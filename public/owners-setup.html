<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Setup - GAS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --border: #e2e8f0;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .logo span {
            font-weight: 300;
            color: var(--text-muted);
            margin-left: 0.5rem;
        }

        /* Main Container */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* Welcome Section */
        .welcome {
            text-align: center;
            margin-bottom: 3rem;
        }

        .welcome h1 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .welcome p {
            color: var(--text-secondary);
            font-size: 1.05rem;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 3rem;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .step.active .step-number {
            background: var(--primary);
            color: white;
        }

        .step.completed .step-number {
            background: var(--success);
            color: white;
        }

        .step-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .step.active .step-label {
            color: var(--text-primary);
            font-weight: 500;
        }

        .step-connector {
            width: 40px;
            height: 2px;
            background: var(--border);
        }

        /* Card */
        .card {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            padding: 2.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .card > p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        /* CM Grid */
        .cm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .cm-option {
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-white);
        }

        .cm-option:hover {
            border-color: var(--primary);
            background: #f8f7ff;
        }

        .cm-option.selected {
            border-color: var(--primary);
            background: #f0f0ff;
        }

        .cm-option .cm-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .cm-option .cm-type {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .cm-option.direct .cm-type {
            color: var(--success);
        }

        /* Search */
        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-box input {
            width: 100%;
            padding: 0.85rem 1rem 0.85rem 2.75rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            border-color: var(--primary);
        }

        .search-box svg {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
        }

        /* Not Listed */
        .not-listed {
            text-align: center;
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            margin-top: 1rem;
        }

        .not-listed p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .not-listed button {
            background: none;
            border: none;
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .not-listed button:hover {
            text-decoration: underline;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group .hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.4rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.85rem 1.75rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Connection Instructions */
        .connection-instructions {
            display: none;
        }

        .connection-instructions.active {
            display: block;
        }

        .instruction-step {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
        }

        .instruction-step:last-child {
            border-bottom: none;
        }

        .instruction-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .instruction-content h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .instruction-content p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .instruction-content code {
            background: var(--bg-light);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        /* Request Form */
        .request-form {
            display: none;
        }

        .request-form.active {
            display: block;
        }

        /* Success State */
        .success-state {
            text-align: center;
            padding: 2rem;
        }

        .success-icon {
            width: 64px;
            height: 64px;
            background: #d1fae5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .success-icon svg {
            width: 32px;
            height: 32px;
            color: var(--success);
        }

        .success-state h2 {
            margin-bottom: 0.5rem;
        }

        .success-state p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Info Box */
        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
        }

        .info-box svg {
            width: 20px;
            height: 20px;
            color: #3b82f6;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .info-box p {
            font-size: 0.9rem;
            color: #1e40af;
            margin: 0;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .container {
                padding: 2rem 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .cm-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .progress-steps {
                flex-wrap: wrap;
            }

            .step-label {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">GAS <span>Owner Setup</span></div>
    </header>

    <div class="container">
        <!-- Welcome -->
        <div class="welcome">
            <h1>Welcome to GAS</h1>
            <p>Let's connect your property management system</p>
        </div>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <span class="step-label">Select CM</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <span class="step-label">Connect</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <span class="step-label">Import</span>
            </div>
        </div>

        <!-- Step 1: Select CM -->
        <div class="card" id="step1">
            <h2>Select your Channel Manager</h2>
            <p>Choose your property management system to connect with GAS</p>

            <div class="search-box">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="cmSearch" placeholder="Search channel managers...">
            </div>

            <div class="cm-grid" id="cmGrid">
                <!-- Populated by JS -->
            </div>

            <div class="not-listed">
                <p>Don't see your channel manager?</p>
                <button onclick="showRequestForm()">Request a connection</button>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" id="continueBtn" onclick="goToStep2()" disabled>Continue</button>
            </div>
        </div>

        <!-- Step 2: Connect -->
        <div class="card hidden" id="step2">
            <h2>Connect <span id="selectedCmName"></span></h2>
            <p>Follow these steps to connect your account</p>

            <!-- Direct Connection (Beds24, Hostaway) -->
            <div class="connection-instructions" id="directConnection">
                <div class="info-box">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>Direct integration available. Your properties will sync automatically.</p>
                </div>

                <div class="form-group">
                    <label>API Key</label>
                    <input type="text" id="apiKey" placeholder="Enter your API key">
                    <p class="hint">Find this in your <span id="cmSettingsLocation">account settings</span></p>
                </div>

                <div class="form-group" id="propKeyGroup">
                    <label>Property Key (if required)</label>
                    <input type="text" id="propKey" placeholder="Enter property key">
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep1()">Back</button>
                    <button class="btn btn-primary" onclick="connectDirect()">Connect</button>
                </div>
            </div>

            <!-- Calry Connection -->
            <div class="connection-instructions" id="calryConnection">
                <div class="info-box">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>Connection via Calry. You'll be redirected to authorise access.</p>
                </div>

                <div class="instruction-step">
                    <div class="instruction-number">1</div>
                    <div class="instruction-content">
                        <h4>Click Connect</h4>
                        <p>You'll be redirected to Calry's secure connection page</p>
                    </div>
                </div>

                <div class="instruction-step">
                    <div class="instruction-number">2</div>
                    <div class="instruction-content">
                        <h4>Authorise GAS</h4>
                        <p>Log in to <span id="calryCmName">your channel manager</span> and grant access</p>
                    </div>
                </div>

                <div class="instruction-step">
                    <div class="instruction-number">3</div>
                    <div class="instruction-content">
                        <h4>Return to GAS</h4>
                        <p>You'll be redirected back and your properties will sync</p>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep1()">Back</button>
                    <button class="btn btn-primary" onclick="connectCalry()">Connect via Calry</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Import / Success -->
        <div class="card hidden" id="step3">
            <div class="loading" id="importLoading">
                <div class="spinner"></div>
                <span>Importing your properties...</span>
            </div>

            <div class="success-state hidden" id="importSuccess">
                <div class="success-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h2>Connected Successfully!</h2>
                <p><span id="propertyCount">0</span> properties imported from <span id="importedCmName"></span></p>
                <button class="btn btn-primary" onclick="goToDashboard()">Go to Dashboard</button>
            </div>
        </div>

        <!-- Request Form -->
        <div class="card hidden" id="requestForm">
            <h2>Request CM Connection</h2>
            <p>Tell us about your channel manager and we'll work on adding it</p>

            <div class="form-group">
                <label>Channel Manager Name *</label>
                <input type="text" id="requestCmName" placeholder="e.g., MyPMS, CustomSoftware">
            </div>

            <div class="form-group">
                <label>Website URL</label>
                <input type="text" id="requestCmUrl" placeholder="https://...">
            </div>

            <div class="form-group">
                <label>Your Email *</label>
                <input type="email" id="requestEmail" placeholder="your@email.com">
            </div>

            <div class="form-group">
                <label>Additional Information</label>
                <textarea id="requestNotes" placeholder="Any details about your setup, API availability, etc."></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="hideRequestForm()">Back</button>
                <button class="btn btn-primary" onclick="submitRequest()">Submit Request</button>
            </div>
        </div>

        <!-- Request Submitted -->
        <div class="card hidden" id="requestSubmitted">
            <div class="success-state">
                <div class="success-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h2>Request Submitted</h2>
                <p>We'll review your request and get back to you within 48 hours.</p>
                <button class="btn btn-primary" onclick="location.href='/'">Return Home</button>
            </div>
        </div>
    </div>

    <script>
        // Channel Manager Data
        const channelManagers = [
            // Direct integrations
            { id: 'beds24', name: 'Beds24', type: 'direct', popular: true },
            { id: 'hostaway', name: 'Hostaway', type: 'direct', popular: true },
            
            // Calry integrations (popular first)
            { id: 'guesty', name: 'Guesty', type: 'calry', popular: true },
            { id: 'lodgify', name: 'Lodgify', type: 'calry', popular: true },
            { id: 'smoobu', name: 'Smoobu', type: 'calry', popular: true },
            { id: 'ownerrez', name: 'OwnerRez', type: 'calry', popular: true },
            { id: 'hospitable', name: 'Hospitable', type: 'calry', popular: true },
            { id: 'uplisting', name: 'Uplisting', type: 'calry', popular: true },
            { id: 'hostify', name: 'Hostify', type: 'calry', popular: true },
            { id: 'lodgable', name: 'Lodgable', type: 'calry' },
            { id: '365villas', name: '365Villas', type: 'calry' },
            { id: 'bookinglayer', name: 'Bookinglayer', type: 'calry' },
            { id: 'bookster', name: 'Bookster', type: 'calry' },
            { id: 'ciirus', name: 'Ciirus', type: 'calry' },
            { id: 'dack', name: 'Dack', type: 'calry' },
            { id: 'direct', name: 'Direct', type: 'calry' },
            { id: 'escapia', name: 'Escapia', type: 'calry' },
            { id: 'avantio', name: 'Avantio', type: 'calry' },
            { id: 'bookingautomation', name: 'Booking Automation', type: 'calry' },
            { id: 'bookingsync', name: 'BookingSync', type: 'calry' },
            { id: 'eviivo', name: 'Eviivo', type: 'calry' },
            { id: 'fantasticstay', name: 'FantasticStay', type: 'calry' },
            { id: 'guestline', name: 'Guestline', type: 'calry' },
            { id: 'hirum', name: 'HiRUM', type: 'calry' },
            { id: 'hotelogix', name: 'Hotelogix', type: 'calry' },
            { id: 'impala', name: 'Impala', type: 'calry' },
            { id: 'clock', name: 'Clock PMS', type: 'calry' },
            { id: 'mews', name: 'Mews', type: 'calry' },
            { id: 'newbook', name: 'NewBook', type: 'calry' },
            { id: 'apaleo', name: 'Apaleo', type: 'calry' },
            { id: 'opengds', name: 'Open GDS', type: 'calry' },
            { id: 'optimapms', name: 'Optima PMS', type: 'calry' },
            { id: 'resnexus', name: 'ResNexus', type: 'calry' },
            { id: 'rms', name: 'RMS Cloud', type: 'calry' },
            { id: 'sabeeapp', name: 'SabeeApp', type: 'calry' },
            { id: 'sirvoy', name: 'Sirvoy', type: 'calry' },
            { id: 'stayntouch', name: 'Stayntouch', type: 'calry' },
            { id: 'thinkreservations', name: 'ThinkReservations', type: 'calry' },
            { id: 'webrezpro', name: 'WebRezPro', type: 'calry' },
            { id: 'zeevou', name: 'Zeevou', type: 'calry' },
            { id: 'cloudbeds', name: 'Cloudbeds', type: 'calry' },
            { id: 'little-hotelier', name: 'Little Hotelier', type: 'calry' },
            { id: 'freetobook', name: 'Freetobook', type: 'calry' },
            { id: 'rentals-united', name: 'Rentals United', type: 'calry' },
            { id: 'kross-booking', name: 'Kross Booking', type: 'calry' },
            { id: 'hotel-runner', name: 'HotelRunner', type: 'calry' },
            { id: 'channex', name: 'Channex', type: 'calry' },
            { id: 'amenitiz', name: 'Amenitiz', type: 'calry' },
            { id: 'octorate', name: 'Octorate', type: 'calry' },
            { id: 'resharmonics', name: 'Resharmonics', type: 'calry' },
        ];

        let selectedCm = null;
        let onboardingData = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load onboarding data from bot
            const stored = localStorage.getItem('gas_onboarding');
            if (stored) {
                onboardingData = JSON.parse(stored);
                console.log('Onboarding data:', onboardingData);
                
                // Pre-fill email in request form
                if (onboardingData.email) {
                    document.getElementById('requestEmail').value = onboardingData.email;
                }
                
                // If they told the bot their CM, try to pre-select it
                if (onboardingData.channelManager) {
                    const cmName = onboardingData.channelManager.toLowerCase();
                    const match = channelManagers.find(cm => 
                        cm.name.toLowerCase().includes(cmName) || 
                        cmName.includes(cm.name.toLowerCase())
                    );
                    if (match) {
                        selectedCm = match;
                    }
                }
            }
            
            renderCmGrid();
        });

        // Render CM Grid
        function renderCmGrid(filter = '') {
            const grid = document.getElementById('cmGrid');
            const filtered = channelManagers.filter(cm => 
                cm.name.toLowerCase().includes(filter.toLowerCase())
            );
            
            // Sort: popular first, then alphabetical
            filtered.sort((a, b) => {
                if (a.popular && !b.popular) return -1;
                if (!a.popular && b.popular) return 1;
                return a.name.localeCompare(b.name);
            });
            
            grid.innerHTML = filtered.map(cm => `
                <div class="cm-option ${cm.type === 'direct' ? 'direct' : ''} ${selectedCm?.id === cm.id ? 'selected' : ''}" 
                     onclick="selectCm('${cm.id}')">
                    <div class="cm-name">${cm.name}</div>
                    <div class="cm-type">${cm.type === 'direct' ? 'Direct' : 'via Calry'}</div>
                </div>
            `).join('');
        }

        // Search
        document.getElementById('cmSearch').addEventListener('input', (e) => {
            renderCmGrid(e.target.value);
        });

        // Select CM
        function selectCm(id) {
            selectedCm = channelManagers.find(cm => cm.id === id);
            renderCmGrid(document.getElementById('cmSearch').value);
            document.getElementById('continueBtn').disabled = false;
        }

        // Step Navigation
        function goToStep1() {
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            updateProgressSteps(1);
        }

        function goToStep2() {
            if (!selectedCm) return;
            
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('selectedCmName').textContent = selectedCm.name;
            
            // Show appropriate connection method
            if (selectedCm.type === 'direct') {
                document.getElementById('directConnection').classList.add('active');
                document.getElementById('calryConnection').classList.remove('active');
                
                // Customize for specific CMs
                if (selectedCm.id === 'beds24') {
                    document.getElementById('cmSettingsLocation').textContent = 'Beds24 → Settings → API';
                    document.getElementById('propKeyGroup').classList.remove('hidden');
                } else if (selectedCm.id === 'hostaway') {
                    document.getElementById('cmSettingsLocation').textContent = 'Hostaway → Settings → API Access';
                    document.getElementById('propKeyGroup').classList.add('hidden');
                }
            } else {
                document.getElementById('directConnection').classList.remove('active');
                document.getElementById('calryConnection').classList.add('active');
                document.getElementById('calryCmName').textContent = selectedCm.name;
            }
            
            updateProgressSteps(2);
        }

        function goToStep3() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            updateProgressSteps(3);
        }

        function updateProgressSteps(currentStep) {
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                }
            });
        }

        // Connect Direct
        async function connectDirect() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Please enter your API key');
                return;
            }
            
            const propKey = document.getElementById('propKey').value.trim();
            
            goToStep3();
            
            // Simulate API call
            try {
                const response = await fetch('/api/cm/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cm_type: selectedCm.id,
                        api_key: apiKey,
                        prop_key: propKey,
                        email: onboardingData.email
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.property_count || 1);
                } else {
                    throw new Error(data.error || 'Connection failed');
                }
            } catch (error) {
                console.error('Connection error:', error);
                // For now, show success anyway (demo mode)
                setTimeout(() => showSuccess(3), 2000);
            }
        }

        // Connect via Calry
        async function connectCalry() {
            goToStep3();
            
            try {
                // Get Calry OAuth URL
                const response = await fetch('/api/calry/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pms: selectedCm.id,
                        email: onboardingData.email,
                        redirect_url: window.location.origin + '/owners/setup/callback'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.oauth_url) {
                    // Redirect to Calry OAuth
                    window.location.href = data.oauth_url;
                } else {
                    throw new Error(data.error || 'Could not start connection');
                }
            } catch (error) {
                console.error('Calry connection error:', error);
                // Demo mode - simulate success
                setTimeout(() => showSuccess(5), 2000);
            }
        }

        // Show Success
        function showSuccess(propertyCount) {
            document.getElementById('importLoading').classList.add('hidden');
            document.getElementById('importSuccess').classList.remove('hidden');
            document.getElementById('propertyCount').textContent = propertyCount;
            document.getElementById('importedCmName').textContent = selectedCm.name;
        }

        // Dashboard
        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        // Request Form
        function showRequestForm() {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('requestForm').classList.remove('hidden');
            
            // Pre-fill CM name if they typed something
            const searchValue = document.getElementById('cmSearch').value;
            if (searchValue) {
                document.getElementById('requestCmName').value = searchValue;
            }
        }

        function hideRequestForm() {
            document.getElementById('requestForm').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        async function submitRequest() {
            const cmName = document.getElementById('requestCmName').value.trim();
            const email = document.getElementById('requestEmail').value.trim();
            
            if (!cmName || !email) {
                alert('Please fill in the required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/cm/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cm_name: cmName,
                        cm_url: document.getElementById('requestCmUrl').value.trim(),
                        email: email,
                        notes: document.getElementById('requestNotes').value.trim(),
                        onboarding_data: onboardingData
                    })
                });
                
                // Show success regardless (we'll handle the API later)
                document.getElementById('requestForm').classList.add('hidden');
                document.getElementById('requestSubmitted').classList.remove('hidden');
                
            } catch (error) {
                console.error('Request error:', error);
                // Show success anyway for demo
                document.getElementById('requestForm').classList.add('hidden');
                document.getElementById('requestSubmitted').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
