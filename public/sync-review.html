<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GAS Sync Review</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { color: #333; margin-bottom: 20px; }
    
    /* Connection Cards */
    .connections-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .connection-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; border: 3px solid transparent; }
    .connection-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
    .connection-card.selected { border-color: #2196F3; }
    .connection-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .connection-name { font-size: 20px; font-weight: 600; color: #333; }
    .connection-status { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .connection-status.connected { background: #e8f5e9; color: #2e7d32; }
    .connection-status.disconnected { background: #ffebee; color: #c62828; }
    
    .connection-ids { display: flex; gap: 20px; margin-bottom: 15px; }
    .id-box { background: #f5f5f5; padding: 10px 15px; border-radius: 8px; }
    .id-label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
    .id-value { font-size: 24px; font-weight: 700; color: #333; font-family: 'Monaco', 'Consolas', monospace; }
    
    .connection-stats { display: flex; gap: 15px; }
    .stat { text-align: center; }
    .stat-value { font-size: 18px; font-weight: 600; color: #333; }
    .stat-label { font-size: 11px; color: #666; }
    
    .last-sync { font-size: 12px; color: #666; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    
    /* Sync Review Panel */
    .sync-panel { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none; }
    .sync-panel.visible { display: block; }
    .sync-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .sync-title { font-size: 18px; font-weight: 600; }
    .sync-actions { display: flex; gap: 10px; }
    
    .btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; }
    .btn-primary { background: #2196F3; color: white; }
    .btn-primary:hover { background: #1976D2; }
    .btn-secondary { background: #f5f5f5; color: #333; }
    .btn-secondary:hover { background: #e0e0e0; }
    .btn-danger { background: #f44336; color: white; }
    .btn-danger:hover { background: #d32f2f; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-success:hover { background: #388E3C; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Summary Stats */
    .sync-summary { display: flex; gap: 20px; margin-bottom: 25px; padding: 20px; background: #fafafa; border-radius: 8px; }
    .summary-stat { text-align: center; flex: 1; }
    .summary-value { font-size: 32px; font-weight: 700; }
    .summary-value.new { color: #4CAF50; }
    .summary-value.matched { color: #666; }
    .summary-value.missing { color: #f44336; }
    .summary-label { font-size: 12px; color: #666; margin-top: 5px; }
    
    /* Room List */
    .room-list { border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
    .room-row { display: grid; grid-template-columns: 50px 1fr 150px 120px 150px; align-items: center; padding: 15px; border-bottom: 1px solid #e0e0e0; }
    .room-row:last-child { border-bottom: none; }
    .room-row.header { background: #f5f5f5; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #666; }
    
    .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-align: center; }
    .status-badge.new { background: #e8f5e9; color: #2e7d32; }
    .status-badge.matched { background: #f5f5f5; color: #666; }
    .status-badge.missing { background: #ffebee; color: #c62828; }
    .status-badge.updated { background: #e3f2fd; color: #1565c0; }
    
    .room-name { font-weight: 500; }
    .room-id { font-family: 'Monaco', 'Consolas', monospace; font-size: 13px; color: #666; }
    
    .action-select { padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 13px; }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; color: #666; }
    .spinner { width: 40px; height: 40px; border: 3px solid #f0f0f0; border-top-color: #2196F3; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: #666; }
    .empty-state h3 { margin-bottom: 10px; color: #333; }
    
    /* Property Selector */
    .property-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .property-tab { padding: 10px 20px; background: #f5f5f5; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .property-tab:hover { background: #e0e0e0; }
    .property-tab.active { background: #2196F3; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”„ GAS Sync Review</h1>
    
    <div class="connections-grid" id="connectionsGrid">
      <div class="loading">
        <div class="spinner"></div>
        Loading connections...
      </div>
    </div>
    
    <div class="sync-panel" id="syncPanel">
      <div class="sync-header">
        <div class="sync-title" id="syncTitle">Select a connection to review</div>
        <div class="sync-actions">
          <button class="btn btn-secondary" onclick="refreshComparison()">â†» Refresh</button>
          <button class="btn btn-success" id="applySyncBtn" onclick="applySync()" disabled>âœ“ Apply Changes</button>
        </div>
      </div>
      
      <div class="property-tabs" id="propertyTabs"></div>
      
      <div class="sync-summary" id="syncSummary" style="display: none;">
        <div class="summary-stat">
          <div class="summary-value new" id="newCount">0</div>
          <div class="summary-label">ðŸŸ¢ New Rooms</div>
        </div>
        <div class="summary-stat">
          <div class="summary-value matched" id="matchedCount">0</div>
          <div class="summary-label">âšª Matched</div>
        </div>
        <div class="summary-stat">
          <div class="summary-value updated" id="updatedCount">0</div>
          <div class="summary-label">ðŸ”µ Updated</div>
        </div>
        <div class="summary-stat">
          <div class="summary-value missing" id="missingCount">0</div>
          <div class="summary-label">ðŸ”´ Missing</div>
        </div>
      </div>
      
      <div class="room-list" id="roomList">
        <div class="empty-state">
          <h3>No property selected</h3>
          <p>Select a property above to compare rooms</p>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://www.gas.travel';
    
    let connections = [];
    let selectedConnection = null;
    let selectedProperty = null;
    let comparisonData = null;
    
    // Load connections on page load
    document.addEventListener('DOMContentLoaded', loadConnections);
    
    async function loadConnections() {
      try {
        const response = await fetch(`${API_BASE}/api/gas-sync/connections`);
        const data = await response.json();
        
        if (data.success && data.connections) {
          connections = data.connections;
          renderConnections();
        }
      } catch (error) {
        console.error('Error loading connections:', error);
        document.getElementById('connectionsGrid').innerHTML = `
          <div class="empty-state">
            <h3>Error loading connections</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }
    
    function renderConnections() {
      const grid = document.getElementById('connectionsGrid');
      
      if (connections.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <h3>No connections found</h3>
            <p>Set up a channel manager connection first</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = connections.map(conn => `
        <div class="connection-card" onclick="selectConnection(${conn.id})" id="conn-${conn.id}">
          <div class="connection-header">
            <div class="connection-name">${conn.account_name || 'Unknown Account'}</div>
            <div class="connection-status ${conn.status}">${conn.status}</div>
          </div>
          
          <div class="connection-ids">
            <div class="id-box">
              <div class="id-label">Account ID</div>
              <div class="id-value">${conn.account_id}</div>
            </div>
            <div class="id-box">
              <div class="id-label">Connection ID</div>
              <div class="id-value">${conn.id}</div>
            </div>
          </div>
          
          <div class="connection-stats">
            <div class="stat">
              <div class="stat-value">${conn.property_count || 0}</div>
              <div class="stat-label">Properties</div>
            </div>
            <div class="stat">
              <div class="stat-value">${conn.room_type_count || 0}</div>
              <div class="stat-label">Rooms</div>
            </div>
            <div class="stat">
              <div class="stat-value">${conn.adapter_code || 'beds24'}</div>
              <div class="stat-label">Adapter</div>
            </div>
          </div>
          
          <div class="last-sync">
            Last sync: ${conn.last_sync_at ? new Date(conn.last_sync_at).toLocaleString() : 'Never'}
          </div>
        </div>
      `).join('');
    }
    
    async function selectConnection(connectionId) {
      // Update selection UI
      document.querySelectorAll('.connection-card').forEach(card => card.classList.remove('selected'));
      document.getElementById(`conn-${connectionId}`).classList.add('selected');
      
      selectedConnection = connections.find(c => c.id === connectionId);
      document.getElementById('syncPanel').classList.add('visible');
      document.getElementById('syncTitle').textContent = `Sync Review: ${selectedConnection.account_name}`;
      
      // Load properties for this connection
      await loadProperties(connectionId);
    }
    
    async function loadProperties(connectionId) {
      const tabsContainer = document.getElementById('propertyTabs');
      tabsContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      try {
        const response = await fetch(`${API_BASE}/api/gas-sync/connections/${connectionId}/properties`);
        const data = await response.json();
        
        if (data.success && data.properties) {
          if (data.properties.length === 0) {
            tabsContainer.innerHTML = '<p>No properties found. Run initial sync first.</p>';
            return;
          }
          
          tabsContainer.innerHTML = data.properties.map(prop => `
            <div class="property-tab" onclick="selectProperty(${prop.id}, '${prop.name}')" id="prop-${prop.id}">
              ${prop.name}
              <small style="opacity: 0.7; margin-left: 5px;">(${prop.external_id})</small>
            </div>
          `).join('');
          
          // Auto-select first property
          if (data.properties.length > 0) {
            selectProperty(data.properties[0].id, data.properties[0].name);
          }
        }
      } catch (error) {
        console.error('Error loading properties:', error);
        tabsContainer.innerHTML = `<p>Error: ${error.message}</p>`;
      }
    }
    
    async function selectProperty(propertyId, propertyName) {
      // Update tab selection
      document.querySelectorAll('.property-tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(`prop-${propertyId}`).classList.add('active');
      
      selectedProperty = { id: propertyId, name: propertyName };
      
      // Load comparison data
      await loadComparison(propertyId);
    }
    
    async function loadComparison(propertyId) {
      const roomList = document.getElementById('roomList');
      roomList.innerHTML = '<div class="loading"><div class="spinner"></div>Comparing rooms with Beds24...</div>';
      document.getElementById('syncSummary').style.display = 'none';
      
      try {
        const response = await fetch(`${API_BASE}/api/gas-sync/properties/${propertyId}/compare`);
        const data = await response.json();
        
        if (data.success) {
          comparisonData = data;
          renderComparison(data);
        } else {
          roomList.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${data.error}</p></div>`;
        }
      } catch (error) {
        console.error('Error loading comparison:', error);
        roomList.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${error.message}</p></div>`;
      }
    }
    
    function renderComparison(data) {
      // Update summary counts
      document.getElementById('newCount').textContent = data.summary.new;
      document.getElementById('matchedCount').textContent = data.summary.matched;
      document.getElementById('updatedCount').textContent = data.summary.updated || 0;
      document.getElementById('missingCount').textContent = data.summary.missing;
      document.getElementById('syncSummary').style.display = 'flex';
      
      // Enable apply button if there are changes
      const hasChanges = data.summary.new > 0 || data.summary.missing > 0 || (data.summary.updated || 0) > 0;
      document.getElementById('applySyncBtn').disabled = !hasChanges;
      
      // Render room list
      const roomList = document.getElementById('roomList');
      
      if (data.rooms.length === 0) {
        roomList.innerHTML = '<div class="empty-state"><h3>No rooms found</h3></div>';
        return;
      }
      
      let html = `
        <div class="room-row header">
          <div>Status</div>
          <div>Room Name</div>
          <div>Beds24 ID</div>
          <div>GAS ID</div>
          <div>Action</div>
        </div>
      `;
      
      // Sort: new first, then matched, then missing
      const sortOrder = { 'new': 0, 'updated': 1, 'matched': 2, 'missing': 3 };
      const sortedRooms = [...data.rooms].sort((a, b) => sortOrder[a.status] - sortOrder[b.status]);
      
      sortedRooms.forEach(room => {
        const statusEmoji = {
          'new': 'ðŸŸ¢',
          'matched': 'âšª',
          'updated': 'ðŸ”µ',
          'missing': 'ðŸ”´'
        }[room.status] || 'âšª';
        
        const actionOptions = room.status === 'missing' 
          ? `<select class="action-select" data-room-id="${room.gas_id}" data-status="${room.status}">
               <option value="deactivate">Deactivate</option>
               <option value="keep">Keep Active</option>
               <option value="delete">Delete</option>
             </select>`
          : room.status === 'new'
          ? `<select class="action-select" data-room-id="${room.beds24_id}" data-status="${room.status}">
               <option value="add">Add to GAS</option>
               <option value="skip">Skip</option>
             </select>`
          : '<span style="color: #666;">No action needed</span>';
        
        html += `
          <div class="room-row">
            <div><span class="status-badge ${room.status}">${statusEmoji} ${room.status.toUpperCase()}</span></div>
            <div class="room-name">${room.name}</div>
            <div class="room-id">${room.beds24_id || '-'}</div>
            <div class="room-id">${room.gas_id || '-'}</div>
            <div>${actionOptions}</div>
          </div>
        `;
      });
      
      roomList.innerHTML = html;
    }
    
    function refreshComparison() {
      if (selectedProperty) {
        loadComparison(selectedProperty.id);
      }
    }
    
    async function applySync() {
      if (!selectedConnection || !selectedProperty || !comparisonData) {
        alert('Please select a connection and property first');
        return;
      }
      
      // Collect actions from dropdowns
      const actions = [];
      document.querySelectorAll('.action-select').forEach(select => {
        actions.push({
          roomId: select.dataset.roomId,
          status: select.dataset.status,
          action: select.value
        });
      });
      
      if (!confirm(`Apply sync changes to ${selectedProperty.name}?\n\nThis will:\n- Add ${comparisonData.summary.new} new rooms\n- Process ${comparisonData.summary.missing} missing rooms based on your selections`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/gas-sync/properties/${selectedProperty.id}/apply-sync`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ actions })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(`Sync applied successfully!\n\nAdded: ${data.added || 0}\nDeactivated: ${data.deactivated || 0}\nDeleted: ${data.deleted || 0}`);
          refreshComparison();
        } else {
          alert('Error applying sync: ' + data.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }
  </script>
</body>
</html>
