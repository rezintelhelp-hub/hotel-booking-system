<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect - GAS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --border: #e2e8f0;
            --success: #10b981;
            --error: #ef4444;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            color: var(--text-primary);
        }

        /* Main Container */
        .main {
            max-width: 600px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* CM Header */
        .cm-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .cm-logo {
            width: 72px;
            height: 72px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            border-radius: 16px;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .cm-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .cm-header p {
            color: var(--text-secondary);
        }

        /* Progress Steps */
        .progress {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border);
        }

        .progress-dot.active {
            background: var(--primary);
        }

        .progress-dot.completed {
            background: var(--success);
        }

        /* Card */
        .card {
            background: var(--bg-white);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            padding: 2rem;
        }

        .card h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .card > p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group .hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.4rem;
        }

        .form-group .error {
            font-size: 0.8rem;
            color: var(--error);
            margin-top: 0.4rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.9rem 1.75rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: inherit;
            width: 100%;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Info Box */
        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .info-box svg {
            width: 20px;
            height: 20px;
            color: #3b82f6;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .info-box p {
            font-size: 0.9rem;
            color: #1e40af;
            margin: 0;
        }

        /* Direct Connection Fields */
        .direct-fields {
            display: none;
        }

        .direct-fields.active {
            display: block;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading p {
            color: var(--text-secondary);
        }

        /* Success State */
        .success-state {
            text-align: center;
            padding: 2rem;
        }

        .success-icon {
            width: 64px;
            height: 64px;
            background: #d1fae5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .success-icon svg {
            width: 32px;
            height: 32px;
            color: var(--success);
        }

        /* Responsive */
        @media (max-width: 640px) {
            .main {
                padding: 2rem 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">GAS</div>
        <a href="/connect-cm" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Back to Channel Managers
        </a>
    </header>

    <main class="main">
        <!-- CM Header -->
        <div class="cm-header">
            <div class="cm-logo" id="cmLogo">SM</div>
            <h1>Connect <span id="cmName">Smoobu</span></h1>
            <p>Import your properties from <span id="cmName2">Smoobu</span></p>
        </div>

        <!-- Progress -->
        <div class="progress">
            <div class="progress-dot active" id="dot1"></div>
            <div class="progress-dot" id="dot2"></div>
            <div class="progress-dot" id="dot3"></div>
        </div>

        <!-- Step 1: User Info -->
        <div class="card" id="step1">
            <h2>Your Details</h2>
            <p>Tell us a bit about yourself so we can set up your account.</p>

            <div class="form-group">
                <label>Your Name *</label>
                <input type="text" id="userName" placeholder="John Smith">
            </div>

            <div class="form-group">
                <label>Email Address *</label>
                <input type="email" id="userEmail" placeholder="john@example.com">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Number of Properties</label>
                    <select id="propertyCount">
                        <option value="1">1 property</option>
                        <option value="2-5">2-5 properties</option>
                        <option value="6-20">6-20 properties</option>
                        <option value="21-100">21-100 properties</option>
                        <option value="100+">100+ properties</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Country</label>
                    <input type="text" id="userCountry" placeholder="United Kingdom">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="goToStep2()">Continue</button>
            </div>
        </div>

        <!-- Step 2: Connect (Direct or Calry redirect) -->
        <div class="card hidden" id="step2">
            <!-- Direct Connection (Beds24, Hostaway) -->
            <div class="direct-fields" id="directFields">
                <h2>Enter Your API Key</h2>
                <p>Connect your <span id="directCmName">Beds24</span> account by entering your API key.</p>

                <div class="info-box">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                        <p><strong>How to find your API Key:</strong></p>
                        <p id="apiInstructions">Log in to Beds24 → Settings → API</p>
                    </div>
                </div>

                <div class="form-group">
                    <label><span id="directCmName2">Beds24</span> API Key *</label>
                    <input type="text" id="apiKey" placeholder="Enter your API key">
                </div>

                <div class="form-group" id="propKeyGroup">
                    <label>Property Key (optional)</label>
                    <input type="text" id="propKey" placeholder="Enter property key if required">
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep1()">Back</button>
                    <button class="btn btn-primary" onclick="connectDirect()">Connect</button>
                </div>
            </div>

            <!-- Calry Redirect -->
            <div class="calry-fields" id="calryFields">
                <h2>Connect to <span id="calryCmName">Smoobu</span></h2>
                <p>You'll be redirected to securely connect your account.</p>

                <div class="info-box">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <div>
                        <p><strong>Secure Connection</strong></p>
                        <p>Your credentials are handled securely and never shared without your permission.</p>
                    </div>
                </div>

                <div style="background: var(--bg-light); border-radius: 10px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">What happens next:</p>
                    <ol style="font-size: 0.9rem; color: var(--text-primary); padding-left: 1.25rem; margin: 0;">
                        <li style="margin-bottom: 0.5rem;">You'll be redirected to enter your <span id="calryCmName2">Smoobu</span> API key</li>
                        <li style="margin-bottom: 0.5rem;">Your properties will be imported automatically</li>
                        <li>You'll return to GAS to complete setup</li>
                    </ol>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep1()">Back</button>
                    <button class="btn btn-primary" onclick="redirectToCalry()">
                        Connect to <span id="calryCmName3">Smoobu</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Loading/Success -->
        <div class="card hidden" id="step3">
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <p>Connecting to <span id="loadingCmName">Smoobu</span>...</p>
            </div>

            <div class="success-state hidden" id="successState">
                <div class="success-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h2>Connected Successfully!</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    <span id="propertyImportCount">0</span> properties imported from <span id="successCmName">Smoobu</span>
                </p>
                <button class="btn btn-primary" onclick="goToDashboard()">Go to Dashboard</button>
            </div>
        </div>
    </main>

    <script>
        // CM configurations
        const cmConfigs = {
            'beds24': {
                name: 'Beds24',
                type: 'direct',
                apiInstructions: 'Log in to Beds24 → Settings → API → Copy your API Key',
                showPropKey: true
            },
            'hostaway': {
                name: 'Hostaway',
                type: 'direct',
                apiInstructions: 'Log in to Hostaway → Settings → API Access → Generate API Key',
                showPropKey: false
            },
            'smoobu': {
                name: 'Smoobu',
                type: 'calry',
                calryPms: 'smoobu'
            },
            'guesty': {
                name: 'Guesty',
                type: 'calry',
                calryPms: 'guesty'
            },
            'cloudbeds': {
                name: 'Cloudbeds',
                type: 'calry',
                calryPms: 'cloudbeds'
            },
            'lodgify': {
                name: 'Lodgify',
                type: 'calry',
                calryPms: 'lodgify'
            },
            'ownerrez': {
                name: 'OwnerRez',
                type: 'calry',
                calryPms: 'ownerrez'
            },
            'hostfully': {
                name: 'Hostfully',
                type: 'calry',
                calryPms: 'hostfully'
            }
        };

        // Default config for unlisted CMs
        const defaultCalryConfig = {
            type: 'calry'
        };

        let selectedCm = null;
        let userData = {};

        // Get CM from URL or localStorage
        function init() {
            const params = new URLSearchParams(window.location.search);
            const cmId = params.get('cm');

            // Try localStorage if not in URL
            const stored = localStorage.getItem('gas_selected_cm');
            if (stored) {
                selectedCm = JSON.parse(stored);
            }

            // Override with URL param config
            if (cmId && cmConfigs[cmId]) {
                selectedCm = { id: cmId, ...cmConfigs[cmId] };
            } else if (cmId) {
                // Unknown CM, treat as Calry
                selectedCm = { id: cmId, name: cmId.charAt(0).toUpperCase() + cmId.slice(1), ...defaultCalryConfig, calryPms: cmId };
            }

            if (!selectedCm) {
                // No CM selected, go back to selector
                window.location.href = '/connect-cm';
                return;
            }

            // Update UI with CM info
            updateCmDisplay();
        }

        // Update UI with selected CM
        function updateCmDisplay() {
            const initials = selectedCm.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            
            document.getElementById('cmLogo').textContent = initials;
            document.getElementById('cmName').textContent = selectedCm.name;
            document.getElementById('cmName2').textContent = selectedCm.name;

            if (selectedCm.type === 'direct') {
                document.getElementById('directCmName').textContent = selectedCm.name;
                document.getElementById('directCmName2').textContent = selectedCm.name;
                document.getElementById('apiInstructions').textContent = selectedCm.apiInstructions || 'Check your account settings for API credentials';
                
                if (!selectedCm.showPropKey) {
                    document.getElementById('propKeyGroup').style.display = 'none';
                }
            } else {
                document.getElementById('calryCmName').textContent = selectedCm.name;
                document.getElementById('calryCmName2').textContent = selectedCm.name;
                document.getElementById('calryCmName3').textContent = selectedCm.name;
            }

            document.getElementById('loadingCmName').textContent = selectedCm.name;
            document.getElementById('successCmName').textContent = selectedCm.name;
        }

        // Step navigation
        function goToStep1() {
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            updateProgress(1);
        }

        function goToStep2() {
            // Validate step 1
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();

            if (!name || !email) {
                alert('Please fill in your name and email');
                return;
            }

            if (!email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            // Store user data
            userData = {
                name,
                email,
                propertyCount: document.getElementById('propertyCount').value,
                country: document.getElementById('userCountry').value.trim(),
                cm: selectedCm.id
            };

            // Show step 2
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');

            // Show correct fields
            if (selectedCm.type === 'direct') {
                document.getElementById('directFields').classList.add('active');
                document.getElementById('calryFields').style.display = 'none';
            } else {
                document.getElementById('directFields').classList.remove('active');
                document.getElementById('calryFields').style.display = 'block';
            }

            updateProgress(2);
        }

        function goToStep3() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            updateProgress(3);
        }

        function updateProgress(step) {
            document.getElementById('dot1').className = 'progress-dot ' + (step >= 1 ? (step > 1 ? 'completed' : 'active') : '');
            document.getElementById('dot2').className = 'progress-dot ' + (step >= 2 ? (step > 2 ? 'completed' : 'active') : '');
            document.getElementById('dot3').className = 'progress-dot ' + (step >= 3 ? 'active' : '');
        }

        // Direct connection (Beds24, Hostaway)
        async function connectDirect() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Please enter your API key');
                return;
            }

            const propKey = document.getElementById('propKey')?.value.trim();

            goToStep3();

            try {
                const response = await fetch('/api/cm/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cm_type: selectedCm.id,
                        api_key: apiKey,
                        prop_key: propKey,
                        user: userData
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.property_count || 1);
                } else {
                    throw new Error(data.error || 'Connection failed');
                }
            } catch (error) {
                console.error('Connection error:', error);
                // Demo mode - simulate success
                setTimeout(() => showSuccess(3), 2000);
            }
        }

        // Redirect to Calry
        async function redirectToCalry() {
            // Store user data for when they return
            localStorage.setItem('gas_cm_user_data', JSON.stringify(userData));

            try {
                // Get Calry connection URL from our API
                const response = await fetch('/api/calry/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pms: selectedCm.calryPms || selectedCm.id,
                        user: userData,
                        callback_url: window.location.origin + '/connect-cm-callback'
                    })
                });

                const data = await response.json();

                if (data.success && data.redirect_url) {
                    // Redirect to Calry
                    window.location.href = data.redirect_url;
                } else {
                    throw new Error(data.error || 'Could not initiate connection');
                }
            } catch (error) {
                console.error('Calry initiation error:', error);
                // Demo mode - redirect to Calry dev environment
                const calryUrl = `https://dev.calry.app/link/${selectedCm.calryPms || selectedCm.id}?callback=${encodeURIComponent(window.location.origin + '/connect-cm-callback')}`;
                window.location.href = calryUrl;
            }
        }

        // Show success
        function showSuccess(propertyCount) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('successState').classList.remove('hidden');
            document.getElementById('propertyImportCount').textContent = propertyCount;
        }

        // Go to dashboard
        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        // Init on load
        init();
    </script>
</body>
</html>
