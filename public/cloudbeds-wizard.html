classList.add('active');
            }
            
            document.getElementById('btn-back').classList.toggle('hidden', currentStep === 1);
            
            if (currentStep === 4) {
                document.getElementById('btn-next').textContent = 'Go to Dashboard →';
            } else if (currentStep === 3) {
                document.getElementById('btn-next').classList.add('hidden');
            } else {
                document.getElementById('btn-next').classList.remove('hidden');
                document.getElementById('btn-next').textContent = 'Next →';
            }
        }

        function showAuthTab(tab) {
            isLoginMode = (tab === 'login');
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (isLoginMode) {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('show');
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
        }

        async function nextStep() {
            clearErrors();
            
            if (currentStep === 1) {
                const success = isLoginMode ? await doLogin() : await doRegister();
                if (!success) return;
            }
            
            if (currentStep === 2) {
                await prepareCalryLink();
            }
            
            if (currentStep === 4) {
                window.location.href = 'https://admin.gas.travel/properties';
                return;
            }
            
            currentStep++;
            updateStep();
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStep();
            }
        }

        async function doLogin() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showError('step1-error', 'Please enter email and password');
                return false;
            }
            
            try {
                const response = await fetch('https://api.gas.travel/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success && data.account) {
                    gasAccountId = data.account.id;
                    localStorage.setItem('gas_cloudbeds_account', JSON.stringify(data.account));
                    return true;
                } else {
                    showError('step1-error', data.error || 'Login failed');
                    return false;
                }
            } catch (error) {
                showError('step1-error', 'Connection error: ' + error.message);
                return false;
            }
        }

        async function doRegister() {
            const business = document.getElementById('reg-business').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            
            if (!business || !email || !password) {
                showError('step1-error', 'Please fill in all fields');
                return false;
            }
            
            try {
                const response = await fetch('https://api.gas.travel/api/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: business, email, password, business_name: business })
                });
                
                const data = await response.json();
                
                if (data.success && data.account) {
                    gasAccountId = data.account.id;
                    localStorage.setItem('gas_cloudbeds_account', JSON.stringify(data.account));
                    return true;
                } else {
                    showError('step1-error', data.error || 'Registration failed');
                    return false;
                }
            } catch (error) {
                showError('step1-error', 'Connection error: ' + error.message);
                return false;
            }
        }

        async function prepareCalryLink() {
            try {
                const finalRedirect = encodeURIComponent(window.location.origin + window.location.pathname);
                const response = await fetch(`https://api.gas.travel/api/calry/link/start?pms=cloudbeds&account_id=${gasAccountId}&final_redirect=${finalRedirect}`);
                const data = await response.json();
                
                if (data.success && data.link_url) {
                    calryLinkUrl = data.link_url;
                }
            } catch (error) {
                console.error('Calry Link prep error:', error);
            }
        }

        function openCalryLink() {
            if (calryLinkUrl) {
                document.getElementById('connect-btn').classList.add('hidden');
                document.getElementById('connect-loading').classList.add('show');
                window.location.href = calryLinkUrl;
            } else {
                showError('step3-error', 'Connection not ready. Please go back and try again.');
            }
        }

        updateStep();
        
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && currentStep < 3) nextStep();
        });
        
        console.log('☁️ Cloudbeds Wizard loaded');
    </script>
</body>
</html>
