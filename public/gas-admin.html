<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAS Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: #e0e7ff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --error: #ef4444;
            --error-light: #fee2e2;
            --border-color: #e2e8f0;
            --border: #e2e8f0;
            --sidebar-bg: #ffffff;
            --sidebar-text: #64748b;
            --sidebar-hover: #f1f5f9;
            --sidebar-active: #6366f1;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        /* Sidebar - Light theme */
        .sidebar {
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 1.5rem 0 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .logo {
            padding: 0 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .nav {
            padding: 0 0.75rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.15s;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #ffffff;
            font-weight: 600;
        }

        .nav-item.feature-locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-item.feature-locked:hover {
            background: transparent;
            color: var(--text-secondary);
        }

        .nav-icon {
            font-size: 1.1rem;
        }

        /* User Profile Section */
        .user-profile-section {
            margin-top: auto;
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            background: var(--bg-primary);
        }

        .user-profile-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: capitalize;
        }

        .logout-btn {
            width: 100%;
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        /* Main Content */
        .main {
            padding: 1.5rem 2rem;
            overflow-y: auto;
            height: 100vh;
            background: var(--bg-primary);
        }

        .header {
            margin-bottom: 1.5rem;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--accent);
        }

        .stat-card::before {
            display: none;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .stat-icon {
            font-size: 1.25rem;
            color: var(--accent);
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        th {
            text-align: left;
            padding: 0.625rem 0.75rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--bg-primary);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-secondary {
            background: #f3f4f6;
            color: var(--text-secondary);
        }

        .badge-warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .badge-info {
            background: var(--accent-light);
            color: var(--accent);
        }

        /* Preset Buttons */
        .preset-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #475569;
        }
        .preset-btn:hover {
            background: #e0f2fe;
            border-color: #3b82f6;
            color: #1d4ed8;
            transform: translateY(-1px);
        }
        .preset-btn:active {
            transform: translateY(0);
        }
        .preset-btn.added {
            background: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        /* Feature Grid for Marketing */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.75rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .feature-item:hover {
            background: #f0f9ff;
            border-color: #3b82f6;
        }
        .feature-item:has(input:checked) {
            background: #dcfce7;
            border-color: #22c55e;
        }
        .feature-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .custom-feature-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #e0f2fe;
            border: 1px solid #7dd3fc;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 0.25rem;
        }
        .custom-feature-tag button {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            padding: 0;
        }

        /* Button */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            box-shadow: 0 1px 2px rgba(99, 102, 241, 0.2);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: #ffffff;
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #ffffff;
        }
        
        .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.35rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.15s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        textarea.form-input {
            min-height: 80px;
            resize: vertical;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .channel-option:hover {
            border-color: var(--accent) !important;
            background: #f8fafc;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
        }

        .empty-icon {
            font-size: 2.5rem;
            opacity: 0.3;
            margin-bottom: 0.75rem;
        }

        .empty-state h3 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        /* View Sections */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Image Gallery */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .image-item {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 6px;
            overflow: hidden;
            background: var(--bg-primary);
            border: 1px solid var(--border);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.35rem;
        }

        /* Amenity Item */
        .amenity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                height: auto;
            }
        }

        /* Filter Tabs */
        .filter-tab {
            padding: 0.4rem 0.75rem;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.8rem;
        }

        .filter-tab:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .filter-tab.active {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
            font-weight: 500;
        }

        /* Image Gallery Grid */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
            padding: 0.75rem;
        }

        .image-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            transition: all 0.15s;
        }

        .image-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .image-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
        }

        .image-card-info {
            padding: 0.75rem;
        }

        .image-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-bottom: 0.5rem;
        }

        .image-tag {
            background: var(--bg-primary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .image-tag.property { border-left: 2px solid var(--accent); }
        .image-tag.room { border-left: 2px solid var(--success); }
        .image-tag.location { border-left: 2px solid var(--warning); }

        .image-actions {
            display: flex;
            gap: 0.35rem;
            margin-top: 0.5rem;
        }

        .image-actions button {
            flex: 1;
            padding: 0.35rem;
            font-size: 0.75rem;
        }

        /* Upload Modal Specific */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 1rem;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .upload-zone.dragover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .upload-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
            max-height: 250px;
            overflow-y: auto;
        }

        .upload-preview-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .upload-preview-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .upload-preview-item .remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }

        .upload-preview-item .error {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 0.2rem;
            font-size: 0.65rem;
            text-align: center;
        }

        .assignment-section {
            background: var(--bg-primary);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .assignment-section h4 {
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.5rem;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.8rem;
        }

        .checkbox-label:hover {
            border-color: var(--accent);
        }

        .checkbox-label input[type="checkbox"]:checked ~ span {
            color: var(--accent);
            font-weight: 500;
        }

        /* Availability Grid Styles */
        #availability-grid {
            font-size: 0.75rem;
            background: #ffffff;
        }
        
        #availability-grid th,
        #availability-grid td {
            border: 1px solid var(--border);
        }
        
        #availability-grid th {
            background: var(--bg-primary);
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        #availability-grid td:hover {
            filter: brightness(0.95);
        }
        
        /* Scrollbar for light theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        /* Client Selector Styles */
        .client-selector {
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0 1rem 1rem;
        }
        
        .client-selector label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .client-selector select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #334155;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
        }
        
        .client-selector select:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        .client-selector select option {
            background: white;
            color: #334155;
            padding: 0.5rem;
        }
        
        .client-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            padding: 0.4rem 0.6rem;
            background: #f1f5f9;
            border-radius: 6px;
            color: #64748b;
        }
        
        .client-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            flex-shrink: 0;
        }
        
        .client-indicator.all-clients .dot {
            background: #f59e0b;
        }
        
        #clientIndicatorText {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1>GAS_ADMIN</h1>
                <p>Property Management System</p>
            </div>
            
            <!-- Client Selector - Hidden for now -->
            <div class="client-selector" style="display: none;">
                <label>üëÅÔ∏è Viewing Client</label>
                <select id="globalClientSelector" onchange="switchClient(this.value)">
                    <option value="">üåê All Clients (Admin View)</option>
                </select>
                <div class="client-indicator" id="clientIndicator">
                    <span class="dot"></span>
                    <span id="clientIndicatorText">All clients</span>
                </div>
            </div>
            
            <!-- Agency Filter Banner -->
            <div id="agencyFilterBanner" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.75rem 1rem; border-radius: 8px; margin: 0 0.75rem 1rem 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span style="font-size: 0.75rem; opacity: 0.9;">VIEWING</span>
                    <div id="agencyFilterName" style="font-weight: 600;"></div>
                </div>
                <button onclick="clearAccountFilter()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">‚úï Clear</button>
            </div>

            <nav class="nav">
                <div class="nav-section">
                    <div class="nav-label">Overview</div>
                    <a class="nav-item active" data-view="dashboard" href="#" onclick="navClick(this, 'dashboard'); return false;">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Accounts</div>
                    <a class="nav-item" data-view="accounts" href="#" onclick="navClick(this, 'accounts'); return false;">
                        <span class="nav-icon">üë•</span>
                        <span>All Accounts</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Property Management</div>
                    <a class="nav-item" data-view="properties" href="#" onclick="navClick(this, 'properties'); return false;">
                        <span class="nav-icon">üè®</span>
                        <span>Properties</span>
                    </a>
                    <a class="nav-item" data-view="rooms" href="#" onclick="navClick(this, 'rooms'); return false;">
                        <span class="nav-icon">üõèÔ∏è</span>
                        <span>Rooms & Units</span>
                    </a>
                    <a class="nav-item" data-view="images" href="#" onclick="navClick(this, 'images'); return false;">
                        <span class="nav-icon">üñºÔ∏è</span>
                        <span>Images</span>
                    </a>
                    <a class="nav-item" data-view="amenities" href="#" onclick="navClick(this, 'amenities'); return false;">
                        <span class="nav-icon">‚≠ê</span>
                        <span>Amenities</span>
                    </a>
                    <a class="nav-item" data-view="content" href="#" onclick="navClick(this, 'content'); return false;">
                        <span class="nav-icon">üìù</span>
                        <span>Content</span>
                    </a>
                    <a class="nav-item" data-view="availability" href="#" onclick="navClick(this, 'availability'); return false;">
                        <span class="nav-icon">üìÖ</span>
                        <span>Availability</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Bookings & Revenue</div>
                    <a class="nav-item" data-view="bookings" href="#" onclick="navClick(this, 'bookings'); return false;">
                        <span class="nav-icon">üìÖ</span>
                        <span>Bookings</span>
                    </a>
                    <a class="nav-item" data-view="offers" href="#" onclick="navClick(this, 'offers'); return false;">
                        <span class="nav-icon">üè∑Ô∏è</span>
                        <span>Offers</span>
                    </a>
                    <a class="nav-item" data-view="vouchers" href="#" onclick="navClick(this, 'vouchers'); return false;">
                        <span class="nav-icon">üéüÔ∏è</span>
                        <span>Vouchers</span>
                    </a>
                    <a class="nav-item" data-view="upsells" href="#" onclick="navClick(this, 'upsells'); return false;">
                        <span class="nav-icon">üéÅ</span>
                        <span>Upsells</span>
                    </a>
                    <a class="nav-item" data-view="taxes" href="#" onclick="navClick(this, 'taxes'); return false;">
                        <span class="nav-icon">üèõÔ∏è</span>
                        <span>Taxes</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Marketing</div>
                    <a class="nav-item" data-view="marketing" href="#" onclick="navClick(this, 'marketing'); return false;">
                        <span class="nav-icon">üì£</span>
                        <span>Features & Tags</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Website Builder</div>
                    <a class="nav-item" data-view="wb-header" href="#" onclick="navClick(this, 'wb-header'); return false;">
                        <span class="nav-icon">üìå</span>
                        <span>Header & Logo</span>
                    </a>
                    <a class="nav-item" data-view="wb-hero" href="#" onclick="navClick(this, 'wb-hero'); return false;">
                        <span class="nav-icon">üñºÔ∏è</span>
                        <span>Hero Section</span>
                    </a>
                    <a class="nav-item" data-view="wb-intro" href="#" onclick="navClick(this, 'wb-intro'); return false;">
                        <span class="nav-icon">üìù</span>
                        <span>Intro Section</span>
                    </a>
                    <a class="nav-item" data-view="wb-featured" href="#" onclick="navClick(this, 'wb-featured'); return false;">
                        <span class="nav-icon">üè®</span>
                        <span>Featured Properties</span>
                    </a>
                    <a class="nav-item" data-view="wb-reviews" href="#" onclick="navClick(this, 'wb-reviews'); return false;">
                        <span class="nav-icon">‚≠ê</span>
                        <span>Reviews</span>
                    </a>
                    <a class="nav-item" data-view="wb-cta" href="#" onclick="navClick(this, 'wb-cta'); return false;">
                        <span class="nav-icon">üöÄ</span>
                        <span>CTA Section</span>
                    </a>
                    <a class="nav-item" data-view="wb-footer" href="#" onclick="navClick(this, 'wb-footer'); return false;">
                        <span class="nav-icon">üë£</span>
                        <span>Footer</span>
                    </a>
                    <a class="nav-item" data-view="wb-styles" href="#" onclick="navClick(this, 'wb-styles'); return false;">
                        <span class="nav-icon">üé®</span>
                        <span>Styles & Colors</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Knowledge Base</div>
                    <a class="nav-item" data-view="kb-articles" href="#" onclick="navClick(this, 'kb-articles'); return false;">
                        <span class="nav-icon">üìö</span>
                        <span>Articles</span>
                    </a>
                    <a class="nav-item" data-view="kb-unanswered" href="#" onclick="navClick(this, 'kb-unanswered'); return false;">
                        <span class="nav-icon">‚ùì</span>
                        <span>Unanswered</span>
                    </a>
                </div>

                <div class="nav-section" id="nav-billing-section">
                    <div class="nav-label">Billing</div>
                    <a class="nav-item" data-view="my-billing" href="#" onclick="navClick(this, 'my-billing'); return false;">
                        <span class="nav-icon">üí≥</span>
                        <span>Plans & Extras</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-overview" href="#" onclick="navClick(this, 'billing-overview'); return false;">
                        <span class="nav-icon">üìä</span>
                        <span>Overview</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-plans" href="#" onclick="navClick(this, 'billing-plans'); return false;">
                        <span class="nav-icon">üìã</span>
                        <span>Manage Plans</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-credits" href="#" onclick="navClick(this, 'billing-credits'); return false;">
                        <span class="nav-icon">ü™ô</span>
                        <span>Manage Credits</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-extras" href="#" onclick="navClick(this, 'billing-extras'); return false;">
                        <span class="nav-icon">üõí</span>
                        <span>Manage Extras</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-label">System</div>
                    <a class="nav-item" data-view="integrations" href="#" onclick="navClick(this, 'integrations'); return false;">
                        <span class="nav-icon">üîó</span>
                        <span>Integrations</span>
                    </a>
                    <a class="nav-item" data-view="settings" href="#" onclick="navClick(this, 'settings'); return false;">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Apps</div>
                    <a class="nav-item" data-view="app-blog" data-requires-feature="blog_module" href="#" onclick="return handleFeatureClick(this, 'app-blog', 'blog_module');">
                        <span class="nav-icon">üìù</span>
                        <span>Blog</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;">üîí</span>
                    </a>
                    <a class="nav-item" data-view="app-attractions" data-requires-feature="attractions_module" href="#" onclick="return handleFeatureClick(this, 'app-attractions', 'attractions_module');">
                        <span class="nav-icon">üéØ</span>
                        <span>Attractions</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;">üîí</span>
                    </a>
                    <a class="nav-item" data-view="app-reviews" data-requires-feature="reviews_widget" href="#" onclick="return handleFeatureClick(this, 'app-reviews', 'reviews_widget');">
                        <span class="nav-icon">‚≠ê</span>
                        <span>Reviews</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;">üîí</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Developers</div>
                    <a class="nav-item" data-view="api-docs" data-requires-feature="api_access" href="#" onclick="return handleFeatureClick(this, 'api-docs', 'api_access');">
                        <span class="nav-icon">üîå</span>
                        <span>API</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;">üîí</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Website</div>
                    <a class="nav-item" data-view="wordpress" data-requires-feature="has_subscription" href="#" onclick="return handleFeatureClick(this, 'wordpress', 'has_subscription');">
                        <span class="nav-icon"><svg width="18" height="18" viewBox="0 0 122.5 122.5" fill="currentColor"><path d="M8.7 61.3c0 20.8 12.1 38.8 29.6 47.3L13 40.3c-2.8 6.5-4.3 13.7-4.3 21zm88.6-2.7c0-6.5-2.3-11-4.3-14.5-2.7-4.3-5.2-8-5.2-12.3 0-4.8 3.7-9.3 8.9-9.3h.7c-9.4-8.6-21.9-13.9-35.7-13.9-18.5 0-34.7 9.5-44.2 23.8h3.4c5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.8.3-6 .5l19.1 57 11.5-34.5-8.2-22.5c-2.8-.2-5.5-.5-5.5-.5-2.8-.2-2.5-4.5.3-4.3 0 0 8.7.7 13.9.7 5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.9.3-6 .5l19 56.5 5.2-17.5c2.3-7.3 4-12.5 4-17zm-36.3 7.6l-15.8 45.8c4.7 1.4 9.7 2.2 14.8 2.2 6.1 0 12-1.1 17.4-3-.1-.2-.3-.5-.4-.7l-16-43.3zm45.1-29.8c.5 3.4.7 7 .7 10.9 0 10.8-2 22.9-8 38l-21.8 63.1c21.2-12.4 35.5-35.5 35.5-62.1 0-17.9-6.2-34.3-16.4-47.9zM61.3 0C27.5 0 0 27.5 0 61.3c0 33.8 27.5 61.3 61.3 61.3 33.8 0 61.3-27.5 61.3-61.3C122.5 27.5 95 0 61.3 0zm0 119.7c-32.2 0-58.5-26.2-58.5-58.5 0-32.2 26.2-58.5 58.5-58.5 32.2 0 58.5 26.2 58.5 58.5-.1 32.3-26.3 58.5 58.5z"/></svg></span>
                        <span>WordPress</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;">üîí</span>
                    </a>
                </div>
                
                <!-- User Profile Section -->
                <div class="user-profile-section" id="userProfileSection">
                    <div class="user-profile-info">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRole">-</div>
                        </div>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">
                        <span>üö™</span> Sign Out
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Dashboard Overview</h2>
                            <p>Welcome back! Here's what's happening with your properties.</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <a href="/beds24-wizard.html" class="btn">
                                <span>+</span>
                                <span>Import from Beds24</span>
                            </a>
                            <a href="/hostaway-wizard.html" class="btn" style="background: #1e3a5f;">
                                <span>+</span>
                                <span>Import from Hostaway</span>
                            </a>
                            <a href="/smoobu-wizard.html" class="btn" style="background: #00b4b4;">
                                <span>+</span>
                                <span>Import from Smoobu</span>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">üè®</span>
                        </div>
                        <div class="stat-value" id="stat-properties">-</div>
                        <div class="stat-label">Properties</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">üõèÔ∏è</span>
                        </div>
                        <div class="stat-value" id="stat-rooms">-</div>
                        <div class="stat-label">Rooms & Units</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">üìÖ</span>
                        </div>
                        <div class="stat-value" id="stat-bookings">-</div>
                        <div class="stat-label">Total Bookings</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">üîó</span>
                        </div>
                        <div class="stat-value" id="stat-integrations">-</div>
                        <div class="stat-label">Active Integrations</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <button class="btn" onclick="showView('properties')">
                            <span>üè®</span>
                            <span>Manage Properties</span>
                        </button>
                        <button class="btn btn-secondary" onclick="showView('rooms')">
                            <span>üõèÔ∏è</span>
                            <span>Manage Rooms</span>
                        </button>
                        <button class="btn btn-secondary" onclick="showView('images')">
                            <span>üñºÔ∏è</span>
                            <span>Upload Images</span>
                        </button>
                        <button class="btn btn-secondary" onclick="showView('rateplans')">
                            <span>üí∞</span>
                            <span>Create Rate Plan</span>
                        </button>
                        <button class="btn btn-secondary" onclick="cleanupDuplicates()" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">
                            <span>üßπ</span>
                            <span>Remove Duplicates</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Agencies View -->
            <div id="accounts" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üë• Accounts</h2>
                            <p>Manage all accounts - Master Admin, Agency Admins, Sub Masters, and Admins</p>
                        </div>
                        <button class="btn" onclick="openAddAccountModal()">
                            <span>+</span>
                            <span>Add Account</span>
                        </button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total-accounts">-</div>
                        <div class="stat-label">Total Accounts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-agency-admins">-</div>
                        <div class="stat-label">Agency Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-submaster-admins">-</div>
                        <div class="stat-label">Sub Masters</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-admins">-</div>
                        <div class="stat-label">Admins</div>
                    </div>
                </div>

                <!-- Role Filter -->
                <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary account-filter active" data-role="all" onclick="filterAccounts('all')">All</button>
                        <button class="btn btn-secondary account-filter" data-role="agency_admin" onclick="filterAccounts('agency_admin')">üè¢ Agency Admins</button>
                        <button class="btn btn-secondary account-filter" data-role="submaster_admin" onclick="filterAccounts('submaster_admin')">üìÅ Sub Masters</button>
                        <button class="btn btn-secondary account-filter" data-role="admin" onclick="filterAccounts('admin')">üë§ Admins</button>
                    </div>
                </div>

                <div class="card">
                    <div id="accounts-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem;">Loading accounts...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keep old views hidden for backward compatibility -->
            <div id="agencies" class="view" style="display:none;"></div>
            <div id="clients" class="view" style="display:none;"></div>

            <!-- Properties View -->
            <div id="properties" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Properties</h2>
                            <p>Manage your property listings</p>
                        </div>
                        <a href="/beds24-wizard.html" class="btn">
                            <span>+</span>
                            <span>Import Property</span>
                        </a>
                    </div>
                </div>

                <div class="card">
                    <div id="properties-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem;">Loading properties...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rooms View -->
            <div id="rooms" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Rooms & Units</h2>
                            <p>Manage bookable rooms and units</p>
                        </div>
                        <button class="btn" onclick="openAddRoomModal()">
                            <span>+</span>
                            <span>Add Room</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div id="rooms-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem;">Loading rooms...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bookings View -->
            <div id="bookings" class="view">
                <div class="header">
                    <h2>Bookings</h2>
                    <p>View all reservations</p>
                </div>

                <div class="card">
                    <div id="bookings-list">
                        <div class="empty-state">
                            <div class="empty-icon">üìÖ</div>
                            <h3>No Bookings Yet</h3>
                            <p>Bookings will appear here when guests make reservations</p>
                            <a href="/admin-improved.html" class="btn">View Booking Site</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Images View -->
            <div id="images" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Images</h2>
                            <p>Manage property, room, and location images</p>
                        </div>
                        <button class="btn" onclick="openImageUploadModal()">
                            <span>+</span>
                            <span>Upload Images</span>
                        </button>
                    </div>
                </div>

                <!-- Image Stats Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Property Images</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="property-image-count">0</div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Room Images</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="room-image-count">0</div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Location Images</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="location-image-count">0</div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Images</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="total-image-count">0</div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button class="filter-tab active" data-filter="all" onclick="filterImages('all')">
                        All Images
                    </button>
                    <button class="filter-tab" data-filter="property" onclick="filterImages('property')">
                        üè® Property
                    </button>
                    <button class="filter-tab" data-filter="rooms" onclick="filterImages('rooms')">
                        üõèÔ∏è Rooms
                    </button>
                    <button class="filter-tab" data-filter="location" onclick="filterImages('location')">
                        üìç Location
                    </button>
                </div>

                <div class="card">
                    <div id="images-gallery">
                        <div class="empty-state">
                            <div class="empty-icon">üñºÔ∏è</div>
                            <h3>No Images Yet</h3>
                            <p>Upload images to showcase your properties</p>
                            <button class="btn" onclick="openImageUploadModal()">Upload Images</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Amenities View -->
            <div id="amenities" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Amenities</h2>
                            <p>Manage property and room amenities</p>
                        </div>
                        <button class="btn" onclick="openAddAmenityModal()">
                            <span>+</span>
                            <span>Add Amenity</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div id="amenities-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem;">Loading amenities...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content View -->
            <div id="content" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Content Management</h2>
                            <p>Manage descriptions, policies and terms</p>
                        </div>
                    </div>
                </div>

                <!-- Content Type Tabs -->
                <div class="filter-tabs" style="margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button class="filter-tab active" data-content-type="property" onclick="filterContent('property')">üè® Property</button>
                    <button class="filter-tab" data-content-type="contact" onclick="filterContent('contact')">üìû Contact</button>
                    <button class="filter-tab" data-content-type="room" onclick="filterContent('room')">üõèÔ∏è Rooms</button>
                    <button class="filter-tab" data-content-type="policies" onclick="filterContent('policies')">üìã Policies</button>
                    <button class="filter-tab" data-content-type="pages" onclick="filterContent('pages')">üìÑ Website Pages</button>
                    <button class="filter-tab" data-content-type="branding" onclick="filterContent('branding')">üé® Branding</button>
                </div>

                <!-- Property Content Section -->
                <div id="content-property" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Property Descriptions</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Property</label>
                            <select class="form-input" id="content-property-select" onchange="loadPropertyContent()">
                                <option value="">Choose a property...</option>
                            </select>
                        </div>
                        
                        <div id="property-content-form" style="display: none;">
                            <!-- AI Generation Panel -->
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; color: white;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                    <span style="font-size: 1.5rem;">‚ú®</span>
                                    <h4 style="margin: 0; font-weight: 600;">AI Content Generator</h4>
                                </div>
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <textarea id="property-ai-prompt" rows="2" placeholder="Describe your property style, vibe, target guests... e.g. 'Romantic Victorian B&B, dog-friendly, known for amazing breakfasts'" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; font-size: 0.9rem;"></textarea>
                                </div>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button onclick="generatePropertyContent('property_description')" style="background: white; color: #667eea; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer;">ü™Ñ Generate Description</button>
                                    <button onclick="generatePropertyContent('property_location')" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üìç Generate Location</button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Property Description <button onclick="copyToClipboard('property-description')" style="background: none; border: none; cursor: pointer; font-size: 1rem;" title="Copy to clipboard">üìã</button></label>
                                <textarea class="form-input" id="property-description" rows="10" placeholder="Describe your property... its history, character, what makes it special"></textarea>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    This is the main description shown to guests
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Location Description <button onclick="copyToClipboard('property-location')" style="background: none; border: none; cursor: pointer; font-size: 1rem;" title="Copy to clipboard">üìã</button></label>
                                <textarea class="form-input" id="property-location" rows="8" placeholder="Describe the area, nearby attractions, transport links, directions..."></textarea>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    Help guests understand where you are and what's nearby
                                </div>
                            </div>
                            
                            <button class="btn" onclick="savePropertyContent()">üíæ Save Property Content</button>
                        </div>
                    </div>
                </div>

                <!-- Contact Info Section -->
                <div id="content-contact" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìû Contact Information</h3>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">This information appears on your contact page, website footer, and across your site</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Business Name *</label>
                                <input type="text" class="form-input" id="contact-business-name" placeholder="Your Business Name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tagline</label>
                                <input type="text" class="form-input" id="contact-tagline" placeholder="Your tagline or slogan">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" id="contact-email" placeholder="contact@example.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone *</label>
                                <input type="text" class="form-input" id="contact-phone" placeholder="+1 234 567 8900">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Secondary Phone</label>
                                <input type="text" class="form-input" id="contact-phone-secondary" placeholder="Alternative number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">WhatsApp</label>
                                <input type="text" class="form-input" id="contact-whatsapp" placeholder="+1 234 567 8900">
                            </div>
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--text-primary);">üìç Address</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Address Line 1</label>
                                <input type="text" class="form-input" id="contact-address1" placeholder="Street address">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address Line 2</label>
                                <input type="text" class="form-input" id="contact-address2" placeholder="Suite, floor, etc.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">City</label>
                                <input type="text" class="form-input" id="contact-city" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label class="form-label">State / Province</label>
                                <input type="text" class="form-input" id="contact-state" placeholder="State or Province">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Postal Code</label>
                                <input type="text" class="form-input" id="contact-postal" placeholder="ZIP / Postal code">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Country</label>
                                <select class="form-input" id="contact-country">
                                    <option value="">Select country...</option>
                                    <option value="GB">üá¨üáß United Kingdom</option>
                                    <option value="US">üá∫üá∏ United States</option>
                                    <option value="CH">üá®üá≠ Switzerland</option>
                                    <option value="DE">üá©üá™ Germany</option>
                                    <option value="FR">üá´üá∑ France</option>
                                    <option value="IT">üáÆüáπ Italy</option>
                                    <option value="ES">üá™üá∏ Spain</option>
                                    <option value="NL">üá≥üá± Netherlands</option>
                                    <option value="AT">üá¶üáπ Austria</option>
                                    <option value="PT">üáµüáπ Portugal</option>
                                    <option value="BE">üáßüá™ Belgium</option>
                                    <option value="IE">üáÆüá™ Ireland</option>
                                    <option value="AU">üá¶üá∫ Australia</option>
                                    <option value="NZ">üá≥üáø New Zealand</option>
                                    <option value="CA">üá®üá¶ Canada</option>
                                    <option value="AE">üá¶üá™ UAE</option>
                                    <option value="JP">üáØüáµ Japan</option>
                                    <option value="TH">üáπüá≠ Thailand</option>
                                    <option value="GR">üá¨üá∑ Greece</option>
                                    <option value="HR">üá≠üá∑ Croatia</option>
                                    <option value="CZ">üá®üáø Czech Republic</option>
                                    <option value="PL">üáµüá± Poland</option>
                                    <option value="HU">üá≠üá∫ Hungary</option>
                                    <option value="SE">üá∏üá™ Sweden</option>
                                    <option value="NO">üá≥üá¥ Norway</option>
                                    <option value="DK">üá©üá∞ Denmark</option>
                                    <option value="FI">üá´üáÆ Finland</option>
                                </select>
                            </div>
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--text-primary);">üîó Social Media Links</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Facebook</label>
                                <input type="url" class="form-input" id="contact-facebook" placeholder="https://facebook.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Instagram</label>
                                <input type="url" class="form-input" id="contact-instagram" placeholder="https://instagram.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Twitter/X</label>
                                <input type="url" class="form-input" id="contact-twitter" placeholder="https://twitter.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">LinkedIn</label>
                                <input type="url" class="form-input" id="contact-linkedin" placeholder="https://linkedin.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">YouTube</label>
                                <input type="url" class="form-input" id="contact-youtube" placeholder="https://youtube.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TripAdvisor</label>
                                <input type="url" class="form-input" id="contact-tripadvisor" placeholder="https://tripadvisor.com/...">
                            </div>
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem; color: var(--text-primary);">üó∫Ô∏è Map & Location</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Google Maps URL</label>
                                <input type="url" class="form-input" id="contact-maps-url" placeholder="https://maps.google.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Google Place ID</label>
                                <input type="text" class="form-input" id="contact-place-id" placeholder="ChIJ...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Latitude</label>
                                <input type="text" class="form-input" id="contact-latitude" placeholder="51.5074">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Longitude</label>
                                <input type="text" class="form-input" id="contact-longitude" placeholder="-0.1278">
                            </div>
                        </div>
                        
                        <button class="btn" onclick="saveContactInfo()" style="margin-top: 1.5rem;">üíæ Save Contact Information</button>
                    </div>
                </div>

                <!-- Room Content Section -->
                <div id="content-room" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Room Descriptions</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Room</label>
                            <select class="form-input" id="content-room-select" onchange="loadRoomContent()">
                                <option value="">Choose a room...</option>
                            </select>
                        </div>
                        
                        <div id="room-content-form" style="display: none;">
                            <!-- AI Generation Panel -->
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; color: white;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                    <span style="font-size: 1.5rem;">‚ú®</span>
                                    <h4 style="margin: 0; font-weight: 600;">AI Room Description Generator</h4>
                                </div>
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <textarea id="room-ai-prompt" rows="2" placeholder="Describe this room's special features... e.g. 'Garden view, four-poster bed, ensuite with roll-top bath'" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; font-size: 0.9rem;"></textarea>
                                </div>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button onclick="generateRoomContent('room_short')" style="background: white; color: #11998e; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer;">ü™Ñ Generate Short</button>
                                    <button onclick="generateRoomContent('room_full')" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üìù Generate Full</button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Short Description <button onclick="copyToClipboard('room-short-description')" style="background: none; border: none; cursor: pointer; font-size: 1rem;" title="Copy to clipboard">üìã</button></label>
                                <textarea class="form-input" id="room-short-description" rows="3" placeholder="Brief, punchy description of the room (1-2 sentences)"></textarea>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    Shown in listings and search results
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Full Description <button onclick="copyToClipboard('room-full-description')" style="background: none; border: none; cursor: pointer; font-size: 1rem;" title="Copy to clipboard">üìã</button></label>
                                <textarea class="form-input" id="room-full-description" rows="12" placeholder="Detailed description of the room, its features, views, atmosphere..."></textarea>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    Extended information shown on room detail page
                                </div>
                            </div>
                            
                            <button class="btn" onclick="saveRoomContent()">üíæ Save Room Content</button>
                        </div>
                    </div>
                </div>

                <!-- Policies Section -->
                <div id="content-policies" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Policies & Terms</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Property</label>
                            <select class="form-input" id="content-policies-property-select" onchange="loadPoliciesContent()">
                                <option value="">Choose a property...</option>
                            </select>
                        </div>
                        
                        <div id="policies-content-form" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">House Rules</label>
                                <textarea class="form-input" id="policy-house-rules" rows="6" placeholder="Check-in/out times, noise policy, smoking policy, pet policy, etc."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Cancellation Policy</label>
                                <textarea class="form-input" id="policy-cancellation" rows="4" placeholder="Describe your cancellation and refund policy"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">General Terms & Conditions</label>
                                <textarea class="form-input" id="policy-terms" rows="6" placeholder="Liability, damages, additional terms..."></textarea>
                            </div>
                            
                            <button class="btn" onclick="savePoliciesContent()">üíæ Save Policies</button>
                        </div>
                    </div>
                </div>

                <!-- Website Pages Section -->
                <div id="content-pages" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìÑ Website Pages</h3>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Manage your About, Contact, Terms, and Privacy pages</p>
                        
                        <!-- Page Type Tabs -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                            <button class="btn" style="background: var(--accent);" onclick="loadWebsitePage('about')" id="page-tab-about">About Us</button>
                            <button class="btn" style="background: #64748b;" onclick="loadWebsitePage('contact')" id="page-tab-contact">Contact</button>
                            <button class="btn" style="background: #64748b;" onclick="loadWebsitePage('terms')" id="page-tab-terms">Terms</button>
                            <button class="btn" style="background: #64748b;" onclick="loadWebsitePage('privacy')" id="page-tab-privacy">Privacy</button>
                        </div>
                        
                        <!-- AI Content Generator Panel -->
                        <div id="page-ai-panel" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; color: white;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                                <span style="font-size: 1.5rem;">‚ú®</span>
                                <h4 style="margin: 0; font-weight: 600;">AI Content Generator</h4>
                                <span id="page-ai-badge" style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">About Us</span>
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <textarea id="page-ai-context" rows="2" placeholder="Tell us about your property... e.g. 'Victorian B&B in St Louis, family-run since 1995, known for gourmet breakfasts and historic charm'" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; font-size: 0.9rem;"></textarea>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="generatePageContent()" style="background: white; color: #667eea; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer;">ü™Ñ Generate Content</button>
                                <button onclick="generatePageSEO()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üîç Generate SEO</button>
                                <button onclick="generatePageFAQSchema()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">üìã Generate FAQ Schema</button>
                            </div>
                            <div id="page-ai-status" style="margin-top: 0.75rem; font-size: 0.85rem; display: none;"></div>
                        </div>
                        
                        <div id="website-page-form">
                            <div class="form-group">
                                <label class="form-label">Page Title</label>
                                <input type="text" class="form-input" id="page-title" placeholder="Page title">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Subtitle (optional)</label>
                                <input type="text" class="form-input" id="page-subtitle" placeholder="Brief subtitle or tagline">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Content</label>
                                <textarea class="form-input" id="page-content" rows="15" placeholder="Page content... HTML is supported. Use &lt;h2&gt; headers for FAQ schema generation."></textarea>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                    üí° Use &lt;h2&gt; and &lt;h3&gt; headers followed by paragraphs to auto-generate FAQ schema
                                </div>
                            </div>
                            
                            <!-- SEO Section -->
                            <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 1rem; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üîç SEO Settings
                                    <button onclick="generatePageSEO()" style="background: var(--accent); color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">AI Suggest</button>
                                </h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Meta Title <span id="meta-title-count" style="color: var(--text-muted); font-weight: normal;">(0/60)</span></label>
                                        <input type="text" class="form-input" id="page-meta-title" placeholder="SEO title - aim for 50-60 characters" maxlength="60" oninput="updateMetaCount()">
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Meta Description <span id="meta-desc-count" style="color: var(--text-muted); font-weight: normal;">(0/160)</span></label>
                                        <input type="text" class="form-input" id="page-meta-description" placeholder="SEO description - aim for 150-160 characters" maxlength="160" oninput="updateMetaCount()">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- FAQ Schema Section -->
                            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <h4 style="margin: 0 0 0.5rem; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem;">
                                    üìã FAQ Schema (Structured Data)
                                    <button onclick="generatePageFAQSchema()" style="background: #10b981; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">Generate from Headers</button>
                                </h4>
                                <p style="font-size: 0.8rem; color: #166534; margin-bottom: 0.75rem;">FAQ schema helps your pages appear in Google's rich results with expandable Q&A</p>
                                <div id="faq-schema-preview" style="display: none; margin-bottom: 0.75rem;">
                                    <div style="background: white; border-radius: 6px; padding: 0.75rem; max-height: 200px; overflow-y: auto;" id="faq-items-list"></div>
                                </div>
                                <textarea class="form-input" id="page-faq-schema" rows="4" placeholder='[{"question": "...", "answer": "..."}]' style="font-family: monospace; font-size: 0.85rem;"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="page-published" checked>
                                    <span>Published (visible on website)</span>
                                </label>
                            </div>
                            
                            <input type="hidden" id="page-type" value="about">
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn" onclick="saveWebsitePage()">üíæ Save Page</button>
                                <button class="btn" style="background: #64748b;" onclick="previewPageContent()">üëÅÔ∏è Preview</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Blog Section -->
                <div id="content-blog" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title">üìù Blog Posts</h3>
                            <button class="btn" onclick="openBlogModal()">+ New Post</button>
                        </div>
                        <div id="blog-posts-list">
                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                                <p>No blog posts yet</p>
                                <button class="btn" style="margin-top: 1rem;" onclick="openBlogModal()">Create Your First Post</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attractions Section -->
                <div id="content-attractions" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title">üéØ Local Attractions</h3>
                            <button class="btn" onclick="openAttractionModal()">+ Add Attraction</button>
                        </div>
                        <div id="attractions-list">
                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üéØ</div>
                                <p>No attractions added yet</p>
                                <button class="btn" style="margin-top: 1rem;" onclick="openAttractionModal()">Add Your First Attraction</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Branding Section -->
                <div id="content-branding" class="content-section" style="display: none;">
                    <!-- Logo & Identity -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üñºÔ∏è Logo & Identity</h3>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Logo URL (light backgrounds)</label>
                                <input type="url" class="form-input" id="brand-logo-url" placeholder="https://...">
                                <div id="brand-logo-preview" style="margin-top: 0.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px; display: none;">
                                    <img src="" style="max-height: 60px; max-width: 200px;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Logo URL (dark backgrounds)</label>
                                <input type="url" class="form-input" id="brand-logo-dark-url" placeholder="https://...">
                                <div id="brand-logo-dark-preview" style="margin-top: 0.5rem; padding: 1rem; background: #1e293b; border-radius: 8px; display: none;">
                                    <img src="" style="max-height: 60px; max-width: 200px;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Favicon URL</label>
                                <input type="url" class="form-input" id="brand-favicon-url" placeholder="https://... (32x32 or 64x64 .ico/.png)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Social Share Image (OG Image)</label>
                                <input type="url" class="form-input" id="brand-og-image-url" placeholder="https://... (1200x630 recommended)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Site Title (for SEO)</label>
                                <input type="text" class="form-input" id="brand-site-title" placeholder="Your Business Name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Site Description (for SEO)</label>
                                <input type="text" class="form-input" id="brand-site-description" placeholder="Brief description of your business">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Colors -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üé® Brand Colors</h3>
                        </div>
                        
                        <h4 style="margin: 0 0 1rem; font-size: 0.9rem; color: var(--text-secondary);">Primary Palette</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Primary</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-primary-color" value="#2563eb" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-primary-color-text" value="#2563eb" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Secondary</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-secondary-color" value="#7c3aed" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-secondary-color-text" value="#7c3aed" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Accent</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-accent-color" value="#f59e0b" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-accent-color-text" value="#f59e0b" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem; font-size: 0.9rem; color: var(--text-secondary);">Text & Background</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-text-color" value="#1e293b" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-text-color-text" value="#1e293b" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Light</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-text-light-color" value="#64748b" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-text-light-color-text" value="#64748b" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Background</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-background-color" value="#ffffff" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-background-color-text" value="#ffffff" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Surface</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-surface-color" value="#f8fafc" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-surface-color-text" value="#f8fafc" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Header Styling -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üìå Header Styling</h3>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Header Background</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-header-bg" value="#ffffff" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-header-bg-text" value="#ffffff" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Header Text</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-header-text" value="#1e293b" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-header-text-text" value="#1e293b" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 2rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="brand-header-sticky" checked>
                                <span>Sticky Header</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="brand-header-transparent">
                                <span>Transparent on Homepage</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Footer Styling -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">ü¶∂ Footer Styling</h3>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Footer Background</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-footer-bg" value="#0f172a" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-footer-bg-text" value="#0f172a" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Footer Text</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-footer-text" value="#ffffff" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-footer-text-text" value="#ffffff" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Link Color</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-footer-link" value="#94a3b8" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-footer-link-text" value="#94a3b8" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Link Hover</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="color" id="brand-footer-link-hover" value="#ffffff" style="width: 45px; height: 36px; border: none; cursor: pointer; border-radius: 4px;">
                                    <input type="text" class="form-input" id="brand-footer-link-hover-text" value="#ffffff" style="flex: 1; font-family: monospace; font-size: 0.85rem;">
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Copyright Text</label>
                            <input type="text" class="form-input" id="brand-copyright" placeholder="¬© 2025 Your Business Name. All rights reserved.">
                        </div>
                    </div>
                    
                    <!-- Button Styling -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üîò Button Styling</h3>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <h4 style="margin: 0 0 1rem; font-size: 0.9rem; color: var(--text-secondary);">Primary Button</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Background</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <input type="color" id="brand-btn-primary-bg" value="#2563eb" style="width: 40px; height: 32px; border: none; cursor: pointer; border-radius: 4px;">
                                            <input type="text" class="form-input" id="brand-btn-primary-bg-text" value="#2563eb" style="flex: 1; font-family: monospace; font-size: 0.8rem;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Text</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <input type="color" id="brand-btn-primary-text" value="#ffffff" style="width: 40px; height: 32px; border: none; cursor: pointer; border-radius: 4px;">
                                            <input type="text" class="form-input" id="brand-btn-primary-text-text" value="#ffffff" style="flex: 1; font-family: monospace; font-size: 0.8rem;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Hover</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <input type="color" id="brand-btn-primary-hover" value="#1d4ed8" style="width: 40px; height: 32px; border: none; cursor: pointer; border-radius: 4px;">
                                            <input type="text" class="form-input" id="brand-btn-primary-hover-text" value="#1d4ed8" style="flex: 1; font-family: monospace; font-size: 0.8rem;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Border Radius</label>
                                        <select class="form-input" id="brand-btn-radius">
                                            <option value="0px">Square (0px)</option>
                                            <option value="4px">Slightly Rounded (4px)</option>
                                            <option value="8px" selected>Rounded (8px)</option>
                                            <option value="12px">More Rounded (12px)</option>
                                            <option value="9999px">Pill Shape</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; text-align: center;">
                                    <button id="preview-btn-primary" style="padding: 0.75rem 1.5rem; border: none; cursor: pointer; font-weight: 600;">Book Now</button>
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="margin: 0 0 1rem; font-size: 0.9rem; color: var(--text-secondary);">Secondary Button</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Text/Border</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <input type="color" id="brand-btn-secondary-text" value="#2563eb" style="width: 40px; height: 32px; border: none; cursor: pointer; border-radius: 4px;">
                                            <input type="text" class="form-input" id="brand-btn-secondary-text-text" value="#2563eb" style="flex: 1; font-family: monospace; font-size: 0.8rem;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Background</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <input type="color" id="brand-btn-secondary-bg" value="#ffffff" style="width: 40px; height: 32px; border: none; cursor: pointer; border-radius: 4px;">
                                            <input type="text" class="form-input" id="brand-btn-secondary-bg-text" value="#ffffff" style="flex: 1; font-family: monospace; font-size: 0.8rem;">
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; text-align: center;">
                                    <button id="preview-btn-secondary" style="padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 600;">Learn More</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Typography -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üî§ Typography</h3>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Heading Font</label>
                                <select class="form-input" id="brand-font-heading">
                                    <option value="Inter">Inter</option>
                                    <option value="Playfair Display">Playfair Display</option>
                                    <option value="Poppins">Poppins</option>
                                    <option value="Roboto">Roboto</option>
                                    <option value="Montserrat">Montserrat</option>
                                    <option value="Lora">Lora</option>
                                    <option value="Open Sans">Open Sans</option>
                                    <option value="Raleway">Raleway</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Body Font</label>
                                <select class="form-input" id="brand-font-body">
                                    <option value="Inter">Inter</option>
                                    <option value="Poppins">Poppins</option>
                                    <option value="Roboto">Roboto</option>
                                    <option value="Open Sans">Open Sans</option>
                                    <option value="Lato">Lato</option>
                                    <option value="Source Sans Pro">Source Sans Pro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Heading Weight</label>
                                <select class="form-input" id="brand-font-heading-weight">
                                    <option value="400">Regular (400)</option>
                                    <option value="500">Medium (500)</option>
                                    <option value="600">Semibold (600)</option>
                                    <option value="700" selected>Bold (700)</option>
                                    <option value="800">Extra Bold (800)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Body Weight</label>
                                <select class="form-input" id="brand-font-body-weight">
                                    <option value="300">Light (300)</option>
                                    <option value="400" selected>Regular (400)</option>
                                    <option value="500">Medium (500)</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                            <h2 id="preview-heading" style="margin: 0 0 0.5rem;">Heading Preview</h2>
                            <p id="preview-body" style="margin: 0; color: #64748b;">This is how your body text will look. The quick brown fox jumps over the lazy dog.</p>
                        </div>
                    </div>
                    
                    <!-- Custom CSS -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h3 class="card-title">üíª Custom CSS (Advanced)</h3>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">Add custom CSS that will be injected into your website. Use with caution.</p>
                        <textarea class="form-input" id="brand-custom-css" rows="6" placeholder="/* Your custom CSS here */
.my-class {
    color: red;
}" style="font-family: monospace; font-size: 0.85rem;"></textarea>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                        <button class="btn" onclick="saveBranding()">üíæ Save Branding</button>
                        <button class="btn" style="background: #64748b;" onclick="previewBranding()">üëÅÔ∏è Preview Theme</button>
                    </div>
                </div>

                <!-- API Documentation Section -->
                <div id="content-api" class="content-section" style="display: none;">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title">üîå API Documentation</h3>
                            <button class="btn" style="background: #10b981;" onclick="testApiConnection()">Test Connection</button>
                        </div>
                        
                        <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label class="form-label">API Base URL</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" class="form-input" id="api-base-url" value="" readonly style="font-family: monospace;">
                                    <button class="btn" style="background: #64748b;" onclick="copyApiUrl()">üìã Copy</button>
                                </div>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">Client ID</label>
                                <input type="text" class="form-input" id="api-client-id" value="1" readonly style="font-family: monospace; max-width: 100px;">
                            </div>
                        </div>
                        
                        <h4 style="margin-bottom: 1rem;">üìö Public Endpoints (no auth required)</h4>
                        
                        <div class="api-endpoint" style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace;">/api/public/client/{clientId}/site-config</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">Get complete site config (contact, branding, navigation)</p>
                        </div>
                        
                        <div class="api-endpoint" style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace;">/api/public/client/{clientId}/rooms</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">Get all rooms/properties for display</p>
                        </div>
                        
                        <div class="api-endpoint" style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace;">/api/public/client/{clientId}/page/{pageType}</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">Get page content (about, contact, terms, privacy)</p>
                        </div>
                        
                        <div class="api-endpoint" style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace;">/api/public/client/{clientId}/blog</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">Get published blog posts</p>
                        </div>
                        
                        <div class="api-endpoint" style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace;">/api/public/client/{clientId}/attractions</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">Get local attractions</p>
                        </div>
                        
                        <div class="api-endpoint" style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                                <code style="font-family: monospace;">/api/public/check-availability</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">Check room availability for dates</p>
                        </div>
                        
                        <details style="margin-top: 1rem;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--accent);">View Example Code</summary>
                            <pre style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; overflow-x: auto; margin-top: 0.5rem; font-size: 0.85rem;">
// Fetch site configuration
fetch('/api/public/client/1/site-config')
  .then(res => res.json())
  .then(data => {
    console.log(data.contact);  // Contact info
    console.log(data.branding); // Colors, logo
    console.log(data.navigation); // Menu items
  });

// Fetch rooms
fetch('/api/public/client/1/rooms')
  .then(res => res.json())
  .then(data => console.log(data.rooms));
                            </pre>
                        </details>
                    </div>
                </div>
            </div>

            <!-- Availability View -->
            <div id="availability" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Availability & Pricing</h2>
                            <p>View and manage all rooms in one place</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <button class="btn" onclick="syncBeds24()" id="sync-beds24-btn" style="background: #f59e0b;">üîÑ Beds24</button>
                            <button class="btn" onclick="syncHostaway()" id="sync-hostaway-btn" style="background: #1e3a5f;">üîÑ Hostaway</button>
                            <button class="btn" onclick="syncSmoobu()" id="sync-smoobu-btn" style="background: #00b4b4;">üîÑ Smoobu</button>
                        </div>
                    </div>
                </div>
                
                <!-- Property Filter Bar -->
                <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 600; white-space: nowrap;">Filter by Property:</label>
                            <select id="grid-property-filter" class="form-input" style="min-width: 250px; padding: 0.5rem;" onchange="filterGridByProperty()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-left: auto;">
                            <button class="btn btn-secondary" onclick="shiftGridDays(-7)">‚Äπ‚Äπ</button>
                            <button class="btn btn-secondary" onclick="shiftGridDays(-1)">‚Äπ</button>
                            <button class="btn btn-secondary" onclick="goToToday()">Today</button>
                            <button class="btn btn-secondary" onclick="shiftGridDays(1)">‚Ä∫</button>
                            <button class="btn btn-secondary" onclick="shiftGridDays(7)">‚Ä∫‚Ä∫</button>
                            <input type="date" id="grid-date-picker" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" onchange="jumpToDate(this.value)">
                            <span style="color: #6b7280;" id="grid-date-range"></span>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div style="display: flex; gap: 1.5rem; margin-bottom: 1rem; font-size: 0.85rem;">
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 16px; height: 16px; background: #d1fae5; border: 1px solid #10b981; border-radius: 3px;"></span>
                        Available
                    </span>
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 16px; height: 16px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 3px;"></span>
                        Booked
                    </span>
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 16px; height: 16px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 3px;"></span>
                        Blocked
                    </span>
                </div>

                <!-- Grid Calendar -->
                <div class="card" style="overflow-x: auto; padding: 0;">
                    <table id="availability-grid" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                        <!-- Will be rendered by JS -->
                    </table>
                </div>

                <!-- Quick Edit Panel -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">Quick Edit</h3>
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <label class="form-label">Room</label>
                            <select class="form-input" id="edit-room-select">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">From</label>
                            <input type="date" class="form-input" id="edit-from-date">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">To</label>
                            <input type="date" class="form-input" id="edit-to-date">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Action</label>
                            <select class="form-input" id="edit-action" onchange="toggleEditInputs()">
                                <option value="block">Block Dates</option>
                                <option value="unblock">Unblock</option>
                                <option value="price">Set Direct Price</option>
                                <option value="discount">Set % Discount</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; display: none;" id="edit-price-group">
                            <label class="form-label">Price ($)</label>
                            <input type="number" class="form-input" id="edit-price" placeholder="150" style="width: 100px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0; display: none;" id="edit-discount-group">
                            <label class="form-label">Discount %</label>
                            <input type="number" class="form-input" id="edit-discount" placeholder="10" style="width: 80px;">
                        </div>
                        <button class="btn" onclick="applyQuickEdit()">Apply</button>
                    </div>
                </div>

                <!-- API Feed Info (collapsed) -->
                <details style="margin-top: 1rem;">
                    <summary style="cursor: pointer; color: var(--text-secondary);">üì° API Feed Info</summary>
                    <div class="card" style="margin-top: 0.5rem;">
                        <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">Public endpoint for booking widget:</p>
                        <code style="display: block; background: var(--bg-primary); padding: 0.75rem; border-radius: 6px; font-size: 0.8rem;">
                            /api/availability/{room_id}?from=YYYY-MM-DD&to=YYYY-MM-DD
                        </code>
                    </div>
                </details>
            </div>

            <!-- Offers View -->
            <div id="offers" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Pricing & Offers</h2>
                            <p>Set your standard prices and create special offers</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="openBulkEditModal()" style="background: #f0fdf4; border-color: #86efac; color: #166534;">
                                <span>‚ö°</span>
                                <span>Bulk Edit</span>
                            </button>
                            <button class="btn" onclick="openAddOfferModal()">
                                <span>+</span>
                                <span>Add New Offer</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Property/Room Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="offers-property-select" class="form-input" onchange="loadOffersRooms()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="offers-room-select" class="form-input" onchange="loadOffersPricingGrid()">
                                <option value="">Select Room...</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                            <button class="btn btn-secondary" onclick="shiftOffersDays(-7)">‚Äπ‚Äπ</button>
                            <button class="btn btn-secondary" onclick="shiftOffersDays(-1)">‚Äπ</button>
                            <button class="btn btn-secondary" onclick="offersGoToToday()">Today</button>
                            <button class="btn btn-secondary" onclick="shiftOffersDays(1)">‚Ä∫</button>
                            <button class="btn btn-secondary" onclick="shiftOffersDays(7)">‚Ä∫‚Ä∫</button>
                        </div>
                    </div>
                </div>

                <!-- Pricing Grid -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div id="offers-pricing-grid">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            Select a property and room to view pricing
                        </p>
                    </div>
                </div>

                <!-- Offer Distribution Settings -->
                <div class="card" id="offer-distribution-card" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">üì¢ Offer Distribution</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                        Choose where each offer is available
                    </p>
                    <div id="offer-distribution-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Vouchers View -->
            <div id="vouchers" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Vouchers</h2>
                            <p>Gift cards, promo codes and discount vouchers</p>
                        </div>
                        <button class="btn" onclick="openAddVoucherModal()">
                            <span>+</span>
                            <span>Custom Voucher</span>
                        </button>
                    </div>
                </div>

                <!-- Quick Add Presets -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">üéüÔ∏è Quick Add Voucher Templates</h3>
                        <button class="btn btn-secondary" onclick="toggleVoucherPresets()" id="toggle-voucher-presets-btn" style="font-size: 0.85rem;">
                            Show All Categories ‚ñº
                        </button>
                    </div>
                    
                    <!-- Popular (always visible) -->
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <button class="preset-btn" onclick="quickAddVoucher('¬£25 Gift Voucher', 'monetary', 25)">üí∑ ¬£25 Gift Voucher</button>
                            <button class="preset-btn" onclick="quickAddVoucher('¬£50 Gift Voucher', 'monetary', 50)">üí∑ ¬£50 Gift Voucher</button>
                            <button class="preset-btn" onclick="quickAddVoucher('¬£100 Gift Voucher', 'monetary', 100)">üí∑ ¬£100 Gift Voucher</button>
                            <button class="preset-btn" onclick="quickAddVoucher('10% Off', 'percentage', 10)">üè∑Ô∏è 10% Off</button>
                            <button class="preset-btn" onclick="quickAddVoucher('15% Off', 'percentage', 15)">üè∑Ô∏è 15% Off</button>
                            <button class="preset-btn" onclick="quickAddVoucher('1-Night Stay', 'stay', 1)">üåô 1-Night Stay</button>
                            <button class="preset-btn" onclick="quickAddVoucher('Weekend Stay', 'stay', 2)">üåô Weekend Stay</button>
                            <button class="preset-btn" onclick="quickAddVoucher('Free Breakfast', 'addon', 0)">üç≥ Free Breakfast</button>
                            <button class="preset-btn" onclick="quickAddVoucher('Referral ¬£20', 'monetary', 20)">üë• Referral ¬£20</button>
                        </div>
                    </div>
                    
                    <!-- All Categories (hidden by default) -->
                    <div id="all-voucher-presets" style="display: none;">
                        
                        <!-- Monetary Value -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #10b981; margin-bottom: 0.5rem; font-size: 0.9rem;">üí∑ Monetary Value Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('¬£25 Hotel Credit', 'monetary', 25)">¬£25 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£50 Hotel Credit', 'monetary', 50)">¬£50 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£75 Hotel Credit', 'monetary', 75)">¬£75 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£100 Hotel Credit', 'monetary', 100)">¬£100 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£150 Hotel Credit', 'monetary', 150)">¬£150 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£200 Hotel Credit', 'monetary', 200)">¬£200 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£250 Hotel Credit', 'monetary', 250)">¬£250 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£500 Hotel Credit', 'monetary', 500)">¬£500 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Flexible Stay Voucher', 'monetary', 100)">Flexible Stay</button>
                            </div>
                        </div>
                        
                        <!-- Stay Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #6366f1; margin-bottom: 0.5rem; font-size: 0.9rem;">üåô Stay Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('1-Night Stay Voucher', 'stay', 1)">1-Night Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('2-Night Stay Voucher', 'stay', 2)">2-Night Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Weekend Stay Voucher', 'stay', 2)">Weekend Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Midweek Escape', 'stay', 2)">Midweek Escape</button>
                                <button class="preset-btn" onclick="quickAddVoucher('3-Night Break', 'stay', 3)">3-Night Break</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Week Stay Voucher', 'stay', 7)">Week Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Romantic Escape', 'stay', 2)">Romantic Escape</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Anniversary Stay', 'stay', 2)">Anniversary Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Honeymoon Package', 'stay', 3)">Honeymoon Package</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Stay + Breakfast', 'stay', 1)">Stay + Breakfast</button>
                            </div>
                        </div>
                        
                        <!-- Discount Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f59e0b; margin-bottom: 0.5rem; font-size: 0.9rem;">üè∑Ô∏è Discount Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('5% Off Stay', 'percentage', 5)">5% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('10% Off Stay', 'percentage', 10)">10% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('15% Off Stay', 'percentage', 15)">15% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('20% Off Stay', 'percentage', 20)">20% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('25% Off Stay', 'percentage', 25)">25% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£20 Off Booking', 'fixed', 20)">¬£20 Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£30 Off Booking', 'fixed', 30)">¬£30 Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£50 Off Booking', 'fixed', 50)">¬£50 Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('New Guest Discount', 'percentage', 10)">New Guest</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Returning Guest', 'percentage', 15)">Returning Guest</button>
                            </div>
                        </div>
                        
                        <!-- Dining Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ef4444; margin-bottom: 0.5rem; font-size: 0.9rem;">üçΩÔ∏è Dining Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Breakfast Voucher', 'addon', 15)">Breakfast</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Dinner Voucher', 'addon', 40)">Dinner</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Afternoon Tea', 'addon', 30)">Afternoon Tea</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Sunday Roast', 'addon', 25)">Sunday Roast</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Wine & Dine', 'addon', 75)">Wine & Dine</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Dining for Two', 'addon', 80)">Dining for Two</button>
                            </div>
                        </div>
                        
                        <!-- Spa & Wellness -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ec4899; margin-bottom: 0.5rem; font-size: 0.9rem;">üßñ Spa & Wellness Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Massage Session', 'addon', 60)">Massage</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Spa Day Pass', 'addon', 80)">Spa Day</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Couples Treatment', 'addon', 120)">Couples Treatment</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Facial Voucher', 'addon', 50)">Facial</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Yoga Retreat', 'addon', 45)">Yoga Retreat</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Sauna & Steam', 'addon', 30)">Sauna & Steam</button>
                            </div>
                        </div>
                        
                        <!-- Experience Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #3b82f6; margin-bottom: 0.5rem; font-size: 0.9rem;">üéØ Experience Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Wine Tasting', 'addon', 40)">Wine Tasting</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Cooking Class', 'addon', 75)">Cooking Class</button>
                                <button class="preset-btn" onclick="quickAddVoucher('City Tour', 'addon', 35)">City Tour</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Boat Trip', 'addon', 50)">Boat Trip</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Golf Experience', 'addon', 100)">Golf Experience</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Ski Package', 'addon', 120)">Ski Package</button>
                            </div>
                        </div>
                        
                        <!-- Celebration Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #8b5cf6; margin-bottom: 0.5rem; font-size: 0.9rem;">üéÅ Celebration Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Birthday Voucher', 'monetary', 50)">Birthday</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Anniversary Voucher', 'monetary', 75)">Anniversary</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Valentine\\'s Stay', 'stay', 1)">Valentine's</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Mother\\'s Day', 'monetary', 50)">Mother's Day</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Father\\'s Day', 'monetary', 50)">Father's Day</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Christmas Gift', 'monetary', 100)">Christmas</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Graduation Gift', 'monetary', 75)">Graduation</button>
                            </div>
                        </div>
                        
                        <!-- Loyalty Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #14b8a6; margin-bottom: 0.5rem; font-size: 0.9rem;">‚≠ê Loyalty & Rewards</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Thank You Voucher', 'monetary', 25)">Thank You</button>
                                <button class="preset-btn" onclick="quickAddVoucher('VIP Guest Voucher', 'percentage', 20)">VIP Guest</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Repeat Stay Credit', 'monetary', 30)">Repeat Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Referral Reward', 'monetary', 20)">Referral Reward</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Review Incentive', 'percentage', 10)">Review Incentive</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Welcome Back', 'percentage', 15)">Welcome Back</button>
                            </div>
                        </div>
                        
                        <!-- Corporate Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #64748b; margin-bottom: 0.5rem; font-size: 0.9rem;">üíº Corporate & Group</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Staff Reward', 'monetary', 100)">Staff Reward</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Client Gift', 'monetary', 150)">Client Gift</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Team Retreat', 'percentage', 15)">Team Retreat</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Conference Credit', 'monetary', 200)">Conference Credit</button>
                            </div>
                        </div>
                        
                        <!-- Compensation Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #dc2626; margin-bottom: 0.5rem; font-size: 0.9rem;">üîÑ Compensation & Recovery</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Refund Credit', 'monetary', 0)">Refund Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Apology Voucher', 'percentage', 20)">Apology Voucher</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Disruption Compensation', 'monetary', 50)">Disruption Comp</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Future Stay Credit', 'monetary', 0)">Future Stay</button>
                            </div>
                        </div>
                        
                        <!-- Promotional -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f97316; margin-bottom: 0.5rem; font-size: 0.9rem;">üì¢ Promotional</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Book Direct Discount', 'percentage', 10)">Book Direct</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Black Friday', 'percentage', 25)">Black Friday</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Flash Sale', 'percentage', 30)">Flash Sale</button>
                                <button class="preset-btn" onclick="quickAddVoucher('New Launch', 'percentage', 20)">New Launch</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Early Bird', 'percentage', 15)">Early Bird</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Last Minute', 'percentage', 20)">Last Minute</button>
                            </div>
                        </div>
                        
                        <!-- Service-Specific -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #06b6d4; margin-bottom: 0.5rem; font-size: 0.9rem;">üé´ Service Add-ons</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Late Check-out', 'addon', 0)">Late Check-out</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Room Upgrade', 'addon', 0)">Room Upgrade</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Free Breakfast', 'addon', 0)">Free Breakfast</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Free Parking', 'addon', 0)">Free Parking</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Free Spa Access', 'addon', 0)">Free Spa Access</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Airport Transfer', 'addon', 0)">Airport Transfer</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Welcome Wine', 'addon', 0)">Welcome Wine</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Kids Eat Free', 'addon', 0)">Kids Eat Free</button>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- Active Vouchers List -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Your Vouchers</h3>
                    <div id="vouchers-list">
                        <div class="empty-state">
                            <div class="empty-icon">üéüÔ∏è</div>
                            <h3>No Vouchers Created</h3>
                            <p>Click any template above or create a custom voucher</p>
                            <button class="btn" onclick="openAddVoucherModal()">Create Custom Voucher</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upsells View -->
            <div id="upsells" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Upsells</h2>
                            <p>Additional services and add-ons guests can purchase</p>
                        </div>
                        <button class="btn" onclick="openAddUpsellModal()">
                            <span>+</span>
                            <span>Custom Upsell</span>
                        </button>
                    </div>
                </div>

                <!-- Quick Add Presets -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">‚ö° Quick Add Popular Upsells</h3>
                        <button class="btn btn-secondary" onclick="toggleUpsellPresets()" id="toggle-presets-btn" style="font-size: 0.85rem;">
                            Show All Categories ‚ñº
                        </button>
                    </div>
                    
                    <!-- Popular/Common (always visible) -->
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="popular-upsells">
                            <button class="preset-btn" onclick="quickAddUpsell('Early check-in', 25, 'per_booking')">‚è∞ Early check-in</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Late check-out', 25, 'per_booking')">‚è∞ Late check-out</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Airport transfer', 50, 'per_booking')">üöó Airport transfer</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Breakfast', 15, 'per_guest_per_night')">üç≥ Breakfast</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Parking', 15, 'per_night')">üÖøÔ∏è Parking</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Pet fee', 30, 'per_booking')">üêæ Pet fee</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Champagne on arrival', 45, 'per_booking')">üçæ Champagne on arrival</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Welcome hamper', 35, 'per_booking')">üß∫ Welcome hamper</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Mid-stay cleaning', 50, 'per_booking')">üßπ Mid-stay cleaning</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Extra bed', 25, 'per_night')">üõèÔ∏è Extra bed</button>
                        </div>
                    </div>
                    
                    <!-- All Categories (hidden by default) -->
                    <div id="all-upsell-presets" style="display: none;">
                        
                        <!-- Accommodation Upgrades -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #6366f1; margin-bottom: 0.5rem; font-size: 0.9rem;">üè® Accommodation Upgrades</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Room upgrade', 50, 'per_night')">Room upgrade</button>
                                <button class="preset-btn" onclick="quickAddUpsell('High-floor room', 20, 'per_night')">High-floor room</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Sea view room', 30, 'per_night')">Sea view</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Balcony upgrade', 25, 'per_night')">Balcony upgrade</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Executive floor access', 40, 'per_night')">Executive floor</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Connecting rooms', 30, 'per_night')">Connecting rooms</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Premium Wi-Fi', 10, 'per_night')">Premium Wi-Fi</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pillow menu upgrade', 15, 'per_booking')">Pillow menu</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Gaming console rental', 20, 'per_night')">Gaming console</button>
                            </div>
                        </div>
                        
                        <!-- Guest Comfort -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #10b981; margin-bottom: 0.5rem; font-size: 0.9rem;">üõèÔ∏è Guest Comfort & Convenience</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Extra bed / rollaway', 25, 'per_night')">Extra bed</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Baby cot / crib', 15, 'per_night')">Baby cot</button>
                                <button class="preset-btn" onclick="quickAddUpsell('High chair', 10, 'per_booking')">High chair</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Extra towels', 10, 'per_booking')">Extra towels</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Bathrobe & slippers', 20, 'per_booking')">Bathrobe & slippers</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Luxury toiletries', 25, 'per_booking')">Luxury toiletries</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Laundry service', 30, 'per_booking')">Laundry service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Dry cleaning', 25, 'per_booking')">Dry cleaning</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Turndown service', 15, 'per_night')">Turndown service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Express housekeeping', 20, 'per_booking')">Express housekeeping</button>
                            </div>
                        </div>
                        
                        <!-- Food & Beverage -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f59e0b; margin-bottom: 0.5rem; font-size: 0.9rem;">üç≥ Food & Beverage</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Continental breakfast', 12, 'per_guest_per_night')">Continental breakfast</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Full English breakfast', 18, 'per_guest_per_night')">Full English breakfast</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Breakfast in room', 25, 'per_guest_per_night')">Breakfast in room</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Welcome drinks', 20, 'per_booking')">Welcome drinks</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Welcome hamper', 35, 'per_booking')">Welcome hamper</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Champagne on arrival', 45, 'per_booking')">Champagne on arrival</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Wine on arrival', 30, 'per_booking')">Wine on arrival</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Local produce basket', 40, 'per_booking')">Local produce basket</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Minibar package', 50, 'per_booking')">Minibar package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Fridge pre-stocking', 40, 'per_booking')">Fridge pre-stocking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Private chef', 200, 'per_booking')">Private chef</button>
                                <button class="preset-btn" onclick="quickAddUpsell('BBQ pack', 35, 'per_booking')">BBQ pack</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Romantic dinner setup', 75, 'per_booking')">Romantic dinner</button>
                            </div>
                        </div>
                        
                        <!-- Celebrations -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ec4899; margin-bottom: 0.5rem; font-size: 0.9rem;">üíê Celebrations & Occasions</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Birthday package', 50, 'per_booking')">Birthday package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Anniversary package', 60, 'per_booking')">Anniversary package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Honeymoon package', 80, 'per_booking')">Honeymoon package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Flowers', 40, 'per_booking')">Flowers</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Chocolates', 25, 'per_booking')">Chocolates</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Balloons & decorations', 35, 'per_booking')">Balloons</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Celebration cake', 45, 'per_booking')">Celebration cake</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Rose petal decorations', 50, 'per_booking')">Rose petals</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Proposal setup', 150, 'per_booking')">Proposal setup</button>
                            </div>
                        </div>
                        
                        <!-- Transport -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #3b82f6; margin-bottom: 0.5rem; font-size: 0.9rem;">üöó Transport & Parking</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Airport transfer', 50, 'per_booking')">Airport transfer</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Private driver', 100, 'per_booking')">Private driver</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Shuttle service', 20, 'per_guest')">Shuttle service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Parking', 15, 'per_night')">Parking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Valet parking', 25, 'per_night')">Valet parking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('EV charging', 15, 'per_night')">EV charging</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Bicycle rental', 15, 'per_day')">Bicycle rental</button>
                                <button class="preset-btn" onclick="quickAddUpsell('E-bike rental', 30, 'per_day')">E-bike rental</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Scooter rental', 40, 'per_day')">Scooter rental</button>
                            </div>
                        </div>
                        
                        <!-- Cleaning (Airbnb style) -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #14b8a6; margin-bottom: 0.5rem; font-size: 0.9rem;">üßπ Cleaning & Property Services</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Mid-stay cleaning', 50, 'per_booking')">Mid-stay cleaning</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Deep clean upgrade', 75, 'per_booking')">Deep clean</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Daily housekeeping', 30, 'per_night')">Daily housekeeping</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Linen swap', 25, 'per_booking')">Linen swap</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pool cleaning', 50, 'per_booking')">Pool cleaning</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Hot tub servicing', 40, 'per_booking')">Hot tub servicing</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Firewood bundle', 20, 'per_booking')">Firewood bundle</button>
                                <button class="preset-btn" onclick="quickAddUpsell('BBQ cleaning', 25, 'per_booking')">BBQ cleaning</button>
                            </div>
                        </div>
                        
                        <!-- Pets -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #8b5cf6; margin-bottom: 0.5rem; font-size: 0.9rem;">üêæ Pet Services</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Pet fee', 30, 'per_booking')">Pet fee</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet welcome pack', 25, 'per_booking')">Pet welcome pack</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Dog bed', 15, 'per_booking')">Dog bed</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet food bowls', 10, 'per_booking')">Food bowls</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet sitting', 40, 'per_day')">Pet sitting</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Dog walking', 25, 'per_day')">Dog walking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet cleaning fee', 50, 'per_booking')">Pet cleaning fee</button>
                            </div>
                        </div>
                        
                        <!-- Business -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #64748b; margin-bottom: 0.5rem; font-size: 0.9rem;">üíª Business & Work</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Dedicated workspace', 20, 'per_night')">Dedicated workspace</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Printer access', 15, 'per_booking')">Printer access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Meeting room hire', 75, 'per_booking')">Meeting room</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Business lounge', 30, 'per_night')">Business lounge</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Video conference setup', 25, 'per_booking')">Video conference</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Projector hire', 40, 'per_booking')">Projector hire</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Co-working pass', 25, 'per_day')">Co-working pass</button>
                            </div>
                        </div>
                        
                        <!-- Wellness -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #06b6d4; margin-bottom: 0.5rem; font-size: 0.9rem;">üèä Leisure & Wellness</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Gym access', 15, 'per_night')">Gym access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Spa access', 40, 'per_guest')">Spa access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Sauna / steam room', 25, 'per_guest')">Sauna / steam</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Hot tub access', 30, 'per_night')">Hot tub access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Massage', 80, 'per_guest')">Massage</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Yoga class', 25, 'per_guest')">Yoga class</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Personal trainer', 60, 'per_booking')">Personal trainer</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pool cabana', 50, 'per_day')">Pool cabana</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Tennis court', 30, 'per_booking')">Tennis court</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Golf booking', 100, 'per_guest')">Golf booking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Wine tasting', 50, 'per_guest')">Wine tasting</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Cooking class', 75, 'per_guest')">Cooking class</button>
                            </div>
                        </div>
                        
                        <!-- Family -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f472b6; margin-bottom: 0.5rem; font-size: 0.9rem;">üßí Family & Children</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Babysitting', 20, 'per_hour')">Babysitting</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Nanny service', 150, 'per_day')">Nanny service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Kids activity pack', 20, 'per_booking')">Kids activity pack</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Children\'s meals', 12, 'per_guest_per_night')">Children's meals</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Baby proofing', 25, 'per_booking')">Baby proofing</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Toy rental', 15, 'per_booking')">Toy rental</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pushchair hire', 20, 'per_booking')">Pushchair hire</button>
                            </div>
                        </div>
                        
                        <!-- Protection -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ef4444; margin-bottom: 0.5rem; font-size: 0.9rem;">üö® Protection & Flexibility</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Flexible cancellation', 25, 'per_booking')">Flexible cancellation</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Date change protection', 20, 'per_booking')">Date change protection</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Damage waiver', 30, 'per_booking')">Damage waiver</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Travel insurance', 40, 'per_booking')">Travel insurance</button>
                            </div>
                        </div>
                        
                        <!-- Concierge -->
                        <div style="margin-bottom: 0;">
                            <h4 style="color: #a855f7; margin-bottom: 0.5rem; font-size: 0.9rem;">üõéÔ∏è Concierge Services</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Local guide', 50, 'per_booking')">Local guide</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Tour booking', 30, 'per_booking')">Tour booking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Event tickets', 25, 'per_booking')">Event tickets</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Restaurant reservations', 15, 'per_booking')">Restaurant reservations</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Personal itinerary', 75, 'per_booking')">Personal itinerary</button>
                                <button class="preset-btn" onclick="quickAddUpsell('VIP entry service', 100, 'per_booking')">VIP entry</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Upsells List -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Your Upsells</h3>
                    <div id="upsells-list">
                        <div class="empty-state">
                            <div class="empty-icon">üéÅ</div>
                            <h3>No Upsells Configured</h3>
                            <p>Click any preset above or create a custom upsell</p>
                            <button class="btn" onclick="openAddUpsellModal()">Create Custom Upsell</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fees View -->
            <div id="fees" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Fees</h2>
                            <p>Mandatory charges and taxes applied to bookings</p>
                        </div>
                        <button class="btn" onclick="openAddFeeModal()">
                            <span>+</span>
                            <span>Add Fee</span>
                        </button>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 1rem; background: #fef3c7; border: 1px solid #fde68a;">
                    <h3 style="color: #92400e; margin-bottom: 0.5rem;">üí° Common Fee Types</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; color: #78350f;">
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üßπ Cleaning fee</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üèõÔ∏è City/Tourist tax</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üõ°Ô∏è Damage deposit</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üêï Pet fee</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üî• Resort fee</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üÖøÔ∏è Parking fee</span>
                    </div>
                </div>

                <div class="card">
                    <div id="fees-list">
                        <div class="empty-state">
                            <div class="empty-icon">üíµ</div>
                            <h3>No Fees Configured</h3>
                            <p>Add cleaning fees, taxes, or other charges</p>
                            <button class="btn" onclick="openAddFeeModal()">Add Your First Fee</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Taxes View -->
            <div id="taxes" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Tourist Taxes</h2>
                            <p>Government-mandated taxes that vary by location</p>
                        </div>
                        <button class="btn" onclick="openAddTaxModal()">
                            <span>+</span>
                            <span>Add Tax</span>
                        </button>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 1rem; background: linear-gradient(135deg, #dbeafe 0%, #ede9fe 100%); border: 1px solid #c7d2fe;">
                    <h3 style="color: #4338ca; margin-bottom: 0.75rem;">üåç Tourist Tax Guide</h3>
                    <p style="color: #5b21b6; margin-bottom: 1rem; font-size: 0.9rem;">
                        Tourist taxes vary significantly by country and city. Configure them based on your property location.
                    </p>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üá´üá∑ France: ‚Ç¨2-‚Ç¨11 PPPN
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üáÆüáπ Italy: ‚Ç¨1-‚Ç¨10 PPPN
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üá≥üá± Amsterdam: 12.5%
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üá∫üá∏ USA: 10-16%
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üá™üá∏ Spain: ‚Ç¨1-‚Ç¨7 PPPN
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üá¶üá™ Dubai: 7-20 AED PPPN
                        </span>
                    </div>
                </div>

                <div class="card">
                    <div id="taxes-list">
                        <div class="empty-state">
                            <div class="empty-icon">üèõÔ∏è</div>
                            <h3>No Taxes Configured</h3>
                            <p>Add tourist taxes based on your property's location requirements</p>
                            <button class="btn" onclick="openAddTaxModal()">Add Your First Tax</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marketing View -->
            <div id="marketing" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Marketing Features & Tags</h2>
                            <p>Define what makes your property special to help travel agents find you</p>
                        </div>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Select Property</label>
                            <select id="marketing-property-select" class="form-input" onchange="loadPropertyFeatures()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div id="marketing-save-btn" style="display: none;">
                            <button class="btn" onclick="savePropertyFeatures()" style="background: #16a34a;">
                                üíæ Save Features
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Features Content -->
                <div id="marketing-content" style="display: none;">
                    
                    <!-- AI Suggestion Panel -->
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; color: white;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.5rem;">ü§ñ</span>
                            <h4 style="margin: 0; font-weight: 600;">AI Feature Suggestions</h4>
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <textarea id="marketing-ai-prompt" rows="2" placeholder="Describe your property... e.g. 'Victorian B&B near the beach, dog-friendly, great for romantic getaways and walking holidays'" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; font-size: 0.9rem;"></textarea>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="aiSuggestFeatures()" style="background: white; color: #8b5cf6; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer;">ü™Ñ Suggest Features</button>
                        </div>
                    </div>
                    
                    <!-- AI Suggestions Results (hidden by default) -->
                    <div id="ai-suggestions-results" class="card" style="margin-bottom: 1rem; display: none; border: 2px solid #8b5cf6;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>ü§ñ</span> AI Suggested Features
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Click on suggestions to add them to your property
                        </p>
                        <div id="ai-suggestions-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <!-- AI suggestions will appear here -->
                        </div>
                    </div>
                    
                    <!-- Activities -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üèÉ</span> Activities & Experiences
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            What activities can guests enjoy at or near your property?
                        </p>
                        <div class="feature-grid" data-category="activities">
                            <label class="feature-item"><input type="checkbox" data-feature="walking"> ü•æ Walking / Hiking</label>
                            <label class="feature-item"><input type="checkbox" data-feature="cycling"> üö¥ Cycling</label>
                            <label class="feature-item"><input type="checkbox" data-feature="golf"> ‚õ≥ Golf</label>
                            <label class="feature-item"><input type="checkbox" data-feature="fishing"> üé£ Fishing</label>
                            <label class="feature-item"><input type="checkbox" data-feature="water-sports"> üèÑ Water Sports</label>
                            <label class="feature-item"><input type="checkbox" data-feature="horse-riding"> üê¥ Horse Riding</label>
                            <label class="feature-item"><input type="checkbox" data-feature="skiing"> ‚õ∑Ô∏è Skiing / Winter Sports</label>
                            <label class="feature-item"><input type="checkbox" data-feature="birdwatching"> ü¶Ö Birdwatching / Wildlife</label>
                            <label class="feature-item"><input type="checkbox" data-feature="wine-tasting"> üç∑ Wine Tasting</label>
                            <label class="feature-item"><input type="checkbox" data-feature="cooking-classes"> üë®‚Äçüç≥ Cooking Classes</label>
                        </div>
                    </div>

                    <!-- Guest Types -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üë•</span> Guest Types & Accessibility
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Who is your property best suited for?
                        </p>
                        <div class="feature-grid" data-category="guest-types">
                            <label class="feature-item"><input type="checkbox" data-feature="pet-friendly"> üêï Pet Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="family-friendly"> üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="adults-only"> üç∏ Adults Only</label>
                            <label class="feature-item"><input type="checkbox" data-feature="wheelchair-accessible"> ‚ôø Wheelchair Accessible</label>
                            <label class="feature-item"><input type="checkbox" data-feature="senior-friendly"> üë¥ Senior Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="lgbtq-friendly"> üè≥Ô∏è‚Äçüåà LGBTQ+ Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="business-travelers"> üíº Business Travelers</label>
                            <label class="feature-item"><input type="checkbox" data-feature="digital-nomads"> üíª Digital Nomads</label>
                        </div>
                    </div>

                    <!-- Themes & Experiences -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚ú®</span> Themes & Experiences
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            What type of experience does your property offer?
                        </p>
                        <div class="feature-grid" data-category="themes">
                            <label class="feature-item"><input type="checkbox" data-feature="romantic"> üíï Romantic / Couples</label>
                            <label class="feature-item"><input type="checkbox" data-feature="wellness-spa"> üßò Wellness / Spa</label>
                            <label class="feature-item"><input type="checkbox" data-feature="adventure"> üèîÔ∏è Adventure</label>
                            <label class="feature-item"><input type="checkbox" data-feature="eco-friendly"> üåø Eco-Friendly / Sustainable</label>
                            <label class="feature-item"><input type="checkbox" data-feature="luxury"> üëë Luxury</label>
                            <label class="feature-item"><input type="checkbox" data-feature="budget-friendly"> üí∞ Budget Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="historic"> üè∞ Historic / Heritage</label>
                            <label class="feature-item"><input type="checkbox" data-feature="boutique"> üé® Boutique / Unique</label>
                            <label class="feature-item"><input type="checkbox" data-feature="farm-stay"> üåæ Farm Stay / Agritourism</label>
                            <label class="feature-item"><input type="checkbox" data-feature="glamping"> ‚õ∫ Glamping</label>
                        </div>
                    </div>

                    <!-- Location Features -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìç</span> Location & Setting
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Describe your property's location and surroundings
                        </p>
                        <div class="feature-grid" data-category="location">
                            <label class="feature-item"><input type="checkbox" data-feature="beachfront"> üèñÔ∏è Beachfront</label>
                            <label class="feature-item"><input type="checkbox" data-feature="mountain-view"> üèîÔ∏è Mountain View</label>
                            <label class="feature-item"><input type="checkbox" data-feature="countryside"> üåÑ Countryside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="city-centre"> üèôÔ∏è City Centre</label>
                            <label class="feature-item"><input type="checkbox" data-feature="lakeside"> üåä Lakeside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="riverside"> üèûÔ∏è Riverside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="forest"> üå≤ Forest / Woodland</label>
                            <label class="feature-item"><input type="checkbox" data-feature="village"> üèòÔ∏è Village / Rural</label>
                            <label class="feature-item"><input type="checkbox" data-feature="coastal"> ‚öì Coastal</label>
                            <label class="feature-item"><input type="checkbox" data-feature="island"> üèùÔ∏è Island</label>
                        </div>
                    </div>

                    <!-- Property Amenities -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üè†</span> Notable Amenities
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Highlight standout amenities that set you apart
                        </p>
                        <div class="feature-grid" data-category="amenities">
                            <label class="feature-item"><input type="checkbox" data-feature="ev-charging"> ‚ö° EV Charging</label>
                            <label class="feature-item"><input type="checkbox" data-feature="swimming-pool"> üèä Swimming Pool</label>
                            <label class="feature-item"><input type="checkbox" data-feature="hot-tub"> üõÅ Hot Tub / Jacuzzi</label>
                            <label class="feature-item"><input type="checkbox" data-feature="sauna"> üßñ Sauna</label>
                            <label class="feature-item"><input type="checkbox" data-feature="gym"> üèãÔ∏è Gym / Fitness</label>
                            <label class="feature-item"><input type="checkbox" data-feature="garden"> üå≥ Garden</label>
                            <label class="feature-item"><input type="checkbox" data-feature="bbq"> üçñ BBQ Area</label>
                            <label class="feature-item"><input type="checkbox" data-feature="fireplace"> üî• Fireplace</label>
                            <label class="feature-item"><input type="checkbox" data-feature="private-parking"> üÖøÔ∏è Private Parking</label>
                            <label class="feature-item"><input type="checkbox" data-feature="restaurant"> üçΩÔ∏è On-site Restaurant</label>
                        </div>
                    </div>

                    <!-- Custom Features -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚ûï</span> Custom Features
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Add any unique features not listed above
                        </p>
                        <div id="custom-features-list" style="margin-bottom: 1rem;">
                            <!-- Custom features will be added here -->
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="new-custom-feature" class="form-input" placeholder="e.g., Treehouse, Observatory, Private Cinema" style="flex: 1;">
                            <button class="btn btn-secondary" onclick="addCustomFeature()">+ Add</button>
                        </div>
                    </div>

                    <!-- Room Exclusions -->
                    <div class="card" id="room-exclusions-card" style="margin-bottom: 1rem; display: none;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üö´</span> Room Exclusions
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Some features may not apply to all rooms. Select features to see which rooms to exclude.
                        </p>
                        <div id="room-exclusions-content">
                            <p style="color: var(--text-secondary); font-style: italic;">Select a feature above to manage room exclusions</p>
                        </div>
                    </div>

                </div>

                <!-- Empty State -->
                <div id="marketing-empty" class="card">
                    <div class="empty-state">
                        <div class="empty-icon">üì£</div>
                        <h3>Select a Property</h3>
                        <p>Choose a property above to manage its marketing features and tags</p>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Header & Logo -->
            <div id="wb-header" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìå Header & Logo</h2>
                            <p>Site identity and navigation</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('header')">üíæ Save & Sync</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Logo</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Logo Image</label>
                            <div id="wb-header-logo-preview" style="width: 200px; height: 80px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border: 2px dashed #e2e8f0;">
                                <span style="color: #94a3b8;">No logo uploaded</span>
                            </div>
                            <input type="file" id="wb-header-logo" accept="image/*" onchange="previewWebsiteImage('header-logo')">
                            <small class="form-hint">Recommended: PNG with transparent background, max 400x150px</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Site Name (if no logo)</label>
                            <input type="text" class="form-input" id="wb-header-site-name" placeholder="e.g., The Grand Hotel">
                            <small class="form-hint">Displayed if no logo is uploaded</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tagline</label>
                            <input type="text" class="form-input" id="wb-header-tagline" placeholder="e.g., Luxury Accommodation Since 1985">
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">Navigation Menu</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="wb-header-show-rooms" checked> Show "Rooms" link
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="wb-header-show-about" checked> Show "About" link
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="wb-header-show-contact" checked> Show "Contact" link
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="wb-header-show-blog" checked> Show "Blog" link
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Book Now Button Text</label>
                            <input type="text" class="form-input" id="wb-header-book-button" placeholder="e.g., Book Now">
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">Header Style</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Header Background</label>
                            <select class="form-select" id="wb-header-bg-style">
                                <option value="transparent">Transparent (over hero)</option>
                                <option value="white">White</option>
                                <option value="dark">Dark</option>
                                <option value="primary">Primary Color</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="wb-header-sticky" checked> Sticky Header (stays at top when scrolling)
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Hero Section -->
            <div id="wb-hero" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üñºÔ∏è Hero Section</h2>
                            <p>The main banner at the top of your website</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('hero')">üíæ Save & Sync</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Hero Headline</label>
                            <input type="text" class="form-input" id="wb-hero-headline" placeholder="e.g., Welcome to Paradise">
                            <small class="form-hint">The main text visitors see first</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hero Subheadline</label>
                            <input type="text" class="form-input" id="wb-hero-subheadline" placeholder="e.g., Experience luxury in the heart of the countryside">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Button Text</label>
                            <input type="text" class="form-input" id="wb-hero-button-text" placeholder="e.g., Book Now">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Button Link</label>
                            <input type="text" class="form-input" id="wb-hero-button-link" placeholder="e.g., #booking or /rooms">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Background Image</label>
                            <div id="wb-hero-image-preview" style="width: 100%; height: 200px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                                <span style="color: #94a3b8;">No image selected</span>
                            </div>
                            <input type="file" id="wb-hero-image" accept="image/*" onchange="previewWebsiteImage('hero')">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Overlay Opacity</label>
                            <input type="range" id="wb-hero-overlay" min="0" max="100" value="50" style="width: 100%;">
                            <small class="form-hint">Darken the background to make text more readable</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Intro Section -->
            <div id="wb-intro" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìù Intro Section</h2>
                            <p>Welcome text and feature highlights</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('intro')">üíæ Save & Sync</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Section Title</label>
                            <input type="text" class="form-input" id="wb-intro-title" placeholder="e.g., Why Choose Us">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Intro Text</label>
                            <textarea class="form-textarea" id="wb-intro-text" rows="4" placeholder="Welcome text about your property..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Feature 1</label>
                            <input type="text" class="form-input" id="wb-intro-feature1" placeholder="e.g., üåä Beachfront Location">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Feature 2</label>
                            <input type="text" class="form-input" id="wb-intro-feature2" placeholder="e.g., üç≥ Award-winning Breakfast">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Feature 3</label>
                            <input type="text" class="form-input" id="wb-intro-feature3" placeholder="e.g., üöó Free Parking">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Feature 4</label>
                            <input type="text" class="form-input" id="wb-intro-feature4" placeholder="e.g., üì∂ Fast WiFi">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Featured Properties -->
            <div id="wb-featured" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üè® Featured Properties</h2>
                            <p>Choose which properties/rooms to highlight</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('featured')">üíæ Save & Sync</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Section Title</label>
                            <input type="text" class="form-input" id="wb-featured-title" placeholder="e.g., Our Rooms">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Section Subtitle</label>
                            <input type="text" class="form-input" id="wb-featured-subtitle" placeholder="e.g., Choose your perfect stay">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Display Mode</label>
                            <select class="form-select" id="wb-featured-mode">
                                <option value="all">Show All Rooms</option>
                                <option value="featured">Featured Only</option>
                                <option value="selected">Select Specific</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Number to Display</label>
                            <select class="form-select" id="wb-featured-count">
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="6">6</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div id="wb-featured-rooms-list" style="margin-top: 1rem;">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Reviews -->
            <div id="wb-reviews" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>‚≠ê Reviews Section</h2>
                            <p>Customer testimonials and ratings</p>
                        </div>
                        <button class="btn" onclick="addWebsiteReview()">+ Add Review</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Section Title</label>
                            <input type="text" class="form-input" id="wb-reviews-title" placeholder="e.g., What Our Guests Say">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="wb-reviews-show" checked> Show Reviews Section
                            </label>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">Reviews</h3>
                    </div>
                    <div class="card-body" id="wb-reviews-list">
                        <div class="empty-state">
                            <p>No reviews yet. Click "Add Review" to add testimonials.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: CTA Section -->
            <div id="wb-cta" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üöÄ Call to Action</h2>
                            <p>Encourage visitors to book</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('cta')">üíæ Save & Sync</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">CTA Headline</label>
                            <input type="text" class="form-input" id="wb-cta-headline" placeholder="e.g., Ready to Book Your Stay?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CTA Text</label>
                            <textarea class="form-textarea" id="wb-cta-text" rows="2" placeholder="e.g., Book directly with us for the best rates and exclusive perks."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Button Text</label>
                            <input type="text" class="form-input" id="wb-cta-button-text" placeholder="e.g., Check Availability">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Button Link</label>
                            <input type="text" class="form-input" id="wb-cta-button-link" placeholder="e.g., #booking">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Background Color</label>
                            <input type="color" id="wb-cta-bg-color" value="#6366f1" style="width: 100px; height: 40px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Footer -->
            <div id="wb-footer" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üë£ Footer</h2>
                            <p>Bottom section of your website</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('footer')">üíæ Save & Sync</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Links</h3>
                    </div>
                    <div class="card-body">
                        <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">Choose which links appear in your footer's Quick Links section</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="wb-footer-link-home" checked> Home
                                </label>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="wb-footer-link-rooms" checked> Rooms
                                </label>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="wb-footer-link-about" checked> About
                                </label>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="wb-footer-link-contact" checked> Contact
                                </label>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="wb-footer-link-blog"> Blog
                                </label>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="wb-footer-link-faq"> FAQ
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">Legal Links</h3>
                    </div>
                    <div class="card-body">
                        <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">These appear in the Legal section of your footer</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="wb-footer-link-terms" checked> Terms & Conditions
                                </label>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="wb-footer-link-privacy" checked> Privacy Policy
                                </label>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="wb-footer-link-cookies"> Cookie Policy
                                </label>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="wb-footer-link-cancellation"> Cancellation Policy
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">Contact Info in Footer</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="wb-footer-show-address" checked> Show Address
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="wb-footer-show-phone" checked> Show Phone
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="wb-footer-show-email" checked> Show Email
                            </label>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">Social Media & Branding</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Copyright Text</label>
                            <input type="text" class="form-input" id="wb-footer-copyright" placeholder="e.g., ¬© 2025 Your Property Name. All rights reserved.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Footer Tagline</label>
                            <input type="text" class="form-input" id="wb-footer-tagline" placeholder="e.g., Experience the difference">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="wb-footer-show-social" checked> Show Social Media Icons
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Facebook URL</label>
                            <input type="text" class="form-input" id="wb-footer-facebook" placeholder="https://facebook.com/yourpage">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Instagram URL</label>
                            <input type="text" class="form-input" id="wb-footer-instagram" placeholder="https://instagram.com/yourpage">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Twitter/X URL</label>
                            <input type="text" class="form-input" id="wb-footer-twitter" placeholder="https://twitter.com/yourpage">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Styles & Colors -->
            <div id="wb-styles" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üé® Styles & Colors</h2>
                            <p>Customize your website appearance</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('styles')">üíæ Save & Sync</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Colors</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Primary Color</label>
                                <input type="color" id="wb-style-primary" value="#6366f1" style="width: 100%; height: 50px; border-radius: 8px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Secondary Color</label>
                                <input type="color" id="wb-style-secondary" value="#8b5cf6" style="width: 100%; height: 50px; border-radius: 8px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Accent Color</label>
                                <input type="color" id="wb-style-accent" value="#10b981" style="width: 100%; height: 50px; border-radius: 8px;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <input type="color" id="wb-style-text" value="#1e293b" style="width: 100%; height: 50px; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">Typography</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading Font</label>
                            <select class="form-select" id="wb-style-heading-font">
                                <option value="Playfair Display">Playfair Display (Elegant)</option>
                                <option value="Montserrat">Montserrat (Modern)</option>
                                <option value="Roboto">Roboto (Clean)</option>
                                <option value="Lora">Lora (Classic)</option>
                                <option value="Open Sans">Open Sans (Friendly)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Body Font</label>
                            <select class="form-select" id="wb-style-body-font">
                                <option value="Inter">Inter (Modern)</option>
                                <option value="Roboto">Roboto (Clean)</option>
                                <option value="Open Sans">Open Sans (Friendly)</option>
                                <option value="Lato">Lato (Warm)</option>
                                <option value="Source Sans Pro">Source Sans Pro (Professional)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Button Style</label>
                            <select class="form-select" id="wb-style-button">
                                <option value="rounded">Rounded</option>
                                <option value="pill">Pill</option>
                                <option value="square">Square</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Integrations View -->
            <div id="integrations" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Integrations</h2>
                            <p>Connected apps and services</p>
                        </div>
                        <button class="btn" onclick="openChannelManagerModal()">
                            <span>+</span>
                            <span>Add Integration</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Channel Managers</h3>
                    </div>
                    <div id="channel-connections">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Review Apps</h3>
                        <button class="btn btn-secondary btn-small">Configure</button>
                    </div>
                    <p style="color: var(--text-secondary);">Connect to review platforms like TripAdvisor, Google Reviews, etc.</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Other Integrations</h3>
                        <button class="btn btn-secondary btn-small">Explore</button>
                    </div>
                    <p style="color: var(--text-secondary);">Payment gateways, analytics, marketing tools, and more...</p>
                </div>
            </div>

            <!-- Channel Manager Selection Modal -->
            <div id="channelManagerModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Select Your Channel Manager</h3>
                        <button class="modal-close" onclick="closeChannelManagerModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Which channel manager do you use to manage your property?</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Beds24 - Ready -->
                            <a href="/beds24-wizard.html" class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: inherit; transition: all 0.2s; position: relative;">
                                <span style="position: absolute; top: 0.5rem; right: 0.5rem; background: #10b981; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px;">‚úì Ready</span>
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Beds24</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">PMS + Channel Manager</div>
                            </a>
                            
                            <!-- Hostaway - Ready -->
                            <a href="/hostaway-wizard.html" class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: inherit; transition: all 0.2s; position: relative;">
                                <span style="position: absolute; top: 0.5rem; right: 0.5rem; background: #10b981; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px;">‚úì Ready</span>
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Hostaway</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Vacation Rental Software</div>
                            </a>
                            
                            <!-- Smoobu - Ready -->
                            <a href="/smoobu-wizard.html" class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: inherit; transition: all 0.2s; position: relative;">
                                <span style="position: absolute; top: 0.5rem; right: 0.5rem; background: #10b981; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px;">‚úì Ready</span>
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Smoobu</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Channel Manager</div>
                            </a>
                            
                            <!-- Guesty - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Guesty</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Property Management</div>
                            </div>
                            
                            <!-- Cloudbeds - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Cloudbeds</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Hotel PMS</div>
                            </div>
                            
                            <!-- Lodgify - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Lodgify</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Vacation Rental</div>
                            </div>
                            
                            <!-- OwnerRez - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">OwnerRez</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Vacation Rental</div>
                            </div>
                            
                            <!-- Other -->
                            <div class="channel-option" onclick="alert('Contact us for custom integrations!')" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Other</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Not listed here</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings" class="view">
                <div class="header">
                    <h2>Settings</h2>
                    <p>Configure your system</p>
                </div>

                <div class="card">
                    <h3 class="card-title">System Settings</h3>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">Configure general system preferences, defaults, and behaviors.</p>
                </div>

                <div class="card">
                    <h3 class="card-title">User Management</h3>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">Manage admin users and access permissions.</p>
                </div>

                <div class="card">
                    <h3 class="card-title">API Configuration</h3>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">API keys, webhooks, and developer settings.</p>
                </div>
            </div>

            <!-- Blog App View -->
            <div id="app-blog" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìù Blog</h2>
                            <p>Manage your blog posts and articles</p>
                        </div>
                        <button class="btn" onclick="openBlogModal()">+ New Post</button>
                    </div>
                </div>

                <div class="card">
                    <div id="app-blog-posts-list">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üìù</div>
                            <h3 style="margin-bottom: 0.5rem;">No blog posts yet</h3>
                            <p>Create your first blog post to engage your guests</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openBlogModal()">Create Your First Post</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attractions App View -->
            <div id="app-attractions" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üéØ Attractions</h2>
                            <p>Manage local attractions and things to do</p>
                        </div>
                        <button class="btn" onclick="openAttractionModal()">+ Add Attraction</button>
                    </div>
                </div>

                <div class="card">
                    <div id="app-attractions-list">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üéØ</div>
                            <h3 style="margin-bottom: 0.5rem;">No attractions yet</h3>
                            <p>Add local attractions to help guests explore the area</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openAttractionModal()">Add Your First Attraction</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews App View -->
            <div id="app-reviews" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>‚≠ê Reviews</h2>
                            <p>Manage guest reviews and testimonials</p>
                        </div>
                        <button class="btn" onclick="openReviewModal()">+ Add Review</button>
                    </div>
                </div>

                <div class="card">
                    <div id="app-reviews-list">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">‚≠ê</div>
                            <h3 style="margin-bottom: 0.5rem;">No reviews yet</h3>
                            <p>Add guest reviews to build trust with potential guests</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openReviewModal()">Add Your First Review</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Documentation View -->
            <div id="api-docs" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üîå API Documentation</h2>
                            <p>Integrate GAS with your applications</p>
                        </div>
                        <button class="btn" style="background: #10b981;" onclick="testApiConnection()">Test Connection</button>
                    </div>
                </div>

                <!-- API Keys Management -->
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card-title">üîë API Keys</h3>
                        <button class="btn" onclick="openApiKeyModal()">+ Create API Key</button>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        API keys are required for secure endpoints. Create separate keys for different applications.
                    </p>
                    
                    <div id="api-keys-list">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîê</div>
                            <p>No API keys yet. Create one to access secure endpoints.</p>
                        </div>
                    </div>
                </div>

                <!-- Base URL -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">üåê API Base URL</h3>
                    </div>
                    <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="api-docs-base-url" value="" readonly style="font-family: monospace;">
                            <button class="btn" style="background: #64748b;" onclick="copyToClipboard(document.getElementById('api-docs-base-url').value)">üìã Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Secure API Endpoints -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">üîí Secure API Endpoints (v1)</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Require <code style="background: #fee2e2; padding: 0.125rem 0.375rem; border-radius: 4px;">X-API-Key</code> header. Full access to pricing, availability, offers.
                    </p>
                    
                    <!-- Tabs for endpoint categories -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn" style="background: var(--accent);" onclick="showApiTab('rooms')" id="api-tab-rooms">Rooms</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('availability')" id="api-tab-availability">Availability</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('pricing')" id="api-tab-pricing">Pricing</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('offers')" id="api-tab-offers">Offers</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('content')" id="api-tab-content">Content</button>
                    </div>
                    
                    <!-- Rooms Endpoints -->
                    <div id="api-endpoints-rooms" class="api-endpoints-section">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/rooms</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get all rooms with images, amenities, and base pricing</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/rooms/{roomId}</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get single room with full details</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Availability Endpoints -->
                    <div id="api-endpoints-availability" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/availability?start_date=X&end_date=Y&room_id=Z</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get availability calendar for date range</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/availability/check</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0 0 0.5rem;">Check if room is available + calculate total price</p>
                                <code style="font-size: 0.8rem; color: #64748b;">Body: { room_id, check_in, check_out, guests }</code>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pricing Endpoints -->
                    <div id="api-endpoints-pricing" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/pricing?room_id=X&start_date=Y&end_date=Z</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get base prices and seasonal pricing</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/taxes</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get all taxes and fees</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Offers Endpoints -->
                    <div id="api-endpoints-offers" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/offers</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get active offers and promotions</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/offers/validate</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0 0 0.5rem;">Validate promo code or voucher</p>
                                <code style="font-size: 0.8rem; color: #64748b;">Body: { code, room_id, check_in, check_out, subtotal }</code>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/upsells?room_id=X</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get available upsells/add-ons</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Endpoints -->
                    <div id="api-endpoints-content" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/content</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get all content: pages, contact, branding, blog, attractions</p>
                            </div>
                        </div>
                    </div>
                    
                    <details style="margin-top: 1.5rem;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--accent);">üìñ View Example Code (Secure API)</summary>
                        <pre style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; overflow-x: auto; margin-top: 0.75rem; font-size: 0.85rem;">
// All secure endpoints require X-API-Key header
const API_KEY = 'gas_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
const headers = { 'X-API-Key': API_KEY };

// Get all rooms with full details
const rooms = await fetch('/api/v1/rooms', { headers });
const roomsData = await rooms.json();

// Check availability and get price
const availability = await fetch('/api/v1/availability/check', {
  method: 'POST',
  headers: { ...headers, 'Content-Type': 'application/json' },
  body: JSON.stringify({
    room_id: 123,
    check_in: '2025-02-15',
    check_out: '2025-02-18',
    guests: 2
  })
});
const availData = await availability.json();
// Returns: { available: true, pricing: { nights: 3, total: 450, currency: 'USD' } }

// Validate a promo code
const promo = await fetch('/api/v1/offers/validate', {
  method: 'POST',
  headers: { ...headers, 'Content-Type': 'application/json' },
  body: JSON.stringify({
    code: 'SUMMER20',
    subtotal: 450
  })
});
// Returns: { valid: true, type: 'voucher', calculated_discount: 90 }
                        </pre>
                    </details>
                </div>

                <!-- Public Endpoints -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">üåç Public Endpoints (No Auth)</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        No API key required. Limited data, safe for frontend JavaScript.
                    </p>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace; font-size: 0.9rem;">/api/public/client/{clientId}/site-config</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Complete site config (contact, branding, navigation, pages)</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace; font-size: 0.9rem;">/api/public/client/{clientId}/rooms</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Public room listing</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                                <code style="font-family: monospace; font-size: 0.9rem;">/api/public/check-availability</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Basic availability check</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Key Modal -->
            <div id="apiKeyModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 id="apiKeyModalTitle">Create API Key</h3>
                        <button class="modal-close" onclick="closeApiKeyModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Key Name *</label>
                            <input type="text" class="form-input" id="api-key-name" placeholder="e.g., WordPress Site, Mobile App">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Permissions</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-rooms" checked> Read Rooms
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-availability" checked> Read Availability
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-pricing" checked> Read Pricing
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-offers" checked> Read Offers
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-content" checked> Read Content
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Rate Limit (requests/minute)</label>
                            <input type="number" class="form-input" id="api-key-rate-limit" value="60">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Allowed Origins (optional, comma-separated)</label>
                            <input type="text" class="form-input" id="api-key-origins" placeholder="https://mysite.com, https://app.mysite.com">
                        </div>
                        
                        <input type="hidden" id="api-key-edit-id" value="">
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeApiKeyModal()">Cancel</button>
                        <button class="btn" onclick="saveApiKey()">Create Key</button>
                    </div>
                </div>
            </div>

            <!-- WordPress View -->
            <div id="wordpress" class="view">
                <div class="header">
                    <h2>WordPress Integration</h2>
                    <p>Add booking functionality to your WordPress website</p>
                </div>

                <!-- Website Status Section (for selected account) -->
                <div id="wp-website-section" class="card" style="margin-bottom: 1.5rem; display: none;">
                    <div id="wp-no-website" style="display: none;">
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üåê</div>
                            <h3 style="margin: 0 0 0.5rem 0;">No Website Yet</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Create a WordPress website for this account with our booking system pre-installed.</p>
                            <button class="btn" onclick="openCreateWebsiteModal()" style="font-size: 1rem; padding: 0.75rem 2rem;">
                                üöÄ Create Website
                            </button>
                        </div>
                    </div>
                    
                    <div id="wp-has-website" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">üåê</span>
                                Account Website
                            </h3>
                            <span id="wp-website-status" class="badge badge-success">Active</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Site URL</div>
                                <a id="wp-website-url" href="#" target="_blank" style="color: var(--accent); font-weight: 500; word-break: break-all;"></a>
                            </div>
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">WordPress Admin</div>
                                <a id="wp-website-admin" href="#" target="_blank" style="color: var(--accent); font-weight: 500;">Open Dashboard ‚Üí</a>
                            </div>
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Template</div>
                                <span id="wp-website-template" style="font-weight: 500;">-</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <a id="wp-website-visit-btn" href="#" target="_blank" class="btn" style="text-decoration: none;">
                                üîó Visit Site
                            </a>
                            <a id="wp-website-admin-btn" href="#" target="_blank" class="btn btn-secondary" style="text-decoration: none;">
                                ‚öôÔ∏è WP Admin
                            </a>
                            <button class="btn btn-secondary" onclick="refreshWebsiteStatus()" style="margin-left: auto;">
                                üîÑ Refresh Status
                            </button>
                        </div>
                    </div>
                    
                    <div id="wp-website-creating" style="display: none; text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                        <h3 style="margin: 0 0 0.5rem 0;">Creating Website...</h3>
                        <p style="color: var(--text-secondary);">This usually takes 10-30 seconds</p>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="refreshWebsiteStatus()">Check Status</button>
                        </div>
                    </div>
                </div>

                <!-- WordPress Hosting Settings (Master Admin Only) -->
                <div id="wp-instawp-settings" class="card billing-admin-only" style="margin-bottom: 1.5rem; border: 2px dashed var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            ‚öôÔ∏è WordPress Hosting Configuration
                        </h3>
                        <button class="btn btn-secondary btn-small" onclick="toggleInstaWPSettings()">
                            <span id="instawp-toggle-text">Show Settings</span>
                        </button>
                    </div>
                    
                    <div id="instawp-settings-panel" style="display: none;">
                        <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <p style="margin: 0; font-size: 0.9rem;">‚úÖ <strong>Your WordPress hosting is active!</strong></p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: var(--text-secondary);">API: sites.gas.travel</p>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label>API URL</label>
                            <input type="text" id="instawp-api-url" class="form-input" value="https://sites.gas.travel/gas-api.php">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label>API Key</label>
                            <input type="password" id="instawp-api-key" class="form-input" placeholder="Enter your WordPress API key">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label>Default Template (Optional)</label>
                            <input type="text" id="instawp-default-template" class="form-input" placeholder="e.g., developer-theme">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="instawp-enabled" style="width: 18px; height: 18px;">
                                Enable WordPress Site Creation
                            </label>
                        </div>
                        
                        <button class="btn" onclick="saveInstaWPSettings()">üíæ Save Settings</button>
                    </div>
                </div>

                <!-- Your Settings -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white;">
                    <h3 style="margin: 0 0 1rem 0;">‚öôÔ∏è Your WordPress Plugin Settings</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.25rem;">API URL</div>
                            <code style="font-size: 0.9rem; word-break: break-all;" id="wp-api-url"></code>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.25rem;">Client Account ID</div>
                            <code style="font-size: 1.2rem; font-weight: bold;" id="wp-client-id">-</code>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.25rem;">Property ID</div>
                            <code style="font-size: 1.2rem; font-weight: bold;" id="wp-property-id">-</code>
                        </div>
                    </div>
                </div>

                <!-- Download Section -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); color: white;">
                    <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        üì¶ Plugin Downloads
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
                        <!-- Core Booking Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;">üîå</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Booking</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v4.0 ‚Ä¢ All Plans</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Search, rooms, calendar & checkout</p>
                            <a href="/downloads/gas-booking-wp-plugin.zip" download class="btn" style="background: white; color: #1e40af; width: 100%; text-align: center; text-decoration: none; display: block; font-size: 0.85rem;">
                                ‚¨áÔ∏è Download
                            </a>
                        </div>
                        
                        <!-- Theme -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;">üé®</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">Developer Theme</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v2.0 ‚Ä¢ All Plans</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Starter theme with auto-setup</p>
                            <a href="/downloads/gas-theme-developer.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                ‚¨áÔ∏è Download
                            </a>
                        </div>
                        
                        <!-- Blog Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;">üìù</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Blog</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v1.0 ‚Ä¢ Pro+</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Blog with SEO & schema markup</p>
                            <a href="/downloads/gas-blog.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                ‚¨áÔ∏è Download
                            </a>
                        </div>
                        
                        <!-- Attractions Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;">üìç</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Attractions</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v1.0 ‚Ä¢ Business+</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Nearby places & activities</p>
                            <a href="/downloads/gas-attractions.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                ‚¨áÔ∏è Download
                            </a>
                        </div>
                        
                        <!-- Reviews Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;">‚≠ê</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Reviews</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v1.0 ‚Ä¢ Enterprise</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">TripAdvisor, Booking.com, Google</p>
                            <a href="/downloads/gas-reviews.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                ‚¨áÔ∏è Download
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Setup Guide -->
                <div class="card" style="margin-bottom: 1.5rem; border: 2px solid var(--accent); border-radius: 12px;">
                    <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        üìã Setup Guide
                    </h3>
                    
                    <!-- Step 1 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Install the Plugin</h4>
                            <ol style="margin: 0; padding-left: 1.25rem; color: var(--text-secondary); font-size: 0.9rem; line-height: 1.8;">
                                <li>Download the <strong>GAS Booking Plugin</strong> ZIP file</li>
                                <li>In WordPress, go to <strong>Plugins ‚Üí Add New ‚Üí Upload Plugin</strong></li>
                                <li>Choose the ZIP file and click <strong>Install Now</strong></li>
                                <li>Click <strong>Activate Plugin</strong></li>
                            </ol>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Configure Plugin Settings</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">In WordPress, go to <strong>Settings ‚Üí GAS Booking</strong> and enter:</p>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-size: 0.85rem;">
                                <div style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: center;">
                                    <strong>API URL:</strong>
                                    <div>
                                        <code style="background: #1e293b; color: #e2e8f0; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;" id="wp-api-url-guide"></code>
                                        <button onclick="copyShortcode(document.getElementById('wp-api-url-guide').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-left: 0.5rem;">Copy</button>
                                    </div>
                                    <strong>Client Account ID:</strong>
                                    <div>
                                        <code style="background: #1e293b; color: #e2e8f0; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;" id="wp-client-id-guide">1</code>
                                        <button onclick="copyShortcode(document.getElementById('wp-client-id-guide').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-left: 0.5rem;">Copy</button>
                                    </div>
                                </div>
                                <p style="margin: 0.75rem 0 0 0; color: var(--text-secondary); font-size: 0.8rem;">Leave other settings as default, then click <strong>Save Changes</strong></p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">3</div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Add Search Bar to Homepage</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">Edit your homepage, add a <strong>Shortcode</strong> block, and paste:</p>
                            <div style="background: #1e293b; border-radius: 6px; padding: 0.6rem 1rem; display: inline-flex; align-items: center; gap: 0.75rem;">
                                <code style="color: #e2e8f0; font-size: 0.9rem;">[gas_search]</code>
                                <button onclick="copyShortcode('[gas_search]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">‚Ü≥ Shows check-in/check-out date picker</p>
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">4</div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Create "Book Now" Page</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;"><strong>Pages ‚Üí Add New</strong> ‚Üí Title: "Book Now" ‚Üí Add Shortcode block:</p>
                            <div style="background: #1e293b; border-radius: 6px; padding: 0.6rem 1rem; display: inline-flex; align-items: center; gap: 0.75rem;">
                                <code style="color: #e2e8f0; font-size: 0.9rem;" id="wp-rooms-shortcode">[gas_rooms]</code>
                                <button onclick="copyShortcode('[gas_rooms]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">‚Ü≥ Shows grid of all rooms with availability</p>
                        </div>
                    </div>

                    <!-- Step 5 -->
                    <div style="display: flex; gap: 1rem;">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">5</div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Create "Room" Page</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;"><strong>Pages ‚Üí Add New</strong> ‚Üí Title: "Room" ‚Üí Add Shortcode block:</p>
                            <div style="background: #1e293b; border-radius: 6px; padding: 0.6rem 1rem; display: inline-flex; align-items: center; gap: 0.75rem;">
                                <code style="color: #e2e8f0; font-size: 0.9rem;">[gas_room]</code>
                                <button onclick="copyShortcode('[gas_room]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">‚Ü≥ Shows full room details, calendar & booking form</p>
                        </div>
                    </div>
                </div>

                <!-- Flow Diagram -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                    <h3 class="card-title" style="margin-bottom: 1rem;">üîÑ Booking Flow</h3>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex-wrap: wrap; font-size: 0.9rem;">
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üè†</div>
                            <strong>Homepage</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">[gas_search]</div>
                        </div>
                        <div style="font-size: 1.5rem; color: var(--accent);">‚Üí</div>
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üìã</div>
                            <strong>Book Now</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">[gas_rooms]</div>
                        </div>
                        <div style="font-size: 1.5rem; color: var(--accent);">‚Üí</div>
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üõèÔ∏è</div>
                            <strong>Room Details</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">[gas_room]</div>
                        </div>
                        <div style="font-size: 1.5rem; color: var(--accent);">‚Üí</div>
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">‚úÖ</div>
                            <strong>Booked!</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Confirmation</div>
                        </div>
                    </div>
                </div>

                <!-- Plugin Download & Settings -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="24" height="24" viewBox="0 0 122.5 122.5" fill="#21759b"><path d="M8.7 61.3c0 20.8 12.1 38.8 29.6 47.3L13 40.3c-2.8 6.5-4.3 13.7-4.3 21zm88.6-2.7c0-6.5-2.3-11-4.3-14.5-2.7-4.3-5.2-8-5.2-12.3 0-4.8 3.7-9.3 8.9-9.3h.7c-9.4-8.6-21.9-13.9-35.7-13.9-18.5 0-34.7 9.5-44.2 23.8h3.4c5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.8.3-6 .5l19.1 57 11.5-34.5-8.2-22.5c-2.8-.2-5.5-.5-5.5-.5-2.8-.2-2.5-4.5.3-4.3 0 0 8.7.7 13.9.7 5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.9.3-6 .5l19 56.5 5.2-17.5c2.3-7.3 4-12.5 4-17zm-36.3 7.6l-15.8 45.8c4.7 1.4 9.7 2.2 14.8 2.2 6.1 0 12-1.1 17.4-3-.1-.2-.3-.5-.4-.7l-16-43.3zm45.1-29.8c.5 3.4.7 7 .7 10.9 0 10.8-2 22.9-8 38l-21.8 63.1c21.2-12.4 35.5-35.5 35.5-62.1 0-17.9-6.2-34.3-16.4-47.9zM61.3 0C27.5 0 0 27.5 0 61.3c0 33.8 27.5 61.3 61.3 61.3 33.8 0 61.3-27.5 61.3-61.3C122.5 27.5 95 0 61.3 0zm0 119.7c-32.2 0-58.5-26.2-58.5-58.5 0-32.2 26.2-58.5 58.5-58.5 32.2 0 58.5 26.2 58.5 58.5-.1 32.3-26.3 58.5-58.5 58.5z"/></svg>
                                Your Settings
                            </h3>
                        </div>
                        <a href="/gas-widgets-preview.html" target="_blank" class="btn btn-secondary" style="text-decoration: none;">
                            Preview Widgets ‚Üí
                        </a>
                    </div>
                    
                    <div style="background: var(--accent-light); border-radius: 8px; padding: 1rem;">
                        <div style="display: grid; grid-template-columns: 140px 1fr auto; gap: 0.75rem; align-items: center; font-size: 0.9rem;">
                            <span style="color: var(--text-secondary); font-weight: 500;">API URL:</span>
                            <code style="background: white; padding: 0.4rem 0.75rem; border-radius: 4px; font-size: 0.85rem;" id="wp-api-url"></code>
                            <button onclick="copyShortcode(document.getElementById('wp-api-url').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.3rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Copy</button>
                            
                            <span style="color: var(--text-secondary); font-weight: 500;">Property ID:</span>
                            <code style="background: white; padding: 0.4rem 0.75rem; border-radius: 4px; font-size: 0.85rem;" id="wp-property-id">1</code>
                            <button onclick="copyShortcode(document.getElementById('wp-property-id').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.3rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Shortcodes Reference -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem;">üìù Shortcode Reference</h3>
                    
                    <!-- Search Bar -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="background: #dbeafe; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">üîç</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Search Bar</h4>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Homepage</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_search]</code>
                                <button onclick="copyShortcode('[gas_search]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">style="vertical"</code>
                                <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px; margin-left: 0.25rem;">button_text="Search"</code>
                            </div>
                        </div>
                    </div>

                    <!-- Room Listing -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="background: #dcfce7; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">üè†</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Room Listing</h4>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Book Now page</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_rooms property_id="<span id="shortcode-property-id">1</span>"]</code>
                                <button onclick="copyShortcode('[gas_rooms property_id=&quot;' + (window.currentPropertyId || 1) + '&quot;]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">columns="2"</code>
                            </div>
                        </div>
                    </div>

                    <!-- Room Detail -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="background: #fef3c7; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">üõèÔ∏è</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Room Detail Page</h4>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Room page</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_room]</code>
                                <button onclick="copyShortcode('[gas_room]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">unit_id="190"</code>
                                <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px; margin-left: 0.25rem;">months="3"</code>
                            </div>
                        </div>
                    </div>

                    <!-- Compact Booking -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                        <div style="background: #fce7f3; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">üìÖ</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Compact Booking Widget</h4>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Sidebar / Embed</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_booking unit_id="190"]</code>
                                <button onclick="copyShortcode('[gas_booking unit_id=&quot;190&quot;]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">months="2"</code>
                                <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px; margin-left: 0.25rem;">show_prices="no"</code>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Room IDs Reference -->
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 0.5rem;">Your Room IDs</h3>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">Reference these IDs when using shortcodes for specific rooms:</p>
                    <div id="wp-room-ids" style="background: var(--bg-primary); border-radius: 8px; padding: 1rem;">
                        <p style="color: var(--text-secondary); font-size: 0.85rem;">Loading rooms...</p>
                    </div>
                </div>
            </div>

            <!-- Knowledge Base Articles View -->
            <div id="kb-articles" class="view">
                <div class="header">
                    <h2>üìö Knowledge Base</h2>
                    <p>Manage AI assistant knowledge - articles the chatbot uses to answer questions</p>
                </div>

                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="kb-article-count">0</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Articles</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="kb-category-count">0</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Categories</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="kb-unanswered-count">0</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Unanswered</div>
                    </div>
                </div>

                <!-- Actions Bar -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <button class="btn" onclick="openKBArticleModal()">+ Add Article</button>
                        <button class="btn btn-secondary" onclick="openKBImportModal()">üì• Import Articles</button>
                        <button class="btn btn-secondary" onclick="setupKnowledgeBase()">üîß Setup Tables</button>
                        <div style="flex: 1;"></div>
                        <select id="kb-category-filter" class="form-input" style="width: auto;" onchange="loadKBArticles()">
                            <option value="">All Categories</option>
                        </select>
                        <input type="text" id="kb-search" class="form-input" placeholder="Search articles..." style="width: 200px;" onkeyup="debounce(loadKBArticles, 300)()">
                    </div>
                </div>

                <!-- Articles List -->
                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Views</th>
                                    <th>Helpful</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="kb-articles-table">
                                <tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">Loading articles...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Knowledge Base Unanswered View -->
            <div id="kb-unanswered" class="view">
                <div class="header">
                    <h2>‚ùì Unanswered Questions</h2>
                    <p>Questions the AI couldn't answer - review and add missing knowledge</p>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="kb-unanswered-filter" class="form-input" style="width: auto;" onchange="loadKBUnanswered()">
                            <option value="new">New</option>
                            <option value="resolved">Resolved</option>
                            <option value="">All</option>
                        </select>
                        <div style="flex: 1;"></div>
                        <span id="kb-unanswered-total" style="color: var(--text-secondary); font-size: 0.9rem;">0 questions</span>
                    </div>
                </div>

                <div id="kb-unanswered-list">
                    <div class="card" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        Loading unanswered questions...
                    </div>
                </div>
            </div>

            <!-- Billing Overview View -->
            <div id="billing-overview" class="view">
                <div class="header">
                    <h2>üìä Billing Overview</h2>
                    <p>Revenue and subscription metrics</p>
                </div>

                <!-- MRR Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <div style="font-size: 2.5rem; font-weight: 700;" id="billing-mrr">¬£0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Monthly Recurring Revenue</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent);" id="billing-active-subs">0</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Active Subscriptions</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning);" id="billing-credits-circulation">0</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Credits in Circulation</div>
                    </div>
                </div>

                <!-- Setup Button -->
                <div id="billing-setup-section" class="card" style="margin-bottom: 1.5rem; background: #f0fdf4; border: 1px solid #bbf7d0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; color: #166534;">üîß Setup Billing Tables</h3>
                            <p style="margin: 0; color: #166534; font-size: 0.9rem;">Run this once to create billing tables and default plans/packages</p>
                        </div>
                        <button class="btn" onclick="setupBilling()">Setup Billing</button>
                    </div>
                </div>

                <!-- Subscriptions by Plan -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title">Subscriptions by Plan</h3>
                    <div id="billing-subs-by-plan">
                        <p style="color: var(--text-secondary);">Loading...</p>
                    </div>
                </div>

                <!-- Recent Payments -->
                <div class="card">
                    <h3 class="card-title">Recent Payments</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="billing-recent-payments">
                                <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No payments yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Billing Plans View -->
            <div id="billing-plans" class="view">
                <div class="header">
                    <h2>üí≥ Subscription Plans</h2>
                    <p>Configure pricing tiers for your customers</p>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <button class="btn" onclick="openPlanModal()">+ Add Plan</button>
                </div>

                <div id="billing-plans-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                    <div class="card" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        Loading plans...
                    </div>
                </div>
            </div>

            <!-- Billing Credit Packages View -->
            <div id="billing-credits" class="view">
                <div class="header">
                    <h2>ü™ô Credit Packages</h2>
                    <p>Configure credit bundles customers can purchase</p>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <button class="btn" onclick="openCreditPackageModal()">+ Add Package</button>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Credits</th>
                                    <th>Bonus</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billing-credit-packages-table">
                                <tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Billing Extras View -->
            <div id="billing-extras" class="view">
                <div class="header">
                    <h2>üõí Extras Shop</h2>
                    <p>Services and add-ons customers can buy with credits</p>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <button class="btn" onclick="openExtraModal()">+ Add Extra</button>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Cost</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billing-extras-table">
                                <tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- My Billing (Client View) -->
            <div id="my-billing" class="view">
                <div class="header">
                    <h2>üí≥ Plans & Extras</h2>
                    <p>Subscribe to a plan or purchase extras</p>
                </div>

                <!-- Subscription Plans -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem;">üìã Subscription Plans</h3>
                    <div id="my-billing-plans" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <p style="color: var(--text-secondary);">Loading plans...</p>
                    </div>
                </div>

                <!-- Buy Credits -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem;">ü™ô Credit Packages</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Buy credits to spend on extras and services</p>
                    <div id="my-billing-credits" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                        <p style="color: var(--text-secondary);">Loading credit packages...</p>
                    </div>
                </div>

                <!-- Extras Shop -->
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem;">üõí Extras & Services</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Services you can purchase with credits</p>
                    <div id="my-billing-extras" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <p style="color: var(--text-secondary);">Loading extras...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Knowledge Base Article Modal -->
    <div id="kbArticleModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="kb-article-modal-title" style="margin: 0; font-size: 1.25rem;">üìö Add Knowledge Article</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Add content the AI can use to answer questions</p>
                </div>
                <button class="modal-close" onclick="closeModal('kbArticleModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="kb-article-form" onsubmit="saveKBArticle(event)">
                    <input type="hidden" id="kb-article-id">
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Title <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="kb-article-title" class="form-input" required placeholder="e.g., How to connect Beds24">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="kb-article-category" class="form-input">
                                <option value="">Select category...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Summary</label>
                        <textarea id="kb-article-summary" class="form-input" rows="2" placeholder="Brief summary shown in search results..."></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Content <span style="color: #ef4444;">*</span></label>
                        <textarea id="kb-article-content" class="form-input" rows="12" required placeholder="Full article content. The AI will use this to answer questions. Use markdown formatting."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Keywords (comma-separated)</label>
                            <input type="text" id="kb-article-keywords" class="form-input" placeholder="beds24, api, connect, invite code">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="kb-article-status" class="form-input">
                                <option value="published">Published</option>
                                <option value="draft">Draft</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('kbArticleModal')">Cancel</button>
                        <button type="submit" class="btn">Save Article</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Knowledge Base Import Modal -->
    <div id="kbImportModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">üì• Import Articles</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Bulk import articles from JSON</p>
                </div>
                <button class="modal-close" onclick="closeModal('kbImportModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #166534;">JSON Format</h4>
                    <pre style="margin: 0; font-size: 0.8rem; color: #166534; overflow-x: auto;">[
  {
    "title": "Article Title",
    "category": "getting-started",
    "summary": "Brief summary",
    "content": "Full content here...",
    "keywords": ["keyword1", "keyword2"]
  }
]</pre>
                </div>
                
                <div class="form-group">
                    <label>Paste JSON Array</label>
                    <textarea id="kb-import-json" class="form-input" rows="10" placeholder="Paste your JSON array of articles here..."></textarea>
                </div>
                
                <div id="kb-import-result" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 8px;"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('kbImportModal')">Cancel</button>
                    <button type="button" class="btn" onclick="importKBArticles()">Import Articles</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Billing Plan Modal -->
    <div id="billingPlanModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="plan-modal-title" style="margin: 0; font-size: 1.25rem;">üí≥ Add Subscription Plan</h3>
                </div>
                <button class="modal-close" onclick="closeModal('billingPlanModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="plan-form" onsubmit="savePlan(event)">
                    <input type="hidden" id="plan-id">
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Plan Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="plan-name" class="form-input" required placeholder="e.g., Professional">
                        </div>
                        <div class="form-group">
                            <label>Slug</label>
                            <input type="text" id="plan-slug" class="form-input" placeholder="professional">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <input type="text" id="plan-description" class="form-input" placeholder="For growing businesses">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Monthly Price <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="plan-price-monthly" class="form-input" required step="0.01" placeholder="59.00">
                        </div>
                        <div class="form-group">
                            <label>Yearly Price</label>
                            <input type="number" id="plan-price-yearly" class="form-input" step="0.01" placeholder="590.00">
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <select id="plan-currency" class="form-input">
                                <option value="GBP">¬£ GBP</option>
                                <option value="EUR">‚Ç¨ EUR</option>
                                <option value="USD">$ USD</option>
                                <option value="CHF">CHF</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Max Properties</label>
                            <input type="number" id="plan-max-properties" class="form-input" placeholder="Leave empty for unlimited">
                        </div>
                        <div class="form-group">
                            <label>Sort Order</label>
                            <input type="number" id="plan-sort-order" class="form-input" value="0">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Features (one per line)</label>
                        <textarea id="plan-features" class="form-input" rows="4" placeholder="Up to 5 properties&#10;All features&#10;Priority support"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="plan-is-active" checked>
                            Active (visible to customers)
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('billingPlanModal')">Cancel</button>
                        <button type="submit" class="btn">Save Plan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assign Plan Modal -->
    <div id="assignPlanModal" class="modal">
        <div class="modal-content" style="max-width: 450px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">üí≥ Assign Subscription Plan</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;">For: <span id="assign-plan-account-name"></span></p>
                </div>
                <button class="modal-close" onclick="closeModal('assignPlanModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="assign-plan-current" style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; display: none;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Select Plan</label>
                    <select id="assign-plan-select" class="form-input">
                        <option value="">-- Select Plan --</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Billing Cycle</label>
                    <select id="assign-plan-cycle" class="form-input">
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly (save ~17%)</option>
                    </select>
                </div>
                
                <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.75rem; color: var(--text-primary);">‚ö° Feature Overrides</div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Enable features not included in the plan</p>
                    
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                        <input type="checkbox" id="assign-plan-api-access" style="width: 18px; height: 18px;">
                        <span>üîå API Access</span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" style="color: var(--error);" onclick="cancelAccountSubscription()">Cancel Subscription</button>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('assignPlanModal')">Close</button>
                        <button type="button" class="btn" onclick="saveAssignedPlan()">Assign Plan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Website Modal -->
    <div id="createWebsiteModal" class="modal">
        <div class="modal-content" style="max-width: 500px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">üöÄ Create WordPress Website</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;">For: <span id="create-website-account-name"></span></p>
                </div>
                <button class="modal-close" onclick="closeModal('createWebsiteModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0; font-size: 0.9rem;">‚ú® A new WordPress site will be created with:</p>
                    <ul style="margin: 0.5rem 0 0 1.25rem; font-size: 0.85rem; color: var(--text-secondary);">
                        <li>GAS Booking Plugin pre-installed</li>
                        <li>Theme configured for your property</li>
                        <li>API connection set up automatically</li>
                    </ul>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Site Name</label>
                    <input type="text" id="create-website-name" class="form-input" placeholder="e.g., lehmannhouse">
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        Will be: <strong><span id="create-website-preview">yoursite</span>.instawp.site</strong>
                    </p>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Template (Optional)</label>
                    <select id="create-website-template" class="form-input">
                        <option value="">Use default for plan</option>
                        <option value="gas-starter">GAS Starter</option>
                        <option value="gas-professional">GAS Professional</option>
                        <option value="gas-business">GAS Business</option>
                        <option value="gas-enterprise">GAS Enterprise</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createWebsiteModal')">Cancel</button>
                    <button type="button" class="btn" onclick="createWebsite()" id="create-website-btn">
                        üöÄ Create Website
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Package Modal -->
    <div id="creditPackageModal" class="modal">
        <div class="modal-content" style="max-width: 500px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="credit-package-modal-title" style="margin: 0; font-size: 1.25rem;">ü™ô Add Credit Package</h3>
                </div>
                <button class="modal-close" onclick="closeModal('creditPackageModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="credit-package-form" onsubmit="saveCreditPackage(event)">
                    <input type="hidden" id="credit-package-id">
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Package Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="credit-package-name" class="form-input" required placeholder="e.g., 50 Credits">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Credits <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="credit-package-credits" class="form-input" required placeholder="50">
                        </div>
                        <div class="form-group">
                            <label>Bonus Credits</label>
                            <input type="number" id="credit-package-bonus" class="form-input" value="0" placeholder="0">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Price <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="credit-package-price" class="form-input" required step="0.01" placeholder="40.00">
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <select id="credit-package-currency" class="form-input">
                                <option value="GBP">¬£ GBP</option>
                                <option value="EUR">‚Ç¨ EUR</option>
                                <option value="USD">$ USD</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="credit-package-is-active" checked>
                            Active (available for purchase)
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('creditPackageModal')">Cancel</button>
                        <button type="submit" class="btn">Save Package</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Extras Modal -->
    <div id="extraModal" class="modal">
        <div class="modal-content" style="max-width: 550px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="extra-modal-title" style="margin: 0; font-size: 1.25rem;">üõí Add Extra Service</h3>
                </div>
                <button class="modal-close" onclick="closeModal('extraModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="extra-form" onsubmit="saveExtra(event)">
                    <input type="hidden" id="extra-id">
                    
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="extra-name" class="form-input" required placeholder="e.g., Setup Assistance Call">
                        </div>
                        <div class="form-group">
                            <label>Icon</label>
                            <input type="text" id="extra-icon" class="form-input" placeholder="üìû">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <textarea id="extra-description" class="form-input" rows="2" placeholder="What does the customer get?"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Credit Cost <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="extra-credit-cost" class="form-input" required placeholder="5">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" id="extra-category" class="form-input" placeholder="Support">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="extra-is-active" checked>
                            Active (available in shop)
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('extraModal')">Cancel</button>
                        <button type="submit" class="btn">Save Extra</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Agency Modal -->
    <div id="agencyModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="agency-modal-title" style="margin: 0; font-size: 1.25rem;">üè¢ Add New Agency</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Create an agency partner account</p>
                </div>
                <button class="modal-close" onclick="closeModal('agencyModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="agency-form" onsubmit="saveAgency(event)">
                    <input type="hidden" id="agency-id">
                    <input type="hidden" id="agency-public-id">
                    
                    <!-- API Key Section (only shown when editing) -->
                    <div id="agency-api-key-section" style="display: none; margin-bottom: 1.5rem; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border-radius: 12px; padding: 1rem; color: white;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">üîë Agency API Key</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="agency-api-key-display" readonly style="flex: 1; padding: 0.6rem; border-radius: 6px; border: none; font-size: 0.8rem; background: rgba(255,255,255,0.95); color: #1e293b; font-family: monospace;">
                            <button type="button" onclick="copyAgencyApiKey()" style="padding: 0.6rem 1rem; background: white; color: #4f46e5; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">üìã Copy</button>
                        </div>
                    </div>
                    
                    <!-- Basic Info -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Basic Information</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Agency Name <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="agency-name" class="form-input" required placeholder="e.g., Elevate Schweiz GmbH">
                            </div>
                            <div class="form-group">
                                <label>Email <span style="color: #ef4444;">*</span></label>
                                <input type="email" id="agency-email" class="form-input" required placeholder="contact@agency.com">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="agency-phone" class="form-input" placeholder="+41 58 590 99 91">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Website</label>
                                <input type="url" id="agency-website" class="form-input" placeholder="https://www.agency.com">
                            </div>
                        </div>
                    </div>

                    <!-- Address -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Address</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Address Line 1</label>
                                <input type="text" id="agency-address1" class="form-input" placeholder="Street address">
                            </div>
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="agency-city" class="form-input" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <select id="agency-country" class="form-input">
                                    <option value="GB">üá¨üáß United Kingdom</option>
                                    <option value="US">üá∫üá∏ United States</option>
                                    <option value="CH" selected>üá®üá≠ Switzerland</option>
                                    <option value="DE">üá©üá™ Germany</option>
                                    <option value="FR">üá´üá∑ France</option>
                                    <option value="IT">üáÆüáπ Italy</option>
                                    <option value="ES">üá™üá∏ Spain</option>
                                    <option value="NL">üá≥üá± Netherlands</option>
                                    <option value="AT">üá¶üáπ Austria</option>
                                    <option value="PT">üáµüáπ Portugal</option>
                                    <option value="BE">üáßüá™ Belgium</option>
                                    <option value="IE">üáÆüá™ Ireland</option>
                                    <option value="AU">üá¶üá∫ Australia</option>
                                    <option value="NZ">üá≥üáø New Zealand</option>
                                    <option value="CA">üá®üá¶ Canada</option>
                                    <option value="AE">üá¶üá™ UAE</option>
                                    <option value="JP">üáØüáµ Japan</option>
                                    <option value="TH">üáπüá≠ Thailand</option>
                                    <option value="GR">üá¨üá∑ Greece</option>
                                    <option value="HR">üá≠üá∑ Croatia</option>
                                    <option value="CZ">üá®üáø Czech Republic</option>
                                    <option value="PL">üáµüá± Poland</option>
                                    <option value="HU">üá≠üá∫ Hungary</option>
                                    <option value="SE">üá∏üá™ Sweden</option>
                                    <option value="NO">üá≥üá¥ Norway</option>
                                    <option value="DK">üá©üá∞ Denmark</option>
                                    <option value="FI">üá´üáÆ Finland</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Branding (for future white-label) -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Branding</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Primary Color</label>
                                <input type="color" id="agency-primary-color" class="form-input" value="#6366f1" style="height: 45px;">
                            </div>
                            <div class="form-group">
                                <label>Secondary Color</label>
                                <input type="color" id="agency-secondary-color" class="form-input" value="#8b5cf6" style="height: 45px;">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Logo URL</label>
                                <input type="url" id="agency-logo" class="form-input" placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Settings</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="agency-currency" class="form-input">
                                    <option value="CHF">üá®üá≠ CHF</option>
                                    <option value="EUR">‚Ç¨ EUR</option>
                                    <option value="GBP">¬£ GBP</option>
                                    <option value="USD">$ USD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Plan</label>
                                <select id="agency-plan" class="form-input">
                                    <option value="agency">Agency</option>
                                    <option value="enterprise">Enterprise</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="agency-status" class="form-input">
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group">
                        <label>Internal Notes</label>
                        <textarea id="agency-notes" class="form-input" rows="2" placeholder="Any internal notes about this agency..."></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('agencyModal')">Cancel</button>
                        <button type="submit" class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Save Agency</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Agency Detail Modal -->
    <div id="agencyDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="agency-detail-title" style="margin: 0; font-size: 1.25rem;">Agency Details</h3>
                    <p id="agency-detail-subtitle" style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;"></p>
                </div>
                <button class="modal-close" onclick="closeModal('agencyDetailModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="agency-detail-content">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="client-modal-title" style="margin: 0; font-size: 1.25rem;">üë• Add New Client</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Create a new client account</p>
                </div>
                <button class="modal-close" onclick="closeModal('clientModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="client-form" onsubmit="saveClient(event)">
                    <input type="hidden" id="client-id">
                    <input type="hidden" id="client-public-id">
                    
                    <!-- Setup Link Section (only shown when editing) -->
                    <div id="client-setup-link-section" style="display: none; margin-bottom: 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 1rem; color: white;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">üîó Client Setup Link</h4>
                        <p style="font-size: 0.8rem; margin: 0 0 0.75rem 0; opacity: 0.9;">Send this link to your client so they can connect their channel manager:</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="client-setup-link-display" readonly style="flex: 1; padding: 0.6rem; border-radius: 6px; border: none; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #1e293b;">
                            <button type="button" onclick="copyClientSetupLink()" style="padding: 0.6rem 1rem; background: white; color: #059669; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">üìã Copy</button>
                        </div>
                        <p style="font-size: 0.75rem; margin: 0.5rem 0 0 0; opacity: 0.8;">UUID: <span id="client-uuid-display"></span></p>
                    </div>
                    
                    <!-- Basic Info -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Basic Information</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Company / Client Name <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="client-name" class="form-input" required placeholder="e.g., Lehmann House Ltd">
                            </div>
                            <div class="form-group">
                                <label>Email <span style="color: #ef4444;">*</span></label>
                                <input type="email" id="client-email" class="form-input" required placeholder="info@example.com">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="client-phone" class="form-input" placeholder="+44 1234 567890">
                            </div>
                        </div>
                    </div>

                    <!-- Address -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Address</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Address Line 1</label>
                                <input type="text" id="client-address1" class="form-input" placeholder="Street address">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Address Line 2</label>
                                <input type="text" id="client-address2" class="form-input" placeholder="Apartment, suite, etc.">
                            </div>
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="client-city" class="form-input" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label>Region / County</label>
                                <input type="text" id="client-region" class="form-input" placeholder="Region">
                            </div>
                            <div class="form-group">
                                <label>Postcode</label>
                                <input type="text" id="client-postcode" class="form-input" placeholder="Postcode">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <select id="client-country" class="form-input">
                                    <option value="GB" selected>üá¨üáß United Kingdom</option>
                                    <option value="US">üá∫üá∏ United States</option>
                                    <option value="CH">üá®üá≠ Switzerland</option>
                                    <option value="DE">üá©üá™ Germany</option>
                                    <option value="FR">üá´üá∑ France</option>
                                    <option value="IT">üáÆüáπ Italy</option>
                                    <option value="ES">üá™üá∏ Spain</option>
                                    <option value="NL">üá≥üá± Netherlands</option>
                                    <option value="AT">üá¶üáπ Austria</option>
                                    <option value="PT">üáµüáπ Portugal</option>
                                    <option value="BE">üáßüá™ Belgium</option>
                                    <option value="IE">üáÆüá™ Ireland</option>
                                    <option value="AU">üá¶üá∫ Australia</option>
                                    <option value="NZ">üá≥üáø New Zealand</option>
                                    <option value="CA">üá®üá¶ Canada</option>
                                    <option value="AE">üá¶üá™ UAE</option>
                                    <option value="JP">üáØüáµ Japan</option>
                                    <option value="TH">üáπüá≠ Thailand</option>
                                    <option value="GR">üá¨üá∑ Greece</option>
                                    <option value="HR">üá≠üá∑ Croatia</option>
                                    <option value="CZ">üá®üáø Czech Republic</option>
                                    <option value="PL">üáµüá± Poland</option>
                                    <option value="HU">üá≠üá∫ Hungary</option>
                                    <option value="SE">üá∏üá™ Sweden</option>
                                    <option value="NO">üá≥üá¥ Norway</option>
                                    <option value="DK">üá©üá∞ Denmark</option>
                                    <option value="FI">üá´üáÆ Finland</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Settings</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="client-currency" class="form-input">
                                    <option value="GBP">¬£ GBP</option>
                                    <option value="EUR">‚Ç¨ EUR</option>
                                    <option value="USD">$ USD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Plan</label>
                                <select id="client-plan" class="form-input">
                                    <option value="free">Free</option>
                                    <option value="starter">Starter</option>
                                    <option value="professional">Professional</option>
                                    <option value="agency">Agency</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="client-status" class="form-input">
                                    <option value="active">Active</option>
                                    <option value="trial">Trial</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label>Internal Notes</label>
                        <textarea id="client-notes" class="form-input" rows="2" placeholder="Any internal notes about this client..."></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('clientModal')">Cancel</button>
                        <button type="submit" class="btn">Save Client</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Client Detail Modal -->
    <div id="clientDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="client-detail-title" style="margin: 0; font-size: 1.25rem;">Client Details</h3>
                    <p id="client-detail-subtitle" style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;"></p>
                </div>
                <button class="modal-close" onclick="closeModal('clientDetailModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;" id="client-detail-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;">Loading client details...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Offer Modal -->
    <div id="addOfferModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="offer-modal-title" style="margin: 0; font-size: 1.25rem;">üè∑Ô∏è Create New Offer</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Set up a discount or price adjustment</p>
                </div>
                <button class="modal-close" onclick="closeModal('addOfferModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="offer-form">
                    <input type="hidden" id="offer-id">
                    
                    <!-- Offer Name -->
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Offer Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="offer-name" class="form-input" placeholder="e.g., Early Bird Discount" required
                            style="padding: 0.75rem; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <!-- Description -->
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Description <span style="color: #9ca3af; font-weight: normal;">(shown to guests)</span>
                        </label>
                        <textarea id="offer-description" class="form-input" rows="2" placeholder="Book 30 days in advance and save!"
                            style="padding: 0.75rem; border-radius: 8px; font-size: 0.95rem; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- Discount Section -->
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                            üí∞ Discount Settings
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="offer-discount-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="fixed_amount">Fixed Amount ($)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Value <span style="color: #ef4444;">*</span></label>
                                <div style="position: relative;">
                                    <span id="discount-prefix" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;"></span>
                                    <input type="number" id="offer-discount-value" class="form-input" placeholder="10" required min="0" step="0.01"
                                        style="padding: 0.6rem; padding-left: 1.5rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600;">
                                    <span id="discount-suffix" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Property/Room Selection -->
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #475569; margin-bottom: 0.75rem; display: block;">
                            üè† Apply To
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                                <select id="offer-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="">All Properties</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Room</label>
                                <select id="offer-room" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="">All Rooms</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Conditions -->
                    <details style="margin-bottom: 1.25rem; background: #fefce8; border: 1px solid #fde68a; border-radius: 12px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #854d0e; padding: 1rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="transition: transform 0.2s;">‚ñ∂</span> ‚öôÔ∏è Advanced Conditions
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Nights</label>
                                    <input type="number" id="offer-min-nights" class="form-input" placeholder="1" min="1" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Max Nights</label>
                                    <input type="number" id="offer-max-nights" class="form-input" placeholder="Any" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Days Advance</label>
                                    <input type="number" id="offer-min-advance" class="form-input" placeholder="e.g., 30" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Max Days Advance</label>
                                    <input type="number" id="offer-max-advance" class="form-input" placeholder="e.g., 7" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Valid From</label>
                                    <input type="date" id="offer-valid-from" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Valid Until</label>
                                    <input type="date" id="offer-valid-until" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <!-- Check-in Day Restrictions -->
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px;">
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    üìÖ Allowed Check-in Days
                                </label>
                                <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-sun" value="0" checked style="width: 14px; height: 14px;"> Sun
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-mon" value="1" checked style="width: 14px; height: 14px;"> Mon
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-tue" value="2" checked style="width: 14px; height: 14px;"> Tue
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-wed" value="3" checked style="width: 14px; height: 14px;"> Wed
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-thu" value="4" checked style="width: 14px; height: 14px;"> Thu
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-fri" value="5" checked style="width: 14px; height: 14px;"> Fri
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-sat" value="6" checked style="width: 14px; height: 14px;"> Sat
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Check-out Day Restrictions -->
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px;">
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    üìÖ Allowed Check-out Days
                                </label>
                                <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-sun" value="0" checked style="width: 14px; height: 14px;"> Sun
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-mon" value="1" checked style="width: 14px; height: 14px;"> Mon
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-tue" value="2" checked style="width: 14px; height: 14px;"> Tue
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-wed" value="3" checked style="width: 14px; height: 14px;"> Wed
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-thu" value="4" checked style="width: 14px; height: 14px;"> Thu
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-fri" value="5" checked style="width: 14px; height: 14px;"> Fri
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-sat" value="6" checked style="width: 14px; height: 14px;"> Sat
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Priority (higher = applied first)</label>
                                <input type="number" id="offer-priority" class="form-input" placeholder="0" value="0" style="padding: 0.5rem; border-radius: 6px; width: 100px;">
                            </div>
                        </div>
                    </details>
                    
                    <!-- Active Toggle -->
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <label style="position: relative; display: inline-block; width: 48px; height: 26px;">
                            <input type="checkbox" id="offer-active" checked style="opacity: 0; width: 0; height: 0;">
                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 26px;"
                                onclick="this.previousElementSibling.checked = !this.previousElementSibling.checked; this.style.backgroundColor = this.previousElementSibling.checked ? '#22c55e' : '#ccc';">
                                <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; transform: translateX(0);"
                                    id="toggle-dot"></span>
                            </span>
                        </label>
                        <span style="font-weight: 500; color: #374151;">Active</span>
                        <span style="font-size: 0.85rem; color: #6b7280;">‚Äî Offer is live and can be used</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px; display: flex; justify-content: flex-end; gap: 0.75rem;">
                <button class="btn btn-secondary" onclick="closeModal('addOfferModal')" style="padding: 0.6rem 1.25rem; border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveOffer()" style="padding: 0.6rem 1.5rem; border-radius: 8px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                    üíæ Save Offer
                </button>
            </div>
        </div>
    </div>

    <!-- Add Voucher Modal -->
    <div id="addVoucherModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;">üéüÔ∏è Create New Voucher</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Gift cards, promo codes & discounts</p>
                </div>
                <button class="modal-close" onclick="closeModal('addVoucherModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="voucher-form">
                    <input type="hidden" id="voucher-id">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Voucher Code <span style="color: #ef4444;">*</span>
                            </label>
                            <input type="text" id="voucher-code" class="form-input" placeholder="e.g., WINTER20" required 
                                style="text-transform: uppercase; padding: 0.75rem; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Display Name <span style="color: #ef4444;">*</span>
                            </label>
                            <input type="text" id="voucher-name" class="form-input" placeholder="e.g., Winter Sale 20%" required
                                style="padding: 0.75rem; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">Description</label>
                        <textarea id="voucher-description" class="form-input" placeholder="Get 20% off your winter stay" rows="2"
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                            üè† Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                            <select id="voucher-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadVoucherUnits()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <select id="voucher-unit" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">All Units</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Voucher Type & Value -->
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                            üí∞ Voucher Value
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="voucher-discount-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="percentage">Percentage Off (%)</option>
                                    <option value="fixed">Fixed Amount Off (¬£)</option>
                                    <option value="monetary">Gift Card / Credit (¬£)</option>
                                    <option value="free_nights">Free Night(s)</option>
                                    <option value="addon">Free Add-on</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Value <span style="color: #ef4444;">*</span></label>
                                <input type="number" id="voucher-discount-value" class="form-input" placeholder="e.g., 20" required min="0" step="0.01"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Validity Period -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">Valid From</label>
                            <input type="date" id="voucher-valid-from" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">Valid Until</label>
                            <input type="date" id="voucher-valid-until" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <details style="margin-bottom: 1.25rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #475569; padding: 1rem; list-style: none;">
                            ‚öôÔ∏è Usage Limits & Restrictions
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div class="form-group">
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Max Total Uses</label>
                                    <input type="number" id="voucher-max-uses" class="form-input" placeholder="Unlimited" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Nights Required</label>
                                    <input type="number" id="voucher-min-nights" class="form-input" placeholder="1" min="1" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Booking Total (¬£)</label>
                                <input type="number" id="voucher-min-total" class="form-input" placeholder="No minimum" step="0.01" style="padding: 0.5rem; border-radius: 6px;">
                            </div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #475569; cursor: pointer;">
                                <input type="checkbox" id="voucher-single-use" style="width: 16px; height: 16px;">
                                Single use per guest email
                            </label>
                        </div>
                    </details>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="voucher-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addVoucherModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveVoucher()" style="border-radius: 8px; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                    üíæ Save Voucher
                </button>
            </div>
        </div>
    </div>

    <!-- Add Upsell Modal -->
    <div id="addUpsellModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="upsell-modal-title" style="margin: 0;">üéÅ Add Upsell</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Extra service guests can add to their booking</p>
                </div>
                <button class="modal-close" onclick="closeModal('addUpsellModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="upsell-form">
                    <input type="hidden" id="upsell-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Upsell Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="upsell-name" class="form-input" placeholder="e.g., Champagne on arrival" required
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Description
                        </label>
                        <textarea id="upsell-description" class="form-input" rows="2" placeholder="Bottle of premium champagne waiting in your room"
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                            üè† Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                            <select id="upsell-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadUpsellRooms()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <div id="upsell-rooms-container">
                                <select id="upsell-room" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="">All Units</option>
                                </select>
                            </div>
                            <div id="upsell-rooms-checkboxes" style="display: none; max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.5rem; margin-top: 0.5rem; background: white;">
                                <!-- Unit checkboxes populated by JS -->
                            </div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.85rem; color: #475569; cursor: pointer;">
                                <input type="checkbox" id="upsell-multi-room" onchange="toggleUpsellMultiRoom()">
                                Select multiple units
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Price <span style="color: #ef4444;">*</span>
                            </label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">$</span>
                                <input type="number" id="upsell-price" class="form-input" placeholder="50.00" required min="0" step="0.01"
                                    style="padding: 0.75rem; padding-left: 1.75rem; border-radius: 8px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Charge Type
                            </label>
                            <select id="upsell-charge-type" class="form-input" style="padding: 0.75rem; border-radius: 8px;">
                                <option value="per_booking">Per Booking (one-time)</option>
                                <option value="per_night">Per Night</option>
                                <option value="per_day">Per Day</option>
                                <option value="per_guest">Per Guest</option>
                                <option value="per_guest_per_night">Per Guest/Night</option>
                                <option value="per_hour">Per Hour</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Max Quantity <span style="color: #9ca3af; font-weight: normal;">(optional)</span>
                        </label>
                        <input type="number" id="upsell-max-qty" class="form-input" placeholder="Unlimited" min="1"
                            style="padding: 0.75rem; border-radius: 8px; width: 120px;">
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="upsell-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addUpsellModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveUpsell()" style="border-radius: 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    üíæ Save Upsell
                </button>
            </div>
        </div>
    </div>

    <!-- Add Fee Modal -->
    <div id="addFeeModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="fee-modal-title" style="margin: 0;">üíµ Add Fee</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Mandatory charge applied to bookings</p>
                </div>
                <button class="modal-close" onclick="closeModal('addFeeModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="fee-form">
                    <input type="hidden" id="fee-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Fee Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="fee-name" class="form-input" placeholder="e.g., Cleaning Fee" required
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Description
                        </label>
                        <textarea id="fee-description" class="form-input" rows="2" placeholder="One-time cleaning fee"
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                            üè† Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                            <select id="fee-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadFeeUnits()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <select id="fee-unit" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">All Units</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Amount Type
                            </label>
                            <select id="fee-amount-type" class="form-input" style="padding: 0.75rem; border-radius: 8px;" onchange="toggleFeeAmountInput()">
                                <option value="fixed">Fixed Amount ($)</option>
                                <option value="percentage">Percentage (%)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Amount <span style="color: #ef4444;">*</span>
                            </label>
                            <div style="position: relative;">
                                <span id="fee-amount-prefix" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">$</span>
                                <input type="number" id="fee-amount" class="form-input" placeholder="100.00" required min="0" step="0.01"
                                    style="padding: 0.75rem; padding-left: 1.75rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Apply Per
                        </label>
                        <select id="fee-apply-per" class="form-input" style="padding: 0.75rem; border-radius: 8px;">
                            <option value="per_booking">Per Booking</option>
                            <option value="per_night">Per Night</option>
                            <option value="per_guest">Per Guest</option>
                            <option value="per_guest_per_night">Per Guest/Night</option>
                        </select>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem; display: block;">
                            Tax Settings
                        </label>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="checkbox" id="fee-is-tax" style="width: 18px; height: 18px;">
                            <span style="color: #78350f;">This is a tax (shown separately on invoice)</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="fee-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addFeeModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveFee()" style="border-radius: 8px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    üíæ Save Fee
                </button>
            </div>
        </div>
    </div>

    <!-- Add Tax Modal -->
    <div id="addTaxModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="tax-modal-title" style="margin: 0;">üèõÔ∏è Add Tourist Tax</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Government-mandated tax for your location</p>
                </div>
                <button class="modal-close" onclick="closeModal('addTaxModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="tax-form">
                    <input type="hidden" id="tax-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Tax Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="tax-name" class="form-input" placeholder="e.g., City Tourist Tax, Taxe de S√©jour" required
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Country/Region
                        </label>
                        <select id="tax-country" class="form-input" style="padding: 0.75rem; border-radius: 8px;" onchange="updateTaxPresets()">
                            <option value="">Select country...</option>
                            <option value="FR">üá´üá∑ France</option>
                            <option value="IT">üáÆüáπ Italy</option>
                            <option value="ES">üá™üá∏ Spain</option>
                            <option value="NL">üá≥üá± Netherlands</option>
                            <option value="DE">üá©üá™ Germany</option>
                            <option value="AT">üá¶üáπ Austria</option>
                            <option value="PT">üáµüáπ Portugal</option>
                            <option value="GR">üá¨üá∑ Greece</option>
                            <option value="CH">üá®üá≠ Switzerland</option>
                            <option value="BE">üáßüá™ Belgium</option>
                            <option value="CZ">üá®üáø Czech Republic</option>
                            <option value="HU">üá≠üá∫ Hungary</option>
                            <option value="US">üá∫üá∏ United States</option>
                            <option value="AE">üá¶üá™ UAE (Dubai)</option>
                            <option value="JP">üáØüáµ Japan</option>
                            <option value="TH">üáπüá≠ Thailand</option>
                            <option value="ID">üáÆüá© Indonesia (Bali)</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                            üè† Apply To
                        </label>
                        <div class="form-group master-only-field" style="margin-bottom: 0.75rem; display: none;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Client Account</label>
                            <select id="tax-account" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadTaxProperties()">
                                <option value="">Select client account...</option>
                            </select>
                            <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Tax will be visible to and applied for this client's bookings</p>
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                            <select id="tax-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadTaxUnits()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <select id="tax-unit" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">All Units</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                            üí∞ Tax Amount
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="tax-amount-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="toggleTaxAmountInput()">
                                    <option value="fixed">Fixed Amount</option>
                                    <option value="percentage">Percentage of Booking</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Amount <span style="color: #ef4444;">*</span></label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select id="tax-currency" class="form-input" style="padding: 0.6rem; border-radius: 8px; width: 80px;">
                                        <option value="EUR">‚Ç¨</option>
                                        <option value="USD">$</option>
                                        <option value="GBP">¬£</option>
                                        <option value="CHF">CHF</option>
                                        <option value="AED">AED</option>
                                        <option value="JPY">¬•</option>
                                    </select>
                                    <input type="number" id="tax-amount" class="form-input" placeholder="4.00" required min="0" step="0.01"
                                        style="padding: 0.6rem; border-radius: 8px; flex: 1;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                            üìã How is it charged?
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Charge Per</label>
                                <select id="tax-charge-per" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="per_person_per_night">Per Person Per Night (PPPN)</option>
                                    <option value="per_room_per_night">Per Room Per Night (PRPN)</option>
                                    <option value="per_booking">Per Booking (one-time)</option>
                                    <option value="percentage">% of Room Rate</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Max Nights <span style="color: #9ca3af;">(if capped)</span></label>
                                <input type="number" id="tax-max-nights" class="form-input" placeholder="e.g., 7" min="1"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <details style="margin-bottom: 1.25rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #475569; padding: 1rem; list-style: none;">
                            ‚öôÔ∏è Advanced Options
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Age (exempt below)</label>
                                    <input type="number" id="tax-min-age" class="form-input" placeholder="e.g., 12" min="0" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Star Rating Tier</label>
                                    <select id="tax-star-tier" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                        <option value="">All ratings</option>
                                        <option value="1-2">1-2 Star</option>
                                        <option value="3">3 Star</option>
                                        <option value="4">4 Star</option>
                                        <option value="5">5 Star / Luxury</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Season Start</label>
                                    <input type="date" id="tax-season-start" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Season End</label>
                                    <input type="date" id="tax-season-end" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="tax-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addTaxModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveTax()" style="border-radius: 8px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                    üíæ Save Tax
                </button>
            </div>
        </div>
    </div>

    <div id="imageUploadModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Upload Images</h3>
                <button class="modal-close" onclick="closeModal('imageUploadModal')">&times;</button>
            </div>
            <div class="modal-body" style="position: relative;">
                <!-- Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì§</div>
                    <h3>Drag & drop images here</h3>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0;">or click to browse</p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary);">
                        ‚ö†Ô∏è Minimum ratio 1.2:1 (e.g., 1200√ó1000) ‚Ä¢ Max 10MB per image
                    </p>
                    <input type="file" id="imageFileInput" multiple accept="image/*" style="display: none;">
                </div>

                <!-- Preview Area -->
                <div id="uploadPreview" class="upload-preview" style="display: none;"></div>

                <!-- Assignment Section -->
                <div class="assignment-section" id="assignmentSection">
                    <h4>üìç Assign images to:</h4>
                    
                    <!-- Property Assignment -->
                    <div style="margin-bottom: 1rem;">
                        <label class="checkbox-label" style="cursor: pointer;">
                            <input type="checkbox" id="assign-property" value="property" style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                            <span style="flex: 1;">üè® Property Images (general photos)</span>
                        </label>
                    </div>

                    <!-- Location Assignment -->
                    <div style="margin-bottom: 1rem;">
                        <label class="checkbox-label" style="cursor: pointer;">
                            <input type="checkbox" id="assign-location" value="location" style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                            <span style="flex: 1;">üìç Location Images (area/neighborhood)</span>
                        </label>
                    </div>

                    <!-- Room Assignment -->
                    <div>
                        <div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">
                            üõèÔ∏è Rooms (select one or more):
                        </div>
                        <div class="checkbox-group" id="roomCheckboxes">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>

                <!-- Upload Button -->
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('imageUploadModal')" style="flex: 1;">
                        Cancel
                    </button>
                    <button class="btn" id="uploadButton" onclick="uploadImages()" style="flex: 2;" disabled>
                        Upload Images
                    </button>
                </div>

                <!-- Progress (shown during upload) -->
                <div id="uploadProgress" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 10; border-radius: 12px; display: none; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì§</div>
                    <h3 style="margin-bottom: 1rem;">Uploading Images...</h3>
                    <div style="width: 80%; max-width: 300px; background: var(--bg-secondary); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 0.5rem;">
                        <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem;" id="progressText">0%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Property Modal -->
    <div id="editPropertyModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Property</h3>
                <button class="modal-close" onclick="closeModal('editPropertyModal')">√ó</button>
            </div>
            <form id="editPropertyForm" onsubmit="return saveProperty(event)">
                <input type="hidden" id="edit-property-id">
                
                <!-- Basic Info Section -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">Basic Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Property Name *</label>
                            <input type="text" class="form-input" id="edit-property-name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Property Type</label>
                            <select class="form-input" id="edit-property-type">
                                <option value="hotel">Hotel</option>
                                <option value="apartment">Apartment</option>
                                <option value="house">House</option>
                                <option value="bedAndBreakfast">Bed & Breakfast</option>
                                <option value="hostel">Hostel</option>
                                <option value="villa">Villa</option>
                                <option value="cottage">Cottage</option>
                                <option value="guesthouse">Guesthouse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-input" id="edit-property-status">
                                <option value="active">Active</option>
                                <option value="draft">Draft</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Address Section -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">üìç Address & Location</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Street Address</label>
                            <input type="text" class="form-input" id="edit-property-address" placeholder="123 High Street">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City / Town</label>
                            <input type="text" class="form-input" id="edit-property-city" placeholder="London">
                        </div>
                        <div class="form-group">
                            <label class="form-label">District / Area</label>
                            <input type="text" class="form-input" id="edit-property-district" placeholder="Westminster">
                        </div>
                        <div class="form-group">
                            <label class="form-label">State / County / Region</label>
                            <input type="text" class="form-input" id="edit-property-state" placeholder="Greater London">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Postcode / ZIP</label>
                            <input type="text" class="form-input" id="edit-property-zipcode" placeholder="SW1A 1AA">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Country</label>
                            <select class="form-input" id="edit-property-country">
                                <option value="">Select country...</option>
                                <option value="GB">üá¨üáß United Kingdom</option>
                                <option value="US">üá∫üá∏ United States</option>
                                <option value="CH">üá®üá≠ Switzerland</option>
                                <option value="DE">üá©üá™ Germany</option>
                                <option value="FR">üá´üá∑ France</option>
                                <option value="IT">üáÆüáπ Italy</option>
                                <option value="ES">üá™üá∏ Spain</option>
                                <option value="NL">üá≥üá± Netherlands</option>
                                <option value="AT">üá¶üáπ Austria</option>
                                <option value="PT">üáµüáπ Portugal</option>
                                <option value="BE">üáßüá™ Belgium</option>
                                <option value="IE">üáÆüá™ Ireland</option>
                                <option value="AU">üá¶üá∫ Australia</option>
                                <option value="NZ">üá≥üáø New Zealand</option>
                                <option value="CA">üá®üá¶ Canada</option>
                                <option value="AE">üá¶üá™ UAE</option>
                                <option value="JP">üáØüáµ Japan</option>
                                <option value="TH">üáπüá≠ Thailand</option>
                                <option value="GR">üá¨üá∑ Greece</option>
                                <option value="HR">üá≠üá∑ Croatia</option>
                                <option value="CZ">üá®üáø Czech Republic</option>
                                <option value="PL">üáµüá± Poland</option>
                                <option value="HU">üá≠üá∫ Hungary</option>
                                <option value="SE">üá∏üá™ Sweden</option>
                                <option value="NO">üá≥üá¥ Norway</option>
                                <option value="DK">üá©üá∞ Denmark</option>
                                <option value="FI">üá´üáÆ Finland</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Coordinates Section -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">üó∫Ô∏è Map Coordinates</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Latitude</label>
                            <input type="text" class="form-input" id="edit-property-latitude" placeholder="51.5074">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Longitude</label>
                            <input type="text" class="form-input" id="edit-property-longitude" placeholder="-0.1278">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="geocodePropertyAddress()" style="height: 42px;">
                            üìç Lookup
                        </button>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Coordinates are used for map display on your booking site.
                    </p>
                    
                    <!-- Mini Map Preview -->
                    <div id="property-map-preview" style="margin-top: 1rem; height: 200px; background: #e5e7eb; border-radius: 8px; display: none; position: relative; overflow: hidden;">
                        <div id="property-map-container" style="width: 100%; height: 100%;"></div>
                        <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">
                            Click map to set coordinates
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="togglePropertyMap()" style="margin-top: 0.5rem; font-size: 0.85rem;" id="toggle-map-btn">
                        üó∫Ô∏è Show Map
                    </button>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn" style="background: var(--error); border-color: var(--error);" onclick="deleteProperty()">
                        üóëÔ∏è Delete Property
                    </button>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editPropertyModal')">Cancel</button>
                        <button type="submit" class="btn">üíæ Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Settings Modal -->
    <div id="paymentSettingsModal" class="modal">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">üí≥ Payment Settings</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;" id="payment-settings-property-name"></p>
                </div>
                <button class="modal-close" onclick="closeModal('paymentSettingsModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <input type="hidden" id="payment-settings-property-id">
                
                <!-- Enable/Disable -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 1rem;">
                        <input type="checkbox" id="payment-enabled" style="width: 20px; height: 20px;" checked>
                        <strong>Enable Online Payments</strong>
                    </label>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin: 0.25rem 0 0 1.75rem;">
                        Allow guests to pay deposits and balances online
                    </p>
                </div>
                
                <!-- Deposit Settings -->
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem;">üí∞ Deposit Settings</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Deposit Type</label>
                            <select id="payment-deposit-type" class="form-input">
                                <option value="percentage">Percentage of total</option>
                                <option value="fixed">Fixed amount</option>
                                <option value="full">Full payment required</option>
                                <option value="none">No deposit</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Deposit Amount</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="number" id="payment-deposit-amount" class="form-input" value="25" min="0" step="0.01">
                                <span id="payment-deposit-symbol" style="font-weight: 500;">%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1rem; margin-bottom: 0;">
                        <label>Balance Due (days before arrival)</label>
                        <input type="number" id="payment-balance-days" class="form-input" value="14" min="0" style="max-width: 150px;">
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            0 = balance due on arrival
                        </p>
                    </div>
                </div>
                
                <!-- Currency -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Currency</label>
                    <select id="payment-currency" class="form-input" style="max-width: 200px;">
                        <option value="GBP">üá¨üáß GBP (¬£)</option>
                        <option value="USD">üá∫üá∏ USD ($)</option>
                        <option value="EUR">üá™üá∫ EUR (‚Ç¨)</option>
                        <option value="CHF">üá®üá≠ CHF</option>
                    </select>
                </div>
                
                <!-- Payment Methods -->
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem;">üí≥ Payment Methods</h4>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="payment-method-card" checked style="width: 18px; height: 18px;">
                            <span>Credit/Debit Card (via Stripe)</span>
                        </label>
                        <div id="stripe-connect-section" style="margin-left: 1.5rem; padding: 0.75rem; background: white; border-radius: 8px;">
                            <div id="stripe-not-connected" style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="color: var(--error);">‚ö†Ô∏è Stripe not connected</span>
                                <button type="button" class="btn btn-small" onclick="connectStripe()" style="font-size: 0.8rem;">
                                    Connect Stripe
                                </button>
                            </div>
                            <div id="stripe-connected" style="display: none; color: var(--success);">
                                ‚úì Stripe connected
                            </div>
                        </div>
                        
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; opacity: 0.5;">
                            <input type="checkbox" id="payment-method-paypal" disabled style="width: 18px; height: 18px;">
                            <span>PayPal (coming soon)</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; opacity: 0.5;">
                            <input type="checkbox" id="payment-method-bank" disabled style="width: 18px; height: 18px;">
                            <span>Bank Transfer (coming soon)</span>
                        </label>
                    </div>
                </div>
                
                <!-- Cancellation Policy -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Cancellation Policy (Optional)</label>
                    <textarea id="payment-cancellation" class="form-input" rows="3" placeholder="e.g., Free cancellation up to 48 hours before check-in. 50% refund for cancellations made 24-48 hours before. No refund for cancellations less than 24 hours before check-in."></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentSettingsModal')">Cancel</button>
                    <button type="button" class="btn" onclick="savePaymentSettings()">üíæ Save Payment Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Room Modal -->
    <div id="editRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Room</h3>
                <button class="modal-close" onclick="closeModal('editRoomModal')">√ó</button>
            </div>
            <form id="editRoomForm" onsubmit="return saveRoom(event)">
                <input type="hidden" id="edit-room-id">
                
                <!-- CM Data (reference) -->
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">üì° From Channel Manager</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Room Name</label>
                            <input type="text" class="form-input" id="edit-room-name" readonly style="background: var(--bg-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Room Type</label>
                            <input type="text" class="form-input" id="edit-room-type" readonly style="background: var(--bg-primary);">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Max Guests</label>
                            <input type="text" class="form-input" id="edit-room-maxguests" readonly style="background: var(--bg-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Max Adults</label>
                            <input type="text" class="form-input" id="edit-room-maxadults" readonly style="background: var(--bg-primary);">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Max Children</label>
                            <input type="text" class="form-input" id="edit-room-maxchildren" readonly style="background: var(--bg-primary);">
                        </div>
                    </div>
                </div>
                
                <!-- GAS Controls -->
                <div style="font-size: 0.75rem; color: var(--accent); margin-bottom: 0.5rem;">üéõÔ∏è GAS Controls</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Quantity of Room Type</label>
                        <input type="number" class="form-input" id="edit-room-quantity" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="edit-room-status">
                            <option value="available">‚úÖ Available</option>
                            <option value="unavailable">‚ùå Unavailable</option>
                            <option value="maintenance">üîß Maintenance</option>
                        </select>
                    </div>
                </div>
                
                <!-- Amenities from CM -->
                <div class="form-group">
                    <label class="form-label">Select Amenities for this Room</label>
                    <div id="edit-room-amenities" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                        Loading amenities...
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem;">
                    <button type="button" class="btn" style="background: var(--error); border-color: var(--error);" onclick="deleteRoom()">
                        Delete Room
                    </button>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editRoomModal')">Cancel</button>
                        <button type="submit" class="btn">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Amenity Modal -->
    <div id="addAmenityModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Manage Amenities</h3>
                <button class="modal-close" onclick="closeModal('addAmenityModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Category Selection -->
                <div class="form-group">
                    <label class="form-label">Select Category</label>
                    <select class="form-input" id="amenity-category-select" onchange="loadCategoryAmenities()">
                        <option value="">Choose a category...</option>
                    </select>
                </div>
                
                <!-- Current Amenities in Category -->
                <div id="category-amenities-list" style="display: none; margin: 1.5rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <h4 style="margin-bottom: 1rem;">Current Amenities</h4>
                    <div id="amenities-in-category" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <!-- Amenities will be loaded here -->
                    </div>
                </div>
                
                <!-- Add New Amenity Section -->
                <div id="add-amenity-section" style="display: none; border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Add New Amenity to this Category</h4>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Amenity Name</label>
                            <input type="text" class="form-input" id="new-amenity-name" placeholder="e.g., Smart TV" oninput="autoSuggestIcon()">
                        </div>
                        <div class="form-group" style="width: 80px; margin-bottom: 0;">
                            <label class="form-label">Icon</label>
                            <input type="text" class="form-input" id="new-amenity-icon" placeholder="üì∫" maxlength="4" style="font-size: 1.5rem; text-align: center;">
                        </div>
                        <button class="btn" onclick="addAmenityToCategory()" style="height: 42px;">Add</button>
                    </div>
                </div>
                
                <!-- Create New Category Section -->
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Or Create New Category</h4>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Category Name</label>
                            <input type="text" class="form-input" id="new-category-name" placeholder="e.g., Pet Friendly">
                        </div>
                        <button class="btn btn-secondary" onclick="createNewCategory()" style="height: 42px;">Create Category</button>
                    </div>
                </div>
                
                <!-- Danger Zone -->
                <div style="border-top: 1px solid var(--error); padding-top: 1.5rem; margin-top: 2rem; background: rgba(239, 68, 68, 0.05); padding: 1rem; border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem; color: var(--error);">‚ö†Ô∏è Danger Zone</h4>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">These actions cannot be undone.</p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="deleteAllInCategory()" style="background: var(--error); border-color: var(--error);">
                            üóëÔ∏è Delete All in Selected Category
                        </button>
                        <button class="btn" onclick="deleteAllAmenities()" style="background: #7f1d1d; border-color: #7f1d1d;">
                            ‚ö†Ô∏è Delete ALL Amenities
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; text-align: right;">
                    <button class="btn btn-secondary" onclick="closeModal('addAmenityModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div id="bulkEditModal" class="modal">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">‚ö° Bulk Edit</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Update prices, min stays, and restrictions across multiple rooms and dates</p>
                </div>
                <button class="modal-close" onclick="closeModal('bulkEditModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                
                <!-- What to Edit -->
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #475569; margin-bottom: 0.75rem; display: block;">
                        üéØ What do you want to edit?
                    </label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb; flex: 1; min-width: 150px;">
                            <input type="radio" name="bulk-edit-type" value="price" checked onchange="toggleBulkEditType()"> 
                            <span>üí∞ Prices</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb; flex: 1; min-width: 150px;">
                            <input type="radio" name="bulk-edit-type" value="minstay" onchange="toggleBulkEditType()"> 
                            <span>üìè Min Stay</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb; flex: 1; min-width: 150px;">
                            <input type="radio" name="bulk-edit-type" value="closed" onchange="toggleBulkEditType()"> 
                            <span>üö´ Closed Days</span>
                        </label>
                    </div>
                </div>
                
                <!-- Value Input (changes based on type) -->
                <div id="bulk-value-section" style="margin-bottom: 1.25rem;">
                    <!-- Price input -->
                    <div id="bulk-price-input" class="form-group">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            üí∞ Price Action
                        </label>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <select id="bulk-price-action" class="form-input" style="width: auto; padding: 0.6rem;">
                                <option value="set">Set price to</option>
                                <option value="increase">Increase by</option>
                                <option value="decrease">Decrease by</option>
                                <option value="increase_pct">Increase by %</option>
                                <option value="decrease_pct">Decrease by %</option>
                            </select>
                            <input type="number" id="bulk-price-value" class="form-input" min="0" value="100"
                                style="width: 100px; padding: 0.6rem; font-size: 1.1rem; font-weight: 600;">
                            <span id="bulk-price-symbol" style="color: #6b7280;">$</span>
                        </div>
                    </div>
                    
                    <!-- Min Stay input (hidden by default) -->
                    <div id="bulk-minstay-input" class="form-group" style="display: none;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            üìè Min Stay Nights
                        </label>
                        <input type="number" id="bulk-minstay-value" class="form-input" min="1" max="30" value="2"
                            style="width: 100px; padding: 0.6rem; font-size: 1.1rem; font-weight: 600;">
                    </div>
                    
                    <!-- Closed days input (hidden by default) -->
                    <div id="bulk-closed-input" class="form-group" style="display: none;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            üö´ Close for
                        </label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: #fee2e2; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="bulk-close-checkin" checked> <span>Check-in</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: #fee2e2; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="bulk-close-checkout" checked> <span>Check-out</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Date Range -->
                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                        üìÖ Date Range
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">From</label>
                            <input type="date" id="bulk-date-from" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">To</label>
                            <input type="date" id="bulk-date-to" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                    </div>
                </div>
                
                <!-- Days of Week -->
                <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #1e40af; margin-bottom: 0.75rem; display: block;">
                        üìÜ Apply to Days
                    </label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="1" checked> <span>Mon</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="2" checked> <span>Tue</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="3" checked> <span>Wed</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="4" checked> <span>Thu</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="5" checked> <span>Fri</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: #fef3c7; border-radius: 6px; cursor: pointer; border: 1px solid #fde68a;">
                            <input type="checkbox" class="bulk-day-cb" data-day="6" checked> <span>Sat</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: #fef3c7; border-radius: 6px; cursor: pointer; border: 1px solid #fde68a;">
                            <input type="checkbox" class="bulk-day-cb" data-day="0" checked> <span>Sun</span>
                        </label>
                    </div>
                </div>
                
                <!-- Offers Selection (shown for min stay and closed) -->
                <div id="bulk-offers-section" style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem; display: none;">
                    <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                        üè∑Ô∏è Apply to Offers
                    </label>
                    <div style="margin-bottom: 0.5rem;">
                        <a href="#" onclick="document.querySelectorAll('.bulk-offer-cb').forEach(c=>c.checked=true); return false;" style="font-size: 0.85rem; color: #2563eb;">select all</a>
                        <span style="color: #9ca3af; margin: 0 0.5rem;">|</span>
                        <a href="#" onclick="document.querySelectorAll('.bulk-offer-cb').forEach(c=>c.checked=false); return false;" style="font-size: 0.85rem; color: #2563eb;">deselect all</a>
                    </div>
                    <div id="bulk-offers-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                        <p style="padding: 0.75rem; color: #6b7280;">Loading offers...</p>
                    </div>
                </div>
                
                <!-- Room Selection -->
                <div style="background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #7c3aed; margin-bottom: 0.75rem; display: block;">
                        üè† Apply to Rooms
                    </label>
                    <div style="margin-bottom: 0.5rem;">
                        <a href="#" onclick="document.querySelectorAll('.bulk-room-cb').forEach(c=>c.checked=true); return false;" style="font-size: 0.85rem; color: #2563eb;">select all</a>
                        <span style="color: #9ca3af; margin: 0 0.5rem;">|</span>
                        <a href="#" onclick="document.querySelectorAll('.bulk-room-cb').forEach(c=>c.checked=false); return false;" style="font-size: 0.85rem; color: #2563eb;">deselect all</a>
                    </div>
                    <div id="bulk-rooms-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                        <p style="padding: 0.75rem; color: #6b7280;">Loading rooms...</p>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <button class="btn btn-secondary" onclick="closeModal('bulkEditModal')">Cancel</button>
                    <button class="btn" id="bulk-apply-btn" onclick="applyBulkEdit()" style="background: #16a34a; border-color: #16a34a;">
                        ‚úì Apply Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // AUTHENTICATION
        // =====================================================
        let currentAccount = null;
        
        // Country name to ISO code mapping for backward compatibility
        const countryNameToCode = {
            'united kingdom': 'GB', 'uk': 'GB', 'great britain': 'GB', 'england': 'GB',
            'united states': 'US', 'usa': 'US', 'america': 'US',
            'switzerland': 'CH', 'suisse': 'CH', 'schweiz': 'CH',
            'germany': 'DE', 'deutschland': 'DE',
            'france': 'FR',
            'italy': 'IT', 'italia': 'IT',
            'spain': 'ES', 'espa√±a': 'ES',
            'netherlands': 'NL', 'holland': 'NL',
            'austria': 'AT', '√∂sterreich': 'AT',
            'portugal': 'PT',
            'belgium': 'BE', 'belgique': 'BE',
            'ireland': 'IE',
            'australia': 'AU',
            'new zealand': 'NZ',
            'canada': 'CA',
            'uae': 'AE', 'united arab emirates': 'AE', 'dubai': 'AE',
            'japan': 'JP',
            'thailand': 'TH',
            'greece': 'GR',
            'croatia': 'HR',
            'czech republic': 'CZ', 'czechia': 'CZ',
            'poland': 'PL',
            'hungary': 'HU',
            'sweden': 'SE',
            'norway': 'NO',
            'denmark': 'DK',
            'finland': 'FI'
        };
        
        function normalizeCountryCode(country) {
            if (!country) return 'GB';
            // If already a 2-letter code, return uppercase
            if (country.length === 2) return country.toUpperCase();
            // Try to find in mapping
            const code = countryNameToCode[country.toLowerCase()];
            return code || country; // Return original if not found
        }
        
        // Check authentication on page load
        async function checkAuth() {
            const token = localStorage.getItem('gas_token');
            
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            
            try {
                const response = await fetch('/api/accounts/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                
                if (data.success) {
                    currentAccount = data.account;
                    updateUserProfile();
                    applyRoleBasedAccess();
                    // Update billing nav visibility after auth
                    if (typeof updateBillingNavVisibility === 'function') {
                        updateBillingNavVisibility();
                    }
                    // Load feature entitlements
                    if (typeof loadAccountEntitlements === 'function') {
                        loadAccountEntitlements();
                    }
                    // Reload dashboard with correct filters
                    if (typeof loadDashboard === 'function') {
                        loadDashboard();
                    }
                    return true;
                } else {
                    // Token invalid, clear and redirect
                    localStorage.removeItem('gas_token');
                    localStorage.removeItem('gas_account');
                    window.location.href = '/login.html';
                    return false;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // On network error, try using cached account
                const cachedAccount = localStorage.getItem('gas_account');
                if (cachedAccount) {
                    currentAccount = JSON.parse(cachedAccount);
                    updateUserProfile();
                    applyRoleBasedAccess();
                    // Update billing nav visibility after auth
                    if (typeof updateBillingNavVisibility === 'function') {
                        updateBillingNavVisibility();
                    }
                    // Load feature entitlements
                    if (typeof loadAccountEntitlements === 'function') {
                        loadAccountEntitlements();
                    }
                    if (typeof loadDashboard === 'function') {
                        loadDashboard();
                    }
                    return true;
                }
                window.location.href = '/login.html';
                return false;
            }
        }
        
        // Apply role-based access control
        function applyRoleBasedAccess() {
            if (!currentAccount) return;
            
            // Master admin sees everything
            if (currentAccount.role === 'master_admin') {
                return;
            }
            
            // Non-master admins: auto-filter to their own account
            selectedAccountId = currentAccount.id;
            selectedAccountName = currentAccount.name;
            
            // Show the filter banner (but hide clear button)
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            if (banner && nameEl) {
                banner.style.display = 'flex';
                nameEl.textContent = currentAccount.name;
                
                // Hide the clear button for non-master-admins
                const clearBtn = banner.querySelector('button');
                if (clearBtn) {
                    clearBtn.style.display = 'none';
                }
            }
            
            // Hide "All Accounts" nav item for non-master-admins
            const accountsNavItem = document.querySelector('[data-view="accounts"]');
            if (accountsNavItem) {
                accountsNavItem.style.display = 'none';
            }
            
            // Hide Agencies and Clients nav items
            const agenciesNavItem = document.querySelector('[data-view="agencies"]');
            const clientsNavItem = document.querySelector('[data-view="clients"]');
            if (agenciesNavItem) agenciesNavItem.style.display = 'none';
            if (clientsNavItem) clientsNavItem.style.display = 'none';
            
            console.log('Role-based access applied for:', currentAccount.role, '- filtering to account:', selectedAccountId);
        }
        
        function updateUserProfile() {
            if (!currentAccount) return;
            
            const avatarEl = document.getElementById('userAvatar');
            const nameEl = document.getElementById('userName');
            const roleEl = document.getElementById('userRole');
            
            if (avatarEl) {
                avatarEl.textContent = currentAccount.name.charAt(0).toUpperCase();
            }
            if (nameEl) {
                nameEl.textContent = currentAccount.name;
            }
            if (roleEl) {
                const roleLabels = {
                    'master_admin': 'Master Admin',
                    'agency_admin': 'Agency Admin',
                    'submaster_admin': 'Sub Admin',
                    'admin': 'Admin'
                };
                roleEl.textContent = roleLabels[currentAccount.role] || currentAccount.role;
            }
        }
        
        async function handleLogout() {
            const token = localStorage.getItem('gas_token');
            
            try {
                await fetch('/api/accounts/logout', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('gas_token');
            localStorage.removeItem('gas_account');
            window.location.href = '/home.html';
        }
        
        // Helper to add auth header to fetch requests
        function authHeaders() {
            const token = localStorage.getItem('gas_token');
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        }
        
        // =====================================================
        // GLOBAL STATE
        // =====================================================
        // Global client tracking - uses public_id (UUID) for security
        let currentClientPublicId = null; // UUID or null for all clients
        let clientIdMap = {}; // Maps public_id -> internal id
        
        // Agency filter - when set, all views filter by this agency
        let selectedAgencyId = null;
        let selectedAgencyName = null;
        
        // Account filter (new unified system) - when set, all views filter by this account
        let selectedAccountId = null;
        let selectedAccountName = null;
        
        // Run auth check after global state is declared
        checkAuth();
        
        // Helper function to get account query param
        function getAccountParam() {
            if (selectedAccountId) {
                return `account_id=${selectedAccountId}`;
            }
            return '';
        }
        
        // Helper to build query string with account filter
        function buildQueryString(additionalParams = []) {
            let params = [];
            if (selectedAccountId) {
                params.push(`account_id=${selectedAccountId}`);
            }
            params = params.concat(additionalParams.filter(p => p));
            return params.length > 0 ? '?' + params.join('&') : '';
        }
        
        // Set agency filter
        function setAgencyFilter(agencyId, agencyName) {
            selectedAgencyId = agencyId;
            selectedAgencyName = agencyName;
            
            // Show banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            banner.style.display = 'flex';
            nameEl.textContent = agencyName;
            
            // Reload current view with filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                showView(viewName);
            }
        }
        
        // Clear agency filter
        function clearAgencyFilter() {
            selectedAgencyId = null;
            selectedAgencyName = null;
            
            // Hide banner
            document.getElementById('agencyFilterBanner').style.display = 'none';
            
            // Reload current view without filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                showView(viewName);
            }
        }
        
        // Get current client internal ID for API calls
        function getClientId() {
            if (!currentClientPublicId) return null;
            return clientIdMap[currentClientPublicId] || null;
        }
        
        // Get client ID param for API URLs
        function getClientParam() {
            const clientId = getClientId();
            return clientId ? `client_id=${clientId}` : '';
        }
        
        // Load clients into the selector dropdown
        async function loadClientSelector() {
            try {
                const [clientsRes, agenciesRes] = await Promise.all([
                    fetch('/api/admin/clients'),
                    fetch('/api/admin/agencies')
                ]);
                const clientsData = await clientsRes.json();
                const agenciesData = await agenciesRes.json();
                
                const selector = document.getElementById('globalClientSelector');
                if (!selector) return;
                
                selector.innerHTML = '<option value="">üåê All Clients (Admin View)</option>';
                clientIdMap = {}; // Reset map
                
                const agencies = agenciesData.agencies || [];
                const clients = clientsData.clients || [];
                
                // Add agencies first
                if (agencies.length > 0) {
                    const agencyGroup = document.createElement('optgroup');
                    agencyGroup.label = 'üè¢ Agencies';
                    agencies.forEach(agency => {
                        const option = document.createElement('option');
                        option.value = `agency_${agency.id}`;
                        option.textContent = agency.name;
                        agencyGroup.appendChild(option);
                    });
                    selector.appendChild(agencyGroup);
                }
                
                // Add direct clients (API already filters out agencies)
                if (clients.length > 0) {
                    const clientGroup = document.createElement('optgroup');
                    clientGroup.label = 'üë§ Direct Clients';
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        const publicId = client.public_id || client.id;
                        option.value = publicId;
                        option.textContent = client.business_name || client.name || 'Client';
                        clientGroup.appendChild(option);
                        clientIdMap[publicId] = client.id;
                    });
                    selector.appendChild(clientGroup);
                }
                
                // Check URL for client parameter and select it
                const urlParams = new URLSearchParams(window.location.search);
                const urlClientId = urlParams.get('client');
                if (urlClientId && clientIdMap[urlClientId]) {
                    selector.value = urlClientId;
                    switchClient(urlClientId, false);
                }
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }
        
        // Switch to a different client
        function switchClient(publicId, updateUrl = true) {
            currentClientPublicId = publicId || null;
            
            // Update URL so it's bookmarkable/shareable
            if (updateUrl) {
                const url = new URL(window.location);
                if (publicId) {
                    url.searchParams.set('client', publicId);
                } else {
                    url.searchParams.delete('client');
                }
                window.history.pushState({}, '', url);
            }
            
            // Update indicator
            const indicator = document.getElementById('clientIndicator');
            const indicatorText = document.getElementById('clientIndicatorText');
            
            if (!currentClientPublicId) {
                indicator.className = 'client-indicator all-clients';
                indicatorText.textContent = 'Viewing all clients';
            } else {
                indicator.className = 'client-indicator';
                const selector = document.getElementById('globalClientSelector');
                const selectedOption = selector.options[selector.selectedIndex];
                indicatorText.textContent = '‚úì ' + selectedOption.textContent;
            }
            
            // Reload current view with new client context
            const activeNav = document.querySelector('.nav-item.active');
            if (activeNav) {
                const viewName = activeNav.dataset.view;
                showView(viewName);
            }
        }
        
        // Simple navigation click handler
        function navClick(el, viewName) {
            // Update active state
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            
            // Show the view
            showView(viewName);
        }

        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            // Show requested view
            const viewEl = document.getElementById(viewName);
            if (viewEl) {
                viewEl.classList.add('active');
            } else {
                console.error('View not found:', viewName);
                return;
            }
            
            // Load data for specific views
            if (viewName === 'dashboard') loadDashboard();
            if (viewName === 'accounts') loadAccounts();
            if (viewName === 'agencies') loadAgencies();
            if (viewName === 'clients') loadClients();
            if (viewName === 'properties') loadProperties();
            if (viewName === 'rooms') loadRooms();
            if (viewName === 'images') loadImages();
            if (viewName === 'amenities') loadAmenities();
            if (viewName === 'content') loadContentView();
            if (viewName === 'availability') loadAvailabilityView();
            if (viewName === 'integrations') loadIntegrations();
            if (viewName === 'offers') loadOffers();
            if (viewName === 'vouchers') loadVouchers();
            if (viewName === 'upsells') loadUpsells();
            if (viewName === 'fees') loadFees();
            if (viewName === 'taxes') loadTaxes();
            if (viewName === 'marketing') loadMarketingProperties();
            if (viewName === 'wordpress') loadWordPressView();
            
            // New sidebar views
            if (viewName === 'app-blog') loadAppBlogPosts();
            if (viewName === 'app-attractions') loadAppAttractions();
            if (viewName === 'api-docs') {
                const urlInput = document.getElementById('api-docs-base-url');
                if (urlInput) urlInput.value = window.location.origin;
                loadApiKeys();
            }
            
            // Website Builder views
            if (viewName.startsWith('wb-')) loadWebsiteBuilderSection(viewName.replace('wb-', ''));
        }

        // =========================================================
        // WEBSITE BUILDER FUNCTIONS
        // =========================================================
        
        async function loadWebsiteBuilderSection(section) {
            try {
                const clientId = getClientId();
                if (!clientId) return;
                
                const response = await fetch(`/api/admin/website-builder/${section}?client_id=${clientId}`);
                const data = await response.json();
                
                if (data.success && data.settings) {
                    // Populate form fields based on section
                    Object.keys(data.settings).forEach(key => {
                        const el = document.getElementById(`wb-${section}-${key}`);
                        if (el) {
                            if (el.type === 'checkbox') {
                                el.checked = data.settings[key];
                            } else if (el.type === 'color') {
                                el.value = data.settings[key] || el.value;
                            } else {
                                el.value = data.settings[key] || '';
                            }
                        }
                    });
                    
                    // Handle image preview
                    if (data.settings.image) {
                        const preview = document.getElementById(`wb-${section}-image-preview`);
                        if (preview) {
                            preview.innerHTML = `<img src="${data.settings.image}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading website builder section:', error);
            }
        }
        
        async function saveWebsiteSection(section) {
            try {
                const clientId = getClientId();
                if (!clientId) {
                    alert('Please select a client first');
                    return;
                }
                
                // Collect all form values for this section
                const settings = {};
                const prefix = `wb-${section}-`;
                
                document.querySelectorAll(`[id^="${prefix}"]`).forEach(el => {
                    const key = el.id.replace(prefix, '');
                    if (el.type === 'checkbox') {
                        settings[key] = el.checked;
                    } else if (el.type === 'file') {
                        // Handle file uploads separately
                    } else {
                        settings[key] = el.value;
                    }
                });
                
                const response = await fetch(`/api/admin/website-builder/${section}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: clientId, settings })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Saved! Your website will update automatically.');
                } else {
                    alert('Error: ' + (data.error || 'Failed to save'));
                }
            } catch (error) {
                console.error('Error saving website section:', error);
                alert('Error saving. Please try again.');
            }
        }
        
        function previewWebsiteImage(section) {
            const input = document.getElementById(`wb-${section}-image`);
            const preview = document.getElementById(`wb-${section}-image-preview`);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function addWebsiteReview() {
            const container = document.getElementById('wb-reviews-list');
            const reviewId = Date.now();
            
            container.innerHTML += `
                <div class="review-item" id="review-${reviewId}" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Guest Name</label>
                        <input type="text" class="form-input review-name" placeholder="e.g., John D.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Review Text</label>
                        <textarea class="form-textarea review-text" rows="2" placeholder="Their testimonial..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rating</label>
                        <select class="form-select review-rating">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (3 stars)</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="document.getElementById('review-${reviewId}').remove()">üóëÔ∏è Remove</button>
                </div>
            `;
        }

        // =========================================================
        // AGENCY MANAGEMENT FUNCTIONS
        // =========================================================

        // =====================================================
        // ACCOUNTS MANAGEMENT (New unified system)
        // =====================================================
        
        let allAccounts = [];
        let currentAccountFilter = 'all';
        
        async function loadAccounts() {
            const container = document.getElementById('accounts-list');
            try {
                const response = await fetch('/api/admin/accounts');
                const data = await response.json();
                
                if (data.success && data.accounts) {
                    allAccounts = data.accounts;
                    
                    // Update stats
                    const masterAdmins = data.accounts.filter(a => a.role === 'master_admin');
                    const agencyAdmins = data.accounts.filter(a => a.role === 'agency_admin');
                    const subMasters = data.accounts.filter(a => a.role === 'submaster_admin');
                    const admins = data.accounts.filter(a => a.role === 'admin');
                    
                    document.getElementById('stat-total-accounts').textContent = data.accounts.length;
                    document.getElementById('stat-agency-admins').textContent = agencyAdmins.length;
                    document.getElementById('stat-submaster-admins').textContent = subMasters.length;
                    document.getElementById('stat-admins').textContent = admins.length;
                    
                    renderAccountsTable(data.accounts);
                } else {
                    container.innerHTML = `<p style="color: var(--error); padding: 2rem; text-align: center;">Error loading accounts</p>`;
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
                container.innerHTML = `<p style="color: var(--error); padding: 2rem; text-align: center;">Error loading accounts: ${error.message}</p>`;
            }
        }
        
        function filterAccounts(role) {
            currentAccountFilter = role;
            
            // Update button states
            document.querySelectorAll('.account-filter').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '';
                btn.style.color = '';
                if (btn.dataset.role === role) {
                    btn.classList.add('active');
                    btn.style.background = '#6366f1';
                    btn.style.color = 'white';
                }
            });
            
            // Filter and render
            let filtered = allAccounts;
            if (role !== 'all') {
                filtered = allAccounts.filter(a => a.role === role);
            }
            // Don't show master_admin in filtered views unless specifically viewing "all"
            if (role === 'all') {
                // Show everyone
            } else {
                filtered = allAccounts.filter(a => a.role === role);
            }
            
            renderAccountsTable(filtered);
        }
        
        function getRoleBadge(role) {
            const badges = {
                'master_admin': '<span class="badge" style="background: linear-gradient(135deg, #9333ea, #7c3aed); color: white;">üëë Master Admin</span>',
                'agency_admin': '<span class="badge" style="background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white;">üè¢ Agency Admin</span>',
                'submaster_admin': '<span class="badge" style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white;">üìÅ Sub Master</span>',
                'admin': '<span class="badge" style="background: linear-gradient(135deg, #16a34a, #15803d); color: white;">üë§ Admin</span>'
            };
            return badges[role] || `<span class="badge">${role}</span>`;
        }
        
        function renderAccountsTable(accounts) {
            const container = document.getElementById('accounts-list');
            
            if (accounts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <p style="font-size: 3rem; margin-bottom: 1rem;">üë•</p>
                        <p>No accounts found.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Role</th>
                                <th>Plan</th>
                                <th>Parent</th>
                                <th>Properties</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accounts.map(account => `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, ${account.primary_color || '#6366f1'} 0%, ${account.secondary_color || '#8b5cf6'} 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                                                ${account.name.charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <strong>${account.name}</strong>
                                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${account.email}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>${getRoleBadge(account.role)}</td>
                                    <td>
                                        <span id="account-plan-${account.id}" class="badge badge-secondary" style="cursor: pointer;" onclick="openAssignPlanModal(${account.id}, \`${account.name.replace(/`/g, "'")}\`)">
                                            Loading...
                                        </span>
                                    </td>
                                    <td>
                                        ${account.parent_name 
                                            ? `<span style="color: var(--text-secondary);">‚Ü≥ ${account.parent_name}</span>` 
                                            : '<span style="color: #9ca3af;">‚Äî</span>'}
                                    </td>
                                    <td><span class="badge">${account.property_count || 0}</span></td>
                                    <td>
                                        <span class="badge ${account.status === 'active' ? 'badge-success' : account.status === 'pending' ? 'badge-warning' : 'badge-secondary'}">
                                            ${account.status}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-secondary btn-small" onclick="viewAccount(${account.id})">View</button>
                                            ${account.role !== 'master_admin' ? `
                                                <button class="btn btn-secondary btn-small" onclick="openChangeRoleModal(${account.id}, '${account.role}', \`${account.name.replace(/`/g, "'")}\`)">Role</button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Load plan badges for each account
            accounts.forEach(account => loadAccountPlanBadge(account.id));
        }
        
        function viewAccount(accountId) {
            const account = allAccounts.find(a => a.id === accountId);
            if (!account) return;
            
            // Set the filter variables
            selectedAccountId = accountId;
            selectedAccountName = account.name;
            
            // Show banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            if (banner && nameEl) {
                banner.style.display = 'flex';
                nameEl.textContent = account.name;
            }
            
            // Reload entitlements for selected account
            if (typeof loadAccountEntitlements === 'function') {
                loadAccountEntitlements();
            }
            
            // Navigate to dashboard with new filter
            showView('dashboard');
        }
        
        // Load plan badge for an account
        async function loadAccountPlanBadge(accountId) {
            const badge = document.getElementById(`account-plan-${accountId}`);
            if (!badge) return;
            
            try {
                const response = await fetch(`/api/admin/billing/subscription/${accountId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const planColors = {
                        'starter': '#6b7280',
                        'professional': '#2563eb',
                        'business': '#7c3aed',
                        'enterprise': '#dc2626'
                    };
                    const color = planColors[data.data.plan_slug] || '#6b7280';
                    badge.innerHTML = data.data.plan_name;
                    badge.style.background = color;
                    badge.style.color = 'white';
                } else {
                    badge.innerHTML = 'No Plan';
                    badge.style.background = '#e5e7eb';
                    badge.style.color = '#6b7280';
                }
            } catch (error) {
                badge.innerHTML = 'Error';
                badge.style.background = '#fee2e2';
                badge.style.color = '#dc2626';
            }
        }
        
        // Open assign plan modal
        let assignPlanAccountId = null;
        let assignPlanAccountName = null;
        
        async function openAssignPlanModal(accountId, accountName) {
            assignPlanAccountId = accountId;
            assignPlanAccountName = accountName;
            
            // Reset checkboxes
            document.getElementById('assign-plan-api-access').checked = false;
            
            // Load plans for dropdown
            try {
                const response = await fetch('/api/admin/billing/plans');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const select = document.getElementById('assign-plan-select');
                    select.innerHTML = '<option value="">-- Select Plan --</option>' + 
                        data.data.filter(p => p.is_active).map(plan => 
                            `<option value="${plan.id}">${plan.name} - ¬£${parseFloat(plan.price_monthly).toFixed(2)}/mo</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading plans:', error);
            }
            
            // Get current subscription
            try {
                const response = await fetch(`/api/admin/billing/subscription/${accountId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    document.getElementById('assign-plan-select').value = data.data.plan_id;
                    document.getElementById('assign-plan-current').innerHTML = `Current plan: <strong>${data.data.plan_name}</strong>`;
                    document.getElementById('assign-plan-current').style.display = 'block';
                    
                    // Load feature overrides
                    const overrides = data.data.feature_overrides || {};
                    document.getElementById('assign-plan-api-access').checked = overrides.api_access === true;
                } else {
                    document.getElementById('assign-plan-current').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('assign-plan-current').style.display = 'none';
            }
            
            document.getElementById('assign-plan-account-name').textContent = accountName;
            openModal('assignPlanModal');
        }
        
        async function saveAssignedPlan() {
            const planId = document.getElementById('assign-plan-select').value;
            const billingCycle = document.getElementById('assign-plan-cycle').value;
            const apiAccess = document.getElementById('assign-plan-api-access').checked;
            
            if (!planId) {
                showNotification('Please select a plan', 'error');
                return;
            }
            
            // Build feature overrides (only include if checked)
            const featureOverrides = {};
            if (apiAccess) {
                featureOverrides.api_access = true;
            }
            
            try {
                const response = await fetch('/api/admin/billing/assign-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: assignPlanAccountId,
                        plan_id: parseInt(planId),
                        billing_cycle: billingCycle,
                        feature_overrides: featureOverrides
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(`Plan assigned to ${assignPlanAccountName}!`, 'success');
                    closeModal('assignPlanModal');
                    loadAccountPlanBadge(assignPlanAccountId);
                    // Reload entitlements if viewing this account
                    if (selectedAccountId === assignPlanAccountId) {
                        loadAccountEntitlements();
                    }
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error assigning plan', 'error');
            }
        }
        
        async function cancelAccountSubscription() {
            if (!confirm(`Cancel subscription for ${assignPlanAccountName}?`)) return;
            
            try {
                const response = await fetch('/api/admin/billing/cancel-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_id: assignPlanAccountId })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Subscription cancelled', 'success');
                    closeModal('assignPlanModal');
                    loadAccountPlanBadge(assignPlanAccountId);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error cancelling subscription', 'error');
            }
        }
        
        // Account filter (like the old agency filter)
        // selectedAccountId and selectedAccountName are declared at the top with other globals
        
        function setAccountFilter(accountId, accountName) {
            selectedAccountId = accountId;
            selectedAccountName = accountName;
            
            // Show banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            if (banner && nameEl) {
                banner.style.display = 'flex';
                nameEl.textContent = accountName;
            }
            
            // Reload entitlements for selected account
            if (typeof loadAccountEntitlements === 'function') {
                loadAccountEntitlements();
            }
            
            // Reload current view with filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                showView(viewName);
            }
        }
        
        function clearAccountFilter() {
            // Only master_admin can clear the filter
            if (currentAccount && currentAccount.role !== 'master_admin') {
                console.log('Non-master admin cannot clear account filter');
                return;
            }
            
            selectedAccountId = null;
            selectedAccountName = null;
            
            // Also clear old agency filter
            selectedAgencyId = null;
            selectedAgencyName = null;
            
            // Hide banner
            const banner = document.getElementById('agencyFilterBanner');
            if (banner) banner.style.display = 'none';
            
            // Reload entitlements (will show master admin's defaults)
            if (typeof loadAccountEntitlements === 'function') {
                loadAccountEntitlements();
            }
            
            // Reload current view without filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                showView(viewName);
            }
        }
        
        function openChangeRoleModal(accountId, currentRole, accountName) {
            const roles = ['admin', 'submaster_admin', 'agency_admin'];
            const roleLabels = {
                'admin': 'üë§ Admin',
                'submaster_admin': 'üìÅ Sub Master Admin',
                'agency_admin': 'üè¢ Agency Admin'
            };
            
            const options = roles.map(r => 
                `<option value="${r}" ${r === currentRole ? 'selected' : ''}>${roleLabels[r]}</option>`
            ).join('');
            
            const modalHtml = `
                <div class="modal-overlay" id="changeRoleModal" style="display: flex;">
                    <div class="modal" style="max-width: 400px;">
                        <div class="modal-header">
                            <h3>Change Role</h3>
                            <button class="modal-close" onclick="closeModal('changeRoleModal')">&times;</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <p style="margin-bottom: 1rem;">Change role for <strong>${accountName}</strong>:</p>
                            <select id="newRoleSelect" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                                ${options}
                            </select>
                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button class="btn btn-secondary" onclick="closeModal('changeRoleModal')" style="flex: 1;">Cancel</button>
                                <button class="btn" onclick="saveAccountRole(${accountId})" style="flex: 1;">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        async function saveAccountRole(accountId) {
            const newRole = document.getElementById('newRoleSelect').value;
            
            try {
                const response = await fetch(`/api/admin/accounts/${accountId}/update-role`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('changeRoleModal');
                    loadAccounts();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function openAddAccountModal() {
            // TODO: Implement add account modal
            alert('Add Account feature coming soon. For now, accounts are created when they sign up.');
        }

        async function loadAgencies() {
            const container = document.getElementById('agencies-list');
            try {
                const response = await fetch('/api/admin/agencies');
                const data = await response.json();
                
                // Also get direct clients count (clients without agency)
                const clientsRes = await fetch('/api/admin/clients');
                const clientsData = await clientsRes.json();
                const directClients = clientsData.clients?.filter(c => !c.agency_id) || [];
                const agencyClients = clientsData.clients?.filter(c => c.agency_id) || [];
                
                if (data.success && data.agencies) {
                    // Update stats
                    document.getElementById('stat-total-agencies').textContent = data.agencies.length;
                    document.getElementById('stat-agency-clients').textContent = agencyClients.length;
                    document.getElementById('stat-agency-properties').textContent = data.agencies.reduce((sum, a) => sum + parseInt(a.property_count || 0), 0);
                    document.getElementById('stat-direct-clients').textContent = directClients.length;
                    
                    if (data.agencies.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                <p style="font-size: 3rem; margin-bottom: 1rem;">üè¢</p>
                                <p>No agencies yet.</p>
                                <p style="font-size: 0.9rem; margin-top: 0.5rem;">Agencies are partners who manage multiple property owners.</p>
                                <button class="btn" onclick="openAddAgencyModal()" style="margin-top: 1rem;">Add Your First Agency</button>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Agency</th>
                                        <th>Clients</th>
                                        <th>Properties</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.agencies.map(agency => `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, ${agency.primary_color || '#10b981'} 0%, ${agency.secondary_color || '#059669'} 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                                                        ${agency.name.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <strong>${agency.name}</strong>
                                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${agency.email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="badge">${agency.client_count || 0}</span></td>
                                            <td><span class="badge">${agency.property_count || 0}</span></td>
                                            <td>
                                                <span class="badge ${agency.plan === 'enterprise' ? 'badge-warning' : 'badge-success'}">
                                                    ${agency.plan}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${agency.status === 'active' ? 'badge-success' : agency.status === 'pending' ? 'badge-warning' : 'badge-secondary'}">
                                                    ${agency.status}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewAgency(${agency.id})">View</button>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="editAgency(${agency.id})">Edit</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Error loading agencies. Run /api/setup-clients first.</p>';
                }
            } catch (error) {
                console.error('Error loading agencies:', error);
                container.innerHTML = `<p style="color: var(--error); text-align: center; padding: 2rem;">Error loading agencies: ${error.message}</p>`;
            }
        }

        function openAddAgencyModal() {
            document.getElementById('agency-id').value = '';
            document.getElementById('agency-public-id').value = '';
            document.getElementById('agency-form').reset();
            document.getElementById('agency-modal-title').textContent = 'üè¢ Add New Agency';
            document.getElementById('agency-country').value = 'CH';
            document.getElementById('agency-primary-color').value = '#6366f1';
            document.getElementById('agency-secondary-color').value = '#8b5cf6';
            document.getElementById('agency-api-key-section').style.display = 'none';
            openModal('agencyModal');
        }

        async function editAgency(agencyId) {
            try {
                const response = await fetch(`/api/admin/agencies/${agencyId}`);
                const data = await response.json();
                
                if (data.success && data.agency) {
                    const a = data.agency;
                    document.getElementById('agency-id').value = a.id;
                    document.getElementById('agency-public-id').value = a.public_id || '';
                    document.getElementById('agency-name').value = a.name || '';
                    document.getElementById('agency-email').value = a.email || '';
                    document.getElementById('agency-phone').value = a.phone || '';
                    document.getElementById('agency-website').value = a.website_url || '';
                    document.getElementById('agency-address1').value = a.address_line1 || '';
                    document.getElementById('agency-city').value = a.city || '';
                    document.getElementById('agency-country').value = normalizeCountryCode(a.country) || 'CH';
                    document.getElementById('agency-primary-color').value = a.primary_color || '#6366f1';
                    document.getElementById('agency-secondary-color').value = a.secondary_color || '#8b5cf6';
                    document.getElementById('agency-logo').value = a.logo_url || '';
                    document.getElementById('agency-currency').value = a.currency || 'CHF';
                    document.getElementById('agency-plan').value = a.plan || 'agency';
                    document.getElementById('agency-status').value = a.status || 'active';
                    document.getElementById('agency-notes').value = a.notes || '';
                    
                    // Show API key
                    if (a.api_key) {
                        document.getElementById('agency-api-key-display').value = a.api_key;
                        document.getElementById('agency-api-key-section').style.display = 'block';
                    } else {
                        document.getElementById('agency-api-key-section').style.display = 'none';
                    }
                    
                    document.getElementById('agency-modal-title').textContent = '‚úèÔ∏è Edit Agency';
                    openModal('agencyModal');
                }
            } catch (error) {
                alert('Error loading agency: ' + error.message);
            }
        }

        async function saveAgency(event) {
            event.preventDefault();
            
            const agencyId = document.getElementById('agency-id').value;
            const agencyData = {
                name: document.getElementById('agency-name').value,
                email: document.getElementById('agency-email').value,
                phone: document.getElementById('agency-phone').value,
                website_url: document.getElementById('agency-website').value,
                address_line1: document.getElementById('agency-address1').value,
                city: document.getElementById('agency-city').value,
                country: document.getElementById('agency-country').value,
                primary_color: document.getElementById('agency-primary-color').value,
                secondary_color: document.getElementById('agency-secondary-color').value,
                logo_url: document.getElementById('agency-logo').value,
                currency: document.getElementById('agency-currency').value,
                plan: document.getElementById('agency-plan').value,
                status: document.getElementById('agency-status').value,
                notes: document.getElementById('agency-notes').value
            };
            
            try {
                const url = agencyId ? `/api/admin/agencies/${agencyId}` : '/api/admin/agencies';
                const method = agencyId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agencyData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('agencyModal');
                    loadAgencies();
                    // If new agency, show success with API key
                    if (!agencyId && result.agency?.api_key) {
                        alert(`‚úÖ Agency created!\n\nAPI Key: ${result.agency.api_key}\n\nSave this key - it's needed for API access.`);
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving agency: ' + error.message);
            }
        }

        async function viewAgency(agencyId) {
            try {
                const response = await fetch(`/api/admin/agencies/${agencyId}`);
                const data = await response.json();
                
                if (data.success) {
                    const a = data.agency;
                    // Set the filter and navigate to dashboard
                    setAgencyFilter(a.id, a.name);
                    showView('dashboard');
                }
            } catch (error) {
                alert('Error loading agency: ' + error.message);
            }
        }
        
        // View agency details in modal (for Edit button)
        async function viewAgencyDetails(agencyId) {
            try {
                const response = await fetch(`/api/admin/agencies/${agencyId}`);
                const data = await response.json();
                
                if (data.success) {
                    const a = data.agency;
                    const properties = data.properties || [];
                    const totalRooms = properties.reduce((sum, p) => sum + parseInt(p.room_count || 0), 0);
                    
                    document.getElementById('agency-detail-title').textContent = a.name;
                    document.getElementById('agency-detail-subtitle').textContent = `${properties.length} properties ¬∑ ${a.email}`;
                    
                    document.getElementById('agency-detail-content').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${properties.length}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Properties</div>
                            </div>
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${totalRooms}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Rooms</div>
                            </div>
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700;">${a.plan}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Plan</div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem 0;">Agency Properties</h4>
                        ${properties.length === 0 ? `
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary); background: var(--bg-primary); border-radius: 8px;">
                                <p>No properties assigned to this agency yet.</p>
                                <p style="font-size: 0.85rem; margin-top: 0.5rem;">Go to Properties and use the Agency dropdown to assign properties.</p>
                            </div>
                        ` : `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Property</th>
                                            <th>Location</th>
                                            <th>Rooms</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${properties.map(p => `
                                            <tr>
                                                <td><strong>${p.name}</strong></td>
                                                <td style="font-size: 0.85rem; color: var(--text-secondary);">${p.city || 'N/A'}, ${p.country || ''}</td>
                                                <td><span class="badge">${p.room_count || 0}</span></td>
                                                <td>
                                                    <span class="badge ${p.status === 'active' ? 'badge-success' : 'badge-secondary'}">${p.status || 'active'}</span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-secondary btn-small" onclick="editProperty(${p.id}); closeModal('agencyDetailModal');" style="font-size: 0.75rem;">Edit</button>
                                                    <button class="btn btn-secondary btn-small" onclick="removePropertyFromAgency(${p.id}, ${a.id})" style="font-size: 0.75rem;">Remove</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 1rem;">
                            <button onclick="editAgency(${a.id}); closeModal('agencyDetailModal');" class="btn btn-secondary">Edit Agency</button>
                            <button onclick="closeModal('agencyDetailModal')" class="btn">Close</button>
                        </div>
                    `;
                    
                    openModal('agencyDetailModal');
                }
            } catch (error) {
                alert('Error loading agency: ' + error.message);
            }
        }
        
        async function removePropertyFromAgency(propertyId, agencyId) {
            if (!confirm('Remove this property from the agency?')) return;
            
            try {
                const response = await fetch(`/api/admin/properties/${propertyId}/assign-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agency_id: null })
                });
                const result = await response.json();
                if (result.success) {
                    viewAgency(agencyId);
                    loadAgencies();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function copyAgencyApiKey() {
            const keyInput = document.getElementById('agency-api-key-display');
            keyInput.select();
            navigator.clipboard.writeText(keyInput.value).then(() => {
                alert('‚úÖ API key copied!');
            }).catch(() => {
                document.execCommand('copy');
                alert('‚úÖ Copied!');
            });
        }

        async function assignClientToAgency(agencyId) {
            // Get unassigned clients
            const response = await fetch('/api/admin/clients');
            const data = await response.json();
            const unassignedClients = data.clients?.filter(c => !c.agency_id) || [];
            
            if (unassignedClients.length === 0) {
                alert('No unassigned clients available. Create a new client first.');
                return;
            }
            
            const clientOptions = unassignedClients.map(c => `${c.id}: ${c.business_name || c.name}`).join('\n');
            const selectedId = prompt(`Enter client ID to assign:\n\n${clientOptions}`);
            
            if (selectedId) {
                try {
                    const res = await fetch(`/api/admin/agencies/${agencyId}/assign-client`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ client_id: parseInt(selectedId) })
                    });
                    const result = await res.json();
                    if (result.success) {
                        alert('‚úÖ Client assigned to agency!');
                        viewAgency(agencyId);
                        loadAgencies();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        async function removeClientFromAgency(agencyId, clientId) {
            if (!confirm('Remove this client from the agency? They will become a direct client.')) return;
            
            try {
                const res = await fetch(`/api/admin/agencies/${agencyId}/remove-client`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: clientId })
                });
                const result = await res.json();
                if (result.success) {
                    alert('‚úÖ Client removed from agency');
                    viewAgency(agencyId);
                    loadAgencies();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function selectClientAndClose(clientId) {
            closeModal('agencyDetailModal');
            // Select the client in the dropdown and switch to their view
            document.getElementById('client-selector').value = clientId;
            clientId = clientId;
            selectedClientId = clientId;
            localStorage.setItem('selectedClientId', clientId);
            showView('dashboard');
        }

        // =========================================================
        // CLIENT MANAGEMENT FUNCTIONS
        // =========================================================

        async function loadClients() {
            const container = document.getElementById('clients-list');
            try {
                const [clientsRes, unassignedRes] = await Promise.all([
                    fetch('/api/admin/clients'),
                    fetch('/api/admin/properties/unassigned')
                ]);
                const data = await clientsRes.json();
                const unassignedData = await unassignedRes.json();
                
                if (data.success && data.clients) {
                    // Update stats
                    document.getElementById('stat-total-clients').textContent = data.clients.length;
                    document.getElementById('stat-active-clients').textContent = data.clients.filter(c => c.status === 'active').length;
                    document.getElementById('stat-paid-clients').textContent = data.clients.filter(c => c.plan !== 'free').length;
                    document.getElementById('stat-unassigned-props').textContent = unassignedData.properties?.length || 0;
                    
                    if (data.clients.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                <p style="font-size: 3rem; margin-bottom: 1rem;">üë•</p>
                                <p>No direct clients. All accounts are agencies.</p>
                                <button class="btn" onclick="openAddClientModal()" style="margin-top: 1rem;">Add Direct Client</button>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Client</th>
                                        <th>Properties</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Setup Link</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.clients.map(client => `
                                        <tr>
                                            <td>
                                                <strong>${client.business_name || client.name}</strong>
                                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${client.email}</div>
                                            </td>
                                            <td><span class="badge">${client.property_count || 0}</span></td>
                                            <td>
                                                <span class="badge ${client.plan === 'free' ? 'badge-secondary' : 'badge-warning'}">
                                                    ${client.plan}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${client.status === 'active' ? 'badge-success' : client.status === 'pending' ? 'badge-warning' : 'badge-secondary'}">
                                                    ${client.status}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: #10b981;" onclick="copySetupLink('${client.public_id || client.id}')">
                                                    üìã Copy Link
                                                </button>
                                            </td>
                                            <td>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewClient(${client.id})">View</button>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="editClient(${client.id})">Edit</button>
                                                ${parseInt(client.property_count) > 1 ? `
                                                    <button class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: #6366f1;" onclick="convertToAgency(${client.id}, '${client.name}')">
                                                        üè¢ Make Agency
                                                    </button>
                                                ` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No clients table found. Run the migration first.</p>';
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                container.innerHTML = `<p style="color: var(--error); text-align: center; padding: 2rem;">Error loading clients: ${error.message}</p>`;
            }
        }
        
        // Copy setup link for client
        function copySetupLink(publicId) {
            const baseUrl = window.location.origin;
            const setupLink = `${baseUrl}/setup.html?c=${publicId}`;
            
            navigator.clipboard.writeText(setupLink).then(() => {
                alert('‚úÖ Setup link copied!\n\n' + setupLink);
            }).catch(() => {
                prompt('Copy this setup link:', setupLink);
            });
        }

        // Convert client to agency
        async function convertToAgency(clientId, clientName) {
            if (!confirm(`Convert "${clientName}" to an Agency?\n\nThis will:\n‚Ä¢ Create an agency account for them\n‚Ä¢ Remove them from the Clients list\n‚Ä¢ They'll appear under Agencies instead`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/convert-to-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ ${clientName} is now an Agency!\n\nAPI Key: ${result.agency.api_key}`);
                    loadClients();
                    loadAgencies();
                    loadClientSelector();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error converting to agency: ' + error.message);
            }
        }

        function openAddClientModal() {
            document.getElementById('client-id').value = '';
            document.getElementById('client-public-id').value = '';
            document.getElementById('client-form').reset();
            document.getElementById('client-modal-title').textContent = 'üë• Add New Client';
            document.getElementById('client-country').value = 'GB';
            document.getElementById('client-setup-link-section').style.display = 'none';
            openModal('clientModal');
        }

        async function editClient(clientId) {
            try {
                const response = await fetch(`/api/admin/clients/${clientId}`);
                const data = await response.json();
                
                if (data.success && data.client) {
                    const c = data.client;
                    document.getElementById('client-id').value = c.id;
                    document.getElementById('client-public-id').value = c.public_id || '';
                    document.getElementById('client-name').value = c.name || '';
                    document.getElementById('client-email').value = c.email || '';
                    document.getElementById('client-phone').value = c.phone || '';
                    document.getElementById('client-address1').value = c.address_line1 || '';
                    document.getElementById('client-address2').value = c.address_line2 || '';
                    document.getElementById('client-city').value = c.city || '';
                    document.getElementById('client-region').value = c.region || '';
                    document.getElementById('client-postcode').value = c.postcode || '';
                    document.getElementById('client-country').value = normalizeCountryCode(c.country) || 'GB';
                    document.getElementById('client-currency').value = c.currency || 'GBP';
                    document.getElementById('client-plan').value = c.plan || 'free';
                    document.getElementById('client-status').value = c.status || 'active';
                    document.getElementById('client-notes').value = c.notes || '';
                    
                    // Show setup link section with UUID
                    const setupLinkSection = document.getElementById('client-setup-link-section');
                    if (c.public_id) {
                        const setupLink = `${window.location.origin}/smoobu-wizard.html?c=${c.public_id}`;
                        document.getElementById('client-setup-link-display').value = setupLink;
                        document.getElementById('client-uuid-display').textContent = c.public_id;
                        setupLinkSection.style.display = 'block';
                    } else {
                        setupLinkSection.style.display = 'none';
                    }
                    
                    document.getElementById('client-modal-title').textContent = '‚úèÔ∏è Edit Client';
                    openModal('clientModal');
                }
            } catch (error) {
                alert('Error loading client: ' + error.message);
            }
        }
        
        function copyClientSetupLink() {
            const linkInput = document.getElementById('client-setup-link-display');
            linkInput.select();
            navigator.clipboard.writeText(linkInput.value).then(() => {
                alert('‚úÖ Setup link copied!\n\n' + linkInput.value);
            }).catch(() => {
                document.execCommand('copy');
                alert('‚úÖ Copied!');
            });
        }

        async function saveClient(event) {
            event.preventDefault();
            
            const clientId = document.getElementById('client-id').value;
            const clientData = {
                name: document.getElementById('client-name').value,
                email: document.getElementById('client-email').value,
                phone: document.getElementById('client-phone').value,
                address_line1: document.getElementById('client-address1').value,
                address_line2: document.getElementById('client-address2').value,
                city: document.getElementById('client-city').value,
                region: document.getElementById('client-region').value,
                postcode: document.getElementById('client-postcode').value,
                country: document.getElementById('client-country').value,
                currency: document.getElementById('client-currency').value,
                plan: document.getElementById('client-plan').value,
                status: document.getElementById('client-status').value,
                notes: document.getElementById('client-notes').value
            };
            
            try {
                const url = clientId ? `/api/admin/clients/${clientId}` : '/api/admin/clients';
                const method = clientId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clientData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('clientModal');
                    loadClients();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving client: ' + error.message);
            }
        }

        async function viewClient(clientId) {
            openModal('clientDetailModal');
            document.getElementById('client-detail-content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;">Loading client details...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}`);
                const data = await response.json();
                
                if (data.success) {
                    const c = data.client;
                    document.getElementById('client-detail-title').textContent = c.name;
                    document.getElementById('client-detail-subtitle').textContent = c.email;
                    
                    document.getElementById('client-detail-content').innerHTML = `
                        <!-- API Key Section -->
                        <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8;">API Key</span>
                                <span class="badge ${c.plan === 'free' ? 'badge-secondary' : 'badge-success'}">${c.plan === 'free' ? 'üîí Requires Paid Plan' : '‚úì Active'}</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <code style="flex: 1; background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; word-break: break-all;">
                                    ${c.api_key || 'No API key generated'}
                                </code>
                                <button onclick="copyShortcode('${c.api_key}')" class="btn" style="padding: 0.5rem 1rem;">Copy</button>
                                <button onclick="regenerateApiKey(${c.id})" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Regenerate</button>
                            </div>
                            ${c.plan === 'free' ? '<p style="margin-top: 0.75rem; font-size: 0.8rem; opacity: 0.8;">‚ö†Ô∏è Upgrade to a paid plan to enable WordPress plugin API access</p>' : ''}
                        </div>

                        <!-- Properties -->
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <h4 style="margin: 0;">Properties (${data.properties?.length || 0})</h4>
                                <button onclick="assignPropertyToClient(${c.id})" class="btn btn-secondary" style="padding: 0.3rem 0.75rem; font-size: 0.8rem;">+ Assign Property</button>
                            </div>
                            ${data.properties && data.properties.length > 0 ? `
                                <div style="background: var(--bg-primary); border-radius: 8px; overflow: hidden;">
                                    ${data.properties.map(p => `
                                        <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${p.name}</strong>
                                                <span style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 0.5rem;">${p.room_count || 0} rooms</span>
                                            </div>
                                            <code style="font-size: 0.75rem; background: var(--bg-secondary); padding: 0.2rem 0.5rem; border-radius: 3px;">ID: ${p.id}</code>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: var(--text-secondary); font-size: 0.9rem;">No properties assigned</p>'}
                        </div>

                        <!-- Client Info Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div>
                                <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: var(--text-secondary);">Contact</h4>
                                <p style="margin: 0.25rem 0;"><strong>Phone:</strong> ${c.phone || '-'}</p>
                                <p style="margin: 0.25rem 0;"><strong>Address:</strong> ${[c.address_line1, c.city, c.postcode, c.country].filter(Boolean).join(', ') || '-'}</p>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: var(--text-secondary);">Settings</h4>
                                <p style="margin: 0.25rem 0;"><strong>Currency:</strong> ${c.currency || 'GBP'}</p>
                                <p style="margin: 0.25rem 0;"><strong>Created:</strong> ${new Date(c.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>

                        ${c.notes ? `
                            <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                                <strong style="color: #92400e;">Notes:</strong>
                                <p style="margin: 0.5rem 0 0 0; color: #78350f;">${c.notes}</p>
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                            <button onclick="editClient(${c.id}); closeModal('clientDetailModal');" class="btn btn-secondary">Edit Client</button>
                            <button onclick="deleteClient(${c.id})" class="btn" style="background: var(--error); border-color: var(--error);">Delete Client</button>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('client-detail-content').innerHTML = `<p style="color: var(--error);">Error loading client: ${error.message}</p>`;
            }
        }

        async function regenerateApiKey(clientId) {
            if (!confirm('Are you sure you want to regenerate the API key? The old key will stop working immediately.')) return;
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/regenerate-api-key`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert('API key regenerated! New key: ' + result.api_key);
                    viewClient(clientId);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error regenerating API key: ' + error.message);
            }
        }

        async function deleteClient(clientId) {
            if (!confirm('Are you sure you want to delete this client? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('clientDetailModal');
                    loadClients();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error deleting client: ' + error.message);
            }
        }

        async function assignPropertyToClient(clientId) {
            try {
                const response = await fetch('/api/admin/properties/unassigned');
                const data = await response.json();
                
                if (!data.properties || data.properties.length === 0) {
                    alert('No unassigned properties available');
                    return;
                }
                
                const propertyId = prompt(
                    'Enter property ID to assign:\n\nUnassigned properties:\n' + 
                    data.properties.map(p => `ID ${p.id}: ${p.name}`).join('\n')
                );
                
                if (propertyId) {
                    const assignResponse = await fetch(`/api/admin/clients/${clientId}/assign-property`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ property_id: parseInt(propertyId) })
                    });
                    
                    const result = await assignResponse.json();
                    if (result.success) {
                        viewClient(clientId);
                    } else {
                        alert('Error: ' + result.error);
                    }
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Copy shortcode to clipboard
        function copyShortcode(shortcode) {
            navigator.clipboard.writeText(shortcode).then(() => {
                const notification = document.createElement('div');
                notification.textContent = 'Copied!';
                notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; z-index: 9999; animation: fadeIn 0.2s;';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            });
        }

        // Load WordPress view data
        async function loadWordPressView() {
            // Load account website status first
            if (typeof loadAccountWebsite === 'function') {
                loadAccountWebsite();
            }
            
            // Set API URL in all locations
            const apiUrl = window.location.origin;
            document.getElementById('wp-api-url').textContent = apiUrl;
            document.getElementById('wp-api-url-guide').textContent = apiUrl;
            
            // Get client ID
            const clientId = selectedAccountId || JSON.parse(localStorage.getItem('gas_user') || '{}').account_id || '';
            document.getElementById('wp-client-id').textContent = clientId || '-';
            if (document.getElementById('wp-client-id-guide')) {
                document.getElementById('wp-client-id-guide').textContent = clientId || '1';
            }
            
            // Build query params for filtering by account
            let queryParams = [];
            if (selectedAccountId) {
                queryParams.push(`account_id=${selectedAccountId}`);
            } else {
                const user = JSON.parse(localStorage.getItem('gas_user') || '{}');
                if (user.account_id) {
                    queryParams.push(`account_id=${user.account_id}`);
                }
            }
            const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
            
            // Load rooms for reference (filtered by account)
            try {
                const response = await fetch('/api/admin/units' + queryString);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    // Set first property ID in all locations
                    const firstPropertyId = data.data[0].property_id;
                    window.currentPropertyId = firstPropertyId;
                    document.getElementById('shortcode-property-id').textContent = firstPropertyId;
                    document.getElementById('wp-property-id').textContent = firstPropertyId;
                    if (document.getElementById('wp-property-id-guide')) {
                        document.getElementById('wp-property-id-guide').textContent = firstPropertyId;
                    }
                    document.getElementById('wp-rooms-shortcode').textContent = `[gas_rooms]`;
                    
                    // Build rooms table
                    let html = '<table style="width: 100%; font-size: 0.85rem;">';
                    html += '<thead><tr style="text-align: left; border-bottom: 1px solid var(--border);"><th style="padding: 0.5rem;">Room Name</th><th style="padding: 0.5rem;">ID</th><th style="padding: 0.5rem;">Shortcode</th></tr></thead>';
                    html += '<tbody>';
                    
                    data.data.forEach(room => {
                        html += `<tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 0.5rem;">${room.name}</td>
                            <td style="padding: 0.5rem;"><code style="background: #e2e8f0; padding: 0.15rem 0.4rem; border-radius: 3px;">${room.id}</code></td>
                            <td style="padding: 0.5rem;">
                                <code style="background: #1e293b; color: #e2e8f0; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">[gas_booking unit_id="${room.id}"]</code>
                                <button onclick="copyShortcode('[gas_booking unit_id=&quot;${room.id}&quot;]')" style="background: var(--accent); border: none; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-left: 0.5rem;">Copy</button>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    document.getElementById('wp-room-ids').innerHTML = html;
                } else {
                    document.getElementById('wp-room-ids').innerHTML = '<p style="color: var(--text-secondary);">No rooms found. Add rooms first or select a client.</p>';
                }
            } catch (error) {
                console.error('Error loading rooms for WordPress view:', error);
                document.getElementById('wp-room-ids').innerHTML = '<p style="color: var(--error);">Error loading rooms</p>';
            }
        }

        // Data Loading
        async function loadDashboard() {
            try {
                // Build query params - prioritize account_id (new system)
                let queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                } else {
                    const clientId = getClientId();
                    if (clientId) {
                        queryParams.push(`client_id=${clientId}`);
                    }
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                console.log('loadDashboard - selectedAccountId:', selectedAccountId, 'queryString:', queryString);
                
                const response = await fetch(`/api/admin/stats${queryString}`);
                const stats = await response.json();
                
                console.log('loadDashboard - stats:', stats);
                
                if (stats.success) {
                    document.getElementById('stat-properties').textContent = stats.properties || 0;
                    document.getElementById('stat-rooms').textContent = stats.units || 0;
                    document.getElementById('stat-bookings').textContent = stats.bookings || 0;
                    document.getElementById('stat-integrations').textContent = stats.connections || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadProperties() {
            const container = document.getElementById('properties-list');
            try {
                // Build query params - prioritize account_id (new system)
                let queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                } else if (selectedAgencyId) {
                    queryParams.push(`agency_id=${selectedAgencyId}`);
                }
                const clientId = getClientId();
                if (clientId) {
                    queryParams.push(`client_id=${clientId}`);
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                // Fetch properties and agencies
                const [propsRes, agenciesRes] = await Promise.all([
                    fetch(`/api/db/properties${queryString}`),
                    fetch('/api/admin/agencies')
                ]);
                const data = await propsRes.json();
                const agenciesData = await agenciesRes.json();
                const agencies = agenciesData.agencies || [];
                
                // Filter properties by account if filter is set
                let properties = data.data || [];
                if (selectedAccountId && properties.length > 0) {
                    properties = properties.filter(p => p.account_id === selectedAccountId);
                } else if (selectedAgencyId && properties.length > 0) {
                    properties = properties.filter(p => p.agency_id === selectedAgencyId);
                }
                
                if (properties.length > 0) {
                    const html = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Property Name</th>
                                        <th>Type</th>
                                        <th>Location</th>
                                        <th>Agency</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${properties.map(prop => {
                                        const currentAgency = agencies.find(a => a.id === prop.agency_id);
                                        return `
                                        <tr>
                                            <td><strong>${prop.name || 'Unnamed Property'}</strong></td>
                                            <td>${prop.property_type || 'N/A'}</td>
                                            <td>${prop.city || 'N/A'}, ${prop.country || 'N/A'}</td>
                                            <td>
                                                <select onchange="assignPropertyToAgency(${prop.id}, this.value)" style="padding: 0.3rem; border-radius: 4px; border: 1px solid #e2e8f0; font-size: 0.8rem;">
                                                    <option value="">-- None --</option>
                                                    ${agencies.map(a => `<option value="${a.id}" ${prop.agency_id === a.id ? 'selected' : ''}>${a.name}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td><span class="badge ${prop.status === 'active' ? 'badge-success' : prop.status === 'draft' ? 'badge-warning' : 'badge-secondary'}">${prop.status || 'active'}</span></td>
                                            <td>
                                                <div style="display: flex; gap: 0.25rem;">
                                                    <button class="btn btn-secondary btn-small" onclick="editProperty(${prop.id})">Edit</button>
                                                    <button class="btn btn-secondary btn-small" onclick="openPaymentSettings(${prop.id}, '${prop.name.replace(/'/g, "\\'")}')" title="Payment Settings">üí≥</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üè®</div>
                            <h3>No Properties ${selectedAgencyId ? 'for this Agency' : 'Yet'}</h3>
                            <p>${selectedAgencyId ? 'Assign properties to this agency from the Properties view.' : 'Import your first property from Beds24'}</p>
                            ${!selectedAgencyId ? '<a href="/beds24-wizard.html" class="btn">Import Property</a>' : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading properties:', error);
                container.innerHTML = '<p style="color: var(--error); padding: 2rem; text-align: center;">Error loading properties</p>';
            }
        }
        
        async function assignPropertyToAgency(propertyId, agencyId) {
            try {
                const response = await fetch(`/api/admin/properties/${propertyId}/assign-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ agency_id: agencyId || null })
                });
                const result = await response.json();
                if (!result.success) {
                    alert('Error: ' + result.error);
                    loadProperties();
                }
            } catch (error) {
                alert('Error assigning agency: ' + error.message);
                loadProperties();
            }
        }

        async function loadRooms() {
            const container = document.getElementById('rooms-list');
            try {
                // Build query params for account filter
                let queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                const response = await fetch(`/api/admin/units${queryString}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const html = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Room Name</th>
                                        <th>Property</th>
                                        <th>Type</th>
                                        <th>Capacity</th>
                                        <th>Qty</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.map(unit => `
                                        <tr>
                                            <td><code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${unit.id}</code></td>
                                            <td><strong>${unit.name}</strong></td>
                                            <td style="font-size: 0.85rem; color: var(--text-secondary);">${unit.property_name || 'N/A'}</td>
                                            <td>${unit.unit_type || 'N/A'}</td>
                                            <td>${unit.max_guests || '-'} guests</td>
                                            <td>${unit.quantity || 1}</td>
                                            <td>
                                                <span class="badge ${(unit.status === 'available' || unit.status === 'active') ? 'badge-success' : unit.status === 'maintenance' ? 'badge-warning' : 'badge-secondary'}">
                                                    ${(unit.status === 'available' || unit.status === 'active') ? '‚úÖ' : unit.status === 'maintenance' ? 'üîß' : '‚ùå'} ${unit.status || 'available'}
                                                </span>
                                            </td>
                                            <td><button class="btn btn-secondary btn-small" onclick="editRoom(${unit.id})">Edit</button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üõèÔ∏è</div>
                            <h3>No Rooms Found</h3>
                            <p>Rooms are imported with properties from Beds24</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
                container.innerHTML = '<p style="color: var(--error); padding: 2rem; text-align: center;">Error loading rooms</p>';
            }
        }

        async function loadAmenities() {
            const container = document.getElementById('amenities-list');
            try {
                const response = await fetch('/api/admin/amenities');
                const data = await response.json();
                
                if (data.success) {
                    const amenitiesList = data.amenities || [];
                    
                    if (amenitiesList.length > 0) {
                        // Group by category
                        const categories = {};
                        amenitiesList.forEach(a => {
                            const cat = a.category || 'other';
                            if (!categories[cat]) categories[cat] = [];
                            categories[cat].push(a);
                        });
                        
                        // Category display names with icons
                        const categoryNames = {
                            'beds': 'üõèÔ∏è Beds',
                            'bathrooms': 'üöø Bathrooms',
                            'essentials': '‚≠ê Essentials',
                            'kitchen': 'üç≥ Kitchen',
                            'entertainment': 'üì∫ Entertainment',
                            'wellness': 'üíÜ Wellness',
                            'parking': 'üöó Parking',
                            'outdoor': 'üå≥ Outdoor',
                            'family': 'üë®‚Äçüë©‚Äçüëß Family',
                            'work': 'üíº Work',
                            'safety': 'üö® Safety',
                            'laundry': 'üß∫ Laundry',
                            'other': 'üì¶ Other'
                        };
                        
                        let html = `
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="font-size: 1.1rem;">${amenitiesList.length}</strong> master amenities available
                                    <span style="color: var(--text-secondary); margin-left: 1rem; font-size: 0.9rem;">
                                        Select amenities for each room in the room editor
                                    </span>
                                </div>
                            </div>
                        `;
                        
                        // Sort categories
                        const sortedCategories = Object.entries(categories).sort((a, b) => {
                            const order = ['beds', 'bathrooms', 'essentials', 'kitchen', 'entertainment', 'outdoor', 'wellness', 'parking', 'family', 'work', 'safety', 'laundry', 'other'];
                            return order.indexOf(a[0]) - order.indexOf(b[0]);
                        });
                        
                        sortedCategories.forEach(([cat, items]) => {
                            html += `
                                <div style="margin-bottom: 2rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                        <h3 style="margin: 0; color: var(--text-primary);">${categoryNames[cat] || cat}</h3>
                                        <span style="color: var(--text-secondary); font-size: 0.85rem;">${items.length} items</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.75rem;">
                                        ${items.map(a => {
                                            const name = typeof a.amenity_name === 'string' ? 
                                                (a.amenity_name.startsWith('{') ? JSON.parse(a.amenity_name).en : a.amenity_name) :
                                                a.amenity_name?.en || a.amenity_code;
                                            return `
                                            <div style="display: flex; justify-content: space-between; align-items: center; background: var(--bg-secondary); border: 1px solid var(--border); padding: 0.75rem; border-radius: 6px;">
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 500;">${a.icon || ''} ${name}</div>
                                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                                        ${a.is_system ? 'System' : 'Custom'}
                                                    </div>
                                                </div>
                                                ${!a.is_system ? `
                                                    <button onclick="deleteAmenity(${a.id})" class="btn btn-secondary btn-small" style="background: var(--error); border-color: var(--error); color: white; padding: 0.25rem 0.5rem; margin-left: 0.5rem;">
                                                        Delete
                                                    </button>
                                                ` : ''}
                                            </div>
                                        `}).join('')}
                                    </div>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">‚≠ê</div>
                                <h3>No Amenities Yet</h3>
                                <p>Run the migration to create standard amenities</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading amenities:', error);
                container.innerHTML = '<p style="color: var(--error); padding: 2rem; text-align: center;">Error loading amenities</p>';
            }
        }
        
        async function deleteAmenity(id) {
            if (!confirm(`Delete this amenity?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/amenities/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Amenity deleted successfully!');
                    loadAmenities();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting amenity:', error);
                alert('Error deleting amenity');
            }
        }

        // =========================================================
        // IMAGE MANAGEMENT FUNCTIONS
        // =========================================================
        
        let selectedFiles = [];
        let currentFilter = 'all';
        let allImages = [];

        async function loadImages() {
            try {
                allImages = [];
                let propertyCount = 0;
                let roomCount = 0;
                let locationCount = 0;

                // Load all properties (filtered by account)
                let properties = [];
                try {
                    const queryString = buildQueryString();
                    const propsResp = await fetch(`/api/db/properties${queryString}`);
                    if (propsResp.ok) {
                        const propsData = await propsResp.json();
                        properties = propsData.data || [];
                    }
                } catch (e) {
                    console.log('No properties found:', e.message);
                }

                // Load all rooms (filtered by account)
                let rooms = [];
                try {
                    const queryString = buildQueryString();
                    const roomsResp = await fetch(`/api/db/bookable-units${queryString}`);
                    if (roomsResp.ok) {
                        const roomsData = await roomsResp.json();
                        rooms = roomsData.data || [];
                    }
                } catch (e) {
                    console.log('No rooms found:', e.message);
                }

                // Load property images
                for (const prop of properties) {
                    try {
                        const imgResp = await fetch(`/api/admin/properties/${prop.id}/images`);
                        if (imgResp.ok) {
                            const imgData = await imgResp.json();
                            if (imgData.success && imgData.images) {
                                imgData.images.forEach(img => {
                                    allImages.push({
                                        ...img,
                                        type: 'property',
                                        entityId: prop.id,
                                        entityName: prop.name
                                    });
                                });
                                propertyCount += imgData.images.length;
                            }
                        }
                    } catch (e) {
                        console.log(`Error loading images for property ${prop.id}:`, e.message);
                    }
                }

                // Load room images
                for (const room of rooms) {
                    try {
                        const imgResp = await fetch(`/api/admin/rooms/${room.id}/images`);
                        if (imgResp.ok) {
                            const imgData = await imgResp.json();
                            if (imgData.success && imgData.images) {
                                imgData.images.forEach(img => {
                                    allImages.push({
                                        ...img,
                                        type: 'room',
                                        entityId: room.id,
                                        entityName: room.name
                                    });
                                });
                                roomCount += imgData.images.length;
                            }
                        }
                    } catch (e) {
                        console.log(`Error loading images for room ${room.id}:`, e.message);
                    }
                }

                // Update counters
                document.getElementById('property-image-count').textContent = propertyCount;
                document.getElementById('room-image-count').textContent = roomCount;
                document.getElementById('location-image-count').textContent = locationCount;
                document.getElementById('total-image-count').textContent = propertyCount + roomCount + locationCount;

                // Display gallery
                displayImages();
            } catch (error) {
                console.error('Error loading images:', error);
                // Show empty state on error
                const gallery = document.getElementById('images-gallery');
                gallery.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üñºÔ∏è</div>
                        <h3>No Images Yet</h3>
                        <p>Upload images to showcase your properties</p>
                        <button class="btn" onclick="openImageUploadModal()">Upload Images</button>
                    </div>
                `;
            }
        }

        function filterImages(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.filter === filter) {
                    tab.classList.add('active');
                }
            });

            displayImages();
        }

        function displayImages() {
            const gallery = document.getElementById('images-gallery');
            
            let filteredImages = allImages;
            if (currentFilter !== 'all') {
                if (currentFilter === 'rooms') {
                    filteredImages = allImages.filter(img => img.type === 'room');
                } else {
                    filteredImages = allImages.filter(img => img.type === currentFilter);
                }
            }

            if (filteredImages.length === 0) {
                gallery.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üñºÔ∏è</div>
                        <h3>No Images Yet</h3>
                        <p>Upload images to showcase your properties</p>
                        <button class="btn" onclick="openImageUploadModal()">Upload Images</button>
                    </div>
                `;
                return;
            }

            // Group images by entity (room or property)
            const groupedImages = {};
            filteredImages.forEach(img => {
                const key = `${img.type}-${img.entityId}`;
                if (!groupedImages[key]) {
                    groupedImages[key] = {
                        type: img.type,
                        entityId: img.entityId,
                        entityName: img.entityName,
                        images: []
                    };
                }
                groupedImages[key].images.push(img);
            });

            // Sort images within each group by display_order
            Object.values(groupedImages).forEach(group => {
                group.images.sort((a, b) => a.display_order - b.display_order);
            });

            let html = '';
            
            Object.values(groupedImages).forEach(group => {
                const icon = group.type === 'room' ? 'üõèÔ∏è' : (group.type === 'property' ? 'üè®' : 'üìç');
                
                html += `
                    <div class="room-image-section" style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border);">
                            ${icon} ${group.entityName}
                            <span style="font-size: 0.85rem; color: var(--text-secondary); font-weight: normal; margin-left: 0.5rem;">
                                (${group.images.length} image${group.images.length !== 1 ? 's' : ''})
                            </span>
                        </h3>
                        <div class="image-gallery">
                            ${group.images.map((img, idx) => {
                                const isFirst = idx === 0;
                                const isLast = idx === group.images.length - 1;
                                
                                return `
                                <div class="image-card" data-id="${img.id}" data-image-id="${img.id}" data-type="${img.type}" data-entity="${img.entityId}">
                                    <img src="${img.thumbnail_url || img.image_url}" alt="${img.alt_text || ''}" loading="lazy">
                                    <div class="image-card-info">
                                        <div class="image-tags">
                                            ${img.is_primary ? '<span class="image-tag" style="background: gold; color: #000;">‚≠ê Primary</span>' : ''}
                                        </div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                            ${img.width} √ó ${img.height} px ‚Ä¢ Order: ${idx + 1}
                                        </div>
                                        <div class="image-actions">
                                            <button class="btn btn-small" onclick="moveImage('${img.type}', ${img.entityId}, ${img.id}, -1)" ${isFirst ? 'disabled style="opacity:0.3"' : ''}>‚Üê</button>
                                            <button class="btn btn-small" onclick="moveImage('${img.type}', ${img.entityId}, ${img.id}, 1)" ${isLast ? 'disabled style="opacity:0.3"' : ''}>‚Üí</button>
                                            ${!img.is_primary ? `<button class="btn btn-small" onclick="setPrimaryImage('${img.type}', ${img.entityId}, ${img.id})">‚≠ê</button>` : ''}
                                            <button class="btn btn-secondary btn-small" onclick="deleteImage('${img.type}', ${img.id})" style="color: #ef4444;">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
            });

            gallery.innerHTML = html;
        }

        function openImageUploadModal() {
            selectedFiles = [];
            document.getElementById('uploadPreview').innerHTML = '';
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('assignmentSection').style.display = 'block'; // Show by default
            document.getElementById('uploadButton').disabled = true;
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            
            // Load rooms for checkboxes
            loadRoomCheckboxes();
            
            openModal('imageUploadModal');
            
            // Setup drag and drop
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('imageFileInput');
            
            uploadZone.onclick = () => fileInput.click();
            
            fileInput.onchange = (e) => handleFiles(e.target.files);
            
            uploadZone.ondragover = (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            };
            
            uploadZone.ondragleave = () => {
                uploadZone.classList.remove('dragover');
            };
            
            uploadZone.ondrop = (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            };
        }

        async function loadRoomCheckboxes() {
            try {
                // Build query params for account filtering
                let queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                } else {
                    const user = JSON.parse(localStorage.getItem('gas_account') || '{}');
                    if (user.account_id) {
                        queryParams.push(`account_id=${user.account_id}`);
                    }
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                const response = await fetch('/api/db/bookable-units' + queryString);
                if (!response.ok) {
                    throw new Error('Failed to load rooms');
                }
                const data = await response.json();
                const rooms = data.data || [];
                
                const container = document.getElementById('roomCheckboxes');
                if (rooms.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">No rooms available for this account.</p>';
                    return;
                }
                
                container.innerHTML = rooms.map(room => `
                    <label class="checkbox-label" style="cursor: pointer;">
                        <input type="checkbox" class="room-checkbox" value="${room.id}" style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                        <span style="flex: 1;">${room.name}</span>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Error loading rooms:', error);
                const container = document.getElementById('roomCheckboxes');
                container.innerHTML = '<p style="color: var(--error); padding: 1rem;">Error loading rooms. Make sure server is deployed.</p>';
            }
        }

        async function handleFiles(files) {
            const preview = document.getElementById('uploadPreview');
            preview.innerHTML = '';
            preview.style.display = 'grid';
            // Assignment section already visible from modal open
            
            selectedFiles = [];
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                
                const reader = new FileReader();
                const previewId = 'preview-' + Math.random().toString(36).substr(2, 9);
                
                reader.onload = async (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = () => {
                        const ratio = img.width / img.height;
                        const isLandscape = ratio >= 1.2; // At least 1.2:1 ratio
                        
                        const previewHtml = `
                            <div class="upload-preview-item" id="${previewId}">
                                <img src="${e.target.result}">
                                ${!isLandscape ? '<div class="error">Ratio too narrow - Min 1.2:1</div>' : ''}
                                <button class="remove" onclick="removePreview('${previewId}', '${file.name}')">√ó</button>
                            </div>
                        `;
                        preview.insertAdjacentHTML('beforeend', previewHtml);
                        
                        if (isLandscape) {
                            selectedFiles.push({ file, previewId });
                        }
                        
                        document.getElementById('uploadButton').disabled = selectedFiles.length === 0;
                    };
                };
                
                reader.readAsDataURL(file);
            }
        }

        function removePreview(previewId, filename) {
            document.getElementById(previewId)?.remove();
            selectedFiles = selectedFiles.filter(f => f.previewId !== previewId);
            document.getElementById('uploadButton').disabled = selectedFiles.length === 0;
        }

        async function uploadImages() {
            if (selectedFiles.length === 0) {
                alert('No valid images selected');
                return;
            }

            // Get assignments
            const isProperty = document.getElementById('assign-property').checked;
            const isLocation = document.getElementById('assign-location').checked;
            const selectedRooms = Array.from(document.querySelectorAll('.room-checkbox:checked')).map(cb => cb.value);

            if (!isProperty && !isLocation && selectedRooms.length === 0) {
                alert('Please assign images to at least one category (Property, Location, or Rooms)');
                return;
            }

            document.getElementById('uploadButton').disabled = true;
            // Show centered progress overlay
            const progressDiv = document.getElementById('uploadProgress');
            progressDiv.style.display = 'flex';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            
            let uploadedCount = 0;
            let errorCount = 0;

            // Upload to each selected destination
            const destinations = [];
            
            if (isProperty) {
                const propsResp = await fetch('/api/db/properties');
                const propsData = await propsResp.json();
                if (propsData.data && propsData.data.length > 0) {
                    destinations.push({ type: 'property', id: propsData.data[0].id });
                }
            }

            selectedRooms.forEach(roomId => {
                destinations.push({ type: 'room', id: roomId });
            });

            const totalUploads = destinations.length * selectedFiles.length;
            let completed = 0;

            for (const dest of destinations) {
                const formData = new FormData();
                selectedFiles.forEach(item => formData.append('images', item.file));

                try {
                    const endpoint = dest.type === 'property' 
                        ? `/api/admin/properties/${dest.id}/images`
                        : `/api/admin/rooms/${dest.id}/images`;
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.success) {
                        uploadedCount += result.images.length;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    errorCount++;
                }

                completed += selectedFiles.length;
                const progress = (completed / totalUploads) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
            }

            // Show completion
            document.getElementById('progressText').textContent = `‚úì ${uploadedCount} images uploaded${errorCount > 0 ? ` (${errorCount} errors)` : ''}`;
            
            setTimeout(() => {
                closeModal('imageUploadModal');
                loadImages();
            }, 1500);
        }

        async function setPrimaryImage(type, entityId, imageId) {
            // Show loading state on the image
            const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imgCard) {
                imgCard.style.opacity = '0.5';
                imgCard.style.pointerEvents = 'none';
            }
            
            try {
                const endpoint = type === 'property'
                    ? `/api/admin/properties/${entityId}/images/${imageId}/primary`
                    : `/api/admin/rooms/${entityId}/images/${imageId}/primary`;
                
                const response = await fetch(endpoint, { method: 'PUT' });
                const result = await response.json();
                
                if (result.success) {
                    await loadImages(); // await the refresh
                } else {
                    alert('Error: ' + result.error);
                    if (imgCard) {
                        imgCard.style.opacity = '1';
                        imgCard.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Error setting primary:', error);
                alert('Error setting primary image');
                if (imgCard) {
                    imgCard.style.opacity = '1';
                    imgCard.style.pointerEvents = 'auto';
                }
            }
        }

        async function deleteImage(type, imageId) {
            if (!confirm('Delete this image? This cannot be undone.')) return;
            
            // Show loading state
            const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imgCard) {
                imgCard.style.opacity = '0.5';
                imgCard.style.pointerEvents = 'none';
            }
            
            try {
                const endpoint = type === 'property'
                    ? `/api/admin/properties/images/${imageId}`
                    : `/api/admin/rooms/images/${imageId}`;
                
                const response = await fetch(endpoint, { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    // Remove the card immediately for instant feedback
                    const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
                    if (imgCard) {
                        imgCard.style.transition = 'opacity 0.3s, transform 0.3s';
                        imgCard.style.opacity = '0';
                        imgCard.style.transform = 'scale(0.8)';
                        setTimeout(() => imgCard.remove(), 300);
                    }
                    // Then refresh to update counts etc
                    await loadImages();
                } else {
                    alert('Error: ' + result.error);
                    const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
                    if (imgCard) {
                        imgCard.style.opacity = '1';
                        imgCard.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('Error deleting image');
            }
        }

        async function moveImage(type, entityId, imageId, direction) {
            // Show loading state
            const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imgCard) {
                imgCard.style.opacity = '0.5';
                imgCard.style.pointerEvents = 'none';
            }
            
            // Get images for this entity
            const entityImages = allImages.filter(img => 
                img.type === type && img.entityId === entityId
            ).sort((a, b) => a.display_order - b.display_order);
            
            const currentIndex = entityImages.findIndex(img => img.id === imageId);
            const newIndex = currentIndex + direction;
            
            if (newIndex < 0 || newIndex >= entityImages.length) {
                if (imgCard) {
                    imgCard.style.opacity = '1';
                    imgCard.style.pointerEvents = 'auto';
                }
                return;
            }
            
            // Swap positions
            const newOrder = entityImages.map(img => img.id);
            [newOrder[currentIndex], newOrder[newIndex]] = [newOrder[newIndex], newOrder[currentIndex]];
            
            try {
                const endpoint = type === 'property'
                    ? `/api/admin/properties/${entityId}/images/reorder`
                    : `/api/admin/rooms/${entityId}/images/reorder`;
                
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageIds: newOrder })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadImages();
                } else {
                    alert('Error: ' + result.error);
                    if (imgCard) {
                        imgCard.style.opacity = '1';
                        imgCard.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Error reordering:', error);
                alert('Error reordering images');
                if (imgCard) {
                    imgCard.style.opacity = '1';
                    imgCard.style.pointerEvents = 'auto';
                }
            }
        }

        async function loadIntegrations() {
            const container = document.getElementById('channel-connections');
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Status</th>
                                <th>Properties</th>
                                <th>Last Sync</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Beds24</strong></td>
                                <td><span class="badge badge-success">Active</span></td>
                                <td>1</td>
                                <td>Just now</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        let allAmenitiesData = [];
        
        async function openAddAmenityModal() {
            // Load all amenities
            await loadAllAmenitiesData();
            
            // Reset form
            document.getElementById('new-amenity-name').value = '';
            document.getElementById('new-amenity-icon').value = '';
            document.getElementById('new-category-name').value = '';
            document.getElementById('category-amenities-list').style.display = 'none';
            document.getElementById('add-amenity-section').style.display = 'none';
            document.getElementById('amenity-category-select').value = '';
            
            openModal('addAmenityModal');
        }
        
        async function loadAllAmenitiesData() {
            try {
                const response = await fetch('/api/admin/amenities');
                const data = await response.json();
                
                if (data.success && data.amenities) {
                    allAmenitiesData = data.amenities;
                    
                    // Get unique categories
                    const categories = [...new Set(data.amenities.map(a => a.category))].sort();
                    
                    const categoryIcons = {
                        'essentials': 'üì∂', 'beds': 'üõèÔ∏è', 'bathrooms': 'üöø', 'kitchen': 'üç≥',
                        'parking': 'üöó', 'entertainment': 'üì∫', 'wellness': 'üíÜ', 'outdoor': 'üå≥',
                        'safety': 'üîí', 'accessibility': '‚ôø', 'services': 'üõéÔ∏è', 'room_features': 'üè†'
                    };
                    
                    const select = document.getElementById('amenity-category-select');
                    select.innerHTML = '<option value="">Choose a category...</option>';
                    
                    categories.forEach(cat => {
                        const icon = categoryIcons[cat] || '‚ú®';
                        const displayName = cat.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        const count = data.amenities.filter(a => a.category === cat).length;
                        select.innerHTML += `<option value="${cat}">${icon} ${displayName} (${count})</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading amenities:', error);
            }
        }
        
        function loadCategoryAmenities() {
            const category = document.getElementById('amenity-category-select').value;
            const listContainer = document.getElementById('category-amenities-list');
            const amenitiesContainer = document.getElementById('amenities-in-category');
            const addSection = document.getElementById('add-amenity-section');
            
            if (!category) {
                listContainer.style.display = 'none';
                addSection.style.display = 'none';
                return;
            }
            
            // Filter amenities by category
            const categoryAmenities = allAmenitiesData.filter(a => a.category === category);
            
            // Display amenities
            amenitiesContainer.innerHTML = categoryAmenities.map(a => {
                const name = typeof a.amenity_name === 'object' ? a.amenity_name.en : a.amenity_name;
                return `
                    <span style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--bg-card); border-radius: 6px; font-size: 0.9rem;">
                        ${a.icon || '‚úì'} ${name}
                        <button onclick="deleteSingleAmenity(${a.id}, '${name.replace(/'/g, "\\'")}')" style="background: none; border: none; color: var(--error); cursor: pointer; padding: 0; margin-left: 0.25rem; font-size: 1.1rem; line-height: 1;">√ó</button>
                    </span>
                `;
            }).join('');
            
            listContainer.style.display = 'block';
            addSection.style.display = 'block';
        }
        
        async function deleteSingleAmenity(id, name) {
            if (!confirm(`Delete "${name}"?`)) return;
            
            try {
                const response = await fetch(`/api/admin/amenities/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    await loadAllAmenitiesData();
                    loadCategoryAmenities();
                    loadAmenities();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting amenity:', error);
                alert('Error deleting amenity');
            }
        }
        
        async function addAmenityToCategory() {
            const category = document.getElementById('amenity-category-select').value;
            const name = document.getElementById('new-amenity-name').value.trim();
            const icon = document.getElementById('new-amenity-icon').value.trim();
            
            if (!category || !name) {
                alert('Please select a category and enter an amenity name');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/amenities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, category, icon })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('new-amenity-name').value = '';
                    document.getElementById('new-amenity-icon').value = '';
                    await loadAllAmenitiesData();
                    loadCategoryAmenities();
                    loadAmenities(); // Refresh main amenities view
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding amenity:', error);
                alert('Error adding amenity');
            }
        }
        
        async function createNewCategory() {
            const categoryName = document.getElementById('new-category-name').value.trim();
            
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }
            
            // Convert to code format
            const categoryCode = categoryName.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
            
            // Add a placeholder amenity to create the category
            try {
                const response = await fetch('/api/admin/amenities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name: categoryName + ' (default)', 
                        category: categoryCode, 
                        icon: '‚ú®' 
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('new-category-name').value = '';
                    await loadAllAmenitiesData();
                    document.getElementById('amenity-category-select').value = categoryCode;
                    loadCategoryAmenities();
                    loadAmenities();
                    alert('Category created! You can now add amenities to it.');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating category:', error);
                alert('Error creating category');
            }
        }
        
        function autoSuggestIcon() {
            const name = document.getElementById('new-amenity-name').value.toLowerCase();
            const iconInput = document.getElementById('new-amenity-icon');
            
            // Only suggest if icon field is empty
            if (iconInput.value) return;
            
            const iconMap = {
                // TV & Entertainment
                'tv': 'üì∫', 'television': 'üì∫', 'smart tv': 'üì∫', 'netflix': 'üì∫', 'streaming': 'üì∫',
                'cable': 'üì∫', 'satellite': 'üì∫', 'dvd': 'üìÄ', 'blu-ray': 'üìÄ', 'gaming': 'üéÆ',
                'playstation': 'üéÆ', 'xbox': 'üéÆ', 'nintendo': 'üéÆ', 'speaker': 'üîä', 'sound': 'üîä',
                'bluetooth': 'üì∂', 'radio': 'üìª', 'music': 'üéµ', 'stereo': 'üéµ',
                
                // Beds
                'bed': 'üõèÔ∏è', 'king': 'üõèÔ∏è', 'queen': 'üõèÔ∏è', 'double': 'üõèÔ∏è', 'single': 'üõèÔ∏è',
                'twin': 'üõèÔ∏è', 'bunk': 'üõèÔ∏è', 'sofa bed': 'üõãÔ∏è', 'futon': 'üõãÔ∏è', 'cot': 'üë∂',
                'crib': 'üë∂', 'mattress': 'üõèÔ∏è', 'pillow': 'üõèÔ∏è', 'duvet': 'üõèÔ∏è', 'blanket': 'üõèÔ∏è',
                
                // Bathroom
                'shower': 'üöø', 'bath': 'üõÅ', 'bathtub': 'üõÅ', 'toilet': 'üöΩ', 'bidet': 'üöø',
                'towel': 'üß¥', 'hairdryer': 'üí®', 'hair dryer': 'üí®', 'shampoo': 'üß¥', 'soap': 'üßº',
                'vanity': 'ü™û', 'mirror': 'ü™û', 'jacuzzi': 'üõÅ', 'hot tub': 'üõÅ', 'sauna': 'üßñ',
                
                // Kitchen
                'kitchen': 'üç≥', 'stove': 'üç≥', 'oven': 'üç≥', 'microwave': 'üìª', 'fridge': 'üßä',
                'refrigerator': 'üßä', 'freezer': 'üßä', 'dishwasher': 'üçΩÔ∏è', 'coffee': '‚òï',
                'espresso': '‚òï', 'kettle': 'ü´ñ', 'tea': 'ü´ñ', 'toaster': 'üçû', 'blender': 'ü•§',
                'utensils': 'üç¥', 'cookware': 'üç≥', 'dishes': 'üçΩÔ∏è', 'wine': 'üç∑', 'glasses': 'ü•É',
                
                // Temperature
                'air conditioning': '‚ùÑÔ∏è', 'ac': '‚ùÑÔ∏è', 'cooling': '‚ùÑÔ∏è', 'heating': 'üî•',
                'heater': 'üî•', 'fireplace': 'üî•', 'fan': 'üí®', 'thermostat': 'üå°Ô∏è',
                
                // Internet & Tech
                'wifi': 'üì∂', 'internet': 'üì∂', 'ethernet': 'üîå', 'computer': 'üíª',
                'laptop': 'üíª', 'desk': 'üñ•Ô∏è', 'workspace': 'üíº', 'printer': 'üñ®Ô∏è', 'charger': 'üîå',
                'usb': 'üîå', 'outlet': 'üîå', 'phone': 'üì±', 'telephone': '‚òéÔ∏è',
                
                // Laundry
                'washer': 'üß∫', 'washing': 'üß∫', 'dryer': 'üß∫', 'laundry': 'üß∫', 'iron': 'üëî',
                'ironing': 'üëî', 'hanger': 'üëî', 'closet': 'üö™', 'wardrobe': 'üö™',
                
                // Outdoor
                'pool': 'üèä', 'swimming': 'üèä', 'garden': 'üå≥', 'patio': 'üå≥', 'balcony': 'üåÖ',
                'terrace': 'üåÖ', 'deck': 'üå≥', 'bbq': 'üçñ', 'grill': 'üçñ', 'barbecue': 'üçñ',
                'beach': 'üèñÔ∏è', 'lake': 'üåä', 'ocean': 'üåä', 'view': 'üåÖ', 'mountain': '‚õ∞Ô∏è',
                
                // Parking
                'parking': 'üöó', 'garage': 'üöó', 'car': 'üöó', 'ev': '‚ö°', 'charging': '‚ö°',
                'electric': '‚ö°', 'bike': 'üö≤', 'bicycle': 'üö≤',
                
                // Safety
                'safe': 'üîí', 'lock': 'üîê', 'security': 'üîí', 'alarm': 'üö®', 'camera': 'üì∑',
                'smoke': 'üö≠', 'fire': 'üßØ', 'extinguisher': 'üßØ', 'first aid': 'üè•',
                'detector': 'üö®', 'carbon': 'üö®',
                
                // Accessibility
                'wheelchair': '‚ôø', 'accessible': '‚ôø', 'elevator': 'üõó', 'lift': 'üõó',
                'ramp': '‚ôø', 'grab bar': '‚ôø', 'step-free': '‚ôø',
                
                // Pets
                'pet': 'üêï', 'dog': 'üêï', 'cat': 'üêà', 'animal': 'üêæ',
                
                // Kids
                'child': 'üë∂', 'kid': 'üë∂', 'baby': 'üë∂', 'high chair': 'üë∂', 'toys': 'üß∏',
                
                // Wellness
                'gym': 'üèãÔ∏è', 'fitness': 'üèãÔ∏è', 'yoga': 'üßò', 'spa': 'üíÜ', 'massage': 'üíÜ',
                
                // Other
                'key': 'üîë', 'keyless': 'üîë', 'luggage': 'üß≥', 'storage': 'üì¶',
                'breakfast': 'üç≥', 'food': 'üçΩÔ∏è', 'dining': 'üçΩÔ∏è', 'room service': 'üõéÔ∏è',
                'concierge': 'üõéÔ∏è', 'reception': 'üõéÔ∏è', 'housekeeping': 'üßπ', 'cleaning': 'üßπ'
            };
            
            // Check for matches
            for (const [keyword, icon] of Object.entries(iconMap)) {
                if (name.includes(keyword)) {
                    iconInput.value = icon;
                    return;
                }
            }
        }
        
        async function deleteAllInCategory() {
            const category = document.getElementById('amenity-category-select').value;
            
            if (!category) {
                alert('Please select a category first');
                return;
            }
            
            const categoryAmenities = allAmenitiesData.filter(a => a.category === category);
            const displayName = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            if (!confirm(`Delete ALL ${categoryAmenities.length} amenities in "${displayName}"?\n\nThis cannot be undone!`)) {
                return;
            }
            
            try {
                let deleted = 0;
                for (const amenity of categoryAmenities) {
                    const response = await fetch(`/api/admin/amenities/${amenity.id}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) deleted++;
                }
                
                alert(`Deleted ${deleted} amenities from ${displayName}`);
                await loadAllAmenitiesData();
                loadCategoryAmenities();
                loadAmenities();
            } catch (error) {
                console.error('Error deleting amenities:', error);
                alert('Error deleting amenities');
            }
        }
        
        async function deleteAllAmenities() {
            const totalCount = allAmenitiesData.length;
            
            if (!confirm(`‚ö†Ô∏è DELETE ALL ${totalCount} AMENITIES?\n\nThis will remove EVERY amenity from your system.\n\nThis action CANNOT be undone!\n\nType "DELETE" to confirm.`)) {
                return;
            }
            
            const confirmation = prompt('Type DELETE to confirm:');
            if (confirmation !== 'DELETE') {
                alert('Deletion cancelled');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/amenities/delete-all', {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`Deleted ${result.deleted} amenities`);
                    await loadAllAmenitiesData();
                    document.getElementById('amenity-category-select').value = '';
                    document.getElementById('category-amenities-list').style.display = 'none';
                    document.getElementById('add-amenity-section').style.display = 'none';
                    loadAmenities();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting all amenities:', error);
                alert('Error deleting amenities');
            }
        }

        // ========================================
        // CONTENT MANAGEMENT FUNCTIONS
        // ========================================
        
        let currentContentType = 'property';
        
        function filterContent(type) {
            currentContentType = type;
            
            // Update tabs
            document.querySelectorAll('[data-content-type]').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.contentType === type) tab.classList.add('active');
            });
            
            // Show/hide sections
            document.getElementById('content-property').style.display = type === 'property' ? 'block' : 'none';
            document.getElementById('content-contact').style.display = type === 'contact' ? 'block' : 'none';
            document.getElementById('content-room').style.display = type === 'room' ? 'block' : 'none';
            document.getElementById('content-policies').style.display = type === 'policies' ? 'block' : 'none';
            document.getElementById('content-pages').style.display = type === 'pages' ? 'block' : 'none';
            document.getElementById('content-branding').style.display = type === 'branding' ? 'block' : 'none';
            
            // Load data for sections
            if (type === 'contact') {
                loadContactInfo();
            } else if (type === 'pages') {
                loadWebsitePage('about');
            } else if (type === 'branding') {
                loadBranding();
            }
        }
        
        async function loadContentView() {
            // Load properties into all selects (filtered by account)
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const propertyOptions = '<option value="">Choose a property...</option>' + 
                        data.data.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    
                    document.getElementById('content-property-select').innerHTML = propertyOptions;
                    document.getElementById('content-policies-property-select').innerHTML = propertyOptions;
                }
                
                // Load rooms (filtered by account)
                const roomsResp = await fetch(`/api/db/bookable-units${queryString}`);
                const roomsData = await roomsResp.json();
                
                if (roomsData.success && roomsData.data) {
                    const roomOptions = '<option value="">Choose a room...</option>' + 
                        roomsData.data.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                    
                    document.getElementById('content-room-select').innerHTML = roomOptions;
                }
            } catch (error) {
                console.error('Error loading content view:', error);
            }
        }
        
        async function loadPropertyContent() {
            const propertyId = document.getElementById('content-property-select').value;
            const form = document.getElementById('property-content-form');
            
            if (!propertyId) {
                form.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/content/property/${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.content) {
                    document.getElementById('property-description').value = data.content.description || '';
                    document.getElementById('property-location').value = data.content.location_description || '';
                } else {
                    document.getElementById('property-description').value = '';
                    document.getElementById('property-location').value = '';
                }
                
                form.style.display = 'block';
            } catch (error) {
                console.error('Error loading property content:', error);
                form.style.display = 'block';
            }
        }
        
        async function savePropertyContent() {
            const propertyId = document.getElementById('content-property-select').value;
            if (!propertyId) return alert('Please select a property');
            
            const content = {
                description: document.getElementById('property-description').value,
                location_description: document.getElementById('property-location').value
            };
            
            try {
                const response = await fetch(`/api/admin/content/property/${propertyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(content)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Property content saved!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving property content:', error);
                alert('Error saving content');
            }
        }
        
        async function loadRoomContent() {
            const roomId = document.getElementById('content-room-select').value;
            const form = document.getElementById('room-content-form');
            
            if (!roomId) {
                form.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/content/room/${roomId}`);
                const data = await response.json();
                
                if (data.success && data.content) {
                    document.getElementById('room-short-description').value = data.content.short_description || '';
                    document.getElementById('room-full-description').value = data.content.full_description || '';
                } else {
                    document.getElementById('room-short-description').value = '';
                    document.getElementById('room-full-description').value = '';
                }
                
                form.style.display = 'block';
            } catch (error) {
                console.error('Error loading room content:', error);
                form.style.display = 'block';
            }
        }
        
        async function saveRoomContent() {
            const roomId = document.getElementById('content-room-select').value;
            if (!roomId) return alert('Please select a room');
            
            const content = {
                short_description: document.getElementById('room-short-description').value,
                full_description: document.getElementById('room-full-description').value
            };
            
            try {
                const response = await fetch(`/api/admin/content/room/${roomId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(content)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Room content saved!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving room content:', error);
                alert('Error saving content');
            }
        }
        
        // AI Content Generation
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).value;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const original = btn.innerHTML;
                btn.innerHTML = '‚úÖ';
                setTimeout(() => btn.innerHTML = original, 1500);
            });
        }
        
        async function generatePropertyContent(type) {
            const propertyId = document.getElementById('content-property-select').value;
            if (!propertyId) return alert('Please select a property');
            
            const prompt = document.getElementById('property-ai-prompt').value;
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, property_id: propertyId, prompt })
                });
                
                const result = await response.json();
                if (result.success) {
                    if (type === 'property_description') {
                        document.getElementById('property-description').value = result.content;
                    } else if (type === 'property_location') {
                        document.getElementById('property-location').value = result.content;
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating content');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generateRoomContent(type) {
            const roomId = document.getElementById('content-room-select').value;
            if (!roomId) return alert('Please select a room');
            
            const prompt = document.getElementById('room-ai-prompt').value;
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, room_id: roomId, prompt })
                });
                
                const result = await response.json();
                if (result.success) {
                    if (type === 'room_short') {
                        document.getElementById('room-short-description').value = result.content;
                    } else if (type === 'room_full') {
                        document.getElementById('room-full-description').value = result.content;
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating content');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function loadPoliciesContent() {
            const propertyId = document.getElementById('content-policies-property-select').value;
            const form = document.getElementById('policies-content-form');
            
            if (!propertyId) {
                form.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/content/policies/${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.content) {
                    document.getElementById('policy-house-rules').value = data.content.house_rules || '';
                    document.getElementById('policy-cancellation').value = data.content.cancellation_policy || '';
                    document.getElementById('policy-terms').value = data.content.terms_conditions || '';
                } else {
                    document.getElementById('policy-house-rules').value = '';
                    document.getElementById('policy-cancellation').value = '';
                    document.getElementById('policy-terms').value = '';
                }
                
                form.style.display = 'block';
            } catch (error) {
                console.error('Error loading policies:', error);
                form.style.display = 'block';
            }
        }
        
        async function savePoliciesContent() {
            const propertyId = document.getElementById('content-policies-property-select').value;
            if (!propertyId) return alert('Please select a property');
            
            const content = {
                house_rules: document.getElementById('policy-house-rules').value,
                cancellation_policy: document.getElementById('policy-cancellation').value,
                terms_conditions: document.getElementById('policy-terms').value
            };
            
            try {
                const response = await fetch(`/api/admin/content/policies/${propertyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(content)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Policies saved!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving policies:', error);
                alert('Error saving policies');
            }
        }

        // ========================================
        // AVAILABILITY GRID FUNCTIONS
        // ========================================
        
        let gridStartDate = new Date();
        let gridRooms = [];
        let gridData = {}; // roomId -> { date -> data }
        const GRID_DAYS = 14; // Show 2 weeks at a time
        
        let allRooms = []; // Store all rooms for filtering
        let availabilityViewLoaded = false;
        
        async function loadAvailabilityView() {
            // Reset loaded flag when account filter changes
            availabilityViewLoaded = false;
            
            // Set start date to today
            gridStartDate = new Date();
            gridStartDate.setHours(0, 0, 0, 0);
            
            // Set default edit dates
            const today = new Date();
            document.getElementById('edit-from-date').value = today.toISOString().split('T')[0];
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('edit-to-date').value = nextWeek.toISOString().split('T')[0];
            
            // Load properties for filter (filtered by account)
            try {
                const queryString = buildQueryString();
                const propsResponse = await fetch(`/api/db/properties${queryString}`);
                const propsData = await propsResponse.json();
                
                const propFilter = document.getElementById('grid-property-filter');
                if (propFilter && propsData.success) {
                    propFilter.innerHTML = '<option value="">All Properties</option>' +
                        propsData.data.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
            
            // Load rooms (filtered by account)
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/bookable-units${queryString}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    allRooms = data.data;
                    gridRooms = data.data;
                    
                    // Populate edit room select
                    const select = document.getElementById('edit-room-select');
                    select.innerHTML = '<option value="">All Rooms</option>' +
                        data.data.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
            
            await loadGridData();
        }
        
        function filterGridByProperty() {
            const propFilter = document.getElementById('grid-property-filter');
            const propertyId = propFilter.value;
            
            console.log('=== FILTER DEBUG ===');
            console.log('Selected property ID:', propertyId);
            console.log('allRooms count:', allRooms.length);
            
            if (propertyId) {
                gridRooms = allRooms.filter(r => {
                    const match = String(r.property_id) === String(propertyId);
                    return match;
                });
                console.log('Filtered to', gridRooms.length, 'rooms for property', propertyId);
            } else {
                gridRooms = [...allRooms];
                console.log('Showing all', gridRooms.length, 'rooms');
            }
            
            // Update edit room select with filtered rooms
            const select = document.getElementById('edit-room-select');
            select.innerHTML = '<option value="">All Rooms</option>' +
                gridRooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            
            // Make sure we preserve the dropdown selection
            propFilter.value = propertyId;
            
            loadGridData();
        }
        
        function shiftGridDays(days) {
            gridStartDate.setDate(gridStartDate.getDate() + days);
            loadGridData();
        }
        
        function jumpToDate(dateStr) {
            if (dateStr) {
                gridStartDate = new Date(dateStr);
                loadGridData();
            }
        }
        
        function goToToday() {
            gridStartDate = new Date();
            gridStartDate.setHours(0, 0, 0, 0);
            loadGridData();
        }
        
        async function loadGridData() {
            const fromDate = gridStartDate.toISOString().split('T')[0];
            const endDate = new Date(gridStartDate);
            endDate.setDate(endDate.getDate() + GRID_DAYS - 1);
            const toDate = endDate.toISOString().split('T')[0];
            
            // Update date range display and date picker
            const opts = { month: 'short', day: 'numeric' };
            document.getElementById('grid-date-range').textContent = 
                `${gridStartDate.toLocaleDateString('en-US', opts)} - ${endDate.toLocaleDateString('en-US', opts)}`;
            document.getElementById('grid-date-picker').value = fromDate;
            
            // Load availability for all rooms
            gridData = {};
            
            for (const room of gridRooms) {
                try {
                    const response = await fetch(`/api/availability/${room.id}?from=${fromDate}&to=${toDate}`);
                    const data = await response.json();
                    
                    if (data.success && data.availability) {
                        gridData[room.id] = {};
                        data.availability.forEach(a => {
                            gridData[room.id][a.date] = a;
                        });
                    }
                } catch (error) {
                    console.error(`Error loading availability for room ${room.id}:`, error);
                }
            }
            
            renderGrid();
        }
        
        function renderGrid() {
            const table = document.getElementById('availability-grid');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate dates array
            const dates = [];
            for (let i = 0; i < GRID_DAYS; i++) {
                const d = new Date(gridStartDate);
                d.setDate(d.getDate() + i);
                dates.push(d);
            }
            
            // Build header row
            let html = '<thead><tr>';
            html += '<th style="position: sticky; left: 0; background: #f9fafb; z-index: 10; padding: 8px; min-width: 180px; text-align: left; font-weight: 600; color: #374151;">Room</th>';
            html += '<th style="padding: 4px; min-width: 45px; text-align: center; background: #f9fafb;">Row</th>';
            
            dates.forEach(d => {
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = d.getDate();
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const isToday = d.getTime() === today.getTime();
                
                html += `<th style="padding: 4px 2px; min-width: 52px; text-align: center; font-weight: normal; 
                    background: ${isWeekend ? '#f3f4f6' : '#f9fafb'};
                    ${isToday ? 'background: #dbeafe; font-weight: 600;' : ''}">
                    <div style="font-size: 0.65rem; color: #9ca3af;">${dayName}</div>
                    <div style="color: #374151;">${dayNum}</div>
                </th>`;
            });
            html += '</tr></thead>';
            
            // Build body rows - one row per room per data type
            html += '<tbody>';
            
            gridRooms.forEach(room => {
                const roomData = gridData[room.id] || {};
                
                // Row 1: Status (Available/Blocked/Booked)
                html += '<tr>';
                html += `<td rowspan="2" style="position: sticky; left: 0; background: #ffffff; z-index: 5; padding: 8px; font-weight: 500; border-bottom: 2px solid #e5e7eb; color: #1f2937;">${room.name}</td>`;
                html += `<td style="padding: 4px; font-size: 0.65rem; color: #9ca3af; background: #fafafa;">Status</td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = roomData[dateStr];
                    const isPast = d < today;
                    
                    let bgColor = '#d1fae5'; // green - available
                    let text = '';
                    let textColor = '#065f46';
                    
                    if (dayData) {
                        if (dayData.is_booked || (!dayData.is_available && !dayData.is_blocked)) {
                            bgColor = '#fee2e2'; // red - booked
                            text = dayData.guest_name ? dayData.guest_name.split(' ')[0] : '√ó';
                            textColor = '#991b1b';
                        } else if (dayData.is_blocked) {
                            bgColor = '#fef3c7'; // yellow
                            text = '‚úï';
                            textColor = '#92400e';
                        }
                    }
                    
                    if (isPast) {
                        bgColor = '#f3f4f6';
                        textColor = '#9ca3af';
                    }
                    
                    html += `<td style="padding: 2px; text-align: center; background: ${bgColor}; color: ${textColor}; font-size: 0.7rem; cursor: ${isPast ? 'default' : 'pointer'};"
                        onclick="selectDateRange('${room.id}', '${dateStr}')">${text}</td>`;
                });
                html += '</tr>';
                
                // Row 2: Price
                html += '<tr style="border-bottom: 2px solid #e5e7eb;">';
                html += `<td style="padding: 4px; font-size: 0.65rem; color: #9ca3af; background: #fafafa;">Price</td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = roomData[dateStr];
                    const isPast = d < today;
                    
                    let priceText = '-';
                    let priceStyle = 'color: var(--text-secondary);';
                    
                    if (dayData && !isPast) {
                        if (dayData.direct_price && dayData.cm_price && dayData.direct_price != dayData.cm_price) {
                            // Show direct price in green (discounted)
                            priceText = `${Math.round(dayData.direct_price)}`;
                            priceStyle = 'color: #10b981; font-weight: 500;';
                        } else if (dayData.cm_price) {
                            priceText = `${Math.round(dayData.cm_price)}`;
                        } else if (dayData.direct_price) {
                            priceText = `${Math.round(dayData.direct_price)}`;
                        }
                    }
                    
                    html += `<td style="padding: 2px; text-align: center; font-size: 0.7rem; ${priceStyle} ${isPast ? 'opacity: 0.4;' : ''}">${priceText}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function selectDateRange(roomId, dateStr) {
            document.getElementById('edit-room-select').value = roomId;
            document.getElementById('edit-from-date').value = dateStr;
            document.getElementById('edit-to-date').value = dateStr;
        }
        
        function toggleEditInputs() {
            const action = document.getElementById('edit-action').value;
            document.getElementById('edit-price-group').style.display = action === 'price' ? 'block' : 'none';
            document.getElementById('edit-discount-group').style.display = action === 'discount' ? 'block' : 'none';
        }
        
        async function applyQuickEdit() {
            const roomId = document.getElementById('edit-room-select').value;
            const fromDate = document.getElementById('edit-from-date').value;
            const toDate = document.getElementById('edit-to-date').value;
            const action = document.getElementById('edit-action').value;
            const price = document.getElementById('edit-price').value;
            const discount = document.getElementById('edit-discount').value;
            
            if (!fromDate || !toDate) return alert('Please select dates');
            
            // Determine which rooms to update
            const roomsToUpdate = roomId ? [roomId] : gridRooms.map(r => r.id);
            
            let totalUpdated = 0;
            
            for (const rid of roomsToUpdate) {
                const payload = {
                    room_id: rid,
                    from_date: fromDate,
                    to_date: toDate,
                    status: (action === 'block') ? 'blocked' : 'available'
                };
                
                if (action === 'price' && price) {
                    payload.price = price;
                } else if (action === 'discount' && discount) {
                    payload.discount_percent = discount;
                }
                
                try {
                    const response = await fetch('/api/admin/availability', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.success) {
                        totalUpdated += result.days_updated;
                    }
                } catch (error) {
                    console.error('Error updating:', error);
                }
            }
            
            alert(`Updated ${totalUpdated} day(s) across ${roomsToUpdate.length} room(s)`);
            loadGridData();
        }
        
        async function syncBeds24() {
            if (!confirm('Sync availability and pricing from Beds24?')) return;
            
            const btn = document.getElementById('sync-beds24-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';
            
            try {
                const response = await fetch('/api/admin/sync-all-availability-quick', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Beds24 Sync complete!\n\n${result.roomsCount} rooms\n${result.totalPricesFound} prices`);
                } else {
                    alert(`‚ùå Beds24 Sync failed: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Beds24';
            loadGridData();
        }
        
        async function syncHostaway() {
            if (!confirm('Sync availability and pricing from Hostaway?')) return;
            
            const btn = document.getElementById('sync-hostaway-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';
            
            try {
                const response = await fetch('/api/admin/sync-hostaway-availability', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Hostaway Sync complete!\n\n${result.roomsSynced} listings\n${result.totalPricesUpdated} prices`);
                } else {
                    alert(`‚ùå Hostaway Sync failed: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Hostaway';
            loadGridData();
        }

        async function syncSmoobu() {
            if (!confirm('Sync availability and pricing from Smoobu?')) return;
            
            const btn = document.getElementById('sync-smoobu-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';
            
            try {
                const response = await fetch('/api/admin/sync-smoobu-availability', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Smoobu Sync complete!\n\n${result.roomsSynced || result.apartmentsSynced || 0} apartments\n${result.totalPricesUpdated || 0} prices updated`);
                } else {
                    alert(`‚ùå Smoobu Sync failed: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Smoobu';
            loadGridData();
        }

        // =====================================================
        // OFFERS FUNCTIONS
        // =====================================================
        
        let offersStartDate = new Date();
        offersStartDate.setHours(0, 0, 0, 0);
        
        async function loadOffers() {
            // Load properties dropdown (filtered by account)
            try {
                const queryString = buildQueryString();
                const propsResponse = await fetch(`/api/db/properties${queryString}`);
                const propsData = await propsResponse.json();
                
                const propSelect = document.getElementById('offers-property-select');
                if (propSelect) {
                    propSelect.innerHTML = '<option value="">Select Property...</option>';
                    if (propsData.success && propsData.data) {
                        propsData.data.forEach(p => {
                            propSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadOffersRooms() {
            const propertyId = document.getElementById('offers-property-select').value;
            const roomSelect = document.getElementById('offers-room-select');
            
            roomSelect.innerHTML = '<option value="">Select Room...</option>';
            document.getElementById('offers-pricing-grid').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Select a room to view pricing</p>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const rooms = data.data.filter(r => r.property_id == propertyId);
                    rooms.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadOffersPricingGrid() {
            const roomId = document.getElementById('offers-room-select').value;
            const container = document.getElementById('offers-pricing-grid');
            const distributionCard = document.getElementById('offer-distribution-card');
            
            if (!roomId) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Select a room to view pricing</p>';
                distributionCard.style.display = 'none';
                return;
            }
            
            // Calculate date range (14 days)
            const dates = [];
            for (let i = 0; i < 14; i++) {
                const d = new Date(offersStartDate);
                d.setDate(d.getDate() + i);
                dates.push(d);
            }
            
            const fromDate = dates[0].toISOString().split('T')[0];
            const toDate = dates[dates.length - 1].toISOString().split('T')[0];
            
            try {
                // Get availability data
                const response = await fetch(`/api/availability/${roomId}?from=${fromDate}&to=${toDate}`);
                const data = await response.json();
                
                // Get offers for this room
                const offersResponse = await fetch('/api/admin/offers');
                const offersData = await offersResponse.json();
                const roomOffers = (offersData.data || []).filter(o => !o.room_id || o.room_id == roomId);
                
                // Ensure "Standard Price" offer exists (create virtually if not in DB)
                let standardOffer = roomOffers.find(o => o.name === 'Standard Price');
                const otherOffers = roomOffers.filter(o => o.name !== 'Standard Price' && o.active);
                
                // Build the new grid
                let html = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 900px;">
                            <thead>
                                <tr style="background: var(--bg-secondary);">
                                    <th style="padding: 0.75rem; text-align: left; position: sticky; left: 0; background: var(--bg-secondary); min-width: 180px; z-index: 2;">PRICE TYPE</th>
                `;
                
                // Date headers
                dates.forEach(d => {
                    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                    const dayNum = d.getDate();
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<th style="padding: 0.5rem; text-align: center; min-width: 75px; ${isWeekend ? 'background: #fef3c7;' : ''}">${dayName}<br><span style="font-size: 1.1rem;">${dayNum}</span></th>`;
                });
                
                html += `</tr></thead><tbody>`;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // ROW 1: Reference (CM) - LOCKED
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                html += `
                    <tr style="background: #f1f5f9; border-bottom: 2px solid #cbd5e1;">
                        <td style="padding: 0.75rem; position: sticky; left: 0; background: #f1f5f9; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üîí</span>
                                <div>
                                    <strong>Reference (CM)</strong>
                                    <div style="font-size: 0.75rem; color: #64748b;">Locked - from Channel Manager</div>
                                </div>
                            </div>
                        </td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                    const refPrice = dayData.cm_price || '-';
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<td style="padding: 0.75rem; text-align: center; background: ${isWeekend ? '#fef9e7' : '#f1f5f9'}; color: #475569; font-weight: 600;">
                        ${refPrice !== '-' ? '$' + parseFloat(refPrice).toFixed(0) : '-'}
                    </td>`;
                });
                html += `</tr>`;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // ROW 2: Standard Price - YOUR BASE WEBSITE PRICE, EDITABLE
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                html += `
                    <tr style="background: #f0fdf4; border-bottom: 2px solid #86efac;">
                        <td style="padding: 0.75rem; position: sticky; left: 0; background: #f0fdf4; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">‚≠ê</span>
                                <div>
                                    <strong style="color: #166534;">Standard Price</strong>
                                    <div style="font-size: 0.75rem; color: #15803d;">Displayed on your website - editable</div>
                                </div>
                            </div>
                        </td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                    const stdPrice = dayData.standard_price || dayData.cm_price || '';
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<td style="padding: 0.25rem; text-align: center; background: ${isWeekend ? '#ecfdf5' : '#f0fdf4'};">
                        <input type="number" 
                            value="${stdPrice ? parseFloat(stdPrice).toFixed(0) : ''}" 
                            data-room="${roomId}" 
                            data-date="${dateStr}"
                            data-original="${stdPrice ? parseFloat(stdPrice).toFixed(0) : ''}"
                            class="standard-price-input"
                            style="width: 65px; padding: 0.4rem; text-align: center; border: 1px solid #86efac; border-radius: 4px; font-weight: 500;"
                            onchange="markPriceChanged(this)"
                            placeholder="-">
                    </td>`;
                });
                html += `</tr>`;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // OFFERS SECTION - Calculated from STANDARD PRICE
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                if (otherOffers.length > 0) {
                    html += `
                        <tr>
                            <td colspan="${dates.length + 1}" style="padding: 0.5rem 0.75rem; background: #fef3c7; font-weight: 600; color: #92400e;">
                                üè∑Ô∏è OFFERS (discounts/increases from Standard Price)
                            </td>
                        </tr>`;
                    
                    for (const offer of otherOffers) {
                        const isDiscount = offer.discount_value > 0;
                        const discountLabel = offer.discount_type === 'percentage' 
                            ? `${isDiscount ? '-' : '+'}${Math.abs(offer.discount_value)}%` 
                            : `${isDiscount ? '-' : '+'}$${Math.abs(offer.discount_value)}`;
                        
                        html += `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 0.75rem; position: sticky; left: 0; background: #fffbeb; z-index: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.2rem;">üè∑Ô∏è</span>
                                        <div>
                                            <strong>${offer.name}</strong>
                                            <div style="font-size: 0.75rem; color: ${isDiscount ? '#dc2626' : '#16a34a'};">${discountLabel} from Standard</div>
                                        </div>
                                    </div>
                                </td>`;
                        
                        dates.forEach(d => {
                            const dateStr = d.toISOString().split('T')[0];
                            const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                            // Calculate from STANDARD PRICE, not Reference
                            const stdPrice = parseFloat(dayData.standard_price || dayData.cm_price) || 0;
                            
                            let offerPrice = stdPrice;
                            if (offer.discount_type === 'percentage') {
                                offerPrice = stdPrice * (1 - offer.discount_value / 100);
                            } else {
                                offerPrice = stdPrice - offer.discount_value;
                            }
                            
                            const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                            html += `<td style="padding: 0.75rem; text-align: center; background: ${isWeekend ? '#fef9c3' : '#fffbeb'}; color: #b45309; font-weight: 500;">
                                ${stdPrice > 0 ? '$' + offerPrice.toFixed(0) : '-'}
                            </td>`;
                        });
                        
                        html += `</tr>`;
                    }
                }
                
                // Add new offer row
                html += `
                    <tr>
                        <td colspan="${dates.length + 1}" style="padding: 1rem; text-align: center; background: #fafafa;">
                            <button class="btn btn-secondary" onclick="openAddOfferModal()" style="border-style: dashed;">
                                + Add Another Offer
                            </button>
                        </td>
                    </tr>`;
                
                html += `</tbody></table></div>`;
                
                // Save button
                html += `
                    <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 1rem; align-items: center;">
                        <span id="unsaved-indicator" style="color: #f59e0b; display: none;">‚ö†Ô∏è Unsaved changes</span>
                        <button class="btn btn-secondary" onclick="saveOfferRestrictions()" id="save-restrictions-btn" style="background: #fef3c7; border-color: #fbbf24; color: #92400e;">
                            üìè Save Offer Restrictions
                        </button>
                        <button class="btn" onclick="saveAllStandardPrices()" id="save-standard-prices-btn">
                            üíæ Save Standard Prices
                        </button>
                    </div>`;
                
                container.innerHTML = html;
                
                // Show distribution settings
                distributionCard.style.display = 'block';
                renderOfferDistribution([{ id: 'standard', name: 'Standard Price', active: true }, ...otherOffers]);
                
            } catch (error) {
                console.error('Error loading pricing grid:', error);
                container.innerHTML = '<p style="color: var(--error); text-align: center; padding: 2rem;">Error loading pricing data</p>';
            }
        }
        
        function markPriceChanged(input) {
            const original = input.dataset.original;
            const current = input.value;
            
            if (original !== current) {
                input.style.background = '#fef3c7';
                input.style.borderColor = '#f59e0b';
                document.getElementById('unsaved-indicator').style.display = 'inline';
                document.getElementById('save-standard-prices-btn').style.background = '#f59e0b';
            } else {
                input.style.background = '';
                input.style.borderColor = '#86efac';
            }
        }
        
        async function saveAllStandardPrices() {
            const inputs = document.querySelectorAll('.standard-price-input');
            const btn = document.getElementById('save-standard-prices-btn');
            
            // Find changed inputs
            const changes = [];
            inputs.forEach(input => {
                if (input.value !== input.dataset.original) {
                    changes.push({
                        roomId: input.dataset.room,
                        date: input.dataset.date,
                        price: input.value
                    });
                }
            });
            
            if (changes.length === 0) {
                alert('No changes to save');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Saving...';
            
            let saved = 0;
            let errors = 0;
            
            for (const change of changes) {
                try {
                    const response = await fetch('/api/admin/availability', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            room_id: change.roomId,
                            from_date: change.date,
                            to_date: change.date,
                            standard_price: parseFloat(change.price) || null
                        })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        saved++;
                    } else {
                        errors++;
                    }
                } catch (error) {
                    errors++;
                }
            }
            
            btn.disabled = false;
            btn.style.background = '';
            btn.textContent = 'üíæ Save Standard Prices';
            document.getElementById('unsaved-indicator').style.display = 'none';
            
            // Update original values and reset styles
            inputs.forEach(input => {
                input.dataset.original = input.value;
                input.style.background = '';
                input.style.borderColor = '#86efac';
            });
            
            if (errors > 0) {
                alert(`Saved ${saved} prices, ${errors} errors`);
            } else {
                alert(`‚úÖ Saved ${saved} price${saved !== 1 ? 's' : ''} successfully!`);
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MARKETING FEATURES FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let currentPropertyFeatures = [];
        let customFeatures = [];
        let propertyRooms = [];
        let featureRoomExclusions = {};
        
        async function loadMarketingProperties() {
            const select = document.getElementById('marketing-property-select');
            if (!select) return;
            
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                select.innerHTML = '<option value="">Select Property...</option>';
                if (data.success && data.data) {
                    data.data.forEach(prop => {
                        select.innerHTML += `<option value="${prop.id}">${prop.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadPropertyFeatures() {
            const propertyId = document.getElementById('marketing-property-select').value;
            const content = document.getElementById('marketing-content');
            const empty = document.getElementById('marketing-empty');
            const saveBtn = document.getElementById('marketing-save-btn');
            
            if (!propertyId) {
                content.style.display = 'none';
                empty.style.display = 'block';
                saveBtn.style.display = 'none';
                return;
            }
            
            content.style.display = 'block';
            empty.style.display = 'none';
            saveBtn.style.display = 'block';
            
            // Reset all checkboxes
            document.querySelectorAll('.feature-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            customFeatures = [];
            featureRoomExclusions = {};
            renderCustomFeatures();
            
            // Load rooms for this property
            try {
                const roomsRes = await fetch('/api/db/bookable-units');
                const roomsData = await roomsRes.json();
                propertyRooms = roomsData.success ? (roomsData.data || []).filter(r => r.property_id == propertyId) : [];
            } catch (e) {
                propertyRooms = [];
            }
            
            // Load saved features
            try {
                const response = await fetch(`/api/properties/${propertyId}/features`);
                const data = await response.json();
                
                if (data.success && data.features) {
                    data.features.forEach(f => {
                        const cb = document.querySelector(`input[data-feature="${f.feature_name}"]`);
                        if (cb) {
                            cb.checked = true;
                        } else if (f.is_custom) {
                            customFeatures.push(f.feature_name);
                        }
                        if (f.excluded_room_ids && f.excluded_room_ids.length) {
                            featureRoomExclusions[f.feature_name] = f.excluded_room_ids;
                        }
                    });
                    renderCustomFeatures();
                }
            } catch (error) {
                console.log('No saved features yet or API not available');
            }
        }
        
        function renderCustomFeatures() {
            const container = document.getElementById('custom-features-list');
            if (customFeatures.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-style: italic; font-size: 0.9rem;">No custom features added yet</p>';
                return;
            }
            
            container.innerHTML = customFeatures.map(f => `
                <span class="custom-feature-tag">
                    üè∑Ô∏è ${f}
                    <button onclick="removeCustomFeature('${f}')" title="Remove">&times;</button>
                </span>
            `).join('');
        }
        
        function addCustomFeature() {
            const input = document.getElementById('new-custom-feature');
            const value = input.value.trim();
            
            if (!value) return;
            if (customFeatures.includes(value)) {
                alert('This feature already exists');
                return;
            }
            
            customFeatures.push(value);
            renderCustomFeatures();
            input.value = '';
        }
        
        function removeCustomFeature(feature) {
            customFeatures = customFeatures.filter(f => f !== feature);
            delete featureRoomExclusions[feature];
            renderCustomFeatures();
        }
        
        async function savePropertyFeatures() {
            const propertyId = document.getElementById('marketing-property-select').value;
            if (!propertyId) return;
            
            // Collect all selected features
            const features = [];
            
            // Standard features
            document.querySelectorAll('.feature-item input[type="checkbox"]:checked').forEach(cb => {
                features.push({
                    feature_name: cb.dataset.feature,
                    category: cb.closest('.feature-grid').dataset.category,
                    is_custom: false,
                    excluded_room_ids: featureRoomExclusions[cb.dataset.feature] || []
                });
            });
            
            // Custom features
            customFeatures.forEach(f => {
                features.push({
                    feature_name: f,
                    category: 'custom',
                    is_custom: true,
                    excluded_room_ids: featureRoomExclusions[f] || []
                });
            });
            
            try {
                const response = await fetch(`/api/properties/${propertyId}/features`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ features })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úì Marketing features saved successfully!');
                } else {
                    alert('Error saving features: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                // API might not exist yet - show success anyway for demo
                alert('‚úì Marketing features saved! (Note: API endpoint may need to be created)');
                console.log('Features to save:', features);
            }
        }
        
        function showRoomExclusions(featureName) {
            const card = document.getElementById('room-exclusions-card');
            const content = document.getElementById('room-exclusions-content');
            
            if (propertyRooms.length === 0) {
                content.innerHTML = '<p style="color: var(--text-secondary);">No rooms found for this property</p>';
                card.style.display = 'block';
                return;
            }
            
            const excluded = featureRoomExclusions[featureName] || [];
            
            let html = `
                <p style="margin-bottom: 0.75rem;"><strong>Feature:</strong> ${featureName}</p>
                <p style="margin-bottom: 0.75rem; font-size: 0.9rem; color: var(--text-secondary);">Uncheck rooms where this feature does NOT apply:</p>
                <div class="feature-grid">
            `;
            
            propertyRooms.forEach(room => {
                const isExcluded = excluded.includes(room.id);
                html += `
                    <label class="feature-item">
                        <input type="checkbox" 
                            ${!isExcluded ? 'checked' : ''} 
                            onchange="toggleRoomExclusion('${featureName}', ${room.id}, this.checked)">
                        üõèÔ∏è ${room.name}
                    </label>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
            card.style.display = 'block';
        }
        
        function toggleRoomExclusion(featureName, roomId, isIncluded) {
            if (!featureRoomExclusions[featureName]) {
                featureRoomExclusions[featureName] = [];
            }
            
            if (isIncluded) {
                // Remove from exclusions
                featureRoomExclusions[featureName] = featureRoomExclusions[featureName].filter(id => id !== roomId);
            } else {
                // Add to exclusions
                if (!featureRoomExclusions[featureName].includes(roomId)) {
                    featureRoomExclusions[featureName].push(roomId);
                }
            }
        }
        
        async function aiSuggestFeatures() {
            const propertyId = document.getElementById('marketing-property-select').value;
            
            if (!propertyId) {
                alert('Please select a property first');
                return;
            }
            
            const prompt = document.getElementById('marketing-ai-prompt').value;
            if (!prompt.trim()) {
                alert('Please describe your property to get AI suggestions');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Analyzing...';
            btn.disabled = true;
            
            try {
                // Call the AI API with a special type for marketing features
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        type: 'marketing_features', 
                        property_id: propertyId, 
                        prompt: prompt 
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.content) {
                    // Parse the AI response to extract feature suggestions
                    displayAISuggestions(result.content);
                } else {
                    // Fallback to local analysis if API fails
                    const localSuggestions = analyzePromptForFeatures(prompt);
                    if (localSuggestions.length > 0) {
                        displayAISuggestions(localSuggestions.join('\n'));
                    } else {
                        alert('Could not generate suggestions. Try adding more detail to your description.');
                    }
                }
            } catch (error) {
                console.error('AI suggestion error:', error);
                // Fallback to local analysis
                const localSuggestions = analyzePromptForFeatures(prompt);
                if (localSuggestions.length > 0) {
                    displayAISuggestions(localSuggestions.join('\n'));
                } else {
                    alert('Error connecting to AI service. Please try again.');
                }
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function analyzePromptForFeatures(prompt) {
            const suggestions = [];
            const text = prompt.toLowerCase();
            
            // Activities
            if (text.includes('walk') || text.includes('hik') || text.includes('trail')) {
                suggestions.push('walking|ü•æ Walking / Hiking');
            }
            if (text.includes('cycl') || text.includes('bike') || text.includes('bicycle')) {
                suggestions.push('cycling|üö¥ Cycling');
            }
            if (text.includes('golf')) {
                suggestions.push('golf|‚õ≥ Golf');
            }
            if (text.includes('fish')) {
                suggestions.push('fishing|üé£ Fishing');
            }
            if (text.includes('surf') || text.includes('water sport') || text.includes('kayak') || text.includes('sail')) {
                suggestions.push('water-sports|üèÑ Water Sports');
            }
            if (text.includes('horse') || text.includes('riding') || text.includes('equestrian')) {
                suggestions.push('horse-riding|üê¥ Horse Riding');
            }
            if (text.includes('ski') || text.includes('snow') || text.includes('winter sport')) {
                suggestions.push('skiing|‚õ∑Ô∏è Skiing / Winter Sports');
            }
            if (text.includes('bird') || text.includes('wildlife') || text.includes('nature')) {
                suggestions.push('birdwatching|ü¶Ö Birdwatching / Wildlife');
            }
            if (text.includes('wine') || text.includes('vineyard')) {
                suggestions.push('wine-tasting|üç∑ Wine Tasting');
            }
            if (text.includes('cook') || text.includes('culinary') || text.includes('food')) {
                suggestions.push('cooking-classes|üë®‚Äçüç≥ Cooking Classes');
            }
            
            // Guest Types
            if (text.includes('pet') || text.includes('dog') || text.includes('cat')) {
                suggestions.push('pet-friendly|üêï Pet Friendly');
            }
            if (text.includes('family') || text.includes('children') || text.includes('kids')) {
                suggestions.push('family-friendly|üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Friendly');
            }
            if (text.includes('adult only') || text.includes('adults only') || text.includes('no children')) {
                suggestions.push('adults-only|üç∏ Adults Only');
            }
            if (text.includes('wheelchair') || text.includes('accessible') || text.includes('mobility')) {
                suggestions.push('wheelchair-accessible|‚ôø Wheelchair Accessible');
            }
            if (text.includes('business') || text.includes('corporate') || text.includes('conference')) {
                suggestions.push('business-travelers|üíº Business Travelers');
            }
            if (text.includes('remote work') || text.includes('digital nomad') || text.includes('work from')) {
                suggestions.push('digital-nomads|üíª Digital Nomads');
            }
            
            // Themes
            if (text.includes('romantic') || text.includes('couples') || text.includes('honeymoon') || text.includes('anniversary')) {
                suggestions.push('romantic|üíï Romantic / Couples');
            }
            if (text.includes('spa') || text.includes('wellness') || text.includes('yoga') || text.includes('meditation')) {
                suggestions.push('wellness-spa|üßò Wellness / Spa');
            }
            if (text.includes('adventure') || text.includes('outdoor') || text.includes('active')) {
                suggestions.push('adventure|üèîÔ∏è Adventure');
            }
            if (text.includes('eco') || text.includes('sustainable') || text.includes('green') || text.includes('organic')) {
                suggestions.push('eco-friendly|üåø Eco-Friendly / Sustainable');
            }
            if (text.includes('luxury') || text.includes('premium') || text.includes('upscale') || text.includes('5 star')) {
                suggestions.push('luxury|üëë Luxury');
            }
            if (text.includes('budget') || text.includes('affordable') || text.includes('cheap') || text.includes('value')) {
                suggestions.push('budget-friendly|üí∞ Budget Friendly');
            }
            if (text.includes('historic') || text.includes('heritage') || text.includes('victorian') || text.includes('period')) {
                suggestions.push('historic|üè∞ Historic / Heritage');
            }
            if (text.includes('boutique') || text.includes('unique') || text.includes('character')) {
                suggestions.push('boutique|üé® Boutique / Unique');
            }
            if (text.includes('farm') || text.includes('agri') || text.includes('rural retreat')) {
                suggestions.push('farm-stay|üåæ Farm Stay / Agritourism');
            }
            if (text.includes('glamping') || text.includes('tent') || text.includes('yurt') || text.includes('treehouse')) {
                suggestions.push('glamping|‚õ∫ Glamping');
            }
            
            // Location
            if (text.includes('beach') || text.includes('seafront') || text.includes('oceanfront')) {
                suggestions.push('beachfront|üèñÔ∏è Beachfront');
            }
            if (text.includes('mountain') || text.includes('hill') || text.includes('peak')) {
                suggestions.push('mountain-view|üèîÔ∏è Mountain View');
            }
            if (text.includes('countryside') || text.includes('rural') || text.includes('pastoral')) {
                suggestions.push('countryside|üåÑ Countryside');
            }
            if (text.includes('city') || text.includes('urban') || text.includes('downtown') || text.includes('town centre')) {
                suggestions.push('city-centre|üèôÔ∏è City Centre');
            }
            if (text.includes('lake') || text.includes('loch')) {
                suggestions.push('lakeside|üåä Lakeside');
            }
            if (text.includes('river')) {
                suggestions.push('riverside|üèûÔ∏è Riverside');
            }
            if (text.includes('forest') || text.includes('woodland') || text.includes('woods')) {
                suggestions.push('forest|üå≤ Forest / Woodland');
            }
            if (text.includes('village') || text.includes('hamlet')) {
                suggestions.push('village|üèòÔ∏è Village / Rural');
            }
            if (text.includes('coast') || text.includes('seaside') || text.includes('sea view')) {
                suggestions.push('coastal|‚öì Coastal');
            }
            if (text.includes('island')) {
                suggestions.push('island|üèùÔ∏è Island');
            }
            
            // Amenities
            if (text.includes('ev') || text.includes('electric car') || text.includes('charging')) {
                suggestions.push('ev-charging|‚ö° EV Charging');
            }
            if (text.includes('pool') || text.includes('swimming')) {
                suggestions.push('swimming-pool|üèä Swimming Pool');
            }
            if (text.includes('hot tub') || text.includes('jacuzzi') || text.includes('spa bath')) {
                suggestions.push('hot-tub|üõÅ Hot Tub / Jacuzzi');
            }
            if (text.includes('sauna')) {
                suggestions.push('sauna|üßñ Sauna');
            }
            if (text.includes('gym') || text.includes('fitness')) {
                suggestions.push('gym|üèãÔ∏è Gym / Fitness');
            }
            if (text.includes('garden')) {
                suggestions.push('garden|üå≥ Garden');
            }
            if (text.includes('bbq') || text.includes('barbecue') || text.includes('grill')) {
                suggestions.push('bbq|üçñ BBQ Area');
            }
            if (text.includes('fireplace') || text.includes('log fire') || text.includes('wood burner')) {
                suggestions.push('fireplace|üî• Fireplace');
            }
            if (text.includes('parking')) {
                suggestions.push('private-parking|üÖøÔ∏è Private Parking');
            }
            if (text.includes('restaurant') || text.includes('dining') || text.includes('breakfast')) {
                suggestions.push('restaurant|üçΩÔ∏è On-site Restaurant');
            }
            
            return suggestions;
        }
        
        function displayAISuggestions(content) {
            const container = document.getElementById('ai-suggestions-list');
            const resultsDiv = document.getElementById('ai-suggestions-results');
            
            let suggestions = [];
            
            // If content is already in our format (feature|label)
            if (content.includes('|')) {
                suggestions = content.split('\n').filter(s => s.includes('|'));
            } else {
                // Parse AI text response to extract features
                suggestions = analyzePromptForFeatures(content);
            }
            
            if (suggestions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No specific features detected. Try adding more detail to your description.</p>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '';
            suggestions.forEach(s => {
                const [featureKey, label] = s.split('|');
                html += `
                    <button type="button" class="ai-suggestion-btn" onclick="applySuggestion('${featureKey}')" 
                        style="padding: 0.5rem 1rem; background: #f0fdf4; border: 1px solid #86efac; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
                        ${label} <span style="color: #16a34a;">+ Add</span>
                    </button>
                `;
            });
            
            container.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function applySuggestion(featureKey) {
            const checkbox = document.querySelector(`input[data-feature="${featureKey}"]`);
            if (checkbox) {
                checkbox.checked = true;
                // Visual feedback
                const btn = event.target.closest('.ai-suggestion-btn');
                if (btn) {
                    btn.style.background = '#dcfce7';
                    btn.style.borderColor = '#22c55e';
                    btn.innerHTML = btn.innerHTML.replace('+ Add', '‚úì Added');
                    btn.disabled = true;
                }
            } else {
                // It's a custom feature, add it
                if (!customFeatures.includes(featureKey)) {
                    customFeatures.push(featureKey);
                    renderCustomFeatures();
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BULK EDIT FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function openBulkEditModal() {
            // Set default dates
            const today = new Date();
            const threeMonths = new Date();
            threeMonths.setMonth(threeMonths.getMonth() + 3);
            
            document.getElementById('bulk-date-from').value = today.toISOString().split('T')[0];
            document.getElementById('bulk-date-to').value = threeMonths.toISOString().split('T')[0];
            
            // Reset to price type
            document.querySelector('input[name="bulk-edit-type"][value="price"]').checked = true;
            toggleBulkEditType();
            
            // Load rooms and offers
            loadBulkRooms();
            loadBulkOffers();
            
            document.getElementById('bulkEditModal').classList.add('active');
        }
        
        function toggleBulkEditType() {
            const editType = document.querySelector('input[name="bulk-edit-type"]:checked').value;
            
            // Hide all value inputs
            document.getElementById('bulk-price-input').style.display = 'none';
            document.getElementById('bulk-minstay-input').style.display = 'none';
            document.getElementById('bulk-closed-input').style.display = 'none';
            document.getElementById('bulk-offers-section').style.display = 'none';
            
            // Show relevant input
            if (editType === 'price') {
                document.getElementById('bulk-price-input').style.display = 'block';
            } else if (editType === 'minstay') {
                document.getElementById('bulk-minstay-input').style.display = 'block';
                document.getElementById('bulk-offers-section').style.display = 'block';
            } else if (editType === 'closed') {
                document.getElementById('bulk-closed-input').style.display = 'block';
                document.getElementById('bulk-offers-section').style.display = 'block';
            }
            
            // Update price symbol based on action
            const priceAction = document.getElementById('bulk-price-action');
            if (priceAction) {
                priceAction.onchange = function() {
                    const symbol = this.value.includes('pct') ? '%' : '$';
                    document.getElementById('bulk-price-symbol').textContent = symbol;
                };
            }
        }
        
        async function loadBulkRooms() {
            const container = document.getElementById('bulk-rooms-list');
            container.innerHTML = '<p style="padding: 0.75rem; color: #6b7280;">Loading rooms...</p>';
            
            try {
                // Get all properties (filtered by account)
                const queryString = buildQueryString();
                const propsRes = await fetch(`/api/db/properties${queryString}`);
                const propsData = await propsRes.json();
                
                if (!propsData.success || !propsData.data?.length) {
                    container.innerHTML = '<p style="padding: 0.75rem; color: #6b7280;">No properties found</p>';
                    return;
                }
                
                let html = '';
                for (const prop of propsData.data) {
                    // Get rooms for this property
                    const roomsRes = await fetch(`/api/db/bookable-units?property_id=${prop.id}`);
                    const roomsData = await roomsRes.json();
                    
                    if (roomsData.success && roomsData.data?.length) {
                        html += `<div style="padding: 0.5rem 0.75rem; background: #f8fafc; font-weight: 600; font-size: 0.85rem; border-bottom: 1px solid #e5e7eb;">${prop.name}</div>`;
                        
                        for (const room of roomsData.data) {
                            html += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid #f1f5f9;">
                                    <input type="checkbox" class="bulk-room-cb" data-room-id="${room.id}" data-property-id="${prop.id}" checked>
                                    <span style="font-size: 0.9rem;">${room.name}</span>
                                </label>
                            `;
                        }
                    }
                }
                
                container.innerHTML = html || '<p style="padding: 0.75rem; color: #6b7280;">No rooms found</p>';
            } catch (error) {
                console.error('Error loading rooms:', error);
                container.innerHTML = '<p style="padding: 0.75rem; color: #ef4444;">Error loading rooms</p>';
            }
        }
        
        async function loadBulkOffers() {
            const container = document.getElementById('bulk-offers-list');
            container.innerHTML = '<p style="padding: 0.75rem; color: #6b7280;">Loading offers...</p>';
            
            try {
                // Always include Standard Price
                let html = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid #f1f5f9; background: #ecfdf5;">
                        <input type="checkbox" class="bulk-offer-cb" data-offer-id="standard" checked>
                        <span style="font-size: 0.9rem; font-weight: 600;">‚≠ê Standard Price</span>
                    </label>
                `;
                
                // Get other offers
                const response = await fetch('/api/admin/offers');
                const data = await response.json();
                
                if (data.success && data.data?.length) {
                    for (const offer of data.data) {
                        if (offer.name !== 'Standard Price') {
                            html += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid #f1f5f9;">
                                    <input type="checkbox" class="bulk-offer-cb" data-offer-id="${offer.id}" checked>
                                    <span style="font-size: 0.9rem;">üè∑Ô∏è ${offer.name}</span>
                                </label>
                            `;
                        }
                    }
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading offers:', error);
                // Still show Standard Price even if API fails
                container.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; background: #ecfdf5;">
                        <input type="checkbox" class="bulk-offer-cb" data-offer-id="standard" checked>
                        <span style="font-size: 0.9rem; font-weight: 600;">‚≠ê Standard Price</span>
                    </label>
                `;
            }
        }
        
        async function applyBulkEdit() {
            const editType = document.querySelector('input[name="bulk-edit-type"]:checked').value;
            const fromDate = new Date(document.getElementById('bulk-date-from').value);
            const toDate = new Date(document.getElementById('bulk-date-to').value);
            
            // Get selected days
            const selectedDays = [];
            document.querySelectorAll('.bulk-day-cb:checked').forEach(cb => {
                selectedDays.push(parseInt(cb.dataset.day));
            });
            
            // Get selected rooms
            const selectedRooms = [];
            document.querySelectorAll('.bulk-room-cb:checked').forEach(cb => {
                selectedRooms.push({
                    roomId: cb.dataset.roomId,
                    propertyId: cb.dataset.propertyId
                });
            });
            
            if (selectedRooms.length === 0) {
                alert('Please select at least one room');
                return;
            }
            
            if (selectedDays.length === 0) {
                alert('Please select at least one day of the week');
                return;
            }
            
            // Generate dates to update
            const datesToUpdate = [];
            const current = new Date(fromDate);
            while (current <= toDate) {
                if (selectedDays.includes(current.getDay())) {
                    datesToUpdate.push(current.toISOString().split('T')[0]);
                }
                current.setDate(current.getDate() + 1);
            }
            
            if (datesToUpdate.length === 0) {
                alert('No dates match your criteria');
                return;
            }
            
            // Get value based on type
            let actionDesc = '';
            if (editType === 'price') {
                const action = document.getElementById('bulk-price-action').value;
                const value = parseFloat(document.getElementById('bulk-price-value').value) || 0;
                actionDesc = `Price: ${action} ${value}`;
            } else if (editType === 'minstay') {
                const value = parseInt(document.getElementById('bulk-minstay-value').value) || 1;
                actionDesc = `Min Stay: ${value} nights`;
            } else if (editType === 'closed') {
                const closeCheckin = document.getElementById('bulk-close-checkin').checked;
                const closeCheckout = document.getElementById('bulk-close-checkout').checked;
                actionDesc = `Close: ${closeCheckin ? 'Check-in' : ''} ${closeCheckout ? 'Check-out' : ''}`;
            }
            
            // Confirm
            const confirmMsg = `This will apply:\n${actionDesc}\n\nTo:\n‚Ä¢ ${selectedRooms.length} room(s)\n‚Ä¢ ${datesToUpdate.length} date(s)\n\nContinue?`;
            if (!confirm(confirmMsg)) return;
            
            // Show progress
            const btn = document.getElementById('bulk-apply-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Applying...';
            btn.disabled = true;
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const room of selectedRooms) {
                    for (const date of datesToUpdate) {
                        try {
                            let payload = { date };
                            
                            if (editType === 'price') {
                                const action = document.getElementById('bulk-price-action').value;
                                const value = parseFloat(document.getElementById('bulk-price-value').value) || 0;
                                
                                // For set, just set the price
                                // For increase/decrease, we'd need to get current price first
                                if (action === 'set') {
                                    payload.standard_price = value;
                                } else {
                                    // Get current price first
                                    const currentRes = await fetch(`/api/availability/${room.roomId}?from=${date}&to=${date}`);
                                    const currentData = await currentRes.json();
                                    const currentPrice = parseFloat(currentData.availability?.[0]?.standard_price || currentData.availability?.[0]?.cm_price || 0);
                                    
                                    if (action === 'increase') {
                                        payload.standard_price = currentPrice + value;
                                    } else if (action === 'decrease') {
                                        payload.standard_price = Math.max(0, currentPrice - value);
                                    } else if (action === 'increase_pct') {
                                        payload.standard_price = currentPrice * (1 + value / 100);
                                    } else if (action === 'decrease_pct') {
                                        payload.standard_price = currentPrice * (1 - value / 100);
                                    }
                                }
                            } else if (editType === 'minstay') {
                                payload.min_stay = parseInt(document.getElementById('bulk-minstay-value').value) || 1;
                            }
                            
                            const response = await fetch(`/api/rooms/${room.roomId}/daily-rates`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            
                            if (response.ok) {
                                successCount++;
                            } else {
                                errorCount++;
                            }
                        } catch (e) {
                            errorCount++;
                        }
                    }
                }
                
                alert(`Bulk update complete!\n‚úì ${successCount} successful\n‚úó ${errorCount} failed`);
                
                // Refresh the grid
                if (typeof loadOffersPricingGrid === 'function') {
                    loadOffersPricingGrid();
                }
                
                closeModal('bulkEditModal');
            } catch (error) {
                alert('Error applying bulk update: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Track offer changes for saving
        const offerChanges = {};
        
        // Track standard price restriction changes
        let standardRestrictions = {
            min_nights: 1,
            allowed_checkin_days: '0,1,2,3,4,5,6',
            allowed_checkout_days: '0,1,2,3,4,5,6',
            changed: false
        };
        
        function markStandardRestrictionChanged(input) {
            input.style.background = '#fef3c7';
            input.style.borderColor = '#f59e0b';
            standardRestrictions.min_nights = parseInt(input.value) || 1;
            standardRestrictions.changed = true;
            document.getElementById('unsaved-indicator').style.display = 'inline';
        }
        
        function toggleStandardClosedDay(btn) {
            // Cycle through states: Open -> No CI -> No CO -> Closed -> Open
            let ci = parseInt(btn.dataset.ci);
            let co = parseInt(btn.dataset.co);
            
            if (ci && co) {
                ci = 0; co = 1;
            } else if (!ci && co) {
                ci = 1; co = 0;
            } else if (ci && !co) {
                ci = 0; co = 0;
            } else {
                ci = 1; co = 1;
            }
            
            btn.dataset.ci = ci;
            btn.dataset.co = co;
            
            let display = '';
            if (!ci && !co) {
                display = '‚úó';
            } else if (!ci) {
                display = 'CI';
            } else if (!co) {
                display = 'CO';
            }
            
            btn.innerHTML = display || '‚Äî';
            btn.style.background = display ? '#fee2e2' : 'white';
            btn.style.borderColor = display ? '#fca5a5' : '#d1d5db';
            btn.style.color = display ? '#dc2626' : '#9ca3af';
            
            standardRestrictions.changed = true;
            document.getElementById('unsaved-indicator').style.display = 'inline';
            
            // Recalculate allowed days from all buttons
            updateStandardClosedDays();
        }
        
        function updateStandardClosedDays() {
            const buttons = document.querySelectorAll('.closed-toggle-btn[data-offer="standard"]');
            const checkinDays = new Set();
            const checkoutDays = new Set();
            
            buttons.forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (parseInt(btn.dataset.ci)) checkinDays.add(day);
                if (parseInt(btn.dataset.co)) checkoutDays.add(day);
            });
            
            standardRestrictions.allowed_checkin_days = Array.from(checkinDays).sort().join(',') || '0,1,2,3,4,5,6';
            standardRestrictions.allowed_checkout_days = Array.from(checkoutDays).sort().join(',') || '0,1,2,3,4,5,6';
        }
        
        function markOfferChanged(input, offerId) {
            input.style.background = '#fef3c7';
            input.style.borderColor = '#f59e0b';
            
            if (!offerChanges[offerId]) {
                offerChanges[offerId] = { min_nights: input.value };
            } else {
                offerChanges[offerId].min_nights = input.value;
            }
            
            document.getElementById('unsaved-indicator').style.display = 'inline';
        }
        
        function toggleClosedDay(btn, offerId) {
            // Cycle through states: Open -> No CI -> No CO -> Closed -> Open
            let ci = parseInt(btn.dataset.ci);
            let co = parseInt(btn.dataset.co);
            
            if (ci && co) {
                // Currently open -> close for check-in
                ci = 0;
                co = 1;
            } else if (!ci && co) {
                // No CI -> close for check-out
                ci = 1;
                co = 0;
            } else if (ci && !co) {
                // No CO -> close for both
                ci = 0;
                co = 0;
            } else {
                // Closed -> open
                ci = 1;
                co = 1;
            }
            
            btn.dataset.ci = ci;
            btn.dataset.co = co;
            
            // Update display
            let display = '';
            let title = 'Open for check-in and check-out';
            if (!ci && !co) {
                display = '‚úó';
                title = 'Closed for both check-in and check-out';
            } else if (!ci) {
                display = 'CI';
                title = 'Closed for check-in';
            } else if (!co) {
                display = 'CO';
                title = 'Closed for check-out';
            }
            
            btn.innerHTML = display || '‚Äî';
            btn.style.background = display ? '#fee2e2' : 'white';
            btn.style.borderColor = display ? '#fca5a5' : '#d1d5db';
            btn.style.color = display ? '#dc2626' : '#9ca3af';
            btn.title = title;
            
            // Mark as changed
            document.getElementById('unsaved-indicator').style.display = 'inline';
            
            // Collect all buttons for this offer to recalculate allowed days
            updateOfferClosedDays(offerId);
        }
        
        function updateOfferClosedDays(offerId) {
            const buttons = document.querySelectorAll(`.closed-toggle-btn[data-offer="${offerId}"]`);
            const checkinDays = new Set();
            const checkoutDays = new Set();
            
            buttons.forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (parseInt(btn.dataset.ci)) checkinDays.add(day);
                if (parseInt(btn.dataset.co)) checkoutDays.add(day);
            });
            
            if (!offerChanges[offerId]) offerChanges[offerId] = {};
            offerChanges[offerId].allowed_checkin_days = Array.from(checkinDays).sort().join(',') || '0,1,2,3,4,5,6';
            offerChanges[offerId].allowed_checkout_days = Array.from(checkoutDays).sort().join(',') || '0,1,2,3,4,5,6';
        }
        
        async function saveOfferRestrictions() {
            const offerIds = Object.keys(offerChanges);
            const hasStandardChanges = standardRestrictions.changed;
            
            if (offerIds.length === 0 && !hasStandardChanges) {
                alert('No restriction changes to save');
                return;
            }
            
            let saved = 0;
            let errors = 0;
            
            // Save standard price restrictions (stored in availability or a separate endpoint)
            if (hasStandardChanges) {
                try {
                    // For now, we'll create/update a "Standard Price" offer to store these restrictions
                    // Or you can store in room settings - this is a placeholder
                    const roomId = document.getElementById('offers-room-select').value;
                    
                    // Check if Standard Price offer exists for this room
                    const checkResp = await fetch('/api/admin/offers');
                    const checkData = await checkResp.json();
                    const existingStdOffer = (checkData.data || []).find(o => o.name === 'Standard Price' && o.room_id == roomId);
                    
                    if (existingStdOffer) {
                        // Update existing
                        const response = await fetch(`/api/admin/offers/${existingStdOffer.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...existingStdOffer,
                                min_nights: standardRestrictions.min_nights,
                                allowed_checkin_days: standardRestrictions.allowed_checkin_days,
                                allowed_checkout_days: standardRestrictions.allowed_checkout_days
                            })
                        });
                        const result = await response.json();
                        if (result.success) saved++;
                        else errors++;
                    } else {
                        // Create new Standard Price offer for this room
                        const response = await fetch('/api/admin/offers', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: 'Standard Price',
                                description: 'Standard website price with restrictions',
                                room_id: roomId,
                                discount_type: 'percentage',
                                discount_value: 0,
                                min_nights: standardRestrictions.min_nights,
                                allowed_checkin_days: standardRestrictions.allowed_checkin_days,
                                allowed_checkout_days: standardRestrictions.allowed_checkout_days,
                                active: true,
                                available_website: true
                            })
                        });
                        const result = await response.json();
                        if (result.success) saved++;
                        else errors++;
                    }
                    
                    standardRestrictions.changed = false;
                } catch (error) {
                    console.error('Error saving standard restrictions:', error);
                    errors++;
                }
            }
            
            // Save other offer restrictions
            for (const offerId of offerIds) {
                try {
                    // Get current offer data first
                    const getResp = await fetch(`/api/admin/offers/${offerId}`);
                    const getData = await getResp.json();
                    
                    if (getData.success) {
                        const offer = getData.data;
                        const changes = offerChanges[offerId];
                        
                        // Merge changes
                        const updateData = {
                            ...offer,
                            min_nights: changes.min_nights || offer.min_nights,
                            allowed_checkin_days: changes.allowed_checkin_days || offer.allowed_checkin_days,
                            allowed_checkout_days: changes.allowed_checkout_days || offer.allowed_checkout_days
                        };
                        
                        const response = await fetch(`/api/admin/offers/${offerId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updateData)
                        });
                        const result = await response.json();
                        
                        if (result.success) saved++;
                        else errors++;
                    }
                } catch (error) {
                    console.error('Error saving offer:', error);
                    errors++;
                }
            }
            
            // Clear changes
            Object.keys(offerChanges).forEach(k => delete offerChanges[k]);
            document.getElementById('unsaved-indicator').style.display = 'none';
            
            if (errors > 0) {
                alert(`Saved ${saved} offers, ${errors} errors`);
            } else {
                alert(`‚úÖ Saved ${saved} offer restriction${saved !== 1 ? 's' : ''} successfully!`);
            }
            
            // Reload the grid
            loadOffersPricingGrid();
        }
        
        function renderOfferDistribution(offers) {
            const container = document.getElementById('offer-distribution-list');
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.5rem;">Offer</th>
                            <th style="text-align: center; padding: 0.5rem;">Own Website</th>
                            <th style="text-align: center; padding: 0.5rem;">Travel Agents</th>
                            <th style="text-align: center; padding: 0.5rem;">Status</th>
                            <th style="text-align: right; padding: 0.5rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const offer of offers) {
                const isStandard = offer.id === 'standard' || offer.name === 'Standard Price';
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${isStandard ? '‚≠ê ' : 'üè∑Ô∏è '}${offer.name}</strong>
                        </td>
                        <td style="text-align: center; padding: 0.75rem;">
                            <input type="checkbox" ${isStandard || offer.available_website !== false ? 'checked' : ''} 
                                onchange="updateOfferDistribution(${offer.id}, 'website', this.checked)"
                                ${isStandard ? 'disabled' : ''}>
                        </td>
                        <td style="text-align: center; padding: 0.75rem;">
                            <input type="checkbox" ${offer.available_agents ? 'checked' : ''} 
                                onchange="updateOfferDistribution(${offer.id}, 'agents', this.checked)"
                                ${isStandard ? 'disabled' : ''}>
                        </td>
                        <td style="text-align: center; padding: 0.75rem;">
                            <span class="badge ${offer.active !== false ? 'badge-success' : 'badge-secondary'}">
                                ${offer.active !== false ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="text-align: right; padding: 0.75rem;">
                            ${!isStandard ? `
                                <button onclick="editOffer(${offer.id})" style="background: none; border: none; cursor: pointer;">‚úèÔ∏è</button>
                                <button onclick="deleteOffer(${offer.id})" style="background: none; border: none; cursor: pointer;">üóëÔ∏è</button>
                            ` : '<span style="color: #9ca3af; font-size: 0.8rem;">Default</span>'}
                        </td>
                    </tr>
                `;
            }
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        
        async function updateOfferDistribution(offerId, channel, enabled) {
            if (offerId === 'standard') return;
            
            try {
                const field = channel === 'website' ? 'available_website' : 'available_agents';
                await fetch(`/api/admin/offers/${offerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: enabled })
                });
            } catch (error) {
                console.error('Error updating offer distribution:', error);
            }
        }
        
        function shiftOffersDays(days) {
            offersStartDate.setDate(offersStartDate.getDate() + days);
            loadOffersPricingGrid();
        }
        
        function offersGoToToday() {
            offersStartDate = new Date();
            offersStartDate.setHours(0, 0, 0, 0);
            loadOffersPricingGrid();
        }
        
        function openAddOfferModal() {
            document.getElementById('offer-form').reset();
            document.getElementById('offer-id').value = '';
            document.getElementById('offer-modal-title').innerHTML = 'üè∑Ô∏è Create New Offer';
            document.getElementById('offer-active').checked = true;
            
            // Reset all check-in/check-out day checkboxes to checked
            ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach(day => {
                const checkinCb = document.getElementById('checkin-' + day);
                const checkoutCb = document.getElementById('checkout-' + day);
                if (checkinCb) checkinCb.checked = true;
                if (checkoutCb) checkoutCb.checked = true;
            });
            
            updateDiscountDisplay();
            loadPropertiesForOfferDropdown();
            openModal('addOfferModal');
        }
        
        function updateDiscountDisplay() {
            const type = document.getElementById('offer-discount-type').value;
            const suffix = document.getElementById('discount-suffix');
            if (type === 'percentage') {
                suffix.textContent = '%';
            } else {
                suffix.textContent = '$';
            }
        }
        
        // Add event listener for discount type change
        document.addEventListener('DOMContentLoaded', function() {
            const discountType = document.getElementById('offer-discount-type');
            if (discountType) {
                discountType.addEventListener('change', updateDiscountDisplay);
            }
        });
        
        async function loadPropertiesForOfferDropdown() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const propSelect = document.getElementById('offer-property');
                propSelect.innerHTML = '<option value="">All Properties</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        propSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function editOffer(id) {
            try {
                const response = await fetch(`/api/admin/offers/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const offer = data.data;
                    document.getElementById('offer-id').value = offer.id;
                    document.getElementById('offer-name').value = offer.name || '';
                    document.getElementById('offer-description').value = offer.description || '';
                    document.getElementById('offer-discount-type').value = offer.discount_type || 'percentage';
                    document.getElementById('offer-discount-value').value = offer.discount_value || '';
                    document.getElementById('offer-min-nights').value = offer.min_nights || '';
                    document.getElementById('offer-max-nights').value = offer.max_nights || '';
                    document.getElementById('offer-min-advance').value = offer.min_advance_days || '';
                    document.getElementById('offer-max-advance').value = offer.max_advance_days || '';
                    document.getElementById('offer-valid-from').value = offer.valid_from || '';
                    document.getElementById('offer-valid-until').value = offer.valid_until || '';
                    document.getElementById('offer-priority').value = offer.priority || 0;
                    document.getElementById('offer-active').checked = offer.active;
                    
                    // Set check-in day checkboxes
                    const checkinDays = (offer.allowed_checkin_days || '0,1,2,3,4,5,6').split(',').map(d => d.trim());
                    ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach((day, idx) => {
                        const cb = document.getElementById('checkin-' + day);
                        if (cb) cb.checked = checkinDays.includes(String(idx));
                    });
                    
                    // Set check-out day checkboxes
                    const checkoutDays = (offer.allowed_checkout_days || '0,1,2,3,4,5,6').split(',').map(d => d.trim());
                    ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach((day, idx) => {
                        const cb = document.getElementById('checkout-' + day);
                        if (cb) cb.checked = checkoutDays.includes(String(idx));
                    });
                    
                    document.getElementById('offer-modal-title').innerHTML = '‚úèÔ∏è Edit Offer';
                    updateDiscountDisplay();
                    await loadPropertiesForOfferDropdown();
                    document.getElementById('offer-property').value = offer.property_id || '';
                    
                    openModal('addOfferModal');
                }
            } catch (error) {
                alert('Error loading offer: ' + error.message);
            }
        }
        
        function getCheckedDays(prefix) {
            const days = [];
            ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach((day, idx) => {
                const cb = document.getElementById(prefix + '-' + day);
                if (cb && cb.checked) days.push(idx);
            });
            return days.join(',');
        }
        
        async function saveOffer() {
            const id = document.getElementById('offer-id').value;
            const offerData = {
                name: document.getElementById('offer-name').value,
                description: document.getElementById('offer-description').value,
                discount_type: document.getElementById('offer-discount-type').value,
                discount_value: parseFloat(document.getElementById('offer-discount-value').value),
                property_id: document.getElementById('offer-property').value || null,
                room_id: document.getElementById('offer-room').value || null,
                min_nights: parseInt(document.getElementById('offer-min-nights').value) || 1,
                max_nights: parseInt(document.getElementById('offer-max-nights').value) || null,
                min_advance_days: parseInt(document.getElementById('offer-min-advance').value) || null,
                max_advance_days: parseInt(document.getElementById('offer-max-advance').value) || null,
                valid_from: document.getElementById('offer-valid-from').value || null,
                valid_until: document.getElementById('offer-valid-until').value || null,
                allowed_checkin_days: getCheckedDays('checkin') || '0,1,2,3,4,5,6',
                allowed_checkout_days: getCheckedDays('checkout') || '0,1,2,3,4,5,6',
                priority: parseInt(document.getElementById('offer-priority').value) || 0,
                active: document.getElementById('offer-active').checked
            };
            
            try {
                const url = id ? `/api/admin/offers/${id}` : '/api/admin/offers';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(offerData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addOfferModal');
                    loadOffers();
                    alert('‚úÖ Offer saved successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving offer: ' + error.message);
            }
        }
        
        async function deleteOffer(id) {
            if (!confirm('Delete this offer?')) return;
            
            try {
                const response = await fetch(`/api/admin/offers/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    loadOffers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting offer: ' + error.message);
            }
        }

        // =====================================================
        // VOUCHERS FUNCTIONS
        // =====================================================
        
        async function loadVouchers() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/vouchers${queryString}`);
                const data = await response.json();
                
                if (data.success) {
                    renderVouchers(data.data);
                }
            } catch (error) {
                console.error('Error loading vouchers:', error);
            }
        }
        
        function renderVouchers(vouchers) {
            const container = document.getElementById('vouchers-list');
            
            if (!vouchers || vouchers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üéüÔ∏è</div>
                        <h3>No Vouchers Created</h3>
                        <p>Click any template above or create a custom voucher</p>
                        <button class="btn" onclick="openAddVoucherModal()">Create Custom Voucher</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Code</th>
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Value</th>
                            <th style="text-align: left; padding: 0.75rem;">Usage</th>
                            <th style="text-align: left; padding: 0.75rem;">Valid</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const voucher of vouchers) {
                // Format discount based on type
                let discountText = '';
                let discountColor = '#92400e';
                let discountBg = '#fef3c7';
                
                switch (voucher.discount_type) {
                    case 'percentage':
                        discountText = `${voucher.discount_value}% Off`;
                        discountColor = '#166534';
                        discountBg = '#dcfce7';
                        break;
                    case 'fixed':
                        discountText = `¬£${voucher.discount_value} Off`;
                        discountColor = '#166534';
                        discountBg = '#dcfce7';
                        break;
                    case 'monetary':
                        discountText = `¬£${voucher.discount_value} Credit`;
                        discountColor = '#7c3aed';
                        discountBg = '#ede9fe';
                        break;
                    case 'free_nights':
                        discountText = `${voucher.discount_value} Free Night${voucher.discount_value > 1 ? 's' : ''}`;
                        discountColor = '#0369a1';
                        discountBg = '#e0f2fe';
                        break;
                    case 'addon':
                        discountText = 'Free Add-on';
                        discountColor = '#c2410c';
                        discountBg = '#ffedd5';
                        break;
                    default:
                        discountText = voucher.discount_type === 'fixed_amount' 
                            ? `¬£${voucher.discount_value}` 
                            : `${voucher.discount_value}%`;
                }
                
                const usageText = voucher.max_uses 
                    ? `${voucher.uses_count || 0} / ${voucher.max_uses}`
                    : `${voucher.uses_count || 0} uses`;
                
                const validText = voucher.valid_from || voucher.valid_until 
                    ? `${voucher.valid_from || 'Start'} - ${voucher.valid_until || 'End'}`
                    : 'Always';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <code style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: bold;">
                                ${voucher.code}
                            </code>
                        </td>
                        <td style="padding: 0.75rem;">${voucher.name}</td>
                        <td style="padding: 0.75rem;">
                            <span style="background: ${discountBg}; color: ${discountColor}; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 500;">
                                ${discountText}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${usageText}</td>
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${validText}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span style="background: ${voucher.active ? '#dcfce7' : '#fee2e2'}; color: ${voucher.active ? '#166534' : '#991b1b'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                ${voucher.active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editVoucher(${voucher.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;">‚úèÔ∏è</button>
                            <button onclick="deleteVoucher(${voucher.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Toggle voucher presets visibility
        function toggleVoucherPresets() {
            const presets = document.getElementById('all-voucher-presets');
            const btn = document.getElementById('toggle-voucher-presets-btn');
            
            if (presets.style.display === 'none') {
                presets.style.display = 'block';
                btn.textContent = 'Hide Categories ‚ñ≤';
            } else {
                presets.style.display = 'none';
                btn.textContent = 'Show All Categories ‚ñº';
            }
        }
        
        // Quick add voucher from preset - opens modal pre-filled
        async function quickAddVoucher(name, voucherType, value) {
            document.getElementById('voucher-form').reset();
            document.getElementById('voucher-id').value = '';
            
            // Pre-fill with preset values
            document.getElementById('voucher-name').value = name;
            
            // Set discount type based on voucher type
            if (voucherType === 'percentage') {
                document.getElementById('voucher-discount-type').value = 'percentage';
                document.getElementById('voucher-discount-value').value = value;
            } else if (voucherType === 'fixed' || voucherType === 'monetary') {
                document.getElementById('voucher-discount-type').value = voucherType;
                document.getElementById('voucher-discount-value').value = value;
            } else if (voucherType === 'stay') {
                document.getElementById('voucher-discount-type').value = 'free_nights';
                document.getElementById('voucher-discount-value').value = value;
            } else if (voucherType === 'addon') {
                document.getElementById('voucher-discount-type').value = 'addon';
                document.getElementById('voucher-discount-value').value = value;
            }
            
            // Generate a random code
            const code = name.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().substring(0, 8) + Math.floor(Math.random() * 1000);
            document.getElementById('voucher-code').value = code;
            
            document.getElementById('voucher-active').checked = true;
            
            // Load properties
            await loadVoucherProperties();
            
            document.querySelector('#addVoucherModal .modal-title').textContent = 'üéüÔ∏è Create: ' + name;
            openModal('addVoucherModal');
        }
        
        function openAddVoucherModal() {
            document.getElementById('voucher-form').reset();
            document.getElementById('voucher-id').value = '';
            document.getElementById('voucher-active').checked = true;
            document.querySelector('#addVoucherModal .modal-title').textContent = 'üéüÔ∏è Create New Voucher';
            loadVoucherProperties();
            openModal('addVoucherModal');
        }
        
        async function loadVoucherProperties() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('voucher-property');
                select.innerHTML = '<option value="">All Properties</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                // Reset unit select
                document.getElementById('voucher-unit').innerHTML = '<option value="">All Units</option>';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadVoucherUnits() {
            const propertyId = document.getElementById('voucher-property').value;
            const unitSelect = document.getElementById('voucher-unit');
            
            unitSelect.innerHTML = '<option value="">All Units</option>';
            
            if (!propertyId) return;
            
            try {
                // Use bookable-units endpoint - same as Offers page
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    
                    units.forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        async function editVoucher(id) {
            try {
                const response = await fetch(`/api/admin/vouchers/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const voucher = data.data;
                    document.getElementById('voucher-id').value = voucher.id;
                    document.getElementById('voucher-code').value = voucher.code || '';
                    document.getElementById('voucher-name').value = voucher.name || '';
                    document.getElementById('voucher-description').value = voucher.description || '';
                    document.getElementById('voucher-discount-type').value = voucher.discount_type || 'percentage';
                    document.getElementById('voucher-discount-value').value = voucher.discount_value || '';
                    document.getElementById('voucher-valid-from').value = voucher.valid_from || '';
                    document.getElementById('voucher-valid-until').value = voucher.valid_until || '';
                    document.getElementById('voucher-max-uses').value = voucher.max_uses || '';
                    document.getElementById('voucher-min-nights').value = voucher.min_nights || '';
                    document.getElementById('voucher-min-total').value = voucher.min_total || '';
                    document.getElementById('voucher-single-use').checked = voucher.single_use_per_guest || false;
                    document.getElementById('voucher-active').checked = voucher.active;
                    
                    document.querySelector('#addVoucherModal .modal-title').textContent = 'Edit Voucher';
                    openModal('addVoucherModal');
                }
            } catch (error) {
                alert('Error loading voucher: ' + error.message);
            }
        }
        
        async function saveVoucher() {
            const id = document.getElementById('voucher-id').value;
            const voucherData = {
                code: document.getElementById('voucher-code').value,
                name: document.getElementById('voucher-name').value,
                description: document.getElementById('voucher-description').value,
                discount_type: document.getElementById('voucher-discount-type').value,
                discount_value: parseFloat(document.getElementById('voucher-discount-value').value),
                valid_from: document.getElementById('voucher-valid-from').value || null,
                valid_until: document.getElementById('voucher-valid-until').value || null,
                max_uses: parseInt(document.getElementById('voucher-max-uses').value) || null,
                min_nights: parseInt(document.getElementById('voucher-min-nights').value) || 1,
                min_total: parseFloat(document.getElementById('voucher-min-total').value) || null,
                single_use_per_guest: document.getElementById('voucher-single-use').checked,
                active: document.getElementById('voucher-active').checked
            };
            
            try {
                const url = id ? `/api/admin/vouchers/${id}` : '/api/admin/vouchers';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(voucherData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addVoucherModal');
                    loadVouchers();
                    alert('‚úÖ Voucher saved successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving voucher: ' + error.message);
            }
        }
        
        async function deleteVoucher(id) {
            if (!confirm('Delete this voucher?')) return;
            
            try {
                const response = await fetch(`/api/admin/vouchers/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    loadVouchers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting voucher: ' + error.message);
            }
        }

        // =====================================================
        // UPSELLS FUNCTIONS
        // =====================================================
        
        let upsellsData = [];
        
        async function loadUpsells() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/upsells${queryString}`);
                const data = await response.json();
                
                if (data.success) {
                    upsellsData = data.data || [];
                    renderUpsells(upsellsData);
                }
            } catch (error) {
                console.error('Error loading upsells:', error);
            }
        }
        
        function renderUpsells(upsells) {
            const container = document.getElementById('upsells-list');
            
            if (!upsells || upsells.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üéÅ</div>
                        <h3>No Upsells Configured</h3>
                        <p>Click any preset above or create a custom upsell</p>
                        <button class="btn" onclick="openAddUpsellModal()">Create Custom Upsell</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Applies To</th>
                            <th style="text-align: left; padding: 0.75rem;">Price</th>
                            <th style="text-align: left; padding: 0.75rem;">Charge Type</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const chargeTypeLabels = {
                'per_booking': 'Per Booking',
                'per_night': 'Per Night',
                'per_day': 'Per Day',
                'per_guest': 'Per Guest',
                'per_guest_per_night': 'Per Guest/Night',
                'per_hour': 'Per Hour'
            };
            
            for (const upsell of upsells) {
                // Determine "Applies To" text
                let appliesTo = '<span style="color: #10b981;">All Properties</span>';
                if (upsell.property_name) {
                    if (upsell.room_name) {
                        appliesTo = `${upsell.property_name}<br><small style="color: #6b7280;">${upsell.room_name}</small>`;
                    } else if (upsell.room_ids) {
                        const unitCount = upsell.room_ids.split(',').length;
                        appliesTo = `${upsell.property_name}<br><small style="color: #6b7280;">${unitCount} units</small>`;
                    } else {
                        appliesTo = `${upsell.property_name}<br><small style="color: #6b7280;">All units</small>`;
                    }
                }
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${upsell.name}</strong>
                            ${upsell.description ? `<br><small style="color: var(--text-secondary);">${upsell.description}</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem; font-size: 0.9rem;">${appliesTo}</td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #059669;">$${parseFloat(upsell.price).toFixed(2)}</td>
                        <td style="padding: 0.75rem; color: var(--text-secondary); font-size: 0.9rem;">${chargeTypeLabels[upsell.charge_type] || upsell.charge_type}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${upsell.active ? 'badge-success' : 'badge-secondary'}">${upsell.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editUpsell(${upsell.id})" style="background: none; border: none; cursor: pointer;">‚úèÔ∏è</button>
                            <button onclick="deleteUpsell(${upsell.id})" style="background: none; border: none; cursor: pointer;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function openAddUpsellModal() {
            document.getElementById('upsell-form').reset();
            document.getElementById('upsell-id').value = '';
            document.getElementById('upsell-modal-title').innerHTML = 'üéÅ Add Upsell';
            document.getElementById('upsell-active').checked = true;
            document.getElementById('upsell-multi-room').checked = false;
            document.getElementById('upsell-rooms-checkboxes').style.display = 'none';
            document.getElementById('upsell-room').style.display = 'block';
            loadUpsellProperties();
            openModal('addUpsellModal');
        }
        
        async function loadUpsellProperties() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('upsell-property');
                select.innerHTML = '<option value="">All Properties</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                // Reset unit select
                document.getElementById('upsell-room').innerHTML = '<option value="">All Units</option>';
                document.getElementById('upsell-rooms-checkboxes').innerHTML = '';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadUpsellRooms() {
            const propertyId = document.getElementById('upsell-property').value;
            const roomSelect = document.getElementById('upsell-room');
            const roomCheckboxes = document.getElementById('upsell-rooms-checkboxes');
            
            roomSelect.innerHTML = '<option value="">All Units</option>';
            roomCheckboxes.innerHTML = '';
            
            if (!propertyId) return;
            
            try {
                // Use bookable-units endpoint - same as Offers page
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    
                    if (units.length > 0) {
                        units.forEach(unit => {
                            // Add to dropdown
                            roomSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                            
                            // Add checkbox
                            roomCheckboxes.innerHTML += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; cursor: pointer; border-radius: 4px; transition: background 0.2s;"
                                    onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background=''">
                                    <input type="checkbox" name="upsell-room-check" value="${unit.id}" style="width: 16px; height: 16px;">
                                    <span style="font-size: 0.9rem;">${unit.name}</span>
                                </label>
                            `;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        function toggleUpsellMultiRoom() {
            const multiRoom = document.getElementById('upsell-multi-room').checked;
            const roomSelect = document.getElementById('upsell-room');
            const roomCheckboxes = document.getElementById('upsell-rooms-checkboxes');
            
            if (multiRoom) {
                roomSelect.style.display = 'none';
                roomCheckboxes.style.display = 'block';
            } else {
                roomSelect.style.display = 'block';
                roomCheckboxes.style.display = 'none';
            }
        }
        
        async function editUpsell(id) {
            const upsell = upsellsData.find(u => u.id === id);
            if (!upsell) return;
            
            document.getElementById('upsell-id').value = upsell.id;
            document.getElementById('upsell-name').value = upsell.name || '';
            document.getElementById('upsell-description').value = upsell.description || '';
            document.getElementById('upsell-price').value = upsell.price || '';
            document.getElementById('upsell-charge-type').value = upsell.charge_type || 'per_booking';
            document.getElementById('upsell-max-qty').value = upsell.max_quantity || '';
            document.getElementById('upsell-active').checked = upsell.active;
            document.getElementById('upsell-multi-room').checked = false;
            document.getElementById('upsell-rooms-checkboxes').style.display = 'none';
            document.getElementById('upsell-room').style.display = 'block';
            
            // Load properties first
            await loadUpsellProperties();
            
            // Set property and load rooms
            if (upsell.property_id) {
                document.getElementById('upsell-property').value = upsell.property_id;
                await loadUpsellRooms();
                
                // Set room if single room
                if (upsell.room_id) {
                    document.getElementById('upsell-room').value = upsell.room_id;
                }
                // Handle room_ids (multiple rooms)
                if (upsell.room_ids) {
                    const roomIds = upsell.room_ids.split(',');
                    if (roomIds.length > 1) {
                        document.getElementById('upsell-multi-room').checked = true;
                        toggleUpsellMultiRoom();
                        roomIds.forEach(rid => {
                            const checkbox = document.querySelector(`input[name="upsell-room-check"][value="${rid}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            }
            
            document.getElementById('upsell-modal-title').innerHTML = '‚úèÔ∏è Edit Upsell';
            openModal('addUpsellModal');
        }
        
        async function saveUpsell() {
            const id = document.getElementById('upsell-id').value;
            const multiRoom = document.getElementById('upsell-multi-room').checked;
            
            // Get room IDs
            let roomId = null;
            let roomIds = null;
            
            if (multiRoom) {
                const checkedBoxes = document.querySelectorAll('input[name="upsell-room-check"]:checked');
                if (checkedBoxes.length > 0) {
                    roomIds = Array.from(checkedBoxes).map(cb => cb.value).join(',');
                }
            } else {
                roomId = document.getElementById('upsell-room').value || null;
            }
            
            const upsellData = {
                name: document.getElementById('upsell-name').value,
                description: document.getElementById('upsell-description').value,
                price: parseFloat(document.getElementById('upsell-price').value),
                charge_type: document.getElementById('upsell-charge-type').value,
                max_quantity: parseInt(document.getElementById('upsell-max-qty').value) || null,
                property_id: document.getElementById('upsell-property').value || null,
                room_id: roomId,
                room_ids: roomIds,
                active: document.getElementById('upsell-active').checked
            };
            
            try {
                const url = id ? `/api/admin/upsells/${id}` : '/api/admin/upsells';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(upsellData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addUpsellModal');
                    loadUpsells();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving upsell: ' + error.message);
            }
        }
        
        async function deleteUpsell(id) {
            if (!confirm('Delete this upsell?')) return;
            
            try {
                const response = await fetch(`/api/admin/upsells/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    loadUpsells();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting upsell: ' + error.message);
            }
        }

        // =====================================================
        // FEES FUNCTIONS
        // =====================================================
        
        let feesData = [];
        
        async function loadFees() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/fees${queryString}`);
                const data = await response.json();
                
                if (data.success) {
                    feesData = data.data || [];
                    renderFees(feesData);
                }
            } catch (error) {
                console.error('Error loading fees:', error);
            }
        }
        
        function renderFees(fees) {
            const container = document.getElementById('fees-list');
            
            if (!fees || fees.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üíµ</div>
                        <h3>No Fees Configured</h3>
                        <p>Add cleaning fees, taxes, or other charges</p>
                        <button class="btn" onclick="openAddFeeModal()">Add Your First Fee</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Amount</th>
                            <th style="text-align: left; padding: 0.75rem;">Apply Per</th>
                            <th style="text-align: center; padding: 0.75rem;">Type</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const applyPerLabels = {
                'per_booking': 'Per Booking',
                'per_night': 'Per Night',
                'per_guest': 'Per Guest',
                'per_guest_per_night': 'Per Guest/Night'
            };
            
            for (const fee of fees) {
                const amountDisplay = fee.amount_type === 'percentage' 
                    ? `${fee.amount}%` 
                    : `$${parseFloat(fee.amount).toFixed(2)}`;
                    
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${fee.name}</strong>
                            ${fee.description ? `<br><small style="color: var(--text-secondary);">${fee.description}</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #d97706;">${amountDisplay}</td>
                        <td style="padding: 0.75rem; color: var(--text-secondary);">${applyPerLabels[fee.apply_per] || fee.apply_per}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${fee.is_tax ? 'badge-warning' : 'badge-secondary'}">${fee.is_tax ? 'Tax' : 'Fee'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${fee.active ? 'badge-success' : 'badge-secondary'}">${fee.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editFee(${fee.id})" style="background: none; border: none; cursor: pointer;">‚úèÔ∏è</button>
                            <button onclick="deleteFee(${fee.id})" style="background: none; border: none; cursor: pointer;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function openAddFeeModal() {
            document.getElementById('fee-form').reset();
            document.getElementById('fee-id').value = '';
            document.getElementById('fee-modal-title').innerHTML = 'üíµ Add Fee';
            document.getElementById('fee-active').checked = true;
            document.getElementById('fee-amount-prefix').textContent = '$';
            await loadFeeProperties();
            openModal('addFeeModal');
        }
        
        async function loadFeeProperties() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('fee-property');
                select.innerHTML = '<option value="">All Properties</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                document.getElementById('fee-unit').innerHTML = '<option value="">All Units</option>';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadFeeUnits() {
            const propertyId = document.getElementById('fee-property').value;
            const unitSelect = document.getElementById('fee-unit');
            
            unitSelect.innerHTML = '<option value="">All Units</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    units.forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        function toggleFeeAmountInput() {
            const type = document.getElementById('fee-amount-type').value;
            document.getElementById('fee-amount-prefix').textContent = type === 'percentage' ? '' : '$';
        }
        
        async function editFee(id) {
            const fee = feesData.find(f => f.id === id);
            if (!fee) return;
            
            document.getElementById('fee-id').value = fee.id;
            document.getElementById('fee-name').value = fee.name || '';
            document.getElementById('fee-description').value = fee.description || '';
            document.getElementById('fee-amount-type').value = fee.amount_type || 'fixed';
            document.getElementById('fee-amount').value = fee.amount || '';
            document.getElementById('fee-apply-per').value = fee.apply_per || 'per_booking';
            document.getElementById('fee-is-tax').checked = fee.is_tax;
            document.getElementById('fee-active').checked = fee.active;
            
            toggleFeeAmountInput();
            document.getElementById('fee-modal-title').innerHTML = '‚úèÔ∏è Edit Fee';
            openModal('addFeeModal');
        }
        
        async function saveFee() {
            const id = document.getElementById('fee-id').value;
            const feeData = {
                name: document.getElementById('fee-name').value,
                description: document.getElementById('fee-description').value,
                amount_type: document.getElementById('fee-amount-type').value,
                amount: parseFloat(document.getElementById('fee-amount').value),
                apply_per: document.getElementById('fee-apply-per').value,
                is_tax: document.getElementById('fee-is-tax').checked,
                active: document.getElementById('fee-active').checked
            };
            
            try {
                const url = id ? `/api/admin/fees/${id}` : '/api/admin/fees';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feeData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addFeeModal');
                    loadFees();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving fee: ' + error.message);
            }
        }
        
        async function deleteFee(id) {
            if (!confirm('Delete this fee?')) return;
            
            try {
                const response = await fetch(`/api/admin/fees/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    loadFees();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting fee: ' + error.message);
            }
        }

        // =====================================================
        // TAXES FUNCTIONS
        // =====================================================
        
        let taxesData = [];
        
        async function loadTaxes() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/taxes${queryString}`);
                const data = await response.json();
                
                if (data.success) {
                    taxesData = data.data || [];
                    renderTaxes(taxesData);
                }
            } catch (error) {
                console.error('Error loading taxes:', error);
            }
        }
        
        function renderTaxes(taxes) {
            const container = document.getElementById('taxes-list');
            
            if (!taxes || taxes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üèõÔ∏è</div>
                        <h3>No Taxes Configured</h3>
                        <p>Add tourist taxes based on your property's location requirements</p>
                        <button class="btn" onclick="openAddTaxModal()">Add Your First Tax</button>
                    </div>
                `;
                return;
            }
            
            const chargePerLabels = {
                'per_person_per_night': 'Per Person/Night',
                'per_room_per_night': 'Per Room/Night',
                'per_booking': 'Per Booking',
                'percentage': '% of Booking'
            };
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Property</th>
                            <th style="text-align: left; padding: 0.75rem;">Country</th>
                            <th style="text-align: left; padding: 0.75rem;">Amount</th>
                            <th style="text-align: left; padding: 0.75rem;">Charged</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const tax of taxes) {
                const currencySymbols = { EUR: '‚Ç¨', USD: '$', GBP: '¬£', CHF: 'CHF', AED: 'AED', JPY: '¬•' };
                const symbol = currencySymbols[tax.currency] || tax.currency || '‚Ç¨';
                const amountDisplay = tax.amount_type === 'percentage' 
                    ? `${tax.amount}%` 
                    : `${symbol}${parseFloat(tax.amount).toFixed(2)}`;
                    
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${tax.name}</strong>
                            ${tax.max_nights ? `<br><small style="color: var(--text-secondary);">Max ${tax.max_nights} nights</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem; color: var(--text-secondary);">${tax.property_name || 'All Properties'}</td>
                        <td style="padding: 0.75rem;">${tax.country || '-'}</td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #4f46e5;">${amountDisplay}</td>
                        <td style="padding: 0.75rem; color: var(--text-secondary);">${chargePerLabels[tax.charge_per] || tax.charge_per}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${tax.active ? 'badge-success' : 'badge-secondary'}">${tax.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editTax(${tax.id})" style="background: none; border: none; cursor: pointer;">‚úèÔ∏è</button>
                            <button onclick="deleteTax(${tax.id})" style="background: none; border: none; cursor: pointer;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function openAddTaxModal() {
            document.getElementById('tax-form').reset();
            document.getElementById('tax-id').value = '';
            document.getElementById('tax-modal-title').innerHTML = 'üèõÔ∏è Add Tourist Tax';
            document.getElementById('tax-active').checked = true;
            
            // Show account dropdown for master users
            if (currentAccount && currentAccount.role === 'admin') {
                document.querySelectorAll('.master-only-field').forEach(el => el.style.display = 'block');
                await loadTaxAccounts();
            } else {
                document.querySelectorAll('.master-only-field').forEach(el => el.style.display = 'none');
            }
            
            await loadTaxProperties();
            openModal('addTaxModal');
        }
        
        async function loadTaxAccounts() {
            try {
                const response = await fetch('/api/admin/accounts');
                const data = await response.json();
                
                const select = document.getElementById('tax-account');
                select.innerHTML = '<option value="">Select client account...</option>';
                
                if (data.success && data.accounts) {
                    data.accounts.forEach(acc => {
                        select.innerHTML += `<option value="${acc.id}">${acc.name} (${acc.email})</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }
        
        async function loadTaxProperties() {
            try {
                // If account selected, filter properties by that account
                const accountId = document.getElementById('tax-account')?.value;
                let queryString = buildQueryString();
                
                // If master selected a specific account, get that account's properties
                if (accountId && currentAccount?.role === 'admin') {
                    queryString = `?account_id=${accountId}`;
                }
                
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('tax-property');
                select.innerHTML = '<option value="">All Properties</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                document.getElementById('tax-unit').innerHTML = '<option value="">All Units</option>';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadTaxUnits() {
            const propertyId = document.getElementById('tax-property').value;
            const unitSelect = document.getElementById('tax-unit');
            
            unitSelect.innerHTML = '<option value="">All Units</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    units.forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        function toggleTaxAmountInput() {
            const type = document.getElementById('tax-amount-type').value;
            const currencySelect = document.getElementById('tax-currency');
            if (type === 'percentage') {
                currencySelect.style.display = 'none';
            } else {
                currencySelect.style.display = 'block';
            }
        }
        
        function updateTaxPresets() {
            const country = document.getElementById('tax-country').value;
            const presets = {
                'FR': { name: 'Taxe de S√©jour', currency: 'EUR', chargePer: 'per_person_per_night' },
                'IT': { name: 'Imposta di Soggiorno', currency: 'EUR', chargePer: 'per_person_per_night' },
                'ES': { name: 'Tasa Tur√≠stica', currency: 'EUR', chargePer: 'per_person_per_night' },
                'NL': { name: 'Toeristenbelasting', currency: 'EUR', chargePer: 'percentage' },
                'DE': { name: 'City Tax', currency: 'EUR', chargePer: 'per_person_per_night' },
                'AT': { name: 'Ortstaxe', currency: 'EUR', chargePer: 'per_person_per_night' },
                'PT': { name: 'Taxa Tur√≠stica', currency: 'EUR', chargePer: 'per_person_per_night' },
                'CH': { name: 'Kurtaxe', currency: 'CHF', chargePer: 'per_person_per_night' },
                'US': { name: 'Occupancy Tax', currency: 'USD', chargePer: 'percentage' },
                'AE': { name: 'Tourism Dirham', currency: 'AED', chargePer: 'per_room_per_night' },
                'JP': { name: 'Accommodation Tax', currency: 'JPY', chargePer: 'per_person_per_night' }
            };
            
            if (presets[country]) {
                document.getElementById('tax-name').value = presets[country].name;
                document.getElementById('tax-currency').value = presets[country].currency;
                document.getElementById('tax-charge-per').value = presets[country].chargePer;
            }
        }
        
        async function editTax(id) {
            const tax = taxesData.find(t => t.id === id);
            if (!tax) return;
            
            // Show account dropdown for master users
            if (currentAccount && currentAccount.role === 'admin') {
                document.querySelectorAll('.master-only-field').forEach(el => el.style.display = 'block');
                await loadTaxAccounts();
                // Set account based on user_id of the tax
                document.getElementById('tax-account').value = tax.user_id || '';
            } else {
                document.querySelectorAll('.master-only-field').forEach(el => el.style.display = 'none');
            }
            
            // Load properties (filtered by account if selected)
            await loadTaxProperties();
            
            document.getElementById('tax-id').value = tax.id;
            document.getElementById('tax-name').value = tax.name || '';
            document.getElementById('tax-country').value = normalizeCountryCode(tax.country) || '';
            document.getElementById('tax-amount-type').value = tax.amount_type || 'fixed';
            document.getElementById('tax-currency').value = tax.currency || 'EUR';
            document.getElementById('tax-amount').value = tax.amount || '';
            document.getElementById('tax-charge-per').value = tax.charge_per || 'per_person_per_night';
            document.getElementById('tax-max-nights').value = tax.max_nights || '';
            document.getElementById('tax-min-age').value = tax.min_age || '';
            document.getElementById('tax-star-tier').value = tax.star_tier || '';
            document.getElementById('tax-season-start').value = tax.season_start || '';
            document.getElementById('tax-season-end').value = tax.season_end || '';
            document.getElementById('tax-active').checked = tax.active;
            
            // Set property and load units
            if (tax.property_id) {
                document.getElementById('tax-property').value = tax.property_id;
                await loadTaxUnits();
                if (tax.room_id) {
                    document.getElementById('tax-unit').value = tax.room_id;
                }
            }
            
            toggleTaxAmountInput();
            document.getElementById('tax-modal-title').innerHTML = '‚úèÔ∏è Edit Tax';
            openModal('addTaxModal');
        }
        
        async function saveTax() {
            const id = document.getElementById('tax-id').value;
            
            // Get account_id - either from dropdown (master) or current account
            let accountId = currentAccount?.id;
            const accountSelect = document.getElementById('tax-account');
            if (accountSelect && accountSelect.value) {
                accountId = accountSelect.value;
            }
            
            const taxData = {
                name: document.getElementById('tax-name').value,
                country: document.getElementById('tax-country').value || null,
                amount_type: document.getElementById('tax-amount-type').value,
                currency: document.getElementById('tax-currency').value,
                amount: parseFloat(document.getElementById('tax-amount').value),
                charge_per: document.getElementById('tax-charge-per').value,
                max_nights: parseInt(document.getElementById('tax-max-nights').value) || null,
                min_age: parseInt(document.getElementById('tax-min-age').value) || null,
                star_tier: document.getElementById('tax-star-tier').value || null,
                season_start: document.getElementById('tax-season-start').value || null,
                season_end: document.getElementById('tax-season-end').value || null,
                property_id: document.getElementById('tax-property').value || null,
                room_id: document.getElementById('tax-unit').value || null,
                active: document.getElementById('tax-active').checked,
                account_id: accountId
            };
            
            try {
                const url = id ? `/api/admin/taxes/${id}` : '/api/admin/taxes';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(taxData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addTaxModal');
                    loadTaxes();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving tax: ' + error.message);
            }
        }
        
        async function deleteTax(id) {
            if (!confirm('Delete this tax?')) return;
            
            try {
                const response = await fetch(`/api/admin/taxes/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    loadTaxes();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting tax: ' + error.message);
            }
        }

        // Property map instance
        let propertyMap = null;
        let propertyMarker = null;

        async function editProperty(id) {
            try {
                const response = await fetch(`/api/db/properties/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const prop = data.data;
                    document.getElementById('edit-property-id').value = prop.id;
                    document.getElementById('edit-property-name').value = prop.name || '';
                    document.getElementById('edit-property-type').value = prop.property_type || 'hotel';
                    document.getElementById('edit-property-address').value = prop.address || '';
                    document.getElementById('edit-property-city').value = prop.city || '';
                    document.getElementById('edit-property-district').value = prop.district || '';
                    document.getElementById('edit-property-state').value = prop.state || '';
                    document.getElementById('edit-property-zipcode').value = prop.zip_code || '';
                    document.getElementById('edit-property-country').value = normalizeCountryCode(prop.country) || '';
                    document.getElementById('edit-property-latitude').value = prop.latitude || '';
                    document.getElementById('edit-property-longitude').value = prop.longitude || '';
                    document.getElementById('edit-property-status').value = prop.status || 'active';
                    
                    // Reset map state
                    document.getElementById('property-map-preview').style.display = 'none';
                    document.getElementById('toggle-map-btn').textContent = 'üó∫Ô∏è Show Map';
                    propertyMap = null;
                    propertyMarker = null;
                    
                    openModal('editPropertyModal');
                }
            } catch (error) {
                console.error('Error loading property:', error);
                alert('Error loading property details');
            }
        }

        async function saveProperty(e) {
            e.preventDefault();
            const id = document.getElementById('edit-property-id').value;
            const data = {
                name: document.getElementById('edit-property-name').value,
                property_type: document.getElementById('edit-property-type').value,
                address: document.getElementById('edit-property-address').value,
                city: document.getElementById('edit-property-city').value,
                district: document.getElementById('edit-property-district').value,
                state: document.getElementById('edit-property-state').value,
                zip_code: document.getElementById('edit-property-zipcode').value,
                country: document.getElementById('edit-property-country').value,
                latitude: document.getElementById('edit-property-latitude').value ? parseFloat(document.getElementById('edit-property-latitude').value) : null,
                longitude: document.getElementById('edit-property-longitude').value ? parseFloat(document.getElementById('edit-property-longitude').value) : null,
                status: document.getElementById('edit-property-status').value
            };
            
            try {
                const response = await fetch(`/api/db/properties/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Property updated successfully!');
                    closeModal('editPropertyModal');
                    loadProperties();
                } else {
                    alert('Error updating property: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving property:', error);
                alert('Error saving property');
            }
            
            return false;
        }

        async function geocodePropertyAddress() {
            const address = document.getElementById('edit-property-address').value;
            const city = document.getElementById('edit-property-city').value;
            const state = document.getElementById('edit-property-state').value;
            const zipcode = document.getElementById('edit-property-zipcode').value;
            const country = document.getElementById('edit-property-country').value;
            
            const fullAddress = [address, city, state, zipcode, country].filter(Boolean).join(', ');
            
            if (!fullAddress) {
                alert('Please enter an address first');
                return;
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`, {
                    headers: { 'User-Agent': 'GAS-Admin/1.0' }
                });
                
                const results = await response.json();
                
                if (results && results.length > 0) {
                    const lat = parseFloat(results[0].lat).toFixed(7);
                    const lon = parseFloat(results[0].lon).toFixed(7);
                    
                    document.getElementById('edit-property-latitude').value = lat;
                    document.getElementById('edit-property-longitude').value = lon;
                    
                    if (propertyMap) {
                        updatePropertyMapMarker(lat, lon);
                    }
                    
                    alert(`‚úÖ Coordinates found!\n\nLatitude: ${lat}\nLongitude: ${lon}`);
                } else {
                    alert('Could not find coordinates for this address. Try being more specific or enter coordinates manually.');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error looking up address. Please enter coordinates manually.');
            }
        }

        function togglePropertyMap() {
            const mapPreview = document.getElementById('property-map-preview');
            const btn = document.getElementById('toggle-map-btn');
            
            if (mapPreview.style.display === 'none') {
                mapPreview.style.display = 'block';
                btn.textContent = 'üó∫Ô∏è Hide Map';
                if (!propertyMap) {
                    initPropertyMap();
                }
            } else {
                mapPreview.style.display = 'none';
                btn.textContent = 'üó∫Ô∏è Show Map';
            }
        }

        function initPropertyMap() {
            if (!document.getElementById('leaflet-css')) {
                const link = document.createElement('link');
                link.id = 'leaflet-css';
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(link);
            }
            
            if (typeof L === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.onload = () => createPropertyMap();
                document.head.appendChild(script);
            } else {
                createPropertyMap();
            }
        }

        function createPropertyMap() {
            const lat = parseFloat(document.getElementById('edit-property-latitude').value) || 51.5074;
            const lon = parseFloat(document.getElementById('edit-property-longitude').value) || -0.1278;
            
            propertyMap = L.map('property-map-container').setView([lat, lon], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(propertyMap);
            
            if (document.getElementById('edit-property-latitude').value) {
                propertyMarker = L.marker([lat, lon], { draggable: true }).addTo(propertyMap);
                propertyMarker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    document.getElementById('edit-property-latitude').value = pos.lat.toFixed(7);
                    document.getElementById('edit-property-longitude').value = pos.lng.toFixed(7);
                });
            }
            
            propertyMap.on('click', function(e) {
                document.getElementById('edit-property-latitude').value = e.latlng.lat.toFixed(7);
                document.getElementById('edit-property-longitude').value = e.latlng.lng.toFixed(7);
                
                if (propertyMarker) {
                    propertyMarker.setLatLng(e.latlng);
                } else {
                    propertyMarker = L.marker(e.latlng, { draggable: true }).addTo(propertyMap);
                    propertyMarker.on('dragend', function(ev) {
                        const pos = ev.target.getLatLng();
                        document.getElementById('edit-property-latitude').value = pos.lat.toFixed(7);
                        document.getElementById('edit-property-longitude').value = pos.lng.toFixed(7);
                    });
                }
            });
            
            setTimeout(() => propertyMap.invalidateSize(), 100);
        }

        function updatePropertyMapMarker(lat, lon) {
            if (propertyMap) {
                propertyMap.setView([lat, lon], 15);
                if (propertyMarker) {
                    propertyMarker.setLatLng([lat, lon]);
                } else {
                    propertyMarker = L.marker([lat, lon], { draggable: true }).addTo(propertyMap);
                    propertyMarker.on('dragend', function(e) {
                        const pos = e.target.getLatLng();
                        document.getElementById('edit-property-latitude').value = pos.lat.toFixed(7);
                        document.getElementById('edit-property-longitude').value = pos.lng.toFixed(7);
                    });
                }
            }
        }

        async function deleteProperty() {
            const id = document.getElementById('edit-property-id').value;
            const name = document.getElementById('edit-property-name').value;
            
            if (!confirm(`Are you sure you want to delete "${name}"?\n\nThis will also delete all rooms, images, and related data.\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/db/properties/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Property deleted successfully!');
                    closeModal('editPropertyModal');
                    loadProperties();
                    loadDashboard(); // Refresh stats
                } else {
                    alert('Error deleting property: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting property:', error);
                alert('Error deleting property');
            }
        }

        async function editRoom(id) {
            try {
                const response = await fetch(`/api/admin/units/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const room = data.data;
                    document.getElementById('edit-room-id').value = room.id;
                    
                    // CM Data (read-only display)
                    document.getElementById('edit-room-name').value = room.name || '';
                    document.getElementById('edit-room-type').value = room.unit_type || '';
                    document.getElementById('edit-room-maxguests').value = room.max_guests || '-';
                    document.getElementById('edit-room-maxadults').value = room.max_adults || '-';
                    document.getElementById('edit-room-maxchildren').value = room.max_children || '-';
                    
                    // GAS Controls
                    document.getElementById('edit-room-quantity').value = room.quantity || 1;
                    document.getElementById('edit-room-status').value = room.status || 'available';
                    
                    // Load all available amenities and room's current selections
                    const amenitiesContainer = document.getElementById('edit-room-amenities');
                    amenitiesContainer.innerHTML = 'Loading amenities...';
                    
                    try {
                        // Get all master amenities
                        const allAmenitiesResp = await fetch('/api/admin/amenities');
                        const allAmenitiesData = await allAmenitiesResp.json();
                        
                        // Get this room's current amenities
                        const roomAmenitiesResp = await fetch(`/api/admin/units/${id}/amenities`);
                        const roomAmenitiesData = await roomAmenitiesResp.json();
                        
                        if (allAmenitiesData.success) {
                            const allAmenities = allAmenitiesData.amenities || [];
                            
                            // Get selected amenity IDs
                            const selectedIds = new Set();
                            if (roomAmenitiesData.success && roomAmenitiesData.data) {
                                roomAmenitiesData.data.forEach(a => selectedIds.add(a.amenity_id));
                            }
                            
                            // Group by category and sort selected to top
                            const categories = {};
                            allAmenities.forEach(a => {
                                const cat = a.category || 'other';
                                if (!categories[cat]) categories[cat] = [];
                                categories[cat].push(a);
                            });
                            
                            // Sort each category: selected first, then alphabetically
                            Object.keys(categories).forEach(cat => {
                                categories[cat].sort((a, b) => {
                                    const aSelected = selectedIds.has(a.id);
                                    const bSelected = selectedIds.has(b.id);
                                    
                                    // Selected items come first
                                    if (aSelected && !bSelected) return -1;
                                    if (!aSelected && bSelected) return 1;
                                    
                                    // Within same selection status, sort by display_order
                                    return a.display_order - b.display_order;
                                });
                            });
                            
                            // Category names
                            const categoryNames = {
                                'beds': 'üõèÔ∏è Beds',
                                'bathrooms': 'üöø Bathrooms',
                                'essentials': '‚≠ê Essentials',
                                'kitchen': 'üç≥ Kitchen',
                                'entertainment': 'üì∫ Entertainment',
                                'outdoor': 'üå≥ Outdoor',
                                'wellness': 'üíÜ Wellness',
                                'parking': 'üöó Parking',
                                'family': 'üë®‚Äçüë©‚Äçüëß Family',
                                'work': 'üíº Work',
                                'safety': 'üö® Safety',
                                'laundry': 'üß∫ Laundry',
                                'other': 'üì¶ Other'
                            };
                            
                            // Build checkbox UI
                            let html = '';
                            const sortOrder = ['beds', 'bathrooms', 'essentials', 'kitchen', 'entertainment', 'outdoor', 'wellness', 'parking', 'family', 'work', 'safety', 'laundry', 'other'];
                            const sortedCategories = Object.entries(categories).sort((a, b) => 
                                sortOrder.indexOf(a[0]) - sortOrder.indexOf(b[0])
                            );
                            
                            sortedCategories.forEach(([cat, items]) => {
                                html += `
                                    <div style="margin-bottom: 1rem;">
                                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.9rem;">
                                            ${categoryNames[cat] || cat}
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                                            ${items.map(a => {
                                                const name = typeof a.amenity_name === 'string' ? 
                                                    (a.amenity_name.startsWith('{') ? JSON.parse(a.amenity_name).en : a.amenity_name) :
                                                    a.amenity_name?.en || a.amenity_code;
                                                const isSelected = selectedIds.has(a.id);
                                                return `
                                                <label style="display: flex; align-items: center; cursor: pointer; padding: 0.4rem; border-radius: 4px; background: ${isSelected ? 'var(--primary)' : 'var(--bg-primary)'}; border: 1px solid ${isSelected ? 'var(--primary)' : 'var(--border)'}; font-size: 0.85rem; color: ${isSelected ? 'white' : 'var(--text-primary)'};">
                                                    <input type="checkbox" 
                                                           class="amenity-checkbox" 
                                                           value="${a.id}" 
                                                           ${isSelected ? 'checked' : ''}
                                                           style="margin-right: 0.5rem;">
                                                    <span>${a.icon || ''} ${name}</span>
                                                </label>
                                            `}).join('')}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            amenitiesContainer.innerHTML = html || '<span style="color: var(--text-secondary);">No amenities available</span>';
                        }
                    } catch (e) {
                        console.error('Error loading amenities:', e);
                        amenitiesContainer.innerHTML = '<span style="color: var(--text-secondary);">Error loading amenities</span>';
                    }
                    
                    openModal('editRoomModal');
                }
            } catch (error) {
                console.error('Error loading room:', error);
                alert('Error loading room details');
            }
        }
        
        function getAmenityName(a) {
            if (typeof a.amenity_name === 'string') {
                if (a.amenity_name.startsWith('{')) {
                    try { return JSON.parse(a.amenity_name).en || a.amenity_code; } catch(e) { return a.amenity_code; }
                }
                return a.amenity_name;
            }
            return a.amenity_name?.en || a.amenity_code;
        }

        async function saveRoom(e) {
            e.preventDefault();
            const id = document.getElementById('edit-room-id').value;
            
            // Get GAS-controlled fields
            const data = {
                quantity: document.getElementById('edit-room-quantity').value || 1,
                status: document.getElementById('edit-room-status').value
            };
            
            // Get selected amenities
            const selectedAmenities = [];
            document.querySelectorAll('.amenity-checkbox:checked').forEach(checkbox => {
                selectedAmenities.push(checkbox.value);
            });
            
            try {
                // Update room fields
                const response = await fetch(`/api/admin/units/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (!result.success) {
                    alert('Error updating room: ' + result.error);
                    return false;
                }
                
                // Update amenities
                const amenitiesResponse = await fetch(`/api/admin/units/${id}/amenities`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amenities: selectedAmenities })
                });
                
                const amenitiesResult = await amenitiesResponse.json();
                if (amenitiesResult.success) {
                    alert('Room updated successfully!');
                    closeModal('editRoomModal');
                    loadRooms();
                } else {
                    alert('Room updated but error updating amenities: ' + amenitiesResult.error);
                }
            } catch (error) {
                console.error('Error saving room:', error);
                alert('Error saving room');
            }
            
            return false;
        }

        async function deleteRoom() {
            const id = document.getElementById('edit-room-id').value;
            const name = document.getElementById('edit-room-name').value;
            
            if (!confirm(`Are you sure you want to delete "${name}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/units/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Room deleted successfully!');
                    closeModal('editRoomModal');
                    loadRooms();
                    loadDashboard(); // Refresh stats
                } else {
                    alert('Error deleting room: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('Error deleting room');
            }
        }

        // Placeholder functions for other modals
        function openAddRoomModal() {
            alert('Add Room feature coming soon!');
        }

        function openUploadModal() {
            openImageUploadModal();
        }

        // Toggle upsell presets visibility
        function toggleUpsellPresets() {
            const presets = document.getElementById('all-upsell-presets');
            const btn = document.getElementById('toggle-presets-btn');
            
            if (presets.style.display === 'none') {
                presets.style.display = 'block';
                btn.textContent = 'Hide Categories ‚ñ≤';
            } else {
                presets.style.display = 'none';
                btn.textContent = 'Show All Categories ‚ñº';
            }
        }
        
        // Quick add upsell from preset - opens modal pre-filled
        async function quickAddUpsell(name, price, chargeType) {
            // Reset form first
            document.getElementById('upsell-form').reset();
            document.getElementById('upsell-id').value = '';
            document.getElementById('upsell-multi-room').checked = false;
            document.getElementById('upsell-rooms-checkboxes').style.display = 'none';
            document.getElementById('upsell-room').style.display = 'block';
            
            // Pre-fill with preset values
            document.getElementById('upsell-name').value = name;
            document.getElementById('upsell-price').value = price;
            document.getElementById('upsell-charge-type').value = chargeType;
            document.getElementById('upsell-active').checked = true;
            
            // Load properties
            await loadUpsellProperties();
            
            // Update modal title to show it's from preset
            document.getElementById('upsell-modal-title').innerHTML = 'üéÅ Add: ' + name;
            
            openModal('addUpsellModal');
        }

        // Cleanup duplicates
        async function cleanupDuplicates() {
            if (!confirm('This will remove duplicate properties and rooms, keeping only the most recent imports. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/cleanup-duplicates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úì Duplicates removed!\n\nProperties: ' + result.counts.properties + '\nRooms: ' + result.counts.units);
                    loadDashboard();
                    if (document.getElementById('properties').classList.contains('active')) {
                        loadProperties();
                    }
                    if (document.getElementById('rooms').classList.contains('active')) {
                        loadRooms();
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error cleaning up: ' + error.message);
            }
        }

        // =====================================================
        // WEBSITE PAGES FUNCTIONS
        // =====================================================
        
        let currentPageType = 'about';
        
        const pageTemplates = {
            about: {
                title: 'About Us',
                prompts: ['history', 'team', 'values', 'mission']
            },
            contact: {
                title: 'Contact Us',
                prompts: ['location', 'hours', 'directions']
            },
            terms: {
                title: 'Terms & Conditions',
                prompts: ['booking', 'cancellation', 'liability', 'payment']
            },
            privacy: {
                title: 'Privacy Policy',
                prompts: ['data collection', 'cookies', 'GDPR', 'rights']
            }
        };

        async function loadWebsitePage(pageType) {
            currentPageType = pageType;
            document.getElementById('page-type').value = pageType;
            
            // Update tab buttons
            ['about', 'contact', 'terms', 'privacy'].forEach(type => {
                const btn = document.getElementById('page-tab-' + type);
                if (btn) {
                    btn.style.background = type === pageType ? 'var(--accent)' : '#64748b';
                }
            });
            
            // Update AI panel badge
            const badge = document.getElementById('page-ai-badge');
            if (badge) {
                const titles = { about: 'About Us', contact: 'Contact', terms: 'Terms & Conditions', privacy: 'Privacy Policy' };
                badge.textContent = titles[pageType] || pageType;
            }
            
            // Update AI context placeholder based on page type
            const contextInput = document.getElementById('page-ai-context');
            if (contextInput) {
                const placeholders = {
                    about: "Tell us about your property... e.g. 'Victorian B&B in St Louis, family-run since 1995, known for gourmet breakfasts'",
                    contact: "Your business details... e.g. 'Open 7 days, check-in from 3pm, located downtown near metro'",
                    terms: "Your booking policies... e.g. '48-hour cancellation, no smoking, pets welcome with fee, 18+ only'",
                    privacy: "Your data practices... e.g. 'We collect booking info, use Stripe for payments, based in USA'"
                };
                contextInput.placeholder = placeholders[pageType] || placeholders.about;
            }
            
            try {
                const response = await fetch(`/api/admin/pages/${pageType}?client_id=${getClientId()}`);
                const data = await response.json();
                
                if (data.success && data.page) {
                    document.getElementById('page-title').value = data.page.title || '';
                    document.getElementById('page-subtitle').value = data.page.subtitle || '';
                    document.getElementById('page-content').value = data.page.content || '';
                    document.getElementById('page-meta-title').value = data.page.meta_title || '';
                    document.getElementById('page-meta-description').value = data.page.meta_description || '';
                    document.getElementById('page-published').checked = data.page.is_published;
                    document.getElementById('page-faq-schema').value = data.page.faq_schema || '';
                    updateMetaCount();
                    updateFAQPreview();
                } else {
                    // Clear form for new page
                    const defaultTitles = { about: 'About Us', contact: 'Contact Us', terms: 'Terms & Conditions', privacy: 'Privacy Policy' };
                    document.getElementById('page-title').value = defaultTitles[pageType] || '';
                    document.getElementById('page-subtitle').value = '';
                    document.getElementById('page-content').value = '';
                    document.getElementById('page-meta-title').value = '';
                    document.getElementById('page-meta-description').value = '';
                    document.getElementById('page-published').checked = false;
                    document.getElementById('page-faq-schema').value = '';
                    updateMetaCount();
                    document.getElementById('faq-schema-preview').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading page:', error);
            }
        }
        
        function updateMetaCount() {
            const title = document.getElementById('page-meta-title').value;
            const desc = document.getElementById('page-meta-description').value;
            
            const titleCount = document.getElementById('meta-title-count');
            const descCount = document.getElementById('meta-desc-count');
            
            if (titleCount) {
                titleCount.textContent = `(${title.length}/60)`;
                titleCount.style.color = title.length > 60 ? '#ef4444' : title.length > 50 ? '#f59e0b' : 'var(--text-muted)';
            }
            if (descCount) {
                descCount.textContent = `(${desc.length}/160)`;
                descCount.style.color = desc.length > 160 ? '#ef4444' : desc.length > 150 ? '#f59e0b' : 'var(--text-muted)';
            }
        }
        
        function updateFAQPreview() {
            const schemaText = document.getElementById('page-faq-schema').value;
            const preview = document.getElementById('faq-schema-preview');
            const list = document.getElementById('faq-items-list');
            
            if (!schemaText || schemaText.trim() === '') {
                preview.style.display = 'none';
                return;
            }
            
            try {
                const faqs = JSON.parse(schemaText);
                if (Array.isArray(faqs) && faqs.length > 0) {
                    list.innerHTML = faqs.map((faq, i) => `
                        <div style="padding: 0.5rem 0; ${i > 0 ? 'border-top: 1px solid #e2e8f0;' : ''}">
                            <div style="font-weight: 600; font-size: 0.85rem; color: #1e293b;">Q: ${faq.question}</div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">A: ${faq.answer?.substring(0, 100)}${faq.answer?.length > 100 ? '...' : ''}</div>
                        </div>
                    `).join('');
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            } catch (e) {
                preview.style.display = 'none';
            }
        }
        
        async function generatePageContent() {
            const context = document.getElementById('page-ai-context').value;
            const businessName = document.getElementById('contact-business-name')?.value || 'Our Property';
            const statusEl = document.getElementById('page-ai-status');
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '‚è≥ Generating content...';
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'page_content',
                        page_type: currentPageType,
                        context: context,
                        business_name: businessName
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.content) {
                    document.getElementById('page-content').value = data.content;
                    if (data.title) document.getElementById('page-title').value = data.title;
                    if (data.subtitle) document.getElementById('page-subtitle').value = data.subtitle;
                    statusEl.innerHTML = '‚úÖ Content generated! Review and edit as needed.';
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
            } catch (error) {
                console.error('Error generating content:', error);
                statusEl.innerHTML = '‚ùå Error generating content. Using template instead...';
                
                // Fallback to local templates
                setTimeout(() => {
                    const template = getPageTemplate(currentPageType, context, businessName);
                    document.getElementById('page-content').value = template;
                    statusEl.innerHTML = '‚úÖ Template applied! Customize it for your property.';
                }, 500);
            }
            
            setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
        }
        
        function getPageTemplate(pageType, context, businessName) {
            const templates = {
                about: `<h2>Welcome to ${businessName}</h2>
<p>${context || 'We are delighted to welcome you to our property. Our commitment to exceptional hospitality ensures every guest enjoys a memorable stay.'}</p>

<h2>Our Story</h2>
<p>Founded with a passion for hospitality, ${businessName} has been providing comfortable accommodations and warm service to travelers from around the world.</p>

<h2>What Makes Us Special</h2>
<ul>
    <li><strong>Prime Location</strong> - Perfectly situated for exploring the local area</li>
    <li><strong>Comfortable Rooms</strong> - Thoughtfully designed for your relaxation</li>
    <li><strong>Personal Service</strong> - Our team is dedicated to making your stay exceptional</li>
    <li><strong>Local Experience</strong> - We love sharing our knowledge of the area</li>
</ul>

<h2>Our Commitment</h2>
<p>We believe that great hospitality is about the details. From the moment you arrive until you check out, our goal is to exceed your expectations and create lasting memories.</p>`,

                contact: `<h2>Get in Touch</h2>
<p>We'd love to hear from you! Whether you have questions about your booking, need recommendations for local attractions, or want to arrange a special request, our team is here to help.</p>

<h2>Contact Information</h2>
<p>Feel free to reach out through any of the following channels:</p>

<h2>Before Your Arrival</h2>
<p>If you have any special requests or need to communicate arrival details, please don't hesitate to contact us. We're happy to help with:</p>
<ul>
    <li>Early check-in or late check-out requests</li>
    <li>Special occasion arrangements</li>
    <li>Dietary requirements</li>
    <li>Transportation assistance</li>
    <li>Local recommendations</li>
</ul>

<h2>During Your Stay</h2>
<p>Our team is available to assist you with anything you need during your stay. Just ask!</p>`,

                terms: `<h2>Booking Terms & Conditions</h2>
<p>Please read these terms carefully before making a reservation at ${businessName}. By completing a booking, you agree to these terms and conditions.</p>

<h2>Reservations & Payment</h2>
<p>A valid credit card is required to secure your reservation. Payment terms vary by rate type:</p>
<ul>
    <li><strong>Standard Rate:</strong> Full payment due at check-in</li>
    <li><strong>Non-Refundable Rate:</strong> Full payment charged at time of booking</li>
    <li><strong>Deposit Required:</strong> Partial payment at booking, balance due at check-in</li>
</ul>

<h2>Cancellation Policy</h2>
<p>Our standard cancellation policy is as follows:</p>
<ul>
    <li>Free cancellation up to 48 hours before check-in</li>
    <li>Cancellations within 48 hours: First night charged</li>
    <li>No-shows: Full stay charged</li>
    <li>Non-refundable bookings: No refunds for any cancellation</li>
</ul>

<h2>Check-in & Check-out</h2>
<ul>
    <li><strong>Check-in:</strong> From 3:00 PM</li>
    <li><strong>Check-out:</strong> By 11:00 AM</li>
    <li>Early check-in and late check-out available upon request (subject to availability)</li>
</ul>

<h2>House Rules</h2>
<ul>
    <li>No smoking on the premises</li>
    <li>Quiet hours: 10:00 PM - 8:00 AM</li>
    <li>Pets policy: Please contact us for pet-friendly options</li>
    <li>Additional guests must be registered at check-in</li>
</ul>

<h2>Liability</h2>
<p>${businessName} is not responsible for loss or damage to guests' personal belongings. Valuables should be secured in provided safes where available.</p>

<h2>Damages</h2>
<p>Guests are responsible for any damage caused to the property during their stay. Costs for repairs or replacement will be charged to the card on file.</p>`,

                privacy: `<h2>Privacy Policy</h2>
<p>At ${businessName}, we are committed to protecting your privacy and personal data. This policy explains how we collect, use, and safeguard your information.</p>

<h2>Information We Collect</h2>
<p>We collect information necessary to provide our services:</p>
<ul>
    <li><strong>Booking Information:</strong> Name, email, phone, address</li>
    <li><strong>Payment Details:</strong> Processed securely through our payment provider</li>
    <li><strong>Stay Preferences:</strong> Special requests, dietary requirements</li>
    <li><strong>Communication Records:</strong> Emails and messages exchanged with us</li>
</ul>

<h2>How We Use Your Information</h2>
<ul>
    <li>Process and manage your booking</li>
    <li>Communicate about your reservation</li>
    <li>Improve our services</li>
    <li>Send marketing communications (with your consent)</li>
    <li>Comply with legal obligations</li>
</ul>

<h2>Data Protection (GDPR)</h2>
<p>If you are in the European Economic Area, you have rights under GDPR including:</p>
<ul>
    <li><strong>Right to Access:</strong> Request a copy of your personal data</li>
    <li><strong>Right to Rectification:</strong> Correct inaccurate data</li>
    <li><strong>Right to Erasure:</strong> Request deletion of your data</li>
    <li><strong>Right to Portability:</strong> Receive your data in a portable format</li>
    <li><strong>Right to Object:</strong> Object to processing of your data</li>
</ul>

<h2>Cookies</h2>
<p>Our website uses cookies to improve your experience:</p>
<ul>
    <li><strong>Essential Cookies:</strong> Required for the website to function</li>
    <li><strong>Analytics Cookies:</strong> Help us understand how visitors use our site</li>
    <li><strong>Marketing Cookies:</strong> Used to deliver relevant advertisements</li>
</ul>

<h2>Data Security</h2>
<p>We implement appropriate security measures to protect your personal information against unauthorized access, alteration, or destruction.</p>

<h2>Third-Party Services</h2>
<p>We may share data with trusted partners who assist in operating our business:</p>
<ul>
    <li>Payment processors</li>
    <li>Booking platforms</li>
    <li>Email service providers</li>
</ul>

<h2>Contact Us</h2>
<p>For any privacy-related questions or to exercise your rights, please contact us.</p>

<h2>Updates to This Policy</h2>
<p>We may update this policy periodically. The latest version will always be available on our website.</p>

<p><em>Last updated: ${new Date().toLocaleDateString()}</em></p>`
            };
            
            return templates[pageType] || templates.about;
        }
        
        async function generatePageSEO() {
            const content = document.getElementById('page-content').value;
            const title = document.getElementById('page-title').value;
            const businessName = document.getElementById('contact-business-name')?.value || '';
            const statusEl = document.getElementById('page-ai-status');
            
            if (!content) {
                alert('Please add some content first, then generate SEO.');
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '‚è≥ Generating SEO suggestions...';
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'seo',
                        page_type: currentPageType,
                        content: content.substring(0, 2000),
                        title: title,
                        business_name: businessName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.meta_title) document.getElementById('page-meta-title').value = data.meta_title;
                    if (data.meta_description) document.getElementById('page-meta-description').value = data.meta_description;
                    updateMetaCount();
                    statusEl.innerHTML = '‚úÖ SEO generated!';
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
            } catch (error) {
                console.error('Error generating SEO:', error);
                // Fallback to basic SEO generation
                const seo = generateBasicSEO(currentPageType, title, businessName);
                document.getElementById('page-meta-title').value = seo.title;
                document.getElementById('page-meta-description').value = seo.description;
                updateMetaCount();
                statusEl.innerHTML = '‚úÖ SEO suggestions applied!';
            }
            
            setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
        }
        
        function generateBasicSEO(pageType, title, businessName) {
            const seoTemplates = {
                about: {
                    title: `About ${businessName || 'Us'} | Our Story & Values`,
                    description: `Learn about ${businessName || 'our property'}, our history, and what makes us special. Discover why guests choose us for their stay.`
                },
                contact: {
                    title: `Contact ${businessName || 'Us'} | Get in Touch`,
                    description: `Contact ${businessName || 'us'} for bookings, inquiries, or assistance. Find our address, phone number, email, and hours of operation.`
                },
                terms: {
                    title: `Terms & Conditions | ${businessName || 'Booking Policies'}`,
                    description: `Read our terms and conditions including booking policies, cancellation rules, check-in/out times, and house rules at ${businessName || 'our property'}.`
                },
                privacy: {
                    title: `Privacy Policy | ${businessName || 'Data Protection'}`,
                    description: `Our privacy policy explains how ${businessName || 'we'} collect, use, and protect your personal data. GDPR compliant.`
                }
            };
            
            return seoTemplates[pageType] || seoTemplates.about;
        }
        
        function generatePageFAQSchema() {
            const content = document.getElementById('page-content').value;
            const statusEl = document.getElementById('page-ai-status');
            
            if (!content) {
                alert('Please add content with headers (h2, h3) first.');
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '‚è≥ Extracting FAQ schema from headers...';
            
            // Parse headers and their following content
            const faqs = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            const headers = tempDiv.querySelectorAll('h2, h3');
            headers.forEach(header => {
                const question = header.textContent.trim();
                if (!question) return;
                
                // Get content until next header
                let answer = '';
                let sibling = header.nextElementSibling;
                while (sibling && !['H1', 'H2', 'H3', 'H4'].includes(sibling.tagName)) {
                    answer += sibling.textContent.trim() + ' ';
                    sibling = sibling.nextElementSibling;
                }
                
                answer = answer.trim();
                if (answer && answer.length > 20) {
                    // Convert header to question format if not already
                    let q = question;
                    if (!q.endsWith('?')) {
                        q = 'What is ' + q.toLowerCase().replace(/^(our |the |about )/i, '') + '?';
                    }
                    
                    faqs.push({
                        question: q.charAt(0).toUpperCase() + q.slice(1),
                        answer: answer.substring(0, 500) + (answer.length > 500 ? '...' : '')
                    });
                }
            });
            
            if (faqs.length > 0) {
                document.getElementById('page-faq-schema').value = JSON.stringify(faqs, null, 2);
                updateFAQPreview();
                statusEl.innerHTML = `‚úÖ Generated ${faqs.length} FAQ items from headers!`;
            } else {
                statusEl.innerHTML = '‚ö†Ô∏è No headers found. Add &lt;h2&gt; or &lt;h3&gt; tags to your content.';
            }
            
            setTimeout(() => { statusEl.style.display = 'none'; }, 4000);
        }
        
        function previewPageContent() {
            const content = document.getElementById('page-content').value;
            const title = document.getElementById('page-title').value;
            
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title} - Preview</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; color: #1e293b; }
                        h1 { color: #6366f1; border-bottom: 2px solid #6366f1; padding-bottom: 10px; }
                        h2 { color: #1e293b; margin-top: 30px; }
                        ul { padding-left: 20px; }
                        li { margin-bottom: 8px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    ${content}
                </body>
                </html>
            `);
            previewWindow.document.close();
        }

        async function saveWebsitePage() {
            const pageData = {
                client_id: getClientId(),
                page_type: currentPageType,
                slug: currentPageType,
                title: document.getElementById('page-title').value,
                subtitle: document.getElementById('page-subtitle').value,
                content: document.getElementById('page-content').value,
                meta_title: document.getElementById('page-meta-title').value,
                meta_description: document.getElementById('page-meta-description').value,
                faq_schema: document.getElementById('page-faq-schema').value,
                is_published: document.getElementById('page-published').checked
            };
            
            try {
                const response = await fetch('/api/admin/pages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pageData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Page saved successfully!');
                } else {
                    alert('Error saving page: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving page:', error);
                alert('Error saving page');
            }
        }

        async function loadContactInfo() {
            try {
                const response = await fetch(`/api/admin/contact-info?client_id=${getClientId()}`);
                const data = await response.json();
                
                if (data.success && data.contact) {
                    const c = data.contact;
                    // Basic info
                    document.getElementById('contact-business-name').value = c.business_name || '';
                    document.getElementById('contact-tagline').value = c.tagline || '';
                    document.getElementById('contact-email').value = c.email || '';
                    document.getElementById('contact-phone').value = c.phone || '';
                    
                    // Optional fields with null checks
                    const phoneSecondary = document.getElementById('contact-phone-secondary');
                    if (phoneSecondary) phoneSecondary.value = c.phone_secondary || '';
                    
                    const whatsapp = document.getElementById('contact-whatsapp');
                    if (whatsapp) whatsapp.value = c.whatsapp || '';
                    
                    // Address fields
                    const addr1 = document.getElementById('contact-address1');
                    if (addr1) addr1.value = c.address_line1 || '';
                    
                    const addr2 = document.getElementById('contact-address2');
                    if (addr2) addr2.value = c.address_line2 || '';
                    
                    const city = document.getElementById('contact-city');
                    if (city) city.value = c.city || '';
                    
                    const state = document.getElementById('contact-state');
                    if (state) state.value = c.state_province || '';
                    
                    const postal = document.getElementById('contact-postal');
                    if (postal) postal.value = c.postal_code || '';
                    
                    const country = document.getElementById('contact-country');
                    if (country) country.value = normalizeCountryCode(c.country) || '';
                    
                    // Social media
                    document.getElementById('contact-facebook').value = c.facebook_url || '';
                    document.getElementById('contact-instagram').value = c.instagram_url || '';
                    document.getElementById('contact-twitter').value = c.twitter_url || '';
                    
                    const linkedin = document.getElementById('contact-linkedin');
                    if (linkedin) linkedin.value = c.linkedin_url || '';
                    
                    const youtube = document.getElementById('contact-youtube');
                    if (youtube) youtube.value = c.youtube_url || '';
                    
                    const tripadvisor = document.getElementById('contact-tripadvisor');
                    if (tripadvisor) tripadvisor.value = c.tripadvisor_url || '';
                    
                    // Map fields
                    const mapsUrl = document.getElementById('contact-maps-url');
                    if (mapsUrl) mapsUrl.value = c.google_maps_url || '';
                    
                    const placeId = document.getElementById('contact-place-id');
                    if (placeId) placeId.value = c.google_place_id || '';
                    
                    const lat = document.getElementById('contact-latitude');
                    if (lat) lat.value = c.latitude || '';
                    
                    const lng = document.getElementById('contact-longitude');
                    if (lng) lng.value = c.longitude || '';
                }
            } catch (error) {
                console.error('Error loading contact info:', error);
            }
        }

        async function saveContactInfo() {
            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };
            
            const contactData = {
                client_id: getClientId(),
                business_name: getVal('contact-business-name'),
                tagline: getVal('contact-tagline'),
                email: getVal('contact-email'),
                phone: getVal('contact-phone'),
                phone_secondary: getVal('contact-phone-secondary'),
                whatsapp: getVal('contact-whatsapp'),
                address_line1: getVal('contact-address1'),
                address_line2: getVal('contact-address2'),
                city: getVal('contact-city'),
                state_province: getVal('contact-state'),
                postal_code: getVal('contact-postal'),
                country: getVal('contact-country'),
                facebook_url: getVal('contact-facebook'),
                instagram_url: getVal('contact-instagram'),
                twitter_url: getVal('contact-twitter'),
                linkedin_url: getVal('contact-linkedin'),
                youtube_url: getVal('contact-youtube'),
                tripadvisor_url: getVal('contact-tripadvisor'),
                google_maps_url: getVal('contact-maps-url'),
                google_place_id: getVal('contact-place-id'),
                latitude: getVal('contact-latitude') || null,
                longitude: getVal('contact-longitude') || null
            };
            
            try {
                const response = await fetch('/api/admin/contact-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contactData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Contact info saved successfully!');
                } else {
                    alert('Error saving contact info: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving contact info:', error);
                alert('Error saving contact info');
            }
        }

        // =====================================================
        // BLOG FUNCTIONS
        // =====================================================

        async function loadBlogPosts() {
            try {
                const response = await fetch(`/api/admin/blog?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('blog-posts-list');
                
                if (data.success && data.posts && data.posts.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.posts.map(post => `
                                    <tr>
                                        <td><strong>${post.title}</strong></td>
                                        <td>${post.category || '-'}</td>
                                        <td><span class="badge ${post.is_published ? 'badge-success' : 'badge-secondary'}">${post.is_published ? 'Published' : 'Draft'}</span></td>
                                        <td>${post.published_at ? new Date(post.published_at).toLocaleDateString() : '-'}</td>
                                        <td>
                                            <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editBlogPost(${post.id})">Edit</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                            <p>No blog posts yet</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openBlogModal()">Create Your First Post</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading blog posts:', error);
            }
        }

        function openBlogModal(post = null) {
            alert('Blog modal coming soon! The API endpoints are ready at /api/admin/blog');
        }

        async function editBlogPost(id) {
            alert('Edit blog post ' + id + ' - Modal coming soon!');
        }

        // =====================================================
        // ATTRACTIONS FUNCTIONS
        // =====================================================

        async function loadAttractions() {
            try {
                const response = await fetch(`/api/admin/attractions?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('attractions-list');
                
                if (data.success && data.attractions && data.attractions.length > 0) {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                            ${data.attractions.map(attr => `
                                <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="editAttraction(${attr.id})">
                                    ${attr.featured_image_url ? 
                                        `<img src="${attr.featured_image_url}" style="width: 100%; height: 150px; object-fit: cover;">` :
                                        `<div style="width: 100%; height: 150px; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; font-size: 3rem;">üéØ</div>`
                                    }
                                    <div style="padding: 1rem;">
                                        <h4 style="margin: 0 0 0.5rem;">${attr.name}</h4>
                                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">
                                            ${attr.category ? `üìç ${attr.category}` : ''}
                                            ${attr.distance_text ? ` ‚Ä¢ ${attr.distance_text}` : ''}
                                        </p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üéØ</div>
                            <p>No attractions added yet</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openAttractionModal()">Add Your First Attraction</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading attractions:', error);
            }
        }

        function openAttractionModal(attraction = null) {
            alert('Attraction modal coming soon! The API endpoints are ready at /api/admin/attractions');
        }

        async function editAttraction(id) {
            alert('Edit attraction ' + id + ' - Modal coming soon!');
        }

        // =====================================================
        // REVIEWS FUNCTIONS
        // =====================================================

        function openReviewModal() {
            alert('Reviews modal coming soon! The API endpoints will be at /api/admin/reviews');
        }

        async function loadAppBlogPosts() {
            // Reuse the same function but target different container
            try {
                const response = await fetch(`/api/admin/blog?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('app-blog-posts-list');
                if (!container) return;
                
                if (data.success && data.posts && data.posts.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.posts.map(post => `
                                    <tr>
                                        <td><strong>${post.title}</strong></td>
                                        <td>${post.category || '-'}</td>
                                        <td><span class="badge ${post.is_published ? 'badge-success' : 'badge-secondary'}">${post.is_published ? 'Published' : 'Draft'}</span></td>
                                        <td>${post.published_at ? new Date(post.published_at).toLocaleDateString() : '-'}</td>
                                        <td>
                                            <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editBlogPost(${post.id})">Edit</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Error loading blog posts:', error);
            }
        }

        async function loadAppAttractions() {
            try {
                const response = await fetch(`/api/admin/attractions?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('app-attractions-list');
                if (!container) return;
                
                if (data.success && data.attractions && data.attractions.length > 0) {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                            ${data.attractions.map(attr => `
                                <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer; background: white;" onclick="editAttraction(${attr.id})">
                                    ${attr.featured_image_url ? 
                                        `<img src="${attr.featured_image_url}" style="width: 100%; height: 150px; object-fit: cover;">` :
                                        `<div style="width: 100%; height: 150px; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; font-size: 3rem;">üéØ</div>`
                                    }
                                    <div style="padding: 1rem;">
                                        <h4 style="margin: 0 0 0.5rem;">${attr.name}</h4>
                                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">
                                            ${attr.category ? `üìç ${attr.category}` : ''}
                                            ${attr.distance_text ? ` ‚Ä¢ ${attr.distance_text}` : ''}
                                        </p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading attractions:', error);
            }
        }

        // =====================================================
        // BRANDING FUNCTIONS
        // =====================================================

        async function loadBranding() {
            try {
                const response = await fetch(`/api/admin/branding?client_id=${getClientId()}`);
                const data = await response.json();
                
                if (data.success && data.branding) {
                    const b = data.branding;
                    
                    // Logo & Identity
                    document.getElementById('brand-logo-url').value = b.logo_url || '';
                    document.getElementById('brand-logo-dark-url').value = b.logo_dark_url || '';
                    document.getElementById('brand-favicon-url').value = b.favicon_url || '';
                    document.getElementById('brand-og-image-url').value = b.og_image_url || '';
                    document.getElementById('brand-site-title').value = b.site_title || '';
                    document.getElementById('brand-site-description').value = b.site_description || '';
                    
                    // Primary Colors
                    setColorInput('brand-primary-color', b.primary_color || '#2563eb');
                    setColorInput('brand-secondary-color', b.secondary_color || '#7c3aed');
                    setColorInput('brand-accent-color', b.accent_color || '#f59e0b');
                    
                    // Text & Background
                    setColorInput('brand-text-color', b.text_color || '#1e293b');
                    setColorInput('brand-text-light-color', b.text_light_color || '#64748b');
                    setColorInput('brand-background-color', b.background_color || '#ffffff');
                    setColorInput('brand-surface-color', b.surface_color || '#f8fafc');
                    
                    // Header
                    setColorInput('brand-header-bg', b.header_bg_color || '#ffffff');
                    setColorInput('brand-header-text', b.header_text_color || '#1e293b');
                    document.getElementById('brand-header-sticky').checked = b.header_sticky !== false;
                    document.getElementById('brand-header-transparent').checked = b.header_transparent_home || false;
                    
                    // Footer
                    setColorInput('brand-footer-bg', b.footer_bg_color || '#0f172a');
                    setColorInput('brand-footer-text', b.footer_text_color || '#ffffff');
                    setColorInput('brand-footer-link', b.footer_link_color || '#94a3b8');
                    setColorInput('brand-footer-link-hover', b.footer_link_hover_color || '#ffffff');
                    document.getElementById('brand-copyright').value = b.copyright_text || '';
                    
                    // Buttons
                    setColorInput('brand-btn-primary-bg', b.button_primary_bg || b.primary_color || '#2563eb');
                    setColorInput('brand-btn-primary-text', b.button_primary_text || '#ffffff');
                    setColorInput('brand-btn-primary-hover', b.button_primary_hover || '#1d4ed8');
                    setColorInput('brand-btn-secondary-text', b.button_secondary_text || b.primary_color || '#2563eb');
                    setColorInput('brand-btn-secondary-bg', b.button_secondary_bg || '#ffffff');
                    document.getElementById('brand-btn-radius').value = b.button_border_radius || '8px';
                    
                    // Typography
                    document.getElementById('brand-font-heading').value = b.font_heading || 'Inter';
                    document.getElementById('brand-font-body').value = b.font_body || 'Inter';
                    document.getElementById('brand-font-heading-weight').value = b.font_heading_weight || '700';
                    document.getElementById('brand-font-body-weight').value = b.font_body_weight || '400';
                    
                    // Custom CSS
                    document.getElementById('brand-custom-css').value = b.custom_css || '';
                    
                    // Update previews
                    updateBrandingPreviews();
                }
            } catch (error) {
                console.error('Error loading branding:', error);
            }
        }
        
        function setColorInput(baseId, value) {
            const colorInput = document.getElementById(baseId);
            const textInput = document.getElementById(baseId + '-text');
            if (colorInput) colorInput.value = value;
            if (textInput) textInput.value = value;
        }
        
        function updateBrandingPreviews() {
            // Update button previews
            const primaryBtn = document.getElementById('preview-btn-primary');
            const secondaryBtn = document.getElementById('preview-btn-secondary');
            const radius = document.getElementById('brand-btn-radius').value;
            
            if (primaryBtn) {
                primaryBtn.style.background = document.getElementById('brand-btn-primary-bg').value;
                primaryBtn.style.color = document.getElementById('brand-btn-primary-text').value;
                primaryBtn.style.borderRadius = radius;
            }
            
            if (secondaryBtn) {
                const textColor = document.getElementById('brand-btn-secondary-text').value;
                secondaryBtn.style.background = document.getElementById('brand-btn-secondary-bg').value;
                secondaryBtn.style.color = textColor;
                secondaryBtn.style.border = '2px solid ' + textColor;
                secondaryBtn.style.borderRadius = radius;
            }
            
            // Update typography preview
            const headingPreview = document.getElementById('preview-heading');
            const bodyPreview = document.getElementById('preview-body');
            
            if (headingPreview) {
                headingPreview.style.fontFamily = document.getElementById('brand-font-heading').value;
                headingPreview.style.fontWeight = document.getElementById('brand-font-heading-weight').value;
            }
            
            if (bodyPreview) {
                bodyPreview.style.fontFamily = document.getElementById('brand-font-body').value;
                bodyPreview.style.fontWeight = document.getElementById('brand-font-body-weight').value;
            }
        }

        async function saveBranding() {
            const brandData = {
                client_id: getClientId(),
                // Logo & Identity
                logo_url: document.getElementById('brand-logo-url').value,
                logo_dark_url: document.getElementById('brand-logo-dark-url').value,
                favicon_url: document.getElementById('brand-favicon-url').value,
                og_image_url: document.getElementById('brand-og-image-url').value,
                site_title: document.getElementById('brand-site-title').value,
                site_description: document.getElementById('brand-site-description').value,
                
                // Primary Colors
                primary_color: document.getElementById('brand-primary-color').value,
                secondary_color: document.getElementById('brand-secondary-color').value,
                accent_color: document.getElementById('brand-accent-color').value,
                
                // Text & Background
                text_color: document.getElementById('brand-text-color').value,
                text_light_color: document.getElementById('brand-text-light-color').value,
                background_color: document.getElementById('brand-background-color').value,
                surface_color: document.getElementById('brand-surface-color').value,
                
                // Header
                header_bg_color: document.getElementById('brand-header-bg').value,
                header_text_color: document.getElementById('brand-header-text').value,
                header_sticky: document.getElementById('brand-header-sticky').checked,
                header_transparent_home: document.getElementById('brand-header-transparent').checked,
                
                // Footer
                footer_bg_color: document.getElementById('brand-footer-bg').value,
                footer_text_color: document.getElementById('brand-footer-text').value,
                footer_link_color: document.getElementById('brand-footer-link').value,
                footer_link_hover_color: document.getElementById('brand-footer-link-hover').value,
                copyright_text: document.getElementById('brand-copyright').value,
                
                // Buttons
                button_primary_bg: document.getElementById('brand-btn-primary-bg').value,
                button_primary_text: document.getElementById('brand-btn-primary-text').value,
                button_primary_hover: document.getElementById('brand-btn-primary-hover').value,
                button_secondary_text: document.getElementById('brand-btn-secondary-text').value,
                button_secondary_bg: document.getElementById('brand-btn-secondary-bg').value,
                button_border_radius: document.getElementById('brand-btn-radius').value,
                
                // Typography
                font_heading: document.getElementById('brand-font-heading').value,
                font_body: document.getElementById('brand-font-body').value,
                font_heading_weight: document.getElementById('brand-font-heading-weight').value,
                font_body_weight: document.getElementById('brand-font-body-weight').value,
                
                // Custom CSS
                custom_css: document.getElementById('brand-custom-css').value
            };
            
            try {
                const response = await fetch('/api/admin/branding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(brandData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Branding saved!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving branding:', error);
            }
        }
        
        function previewBranding() {
            alert('Theme preview coming soon! Your changes are saved and will appear on the website immediately.');
        }
        
        // Add event listeners for live preview updates
        document.addEventListener('DOMContentLoaded', function() {
            // Color input sync
            document.querySelectorAll('input[type="color"]').forEach(colorInput => {
                colorInput.addEventListener('input', function() {
                    const textInput = document.getElementById(this.id + '-text');
                    if (textInput) textInput.value = this.value;
                    updateBrandingPreviews();
                });
            });
            
            // Select change handlers for previews
            ['brand-btn-radius', 'brand-font-heading', 'brand-font-body', 'brand-font-heading-weight', 'brand-font-body-weight'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', updateBrandingPreviews);
            });
        });

        // =====================================================
        // API FUNCTIONS
        // =====================================================

        async function loadApiKeys() {
            try {
                const response = await fetch(`/api/admin/api-keys?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('api-keys-list');
                if (!container) return;
                
                if (data.success && data.api_keys && data.api_keys.length > 0) {
                    container.innerHTML = `
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>API Key</th>
                                        <th>Last Used</th>
                                        <th>Requests</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.api_keys.map(key => `
                                        <tr>
                                            <td><strong>${key.key_name}</strong></td>
                                            <td>
                                                <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                                    ${key.api_key.substring(0, 12)}...
                                                </code>
                                                <button onclick="copyToClipboard('${key.api_key}')" style="background: none; border: none; cursor: pointer; margin-left: 0.25rem;">üìã</button>
                                            </td>
                                            <td style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${key.last_used_at ? new Date(key.last_used_at).toLocaleDateString() : 'Never'}
                                            </td>
                                            <td style="font-size: 0.85rem;">${key.total_requests?.toLocaleString() || 0}</td>
                                            <td>
                                                <span class="badge ${key.is_active ? 'badge-success' : 'badge-secondary'}">
                                                    ${key.is_active ? 'Active' : 'Disabled'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="toggleApiKey(${key.id}, ${!key.is_active})">
                                                    ${key.is_active ? 'Disable' : 'Enable'}
                                                </button>
                                                <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #ef4444;" onclick="deleteApiKey(${key.id})">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîê</div>
                            <p>No API keys yet. Create one to access secure endpoints.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }

        // Channel Manager Modal
        function openChannelManagerModal() {
            document.getElementById('channelManagerModal').style.display = 'flex';
        }

        function closeChannelManagerModal() {
            document.getElementById('channelManagerModal').style.display = 'none';
        }

        function openApiKeyModal() {
            document.getElementById('api-key-name').value = '';
            document.getElementById('api-key-rate-limit').value = '60';
            document.getElementById('api-key-origins').value = '';
            document.getElementById('api-key-edit-id').value = '';
            document.getElementById('perm-read-rooms').checked = true;
            document.getElementById('perm-read-availability').checked = true;
            document.getElementById('perm-read-pricing').checked = true;
            document.getElementById('perm-read-offers').checked = true;
            document.getElementById('perm-read-content').checked = true;
            document.getElementById('apiKeyModalTitle').textContent = 'Create API Key';
            document.getElementById('apiKeyModal').style.display = 'flex';
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }

        async function saveApiKey() {
            const name = document.getElementById('api-key-name').value;
            if (!name) {
                alert('Please enter a key name');
                return;
            }
            
            const permissions = [];
            if (document.getElementById('perm-read-rooms').checked) permissions.push('read:rooms');
            if (document.getElementById('perm-read-availability').checked) permissions.push('read:availability');
            if (document.getElementById('perm-read-pricing').checked) permissions.push('read:pricing');
            if (document.getElementById('perm-read-offers').checked) permissions.push('read:offers');
            if (document.getElementById('perm-read-content').checked) permissions.push('read:content');
            
            const originsText = document.getElementById('api-key-origins').value;
            const allowed_origins = originsText ? originsText.split(',').map(s => s.trim()).filter(Boolean) : [];
            
            const keyData = {
                client_id: getClientId(),
                key_name: name,
                permissions: permissions,
                rate_limit_per_minute: parseInt(document.getElementById('api-key-rate-limit').value) || 60,
                allowed_origins: allowed_origins
            };
            
            try {
                const response = await fetch('/api/admin/api-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(keyData)
                });
                
                const result = await response.json();
                if (result.success) {
                    closeApiKeyModal();
                    loadApiKeys();
                    
                    // Show the new key
                    alert('API Key Created!\n\nYour new key:\n' + result.api_key.api_key + '\n\nCopy this key now - you won\'t be able to see the full key again.');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating API key:', error);
                alert('Error creating API key');
            }
        }

        async function toggleApiKey(id, newState) {
            try {
                const response = await fetch(`/api/admin/api-keys/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: newState })
                });
                
                const result = await response.json();
                if (result.success) {
                    loadApiKeys();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error toggling API key:', error);
            }
        }

        async function deleteApiKey(id) {
            if (!confirm('Are you sure you want to delete this API key? Any applications using it will stop working.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/api-keys/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    loadApiKeys();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting API key:', error);
            }
        }

        function showApiTab(tab) {
            // Update buttons
            ['rooms', 'availability', 'pricing', 'offers', 'content'].forEach(t => {
                const btn = document.getElementById('api-tab-' + t);
                if (btn) btn.style.background = t === tab ? 'var(--accent)' : '#64748b';
            });
            
            // Show/hide sections
            document.querySelectorAll('.api-endpoints-section').forEach(el => el.style.display = 'none');
            const section = document.getElementById('api-endpoints-' + tab);
            if (section) section.style.display = 'block';
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Copied!');
            });
        }

        async function testApiConnection() {
            try {
                const response = await fetch('/api/public/client/1/rooms');
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ API Connection Successful!\n\nFound ' + (data.rooms?.length || 0) + ' rooms.');
                } else {
                    alert('‚ùå API Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Connection Failed: ' + error.message);
            }
        }

        function copyApiUrl() {
            copyToClipboard(document.getElementById('api-docs-base-url').value);
        }

        // =====================================================
        // KNOWLEDGE BASE FUNCTIONS
        // =====================================================

        async function setupKnowledgeBase() {
            try {
                const response = await fetch('/api/setup-knowledge-base');
                const data = await response.json();
                if (data.success) {
                    showNotification('Knowledge base tables created!', 'success');
                    loadKBArticles();
                    loadKBCategories();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error setting up knowledge base', 'error');
            }
        }

        async function loadKBCategories() {
            try {
                const response = await fetch('/api/kb/categories');
                const data = await response.json();
                if (data.success) {
                    // Populate filter dropdown
                    const filterSelect = document.getElementById('kb-category-filter');
                    const articleSelect = document.getElementById('kb-article-category');
                    
                    if (filterSelect) {
                        filterSelect.innerHTML = '<option value="">All Categories</option>' +
                            data.data.map(c => `<option value="${c.id}">${c.icon || ''} ${c.name} (${c.article_count || 0})</option>`).join('');
                    }
                    
                    if (articleSelect) {
                        articleSelect.innerHTML = '<option value="">Select category...</option>' +
                            data.data.map(c => `<option value="${c.id}">${c.icon || ''} ${c.name}</option>`).join('');
                    }
                    
                    // Update stats
                    document.getElementById('kb-category-count').textContent = data.data.length;
                }
            } catch (error) {
                console.error('Error loading KB categories:', error);
            }
        }

        async function loadKBArticles() {
            try {
                const categoryId = document.getElementById('kb-category-filter')?.value || '';
                const search = document.getElementById('kb-search')?.value || '';
                
                let url = '/api/kb/articles?status=published';
                if (categoryId) url += '&category_id=' + categoryId;
                if (search) url += '&search=' + encodeURIComponent(search);
                
                const response = await fetch(url);
                const data = await response.json();
                
                const tbody = document.getElementById('kb-articles-table');
                if (!tbody) return;
                
                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(article => `
                        <tr>
                            <td>
                                <strong>${article.title}</strong>
                                ${article.summary ? `<br><small style="color: var(--text-secondary);">${article.summary.substring(0, 80)}...</small>` : ''}
                            </td>
                            <td>${article.category_icon || ''} ${article.category_name || 'Uncategorized'}</td>
                            <td>
                                <span class="badge ${article.status === 'published' ? 'badge-success' : 'badge-warning'}">
                                    ${article.status}
                                </span>
                            </td>
                            <td>${article.views || 0}</td>
                            <td>
                                <span style="color: var(--success);">üëç ${article.helpful_yes || 0}</span>
                                <span style="color: var(--error); margin-left: 0.5rem;">üëé ${article.helpful_no || 0}</span>
                            </td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editKBArticle(${article.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: var(--error);" onclick="deleteKBArticle(${article.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                    
                    document.getElementById('kb-article-count').textContent = data.data.length;
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No articles found. Click "Setup Tables" first, then add articles.</td></tr>';
                    document.getElementById('kb-article-count').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading KB articles:', error);
            }
        }

        function openKBArticleModal(articleId = null) {
            document.getElementById('kb-article-id').value = '';
            document.getElementById('kb-article-title').value = '';
            document.getElementById('kb-article-summary').value = '';
            document.getElementById('kb-article-content').value = '';
            document.getElementById('kb-article-keywords').value = '';
            document.getElementById('kb-article-status').value = 'published';
            document.getElementById('kb-article-category').value = '';
            document.getElementById('kb-article-modal-title').textContent = 'üìö Add Knowledge Article';
            
            loadKBCategories();
            openModal('kbArticleModal');
        }

        async function editKBArticle(id) {
            try {
                const response = await fetch('/api/kb/articles/' + id);
                const data = await response.json();
                
                if (data.success) {
                    const article = data.data;
                    document.getElementById('kb-article-id').value = article.id;
                    document.getElementById('kb-article-title').value = article.title;
                    document.getElementById('kb-article-summary').value = article.summary || '';
                    document.getElementById('kb-article-content').value = article.content;
                    document.getElementById('kb-article-keywords').value = (article.keywords || []).join(', ');
                    document.getElementById('kb-article-status').value = article.status;
                    document.getElementById('kb-article-modal-title').textContent = 'üìù Edit Article';
                    
                    await loadKBCategories();
                    document.getElementById('kb-article-category').value = article.category_id || '';
                    
                    openModal('kbArticleModal');
                }
            } catch (error) {
                showNotification('Error loading article', 'error');
            }
        }

        async function saveKBArticle(event) {
            event.preventDefault();
            
            const id = document.getElementById('kb-article-id').value;
            const keywords = document.getElementById('kb-article-keywords').value
                .split(',')
                .map(k => k.trim().toLowerCase())
                .filter(k => k.length > 0);
            
            const articleData = {
                id: id || undefined,
                title: document.getElementById('kb-article-title').value,
                category_id: document.getElementById('kb-article-category').value || null,
                summary: document.getElementById('kb-article-summary').value,
                content: document.getElementById('kb-article-content').value,
                keywords: keywords,
                status: document.getElementById('kb-article-status').value
            };
            
            try {
                const response = await fetch('/api/kb/articles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(articleData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Article saved!', 'success');
                    closeModal('kbArticleModal');
                    loadKBArticles();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving article', 'error');
            }
        }

        async function deleteKBArticle(id) {
            if (!confirm('Delete this article? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/kb/articles/' + id, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Article deleted', 'success');
                    loadKBArticles();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error deleting article', 'error');
            }
        }

        function openKBImportModal() {
            document.getElementById('kb-import-json').value = '';
            document.getElementById('kb-import-result').style.display = 'none';
            openModal('kbImportModal');
        }

        async function importKBArticles() {
            const jsonText = document.getElementById('kb-import-json').value.trim();
            const resultDiv = document.getElementById('kb-import-result');
            
            if (!jsonText) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fef2f2';
                resultDiv.innerHTML = '‚ùå Please paste JSON data';
                return;
            }
            
            try {
                const articles = JSON.parse(jsonText);
                
                if (!Array.isArray(articles)) {
                    throw new Error('JSON must be an array');
                }
                
                const response = await fetch('/api/kb/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ articles })
                });
                
                const data = await response.json();
                
                resultDiv.style.display = 'block';
                if (data.success) {
                    resultDiv.style.background = '#f0fdf4';
                    resultDiv.innerHTML = `‚úÖ Imported ${data.imported} articles` +
                        (data.errors?.length ? `<br>‚ö†Ô∏è ${data.errors.length} errors` : '');
                    loadKBArticles();
                    loadKBCategories();
                } else {
                    resultDiv.style.background = '#fef2f2';
                    resultDiv.innerHTML = '‚ùå ' + data.error;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fef2f2';
                resultDiv.innerHTML = '‚ùå Invalid JSON: ' + error.message;
            }
        }

        async function loadKBUnanswered() {
            try {
                const status = document.getElementById('kb-unanswered-filter')?.value || 'new';
                const response = await fetch('/api/kb/unanswered' + (status ? '?status=' + status : ''));
                const data = await response.json();
                
                const container = document.getElementById('kb-unanswered-list');
                const countEl = document.getElementById('kb-unanswered-count');
                const totalEl = document.getElementById('kb-unanswered-total');
                
                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(q => `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <p style="margin: 0 0 0.5rem 0; font-weight: 500;">"${q.question}"</p>
                                    <small style="color: var(--text-secondary);">
                                        Asked ${q.times_asked}x ¬∑ ${new Date(q.created_at).toLocaleDateString()}
                                    </small>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;" onclick="createArticleFromQuestion(${q.id}, '${q.question.replace(/'/g, "\\'")}')">
                                        + Create Article
                                    </button>
                                    <button class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;" onclick="dismissQuestion(${q.id})">
                                        Dismiss
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    if (countEl) countEl.textContent = data.data.length;
                    if (totalEl) totalEl.textContent = data.data.length + ' questions';
                } else {
                    container.innerHTML = '<div class="card" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No unanswered questions! üéâ</div>';
                    if (countEl) countEl.textContent = '0';
                    if (totalEl) totalEl.textContent = '0 questions';
                }
            } catch (error) {
                console.error('Error loading unanswered:', error);
            }
        }

        function createArticleFromQuestion(questionId, questionText) {
            openKBArticleModal();
            document.getElementById('kb-article-title').value = questionText;
            // Store question ID to resolve after saving
            document.getElementById('kb-article-form').dataset.resolveQuestionId = questionId;
        }

        async function dismissQuestion(id) {
            if (!confirm('Dismiss this question?')) return;
            
            try {
                const response = await fetch('/api/kb/unanswered/' + id, { method: 'DELETE' });
                if (response.ok) {
                    showNotification('Question dismissed', 'success');
                    loadKBUnanswered();
                }
            } catch (error) {
                showNotification('Error dismissing question', 'error');
            }
        }

        // Load KB data when switching to KB views
        const originalNavClick = navClick;
        navClick = function(element, view) {
            originalNavClick(element, view);
            if (view === 'kb-articles') {
                loadKBCategories();
                loadKBArticles();
            } else if (view === 'kb-unanswered') {
                loadKBUnanswered();
            } else if (view === 'billing-overview') {
                loadBillingOverview();
            } else if (view === 'billing-plans') {
                loadBillingPlans();
            } else if (view === 'billing-credits') {
                loadCreditPackages();
            } else if (view === 'billing-extras') {
                loadBillingExtras();
            } else if (view === 'my-billing') {
                loadMyBilling();
            }
        };

        // Show admin billing sections for master_admin only
        function updateBillingNavVisibility() {
            // Check both possible storage keys and currentAccount
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || localStorage.getItem('gas_user') || '{}');
            const isMasterAdmin = user.role === 'master_admin';
            
            document.querySelectorAll('.billing-admin-only').forEach(el => {
                el.style.display = isMasterAdmin ? 'flex' : 'none';
            });
        }
        
        // Call on page load (will be called again after auth)
        updateBillingNavVisibility();

        // =====================================================
        // FEATURE ENTITLEMENTS
        // =====================================================
        
        let accountEntitlements = null;
        
        // Load entitlements for the current/selected account
        async function loadAccountEntitlements() {
            const accountId = selectedAccountId || (currentAccount ? currentAccount.id : null);
            
            if (!accountId) {
                // No subscription - lock all premium features
                accountEntitlements = { features: {} };
                applyFeatureLocks();
                return;
            }
            
            try {
                const response = await fetch(`/api/account/${accountId}/entitlements`);
                const data = await response.json();
                
                if (data.success) {
                    accountEntitlements = data;
                } else {
                    accountEntitlements = { features: {} };
                }
            } catch (error) {
                console.error('Error loading entitlements:', error);
                accountEntitlements = { features: {} };
            }
            
            applyFeatureLocks();
        }
        
        // Apply locked state to nav items based on entitlements
        function applyFeatureLocks() {
            const features = accountEntitlements?.features || {};
            const hasPlan = accountEntitlements?.plan != null;
            
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            
            // If master_admin with NO account selected, show everything unlocked
            if (user.role === 'master_admin' && !selectedAccountId) {
                document.querySelectorAll('[data-requires-feature]').forEach(el => {
                    el.classList.remove('feature-locked');
                    const lock = el.querySelector('.feature-lock');
                    if (lock) lock.style.display = 'none';
                });
                return;
            }
            
            // Otherwise, show locks based on selected account's entitlements
            document.querySelectorAll('[data-requires-feature]').forEach(el => {
                const requiredFeature = el.getAttribute('data-requires-feature');
                
                // Check access based on feature type
                let hasAccess = false;
                if (requiredFeature === 'has_subscription') {
                    hasAccess = hasPlan;
                } else if (requiredFeature === 'api_access') {
                    hasAccess = features.api_access === true;
                } else {
                    hasAccess = features[requiredFeature] === true;
                }
                
                if (hasAccess) {
                    el.classList.remove('feature-locked');
                    const lock = el.querySelector('.feature-lock');
                    if (lock) lock.style.display = 'none';
                } else {
                    el.classList.add('feature-locked');
                    const lock = el.querySelector('.feature-lock');
                    if (lock) lock.style.display = 'inline';
                }
            });
        }
        
        // Handle click on feature-gated nav items
        function handleFeatureClick(element, viewName, featureName) {
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            
            // Master admin with no account selected - always has access
            if (user.role === 'master_admin' && !selectedAccountId) {
                navClick(element, viewName);
                return false;
            }
            
            const features = accountEntitlements?.features || {};
            const hasPlan = accountEntitlements?.plan != null;
            
            // Check access based on feature type
            let hasAccess = false;
            if (featureName === 'has_subscription') {
                hasAccess = hasPlan;
            } else if (featureName === 'api_access') {
                hasAccess = features.api_access === true;
            } else {
                hasAccess = features[featureName] === true;
            }
            
            if (hasAccess) {
                navClick(element, viewName);
            } else {
                // Show upgrade prompt
                const featureNames = {
                    'blog_module': 'Blog Module',
                    'attractions_module': 'Attractions Module', 
                    'reviews_widget': 'Reviews Widget',
                    'has_subscription': 'WordPress Integration',
                    'api_access': 'API Access'
                };
                const planRequired = {
                    'blog_module': 'Professional',
                    'attractions_module': 'Business',
                    'reviews_widget': 'Enterprise',
                    'has_subscription': 'any',
                    'api_access': 'with API access enabled'
                };
                
                const name = featureNames[featureName] || featureName;
                const plan = planRequired[featureName] || 'a higher';
                
                // Different messages based on feature type
                if (user.role === 'master_admin') {
                    if (featureName === 'has_subscription') {
                        showNotification(`üîí This account needs an active subscription for ${name}.`, 'warning', 5000);
                    } else if (featureName === 'api_access') {
                        showNotification(`üîí API Access is not enabled for this account. Enable it in account settings.`, 'warning', 5000);
                    } else {
                        showNotification(`üîí This account doesn't have ${name}. Assign ${plan} plan or above.`, 'warning', 5000);
                    }
                } else {
                    if (featureName === 'has_subscription') {
                        showNotification(`üîí ${name} requires an active subscription. Go to Billing to subscribe.`, 'warning', 5000);
                    } else if (featureName === 'api_access') {
                        showNotification(`üîí API Access is not enabled for your account. Contact support.`, 'warning', 5000);
                    } else {
                        showNotification(`üîí ${name} requires ${plan} plan or above. Go to Billing > Plans & Extras to upgrade.`, 'warning', 5000);
                    }
                }
            }
            return false;
        }
        
        // Call after auth and when account selection changes
        loadAccountEntitlements();

        // =====================================================
        // INSTAWP INTEGRATION
        // =====================================================
        
        let instaWPSettingsVisible = false;
        
        function toggleInstaWPSettings() {
            instaWPSettingsVisible = !instaWPSettingsVisible;
            document.getElementById('instawp-settings-panel').style.display = instaWPSettingsVisible ? 'block' : 'none';
            document.getElementById('instawp-toggle-text').textContent = instaWPSettingsVisible ? 'Hide Settings' : 'Show Settings';
            
            if (instaWPSettingsVisible) {
                loadInstaWPSettings();
            }
        }
        
        async function loadInstaWPSettings() {
            try {
                const response = await fetch('/api/admin/instawp/settings');
                const data = await response.json();
                
                if (data.success && data.data) {
                    if (document.getElementById('instawp-api-url')) {
                        document.getElementById('instawp-api-url').value = data.data.api_url || 'https://sites.gas.travel/gas-api.php';
                    }
                    document.getElementById('instawp-api-key').value = data.data.api_key || '';
                    document.getElementById('instawp-default-template').value = data.data.default_template || '';
                    document.getElementById('instawp-enabled').checked = data.data.is_enabled || false;
                }
            } catch (error) {
                console.error('Error loading WordPress settings:', error);
            }
        }
        
        async function saveInstaWPSettings() {
            try {
                const response = await fetch('/api/admin/instawp/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_url: document.getElementById('instawp-api-url')?.value || 'https://sites.gas.travel/gas-api.php',
                        api_key: document.getElementById('instawp-api-key').value,
                        default_template: document.getElementById('instawp-default-template').value,
                        templates: {},
                        is_enabled: document.getElementById('instawp-enabled').checked
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('WordPress hosting settings saved!', 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        }
        
        // Load account website status when WordPress view is shown
        async function loadAccountWebsite() {
            const section = document.getElementById('wp-website-section');
            const noWebsite = document.getElementById('wp-no-website');
            const hasWebsite = document.getElementById('wp-has-website');
            const creating = document.getElementById('wp-website-creating');
            
            // Only show for selected accounts or non-master-admin users
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            const accountId = selectedAccountId || (user.role !== 'master_admin' ? user.id : null);
            
            if (!accountId) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            noWebsite.style.display = 'none';
            hasWebsite.style.display = 'none';
            creating.style.display = 'none';
            
            try {
                const response = await fetch(`/api/account/${accountId}/website`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const website = data.data;
                    
                    if (website.status === 'creating') {
                        creating.style.display = 'block';
                    } else {
                        hasWebsite.style.display = 'block';
                        
                        document.getElementById('wp-website-url').href = website.site_url || '#';
                        document.getElementById('wp-website-url').textContent = website.site_url || '-';
                        document.getElementById('wp-website-admin').href = website.admin_url || '#';
                        document.getElementById('wp-website-template').textContent = website.template_used || '-';
                        document.getElementById('wp-website-visit-btn').href = website.site_url || '#';
                        document.getElementById('wp-website-admin-btn').href = website.admin_url || '#';
                        
                        const statusBadge = document.getElementById('wp-website-status');
                        statusBadge.textContent = website.status;
                        statusBadge.className = 'badge ' + (website.status === 'active' ? 'badge-success' : 'badge-warning');
                    }
                } else {
                    noWebsite.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading website:', error);
                noWebsite.style.display = 'block';
            }
        }
        
        function openCreateWebsiteModal() {
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            const accountId = selectedAccountId || user.id;
            const accountName = selectedAccountName || user.name;
            
            document.getElementById('create-website-account-name').textContent = accountName;
            document.getElementById('create-website-name').value = accountName.toLowerCase().replace(/[^a-z0-9]/g, '');
            updateWebsitePreview();
            
            openModal('createWebsiteModal');
        }
        
        function updateWebsitePreview() {
            const name = document.getElementById('create-website-name').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
            document.getElementById('create-website-preview').textContent = name || 'yoursite';
        }
        
        // Add event listener for site name input
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('create-website-name');
            if (nameInput) {
                nameInput.addEventListener('input', updateWebsitePreview);
            }
        });
        
        async function createWebsite() {
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            const accountId = selectedAccountId || user.id;
            
            const siteName = document.getElementById('create-website-name').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
            const template = document.getElementById('create-website-template').value;
            
            if (!siteName) {
                showNotification('Please enter a site name', 'error');
                return;
            }
            
            const btn = document.getElementById('create-website-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Creating...';
            
            try {
                const response = await fetch('/api/admin/instawp/create-site', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: accountId,
                        site_name: siteName,
                        template_slug: template || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('üéâ Website creation started!', 'success');
                    closeModal('createWebsiteModal');
                    loadAccountWebsite();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error creating website', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Create Website';
            }
        }
        
        async function refreshWebsiteStatus() {
            showNotification('Checking website status...', 'info', 2000);
            await loadAccountWebsite();
        }

        // =====================================================
        // PROPERTY PAYMENT SETTINGS
        // =====================================================
        
        let currentPaymentPropertyId = null;
        
        async function openPaymentSettings(propertyId, propertyName) {
            currentPaymentPropertyId = propertyId;
            document.getElementById('payment-settings-property-id').value = propertyId;
            document.getElementById('payment-settings-property-name').textContent = propertyName;
            
            // Reset form
            document.getElementById('payment-enabled').checked = true;
            document.getElementById('payment-deposit-type').value = 'percentage';
            document.getElementById('payment-deposit-amount').value = 25;
            document.getElementById('payment-balance-days').value = 14;
            document.getElementById('payment-currency').value = 'GBP';
            document.getElementById('payment-method-card').checked = true;
            document.getElementById('payment-cancellation').value = '';
            
            // Load existing settings
            try {
                const response = await fetch(`/api/property/${propertyId}/payment-settings`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const settings = data.data;
                    document.getElementById('payment-enabled').checked = settings.payment_enabled !== false;
                    document.getElementById('payment-deposit-type').value = settings.deposit_type || 'percentage';
                    document.getElementById('payment-deposit-amount').value = settings.deposit_amount || 25;
                    document.getElementById('payment-balance-days').value = settings.balance_due_days || 14;
                    document.getElementById('payment-currency').value = settings.currency || 'GBP';
                    document.getElementById('payment-cancellation').value = settings.cancellation_policy || '';
                    
                    // Payment methods
                    const methods = settings.accepted_methods || ['card'];
                    document.getElementById('payment-method-card').checked = methods.includes('card');
                    
                    // Stripe status
                    if (settings.stripe_connected) {
                        document.getElementById('stripe-not-connected').style.display = 'none';
                        document.getElementById('stripe-connected').style.display = 'block';
                    } else {
                        document.getElementById('stripe-not-connected').style.display = 'flex';
                        document.getElementById('stripe-connected').style.display = 'none';
                    }
                    
                    updateDepositSymbol();
                }
            } catch (error) {
                console.error('Error loading payment settings:', error);
            }
            
            openModal('paymentSettingsModal');
        }
        
        function updateDepositSymbol() {
            const type = document.getElementById('payment-deposit-type').value;
            const symbol = document.getElementById('payment-deposit-symbol');
            const amountInput = document.getElementById('payment-deposit-amount');
            
            if (type === 'percentage') {
                symbol.textContent = '%';
                amountInput.max = 100;
            } else if (type === 'fixed') {
                const currency = document.getElementById('payment-currency').value;
                symbol.textContent = currency === 'GBP' ? '¬£' : currency === 'EUR' ? '‚Ç¨' : currency === 'USD' ? '$' : currency;
                amountInput.max = 99999;
            } else if (type === 'full' || type === 'none') {
                symbol.textContent = '';
                amountInput.disabled = true;
            }
            
            if (type !== 'full' && type !== 'none') {
                amountInput.disabled = false;
            }
        }
        
        // Add event listener for deposit type change
        document.addEventListener('DOMContentLoaded', function() {
            const depositType = document.getElementById('payment-deposit-type');
            if (depositType) {
                depositType.addEventListener('change', updateDepositSymbol);
            }
            const currencySelect = document.getElementById('payment-currency');
            if (currencySelect) {
                currencySelect.addEventListener('change', updateDepositSymbol);
            }
        });
        
        async function savePaymentSettings() {
            const propertyId = document.getElementById('payment-settings-property-id').value;
            
            const acceptedMethods = [];
            if (document.getElementById('payment-method-card').checked) acceptedMethods.push('card');
            
            const settings = {
                payment_enabled: document.getElementById('payment-enabled').checked,
                deposit_type: document.getElementById('payment-deposit-type').value,
                deposit_amount: parseFloat(document.getElementById('payment-deposit-amount').value) || 25,
                balance_due_days: parseInt(document.getElementById('payment-balance-days').value) || 14,
                currency: document.getElementById('payment-currency').value,
                accepted_methods: acceptedMethods,
                cancellation_policy: document.getElementById('payment-cancellation').value
            };
            
            try {
                const response = await fetch(`/api/property/${propertyId}/payment-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Payment settings saved!', 'success');
                    closeModal('paymentSettingsModal');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        }
        
        function connectStripe() {
            // For now, just show a message - Stripe Connect implementation later
            showNotification('Stripe Connect integration coming soon! Contact support for setup assistance.', 'info', 5000);
        }

        // Load client-facing billing page
        async function loadMyBilling() {
            // Load plans
            try {
                const plansRes = await fetch('/api/billing/plans');
                const plansData = await plansRes.json();
                
                const plansContainer = document.getElementById('my-billing-plans');
                if (plansData.success && plansData.data.length > 0) {
                    plansContainer.innerHTML = plansData.data.map(plan => {
                        let features = plan.features;
                        if (typeof features === 'string') {
                            try { features = JSON.parse(features); } catch(e) { features = {}; }
                        }
                        
                        // Handle both old array format and new object format
                        let featuresList = [];
                        if (Array.isArray(features)) {
                            featuresList = features;
                        } else if (features && features.features_list) {
                            featuresList = features.features_list;
                        }
                        
                        const currencySymbol = plan.currency === 'GBP' ? '¬£' : plan.currency === 'EUR' ? '‚Ç¨' : '$';
                        return `
                        <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.2rem;">${plan.name}</h4>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">${plan.description || ''}</p>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent);">
                                ${currencySymbol}${parseFloat(plan.price_monthly).toFixed(2)}
                                <span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">/mo</span>
                            </div>
                            ${plan.price_yearly ? `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1rem;">or ${currencySymbol}${parseFloat(plan.price_yearly).toFixed(2)}/year</div>` : '<div style="margin-bottom: 1rem;"></div>'}
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                ${plan.max_properties ? plan.max_properties + ' properties' : 'Unlimited properties'}
                            </div>
                            <ul style="text-align: left; font-size: 0.8rem; color: var(--text-secondary); margin: 0 0 1rem 0; padding-left: 1.2rem;">
                                ${featuresList.slice(0, 5).map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <button class="btn" style="width: 100%;" onclick="contactForPlan('${plan.name}')">Get Started</button>
                        </div>
                    `}).join('');
                } else {
                    plansContainer.innerHTML = '<p style="color: var(--text-secondary);">No plans available</p>';
                }
            } catch (e) {
                console.error('Error loading plans:', e);
            }
            
            // Load credit packages
            try {
                const creditsRes = await fetch('/api/billing/credit-packages');
                const creditsData = await creditsRes.json();
                
                const creditsContainer = document.getElementById('my-billing-credits');
                if (creditsData.success && creditsData.data.length > 0) {
                    creditsContainer.innerHTML = creditsData.data.map(pkg => {
                        const currencySymbol = pkg.currency === 'GBP' ? '¬£' : pkg.currency === 'EUR' ? '‚Ç¨' : '$';
                        const totalCredits = pkg.credits + (pkg.bonus_credits || 0);
                        return `
                        <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1.25rem; text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.25rem;">ü™ô</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${totalCredits}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">credits</div>
                            ${pkg.bonus_credits > 0 ? `<div style="font-size: 0.75rem; color: var(--success); margin-bottom: 0.5rem;">+${pkg.bonus_credits} bonus!</div>` : ''}
                            <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">${currencySymbol}${parseFloat(pkg.price).toFixed(2)}</div>
                            <button class="btn btn-secondary" style="width: 100%;" onclick="contactForCredits('${pkg.name}')">Buy</button>
                        </div>
                    `}).join('');
                } else {
                    creditsContainer.innerHTML = '<p style="color: var(--text-secondary);">No credit packages available</p>';
                }
            } catch (e) {
                console.error('Error loading credits:', e);
            }
            
            // Load extras
            try {
                const extrasRes = await fetch('/api/billing/extras');
                const extrasData = await extrasRes.json();
                
                const extrasContainer = document.getElementById('my-billing-extras');
                if (extrasData.success && extrasData.data.length > 0) {
                    extrasContainer.innerHTML = extrasData.data.map(extra => `
                        <div style="border: 1px solid var(--border); border-radius: 12px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;">${extra.icon || 'üì¶'}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${extra.name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${extra.description || ''}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: 700; color: var(--warning);">${extra.credit_cost}</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">credits</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    extrasContainer.innerHTML = '<p style="color: var(--text-secondary);">No extras available</p>';
                }
            } catch (e) {
                console.error('Error loading extras:', e);
            }
        }

        // Placeholder functions for purchase actions
        function contactForPlan(planName) {
            alert('To subscribe to the ' + planName + ' plan, please contact us at support@example.com');
        }

        function contactForCredits(packageName) {
            alert('To purchase ' + packageName + ', please contact us at support@example.com');
        }

        // =====================================================
        // BILLING FUNCTIONS
        // =====================================================

        // Show notification toast
        function showNotification(message, type = 'info', duration = 3000) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 400px;
            `;
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            } else if (type === 'warning') {
                notification.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else {
                notification.style.background = 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after duration
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        async function setupBilling() {
            console.log('setupBilling called');
            try {
                const response = await fetch('/api/setup-billing');
                console.log('Response:', response);
                const data = await response.json();
                console.log('Data:', data);
                if (data.success) {
                    showNotification('Billing tables created!', 'success');
                    loadBillingOverview();
                    loadBillingPlans();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Setup billing error:', error);
                showNotification('Error setting up billing: ' + error.message, 'error');
                alert('Error: ' + error.message);
            }
        }

        async function loadBillingOverview() {
            try {
                const response = await fetch('/api/admin/billing/overview');
                const data = await response.json();
                
                // Hide setup button if we have data
                const setupSection = document.getElementById('billing-setup-section');
                if (setupSection) {
                    if (data.success) {
                        setupSection.style.display = 'none';
                    } else {
                        setupSection.style.display = 'block';
                    }
                }
                
                if (data.success) {
                    // Update MRR
                    document.getElementById('billing-mrr').textContent = '¬£' + data.mrr.toFixed(2);
                    
                    // Update active subs count
                    const totalSubs = data.subscriptions_by_plan.reduce((sum, p) => sum + parseInt(p.count), 0);
                    document.getElementById('billing-active-subs').textContent = totalSubs;
                    
                    // Update credits in circulation
                    document.getElementById('billing-credits-circulation').textContent = data.credits?.total_balance || 0;
                    
                    // Subscriptions by plan
                    const subsByPlan = document.getElementById('billing-subs-by-plan');
                    if (data.subscriptions_by_plan.length > 0) {
                        subsByPlan.innerHTML = data.subscriptions_by_plan.map(p => `
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                                <span>${p.name}</span>
                                <span><strong>${p.count}</strong> subscribers √ó ¬£${parseFloat(p.price_monthly).toFixed(2)} = <strong>¬£${parseFloat(p.mrr).toFixed(2)}</strong>/mo</span>
                            </div>
                        `).join('');
                    } else {
                        subsByPlan.innerHTML = '<p style="color: var(--text-secondary);">No active subscriptions yet</p>';
                    }
                    
                    // Recent payments
                    const paymentsTable = document.getElementById('billing-recent-payments');
                    if (data.recent_payments.length > 0) {
                        paymentsTable.innerHTML = data.recent_payments.map(p => `
                            <tr>
                                <td>${p.account_name}</td>
                                <td>¬£${parseFloat(p.amount).toFixed(2)}</td>
                                <td><span class="badge">${p.type}</span></td>
                                <td>${new Date(p.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('');
                    } else {
                        paymentsTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No payments yet</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading billing overview:', error);
            }
        }

        // Plans
        async function loadBillingPlans() {
            try {
                const response = await fetch('/api/admin/billing/plans');
                const data = await response.json();
                
                const container = document.getElementById('billing-plans-list');
                
                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(plan => {
                        let features = plan.features;
                        if (typeof features === 'string') {
                            try { features = JSON.parse(features); } catch(e) { features = {}; }
                        }
                        
                        // Handle both old array format and new object format
                        let featuresList = [];
                        if (Array.isArray(features)) {
                            featuresList = features;
                        } else if (features.features_list) {
                            featuresList = features.features_list;
                        } else {
                            // Build from object
                            if (features.properties) featuresList.push(features.properties === null ? 'Unlimited properties' : features.properties + ' properties');
                            if (features.websites) featuresList.push(features.websites + ' website' + (features.websites > 1 ? 's' : ''));
                            if (features.booking_plugin) featuresList.push('Booking plugin');
                            if (features.blog_module) featuresList.push('Blog module');
                            if (features.attractions_module) featuresList.push('Attractions module');
                            if (features.reviews_widget) featuresList.push('Reviews widget');
                            if (features.support) featuresList.push(features.support.charAt(0).toUpperCase() + features.support.slice(1) + ' support');
                            if (features.free_trial) featuresList.push('14-day free trial');
                            if (features.white_label) featuresList.push('White-label');
                        }
                        
                        return `
                        <div class="card" style="position: relative; ${!plan.is_active ? 'opacity: 0.6;' : ''}">
                            <div style="position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="editPlan(${plan.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--error);" onclick="deletePlan(${plan.id})">√ó</button>
                            </div>
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem;">${plan.name}</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">${plan.description || ''}</p>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem;">
                                ¬£${parseFloat(plan.price_monthly).toFixed(2)}<span style="font-size: 1rem; font-weight: 400; color: var(--text-secondary);">/mo</span>
                            </div>
                            ${plan.price_yearly ? `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">or ¬£${parseFloat(plan.price_yearly).toFixed(2)}/year</div>` : ''}
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                <strong>Max properties:</strong> ${plan.max_properties || 'Unlimited'}
                            </div>
                            <ul style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; padding-left: 1.25rem;">
                                ${featuresList.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            ${!plan.is_active ? '<div style="margin-top: 1rem;"><span class="badge badge-warning">Inactive</span></div>' : ''}
                        </div>
                    `}).join('');
                } else {
                    container.innerHTML = '<div class="card" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No plans configured. Click "Setup Billing" in Overview first.</div>';
                }
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }

        function openPlanModal() {
            document.getElementById('plan-id').value = '';
            document.getElementById('plan-name').value = '';
            document.getElementById('plan-slug').value = '';
            document.getElementById('plan-description').value = '';
            document.getElementById('plan-price-monthly').value = '';
            document.getElementById('plan-price-yearly').value = '';
            document.getElementById('plan-currency').value = 'GBP';
            document.getElementById('plan-max-properties').value = '';
            document.getElementById('plan-features').value = '';
            document.getElementById('plan-sort-order').value = '0';
            document.getElementById('plan-is-active').checked = true;
            document.getElementById('plan-modal-title').textContent = 'üí≥ Add Subscription Plan';
            openModal('billingPlanModal');
        }

        async function editPlan(id) {
            try {
                const response = await fetch('/api/admin/billing/plans');
                const data = await response.json();
                const plan = data.data.find(p => p.id === id);
                
                if (plan) {
                    document.getElementById('plan-id').value = plan.id;
                    document.getElementById('plan-name').value = plan.name;
                    document.getElementById('plan-slug').value = plan.slug;
                    document.getElementById('plan-description').value = plan.description || '';
                    document.getElementById('plan-price-monthly').value = plan.price_monthly;
                    document.getElementById('plan-price-yearly').value = plan.price_yearly || '';
                    document.getElementById('plan-currency').value = plan.currency || 'GBP';
                    document.getElementById('plan-max-properties').value = plan.max_properties || '';
                    document.getElementById('plan-sort-order').value = plan.sort_order || 0;
                    document.getElementById('plan-is-active').checked = plan.is_active;
                    
                    // Handle features - can be array or object with features_list
                    let features = typeof plan.features === 'string' ? JSON.parse(plan.features) : (plan.features || {});
                    let featuresList = [];
                    if (Array.isArray(features)) {
                        featuresList = features;
                    } else if (features.features_list) {
                        featuresList = features.features_list;
                    }
                    document.getElementById('plan-features').value = featuresList.join('\n');
                    
                    document.getElementById('plan-modal-title').textContent = 'üí≥ Edit Plan';
                    openModal('billingPlanModal');
                }
            } catch (error) {
                console.error('Error editing plan:', error);
                showNotification('Error loading plan', 'error');
            }
        }

        async function savePlan(event) {
            event.preventDefault();
            
            const featuresText = document.getElementById('plan-features').value;
            const featuresList = featuresText.split('\n').map(f => f.trim()).filter(f => f.length > 0);
            
            // Build features object with features_list
            const maxProps = document.getElementById('plan-max-properties').value ? parseInt(document.getElementById('plan-max-properties').value) : null;
            const features = {
                properties: maxProps,
                websites: 1,
                booking_plugin: true,
                features_list: featuresList
            };
            
            const planData = {
                id: document.getElementById('plan-id').value || undefined,
                name: document.getElementById('plan-name').value,
                slug: document.getElementById('plan-slug').value || undefined,
                description: document.getElementById('plan-description').value,
                price_monthly: parseFloat(document.getElementById('plan-price-monthly').value),
                price_yearly: document.getElementById('plan-price-yearly').value ? parseFloat(document.getElementById('plan-price-yearly').value) : null,
                currency: document.getElementById('plan-currency').value,
                max_properties: maxProps,
                features: features,
                sort_order: parseInt(document.getElementById('plan-sort-order').value) || 0,
                is_active: document.getElementById('plan-is-active').checked
            };
            
            try {
                const response = await fetch('/api/admin/billing/plans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(planData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Plan saved!', 'success');
                    closeModal('billingPlanModal');
                    loadBillingPlans();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving plan', 'error');
            }
        }

        async function deletePlan(id) {
            if (!confirm('Delete this plan?')) return;
            
            try {
                const response = await fetch('/api/admin/billing/plans/' + id, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showNotification('Plan deleted', 'success');
                    loadBillingPlans();
                }
            } catch (error) {
                showNotification('Error deleting plan', 'error');
            }
        }

        // Credit Packages
        async function loadCreditPackages() {
            try {
                const response = await fetch('/api/admin/billing/credit-packages');
                const data = await response.json();
                
                const tbody = document.getElementById('billing-credit-packages-table');
                
                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(pkg => `
                        <tr style="${!pkg.is_active ? 'opacity: 0.6;' : ''}">
                            <td><strong>${pkg.name}</strong></td>
                            <td>${pkg.credits}</td>
                            <td>${pkg.bonus_credits > 0 ? '+' + pkg.bonus_credits : '-'}</td>
                            <td>¬£${parseFloat(pkg.price).toFixed(2)}</td>
                            <td><span class="badge ${pkg.is_active ? 'badge-success' : 'badge-warning'}">${pkg.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editCreditPackage(${pkg.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: var(--error);" onclick="deleteCreditPackage(${pkg.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No credit packages configured</td></tr>';
                }
            } catch (error) {
                console.error('Error loading credit packages:', error);
            }
        }

        function openCreditPackageModal() {
            document.getElementById('credit-package-id').value = '';
            document.getElementById('credit-package-name').value = '';
            document.getElementById('credit-package-credits').value = '';
            document.getElementById('credit-package-bonus').value = '0';
            document.getElementById('credit-package-price').value = '';
            document.getElementById('credit-package-currency').value = 'GBP';
            document.getElementById('credit-package-is-active').checked = true;
            document.getElementById('credit-package-modal-title').textContent = 'ü™ô Add Credit Package';
            openModal('creditPackageModal');
        }

        async function editCreditPackage(id) {
            try {
                const response = await fetch('/api/admin/billing/credit-packages');
                const data = await response.json();
                const pkg = data.data.find(p => p.id === id);
                
                if (pkg) {
                    document.getElementById('credit-package-id').value = pkg.id;
                    document.getElementById('credit-package-name').value = pkg.name;
                    document.getElementById('credit-package-credits').value = pkg.credits;
                    document.getElementById('credit-package-bonus').value = pkg.bonus_credits || 0;
                    document.getElementById('credit-package-price').value = pkg.price;
                    document.getElementById('credit-package-currency').value = pkg.currency || 'GBP';
                    document.getElementById('credit-package-is-active').checked = pkg.is_active;
                    document.getElementById('credit-package-modal-title').textContent = 'ü™ô Edit Credit Package';
                    openModal('creditPackageModal');
                }
            } catch (error) {
                showNotification('Error loading package', 'error');
            }
        }

        async function saveCreditPackage(event) {
            event.preventDefault();
            
            const pkgData = {
                id: document.getElementById('credit-package-id').value || undefined,
                name: document.getElementById('credit-package-name').value,
                credits: parseInt(document.getElementById('credit-package-credits').value),
                bonus_credits: parseInt(document.getElementById('credit-package-bonus').value) || 0,
                price: parseFloat(document.getElementById('credit-package-price').value),
                currency: document.getElementById('credit-package-currency').value,
                is_active: document.getElementById('credit-package-is-active').checked
            };
            
            try {
                const response = await fetch('/api/admin/billing/credit-packages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pkgData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Package saved!', 'success');
                    closeModal('creditPackageModal');
                    loadCreditPackages();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving package', 'error');
            }
        }

        async function deleteCreditPackage(id) {
            if (!confirm('Delete this package?')) return;
            
            try {
                const response = await fetch('/api/admin/billing/credit-packages/' + id, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showNotification('Package deleted', 'success');
                    loadCreditPackages();
                }
            } catch (error) {
                showNotification('Error deleting package', 'error');
            }
        }

        // Extras
        async function loadBillingExtras() {
            try {
                const response = await fetch('/api/admin/billing/extras');
                const data = await response.json();
                
                const tbody = document.getElementById('billing-extras-table');
                
                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(extra => `
                        <tr style="${!extra.is_active ? 'opacity: 0.6;' : ''}">
                            <td><strong>${extra.icon || ''} ${extra.name}</strong><br><small style="color: var(--text-secondary);">${extra.description || ''}</small></td>
                            <td>${extra.category || '-'}</td>
                            <td><strong>${extra.credit_cost}</strong> credits</td>
                            <td><span class="badge ${extra.is_active ? 'badge-success' : 'badge-warning'}">${extra.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editExtra(${extra.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: var(--error);" onclick="deleteExtra(${extra.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No extras configured</td></tr>';
                }
            } catch (error) {
                console.error('Error loading extras:', error);
            }
        }

        function openExtraModal() {
            document.getElementById('extra-id').value = '';
            document.getElementById('extra-name').value = '';
            document.getElementById('extra-icon').value = '';
            document.getElementById('extra-description').value = '';
            document.getElementById('extra-credit-cost').value = '';
            document.getElementById('extra-category').value = '';
            document.getElementById('extra-is-active').checked = true;
            document.getElementById('extra-modal-title').textContent = 'üõí Add Extra Service';
            openModal('extraModal');
        }

        async function editExtra(id) {
            try {
                const response = await fetch('/api/admin/billing/extras');
                const data = await response.json();
                const extra = data.data.find(e => e.id === id);
                
                if (extra) {
                    document.getElementById('extra-id').value = extra.id;
                    document.getElementById('extra-name').value = extra.name;
                    document.getElementById('extra-icon').value = extra.icon || '';
                    document.getElementById('extra-description').value = extra.description || '';
                    document.getElementById('extra-credit-cost').value = extra.credit_cost;
                    document.getElementById('extra-category').value = extra.category || '';
                    document.getElementById('extra-is-active').checked = extra.is_active;
                    document.getElementById('extra-modal-title').textContent = 'üõí Edit Extra';
                    openModal('extraModal');
                }
            } catch (error) {
                showNotification('Error loading extra', 'error');
            }
        }

        async function saveExtra(event) {
            event.preventDefault();
            
            const extraData = {
                id: document.getElementById('extra-id').value || undefined,
                name: document.getElementById('extra-name').value,
                icon: document.getElementById('extra-icon').value,
                description: document.getElementById('extra-description').value,
                credit_cost: parseInt(document.getElementById('extra-credit-cost').value),
                category: document.getElementById('extra-category').value,
                is_active: document.getElementById('extra-is-active').checked
            };
            
            try {
                const response = await fetch('/api/admin/billing/extras', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(extraData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Extra saved!', 'success');
                    closeModal('extraModal');
                    loadBillingExtras();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving extra', 'error');
            }
        }

        async function deleteExtra(id) {
            if (!confirm('Delete this extra?')) return;
            
            try {
                const response = await fetch('/api/admin/billing/extras/' + id, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showNotification('Extra deleted', 'success');
                    loadBillingExtras();
                }
            } catch (error) {
                showNotification('Error deleting extra', 'error');
            }
        }

        // Initial load
        loadClientSelector();
        loadDashboard();
    </script>
</body>
</html>
