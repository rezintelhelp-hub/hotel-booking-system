<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAS Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: #e0e7ff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --error: #ef4444;
            --error-light: #fee2e2;
            --border-color: #e2e8f0;
            --border: #e2e8f0;
            --sidebar-bg: #ffffff;
            --sidebar-text: #64748b;
            --sidebar-hover: #f1f5f9;
            --sidebar-active: #6366f1;
        }

        /* Modal Overlay Styles */
        .gas-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 99999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .gas-modal-overlay.active {
            display: flex !important;
        }
        .gas-modal-overlay > div {
            background: var(--bg-card, #fff);
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.2s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Website Editor Tabs */
        .editor-tab.active {
            color: #7c3aed !important;
            border-bottom-color: #7c3aed !important;
        }
        .editor-tab:hover {
            color: #7c3aed;
            background: #f8fafc;
        }
        .sub-tab {
            transition: all 0.2s ease;
        }
        .sub-tab:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        /* Sidebar - Light theme */
        .sidebar {
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 1.5rem 0 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .logo {
            padding: 0 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .nav {
            padding: 0 0.75rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.25rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
            transition: background 0.15s;
        }
        
        .nav-label:hover {
            background: var(--sidebar-hover);
        }
        
        .nav-label::after {
            content: 'â–¼';
            font-size: 0.5rem;
            transition: transform 0.2s;
            opacity: 0.5;
        }
        
        .nav-section.collapsed .nav-label::after {
            transform: rotate(-90deg);
        }
        
        .nav-subsection {
            margin: 0.25rem 0;
        }
        
        .nav-subsection-toggle {
            font-weight: 500;
        }
        
        .nav-subsection-arrow {
            font-size: 0.7rem;
            opacity: 0.6;
            transition: transform 0.2s;
        }
        
        .nav-subsection.expanded .nav-subsection-arrow {
            transform: rotate(90deg);
        }
        
        .nav-subsection-items {
            border-left: 2px solid var(--border);
            margin-left: 0.75rem;
        }
        
        .nav-subsection-items .nav-item {
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }
        
        .nav-section-items {
            overflow: hidden;
            transition: max-height 0.3s ease;
            max-height: 500px;
        }
        
        .nav-section.collapsed .nav-section-items {
            max-height: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            color: #64748b;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.15s;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #ffffff;
            font-weight: 600;
        }

        .nav-item.feature-locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-item.feature-locked:hover {
            background: transparent;
            color: #64748b;
        }
        
        /* Locked sub-tabs in Website Builder */
        .sub-tab.feature-locked {
            opacity: 0.6;
            background: #f1f5f9 !important;
            color: #94a3b8 !important;
            border-color: #e2e8f0 !important;
        }
        
        .sub-tab.feature-locked:hover {
            background: #f1f5f9 !important;
            color: #64748b !important;
        }

        .nav-icon {
            font-size: 1.1rem;
        }

        /* User Profile Section */
        .user-profile-section {
            margin-top: auto;
            padding: 1rem 1.25rem;
            border-top: 1px solid #e2e8f0;
            background: var(--bg-primary);
        }

        .user-profile-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: capitalize;
        }

        .logout-btn {
            width: 100%;
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: #64748b;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        /* Main Content */
        .main {
            padding: 1.5rem 2rem;
            overflow-y: auto;
            height: 100vh;
            background: var(--bg-primary);
        }

        .header {
            margin-bottom: 1.5rem;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header p {
            color: #64748b;
            font-size: 0.875rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--accent);
        }

        .stat-card::before {
            display: none;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .stat-icon {
            font-size: 1.25rem;
            color: var(--accent);
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        th {
            text-align: left;
            padding: 0.625rem 0.75rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: #64748b;
            font-weight: 600;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--bg-primary);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-secondary {
            background: #f3f4f6;
            color: #64748b;
        }

        .badge-warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .badge-info {
            background: var(--accent-light);
            color: var(--accent);
        }

        /* Preset Buttons */
        .preset-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #475569;
        }
        .preset-btn:hover {
            background: #e0f2fe;
            border-color: #3b82f6;
            color: #1d4ed8;
            transform: translateY(-1px);
        }
        .preset-btn:active {
            transform: translateY(0);
        }
        .preset-btn.added {
            background: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        /* Feature Grid for Marketing */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.75rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .feature-item:hover {
            background: #f0f9ff;
            border-color: #3b82f6;
        }
        .feature-item:has(input:checked) {
            background: #dcfce7;
            border-color: #22c55e;
        }
        .feature-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .custom-feature-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #e0f2fe;
            border: 1px solid #7dd3fc;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 0.25rem;
        }
        .custom-feature-tag button {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            padding: 0;
        }

        /* Button */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            box-shadow: 0 1px 2px rgba(99, 102, 241, 0.2);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: #ffffff;
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #ffffff;
        }
        
        .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.35rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: #64748b;
        }

        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.15s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        textarea.form-input {
            min-height: 100px;
            width: 100%;
            resize: none;
        }
        
        textarea.form-textarea {
            min-height: 100px;
            width: 100%;
            resize: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .channel-option:hover {
            border-color: var(--accent) !important;
            background: #f8fafc;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Template Selection */
        .template-option {
            transition: all 0.2s ease;
        }
        
        .template-option:hover {
            border-color: var(--primary) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .template-option:has(input:checked) {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .template-option:has(input:checked)::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .template-option {
            position: relative;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
        }

        .empty-icon {
            font-size: 2.5rem;
            opacity: 0.3;
            margin-bottom: 0.75rem;
        }

        .empty-state h3 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .empty-state p {
            color: #64748b;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        /* View Sections */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Image Gallery */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .image-item {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 6px;
            overflow: hidden;
            background: var(--bg-primary);
            border: 1px solid var(--border);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.35rem;
        }

        /* Amenity Item */
        .amenity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                height: auto;
            }
        }

        /* Filter Tabs */
        .filter-tab {
            padding: 0.4rem 0.75rem;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.8rem;
        }

        .filter-tab:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .filter-tab.active {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
            font-weight: 500;
        }

        /* Image Gallery Grid */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
            padding: 0.75rem;
        }

        .image-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            transition: all 0.15s;
        }

        .image-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .image-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
        }

        .image-card-info {
            padding: 0.75rem;
        }

        .image-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-bottom: 0.5rem;
        }

        .image-tag {
            background: var(--bg-primary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            color: #64748b;
        }

        .image-tag.property { border-left: 2px solid var(--accent); }
        .image-tag.room { border-left: 2px solid var(--success); }
        .image-tag.location { border-left: 2px solid var(--warning); }

        .image-actions {
            display: flex;
            gap: 0.35rem;
            margin-top: 0.5rem;
        }

        .image-actions button {
            flex: 1;
            padding: 0.35rem;
            font-size: 0.75rem;
        }

        /* Drag and drop for images */
        .image-card[draggable="true"] {
            cursor: grab;
        }
        .image-card[draggable="true"]:active {
            cursor: grabbing;
        }
        .image-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .image-card.drag-over {
            border: 2px dashed var(--accent);
            background: var(--accent-light);
        }

        /* Upload Modal Specific */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 1rem;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .upload-zone.dragover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .upload-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
            max-height: 250px;
            overflow-y: auto;
        }

        .upload-preview-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .upload-preview-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .upload-preview-item .remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }

        .upload-preview-item .error {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 0.2rem;
            font-size: 0.65rem;
            text-align: center;
        }

        .assignment-section {
            background: var(--bg-primary);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .assignment-section h4 {
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.5rem;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.8rem;
        }

        .checkbox-label:hover {
            border-color: var(--accent);
        }

        .checkbox-label input[type="checkbox"]:checked ~ span {
            color: var(--accent);
            font-weight: 500;
        }

        /* Availability Grid Styles */
        #availability-grid {
            font-size: 0.75rem;
            background: #ffffff;
        }
        
        #availability-grid th,
        #availability-grid td {
            border: 1px solid var(--border);
        }
        
        #availability-grid th {
            background: var(--bg-primary);
            font-weight: 500;
            color: #64748b;
        }
        
        #availability-grid td:hover {
            filter: brightness(0.95);
        }
        
        /* Scrollbar for light theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        /* Client Selector Styles */
        .client-selector {
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0 1rem 1rem;
        }
        
        .client-selector label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .client-selector select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #334155;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
        }
        
        .client-selector select:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        .client-selector select option {
            background: white;
            color: #334155;
            padding: 0.5rem;
        }
        
        .client-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            padding: 0.4rem 0.6rem;
            background: #f1f5f9;
            border-radius: 6px;
            color: #64748b;
        }
        
        .client-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            flex-shrink: 0;
        }
        
        .client-indicator.all-clients .dot {
            background: #f59e0b;
        }
        
        #clientIndicatorText {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Dashboard Category Cards */
        .dashboard-categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 1200px) {
            .dashboard-categories {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-categories {
                grid-template-columns: 1fr;
            }
        }

        .category-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
            transition: background 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }

        .category-card:hover::before {
            background: var(--accent);
        }

        .category-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .category-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }

        .category-card p {
            font-size: 0.85rem;
            color: #64748b;
            margin: 0 0 1rem 0;
            line-height: 1.4;
        }

        .category-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .category-links span {
            font-size: 0.75rem;
            padding: 0.35rem 0.75rem;
            background: var(--bg-primary);
            border-radius: 20px;
            color: #64748b;
            transition: all 0.2s;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .category-links span:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        /* Website status badges */
        .website-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .website-status.status-active, .website-status.status-deployed {
            background: #dcfce7;
            color: #166534;
        }
        .website-status.status-draft {
            background: #fef3c7;
            color: #92400e;
        }
        .website-status.status-paused {
            background: #fee2e2;
            color: #991b1b;
        }
        .website-selector-banner {
            transition: all 0.3s ease;
        }
        
        /* GasSync Styles */
        .connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .connection-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .connection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .connection-card.status-error { border-left-color: #ef4444; }
        .connection-card.status-syncing { border-left-color: #f59e0b; }
        .connection-card.status-disabled { border-left-color: #9ca3af; opacity: 0.7; }
        .connection-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .connection-logo {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .connection-info h4 { margin: 0; font-size: 16px; }
        .connection-info .adapter-name { color: #6b7280; font-size: 13px; }
        .connection-status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: auto;
        }
        .connection-status-badge.connected { background: #d1fae5; color: #047857; }
        .connection-status-badge.error { background: #fee2e2; color: #dc2626; }
        .connection-status-badge.syncing { background: #fef3c7; color: #d97706; }
        .connection-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
            padding: 15px 0;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }
        .connection-stat { text-align: center; }
        .connection-stat-value { font-size: 20px; font-weight: 600; color: #111827; }
        .connection-stat-label { font-size: 11px; color: #6b7280; text-transform: uppercase; }
        .connection-meta { font-size: 12px; color: #6b7280; margin-bottom: 15px; }
        .connection-actions { display: flex; gap: 8px; }
        .connection-actions .btn { flex: 1; padding: 8px; font-size: 13px; }
        .adapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }
        .adapter-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .adapter-card:hover { border-color: #3b82f6; background: #eff6ff; }
        .adapter-card.selected { border-color: #3b82f6; background: #dbeafe; }
        .adapter-card-logo { font-size: 32px; margin-bottom: 8px; }
        .adapter-card-name { font-weight: 500; font-size: 13px; }
        .adapter-card-via { font-size: 10px; color: #6b7280; margin-top: 4px; }
        .connection-status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .connection-status-item .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .connection-status-item .status-dot.connected { background: #10b981; }
        .connection-status-item .status-dot.error { background: #ef4444; }
        .connection-status-item .status-dot.syncing { background: #f59e0b; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .gas-sync-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        .gas-sync-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
        }
        .gas-sync-tab:hover { color: #111827; }
        .gas-sync-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; background: white; }
        .gas-sync-tab-content { min-height: 250px; }
        #credentialFields .form-group { margin-bottom: 15px; }
        #credentialFields label { display: block; margin-bottom: 5px; font-weight: 500; }
        #credentialFields input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; }
        #credentialFields .help-text { font-size: 12px; color: #6b7280; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1>GAS_ADMIN</h1>
                <p>Property Management System</p>
            </div>
            
            <!-- Client Selector - Hidden for now -->
            <div class="client-selector" style="display: none;">
                <label> Viewing Client</label>
                <select id="globalClientSelector" onchange="switchClient(this.value)">
                    <option value=""> All Clients (Admin View)</option>
                </select>
                <div class="client-indicator" id="clientIndicator">
                    <span class="dot"></span>
                    <span id="clientIndicatorText">All clients</span>
                </div>
            </div>
            
            <!-- Agency Filter Banner - Clean Design -->
            <div id="agencyFilterBanner" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.75rem 1rem; border-radius: 12px; margin: 0 0.75rem 1rem 0.75rem; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0;"></div>
                        <div>
                            <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9;">Viewing</div>
                            <div id="agencyFilterName" style="font-weight: 600; font-size: 1rem; line-height: 1.2;"></div>
                            <code id="agencyFilterCode" style="display: none;"></code>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                        <button id="managePlanBtn" class="billing-admin-only" onclick="openAssignPlanModal(selectedAccountId, document.getElementById('agencyFilterName').textContent)" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500; white-space: nowrap; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                             Manage
                        </button>
                        <button id="clearFilterBtn" onclick="clearAccountFilter()" style="background: rgba(0,0,0,0.1); border: none; color: white; padding: 0.4rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.2)'" onmouseout="this.style.background='rgba(0,0,0,0.1)'">
                             Clear
                        </button>
                    </div>
                </div>
            </div>

            <nav class="nav">
                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Overview</div>
                    <div class="nav-section-items">
                    <a class="nav-item active" data-view="dashboard" href="#" onclick="navClick(this, 'dashboard'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Dashboard</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Accounts</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="my-account" href="#" onclick="navClick(this, 'my-account'); return false;">
                        <span class="nav-icon">ðŸ‘¤</span>
                        <span>My Account</span>
                    </a>
                    <a class="nav-item" data-view="accounts" href="#" onclick="navClick(this, 'accounts'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>All Accounts</span>
                    </a>
                    <a class="nav-item agency-only" data-view="management-requests" href="#" onclick="navClick(this, 'management-requests'); return false;" style="display: none;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Management Requests</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Channel Manager</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="gas-sync-connections" href="#" onclick="navClick(this, 'gas-sync-connections'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Connections</span>
                    </a>
                    <a class="nav-item master-only" style="display: none;" data-view="gas-sync-dashboard" href="#" onclick="navClick(this, 'gas-sync-dashboard'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Sync Dashboard</span>
                    </a>
                    <a class="nav-item master-only" style="display: none;" data-view="gas-sync-properties" href="#" onclick="navClick(this, 'gas-sync-properties'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Synced Properties</span>
                    </a>
                    <!-- Sync Logs and Sync Review removed - data still logged, Import is approval step -->
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Property Management</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="properties" href="#" onclick="navClick(this, 'properties'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Properties</span>
                    </a>
                    <a class="nav-item" data-view="rooms" href="#" onclick="navClick(this, 'rooms'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Rooms & Units</span>
                    </a>
                    <a class="nav-item" data-view="images" href="#" onclick="navClick(this, 'images'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Images</span>
                    </a>
                    <a class="nav-item" data-view="amenities" href="#" onclick="navClick(this, 'amenities'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Amenities</span>
                    </a>
                    <a class="nav-item" data-view="availability" href="#" onclick="navClick(this, 'availability'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Availability</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Bookings & Revenue</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="bookings" href="#" onclick="navClick(this, 'bookings'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Bookings</span>
                    </a>
                    <a class="nav-item" data-view="offers" href="#" onclick="navClick(this, 'offers'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Offers</span>
                    </a>
                    <a class="nav-item" data-view="vouchers" href="#" onclick="navClick(this, 'vouchers'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Vouchers</span>
                    </a>
                    <a class="nav-item" data-view="upsells" href="#" onclick="navClick(this, 'upsells'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Upsells</span>
                    </a>
                    <a class="nav-item" data-view="vendors" href="#" onclick="navClick(this, 'vendors'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Vendors</span>
                    </a>
                    <a class="nav-item" data-view="vendor-requests" href="#" onclick="navClick(this, 'vendor-requests'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Service Requests</span>
                    </a>
                    <a class="nav-item" data-view="taxes" href="#" onclick="navClick(this, 'taxes'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Taxes</span>
                    </a>
                    <a class="nav-item" data-view="payments" href="#" onclick="navClick(this, 'payments'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Payments</span>
                    </a>
                    <a class="nav-item" data-view="deposit-rules" href="#" onclick="navClick(this, 'deposit-rules'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Deposit Rules</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Marketing</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="marketing" href="#" onclick="navClick(this, 'marketing'); return false;">
                        <span class="nav-icon">ðŸ·ï¸</span>
                        <span>Marketing Tags</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Turbines</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="turbine-connections" href="#" onclick="navClick(this, 'turbine-connections'); return false;">
                        <span class="nav-icon">ðŸ”—</span>
                        <span>Connections</span>
                    </a>
                    <a class="nav-item" data-view="turbine-campaigns" href="#" onclick="navClick(this, 'turbine-campaigns'); return false;">
                        <span class="nav-icon">ðŸ“£</span>
                        <span>Campaigns</span>
                    </a>
                    <a class="nav-item" data-view="turbine-generator" href="#" onclick="navClick(this, 'turbine-generator'); return false;">
                        <span class="nav-icon">ðŸ“</span>
                        <span>Generator</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">GAS Network</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="network-contacts" href="#" onclick="navClick(this, 'network-contacts'); return false;">
                        <span class="nav-icon">ðŸ‘¥</span>
                        <span>Contacts</span>
                    </a>
                    <a class="nav-item" data-view="network-tags" href="#" onclick="navClick(this, 'network-tags'); return false;">
                        <span class="nav-icon">ðŸ·ï¸</span>
                        <span>Tags</span>
                    </a>
                    <a class="nav-item" data-view="network-segments" href="#" onclick="navClick(this, 'network-segments'); return false;">
                        <span class="nav-icon">ðŸ“Š</span>
                        <span>Segments</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Generators</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="app-blog" data-requires-feature="blog_module" href="#" onclick="return handleFeatureClick(this, 'app-blog', 'blog_module');">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Blog</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;"></span>
                    </a>
                    <a class="nav-item" data-view="app-attractions" data-requires-feature="attractions_module" href="#" onclick="return handleFeatureClick(this, 'app-attractions', 'attractions_module');">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Attractions</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;"></span>
                    </a>
                    <a class="nav-item" data-view="app-reviews" data-requires-feature="reviews_widget" href="#" onclick="return handleFeatureClick(this, 'app-reviews', 'reviews_widget');">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Reviews</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;"></span>
                    </a>
                    <a class="nav-item" data-view="app-seo" href="#" onclick="showView('app-seo'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>SEO Analytics</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Agents</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="agent-requests" href="#" onclick="navClick(this, 'agent-requests'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Requests</span>
                    </a>
                    <a class="nav-item" data-view="agent-approved" href="#" onclick="navClick(this, 'agent-approved'); return false;">
                        <span class="nav-icon">âœ…</span>
                        <span>Approved</span>
                    </a>
                    <a class="nav-item" data-view="agent-pricing" href="#" onclick="navClick(this, 'agent-pricing'); return false;">
                        <span class="nav-icon">ðŸ’°</span>
                        <span>Agent Pricing</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Website Builder</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="deploy-sites" href="#" onclick="navClick(this, 'deploy-sites'); return false;" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; border-radius: 8px; margin-bottom: 0.5rem;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Create Sites</span>
                    </a>
                    <a class="nav-item" data-view="my-custom-site" href="#" onclick="navClick(this, 'my-custom-site'); return false;" id="nav-my-custom-site" style="display: none;">
                        <span class="nav-icon">âœ¨</span>
                        <span>My Custom Site</span>
                    </a>
                    <a class="nav-item master-only" data-view="custom-sites" href="#" onclick="navClick(this, 'custom-sites'); return false;" style="display: none;">
                        <span class="nav-icon">ðŸ› ï¸</span>
                        <span>Manage Custom Sites</span>
                    </a>
                    <a class="nav-item" data-view="plugin-licenses" href="#" onclick="navClick(this, 'plugin-licenses'); return false;">
                        <span class="nav-icon">ðŸ”‘</span>
                        <span>Plugin Licenses</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed master-only" style="display: none;">
                    <div class="nav-label" onclick="toggleNavSection(this)">Knowledge Base</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="kb-articles" href="#" onclick="navClick(this, 'kb-articles'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Articles</span>
                    </a>
                    <a class="nav-item" data-view="kb-unanswered" href="#" onclick="navClick(this, 'kb-unanswered'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Unanswered</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed" id="nav-billing-section">
                    <div class="nav-label" onclick="toggleNavSection(this)">Billing</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="my-billing" href="#" onclick="navClick(this, 'my-billing'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>My Subscription</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-overview" href="#" onclick="navClick(this, 'billing-overview'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Revenue Dashboard</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-products" href="#" onclick="navClick(this, 'billing-products'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Products</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-plans" href="#" onclick="navClick(this, 'billing-plans'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Plans</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-addons" href="#" onclick="navClick(this, 'billing-addons'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Add-ons</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-subscribers" href="#" onclick="navClick(this, 'billing-subscribers'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Subscribers</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-affiliates" href="#" onclick="navClick(this, 'billing-affiliates'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Affiliates</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="my-referrals" href="#" onclick="navClick(this, 'my-referrals'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>My Referrals</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed master-only" style="display: none;">
                    <div class="nav-label" onclick="toggleNavSection(this)">System</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="tasks" href="#" onclick="navClick(this, 'tasks'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Tasks</span>
                    </a>
                    <a class="nav-item" data-view="integrations" href="#" onclick="navClick(this, 'integrations'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Integrations</span>
                    </a>
                    <a class="nav-item" data-view="settings" href="#" onclick="navClick(this, 'settings'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Settings</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed master-only" style="display: none;">
                    <div class="nav-label" onclick="toggleNavSection(this)">Developers</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="api-docs" data-requires-feature="api_access" href="#" onclick="return handleFeatureClick(this, 'api-docs', 'api_access');">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>API</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;"></span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed master-only" style="display: none;">
                    <div class="nav-label" onclick="toggleNavSection(this)"> Services</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="service-credentials" href="#" onclick="navClick(this, 'service-credentials'); return false;">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span>Credentials Vault</span>
                    </a>
                    <a class="nav-item" data-view="calry-admin" href="#" onclick="navClick(this, 'calry-admin'); return false;">
                        <span class="nav-icon">ðŸ”—</span>
                        <span>Calry Admin</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Website</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="wordpress" data-requires-feature="has_subscription" href="#" onclick="return handleFeatureClick(this, 'wordpress', 'has_subscription');">
                        <span class="nav-icon"><svg width="18" height="18" viewBox="0 0 122.5 122.5" fill="currentColor"><path d="M8.7 61.3c0 20.8 12.1 38.8 29.6 47.3L13 40.3c-2.8 6.5-4.3 13.7-4.3 21zm88.6-2.7c0-6.5-2.3-11-4.3-14.5-2.7-4.3-5.2-8-5.2-12.3 0-4.8 3.7-9.3 8.9-9.3h.7c-9.4-8.6-21.9-13.9-35.7-13.9-18.5 0-34.7 9.5-44.2 23.8h3.4c5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.8.3-6 .5l19.1 57 11.5-34.5-8.2-22.5c-2.8-.2-5.5-.5-5.5-.5-2.8-.2-2.5-4.5.3-4.3 0 0 8.7.7 13.9.7 5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.9.3-6 .5l19 56.5 5.2-17.5c2.3-7.3 4-12.5 4-17zm-36.3 7.6l-15.8 45.8c4.7 1.4 9.7 2.2 14.8 2.2 6.1 0 12-1.1 17.4-3-.1-.2-.3-.5-.4-.7l-16-43.3zm45.1-29.8c.5 3.4.7 7 .7 10.9 0 10.8-2 22.9-8 38l-21.8 63.1c21.2-12.4 35.5-35.5 35.5-62.1 0-17.9-6.2-34.3-16.4-47.9zM61.3 0C27.5 0 0 27.5 0 61.3c0 33.8 27.5 61.3 61.3 61.3 33.8 0 61.3-27.5 61.3-61.3C122.5 27.5 95 0 61.3 0zm0 119.7c-32.2 0-58.5-26.2-58.5-58.5 0-32.2 26.2-58.5 58.5-58.5 32.2 0 58.5 26.2 58.5 58.5 0 32.3-26.3 58.5-58.5 58.5z"/></svg></span>
                        <span>WordPress</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;"></span>
                    </a>
                    </div>
                </div>
                
                <!-- User Profile Section -->
                <div class="user-profile-section" id="userProfileSection">
                    <div class="user-profile-info" onclick="showView('my-account')" style="cursor: pointer;" title="Edit Profile">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRole">-</div>
                        </div>
                        <span style="margin-left: auto; color: var(--text-muted); font-size: 0.8rem;"></span>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">
                        <span></span> Sign Out
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Dashboard Overview</h2>
                            <p>Welcome back! Here's what's happening with your properties.</p>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon"></span>
                        </div>
                        <div class="stat-value" id="stat-properties">-</div>
                        <div class="stat-label">Properties</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon"></span>
                        </div>
                        <div class="stat-value" id="stat-rooms">-</div>
                        <div class="stat-label">Rooms & Units</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon"></span>
                        </div>
                        <div class="stat-value" id="stat-bookings">-</div>
                        <div class="stat-label">Total Bookings</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon"></span>
                        </div>
                        <div class="stat-value" id="stat-integrations">-</div>
                        <div class="stat-label">Active Integrations</div>
                    </div>
                </div>

                <!-- Category Navigation Cards -->
                <div class="dashboard-categories">
                    <div class="category-card" onclick="showView('properties')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                        </div>
                        <h3>Property Management</h3>
                        <p>Manage your properties, rooms, images and amenities</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); showView('properties')">Properties</span>
                            <span onclick="event.stopPropagation(); showView('rooms')">Rooms</span>
                            <span onclick="event.stopPropagation(); showView('images')">Images</span>
                            <span onclick="event.stopPropagation(); showView('amenities')">Amenities</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="showView('bookings')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <h3>Bookings & Revenue</h3>
                        <p>View bookings, manage offers, vouchers and taxes</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); showView('bookings')">Bookings</span>
                            <span onclick="event.stopPropagation(); showView('offers')">Offers</span>
                            <span onclick="event.stopPropagation(); showView('vouchers')">Vouchers</span>
                            <span onclick="event.stopPropagation(); showView('taxes')">Taxes</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="showView('availability')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M18 20V10"></path>
                                <path d="M12 20V4"></path>
                                <path d="M6 20v-6"></path>
                            </svg>
                        </div>
                        <h3>Availability & Pricing</h3>
                        <p>Manage calendars, rates and channel connections</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); showView('availability')">Calendar</span>
                            <span onclick="event.stopPropagation(); showView('rateplans')">Rate Plans</span>
                            <span onclick="event.stopPropagation(); showView('fees')">Fees</span>
                            <span onclick="event.stopPropagation(); showView('integrations')">Channels</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="showView('marketing')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                        </div>
                        <h3>Marketing & Website</h3>
                        <p>Features, upsells, website builder and content</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); showView('marketing')">Features</span>
                            <span onclick="event.stopPropagation(); showView('upsells')">Upsells</span>
                            <span onclick="event.stopPropagation(); showView('wordpress')">Website</span>
                            <span onclick="event.stopPropagation(); showView('content')">Content</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="showView('integrations')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                        </div>
                        <h3>Connectivity</h3>
                        <p>Connect channel managers and sync properties</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); openWizard('beds24')">Beds24</span>
                            <span onclick="event.stopPropagation(); openWizard('hostaway')">Hostaway</span>
                            <span onclick="event.stopPropagation(); openWizard('smoobu')">Smoobu</span>
                            <span onclick="event.stopPropagation(); showView('integrations')">All Channels</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="showView('app-blog')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                        </div>
                        <h3>Generators</h3>
                        <p>Blog, attractions, reviews and API documentation</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); showView('app-blog')">Blog</span>
                            <span onclick="event.stopPropagation(); showView('app-attractions')">Attractions</span>
                            <span onclick="event.stopPropagation(); showView('app-reviews')">Reviews</span>
                            <span onclick="event.stopPropagation(); showView('api-docs')">API Docs</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agencies View -->
            <div id="accounts" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Accounts</h2>
                            <p>Manage all accounts - Master Admin, Agency Admins, Sub Masters, and Admins</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="generateMissingCodes()" id="generateCodesBtn" style="display: none;">
                                 Generate Missing Codes
                            </button>
                            <button class="btn" onclick="openAddAccountModal()">
                                <span>+</span>
                                <span>Add Account</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total-accounts">-</div>
                        <div class="stat-label">Total Accounts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-agency-admins">-</div>
                        <div class="stat-label">Agency Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-submaster-admins">-</div>
                        <div class="stat-label">Sub Masters</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-admins">-</div>
                        <div class="stat-label">Admins</div>
                    </div>
                </div>

                <!-- Role Filter -->
                <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary account-filter active" data-role="all" onclick="filterAccounts('all')">All</button>
                        <button class="btn btn-secondary account-filter" data-role="agency_admin" onclick="filterAccounts('agency_admin')"> Agency Admins</button>
                        <button class="btn btn-secondary account-filter" data-role="submaster_admin" onclick="filterAccounts('submaster_admin')"> Sub Masters</button>
                        <button class="btn btn-secondary account-filter" data-role="admin" onclick="filterAccounts('admin')"> Admins</button>
                    </div>
                </div>

                <div class="card">
                    <div id="accounts-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem;">Loading accounts...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keep old views hidden for backward compatibility -->
            <div id="agencies" class="view" style="display:none;"></div>
            <div id="clients" class="view" style="display:none;"></div>

            <!-- Management Requests View (Agency Admin) -->
            <div id="management-requests" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Management Requests</h2>
                            <p>Review and manage requests from property owners</p>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-pending-requests">-</div>
                        <div class="stat-label">Pending Requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-managed-accounts">-</div>
                        <div class="stat-label">Managed Accounts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-managed-properties">-</div>
                        <div class="stat-label">Properties Under Management</div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <button class="btn request-filter active" data-status="pending" onclick="filterManagementRequests('pending')" style="background: var(--accent);">
                         Pending
                    </button>
                    <button class="btn btn-secondary request-filter" data-status="approved" onclick="filterManagementRequests('approved')">
                         Approved
                    </button>
                    <button class="btn btn-secondary request-filter" data-status="rejected" onclick="filterManagementRequests('rejected')">
                         Rejected
                    </button>
                    <button class="btn btn-secondary request-filter" data-status="all" onclick="filterManagementRequests('all')">
                        All
                    </button>
                </div>

                <!-- Requests List -->
                <div class="card">
                    <div id="managementRequestsList">
                        <p style="text-align: center; padding: 2rem; color: #64748b;">Loading requests...</p>
                    </div>
                </div>
            </div>

            <!-- Properties View -->
            <div id="properties" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Properties</h2>
                            <p>Manage your property listings</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="openBulkStripeModal()">
                                ðŸ’³ Bulk Stripe Setup
                            </button>
                            <a href="#" onclick="openWizard('beds24')" class="btn">
                                <span>+</span>
                                <span>Import Property</span>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="properties-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem;">Loading properties...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rooms View -->
            <div id="rooms" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Rooms & Units</h2>
                            <p>Manage bookable rooms and units</p>
                        </div>
                        <button class="btn" onclick="openAddRoomModal()">
                            <span>+</span>
                            <span>Add Room</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="rooms-property-select" class="form-input" onchange="loadRoomsForProperty()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="rooms-list">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">
                            Select a property to view rooms
                        </p>
                    </div>
                </div>
            </div>

            <!-- Bookings View -->
            <div id="bookings" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Bookings</h2>
                            <p>View all reservations</p>
                        </div>
                        <button class="btn" onclick="openAddBookingModal()">
                            <span>+</span>
                            <span>Add Booking</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="bookings-property-select" class="form-input" onchange="loadBookingsForProperty()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="bookings-room-select" class="form-input" onchange="loadBookingsForProperty()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Status</label>
                            <select id="bookings-status-select" class="form-input" onchange="loadBookingsForProperty()">
                                <option value="">All Statuses</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="pending">Pending</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="bookings-list">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">
                            Select a property to view bookings
                        </p>
                    </div>
                </div>
            </div>

            <!-- Images View -->
            <div id="images" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Images</h2>
                            <p>Manage property, room, and location images</p>
                        </div>
                        <button class="btn" onclick="openImageUploadModal()">
                            <span>+</span>
                            <span>Upload Images</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="images-property-select" class="form-input" onchange="loadImagesForProperty()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="images-room-select" class="form-input" onchange="loadImagesForProperty()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Image Stats Summary -->
                <div id="images-stats" style="display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">Property Images</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="property-image-count">0</div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">Room Images</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="room-image-count">0</div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">Location Images</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="location-image-count">0</div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">Total Images</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="total-image-count">0</div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div id="images-filter-tabs" style="display: none; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button class="filter-tab active" data-filter="all" onclick="filterImages('all')">
                        All Images
                    </button>
                    <button class="filter-tab" data-filter="property" onclick="filterImages('property')">
                         Property
                    </button>
                    <button class="filter-tab" data-filter="rooms" onclick="filterImages('rooms')">
                         Rooms
                    </button>
                    <button class="filter-tab" data-filter="location" onclick="filterImages('location')">
                         Location
                    </button>
                </div>

                <div class="card">
                    <div id="images-gallery">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">
                            Select a property to view and manage images
                        </p>
                    </div>
                </div>
            </div>

            <!-- Amenities View - RESTRUCTURED -->
            <div id="amenities" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Amenities</h2>
                            <p>Manage room features, facilities, and policies</p>
                        </div>
                        <button class="btn" onclick="saveAllAmenities()">
                            <span></span>
                            <span>Save All Changes</span>
                        </button>
                    </div>
                </div>

                <!-- Property/Room Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="amenities-property-select" class="form-input" onchange="loadAmenitiesRooms()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="amenities-room-select" class="form-input" onchange="loadAmenitiesForRoom()">
                                <option value="">Select Room...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Amenities Tabs -->
                <div class="filter-tabs" style="margin-bottom: 1rem; flex-wrap: wrap;" id="amenities-tabs">
                    <button class="filter-tab active" data-amenity-tab="rooms" onclick="switchAmenityTab('rooms')"> Rooms</button>
                    <button class="filter-tab" data-amenity-tab="bathrooms" onclick="switchAmenityTab('bathrooms')"> Bathrooms</button>
                    <button class="filter-tab" data-amenity-tab="features" onclick="switchAmenityTab('features')"> In-Room Features</button>
                    <button class="filter-tab" data-amenity-tab="terms" onclick="switchAmenityTab('terms')"> Terms & Policies</button>
                </div>

                <!-- Tab Content Container -->
                <div id="amenities-tab-content">
                    <!-- Rooms Tab -->
                    <div id="amenities-tab-rooms" class="amenity-tab-panel">
                        <!-- Bedroom Configuration -->
                        <div class="card">
                            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>ðŸ›ï¸ Bedroom Configuration</h3>
                                <button class="btn btn-primary btn-small" onclick="openBedroomModal()">+ Add Bedroom</button>
                            </div>
                            <div class="card-body">
                                <p style="color: #64748b; margin-bottom: 1rem;">Configure each bedroom with its bed setup and features</p>
                                <div id="bedrooms-list">
                                    <p style="color: #64748b; text-align: center; padding: 2rem;">No bedrooms configured yet. Click "Add Bedroom" to get started.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Bedroom Amenities (applies to all) -->
                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>ðŸ›‹ï¸ Bedroom Amenities</h3>
                                <p style="font-size: 0.85rem; color: #64748b; margin: 0;">These amenities apply to all bedrooms</p>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-linen" style="width: 18px; height: 18px;">
                                        <span>Linen Provided</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-pillows" style="width: 18px; height: 18px;">
                                        <span>Pillows</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-duvet" style="width: 18px; height: 18px;">
                                        <span>Duvet/Comforter</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-blankets" style="width: 18px; height: 18px;">
                                        <span>Extra Blankets</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-blackout" style="width: 18px; height: 18px;">
                                        <span>Blackout Curtains</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-wardrobe" style="width: 18px; height: 18px;">
                                        <span>Wardrobe/Closet</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-hangers" style="width: 18px; height: 18px;">
                                        <span>Hangers</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-drawers" style="width: 18px; height: 18px;">
                                        <span>Chest of Drawers</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-mirror" style="width: 18px; height: 18px;">
                                        <span>Full-Length Mirror</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-desk" style="width: 18px; height: 18px;">
                                        <span>Desk/Workspace</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-tv" style="width: 18px; height: 18px;">
                                        <span>TV in Room</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-ac" style="width: 18px; height: 18px;">
                                        <span>Air Conditioning</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-heating" style="width: 18px; height: 18px;">
                                        <span>Heating</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-fan" style="width: 18px; height: 18px;">
                                        <span>Ceiling Fan</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-safe" style="width: 18px; height: 18px;">
                                        <span>Safe</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-usb" style="width: 18px; height: 18px;">
                                        <span>USB Charging Ports</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-reading-lights" style="width: 18px; height: 18px;">
                                        <span>Reading Lights</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bedroom-alarm" style="width: 18px; height: 18px;">
                                        <span>Alarm Clock</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Room Amenities (existing) -->
                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>âœ¨ Room Amenities</h3>
                            </div>
                            <div class="card-body" id="room-amenities-list">
                                <p style="color: #64748b; text-align: center; padding: 1rem;">Select a room to load amenities</p>
                            </div>
                        </div>
                    </div>

                    <!-- Bathrooms Tab -->
                    <div id="amenities-tab-bathrooms" class="amenity-tab-panel" style="display: none;">
                        <!-- Bathroom Configuration -->
                        <div class="card">
                            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>ðŸš¿ Bathroom Configuration</h3>
                                <button class="btn btn-primary btn-small" onclick="openBathroomModal()">+ Add Bathroom</button>
                            </div>
                            <div class="card-body">
                                <p style="color: #64748b; margin-bottom: 1rem;">Configure each bathroom with its type, location and features</p>
                                <div id="bathrooms-list">
                                    <p style="color: #64748b; text-align: center; padding: 2rem;">No bathrooms configured yet. Click "Add Bathroom" to get started.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Bathroom Amenities (applies to all) -->
                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>ðŸ§´ Bathroom Amenities</h3>
                                <p style="font-size: 0.85rem; color: #64748b; margin: 0;">These amenities apply to all bathrooms</p>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-towels" style="width: 18px; height: 18px;">
                                        <span>Towels Provided</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-toiletries" style="width: 18px; height: 18px;">
                                        <span>Toiletries Provided</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-hairdryer" style="width: 18px; height: 18px;">
                                        <span>Hair Dryer</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-robes" style="width: 18px; height: 18px;">
                                        <span>Bathrobes</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-slippers" style="width: 18px; height: 18px;">
                                        <span>Slippers</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-shampoo" style="width: 18px; height: 18px;">
                                        <span>Shampoo</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-conditioner" style="width: 18px; height: 18px;">
                                        <span>Conditioner</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-bodywash" style="width: 18px; height: 18px;">
                                        <span>Body Wash</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-soap" style="width: 18px; height: 18px;">
                                        <span>Hand Soap</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-toilet-paper" style="width: 18px; height: 18px;">
                                        <span>Toilet Paper</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bath-first-aid" style="width: 18px; height: 18px;">
                                        <span>First Aid Kit</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- In-Room Features Tab -->
                    <div id="amenities-tab-features" class="amenity-tab-panel" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h3> In-Room Features</h3>
                            </div>
                            <div class="card-body" id="features-amenities-list">
                                <p style="color: #64748b; text-align: center; padding: 1rem;">Select a room to load amenities</p>
                            </div>
                        </div>
                    </div>

                    <!-- Terms & Policies Tab -->
                    <div id="amenities-tab-terms" class="amenity-tab-panel" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h3> Check-in / Check-out</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Check-in From</label>
                                        <select class="form-input" id="terms-checkin-from">
                                            <option value="12:00">12:00 PM (Noon)</option>
                                            <option value="13:00">1:00 PM</option>
                                            <option value="14:00">2:00 PM</option>
                                            <option value="15:00" selected>3:00 PM</option>
                                            <option value="16:00">4:00 PM</option>
                                            <option value="17:00">5:00 PM</option>
                                            <option value="18:00">6:00 PM</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Check-in Until</label>
                                        <select class="form-input" id="terms-checkin-until">
                                            <option value="18:00">6:00 PM</option>
                                            <option value="19:00">7:00 PM</option>
                                            <option value="20:00">8:00 PM</option>
                                            <option value="21:00">9:00 PM</option>
                                            <option value="22:00" selected>10:00 PM</option>
                                            <option value="23:00">11:00 PM</option>
                                            <option value="00:00">Midnight</option>
                                            <option value="flexible">Flexible / 24hr</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Check-out By</label>
                                        <select class="form-input" id="terms-checkout">
                                            <option value="09:00">9:00 AM</option>
                                            <option value="10:00">10:00 AM</option>
                                            <option value="11:00" selected>11:00 AM</option>
                                            <option value="12:00">12:00 PM (Noon)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Late Check-out Fee</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <span></span>
                                            <input type="number" class="form-input" id="terms-late-checkout-fee" min="0" placeholder="0" style="width: 100px;">
                                            <span style="color: #64748b; font-size: 0.85rem;">(leave blank if not offered)</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-self-checkin" style="width: 18px; height: 18px;">
                                        <span>Self Check-in Available</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-24hr-checkin" style="width: 18px; height: 18px;">
                                        <span>24-Hour Check-in</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3> Smoking Policy</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="smoking-policy" value="no" checked style="width: 18px; height: 18px;">
                                            <span><strong> No Smoking</strong> - Entire property is non-smoking</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="smoking-policy" value="designated" style="width: 18px; height: 18px;">
                                            <span><strong>Designated Areas Only</strong> - Smoking in specified areas</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="smoking-policy" value="allowed" style="width: 18px; height: 18px;">
                                            <span><strong>Smoking Allowed</strong></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="form-label">Smoking Violation Fine (optional)</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <span></span>
                                        <input type="number" class="form-input" id="terms-smoking-fine" min="0" placeholder="e.g., 250" style="width: 120px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3> Pet Policy</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="pet-policy" value="no" checked style="width: 18px; height: 18px;">
                                            <span><strong>No Pets Allowed</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="pet-policy" value="yes" style="width: 18px; height: 18px;">
                                            <span><strong> Pets Allowed</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="pet-policy" value="request" style="width: 18px; height: 18px;">
                                            <span><strong>Pets on Request</strong> - Contact to confirm</span>
                                        </label>
                                    </div>
                                </div>
                                <div id="pet-details" style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; display: none;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label class="form-label">Pet Deposit (refundable)</label>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <span></span>
                                                <input type="number" class="form-input" id="terms-pet-deposit" min="0" placeholder="e.g., 50" style="width: 100px;">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Pet Fee Per Night</label>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <span></span>
                                                <input type="number" class="form-input" id="terms-pet-fee" min="0" placeholder="e.g., 15" style="width: 100px;">
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" id="terms-dogs-allowed" checked style="width: 18px; height: 18px;">
                                            <span> Dogs</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" id="terms-cats-allowed" style="width: 18px; height: 18px;">
                                            <span> Cats</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" id="terms-small-pets-only" style="width: 18px; height: 18px;">
                                            <span>Small pets only (under 10kg)</span>
                                        </label>
                                    </div>
                                    <div class="form-group" style="margin-top: 1rem;">
                                        <label class="form-label">Maximum Pets Per Room</label>
                                        <select class="form-input" id="terms-max-pets" style="width: 150px;">
                                            <option value="1">1 pet</option>
                                            <option value="2" selected>2 pets</option>
                                            <option value="3">3 pets</option>
                                            <option value="unlimited">No limit</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3> Children & Guests</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Children Policy</label>
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="children-policy" value="all" checked style="width: 18px; height: 18px;">
                                            <span><strong> Children Welcome</strong> - All ages</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="children-policy" value="5plus" style="width: 18px; height: 18px;">
                                            <span><strong>Children 5+ Only</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="children-policy" value="12plus" style="width: 18px; height: 18px;">
                                            <span><strong>Children 12+ Only</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="children-policy" value="adults18" style="width: 18px; height: 18px;">
                                            <span><strong>Adults Only (18+)</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="children-policy" value="adults21" style="width: 18px; height: 18px;">
                                            <span><strong>Adults Only (21+)</strong></span>
                                        </label>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-cots-available" style="width: 18px; height: 18px;">
                                        <span>Cots/Cribs Available</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-highchairs" style="width: 18px; height: 18px;">
                                        <span>High Chairs Available</span>
                                    </label>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="form-label">Cot Fee Per Night (if offered)</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <span></span>
                                        <input type="number" class="form-input" id="terms-cot-fee" min="0" placeholder="0 if free" style="width: 100px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3> Events & Parties</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="events-policy" value="no" checked style="width: 18px; height: 18px;">
                                            <span><strong>No Parties or Events</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="events-policy" value="small" style="width: 18px; height: 18px;">
                                            <span><strong>Small Gatherings OK</strong> - Up to 10 guests</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="events-policy" value="contact" style="width: 18px; height: 18px;">
                                            <span><strong>Events by Arrangement</strong> - Contact for approval</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3> Accessibility</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-wheelchair" style="width: 18px; height: 18px;">
                                        <span> Wheelchair Accessible</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-step-free" style="width: 18px; height: 18px;">
                                        <span>Step-Free Access</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-bathroom" style="width: 18px; height: 18px;">
                                        <span>Accessible Bathroom</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-grab-rails" style="width: 18px; height: 18px;">
                                        <span>Grab Rails</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-roll-in-shower" style="width: 18px; height: 18px;">
                                        <span>Roll-in Shower</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-elevator" style="width: 18px; height: 18px;">
                                        <span>Elevator/Lift Access</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-ground-floor" style="width: 18px; height: 18px;">
                                        <span>Ground Floor Available</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3> Additional House Rules</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Quiet Hours From</label>
                                        <select class="form-input" id="terms-quiet-from">
                                            <option value="">Not specified</option>
                                            <option value="21:00">9:00 PM</option>
                                            <option value="22:00" selected>10:00 PM</option>
                                            <option value="23:00">11:00 PM</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Quiet Hours Until</label>
                                        <select class="form-input" id="terms-quiet-until">
                                            <option value="">Not specified</option>
                                            <option value="07:00">7:00 AM</option>
                                            <option value="08:00" selected>8:00 AM</option>
                                            <option value="09:00">9:00 AM</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-no-outside-guests" style="width: 18px; height: 18px;">
                                        <span>No Outside Guests</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-id-required" style="width: 18px; height: 18px;">
                                        <span>ID Required at Check-in</span>
                                    </label>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="form-label">Additional Rules/Notes</label>
                                    <textarea class="form-input" id="terms-additional-rules" rows="3" placeholder="Any other house rules not covered above..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3> Cancellation Policy</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Cancellation Policy</label>
                                    <textarea class="form-input" id="terms-cancellation-policy" rows="4" placeholder="e.g., Free cancellation up to 48 hours before check-in. Cancellations within 48 hours will be charged for the first night. No-shows will be charged the full booking amount."></textarea>
                                    <p style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem;">This will be displayed on the room page under the Terms tab.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Link to Marketing Features -->
                <div class="card" style="margin-top: 1.5rem; background: linear-gradient(135deg, #ede9fe, #dbeafe); border: 1px solid #a5b4fc;">
                    <div class="card-body" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="margin: 0 0 0.25rem 0; color: #4338ca;"> Complete Your Property Profile</h3>
                            <p style="margin: 0; color: #6366f1;">Tell guests what makes your property special - location, style, and who it's perfect for!</p>
                        </div>
                        <a href="#" onclick="navClick(document.querySelector('[data-view=marketing]'), 'marketing'); return false;" class="btn" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); white-space: nowrap;">
                             Marketing Tags
                        </a>
                    </div>
                </div>

                <!-- Hidden amenities-list for backward compatibility -->
                <div id="amenities-list" style="display: none;"></div>
            </div>

            <!-- Availability View -->
            <div id="availability" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Availability & Pricing</h2>
                            <p>View and manage all rooms in one place</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <button class="btn" onclick="showView('gas-sync-connections')" style="background: #3b82f6;">ðŸ”„ Manage Sync Connections</button>
                        </div>
                    </div>
                </div>
                
                <!-- Property Filter Bar -->
                <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 600; white-space: nowrap;">Filter by Property:</label>
                            <select id="grid-property-filter" class="form-input" style="min-width: 250px; padding: 0.5rem;" onchange="filterGridByProperty()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="show-hidden-rooms" onchange="filterGridByProperty()">
                                <span style="font-size: 0.85rem; color: #6b7280;">Show hidden rooms</span>
                            </label>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-left: auto;">
                            
                            <button class="btn btn-secondary" onclick="shiftGridDays(-7)">âª</button>
                            <button class="btn btn-secondary" onclick="shiftGridDays(-1)">â—€</button>
                            <button class="btn btn-secondary" onclick="goToToday()">Today</button>
                            <button class="btn btn-secondary" onclick="shiftGridDays(1)">â–¶</button>
                            <button class="btn btn-secondary" onclick="shiftGridDays(7)">â©</button>
                            <input type="date" id="grid-date-picker" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" onchange="jumpToDate(this.value)">
                            <select id="grid-month-select" class="form-input" style="padding: 0.5rem 1rem; min-width: 160px; font-weight: 600; font-size: 1rem; background: #f0f9ff; border: 2px solid #0ea5e9;" onchange="jumpToMonth(this.value)">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div style="display: flex; gap: 1.5rem; margin-bottom: 1rem; font-size: 0.85rem;">
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 16px; height: 16px; background: #d1fae5; border: 1px solid #10b981; border-radius: 3px;"></span>
                        Available
                    </span>
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 16px; height: 16px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 3px;"></span>
                        Booked
                    </span>
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 16px; height: 16px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 3px;"></span>
                        Blocked
                    </span>
                </div>

                <!-- Grid Calendar -->
                <div class="card" style="overflow-x: auto; padding: 0;">
                    <table id="availability-grid" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                        <!-- Will be rendered by JS -->
                    </table>
                </div>

                <!-- Quick Edit Panel -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">Quick Edit</h3>
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <label class="form-label">Room</label>
                            <select class="form-input" id="edit-room-select">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">From</label>
                            <input type="date" class="form-input" id="edit-from-date">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">To</label>
                            <input type="date" class="form-input" id="edit-to-date">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Action</label>
                            <select class="form-input" id="edit-action" onchange="toggleEditInputs()">
                                <option value="block">Block Dates</option>
                                <option value="unblock">Unblock</option>
                                <option value="price">Set Direct Price</option>
                                <option value="discount">Set % Discount</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; display: none;" id="edit-price-group">
                            <label class="form-label">Price ($)</label>
                            <input type="number" class="form-input" id="edit-price" placeholder="150" style="width: 100px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0; display: none;" id="edit-discount-group">
                            <label class="form-label">Discount %</label>
                            <input type="number" class="form-input" id="edit-discount" placeholder="10" style="width: 80px;">
                        </div>
                        <button class="btn" onclick="applyQuickEdit()">Apply</button>
                    </div>
                </div>

                <!-- API Feed Info (collapsed) -->
                <details style="margin-top: 1rem;">
                    <summary style="cursor: pointer; color: #64748b;"> API Feed Info</summary>
                    <div class="card" style="margin-top: 0.5rem;">
                        <p style="margin-bottom: 0.5rem; color: #64748b;">Public endpoint for booking widget:</p>
                        <code style="display: block; background: var(--bg-primary); padding: 0.75rem; border-radius: 6px; font-size: 0.8rem;">
                            /api/availability/{room_id}?from=YYYY-MM-DD&to=YYYY-MM-DD
                        </code>
                    </div>
                </details>
            </div>

            <!-- Offers View -->
            <div id="offers" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Pricing & Offers</h2>
                            <p>Set your standard prices and create special offers</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="openBulkEditModal()" style="background: #f0fdf4; border-color: #86efac; color: #166534;">
                                <span></span>
                                <span>Bulk Edit</span>
                            </button>
                            <button class="btn" onclick="openAddOfferModal()">
                                <span>+</span>
                                <span>Add New Offer</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Property/Room Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px; max-width: 350px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="offers-property-select" class="form-input" onchange="loadOffersRooms()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px; max-width: 350px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="offers-room-select" class="form-input" onchange="loadOffersPricingGrid()">
                                <option value="">Select Room...</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1px;">
                            <button class="btn btn-secondary" onclick="loadOffersPricingGrid()" title="Refresh" style="padding: 0.5rem 0.65rem;">â†»</button>
                            <button class="btn btn-secondary" onclick="shiftOffersDays(-7)">Â«Â«</button>
                            <button class="btn btn-secondary" onclick="shiftOffersDays(-1)">Â«</button>
                            <button class="btn btn-secondary" onclick="offersGoToToday()">Today</button>
                            <button class="btn btn-secondary" onclick="shiftOffersDays(1)">Â»</button>
                            <button class="btn btn-secondary" onclick="shiftOffersDays(7)">Â»Â»</button>
                        </div>
                    </div>
                </div>

                <!-- Pricing Grid -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div id="offers-pricing-grid">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">
                            Select a property and room to view pricing
                        </p>
                    </div>
                </div>

                <!-- Offer Distribution Settings -->
                <div class="card" id="offer-distribution-card" style="display: none;">
                    <h3 style="margin-bottom: 1rem;"> Offer Distribution</h3>
                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                        Choose where each offer is available
                    </p>
                    <div id="offer-distribution-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Vouchers View -->
            <div id="vouchers" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Vouchers</h2>
                            <p>Gift cards, promo codes and discount vouchers</p>
                        </div>
                        <button class="btn" onclick="openAddVoucherModal()">
                            <span>+</span>
                            <span>Custom Voucher</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="vouchers-property-select" class="form-input" onchange="loadVouchersForProperty()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="vouchers-room-select" class="form-input" onchange="loadVouchersForProperty()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Add Presets -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;"> Quick Add Voucher Templates</h3>
                        <button class="btn btn-secondary" onclick="toggleVoucherPresets()" id="toggle-voucher-presets-btn" style="font-size: 0.85rem;">
                            Show All Categories 
                        </button>
                    </div>
                    
                    <!-- Popular (always visible) -->
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <button class="preset-btn" onclick="quickAddVoucher('25 Gift Voucher', 'monetary', 25)"> 25 Gift Voucher</button>
                            <button class="preset-btn" onclick="quickAddVoucher('50 Gift Voucher', 'monetary', 50)"> 50 Gift Voucher</button>
                            <button class="preset-btn" onclick="quickAddVoucher('100 Gift Voucher', 'monetary', 100)"> 100 Gift Voucher</button>
                            <button class="preset-btn" onclick="quickAddVoucher('10% Off', 'percentage', 10)"> 10% Off</button>
                            <button class="preset-btn" onclick="quickAddVoucher('15% Off', 'percentage', 15)"> 15% Off</button>
                            <button class="preset-btn" onclick="quickAddVoucher('1-Night Stay', 'stay', 1)"> 1-Night Stay</button>
                            <button class="preset-btn" onclick="quickAddVoucher('Weekend Stay', 'stay', 2)"> Weekend Stay</button>
                            <button class="preset-btn" onclick="quickAddVoucher('Free Breakfast', 'addon', 0)"> Free Breakfast</button>
                            <button class="preset-btn" onclick="quickAddVoucher('Referral 20', 'monetary', 20)"> Referral 20</button>
                        </div>
                    </div>
                    
                    <!-- All Categories (hidden by default) -->
                    <div id="all-voucher-presets" style="display: none;">
                        
                        <!-- Monetary Value -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #10b981; margin-bottom: 0.5rem; font-size: 0.9rem;"> Monetary Value Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('25 Hotel Credit', 'monetary', 25)">25 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('50 Hotel Credit', 'monetary', 50)">50 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('75 Hotel Credit', 'monetary', 75)">75 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('100 Hotel Credit', 'monetary', 100)">100 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('150 Hotel Credit', 'monetary', 150)">150 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('200 Hotel Credit', 'monetary', 200)">200 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('250 Hotel Credit', 'monetary', 250)">250 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('500 Hotel Credit', 'monetary', 500)">500 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Flexible Stay Voucher', 'monetary', 100)">Flexible Stay</button>
                            </div>
                        </div>
                        
                        <!-- Stay Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #6366f1; margin-bottom: 0.5rem; font-size: 0.9rem;"> Stay Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('1-Night Stay Voucher', 'stay', 1)">1-Night Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('2-Night Stay Voucher', 'stay', 2)">2-Night Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Weekend Stay Voucher', 'stay', 2)">Weekend Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Midweek Escape', 'stay', 2)">Midweek Escape</button>
                                <button class="preset-btn" onclick="quickAddVoucher('3-Night Break', 'stay', 3)">3-Night Break</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Week Stay Voucher', 'stay', 7)">Week Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Romantic Escape', 'stay', 2)">Romantic Escape</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Anniversary Stay', 'stay', 2)">Anniversary Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Honeymoon Package', 'stay', 3)">Honeymoon Package</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Stay + Breakfast', 'stay', 1)">Stay + Breakfast</button>
                            </div>
                        </div>
                        
                        <!-- Discount Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f59e0b; margin-bottom: 0.5rem; font-size: 0.9rem;"> Discount Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('5% Off Stay', 'percentage', 5)">5% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('10% Off Stay', 'percentage', 10)">10% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('15% Off Stay', 'percentage', 15)">15% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('20% Off Stay', 'percentage', 20)">20% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('25% Off Stay', 'percentage', 25)">25% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('20 Off Booking', 'fixed', 20)">20 Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('30 Off Booking', 'fixed', 30)">30 Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('50 Off Booking', 'fixed', 50)">50 Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('New Guest Discount', 'percentage', 10)">New Guest</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Returning Guest', 'percentage', 15)">Returning Guest</button>
                            </div>
                        </div>
                        
                        <!-- Dining Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ef4444; margin-bottom: 0.5rem; font-size: 0.9rem;"> Dining Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Breakfast Voucher', 'addon', 15)">Breakfast</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Dinner Voucher', 'addon', 40)">Dinner</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Afternoon Tea', 'addon', 30)">Afternoon Tea</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Sunday Roast', 'addon', 25)">Sunday Roast</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Wine & Dine', 'addon', 75)">Wine & Dine</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Dining for Two', 'addon', 80)">Dining for Two</button>
                            </div>
                        </div>
                        
                        <!-- Spa & Wellness -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ec4899; margin-bottom: 0.5rem; font-size: 0.9rem;"> Spa & Wellness Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Massage Session', 'addon', 60)">Massage</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Spa Day Pass', 'addon', 80)">Spa Day</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Couples Treatment', 'addon', 120)">Couples Treatment</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Facial Voucher', 'addon', 50)">Facial</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Yoga Retreat', 'addon', 45)">Yoga Retreat</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Sauna & Steam', 'addon', 30)">Sauna & Steam</button>
                            </div>
                        </div>
                        
                        <!-- Experience Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #3b82f6; margin-bottom: 0.5rem; font-size: 0.9rem;"> Experience Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Wine Tasting', 'addon', 40)">Wine Tasting</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Cooking Class', 'addon', 75)">Cooking Class</button>
                                <button class="preset-btn" onclick="quickAddVoucher('City Tour', 'addon', 35)">City Tour</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Boat Trip', 'addon', 50)">Boat Trip</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Golf Experience', 'addon', 100)">Golf Experience</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Ski Package', 'addon', 120)">Ski Package</button>
                            </div>
                        </div>
                        
                        <!-- Celebration Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #8b5cf6; margin-bottom: 0.5rem; font-size: 0.9rem;"> Celebration Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Birthday Voucher', 'monetary', 50)">Birthday</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Anniversary Voucher', 'monetary', 75)">Anniversary</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Valentine\\'s Stay', 'stay', 1)">Valentine's</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Mother\\'s Day', 'monetary', 50)">Mother's Day</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Father\\'s Day', 'monetary', 50)">Father's Day</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Christmas Gift', 'monetary', 100)">Christmas</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Graduation Gift', 'monetary', 75)">Graduation</button>
                            </div>
                        </div>
                        
                        <!-- Loyalty Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #14b8a6; margin-bottom: 0.5rem; font-size: 0.9rem;"> Loyalty & Rewards</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Thank You Voucher', 'monetary', 25)">Thank You</button>
                                <button class="preset-btn" onclick="quickAddVoucher('VIP Guest Voucher', 'percentage', 20)">VIP Guest</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Repeat Stay Credit', 'monetary', 30)">Repeat Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Referral Reward', 'monetary', 20)">Referral Reward</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Review Incentive', 'percentage', 10)">Review Incentive</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Welcome Back', 'percentage', 15)">Welcome Back</button>
                            </div>
                        </div>
                        
                        <!-- Corporate Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #64748b; margin-bottom: 0.5rem; font-size: 0.9rem;"> Corporate & Group</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Staff Reward', 'monetary', 100)">Staff Reward</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Client Gift', 'monetary', 150)">Client Gift</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Team Retreat', 'percentage', 15)">Team Retreat</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Conference Credit', 'monetary', 200)">Conference Credit</button>
                            </div>
                        </div>
                        
                        <!-- Compensation Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #dc2626; margin-bottom: 0.5rem; font-size: 0.9rem;"> Compensation & Recovery</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Refund Credit', 'monetary', 0)">Refund Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Apology Voucher', 'percentage', 20)">Apology Voucher</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Disruption Compensation', 'monetary', 50)">Disruption Comp</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Future Stay Credit', 'monetary', 0)">Future Stay</button>
                            </div>
                        </div>
                        
                        <!-- Promotional -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f97316; margin-bottom: 0.5rem; font-size: 0.9rem;"> Promotional</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Book Direct Discount', 'percentage', 10)">Book Direct</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Black Friday', 'percentage', 25)">Black Friday</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Flash Sale', 'percentage', 30)">Flash Sale</button>
                                <button class="preset-btn" onclick="quickAddVoucher('New Launch', 'percentage', 20)">New Launch</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Early Bird', 'percentage', 15)">Early Bird</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Last Minute', 'percentage', 20)">Last Minute</button>
                            </div>
                        </div>
                        
                        <!-- Service-Specific -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #06b6d4; margin-bottom: 0.5rem; font-size: 0.9rem;"> Service Add-ons</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Late Check-out', 'addon', 0)">Late Check-out</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Room Upgrade', 'addon', 0)">Room Upgrade</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Free Breakfast', 'addon', 0)">Free Breakfast</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Free Parking', 'addon', 0)">Free Parking</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Free Spa Access', 'addon', 0)">Free Spa Access</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Airport Transfer', 'addon', 0)">Airport Transfer</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Welcome Wine', 'addon', 0)">Welcome Wine</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Kids Eat Free', 'addon', 0)">Kids Eat Free</button>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- Active Vouchers List -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Your Vouchers</h3>
                    <div id="vouchers-list">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <h3>No Vouchers Created</h3>
                            <p>Click any template above or create a custom voucher</p>
                            <button class="btn" onclick="openAddVoucherModal()">Create Custom Voucher</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upsells View -->
            <div id="upsells" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Upsells</h2>
                            <p>Additional services and add-ons guests can purchase</p>
                        </div>
                        <button class="btn" onclick="openAddUpsellModal()">
                            <span>+</span>
                            <span>Custom Upsell</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="upsells-property-select" class="form-input" onchange="loadUpsellsForProperty()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="upsells-room-select" class="form-input" onchange="loadUpsellsForProperty()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Add Presets -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;"> Quick Add Popular Upsells</h3>
                        <button class="btn btn-secondary" onclick="toggleUpsellPresets()" id="toggle-presets-btn" style="font-size: 0.85rem;">
                            Show All Categories 
                        </button>
                    </div>
                    
                    <!-- Popular/Common (always visible) -->
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="popular-upsells">
                            <button class="preset-btn" onclick="quickAddUpsell('Early check-in', 25, 'per_booking')"> Early check-in</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Late check-out', 25, 'per_booking')"> Late check-out</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Airport transfer', 50, 'per_booking')"> Airport transfer</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Breakfast', 15, 'per_guest_per_night')"> Breakfast</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Parking', 15, 'per_night')"> Parking</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Pet fee', 30, 'per_booking')"> Pet fee</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Champagne on arrival', 45, 'per_booking')"> Champagne on arrival</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Welcome hamper', 35, 'per_booking')"> Welcome hamper</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Mid-stay cleaning', 50, 'per_booking')"> Mid-stay cleaning</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Extra bed', 25, 'per_night')"> Extra bed</button>
                        </div>
                    </div>
                    
                    <!-- All Categories (hidden by default) -->
                    <div id="all-upsell-presets" style="display: none;">
                        
                        <!-- Accommodation Upgrades -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #6366f1; margin-bottom: 0.5rem; font-size: 0.9rem;"> Accommodation Upgrades</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Room upgrade', 50, 'per_night')">Room upgrade</button>
                                <button class="preset-btn" onclick="quickAddUpsell('High-floor room', 20, 'per_night')">High-floor room</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Sea view room', 30, 'per_night')">Sea view</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Balcony upgrade', 25, 'per_night')">Balcony upgrade</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Executive floor access', 40, 'per_night')">Executive floor</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Connecting rooms', 30, 'per_night')">Connecting rooms</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Premium Wi-Fi', 10, 'per_night')">Premium Wi-Fi</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pillow menu upgrade', 15, 'per_booking')">Pillow menu</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Gaming console rental', 20, 'per_night')">Gaming console</button>
                            </div>
                        </div>
                        
                        <!-- Guest Comfort -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #10b981; margin-bottom: 0.5rem; font-size: 0.9rem;"> Guest Comfort & Convenience</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Extra bed / rollaway', 25, 'per_night')">Extra bed</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Baby cot / crib', 15, 'per_night')">Baby cot</button>
                                <button class="preset-btn" onclick="quickAddUpsell('High chair', 10, 'per_booking')">High chair</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Extra towels', 10, 'per_booking')">Extra towels</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Bathrobe & slippers', 20, 'per_booking')">Bathrobe & slippers</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Luxury toiletries', 25, 'per_booking')">Luxury toiletries</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Laundry service', 30, 'per_booking')">Laundry service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Dry cleaning', 25, 'per_booking')">Dry cleaning</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Turndown service', 15, 'per_night')">Turndown service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Express housekeeping', 20, 'per_booking')">Express housekeeping</button>
                            </div>
                        </div>
                        
                        <!-- Food & Beverage -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f59e0b; margin-bottom: 0.5rem; font-size: 0.9rem;"> Food & Beverage</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Continental breakfast', 12, 'per_guest_per_night')">Continental breakfast</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Full English breakfast', 18, 'per_guest_per_night')">Full English breakfast</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Breakfast in room', 25, 'per_guest_per_night')">Breakfast in room</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Welcome drinks', 20, 'per_booking')">Welcome drinks</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Welcome hamper', 35, 'per_booking')">Welcome hamper</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Champagne on arrival', 45, 'per_booking')">Champagne on arrival</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Wine on arrival', 30, 'per_booking')">Wine on arrival</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Local produce basket', 40, 'per_booking')">Local produce basket</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Minibar package', 50, 'per_booking')">Minibar package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Fridge pre-stocking', 40, 'per_booking')">Fridge pre-stocking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Private chef', 200, 'per_booking')">Private chef</button>
                                <button class="preset-btn" onclick="quickAddUpsell('BBQ pack', 35, 'per_booking')">BBQ pack</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Romantic dinner setup', 75, 'per_booking')">Romantic dinner</button>
                            </div>
                        </div>
                        
                        <!-- Celebrations -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ec4899; margin-bottom: 0.5rem; font-size: 0.9rem;"> Celebrations & Occasions</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Birthday package', 50, 'per_booking')">Birthday package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Anniversary package', 60, 'per_booking')">Anniversary package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Honeymoon package', 80, 'per_booking')">Honeymoon package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Flowers', 40, 'per_booking')">Flowers</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Chocolates', 25, 'per_booking')">Chocolates</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Balloons & decorations', 35, 'per_booking')">Balloons</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Celebration cake', 45, 'per_booking')">Celebration cake</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Rose petal decorations', 50, 'per_booking')">Rose petals</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Proposal setup', 150, 'per_booking')">Proposal setup</button>
                            </div>
                        </div>
                        
                        <!-- Transport -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #3b82f6; margin-bottom: 0.5rem; font-size: 0.9rem;"> Transport & Parking</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Airport transfer', 50, 'per_booking')">Airport transfer</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Private driver', 100, 'per_booking')">Private driver</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Shuttle service', 20, 'per_guest')">Shuttle service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Parking', 15, 'per_night')">Parking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Valet parking', 25, 'per_night')">Valet parking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('EV charging', 15, 'per_night')">EV charging</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Bicycle rental', 15, 'per_day')">Bicycle rental</button>
                                <button class="preset-btn" onclick="quickAddUpsell('E-bike rental', 30, 'per_day')">E-bike rental</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Scooter rental', 40, 'per_day')">Scooter rental</button>
                            </div>
                        </div>
                        
                        <!-- Cleaning (Airbnb style) -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #14b8a6; margin-bottom: 0.5rem; font-size: 0.9rem;"> Cleaning & Property Services</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Mid-stay cleaning', 50, 'per_booking')">Mid-stay cleaning</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Deep clean upgrade', 75, 'per_booking')">Deep clean</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Daily housekeeping', 30, 'per_night')">Daily housekeeping</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Linen swap', 25, 'per_booking')">Linen swap</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pool cleaning', 50, 'per_booking')">Pool cleaning</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Hot tub servicing', 40, 'per_booking')">Hot tub servicing</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Firewood bundle', 20, 'per_booking')">Firewood bundle</button>
                                <button class="preset-btn" onclick="quickAddUpsell('BBQ cleaning', 25, 'per_booking')">BBQ cleaning</button>
                            </div>
                        </div>
                        
                        <!-- Pets -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #8b5cf6; margin-bottom: 0.5rem; font-size: 0.9rem;"> Pet Services</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Pet fee', 30, 'per_booking')">Pet fee</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet welcome pack', 25, 'per_booking')">Pet welcome pack</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Dog bed', 15, 'per_booking')">Dog bed</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet food bowls', 10, 'per_booking')">Food bowls</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet sitting', 40, 'per_day')">Pet sitting</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Dog walking', 25, 'per_day')">Dog walking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet cleaning fee', 50, 'per_booking')">Pet cleaning fee</button>
                            </div>
                        </div>
                        
                        <!-- Business -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #64748b; margin-bottom: 0.5rem; font-size: 0.9rem;"> Business & Work</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Dedicated workspace', 20, 'per_night')">Dedicated workspace</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Printer access', 15, 'per_booking')">Printer access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Meeting room hire', 75, 'per_booking')">Meeting room</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Business lounge', 30, 'per_night')">Business lounge</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Video conference setup', 25, 'per_booking')">Video conference</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Projector hire', 40, 'per_booking')">Projector hire</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Co-working pass', 25, 'per_day')">Co-working pass</button>
                            </div>
                        </div>
                        
                        <!-- Wellness -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #06b6d4; margin-bottom: 0.5rem; font-size: 0.9rem;"> Leisure & Wellness</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Gym access', 15, 'per_night')">Gym access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Spa access', 40, 'per_guest')">Spa access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Sauna / steam room', 25, 'per_guest')">Sauna / steam</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Hot tub access', 30, 'per_night')">Hot tub access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Massage', 80, 'per_guest')">Massage</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Yoga class', 25, 'per_guest')">Yoga class</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Personal trainer', 60, 'per_booking')">Personal trainer</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pool cabana', 50, 'per_day')">Pool cabana</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Tennis court', 30, 'per_booking')">Tennis court</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Golf booking', 100, 'per_guest')">Golf booking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Wine tasting', 50, 'per_guest')">Wine tasting</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Cooking class', 75, 'per_guest')">Cooking class</button>
                            </div>
                        </div>
                        
                        <!-- Family -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f472b6; margin-bottom: 0.5rem; font-size: 0.9rem;"> Family & Children</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Babysitting', 20, 'per_hour')">Babysitting</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Nanny service', 150, 'per_day')">Nanny service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Kids activity pack', 20, 'per_booking')">Kids activity pack</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Children\'s meals', 12, 'per_guest_per_night')">Children's meals</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Baby proofing', 25, 'per_booking')">Baby proofing</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Toy rental', 15, 'per_booking')">Toy rental</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pushchair hire', 20, 'per_booking')">Pushchair hire</button>
                            </div>
                        </div>
                        
                        <!-- Protection -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ef4444; margin-bottom: 0.5rem; font-size: 0.9rem;"> Protection & Flexibility</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Flexible cancellation', 25, 'per_booking')">Flexible cancellation</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Date change protection', 20, 'per_booking')">Date change protection</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Damage waiver', 30, 'per_booking')">Damage waiver</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Travel insurance', 40, 'per_booking')">Travel insurance</button>
                            </div>
                        </div>
                        
                        <!-- Concierge -->
                        <div style="margin-bottom: 0;">
                            <h4 style="color: #a855f7; margin-bottom: 0.5rem; font-size: 0.9rem;"> Concierge Services</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Local guide', 50, 'per_booking')">Local guide</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Tour booking', 30, 'per_booking')">Tour booking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Event tickets', 25, 'per_booking')">Event tickets</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Restaurant reservations', 15, 'per_booking')">Restaurant reservations</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Personal itinerary', 75, 'per_booking')">Personal itinerary</button>
                                <button class="preset-btn" onclick="quickAddUpsell('VIP entry service', 100, 'per_booking')">VIP entry</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Upsells List -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Your Upsells</h3>
                    <div id="upsells-list">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <h3>No Upsells Configured</h3>
                            <p>Click any preset above or create a custom upsell</p>
                            <button class="btn" onclick="openAddUpsellModal()">Create Custom Upsell</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fees View -->
            <div id="fees" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Fees</h2>
                            <p>Mandatory charges and taxes applied to bookings</p>
                        </div>
                        <button class="btn" onclick="openAddFeeModal()">
                            <span>+</span>
                            <span>Add Fee</span>
                        </button>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 1rem; background: #fef3c7; border: 1px solid #fde68a;">
                    <h3 style="color: #92400e; margin-bottom: 0.5rem;"> Common Fee Types</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; color: #78350f;">
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;"> Cleaning fee</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;"> City/Tourist tax</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;"> Damage deposit</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;"> Pet fee</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;"> Resort fee</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;"> Parking fee</span>
                    </div>
                </div>

                <div class="card">
                    <div id="fees-list">
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <h3>No Fees Configured</h3>
                            <p>Add cleaning fees, taxes, or other charges</p>
                            <button class="btn" onclick="openAddFeeModal()">Add Your First Fee</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vendors View -->
            <div id="vendors" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Vendors</h2>
                            <p>External service providers (taxis, tours, restaurants, etc.)</p>
                        </div>
                        <button class="btn" onclick="openVendorModal()">
                            <span>+</span>
                            Add Vendor
                        </button>
                    </div>
                </div>
                <div class="content">
                    <div class="card">
                        <div id="vendors-list">
                            <p style="text-align: center; color: #64748b; padding: 2rem;">Loading vendors...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vendor Service Requests View -->
            <div id="vendor-requests" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Service Requests</h2>
                            <p>Track vendor fulfillment for bookings with external services</p>
                        </div>
                    </div>
                </div>
                <div class="content">
                    <!-- Filters -->
                    <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <label style="font-weight: 600;">Status:</label>
                                <select id="vendor-requests-status-filter" class="form-input" style="width: auto;" onchange="loadVendorRequests()">
                                    <option value="">All</option>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <label style="font-weight: 600;">Vendor:</label>
                                <select id="vendor-requests-vendor-filter" class="form-input" style="width: auto;" onchange="loadVendorRequests()">
                                    <option value="">All Vendors</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div id="vendor-requests-summary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;"></div>
                    
                    <!-- Requests List -->
                    <div class="card">
                        <div id="vendor-requests-list">
                            <p style="text-align: center; color: #64748b; padding: 2rem;">Loading service requests...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Taxes View -->
            <div id="taxes" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Tourist Taxes</h2>
                            <p>Government-mandated taxes that vary by location</p>
                        </div>
                        <button class="btn" onclick="openAddTaxModal()">
                            <span>+</span>
                            <span>Add Tax</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="taxes-property-select" class="form-input" onchange="loadTaxesForProperty()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="taxes-room-select" class="form-input" onchange="loadTaxesForProperty()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 1rem; background: linear-gradient(135deg, #dbeafe 0%, #ede9fe 100%); border: 1px solid #c7d2fe;">
                    <h3 style="color: #4338ca; margin-bottom: 0.75rem;"> Tourist Tax Guide</h3>
                    <p style="color: #5b21b6; margin-bottom: 1rem; font-size: 0.9rem;">
                        Tourist taxes vary significantly by country and city. Configure them based on your property location.
                    </p>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                             France: 2-11 PPPN
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                             Italy: 1-10 PPPN
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                             Amsterdam: 12.5%
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                             USA: 10-16%
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                             Spain: 1-7 PPPN
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                             Dubai: 7-20 AED PPPN
                        </span>
                    </div>
                </div>

                <div class="card">
                    <div id="taxes-list">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">
                            Select a property to view and manage taxes
                        </p>
                    </div>
                </div>
            </div>

            <!-- Payments View -->
            <div id="payments" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Payments</h2>
                            <p>View payment status and transactions for all bookings</p>
                        </div>
                    </div>
                </div>

                <!-- Stripe Connection Status -->
                <div id="stripe-connection-status" class="card" style="margin-bottom: 1rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%); border: 1px solid #c7d2fe;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="color: #4338ca; margin-bottom: 0.5rem;"> Stripe Connection</h3>
                            <p id="stripe-status-text" style="color: #5b21b6; font-size: 0.9rem;">Checking connection status...</p>
                        </div>
                        <div id="stripe-connect-btn-area">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Payment Filters -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="payments-property-select" class="form-input" onchange="loadPaymentsForProperty()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Payment Status</label>
                            <select id="payments-status-select" class="form-input" onchange="loadPaymentsForProperty()">
                                <option value="">All Statuses</option>
                                <option value="pending"> Pending</option>
                                <option value="deposit_paid"> Deposit Paid</option>
                                <option value="fully_paid"> Fully Paid</option>
                                <option value="refunded"> Refunded</option>
                                <option value="failed"> Failed</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Date Range</label>
                            <select id="payments-date-range" class="form-input" onchange="loadPaymentsForProperty()">
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                                <option value="all">All time</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Payment Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="padding: 1.25rem; text-align: center;">
                        <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.5rem;">Pending Payments</div>
                        <div id="pending-payments-count" style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;">0</div>
                    </div>
                    <div class="card" style="padding: 1.25rem; text-align: center;">
                        <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.5rem;">Deposits Received</div>
                        <div id="deposits-received-amount" style="font-size: 1.75rem; font-weight: 700; color: #3b82f6;">0</div>
                    </div>
                    <div class="card" style="padding: 1.25rem; text-align: center;">
                        <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.5rem;">Balance Due</div>
                        <div id="balance-due-amount" style="font-size: 1.75rem; font-weight: 700; color: #ef4444;">0</div>
                    </div>
                    <div class="card" style="padding: 1.25rem; text-align: center;">
                        <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.5rem;">Total Collected</div>
                        <div id="total-collected-amount" style="font-size: 1.75rem; font-weight: 700; color: #10b981;">0</div>
                    </div>
                </div>

                <!-- Bookings with Payment Status -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Bookings & Payment Status</h3>
                    <div id="payments-bookings-list">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">
                            Loading bookings...
                        </p>
                    </div>
                </div>
            </div>

            <!-- Deposit Rules View -->
            <div id="deposit-rules" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Deposit Rules</h2>
                            <p>Configure payment policies for your properties</p>
                        </div>
                        <button class="btn" onclick="openAddDepositRuleModal()">
                            <span>+</span>
                            <span>Add Rule</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Apply To</label>
                            <select id="deposit-rules-property-select" class="form-input" onchange="loadDepositRulesForProperty()">
                                <option value="">Select Property...</option>
                                <option value="all"> All Properties (Account Default)</option>
                            </select>
                        </div>
                        <button class="btn" onclick="openBulkDepositRuleModal()" style="background: #6366f1; white-space: nowrap; height: 42px;">
                             Apply to Multiple
                        </button>
                    </div>
                    <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">
                         Select a property above to create a deposit rule for a single property, or click "Apply to Multiple" to create the same rule across several properties at once.
                    </p>
                </div>

                <!-- Deposit Rules Info -->
                <div class="card" style="margin-bottom: 1rem; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid #a7f3d0;">
                    <h3 style="color: #047857; margin-bottom: 0.75rem;"> How Deposit Rules Work</h3>
                    <div style="color: #065f46; font-size: 0.9rem; line-height: 1.6;">
                        <p style="margin-bottom: 0.75rem;">Deposit rules control how guests pay for their bookings:</p>
                        <ul style="margin: 0; padding-left: 1.5rem;">
                            <li><strong>Deposit Type:</strong> Percentage (e.g., 30%), fixed amount, first night, or full payment</li>
                            <li><strong>Balance Due:</strong> When the remaining amount is due (e.g., 14 days before check-in)</li>
                            <li><strong>Refund Policy:</strong> Flexible, moderate, strict, or non-refundable</li>
                            <li><strong>Auto-charge:</strong> Automatically charge the balance when due</li>
                        </ul>
                    </div>
                </div>

                <!-- Deposit Rules List -->
                <div class="card">
                    <div id="deposit-rules-list">
                        <p style="color: #64748b; text-align: center; padding: 2rem;">
                            Select a property to view deposit rules
                        </p>
                    </div>
                </div>
            </div>

            <!-- Marketing View -->
            <div id="marketing" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Marketing Tags</h2>
                            <p>Define what makes your property special to help travel agents find you</p>
                        </div>
                    </div>
                </div>

                <!-- Property & Room Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Select Property</label>
                            <select id="marketing-property-select" class="form-input" onchange="loadMarketingRooms()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Select Room/Unit</label>
                            <select id="marketing-room-select" class="form-input" onchange="loadRoomFeatures()">
                                <option value="">All Rooms (Property-wide)</option>
                            </select>
                        </div>
                        <div id="marketing-save-btn" style="display: none;">
                            <button class="btn" onclick="saveMarketingFeatures()" style="background: #16a34a;">
                                 Save Features
                            </button>
                        </div>
                    </div>
                    
                    <!-- Apply to all rooms checkbox -->
                    <div id="apply-all-rooms-container" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                            <input type="checkbox" id="apply-to-all-rooms" style="width: 18px; height: 18px;">
                            <span><strong>Apply changes to ALL rooms</strong> in this property</span>
                        </label>
                        <p style="margin: 0.5rem 0 0 2rem; font-size: 0.85rem; color: #3b82f6;">
                            When checked, saving will update all rooms. When unchecked, only the selected room is updated.
                        </p>
                    </div>
                    
                    <!-- Room feature status indicator -->
                    <div id="marketing-room-status" style="display: none; margin-top: 0.75rem; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.9rem;">
                    </div>
                </div>

                <!-- Features Content -->
                <div id="marketing-content" style="display: none;">
                    
                    <!-- AI Suggestion Panel -->
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; color: white;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.5rem;"></span>
                            <h4 style="margin: 0; font-weight: 600;">AI Feature Suggestions</h4>
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <textarea id="marketing-ai-prompt" rows="2" placeholder="Describe your property... e.g. 'Victorian B&B near the beach, dog-friendly, great for romantic getaways and walking holidays'" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; font-size: 0.9rem;"></textarea>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="aiSuggestFeatures()" style="background: white; color: #8b5cf6; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer;"> Suggest Features</button>
                        </div>
                    </div>
                    
                    <!-- AI Suggestions Results (hidden by default) -->
                    <div id="ai-suggestions-results" class="card" style="margin-bottom: 1rem; display: none; border: 2px solid #8b5cf6;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> AI Suggested Features
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            Click on suggestions to add them to your property
                        </p>
                        <div id="ai-suggestions-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <!-- AI suggestions will appear here -->
                        </div>
                    </div>
                    
                    <!-- Activities -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Activities & Experiences
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            What activities can guests enjoy at or near your property?
                        </p>
                        <div class="feature-grid" data-category="activities">
                            <label class="feature-item"><input type="checkbox" data-feature="walking">  Walking / Hiking</label>
                            <label class="feature-item"><input type="checkbox" data-feature="cycling">  Cycling</label>
                            <label class="feature-item"><input type="checkbox" data-feature="golf">  Golf</label>
                            <label class="feature-item"><input type="checkbox" data-feature="fishing">  Fishing</label>
                            <label class="feature-item"><input type="checkbox" data-feature="water-sports">  Water Sports</label>
                            <label class="feature-item"><input type="checkbox" data-feature="horse-riding">  Horse Riding</label>
                            <label class="feature-item"><input type="checkbox" data-feature="skiing">  Skiing / Winter Sports</label>
                            <label class="feature-item"><input type="checkbox" data-feature="birdwatching">  Birdwatching / Wildlife</label>
                            <label class="feature-item"><input type="checkbox" data-feature="wine-tasting">  Wine Tasting</label>
                            <label class="feature-item"><input type="checkbox" data-feature="cooking-classes">  Cooking Classes</label>
                        </div>
                    </div>

                    <!-- Guest Types -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Guest Types & Accessibility
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            Who is your property best suited for?
                        </p>
                        <div class="feature-grid" data-category="guest-types">
                            <label class="feature-item"><input type="checkbox" data-feature="pet-friendly">  Pet Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="family-friendly">  Family Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="adults-only">  Adults Only</label>
                            <label class="feature-item"><input type="checkbox" data-feature="wheelchair-accessible">  Wheelchair Accessible</label>
                            <label class="feature-item"><input type="checkbox" data-feature="senior-friendly">  Senior Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="lgbtq-friendly">  LGBTQ+ Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="business-travelers">  Business Travelers</label>
                            <label class="feature-item"><input type="checkbox" data-feature="digital-nomads">  Digital Nomads</label>
                        </div>
                    </div>

                    <!-- Themes & Experiences -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Themes & Experiences
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            What type of experience does your property offer?
                        </p>
                        <div class="feature-grid" data-category="themes">
                            <label class="feature-item"><input type="checkbox" data-feature="romantic">  Romantic / Couples</label>
                            <label class="feature-item"><input type="checkbox" data-feature="wellness-spa">  Wellness / Spa</label>
                            <label class="feature-item"><input type="checkbox" data-feature="adventure">  Adventure</label>
                            <label class="feature-item"><input type="checkbox" data-feature="eco-friendly">  Eco-Friendly / Sustainable</label>
                            <label class="feature-item"><input type="checkbox" data-feature="luxury">  Luxury</label>
                            <label class="feature-item"><input type="checkbox" data-feature="budget-friendly">  Budget Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="historic">  Historic / Heritage</label>
                            <label class="feature-item"><input type="checkbox" data-feature="boutique">  Boutique / Unique</label>
                            <label class="feature-item"><input type="checkbox" data-feature="farm-stay">  Farm Stay / Agritourism</label>
                            <label class="feature-item"><input type="checkbox" data-feature="glamping">  Glamping</label>
                        </div>
                    </div>

                    <!-- Location Features -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Location & Setting
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            Describe your property's location and surroundings
                        </p>
                        <div class="feature-grid" data-category="location">
                            <label class="feature-item"><input type="checkbox" data-feature="beachfront">  Beachfront</label>
                            <label class="feature-item"><input type="checkbox" data-feature="mountain-view">  Mountain View</label>
                            <label class="feature-item"><input type="checkbox" data-feature="countryside">  Countryside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="city-centre">  City Centre</label>
                            <label class="feature-item"><input type="checkbox" data-feature="lakeside">  Lakeside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="riverside">  Riverside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="forest">  Forest / Woodland</label>
                            <label class="feature-item"><input type="checkbox" data-feature="village">  Village / Rural</label>
                            <label class="feature-item"><input type="checkbox" data-feature="coastal">  Coastal</label>
                            <label class="feature-item"><input type="checkbox" data-feature="island">  Island</label>
                        </div>
                    </div>

                    <!-- Nearby -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Nearby (within 15 mins)
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            What's conveniently close to your property?
                        </p>
                        <div class="feature-grid" data-category="nearby">
                            <label class="feature-item"><input type="checkbox" data-feature="near-beach">  Beach</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-train">  Train Station</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-airport">  Airport</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-transport">  Public Transport</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-restaurants">  Restaurants & Dining</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-shopping">  Shopping</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-golf">  Golf Course</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-ski">  Ski Resort</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-hiking">  Hiking Trails</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-attractions">  Tourist Attractions</label>
                        </div>
                    </div>

                    <!-- Property Amenities -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Notable Amenities
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            Highlight standout amenities that set you apart
                        </p>
                        <div class="feature-grid" data-category="amenities">
                            <label class="feature-item"><input type="checkbox" data-feature="ev-charging">  EV Charging</label>
                            <label class="feature-item"><input type="checkbox" data-feature="swimming-pool">  Swimming Pool</label>
                            <label class="feature-item"><input type="checkbox" data-feature="hot-tub">  Hot Tub / Jacuzzi</label>
                            <label class="feature-item"><input type="checkbox" data-feature="sauna">  Sauna</label>
                            <label class="feature-item"><input type="checkbox" data-feature="gym">  Gym / Fitness</label>
                            <label class="feature-item"><input type="checkbox" data-feature="garden">  Garden</label>
                            <label class="feature-item"><input type="checkbox" data-feature="bbq">  BBQ Area</label>
                            <label class="feature-item"><input type="checkbox" data-feature="fireplace">  Fireplace</label>
                            <label class="feature-item"><input type="checkbox" data-feature="private-parking">  Private Parking</label>
                            <label class="feature-item"><input type="checkbox" data-feature="restaurant">  On-site Restaurant</label>
                        </div>
                    </div>

                    <!-- Property Type & Style -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Property Type & Style
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            What type of property are you, and what's your style?
                        </p>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label">Property Type</label>
                            <select id="marketing-property-type" class="form-input" style="max-width: 300px;">
                                <option value="">Select type...</option>
                                <option value="hotel">Hotel</option>
                                <option value="bnb">Bed & Breakfast</option>
                                <option value="guesthouse">Guest House</option>
                                <option value="inn">Inn</option>
                                <option value="boutique">Boutique Hotel</option>
                                <option value="apartment">Self-Catering / Apartment</option>
                                <option value="villa">Villa</option>
                                <option value="cottage">Cottage</option>
                                <option value="cabin">Cabin / Lodge</option>
                                <option value="farmhouse">Farmhouse / Agriturismo</option>
                                <option value="hostel">Hostel</option>
                                <option value="resort">Resort</option>
                            </select>
                        </div>
                        <div class="feature-grid" data-category="property-style">
                            <label class="feature-item"><input type="checkbox" data-feature="modern">  Modern / Contemporary</label>
                            <label class="feature-item"><input type="checkbox" data-feature="traditional">  Traditional</label>
                            <label class="feature-item"><input type="checkbox" data-feature="rustic">  Rustic / Countryside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="minimalist">  Minimalist</label>
                            <label class="feature-item"><input type="checkbox" data-feature="quirky">  Quirky / Unique</label>
                            <label class="feature-item"><input type="checkbox" data-feature="cozy">  Cozy / Homely</label>
                        </div>
                    </div>

                    <!-- Awards & Recognition -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Awards & Recognition
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            Showcase your achievements and certifications
                        </p>
                        <div class="feature-grid" data-category="awards">
                            <label class="feature-item"><input type="checkbox" data-feature="tripadvisor-coe">  TripAdvisor Certificate of Excellence</label>
                            <label class="feature-item"><input type="checkbox" data-feature="booking-award">  Booking.com Traveller Review Award</label>
                            <label class="feature-item"><input type="checkbox" data-feature="green-tourism">  Green Tourism Certified</label>
                            <label class="feature-item"><input type="checkbox" data-feature="michelin">  Michelin Guide Listed</label>
                            <label class="feature-item"><input type="checkbox" data-feature="aa-rated">  AA Rated</label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Star Rating (Official)</label>
                                <select id="marketing-star-rating" class="form-input">
                                    <option value="">Not rated</option>
                                    <option value="1"> 1 Star</option>
                                    <option value="2"> 2 Stars</option>
                                    <option value="3"> 3 Stars</option>
                                    <option value="4"> 4 Stars</option>
                                    <option value="5"> 5 Stars</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Year Established</label>
                                <input type="number" id="marketing-year-established" class="form-input" placeholder="e.g., 1985" min="1800" max="2025">
                            </div>
                        </div>
                    </div>

                    <!-- Custom Features -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Custom Features
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            Add any unique features not listed above
                        </p>
                        <div id="custom-features-list" style="margin-bottom: 1rem;">
                            <!-- Custom features will be added here -->
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="new-custom-feature" class="form-input" placeholder="e.g., Treehouse, Observatory, Private Cinema" style="flex: 1;">
                            <button class="btn btn-secondary" onclick="addCustomFeature()">+ Add</button>
                        </div>
                    </div>

                    <!-- Room Exclusions -->
                    <div class="card" id="room-exclusions-card" style="margin-bottom: 1rem; display: none;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span></span> Room Exclusions
                        </h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            Some features may not apply to all rooms. Select features to see which rooms to exclude.
                        </p>
                        <div id="room-exclusions-content">
                            <p style="color: #64748b; font-style: italic;">Select a feature above to manage room exclusions</p>
                        </div>
                    </div>

                </div>

                <!-- Empty State -->
                <div id="marketing-empty" class="card">
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>Select a Property</h3>
                        <p>Choose a property above to manage its marketing features and tags</p>
                    </div>
                </div>
            </div>

            <!-- Turbine Connections View -->
            <div id="turbine-connections" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ðŸ”— Social Media Connections</h2>
                            <p>Connect your social media accounts to share offers with your audience</p>
                        </div>
                    </div>
                </div>

                <!-- Connected Accounts -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 1rem; font-size: 1rem; color: #374151;">Connected Accounts</h3>
                    <div id="turbine-connections-list">
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <p>No accounts connected yet</p>
                            <p style="font-size: 0.85rem;">Connect your first social media account below</p>
                        </div>
                    </div>
                </div>

                <!-- Connect New Account -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem; font-size: 1rem; color: #374151;">Connect New Account</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        
                        <!-- Facebook -->
                        <div style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.2s;">
                            <div style="width: 50px; height: 50px; background: #1877f2; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                <span style="color: white; font-size: 1.5rem;">f</span>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; color: #1e293b;">Facebook</h4>
                            <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 1rem;">Pages & Business accounts</p>
                            <button class="btn btn-secondary" onclick="connectTurbine('facebook')" style="width: 100%;">
                                Connect
                            </button>
                        </div>

                        <!-- Instagram -->
                        <div style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.2s;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                <span style="color: white; font-size: 1.5rem;">ðŸ“·</span>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; color: #1e293b;">Instagram</h4>
                            <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 1rem;">Business & Creator accounts</p>
                            <button class="btn btn-secondary" onclick="connectTurbine('instagram')" style="width: 100%;">
                                Connect
                            </button>
                        </div>

                        <!-- Twitter/X -->
                        <div style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.2s;">
                            <div style="width: 50px; height: 50px; background: #000000; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                <span style="color: white; font-size: 1.25rem; font-weight: bold;">ð•</span>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; color: #1e293b;">X (Twitter)</h4>
                            <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 1rem;">Post tweets & threads</p>
                            <button class="btn btn-secondary" onclick="connectTurbine('twitter')" style="width: 100%;">
                                Connect
                            </button>
                        </div>

                        <!-- TikTok -->
                        <div style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.2s;">
                            <div style="width: 50px; height: 50px; background: #000000; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                <span style="color: white; font-size: 1.25rem;">â™ª</span>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; color: #1e293b;">TikTok</h4>
                            <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 1rem;">Business accounts</p>
                            <button class="btn btn-secondary" onclick="connectTurbine('tiktok')" style="width: 100%;">
                                Connect
                            </button>
                        </div>

                        <!-- LinkedIn -->
                        <div style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.2s;">
                            <div style="width: 50px; height: 50px; background: #0a66c2; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                                <span style="color: white; font-size: 1.25rem; font-weight: bold;">in</span>
                            </div>
                            <h4 style="margin-bottom: 0.5rem; color: #1e293b;">LinkedIn</h4>
                            <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 1rem;">Company pages & profiles</p>
                            <button class="btn btn-secondary" onclick="connectTurbine('linkedin')" style="width: 100%;">
                                Connect
                            </button>
                        </div>

                    </div>
                    
                    <!-- Info Note -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px;">
                        <p style="margin: 0; font-size: 0.85rem; color: #1e40af;">
                            <strong>â„¹ï¸ Note:</strong> Social media connections require authorization from each platform. 
                            You'll be redirected to log in and grant access. Your credentials are never stored by GAS.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Turbine Generator View -->
            <div id="turbine-generator" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ðŸ“ Post Generator</h2>
                            <p>Create and schedule social media posts for your offers</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="openCreatePostModal()">
                                <span>+</span>
                                <span>Create Post</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 1.25rem;">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #3b82f6;" id="turbine-stat-scheduled">0</div>
                        <div style="font-size: 0.8rem; color: #64748b;">Scheduled</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.25rem;">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #10b981;" id="turbine-stat-posted">0</div>
                        <div style="font-size: 0.8rem; color: #64748b;">Posted</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.25rem;">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #8b5cf6;" id="turbine-stat-drafts">0</div>
                        <div style="font-size: 0.8rem; color: #64748b;">Drafts</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.25rem;">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;" id="turbine-stat-connections">0</div>
                        <div style="font-size: 0.8rem; color: #64748b;">Connections</div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary turbine-filter active" data-filter="all" onclick="filterTurbinePosts('all')" style="background: #3b82f6; color: white;">All Posts</button>
                        <button class="btn btn-secondary turbine-filter" data-filter="scheduled" onclick="filterTurbinePosts('scheduled')">ðŸ“… Scheduled</button>
                        <button class="btn btn-secondary turbine-filter" data-filter="posted" onclick="filterTurbinePosts('posted')">âœ… Posted</button>
                        <button class="btn btn-secondary turbine-filter" data-filter="draft" onclick="filterTurbinePosts('draft')">ðŸ“ Drafts</button>
                    </div>
                </div>

                <!-- Posts List -->
                <div class="card">
                    <div id="turbine-posts-list">
                        <!-- Empty State -->
                        <div style="text-align: center; padding: 3rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“</div>
                            <h3 style="margin-bottom: 0.5rem; color: #1e293b;">No Posts Yet</h3>
                            <p style="color: #64748b; margin-bottom: 1.5rem;">Create your first social media post to promote your offers</p>
                            <button class="btn" onclick="openCreatePostModal()">
                                <span>+</span>
                                <span>Create Your First Post</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Turbine Campaigns View -->
            <div id="turbine-campaigns" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ðŸ“£ Campaigns</h2>
                            <p>Create targeted promotions and send to your network</p>
                        </div>
                        <button class="btn" onclick="openCreateCampaignModal()">
                            <span>+ New Campaign</span>
                        </button>
                    </div>
                </div>

                <!-- Campaign Stats -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #3b82f6;" id="campaign-stat-active">0</div>
                        <div style="color: #64748b; font-size: 0.85rem;">Active</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #10b981;" id="campaign-stat-sent">0</div>
                        <div style="color: #64748b; font-size: 0.85rem;">Sent</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #8b5cf6;" id="campaign-stat-draft">0</div>
                        <div style="color: #64748b; font-size: 0.85rem;">Drafts</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;" id="campaign-stat-clicks">0</div>
                        <div style="color: #64748b; font-size: 0.85rem;">Total Clicks</div>
                    </div>
                </div>

                <!-- Availability Gaps Alert -->
                <div id="availability-gaps-alert" style="display: none; margin-bottom: 1.5rem;">
                    <div class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;">ðŸ’¡</div>
                            <div style="flex: 1;">
                                <strong style="color: #92400e;">Availability Gaps Detected</strong>
                                <p style="margin: 0.25rem 0 0 0; color: #a16207; font-size: 0.9rem;" id="gaps-summary">You have unbooked nights that could be filled with a promotion</p>
                            </div>
                            <button class="btn" onclick="showAvailabilityGaps()" style="background: #f59e0b;">View Gaps</button>
                        </div>
                    </div>
                </div>

                <!-- Campaigns List -->
                <div class="card">
                    <div id="campaigns-list">
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“£</div>
                            <h3 style="margin-bottom: 0.5rem; color: #1e293b;">No campaigns yet</h3>
                            <p style="margin-bottom: 1.5rem;">Create your first campaign to fill availability gaps and boost bookings</p>
                            <button class="btn" onclick="openCreateCampaignModal()">+ Create Campaign</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GAS Network Contacts View -->
            <div id="network-contacts" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ðŸ‘¥ Contacts</h2>
                            <p>Manage your guest contacts and email list</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="openImportContactsModal()">
                                <span>ðŸ“¤ Import CSV</span>
                            </button>
                            <button class="btn" onclick="openAddContactModal()">
                                <span>+ Add Contact</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Contact Stats -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #3b82f6;" id="contact-stat-total">0</div>
                        <div style="color: #64748b; font-size: 0.85rem;">Total Contacts</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #10b981;" id="contact-stat-bookings">0</div>
                        <div style="color: #64748b; font-size: 0.85rem;">From Bookings</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #8b5cf6;" id="contact-stat-import">0</div>
                        <div style="color: #64748b; font-size: 0.85rem;">Imported</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;" id="contact-stat-repeat">0</div>
                        <div style="color: #64748b; font-size: 0.85rem;">Repeat Guests</div>
                    </div>
                </div>

                <!-- Search & Filter -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <input type="text" id="contact-search" class="form-input" placeholder="Search by name or email..." style="flex: 1; min-width: 200px;" onkeyup="debounceContactSearch()">
                        <select id="contact-tag-filter" class="form-input" style="width: 200px;" onchange="loadNetworkContacts()">
                            <option value="">All Tags</option>
                        </select>
                    </div>
                </div>

                <!-- Contacts List -->
                <div class="card">
                    <div id="contacts-list">
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ‘¥</div>
                            <h3 style="margin-bottom: 0.5rem; color: #1e293b;">No contacts yet</h3>
                            <p style="margin-bottom: 1.5rem;">Add contacts manually or import from a CSV file</p>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button class="btn btn-secondary" onclick="openImportContactsModal()">ðŸ“¤ Import CSV</button>
                                <button class="btn" onclick="openAddContactModal()">+ Add Contact</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GAS Network Tags View -->
            <div id="network-tags" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ðŸ·ï¸ Tags</h2>
                            <p>Manage interest and preference tags for your contacts</p>
                        </div>
                        <button class="btn" onclick="openAddTagModal()">
                            <span>+ New Tag</span>
                        </button>
                    </div>
                </div>

                <!-- Tags by Category -->
                <div id="tags-container">
                    <div style="text-align: center; padding: 2rem;"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- GAS Network Segments View -->
            <div id="network-segments" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ðŸ“Š Segments</h2>
                            <p>Create saved audience filters for targeted campaigns</p>
                        </div>
                        <button class="btn" onclick="openCreateSegmentModal()">
                            <span>+ New Segment</span>
                        </button>
                    </div>
                </div>

                <!-- Segments List -->
                <div class="card">
                    <div id="segments-list">
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“Š</div>
                            <h3 style="margin-bottom: 0.5rem; color: #1e293b;">No segments yet</h3>
                            <p style="margin-bottom: 1.5rem;">Create segments to target specific groups of contacts</p>
                            <button class="btn" onclick="openCreateSegmentModal()">+ Create Segment</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Requests View -->
            <div id="agent-requests" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ðŸ“‹ Agent Requests</h2>
                            <p>Travel agents requesting access to market your properties</p>
                        </div>
                    </div>
                </div>

                <div class="card" style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ“‹</div>
                    <h3 style="margin-bottom: 0.5rem; color: #1e293b;">No Pending Requests</h3>
                    <p style="color: #64748b; max-width: 500px; margin: 0 auto 1.5rem;">
                        When travel agents request access to market your properties, they'll appear here for your approval.
                    </p>
                    <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 1rem; max-width: 400px; margin: 0 auto;">
                        <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
                            <strong>ðŸ’¡ How it works:</strong><br>
                            Agents find your property â†’ Request access â†’ You approve â†’ Set your agent price â†’ They book clients
                        </p>
                    </div>
                </div>
            </div>

            <!-- Agent Approved View -->
            <div id="agent-approved" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>âœ… Approved Agents</h2>
                            <p>Travel agents authorized to book your properties</p>
                        </div>
                    </div>
                </div>

                <div class="card" style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">âœ…</div>
                    <h3 style="margin-bottom: 0.5rem; color: #1e293b;">No Approved Agents Yet</h3>
                    <p style="color: #64748b; max-width: 500px; margin: 0 auto;">
                        Agents you approve will appear here. You can manage their access and view their bookings.
                    </p>
                </div>
            </div>

            <!-- Agent Pricing View -->
            <div id="agent-pricing" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ðŸ’° Agent Pricing</h2>
                            <p>Set the net rates agents pay you - they add their own markup</p>
                        </div>
                    </div>
                </div>

                <!-- Property/Room Selector -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="agent-pricing-property" class="form-input" onchange="loadAgentPricingRooms()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="agent-pricing-room" class="form-input" onchange="loadAgentPricing()">
                                <option value="">Select Room...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Pricing Info -->
                <div class="card">
                    <div style="text-align: center; padding: 2rem; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ’°</div>
                        <h3 style="margin-bottom: 0.5rem; color: #1e293b;">Agent Pricing Coming Soon</h3>
                        <p style="max-width: 500px; margin: 0 auto 1.5rem;">
                            Set net rates for travel agents. They see your price, add their markup, and pay you the agreed amount.
                        </p>
                        <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 1rem; max-width: 450px; margin: 0 auto;">
                            <p style="margin: 0; color: #92400e; font-size: 0.9rem;">
                                <strong>Example:</strong><br>
                                Your standard price: Â£200/night<br>
                                Your agent price: Â£160/night<br>
                                Agent sells at: Â£190/night (their choice)<br>
                                Agent pays you: Â£160/night âœ“
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Editor - Tabbed Interface -->
            <div id="website-editor" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> <span id="editor-site-name">Website Editor</span></h2>
                            <p class="subtitle" id="editor-site-url-display">Customize your website settings</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="backToSitesList()">
                                <span></span>
                                <span>Back to Sites</span>
                            </button>
                            <a id="editor-preview-btn" href="#" target="_blank" class="btn btn-secondary" style="display: none;">
                                <span></span>
                                <span>View Live Site</span>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Editor Tabs -->
                <div class="editor-tabs" style="display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; overflow-x: auto;">
                    <button class="editor-tab active" data-tab="header" onclick="switchEditorTab('header')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                         Header & Logo
                    </button>
                    <button class="editor-tab" data-tab="homepage" onclick="switchEditorTab('homepage')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                         Home Page
                    </button>
                    <button class="editor-tab" id="subpages-tab" data-tab="subpages" onclick="switchEditorTab('subpages')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                         Sub Pages
                    </button>
                    <button class="editor-tab" data-tab="footer" onclick="switchEditorTab('footer')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                         Footer
                    </button>
                    <button class="editor-tab" data-tab="styles" onclick="switchEditorTab('styles')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                        ðŸŽ¨ Styles & Fonts
                    </button>
                    <button class="editor-tab" data-tab="seo" onclick="switchEditorTab('seo')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                         SEO & Analytics
                    </button>
                    <button class="editor-tab" data-tab="wpguide" onclick="switchEditorTab('wpguide')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                         WP Guide
                    </button>
                    <button class="editor-tab" data-tab="customdomain" onclick="switchEditorTab('customdomain')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                        ðŸŒ Custom Domain
                    </button>
                </div>
                
                <!-- Tab Content Panels -->
                <div id="editor-tab-content">
                    <!-- Header Tab -->
                    <div id="editor-panel-header" class="editor-panel">
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                            <button class="btn" onclick="saveWebsiteSection('header', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Header</button>
                        </div>
                        <div id="editor-header-content"></div>
                    </div>
                    
                    <!-- Home Page Tab -->
                    <div id="editor-panel-homepage" class="editor-panel" style="display: none;">
                        <!-- Sub-tabs for home page sections -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button class="sub-tab active" data-subtab="hero" onclick="switchHomeSubTab('hero')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: #7c3aed; color: white; cursor: pointer; font-size: 0.875rem;"> Hero</button>
                            <button class="sub-tab" data-subtab="intro" onclick="switchHomeSubTab('intro')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;"> Intro</button>
                            <button class="sub-tab" data-subtab="featured" onclick="switchHomeSubTab('featured')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;"> Featured</button>
                            <button class="sub-tab" data-subtab="about" onclick="switchHomeSubTab('about')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;"> About</button>
                            <button class="sub-tab" data-subtab="reviews" onclick="switchHomeSubTab('reviews')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;"> Reviews</button>
                            <button class="sub-tab" data-subtab="cta" onclick="switchHomeSubTab('cta')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;"> CTA</button>
                        </div>
                        <div id="editor-homepage-hero" class="home-subtab-panel">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('hero', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Hero</button>
                            </div>
                            <div id="editor-hero-content"></div>
                            <div class="card" style="margin-top: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3> FAQ Schema</h3>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                                        <input type="checkbox" id="wb-hero-faq-enabled" checked>
                                        Enable FAQ Schema
                                    </label>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>What is FAQ Schema?</strong> It's structured data that helps Google understand your FAQs. 
                                        When added to your page, your questions may appear directly in Google search results under "People also ask", 
                                        increasing visibility and click-through rates.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateFAQs('hero')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate FAQs with AI</button>
                                        <button type="button" class="btn btn-sm" onclick="addFAQItem('hero')" style="background: #64748b;">+ Add FAQ Manually</button>
                                    </div>
                                    <div id="wb-hero-faq-list" class="faq-list"></div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> Homepage SEO</h3></div>
                                <div class="card-body">
                                    <div style="margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateSEOMeta('hero')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate Title & Description with AI</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Title <small style="color: #64748b;">(50-60 characters)</small></label>
                                        <input type="text" class="form-input" id="wb-hero-meta-title" placeholder="e.g., The Adelphi Hotel Liverpool | Book Direct for Best Rates">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description <small style="color: #64748b;">(150-160 characters)</small></label>
                                        <textarea class="form-input" id="wb-hero-meta-description" rows="3" placeholder="e.g., Book direct at The Adelphi Hotel Liverpool for the best rates. Historic boutique hotel in the heart of Liverpool city centre."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="editor-homepage-intro" class="home-subtab-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('intro', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Intro</button>
                            </div>
                            <div id="editor-intro-content"></div>
                        </div>
                        <div id="editor-homepage-featured" class="home-subtab-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('featured', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Featured</button>
                            </div>
                            <div id="editor-featured-content"></div>
                        </div>
                        <div id="editor-homepage-about" class="home-subtab-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('about', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save About</button>
                            </div>
                            <div id="editor-about-content"></div>
                        </div>
                        <div id="editor-homepage-reviews" class="home-subtab-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('reviews', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Reviews</button>
                            </div>
                            <div id="editor-reviews-content"></div>
                        </div>
                        <div id="editor-homepage-cta" class="home-subtab-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('cta', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save CTA</button>
                            </div>
                            <div id="editor-cta-content"></div>
                        </div>
                    </div>
                    
                    <!-- Sub Pages Tab -->
                    <div id="editor-panel-subpages" class="editor-panel" style="display: none;">
                        <!-- Sync Button Bar -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.75rem 1rem; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 10px; border: 1px solid #93c5fd;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;">ðŸ”„</span>
                                <span style="font-weight: 500; color: #1e40af;">After enabling or disabling pages, sync to update your WordPress site</span>
                            </div>
                            <button id="sync-pages-btn" onclick="syncPagesToWordPress(this)" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                ðŸš€ Sync Pages to WordPress
                            </button>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button class="sub-tab active" data-subtab="page-rooms" onclick="switchSubPageTab('page-rooms')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: #7c3aed; color: white; cursor: pointer; font-size: 0.875rem;">
                                <span class="page-status-dot" id="status-page-rooms" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981; margin-right: 6px;"></span>Rooms
                            </button>
                            <button class="sub-tab" data-subtab="page-about" onclick="switchSubPageTab('page-about')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">
                                <span class="page-status-dot" id="status-page-about" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; margin-right: 6px;"></span>About Us
                            </button>
                            <button class="sub-tab" data-subtab="page-gallery" onclick="switchSubPageTab('page-gallery')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">
                                <span class="page-status-dot" id="status-page-gallery" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; margin-right: 6px;"></span>Gallery
                            </button>
                            <button class="sub-tab" data-subtab="page-offers" onclick="switchSubPageTab('page-offers')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">
                                <span class="page-status-dot" id="status-page-offers" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; margin-right: 6px;"></span>Special Offers
                            </button>
                            <button class="sub-tab" data-subtab="page-properties" onclick="switchSubPageTab('page-properties')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">
                                <span class="page-status-dot" id="status-page-properties" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; margin-right: 6px;"></span>Properties
                            </button>
                            <button class="sub-tab" data-subtab="page-dining" onclick="switchSubPageTab('page-dining')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">
                                <span class="page-status-dot" id="status-page-dining" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; margin-right: 6px;"></span>Dining
                            </button>
                            <button class="sub-tab" data-subtab="page-blog" data-requires-feature="blog_module" onclick="switchSubPageTab('page-blog')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">
                                <span class="page-status-dot" id="status-page-blog" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; margin-right: 6px;"></span>Blog <span class="feature-lock-icon" style="display: none;">ðŸ”’</span>
                            </button>
                            <button class="sub-tab" data-subtab="page-attractions" data-requires-feature="attractions_module" onclick="switchSubPageTab('page-attractions')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">
                                <span class="page-status-dot" id="status-page-attractions" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; margin-right: 6px;"></span>Attractions <span class="feature-lock-icon" style="display: none;">ðŸ”’</span>
                            </button>
                            <button class="sub-tab" data-subtab="page-reviews" data-requires-feature="reviews_widget" onclick="switchSubPageTab('page-reviews')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">
                                <span class="page-status-dot" id="status-page-reviews" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; margin-right: 6px;"></span>Reviews <span class="feature-lock-icon" style="display: none;">ðŸ”’</span>
                            </button>
                            <button class="sub-tab" data-subtab="page-contact" onclick="switchSubPageTab('page-contact')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">
                                <span class="page-status-dot" id="status-page-contact" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981; margin-right: 6px;"></span>Contact
                            </button>
                        </div>
                        <div id="editor-subpage-page-rooms" class="subpage-panel">
                            <!-- Page Enable Toggle -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 1px solid #bbf7d0;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                        <input type="checkbox" id="wb-page-rooms-enabled" checked disabled style="width: 20px; height: 20px; accent-color: #10b981;">
                                        <span style="font-weight: 600; color: #166534;">Rooms Page Enabled</span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: #166534; background: #bbf7d0; padding: 2px 8px; border-radius: 4px;">Core Page - Always On</span>
                                </div>
                                <button class="btn" onclick="saveWebsiteSection('page-rooms', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Rooms Page</button>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>Page Header</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Page Title</label>
                                        <input type="text" class="form-input" id="wb-page-rooms-title" placeholder="e.g., Our Rooms & Suites" value="Book Your Stay">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Subtitle</label>
                                        <input type="text" class="form-input" id="wb-page-rooms-subtitle" placeholder="e.g., Find your perfect accommodation">
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>Search Widget</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                            <input type="checkbox" id="wb-page-rooms-show-search" checked style="width: 18px; height: 18px;">
                                            <span>Show Search Widget</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>Listing Display</h3></div>
                                <div class="card-body">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label class="form-label">Room Layout Style</label>
                                            <select class="form-select" id="wb-page-rooms-layout-style">
                                                <option value="auto" selected>Auto (adapts to screen)</option>
                                                <option value="grid">Grid (cards)</option>
                                                <option value="row">Row (horizontal)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Columns</label>
                                            <select class="form-select" id="wb-page-rooms-columns">
                                                <option value="2">2 Columns</option>
                                                <option value="3" selected>3 Columns</option>
                                                <option value="4">4 Columns</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                        <div class="form-group">
                                            <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                                <input type="checkbox" id="wb-page-rooms-show-amenity-filter" checked style="width: 18px; height: 18px;">
                                                <span>Show Amenity Filter</span>
                                            </label>
                                        </div>
                                        <div class="form-group">
                                            <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                                <input type="checkbox" id="wb-page-rooms-show-location-filter" checked style="width: 18px; height: 18px;">
                                                <span>Show Location Filter</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin-top: 1rem;">
                                        <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                            <input type="checkbox" id="wb-page-rooms-show-map" style="width: 18px; height: 18px;">
                                            <span>Show Map View Toggle</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3>Styling</h3></div>
                                <div class="card-body">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label class="form-label">Background Color</label>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <input type="color" id="wb-page-rooms-bg-color" value="#ffffff" style="width: 50px; height: 36px; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">
                                                <input type="text" class="form-input" id="wb-page-rooms-bg" value="#ffffff" style="flex: 1;" oninput="document.getElementById('wb-page-rooms-bg-color').value = this.value">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Text Color</label>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <input type="color" id="wb-page-rooms-text-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">
                                                <input type="text" class="form-input" id="wb-page-rooms-text-color" value="#1e293b" style="flex: 1;" oninput="document.getElementById('wb-page-rooms-text-color-picker').value = this.value">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div style="margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateSEOMeta('rooms')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate Title & Description with AI</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Title <small style="color: #64748b;">(50-60 characters)</small></label>
                                        <input type="text" class="form-input" id="wb-page-rooms-meta-title" placeholder="e.g., Rooms & Suites | The Adelphi Hotel Liverpool">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description <small style="color: #64748b;">(150-160 characters)</small></label>
                                        <textarea class="form-input" id="wb-page-rooms-meta-description" rows="3" placeholder="e.g., Explore our range of rooms at The Adelphi Hotel Liverpool. From cosy singles to luxury suites. Book direct for best rates."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3> FAQ Schema</h3>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                                        <input type="checkbox" id="wb-page-rooms-faq-enabled" checked>
                                        Enable FAQ Schema
                                    </label>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>What is FAQ Schema?</strong> It's structured data that helps Google understand your FAQs. 
                                        When added to your page, your questions may appear directly in Google search results under "People also ask", 
                                        increasing visibility and click-through rates.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateFAQs('rooms')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate FAQs with AI</button>
                                        <button type="button" class="btn btn-sm" onclick="addFAQItem('rooms')" style="background: #64748b;">+ Add FAQ Manually</button>
                                    </div>
                                    <div id="wb-page-rooms-faq-list" class="faq-list"></div>
                                </div>
                            </div>
                        </div>
                        <div id="editor-subpage-page-about" class="subpage-panel" style="display: none;">
                            <!-- Page Enable Toggle -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; border: 1px solid #e9d5ff;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                        <input type="checkbox" id="wb-page-about-enabled" onchange="togglePageEnabled('about', this.checked)" style="width: 20px; height: 20px; accent-color: #7c3aed;">
                                        <span style="font-weight: 600; color: #6b21a8;">Enable About Us Page</span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: #7c3aed; background: #e9d5ff; padding: 2px 8px; border-radius: 4px;">Free</span>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
                                        <label style="font-size: 0.85rem; color: #6b21a8;">Menu Position:</label>
                                        <input type="number" id="wb-page-about-menu-order" value="2" min="1" max="20" style="width: 60px; padding: 4px 8px; border: 1px solid #e9d5ff; border-radius: 6px; text-align: center;">
                                    </div>
                                </div>
                                <button class="btn" onclick="saveWebsiteSection('page-about', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save About Page</button>
                            </div>
                            
                            <!-- Page Header Section -->
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>ðŸ“„ Page Header</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Menu Title <small style="color: #64748b;">(appears in navigation menu)</small></label>
                                        <input type="text" class="form-input" id="wb-page-about-menu-title" placeholder="e.g., About Us" value="About Us" style="flex: 1;">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Page Title <small style="color: #64748b;">(displayed on page hero)</small></label>
                                        <div style="display: flex; gap: 8px;">
                                            <input type="text" class="form-input" id="wb-page-about-title" placeholder="e.g., R Apartments, Villa Talang" value="" style="flex: 1;">
                                            <button type="button" class="btn" onclick="generatePageAboutTitle()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); white-space: nowrap;">âœ¨ Generate</button>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Page Subtitle</label>
                                        <input type="text" class="form-input" id="wb-page-about-subtitle" placeholder="e.g., Learn more about our story and values">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Header Background Image</label>
                                        <div id="wb-page-about-hero-image-preview" style="width: 100%; height: 150px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; background-size: cover; background-position: center;">
                                            <span style="color: #94a3b8;">Click below to upload a header image</span>
                                        </div>
                                        <input type="file" id="wb-page-about-hero-image-file" accept="image/*" onchange="previewPageImage('about', 'hero-image')">
                                        <input type="hidden" id="wb-page-about-hero-image">
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                        <div class="form-group">
                                            <label class="form-label">Header Background Color</label>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <input type="color" id="wb-page-about-header-bg-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-page-about-header-bg').value = this.value">
                                                <input type="text" class="form-input" id="wb-page-about-header-bg" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-page-about-header-bg-picker')">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Header Text Color</label>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <input type="color" id="wb-page-about-header-text-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-page-about-header-text').value = this.value">
                                                <input type="text" class="form-input" id="wb-page-about-header-text" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-page-about-header-text-picker')">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Page Content Section -->
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>ðŸ“ Page Content</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Content Title (H2)</label>
                                        <input type="text" class="form-input" id="wb-page-about-content-title" placeholder="e.g., Our Story, Welcome, About Us">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Main Content</label>
                                        <textarea class="form-textarea" id="wb-page-about-content" rows="8" placeholder="Tell your story here... You can write multiple paragraphs about your property, your team, your values, and what makes you unique."></textarea>
                                        <button type="button" class="btn" onclick="generatePageAboutContent()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); margin-top: 8px;">âœ¨ Generate About Content</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Content Image (Optional)</label>
                                        <div id="wb-page-about-content-image-preview" style="width: 100%; height: 200px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; background-size: cover; background-position: center;">
                                            <span style="color: #94a3b8;">Click below to upload an image</span>
                                        </div>
                                        <input type="file" id="wb-page-about-content-image-file" accept="image/*" onchange="previewPageImage('about', 'content-image')">
                                        <input type="hidden" id="wb-page-about-content-image">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Image Position</label>
                                        <select class="form-select" id="wb-page-about-image-position">
                                            <option value="right">Image Right</option>
                                            <option value="left">Image Left</option>
                                            <option value="top">Image Top (Full Width)</option>
                                            <option value="none">No Image</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Page Styling Section -->
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>ðŸŽ¨ Page Styling</h3></div>
                                <div class="card-body">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label class="form-label">Page Background</label>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <input type="color" id="wb-page-about-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-page-about-bg').value = this.value">
                                                <input type="text" class="form-input" id="wb-page-about-bg" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-page-about-bg-picker')">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Title Color</label>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <input type="color" id="wb-page-about-title-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-page-about-title-color').value = this.value">
                                                <input type="text" class="form-input" id="wb-page-about-title-color" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-page-about-title-color-picker')">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Text Color</label>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <input type="color" id="wb-page-about-text-color-picker" value="#475569" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-page-about-text-color').value = this.value">
                                                <input type="text" class="form-input" id="wb-page-about-text-color" value="#475569" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-page-about-text-color-picker')">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-top: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3> FAQ Schema</h3>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                                        <input type="checkbox" id="wb-page-about-faq-enabled" checked>
                                        Enable FAQ Schema
                                    </label>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>What is FAQ Schema?</strong> It's structured data that helps Google understand your FAQs. 
                                        When added to your page, your questions may appear directly in Google search results under "People also ask", 
                                        increasing visibility and click-through rates.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateFAQs('about')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate FAQs with AI</button>
                                        <button type="button" class="btn btn-sm" onclick="addFAQItem('about')" style="background: #64748b;">+ Add FAQ Manually</button>
                                    </div>
                                    <div id="wb-page-about-faq-list" class="faq-list"></div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div style="margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateSEOMeta('about')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate Title & Description with AI</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Title <small style="color: #64748b;">(50-60 characters)</small></label>
                                        <input type="text" class="form-input" id="wb-page-about-meta-title" placeholder="e.g., About Us | The Adelphi Hotel Liverpool">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description <small style="color: #64748b;">(150-160 characters)</small></label>
                                        <textarea class="form-input" id="wb-page-about-meta-description" rows="3" placeholder="e.g., Discover the history of The Adelphi Hotel. A Liverpool landmark since 1826."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="editor-subpage-page-gallery" class="subpage-panel" style="display: none;">
                            <!-- Page Enable Toggle -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; border: 1px solid #e9d5ff;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                        <input type="checkbox" id="wb-page-gallery-enabled" onchange="togglePageEnabled('gallery', this.checked)" style="width: 20px; height: 20px; accent-color: #7c3aed;">
                                        <span style="font-weight: 600; color: #6b21a8;">Enable Gallery Page</span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: #7c3aed; background: #e9d5ff; padding: 2px 8px; border-radius: 4px;">Free</span>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
                                        <label style="font-size: 0.85rem; color: #6b21a8;">Menu Position:</label>
                                        <input type="number" id="wb-page-gallery-menu-order" value="3" min="1" max="20" style="width: 60px; padding: 4px 8px; border: 1px solid #e9d5ff; border-radius: 6px; text-align: center;">
                                    </div>
                                </div>
                                <button class="btn" onclick="saveWebsiteSection('page-gallery', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Gallery Page</button>
                            </div>
                            <div id="editor-page-gallery-content"></div>
                            <div class="card" style="margin-top: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3> FAQ Schema</h3>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                                        <input type="checkbox" id="wb-page-gallery-faq-enabled" checked>
                                        Enable FAQ Schema
                                    </label>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>What is FAQ Schema?</strong> It's structured data that helps Google understand your FAQs. 
                                        When added to your page, your questions may appear directly in Google search results under "People also ask", 
                                        increasing visibility and click-through rates.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateFAQs('gallery')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate FAQs with AI</button>
                                        <button type="button" class="btn btn-sm" onclick="addFAQItem('gallery')" style="background: #64748b;">+ Add FAQ Manually</button>
                                    </div>
                                    <div id="wb-page-gallery-faq-list" class="faq-list"></div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div style="margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateSEOMeta('gallery')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate Title & Description with AI</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Title <small style="color: #64748b;">(50-60 characters)</small></label>
                                        <input type="text" class="form-input" id="wb-page-gallery-meta-title" placeholder="e.g., Photo Gallery | The Adelphi Hotel Liverpool">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description <small style="color: #64748b;">(150-160 characters)</small></label>
                                        <textarea class="form-input" id="wb-page-gallery-meta-description" rows="3" placeholder="e.g., Browse photos of our beautiful rooms, restaurant and facilities."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="editor-subpage-page-blog" class="subpage-panel" style="display: none;">
                            <!-- Page Enable Toggle - Paid Feature -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 1px solid #fcd34d;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                        <input type="checkbox" id="wb-page-blog-enabled" onchange="togglePageEnabled('blog', this.checked)" style="width: 20px; height: 20px; accent-color: #f59e0b;">
                                        <span style="font-weight: 600; color: #92400e;">Enable Blog Page</span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: #92400e; background: #fcd34d; padding: 2px 8px; border-radius: 4px;">ðŸ”’ Requires Blog App</span>
                                </div>
                                <button class="btn" onclick="saveWebsiteSection('page-blog', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Blog Page</button>
                            </div>
                            <div id="editor-page-blog-content"></div>
                            <div class="card" style="margin-top: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3> FAQ Schema</h3>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                                        <input type="checkbox" id="wb-page-blog-faq-enabled" checked>
                                        Enable FAQ Schema
                                    </label>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>What is FAQ Schema?</strong> It's structured data that helps Google understand your FAQs. 
                                        When added to your page, your questions may appear directly in Google search results under "People also ask", 
                                        increasing visibility and click-through rates.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateFAQs('blog')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate FAQs with AI</button>
                                        <button type="button" class="btn btn-sm" onclick="addFAQItem('blog')" style="background: #64748b;">+ Add FAQ Manually</button>
                                    </div>
                                    <div id="wb-page-blog-faq-list" class="faq-list"></div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div style="margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateSEOMeta('blog')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate Title & Description with AI</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Title <small style="color: #64748b;">(50-60 characters)</small></label>
                                        <input type="text" class="form-input" id="wb-page-blog-meta-title" placeholder="e.g., Blog | News & Travel Tips | The Adelphi Hotel">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description <small style="color: #64748b;">(150-160 characters)</small></label>
                                        <textarea class="form-input" id="wb-page-blog-meta-description" rows="3" placeholder="e.g., Read our latest news, travel tips and local guides for Liverpool."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="editor-subpage-page-attractions" class="subpage-panel" style="display: none;">
                            <!-- Page Enable Toggle - Paid Feature -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 1px solid #fcd34d;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                        <input type="checkbox" id="wb-page-attractions-enabled" onchange="togglePageEnabled('attractions', this.checked)" style="width: 20px; height: 20px; accent-color: #f59e0b;">
                                        <span style="font-weight: 600; color: #92400e;">Enable Attractions Page</span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: #92400e; background: #fcd34d; padding: 2px 8px; border-radius: 4px;">ðŸ”’ Requires Attractions App</span>
                                </div>
                                <button class="btn" onclick="saveWebsiteSection('page-attractions', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Attractions Page</button>
                            </div>
                            <div id="editor-page-attractions-content"></div>
                            <div class="card" style="margin-top: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3> FAQ Schema</h3>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                                        <input type="checkbox" id="wb-page-attractions-faq-enabled" checked>
                                        Enable FAQ Schema
                                    </label>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>What is FAQ Schema?</strong> It's structured data that helps Google understand your FAQs. 
                                        When added to your page, your questions may appear directly in Google search results under "People also ask", 
                                        increasing visibility and click-through rates.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateFAQs('attractions')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate FAQs with AI</button>
                                        <button type="button" class="btn btn-sm" onclick="addFAQItem('attractions')" style="background: #64748b;">+ Add FAQ Manually</button>
                                    </div>
                                    <div id="wb-page-attractions-faq-list" class="faq-list"></div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div style="margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateSEOMeta('attractions')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate Title & Description with AI</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Title <small style="color: #64748b;">(50-60 characters)</small></label>
                                        <input type="text" class="form-input" id="wb-page-attractions-meta-title" placeholder="e.g., Things To Do in Liverpool | The Adelphi Hotel">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description <small style="color: #64748b;">(150-160 characters)</small></label>
                                        <textarea class="form-input" id="wb-page-attractions-meta-description" rows="3" placeholder="e.g., Discover the best attractions, restaurants and activities near The Adelphi Hotel Liverpool."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="editor-subpage-page-dining" class="subpage-panel" style="display: none;">
                            <!-- Page Enable Toggle -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; border: 1px solid #e9d5ff;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                        <input type="checkbox" id="wb-page-dining-enabled" onchange="togglePageEnabled('dining', this.checked)" style="width: 20px; height: 20px; accent-color: #7c3aed;">
                                        <span style="font-weight: 600; color: #6b21a8;">Enable Dining Page</span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: #7c3aed; background: #e9d5ff; padding: 2px 8px; border-radius: 4px;">Free</span>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
                                        <label style="font-size: 0.85rem; color: #6b21a8;">Menu Position:</label>
                                        <input type="number" id="wb-page-dining-menu-order" value="4" min="1" max="20" style="width: 60px; padding: 4px 8px; border: 1px solid #e9d5ff; border-radius: 6px; text-align: center;">
                                    </div>
                                </div>
                                <button class="btn" onclick="saveWebsiteSection('page-dining', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Dining Page</button>
                            </div>
                            <div id="editor-page-dining-content"></div>
                            <div class="card" style="margin-top: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3> FAQ Schema</h3>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                                        <input type="checkbox" id="wb-page-dining-faq-enabled" checked>
                                        Enable FAQ Schema
                                    </label>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>What is FAQ Schema?</strong> It's structured data that helps Google understand your FAQs. 
                                        When added to your page, your questions may appear directly in Google search results under "People also ask", 
                                        increasing visibility and click-through rates.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateFAQs('dining')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate FAQs with AI</button>
                                        <button type="button" class="btn btn-sm" onclick="addFAQItem('dining')" style="background: #64748b;">+ Add FAQ Manually</button>
                                    </div>
                                    <div id="wb-page-dining-faq-list" class="faq-list"></div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div style="margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateSEOMeta('dining')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate Title & Description with AI</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Title <small style="color: #64748b;">(50-60 characters)</small></label>
                                        <input type="text" class="form-input" id="wb-page-dining-meta-title" placeholder="e.g., Restaurant & Dining | The Adelphi Hotel Liverpool">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description <small style="color: #64748b;">(150-160 characters)</small></label>
                                        <textarea class="form-input" id="wb-page-dining-meta-description" rows="3" placeholder="e.g., Experience fine dining at The Adelphi Hotel restaurant. British cuisine with a modern twist."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Special Offers Page Panel -->
                        <div id="editor-subpage-page-offers" class="subpage-panel" style="display: none;">
                            <!-- Page Enable Toggle -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; border: 1px solid #e9d5ff;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                        <input type="checkbox" id="wb-page-offers-enabled" onchange="togglePageEnabled('offers', this.checked)" style="width: 20px; height: 20px; accent-color: #7c3aed;">
                                        <span style="font-weight: 600; color: #6b21a8;">Enable Special Offers Page</span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: #7c3aed; background: #e9d5ff; padding: 2px 8px; border-radius: 4px;">Free</span>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
                                        <label style="font-size: 0.85rem; color: #6b21a8;">Menu Position:</label>
                                        <input type="number" id="wb-page-offers-menu-order" value="5" min="1" max="20" style="width: 60px; padding: 4px 8px; border: 1px solid #e9d5ff; border-radius: 6px; text-align: center;">
                                    </div>
                                </div>
                                <button class="btn" onclick="saveWebsiteSection('page-offers', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Offers Page</button>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>ðŸ“„ Page Header</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Page Title</label>
                                        <input type="text" class="form-input" id="wb-page-offers-title" placeholder="e.g., Special Offers" value="Special Offers">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Page Subtitle</label>
                                        <input type="text" class="form-input" id="wb-page-offers-subtitle" placeholder="e.g., Exclusive deals and discounts">
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>ðŸ“ Page Content</h3></div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem;">This page will automatically display offers created in the Bookings & Revenue â†’ Offers section.</p>
                                    <div class="form-group">
                                        <label class="form-label">Intro Text (Optional)</label>
                                        <textarea class="form-textarea" id="wb-page-offers-content" rows="4" placeholder="Add an introduction to your special offers page..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Meta Title</label>
                                        <input type="text" class="form-input" id="wb-page-offers-meta-title" placeholder="e.g., Special Offers | Your Hotel Name">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description</label>
                                        <textarea class="form-input" id="wb-page-offers-meta-description" rows="3" placeholder="e.g., Discover our latest special offers and exclusive deals..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Properties Page Panel -->
                        <div id="editor-subpage-page-properties" class="subpage-panel" style="display: none;">
                            <!-- Page Enable Toggle -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; border: 1px solid #e9d5ff;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                        <input type="checkbox" id="wb-page-properties-enabled" onchange="togglePageEnabled('properties', this.checked)" style="width: 20px; height: 20px; accent-color: #7c3aed;">
                                        <span style="font-weight: 600; color: #6b21a8;">Enable Properties Page</span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: #7c3aed; background: #e9d5ff; padding: 2px 8px; border-radius: 4px;">Free</span>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
                                        <label style="font-size: 0.85rem; color: #6b21a8;">Menu Position:</label>
                                        <input type="number" id="wb-page-properties-menu-order" value="6" min="1" max="20" style="width: 60px; padding: 4px 8px; border: 1px solid #e9d5ff; border-radius: 6px; text-align: center;">
                                    </div>
                                </div>
                                <button class="btn" onclick="saveWebsiteSection('page-properties', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Properties Page</button>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>ðŸ“„ Page Header</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Page Title</label>
                                        <input type="text" class="form-input" id="wb-page-properties-title" placeholder="e.g., Our Properties" value="Our Properties">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Page Subtitle</label>
                                        <input type="text" class="form-input" id="wb-page-properties-subtitle" placeholder="e.g., Explore our collection of vacation rentals">
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>ðŸ“ Page Content</h3></div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem;">This page displays all your properties. Useful for multi-property accounts.</p>
                                    <div class="form-group">
                                        <label class="form-label">Intro Text (Optional)</label>
                                        <textarea class="form-textarea" id="wb-page-properties-content" rows="4" placeholder="Add an introduction to your properties page..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Meta Title</label>
                                        <input type="text" class="form-input" id="wb-page-properties-meta-title" placeholder="e.g., Our Properties | Your Brand Name">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description</label>
                                        <textarea class="form-input" id="wb-page-properties-meta-description" rows="3" placeholder="e.g., Browse our collection of vacation rental properties..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reviews Page Panel -->
                        <div id="editor-subpage-page-reviews" class="subpage-panel" style="display: none;">
                            <!-- Page Enable Toggle - Paid Feature -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 1px solid #fcd34d;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                        <input type="checkbox" id="wb-page-reviews-enabled" onchange="togglePageEnabled('reviews', this.checked)" style="width: 20px; height: 20px; accent-color: #f59e0b;">
                                        <span style="font-weight: 600; color: #92400e;">Enable Reviews Page</span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: #92400e; background: #fcd34d; padding: 2px 8px; border-radius: 4px;">ðŸ”’ Requires Reviews App</span>
                                </div>
                                <button class="btn" onclick="saveWebsiteSection('page-reviews', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Reviews Page</button>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>ðŸ“„ Page Header</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Page Title</label>
                                        <input type="text" class="form-input" id="wb-page-reviews-title" placeholder="e.g., Guest Reviews" value="Guest Reviews">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Page Subtitle</label>
                                        <input type="text" class="form-input" id="wb-page-reviews-subtitle" placeholder="e.g., See what our guests are saying">
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>ðŸ“ Page Content</h3></div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem;">This page will display reviews from the Reviews App. Subscribe to unlock this feature.</p>
                                    <div class="form-group">
                                        <label class="form-label">Intro Text (Optional)</label>
                                        <textarea class="form-textarea" id="wb-page-reviews-content" rows="4" placeholder="Add an introduction to your reviews page..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Meta Title</label>
                                        <input type="text" class="form-input" id="wb-page-reviews-meta-title" placeholder="e.g., Guest Reviews | Your Hotel Name">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description</label>
                                        <textarea class="form-input" id="wb-page-reviews-meta-description" rows="3" placeholder="e.g., Read genuine reviews from our guests..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="editor-subpage-page-contact" class="subpage-panel" style="display: none;">
                            <!-- Page Enable Toggle -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 1px solid #bbf7d0;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                        <input type="checkbox" id="wb-page-contact-enabled" checked onchange="togglePageEnabled('contact', this.checked)" style="width: 20px; height: 20px; accent-color: #10b981;">
                                        <span style="font-weight: 600; color: #166534;">Enable Contact Page</span>
                                    </label>
                                    <span style="font-size: 0.8rem; color: #166534; background: #bbf7d0; padding: 2px 8px; border-radius: 4px;">Free</span>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
                                        <label style="font-size: 0.85rem; color: #166534;">Menu Position:</label>
                                        <input type="number" id="wb-page-contact-menu-order" value="8" min="1" max="20" style="width: 60px; padding: 4px 8px; border: 1px solid #bbf7d0; border-radius: 6px; text-align: center;">
                                    </div>
                                </div>
                                <button class="btn" onclick="saveWebsiteSection('page-contact', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Contact Page</button>
                            </div>
                            <div id="editor-page-contact-content"></div>
                            <div class="card" style="margin-top: 1.5rem; margin-bottom: 1.5rem; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3> FAQ Schema</h3>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                                        <input type="checkbox" id="wb-page-contact-faq-enabled" checked>
                                        Enable FAQ Schema
                                    </label>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>What is FAQ Schema?</strong> It's structured data that helps Google understand your FAQs. 
                                        When added to your page, your questions may appear directly in Google search results under "People also ask", 
                                        increasing visibility and click-through rates.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateFAQs('contact')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate FAQs with AI</button>
                                        <button type="button" class="btn btn-sm" onclick="addFAQItem('contact')" style="background: #64748b;">+ Add FAQ Manually</button>
                                    </div>
                                    <div id="wb-page-contact-faq-list" class="faq-list"></div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div style="margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateSEOMeta('contact')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate Title & Description with AI</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Title <small style="color: #64748b;">(50-60 characters)</small></label>
                                        <input type="text" class="form-input" id="wb-page-contact-meta-title" placeholder="e.g., Contact Us | The Adelphi Hotel Liverpool">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description <small style="color: #64748b;">(150-160 characters)</small></label>
                                        <textarea class="form-input" id="wb-page-contact-meta-description" rows="3" placeholder="e.g., Contact The Adelphi Hotel Liverpool. Located in the city centre. Call us or book online."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer Tab -->
                    <div id="editor-panel-footer" class="editor-panel" style="display: none;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button class="sub-tab active" data-subtab="footer-main" onclick="switchFooterTab('footer-main')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: #7c3aed; color: white; cursor: pointer; font-size: 0.875rem;"> Footer Settings</button>
                            <button class="sub-tab" data-subtab="footer-terms" onclick="switchFooterTab('footer-terms')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;"> Terms & Conditions</button>
                            <button class="sub-tab" data-subtab="footer-privacy" onclick="switchFooterTab('footer-privacy')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;"> Privacy Policy</button>
                        </div>
                        <div id="editor-footer-footer-main" class="footer-panel">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('footer', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Footer</button>
                            </div>
                            <div id="editor-footer-content"></div>
                        </div>
                        <div id="editor-footer-footer-terms" class="footer-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-terms', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Terms</button>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div style="margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateSEOMeta('terms')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate Title & Description with AI</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Title <small style="color: #64748b;">(50-60 characters)</small></label>
                                        <input type="text" class="form-input" id="wb-page-terms-meta-title" placeholder="e.g., Terms & Conditions | The Adelphi Hotel">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description <small style="color: #64748b;">(150-160 characters)</small></label>
                                        <textarea class="form-input" id="wb-page-terms-meta-description" rows="3" placeholder="e.g., Read our terms and conditions for booking at The Adelphi Hotel Liverpool."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3> FAQ Schema</h3>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                                        <input type="checkbox" id="wb-page-terms-faq-enabled" checked>
                                        Enable FAQ Schema
                                    </label>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>What is FAQ Schema?</strong> It's structured data that helps Google understand your FAQs. 
                                        When added to your page, your questions may appear directly in Google search results under "People also ask", 
                                        increasing visibility and click-through rates.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateFAQs('terms')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate FAQs with AI</button>
                                        <button type="button" class="btn btn-sm" onclick="addFAQItem('terms')" style="background: #64748b;">+ Add FAQ Manually</button>
                                    </div>
                                    <div id="wb-page-terms-faq-list" class="faq-list"></div>
                                </div>
                            </div>
                            <div id="editor-terms-content"></div>
                        </div>
                        <div id="editor-footer-footer-privacy" class="footer-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-privacy', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Privacy</button>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><h3> SEO Settings</h3></div>
                                <div class="card-body">
                                    <div style="margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateSEOMeta('privacy')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate Title & Description with AI</button>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Title <small style="color: #64748b;">(50-60 characters)</small></label>
                                        <input type="text" class="form-input" id="wb-page-privacy-meta-title" placeholder="e.g., Privacy Policy | The Adelphi Hotel">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meta Description <small style="color: #64748b;">(150-160 characters)</small></label>
                                        <textarea class="form-input" id="wb-page-privacy-meta-description" rows="3" placeholder="e.g., Read our privacy policy to understand how we protect your data."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
                                    <h3> FAQ Schema</h3>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                                        <input type="checkbox" id="wb-page-privacy-faq-enabled" checked>
                                        Enable FAQ Schema
                                    </label>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">
                                        <strong>What is FAQ Schema?</strong> It's structured data that helps Google understand your FAQs. 
                                        When added to your page, your questions may appear directly in Google search results under "People also ask", 
                                        increasing visibility and click-through rates.
                                    </p>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                        <button type="button" class="btn btn-sm" onclick="generateFAQs('privacy')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Generate FAQs with AI</button>
                                        <button type="button" class="btn btn-sm" onclick="addFAQItem('privacy')" style="background: #64748b;">+ Add FAQ Manually</button>
                                    </div>
                                    <div id="wb-page-privacy-faq-list" class="faq-list"></div>
                                </div>
                            </div>
                            <div id="editor-privacy-content"></div>
                        </div>
                    </div>
                    
                    <!-- Styles Tab -->
                    <div id="editor-panel-styles" class="editor-panel" style="display: none;">
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                            <button class="btn" onclick="saveWebsiteSection('styles', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Styles</button>
                        </div>
                        <div id="editor-styles-content"></div>
                    </div>
                    
                    <!-- SEO Tab -->
                    <div id="editor-panel-seo" class="editor-panel" style="display: none;">
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                            <button class="btn" onclick="saveWebsiteSection('seo', this)" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">ðŸ’¾ Save SEO Settings</button>
                        </div>
                        <div id="editor-seo-content">
                            <!-- SEO Settings Form -->
                            <div style="display: grid; gap: 1.5rem;">
                                
                                <!-- Analytics Section -->
                                <div class="card" style="padding: 1.5rem;">
                                    <h3 style="margin: 0 0 1rem 0; color: #1e293b;"> Analytics & Tracking</h3>
                                    <p style="color: #64748b; margin-bottom: 1.5rem;">Connect your analytics tools to track visitor behavior and conversions.</p>
                                    
                                    <div style="display: grid; gap: 1rem;">
                                        <div>
                                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Google Analytics 4 ID</label>
                                            <input type="text" id="wb-seo-google-analytics-id" class="form-control" placeholder="G-XXXXXXXXXX" style="max-width: 300px;">
                                            <small style="color: #64748b;">Your GA4 Measurement ID (starts with G-)</small>
                                        </div>
                                        <div>
                                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Google Tag Manager ID</label>
                                            <input type="text" id="wb-seo-google-tag-manager-id" class="form-control" placeholder="GTM-XXXXXXX" style="max-width: 300px;">
                                            <small style="color: #64748b;">Your GTM Container ID</small>
                                        </div>
                                        <div>
                                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Facebook Pixel ID</label>
                                            <input type="text" id="wb-seo-facebook-pixel-id" class="form-control" placeholder="1234567890" style="max-width: 300px;">
                                            <small style="color: #64748b;">For Facebook/Instagram conversion tracking</small>
                                        </div>
                                        <div>
                                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Google Search Console Verification</label>
                                            <input type="text" id="wb-seo-google-site-verification" class="form-control" placeholder="abc123xyz..." style="max-width: 400px;">
                                            <small style="color: #64748b;">The content value from your Google Search Console verification meta tag</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Meta Tags Section -->
                                <div class="card" style="padding: 1.5rem;">
                                    <h3 style="margin: 0 0 1rem 0; color: #1e293b;"> Default Meta Tags</h3>
                                    <p style="color: #64748b; margin-bottom: 1.5rem;">Set default meta information for your website. These can be overridden on individual pages.</p>
                                    
                                    <div style="display: grid; gap: 1rem;">
                                        <div>
                                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">
                                                <input type="checkbox" id="wb-seo-enabled" checked style="margin-right: 0.5rem;">
                                                Enable SEO Meta Tags
                                            </label>
                                            <small style="color: #64748b;">Inject meta description, Open Graph, and Twitter Card tags. Disable if using another SEO plugin.</small>
                                        </div>
                                        <div>
                                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Default Meta Title</label>
                                            <input type="text" id="wb-seo-meta-title" class="form-control" placeholder="Your Property Name | Book Direct">
                                            <small style="color: #64748b;">50-60 characters recommended</small>
                                        </div>
                                        <div>
                                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Default Meta Description</label>
                                            <textarea id="wb-seo-meta-description" class="form-control" rows="3" placeholder="Book your stay at our beautiful property. Best rates guaranteed when you book direct."></textarea>
                                            <small style="color: #64748b;">150-160 characters recommended. Shows in search results.</small>
                                        </div>
                                        <div>
                                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Default OG Image URL</label>
                                            <input type="url" id="wb-seo-og-image" class="form-control" placeholder="https://yoursite.com/images/og-image.jpg">
                                            <small style="color: #64748b;">Image shown when sharing on social media. Recommended: 1200x630px.</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Schema Section -->
                                <div class="card" style="padding: 1.5rem;">
                                    <h3 style="margin: 0 0 1rem 0; color: #1e293b;"> Schema.org Markup</h3>
                                    <p style="color: #64748b; margin-bottom: 1.5rem;">Structured data helps search engines understand your content and can enable rich results.</p>
                                    
                                    <div style="display: grid; gap: 1rem;">
                                        <div>
                                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">
                                                <input type="checkbox" id="wb-seo-include-schema" checked style="margin-right: 0.5rem;">
                                                Include LodgingBusiness Schema
                                            </label>
                                            <small style="color: #64748b;">Adds structured data for Google's hotel/accommodation features.</small>
                                        </div>
                                        <div>
                                            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">
                                                <input type="checkbox" id="wb-seo-include-faqs" checked style="margin-right: 0.5rem;">
                                                Include FAQ Schema
                                            </label>
                                            <small style="color: #64748b;">Injects FAQPage schema from your FAQs (configured in SEO & Content  FAQs).</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Info Box -->
                                <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 12px; border: 1px solid #86efac;">
                                    <h4 style="margin: 0 0 0.5rem 0; color: #166534;"> WordPress Sync</h4>
                                    <p style="margin: 0; color: #166534;">These settings will be synced to your WordPress site when you click "Sync from GAS" in the GAS Booking plugin settings.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WP Guide Tab -->
                    <div id="editor-panel-wpguide" class="editor-panel" style="display: none;">
                        <div style="max-width: 700px;">
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #6366f1;">
                                <div class="card-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white;">
                                    <h3> WordPress Access</h3>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1rem;">
                                        Most settings can be managed here in GAS Admin. WordPress is only needed for advanced customizations.
                                    </p>
                                    
                                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                        <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;"> How to Access WordPress</h4>
                                        <p style="margin: 0; color: #374151;">
                                            Add <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px;">/wp-admin</code> to your site URL<br>
                                            <span style="color: #64748b; font-size: 0.9rem;">Example: https://yoursite.sites.gas.travel/wp-admin</span>
                                        </p>
                                    </div>
                                    
                                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                                        <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;"> Switch Light/Dark Theme</h4>
                                        <p style="margin: 0; color: #374151;">
                                            In WordPress: <strong>Appearance  Themes</strong><br>
                                            <span style="color: #64748b; font-size: 0.9rem;">Choose between GAS Developer (Light) or GAS Developer Dark</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="card" style="border: 2px solid #10b981;">
                                <div class="card-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                                    <h3> Tip</h3>
                                </div>
                                <div class="card-body">
                                    <p style="margin: 0; color: #374151;">
                                        Room layout style, filters, and display options can all be configured in <strong>Sub Pages  Rooms</strong> without needing WordPress.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Domain Tab -->
                    <div id="editor-panel-customdomain" class="editor-panel" style="display: none;">
                        <div style="max-width: 700px;">
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #3b82f6;">
                                <div class="card-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                                    <h3>ðŸŒ Custom Domain</h3>
                                </div>
                                <div class="card-body">
                                    <p style="color: #64748b; margin-bottom: 1.5rem;">
                                        Connect your own domain to your GAS website. Your site will be accessible at both your custom domain and the sites.gas.travel subdomain.
                                    </p>
                                    
                                    <div id="custom-domain-current" style="margin-bottom: 1.5rem;">
                                        <!-- Current domain status will be loaded here -->
                                    </div>
                                    
                                    <div id="custom-domain-form">
                                        <div class="form-group" style="margin-bottom: 1rem;">
                                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Your Domain</label>
                                            <input type="text" id="custom-domain-input" class="form-input" placeholder="example.com" style="width: 100%;">
                                            <small style="color: #64748b;">Enter without http:// or www (e.g., villa-talang.com)</small>
                                        </div>
                                        
                                        <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                            <h4 style="margin: 0 0 0.75rem 0; color: #92400e;">âš ï¸ Before connecting, add these DNS records:</h4>
                                            <div style="background: #1e293b; border-radius: 6px; padding: 1rem; font-family: monospace; font-size: 0.9rem;">
                                                <div style="color: #22c55e; margin-bottom: 0.5rem;">
                                                    <span style="color: #94a3b8;">Type:</span> A &nbsp;&nbsp;
                                                    <span style="color: #94a3b8;">Name:</span> @ &nbsp;&nbsp;
                                                    <span style="color: #94a3b8;">Value:</span> 72.61.207.109
                                                </div>
                                                <div style="color: #22c55e;">
                                                    <span style="color: #94a3b8;">Type:</span> A &nbsp;&nbsp;
                                                    <span style="color: #94a3b8;">Name:</span> www &nbsp;&nbsp;
                                                    <span style="color: #94a3b8;">Value:</span> 72.61.207.109
                                                </div>
                                            </div>
                                            <p style="margin: 0.75rem 0 0 0; color: #92400e; font-size: 0.85rem;">
                                                <strong>Important:</strong> Delete any existing AAAA (IPv6) records for your domain.
                                            </p>
                                        </div>
                                        
                                        <button onclick="connectCustomDomain()" class="btn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); width: 100%;">
                                            ðŸ”— Connect Domain
                                        </button>
                                    </div>
                                    
                                    <div id="custom-domain-progress" style="display: none; text-align: center; padding: 2rem;">
                                        <div class="spinner" style="margin: 0 auto 1rem;"></div>
                                        <p id="custom-domain-progress-text" style="color: #64748b;">Connecting domain...</p>
                                    </div>
                                    
                                    <div id="custom-domain-success" style="display: none; background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 1.5rem; text-align: center;">
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">âœ…</div>
                                        <h4 style="margin: 0 0 0.5rem 0; color: #166534;">Domain Connected!</h4>
                                        <p id="custom-domain-success-url" style="color: #15803d; margin: 0;"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- WordPress Admin Access Card -->
                            <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #8b5cf6;">
                                <div class="card-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                                    <h3>ðŸ” WordPress Admin Access</h3>
                                </div>
                                <div class="card-body">
                                    <div id="wp-admin-access-content">
                                        <p style="color: #64748b;">Loading WordPress access details...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card" style="border: 2px solid #f59e0b;">
                                <div class="card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                                    <h3>ðŸ’¡ Need Help?</h3>
                                </div>
                                <div class="card-body">
                                    <p style="margin: 0 0 0.5rem 0; color: #374151;">
                                        <strong>DNS changes can take up to 24 hours to propagate.</strong>
                                    </p>
                                    <p style="margin: 0; color: #64748b; font-size: 0.9rem;">
                                        If you need help setting up DNS records, contact support or check your domain registrar's documentation.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Header & Logo -->
            <div id="wb-header" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Header & Logo</h2>
                            <p>Site identity and navigation</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="openSitePreview()" id="wb-preview-btn" style="display: none;">
                                <span></span>
                                <span>Preview Site</span>
                            </button>
                            <button class="btn" onclick="saveWebsiteSection('header', this)">ðŸ’¾ Save & Sync</button>
                        </div>
                    </div>
                    
                    <!-- Website Selector Banner -->
                    <div class="website-selector-banner" style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <label style="font-weight: 600; color: #334155;">Editing Website:</label>
                                <select class="form-select website-selector-dropdown" onchange="onWebsiteSelected(this)" style="min-width: 250px;">
                                    <option value="">-- Select Website --</option>
                                </select>
                            </div>
                            <div class="website-edit-banner" style="display: none;">
                                <span class="website-status" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; background: #dcfce7; color: #166534; margin-right: 0.5rem;"></span>
                                <a class="website-url" href="#" target="_blank" style="color: #6366f1; font-size: 0.875rem;"></a>
                            </div>
                        </div>
                    </div>
                    
                    <div id="wb-site-banner" style="display: none; margin-top: 1rem; padding: 0.75rem 1rem; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 8px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong> Your Website:</strong> <a id="wb-site-url" href="#" target="_blank" style="color: white; text-decoration: underline;"></a>
                            </div>
                            <span style="font-size: 0.8rem; opacity: 0.9;">Changes sync automatically when you save</span>
                        </div>
                    </div>
                </div>

                <!-- Logo Card -->
                <div class="card">
                    <div class="card-header"><h3>Logo</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Logo Image</label>
                            <div id="wb-header-logo-image-preview" style="width: 200px; height: 80px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border: 2px dashed #e2e8f0; background-size: contain; background-position: center; background-repeat: no-repeat;">
                                <span style="color: #94a3b8;">No logo uploaded</span>
                            </div>
                            <input type="file" id="wb-header-logo-image" accept="image/*" onchange="previewWebsiteImage('header-logo')">
                            <input type="hidden" id="wb-header-logo-image-url">
                            <small class="form-hint">Recommended: PNG with transparent background, max 400x150px</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Site Name (if no logo)</label>
                            <input type="text" class="form-input" id="wb-header-site-name" placeholder="e.g., The Grand Hotel">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tagline</label>
                            <input type="text" class="form-input" id="wb-header-tagline" placeholder="e.g., Luxury Accommodation Since 1985">
                        </div>
                    </div>
                </div>

                <!-- Header Colors Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Header Colors</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-bg-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-bg-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-bg-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-bg-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Menu Link Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-text-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-text-color" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-text-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Menu Active Underline Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-underline-color-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-underline-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-underline-color" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-underline-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Logo/Site Title Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-logo-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-logo-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-logo-color" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-logo-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CTA Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-cta-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-cta-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-cta-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-cta-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CTA Button Text</label>
                                <input type="text" class="form-input" id="wb-header-cta-button-text" value="Book Now" placeholder="Book Now">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CTA Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-cta-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-cta-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-cta-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-cta-text-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Border Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-border-color-picker" value="#e5e7eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-border-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-border-color" value="#e5e7eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-border-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu Typography Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Menu Typography</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Menu Font</label>
                                <select class="form-select" id="wb-header-font">
                                    <option value="inter" selected>Inter (Modern)</option>
                                    <option value="playfair">Playfair Display (Elegant)</option>
                                    <option value="montserrat">Montserrat (Clean)</option>
                                    <option value="lora">Lora (Classic)</option>
                                    <option value="roboto">Roboto (Neutral)</option>
                                    <option value="opensans">Open Sans (Friendly)</option>
                                    <option value="poppins">Poppins (Geometric)</option>
                                    <option value="raleway">Raleway (Thin)</option>
                                    <option value="nunito">Nunito (Rounded)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Font Size: <span id="wb-header-font-size-value">15</span>px</label>
                                <input type="range" id="wb-header-font-size" min="12" max="24" value="15" style="width: 100%;" oninput="document.getElementById('wb-header-font-size-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Font Weight</label>
                                <select class="form-select" id="wb-header-font-weight">
                                    <option value="400">Normal (400)</option>
                                    <option value="500" selected>Medium (500)</option>
                                    <option value="600">Semi-Bold (600)</option>
                                    <option value="700">Bold (700)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Style</label>
                                <select class="form-select" id="wb-header-text-transform">
                                    <option value="none">Normal</option>
                                    <option value="uppercase">UPPERCASE</option>
                                    <option value="capitalize">Capitalize</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Header Layout Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Layout & Options</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Menu Layout</label>
                            <select class="form-select" id="wb-header-layout">
                                <option value="logo-left">Logo Left, Menu Right</option>
                                <option value="logo-center">Logo Center, Menu Split</option>
                                <option value="logo-right">Logo Right, Menu Left</option>
                                <option value="stacked">Stacked (Logo above Menu)</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-header-transparent" checked> Transparent over Hero
                            </label>
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-header-sticky" checked> Sticky Header
                            </label>
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-header-border"> Show Bottom Border
                            </label>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Website Builder: Hero Section -->
            <div id="wb-hero" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Hero Section</h2>
                            <p>The main banner at the top of your website</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('hero', this)">ðŸ’¾ Save & Sync</button>
                    </div>
                </div>

                <!-- Hero Content Card -->
                <div class="card">
                    <div class="card-header"><h3>Hero Content</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Headline</label>
                            <input type="text" class="form-input" id="wb-hero-headline" placeholder="e.g., Welcome to Paradise">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subheadline</label>
                            <input type="text" class="form-input" id="wb-hero-subheadline" placeholder="e.g., Experience luxury in the heart of the countryside">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Badge Text</label>
                                <input type="text" class="form-input" id="wb-hero-button-text" placeholder="e.g., Welcome to Paradise">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Badge Link (optional)</label>
                                <input type="text" class="form-input" id="wb-hero-button-link" placeholder="e.g., /about">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hero Image Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Background Image / Video</h3></div>
                    <div class="card-body">
                        <!-- Background Type Toggle -->
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label">Background Type</label>
                            <div style="display: flex; gap: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="hero-bg-type" value="image" checked onchange="toggleHeroBackgroundType('image')">  Image
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="hero-bg-type" value="slider" onchange="toggleHeroBackgroundType('slider')">  Image Slider
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="hero-bg-type" value="video" onchange="toggleHeroBackgroundType('video')">  Video (MP4)
                                </label>
                            </div>
                        </div>
                        
                        <!-- Single Image Upload (default) -->
                        <div id="hero-image-upload-section" class="form-group">
                            <div id="wb-hero-image-preview" style="width: 100%; height: 200px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; background-size: cover; background-position: center;">
                                <span style="color: #94a3b8;">Click below to upload an image</span>
                            </div>
                            <input type="file" id="wb-hero-image" accept="image/*" onchange="previewWebsiteImage('hero')">
                            <input type="hidden" id="wb-hero-image-url">
                        </div>
                        
                        <!-- Image Slider Upload (hidden by default) -->
                        <div id="hero-slider-upload-section" class="form-group" style="display: none;">
                            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 1rem;">
                                 Add up to 4 images that will automatically rotate in the hero section
                            </p>
                            <div id="hero-slider-images" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <!-- Slide 1 -->
                                <div class="slider-image-slot" data-slot="1" style="border: 2px dashed #e2e8f0; border-radius: 8px; padding: 0.5rem;">
                                    <div id="wb-hero-slide-1-preview" style="width: 100%; height: 120px; background: #f1f5f9; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; background-size: cover; background-position: center; position: relative;">
                                        <span class="slide-placeholder" style="color: #94a3b8; font-size: 0.8rem;">Slide 1 (required)</span>
                                        <button type="button" class="remove-slide-btn" onclick="removeSliderImage(1)" style="display: none; position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;"></button>
                                    </div>
                                    <input type="file" accept="image/*" onchange="previewSliderImage(1, this)" style="font-size: 0.8rem; width: 100%;">
                                    <input type="hidden" id="wb-hero-slide-1-url" value="">
                                </div>
                                <!-- Slide 2 -->
                                <div class="slider-image-slot" data-slot="2" style="border: 2px dashed #e2e8f0; border-radius: 8px; padding: 0.5rem;">
                                    <div id="wb-hero-slide-2-preview" style="width: 100%; height: 120px; background: #f1f5f9; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; background-size: cover; background-position: center; position: relative;">
                                        <span class="slide-placeholder" style="color: #94a3b8; font-size: 0.8rem;">Slide 2 (optional)</span>
                                        <button type="button" class="remove-slide-btn" onclick="removeSliderImage(2)" style="display: none; position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;"></button>
                                    </div>
                                    <input type="file" accept="image/*" onchange="previewSliderImage(2, this)" style="font-size: 0.8rem; width: 100%;">
                                    <input type="hidden" id="wb-hero-slide-2-url" value="">
                                </div>
                                <!-- Slide 3 -->
                                <div class="slider-image-slot" data-slot="3" style="border: 2px dashed #e2e8f0; border-radius: 8px; padding: 0.5rem;">
                                    <div id="wb-hero-slide-3-preview" style="width: 100%; height: 120px; background: #f1f5f9; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; background-size: cover; background-position: center; position: relative;">
                                        <span class="slide-placeholder" style="color: #94a3b8; font-size: 0.8rem;">Slide 3 (optional)</span>
                                        <button type="button" class="remove-slide-btn" onclick="removeSliderImage(3)" style="display: none; position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;"></button>
                                    </div>
                                    <input type="file" accept="image/*" onchange="previewSliderImage(3, this)" style="font-size: 0.8rem; width: 100%;">
                                    <input type="hidden" id="wb-hero-slide-3-url" value="">
                                </div>
                                <!-- Slide 4 -->
                                <div class="slider-image-slot" data-slot="4" style="border: 2px dashed #e2e8f0; border-radius: 8px; padding: 0.5rem;">
                                    <div id="wb-hero-slide-4-preview" style="width: 100%; height: 120px; background: #f1f5f9; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; background-size: cover; background-position: center; position: relative;">
                                        <span class="slide-placeholder" style="color: #94a3b8; font-size: 0.8rem;">Slide 4 (optional)</span>
                                        <button type="button" class="remove-slide-btn" onclick="removeSliderImage(4)" style="display: none; position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;"></button>
                                    </div>
                                    <input type="file" accept="image/*" onchange="previewSliderImage(4, this)" style="font-size: 0.8rem; width: 100%;">
                                    <input type="hidden" id="wb-hero-slide-4-url" value="">
                                </div>
                            </div>
                            <!-- Slider Settings -->
                            <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Slide Duration</label>
                                        <select class="form-select" id="wb-hero-slider-duration">
                                            <option value="3000">3 seconds</option>
                                            <option value="5000" selected>5 seconds</option>
                                            <option value="7000">7 seconds</option>
                                            <option value="10000">10 seconds</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Transition Effect</label>
                                        <select class="form-select" id="wb-hero-slider-transition">
                                            <option value="fade" selected>Fade</option>
                                            <option value="slide">Slide</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Video URL (hidden by default) -->
                        <div id="hero-video-upload-section" class="form-group" style="display: none;">
                            <div id="wb-hero-video-preview" style="width: 100%; height: 200px; background: #0f172a; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; overflow: hidden;">
                                <span id="hero-video-placeholder" style="color: #94a3b8;"> Upload or enter video URL below</span>
                                <video id="hero-video-player" style="width: 100%; height: 100%; object-fit: cover; display: none;" muted loop></video>
                            </div>
                            <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                                <div style="flex: 1;">
                                    <label class="form-label">Upload Video (MP4, max 100MB)</label>
                                    <input type="file" id="wb-hero-video-file" accept="video/mp4,video/webm" onchange="uploadHeroVideo(this)">
                                </div>
                            </div>
                            <label class="form-label">Or paste Video URL</label>
                            <input type="text" class="form-input" id="wb-hero-video-url" placeholder="https://example.com/video.mp4" oninput="previewHeroVideo(this.value)">
                            <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">
                                 Video will autoplay muted and loop. Keep under 30 seconds for best performance.
                            </p>
                            
                            <!-- Mobile Video Settings -->
                            <div style="margin-top: 1rem; padding: 1rem; background: #f1f5f9; border-radius: 8px;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                                    <input type="checkbox" id="wb-hero-video-mobile" style="width: 18px; height: 18px;">
                                     Show video on mobile & tablets
                                </label>
                                <p style="font-size: 0.8rem; color: #64748b; margin: 0.5rem 0 0 26px;">
                                    If unchecked, mobile users will see the fallback image below
                                </p>
                            </div>
                            
                            <!-- Mobile Fallback Image -->
                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="form-label"> Mobile Fallback Image</label>
                                <div id="wb-hero-mobile-image-preview" style="width: 100%; height: 150px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border: 2px dashed #e2e8f0; background-size: cover; background-position: center;">
                                    <span style="color: #94a3b8;"> Mobile fallback image</span>
                                </div>
                                <input type="file" id="wb-hero-mobile-image" accept="image/*" onchange="previewWebsiteImage('hero-mobile')">
                                <input type="hidden" id="wb-hero-mobile-image-url">
                                <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">
                                    Shown on mobile when video is disabled, or as poster frame while video loads
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Overlay Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-overlay-color-picker" value="#0f172a" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-overlay-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-overlay-color" value="#0f172a" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-overlay-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Overlay Opacity: <span id="wb-hero-overlay-value">30</span>%</label>
                                <input type="range" id="wb-hero-overlay" min="0" max="100" value="30" style="width: 100%;" oninput="document.getElementById('wb-hero-overlay-value').textContent = this.value">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hero Height: <span id="wb-hero-height-value">90</span>vh</label>
                            <input type="range" id="wb-hero-height" min="50" max="100" value="90" style="width: 100%;" oninput="document.getElementById('wb-hero-height-value').textContent = this.value">
                        </div>
                    </div>
                </div>

                <!-- Badge Styling Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Badge Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-badge-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer; opacity: 0.3;" onchange="document.getElementById('wb-hero-badge-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-badge-bg" value="rgba(255,255,255,0.15)" style="width: 100%; font-family: monospace; font-size: 12px;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-badge-text-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-badge-text').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-badge-text" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-badge-text-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Border</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-badge-border-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer; opacity: 0.3;" onchange="document.getElementById('wb-hero-badge-border').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-badge-border" value="rgba(255,255,255,0.3)" style="width: 100%; font-family: monospace; font-size: 12px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trust Badges Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Trust Badges</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Badge 1</label>
                                <input type="text" class="form-input" id="wb-hero-trust-1" value="Instant Booking">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Badge 2</label>
                                <input type="text" class="form-input" id="wb-hero-trust-2" value="Best Price Guarantee">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Badge 3</label>
                                <input type="text" class="form-input" id="wb-hero-trust-3" value="24/7 Support">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Text Colour</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-trust-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-trust-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-trust-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-trust-text-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Widget Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3> Search Widget</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-search-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-search-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-search-bg" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-search-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Label Text Colour</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-search-label-color-picker" value="#374151" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-search-label-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-search-label-color" value="#374151" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-search-label-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Opacity: <span id="wb-hero-search-opacity-value">100</span>%</label>
                                <input type="range" id="wb-hero-search-opacity" min="0" max="100" value="100" style="width: 100%;" oninput="document.getElementById('wb-hero-search-opacity-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Corner Radius: <span id="wb-hero-search-radius-value">16</span>px</label>
                                <input type="range" id="wb-hero-search-radius" min="0" max="32" value="16" style="width: 100%;" oninput="document.getElementById('wb-hero-search-radius-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Padding: <span id="wb-hero-search-padding-value">24</span>px</label>
                                <input type="range" id="wb-hero-search-padding" min="0" max="48" value="24" style="width: 100%;" oninput="document.getElementById('wb-hero-search-padding-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Width: <span id="wb-hero-search-max-width-value">900</span>px</label>
                                <input type="range" id="wb-hero-search-max-width" min="600" max="1200" value="900" style="width: 100%;" oninput="document.getElementById('wb-hero-search-max-width-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Scale: <span id="wb-hero-search-scale-value">100</span>%</label>
                                <input type="range" id="wb-hero-search-scale" min="80" max="120" value="100" style="width: 100%;" oninput="document.getElementById('wb-hero-search-scale-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Guests in Dropdown</label>
                                <input type="number" class="form-input" id="wb-hero-search-max-guests" min="1" max="20" value="4" style="width: 80px;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-search-btn-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-search-btn-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-search-btn-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-search-btn-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-search-btn-text-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-search-btn-text').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-search-btn-text" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-search-btn-text-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Intro Section -->
            <div id="wb-intro" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Intro Section</h2>
                            <p>Welcome text below the hero</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('intro', this)">ðŸ’¾ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Content</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-intro-enabled" checked> Enable Intro Section
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" class="form-input" id="wb-intro-title" placeholder="e.g., Welcome to Our Property" style="flex: 1;">
                                <button type="button" class="btn" onclick="generateIntroTitle()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); white-space: nowrap;">âœ¨ Generate</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Text</label>
                            <textarea class="form-textarea" id="wb-intro-text" rows="4" placeholder="Welcome text about your property..."></textarea>
                            <button type="button" class="btn" onclick="generateIntroText()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); margin-top: 8px;">âœ¨ Generate Intro Text</button>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-intro-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-intro-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-intro-bg" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-intro-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-intro-text-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-intro-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-intro-text-color" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-intro-text-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title Size: <span id="wb-intro-title-size-value">36</span>px</label>
                                <input type="range" id="wb-intro-title-size" min="24" max="72" value="36" style="width: 100%;" oninput="document.getElementById('wb-intro-title-size-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Size: <span id="wb-intro-text-size-value">18</span>px</label>
                                <input type="range" id="wb-intro-text-size" min="14" max="24" value="18" style="width: 100%;" oninput="document.getElementById('wb-intro-text-size-value').textContent = this.value">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Max Width: <span id="wb-intro-max-width-value">800</span>px</label>
                            <input type="range" id="wb-intro-max-width" min="600" max="1200" value="800" style="width: 100%;" oninput="document.getElementById('wb-intro-max-width-value').textContent = this.value">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Button (Optional)</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Button Text</label>
                                <input type="text" class="form-input" id="wb-intro-btn-text" placeholder="e.g., Learn More">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button URL</label>
                                <input type="text" class="form-input" id="wb-intro-btn-url" placeholder="e.g., /about">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-intro-btn-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-intro-btn-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-intro-btn-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-intro-btn-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-intro-btn-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-intro-btn-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-intro-btn-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-intro-btn-text-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Featured Properties -->
            <div id="wb-featured" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Featured Properties</h2>
                            <p>Choose which rooms to highlight</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('featured', this)">ðŸ’¾ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Section Settings</h3></div>
                    <div class="card-body">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="wb-featured-enabled" checked> Enable Featured Section
                        </label>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Section Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Colour</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-featured-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-featured-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-featured-bg" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-featured-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title Colour</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-featured-title-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-featured-title-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-featured-title-color" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-featured-title-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subtitle Colour</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-featured-subtitle-color-picker" value="#64748b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-featured-subtitle-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-featured-subtitle-color" value="#64748b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-featured-subtitle-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Content</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Section Title</label>
                            <input type="text" class="form-input" id="wb-featured-title" value="Featured Properties" placeholder="e.g., Our Rooms">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Section Subtitle</label>
                            <textarea class="form-textarea" id="wb-featured-subtitle" rows="2" placeholder="e.g., Discover our handpicked selection...">Discover our handpicked selection of stunning vacation rentals.</textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Display Settings</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Display Mode</label>
                                <select class="form-select" id="wb-featured-mode">
                                    <option value="all">Show All Rooms</option>
                                    <option value="count">Show First X Rooms</option>
                                    <option value="random">Show Random Rooms</option>
                                    <option value="selected">Select Specific Rooms</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Count: <span id="wb-featured-count-value">3</span></label>
                                <input type="range" id="wb-featured-count" min="1" max="12" value="3" style="width: 100%;" oninput="document.getElementById('wb-featured-count-value').textContent = this.value">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Columns</label>
                                <select class="form-select" id="wb-featured-columns">
                                    <option value="1">1 Column</option>
                                    <option value="2">2 Columns</option>
                                    <option value="3" selected>3 Columns</option>
                                    <option value="4">4 Columns</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Layout Style</label>
                                <select class="form-select" id="wb-featured-layout-style">
                                    <option value="grid" selected>Grid</option>
                                    <option value="row">Row</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Room IDs (comma-separated)</label>
                            <input type="text" class="form-input" id="wb-featured-ids" placeholder="e.g., 1,3,5">
                            <small class="form-hint">Only used when "Select Specific Rooms" is chosen</small>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Button</h3></div>
                    <div class="card-body">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="wb-featured-btn-enabled" checked> Show "View All" Button
                            </label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Button Text</label>
                                <input type="text" class="form-input" id="wb-featured-btn-text" value="View All Properties">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button URL</label>
                                <input type="text" class="form-input" id="wb-featured-btn-url" value="/book-now/">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-featured-btn-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-featured-btn-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-featured-btn-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-featured-btn-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-featured-btn-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-featured-btn-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-featured-btn-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-featured-btn-text-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Reviews -->
            <div id="wb-reviews" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Reviews Section</h2>
                            <p>Customer testimonials and ratings</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('reviews', this)" id="wb-reviews-save-btn">ðŸ’¾ Save & Sync</button>
                    </div>
                </div>

                <!-- Upgrade Banner (shown when Reviews app not purchased) -->
                <div id="wb-reviews-upgrade-banner" class="card" style="margin-bottom: 1rem; display: none;">
                    <div class="card-body" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                        <h3 style="margin-bottom: 0.5rem;">Unlock the Reviews App</h3>
                        <p style="color: #64748b; margin-bottom: 1.5rem;">Display reviews from TripAdvisor, Booking.com, Google and more on your website with beautiful, auto-updating widgets.</p>
                        <a href="#" onclick="navClick(document.querySelector('[data-view=my-billing]'), 'my-billing'); return false;" class="btn" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                             Upgrade Your Plan
                        </a>
                    </div>
                </div>

                <!-- Settings (shown when Reviews app is active) -->
                <div id="wb-reviews-content">
                    <div class="card">
                        <div class="card-header"><h3>Settings</h3></div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="wb-reviews-enabled"> Enable Reviews Section
                                </label>
                                <small class="form-hint">Display a reviews section on your homepage</small>
                            </div>
                            
                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="wb-reviews-use-app" onchange="toggleReviewsAppFields()"> Use Reviews App (Repuso)
                                </label>
                                <small class="form-hint">Connect to TripAdvisor, Booking.com, Google reviews automatically</small>
                            </div>
                            
                            <!-- Reviews App Fields (shown when Use App is checked) -->
                            <div id="wb-reviews-app-fields" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0;">
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label class="form-label">Reviews App Code</label>
                                    <input type="text" class="form-input" id="wb-reviews-app-code" placeholder="e.g. 48621" style="max-width: 200px;">
                                    <small class="form-hint">Your unique Repuso widget ID</small>
                                </div>
                                <p style="font-size: 0.85rem; color: #166534; margin: 0;">
                                     Don't have an account? <a href="https://repuso.com" target="_blank" style="color: #15803d; font-weight: 500;">Sign up for Repuso</a> to aggregate reviews from multiple platforms.
                                </p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Section Title</label>
                                    <input type="text" class="form-input" id="wb-reviews-title" value="What Our Guests Say">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Section Subtitle</label>
                                    <input type="text" class="form-input" id="wb-reviews-subtitle" value="Real reviews from real guests">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 1rem;">
                        <div class="card-header"><h3>Styling</h3></div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Background Color</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="color" id="wb-reviews-bg-picker" value="#0f172a" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-reviews-bg').value = this.value">
                                        <input type="text" class="form-input" id="wb-reviews-bg" value="#0f172a" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-reviews-bg-picker')">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Text Color</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="color" id="wb-reviews-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-reviews-text-color').value = this.value">
                                        <input type="text" class="form-input" id="wb-reviews-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-reviews-text-color-picker')">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Review Card Background</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="color" id="wb-reviews-card-bg-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-reviews-card-bg').value = this.value">
                                        <input type="text" class="form-input" id="wb-reviews-card-bg" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-reviews-card-bg-picker')">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Star Color</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="color" id="wb-reviews-star-color-picker" value="#fbbf24" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-reviews-star-color').value = this.value">
                                        <input type="text" class="form-input" id="wb-reviews-star-color" value="#fbbf24" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-reviews-star-color-picker')">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Reviews (shown when Use App is NOT checked) -->
                    <div class="card" style="margin-top: 1rem;" id="wb-reviews-manual-section">
                        <div class="card-header"><h3>Manual Reviews</h3></div>
                        <div class="card-body">
                            <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">Add up to 3 reviews manually. These display when the Reviews App is not connected.</p>
                            
                            <!-- Review 1 -->
                            <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <strong style="color: #475569; font-size: 0.9rem;">Review 1</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Reviewer Name</label>
                                        <input type="text" class="form-input" id="wb-reviews-review1-name" placeholder="John D.">
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Source</label>
                                        <select class="form-select" id="wb-reviews-review1-source">
                                            <option value="">Select source...</option>
                                            <option value="Google">Google</option>
                                            <option value="TripAdvisor">TripAdvisor</option>
                                            <option value="Booking.com">Booking.com</option>
                                            <option value="Airbnb">Airbnb</option>
                                            <option value="Facebook">Facebook</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 0.5rem; margin-bottom: 0;">
                                    <label class="form-label">Review Text</label>
                                    <textarea class="form-textarea" id="wb-reviews-review1-text" rows="2" placeholder="Amazing stay! The property was exactly as described..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Review 2 -->
                            <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <strong style="color: #475569; font-size: 0.9rem;">Review 2</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Reviewer Name</label>
                                        <input type="text" class="form-input" id="wb-reviews-review2-name" placeholder="Sarah M.">
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Source</label>
                                        <select class="form-select" id="wb-reviews-review2-source">
                                            <option value="">Select source...</option>
                                            <option value="Google">Google</option>
                                            <option value="TripAdvisor">TripAdvisor</option>
                                            <option value="Booking.com">Booking.com</option>
                                            <option value="Airbnb">Airbnb</option>
                                            <option value="Facebook">Facebook</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 0.5rem; margin-bottom: 0;">
                                    <label class="form-label">Review Text</label>
                                    <textarea class="form-textarea" id="wb-reviews-review2-text" rows="2" placeholder="We had the most wonderful time..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Review 3 -->
                            <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                                <strong style="color: #475569; font-size: 0.9rem;">Review 3</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Reviewer Name</label>
                                        <input type="text" class="form-input" id="wb-reviews-review3-name" placeholder="Mike T.">
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Source</label>
                                        <select class="form-select" id="wb-reviews-review3-source">
                                            <option value="">Select source...</option>
                                            <option value="Google">Google</option>
                                            <option value="TripAdvisor">TripAdvisor</option>
                                            <option value="Booking.com">Booking.com</option>
                                            <option value="Airbnb">Airbnb</option>
                                            <option value="Facebook">Facebook</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 0.5rem; margin-bottom: 0;">
                                    <label class="form-label">Review Text</label>
                                    <textarea class="form-textarea" id="wb-reviews-review3-text" rows="2" placeholder="Highly recommend this property..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 1rem; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border: 1px solid #86efac;">
                        <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;"></div>
                            <div>
                                <strong style="color: #166534;">Reviews App Active</strong>
                                <p style="margin: 0; color: #15803d; font-size: 0.9rem;">Your reviews from TripAdvisor, Booking.com, and Google will automatically display on your website.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: About Section -->
            <div id="wb-about" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> About Section</h2>
                            <p>Tell visitors about your property</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('about', this)">ðŸ’¾ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Section Settings</h3></div>
                    <div class="card-body">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="wb-about-enabled" checked> Enable About Section
                        </label>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Content</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Image</label>
                            <div id="wb-about-image-preview" style="width: 100%; height: 200px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; background-size: cover; background-position: center;">
                                <span style="color: #94a3b8;">Click below to upload an image</span>
                            </div>
                            <input type="file" id="wb-about-image" accept="image/*" onchange="previewWebsiteImage('about')">
                            <input type="hidden" id="wb-about-image-url">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" class="form-input" id="wb-about-title" value="Experience Luxury & Comfort" style="flex: 1;">
                                <button type="button" class="btn" onclick="generateAboutTitle()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); white-space: nowrap;">âœ¨ Generate</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Text</label>
                            <textarea class="form-textarea" id="wb-about-text" rows="4">Our carefully curated collection of vacation rentals offers the perfect blend of luxury, comfort, and convenience.</textarea>
                            <button type="button" class="btn" onclick="generateAboutText()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); margin-top: 8px;">âœ¨ Generate About Text</button>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Layout</label>
                            <select class="form-select" id="wb-about-layout">
                                <option value="image-left">Image Left</option>
                                <option value="image-right">Image Right</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Section Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Colour</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-about-bg-picker" value="#f8fafc" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-about-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-about-bg" value="#f8fafc" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-about-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title Colour</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-about-title-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-about-title-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-about-title-color" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-about-title-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Colour</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-about-text-color-picker" value="#475569" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-about-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-about-text-color" value="#475569" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-about-text-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title Size: <span id="wb-about-title-size-value">36</span>px</label>
                                <input type="range" id="wb-about-title-size" min="24" max="72" value="36" style="width: 100%;" oninput="document.getElementById('wb-about-title-size-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Size: <span id="wb-about-text-size-value">16</span>px</label>
                                <input type="range" id="wb-about-text-size" min="14" max="24" value="16" style="width: 100%;" oninput="document.getElementById('wb-about-text-size-value').textContent = this.value">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Features (Checkmarks)</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Feature 1</label>
                                <input type="text" class="form-input" id="wb-about-feature-1" value="Spacious Bedrooms">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Feature 2</label>
                                <input type="text" class="form-input" id="wb-about-feature-2" value="Luxury Bathrooms">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Feature 3</label>
                                <input type="text" class="form-input" id="wb-about-feature-3" value="Prime Locations">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Feature 4</label>
                                <input type="text" class="form-input" id="wb-about-feature-4" value="Full Amenities">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Feature 5</label>
                                <input type="text" class="form-input" id="wb-about-feature-5" value="Entertainment Areas">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Feature 6</label>
                                <input type="text" class="form-input" id="wb-about-feature-6" value="Private Parking">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Button</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Button Text</label>
                                <input type="text" class="form-input" id="wb-about-btn-text" value="Learn More">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button URL</label>
                                <input type="text" class="form-input" id="wb-about-btn-url" value="/about/">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-about-btn-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-about-btn-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-about-btn-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-about-btn-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-about-btn-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-about-btn-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-about-btn-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-about-btn-text-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: CTA Section -->
            <div id="wb-cta" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Call to Action</h2>
                            <p>Encourage visitors to book</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('cta', this)">ðŸ’¾ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Content</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-cta-enabled" checked> Enable CTA Section
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" id="wb-cta-title" value="Ready to Book Your Stay?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Text</label>
                            <textarea class="form-textarea" id="wb-cta-text" rows="2">Find your perfect vacation rental today and create memories that last a lifetime.</textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-cta-background-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-cta-background').value = this.value">
                                    <input type="text" class="form-input" id="wb-cta-background" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-cta-background-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-cta-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-cta-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-cta-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-cta-text-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title Size: <span id="wb-cta-title-size-value">36</span>px</label>
                                <input type="range" id="wb-cta-title-size" min="24" max="72" value="36" style="width: 100%;" oninput="document.getElementById('wb-cta-title-size-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Size: <span id="wb-cta-text-size-value">18</span>px</label>
                                <input type="range" id="wb-cta-text-size" min="14" max="24" value="18" style="width: 100%;" oninput="document.getElementById('wb-cta-text-size-value').textContent = this.value">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Button</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Button Text</label>
                                <input type="text" class="form-input" id="wb-cta-btn-text" value="Browse Properties">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button URL</label>
                                <input type="text" class="form-input" id="wb-cta-btn-url" value="/book-now/">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-cta-btn-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-cta-btn-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-cta-btn-bg" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-cta-btn-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-cta-btn-text-color-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-cta-btn-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-cta-btn-text-color" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-cta-btn-text-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Footer -->
            <div id="wb-footer" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Footer</h2>
                            <p>Bottom section of your website</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('footer', this)">ðŸ’¾ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Footer Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-footer-bg-picker" value="#0f172a" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-footer-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-footer-bg" value="#0f172a" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-footer-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-footer-text-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-footer-text').value = this.value">
                                    <input type="text" class="form-input" id="wb-footer-text" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-footer-text-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Layout</label>
                                <select class="form-select" id="wb-footer-layout">
                                    <option value="default">Default (3 columns)</option>
                                    <option value="centered">Centered</option>
                                    <option value="minimal">Minimal</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Copyright Text</label>
                            <input type="text" class="form-input" id="wb-footer-copyright" value=" 2025 All rights reserved.">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Contact Information</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="wb-footer-email" placeholder="info@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-input" id="wb-footer-phone" placeholder="+1 (555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea class="form-textarea" id="wb-footer-address" rows="2" placeholder="123 Main Street, City, State ZIP"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Social Media Links</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Facebook</label>
                                <input type="text" class="form-input" id="wb-footer-social-facebook" placeholder="https://facebook.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Instagram</label>
                                <input type="text" class="form-input" id="wb-footer-social-instagram" placeholder="https://instagram.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Twitter/X</label>
                                <input type="text" class="form-input" id="wb-footer-social-twitter" placeholder="https://twitter.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">LinkedIn</label>
                                <input type="text" class="form-input" id="wb-footer-social-linkedin" placeholder="https://linkedin.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">YouTube</label>
                                <input type="text" class="form-input" id="wb-footer-social-youtube" placeholder="https://youtube.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TikTok</label>
                                <input type="text" class="form-input" id="wb-footer-social-tiktok" placeholder="https://tiktok.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pinterest</label>
                                <input type="text" class="form-input" id="wb-footer-social-pinterest" placeholder="https://pinterest.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TripAdvisor</label>
                                <input type="text" class="form-input" id="wb-footer-social-tripadvisor" placeholder="https://tripadvisor.com/...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Custom Site - Client View -->
            <div id="my-custom-site" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>âœ¨ My Custom Site</h2>
                            <p class="subtitle">Your custom bespoke website details and credentials</p>
                        </div>
                        <button class="btn" onclick="loadMyCustomSite()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            ðŸ”„ Refresh
                        </button>
                    </div>
                </div>
                
                <div id="my-custom-site-container">
                    <div style="text-align: center; padding: 3rem; color: #64748b;">
                        <div class="spinner" style="margin: 0 auto 1rem;"></div>
                        Loading your custom site details...
                    </div>
                </div>
            </div>

            <!-- Custom Sites (Bespoke) - Master Only -->
            <div id="custom-sites" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>âœ¨ Custom Bespoke Sites</h2>
                            <p class="subtitle">Manage custom site requests and provision premium websites</p>
                        </div>
                        <button class="btn" onclick="refreshCustomSiteRequests()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            ðŸ”„ Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Provisioned Sites List -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-bottom: 1px solid #3b82f6;">
                        <h3 style="margin: 0; color: #1e40af;">ðŸŒ Provisioned Sites</h3>
                    </div>
                    <div class="card-body" id="provisioned-sites-container">
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            Loading sites...
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-bottom: 1px solid #f59e0b;">
                        <h3 style="margin: 0; color: #92400e;">ðŸ“‹ Pending Requests</h3>
                    </div>
                    <div class="card-body" id="custom-site-requests-container">
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            Loading requests...
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-bottom: 1px solid #10b981;">
                        <h3 style="margin: 0; color: #065f46;">ðŸš€ Provision New Site</h3>
                    </div>
                    <div class="card-body">
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <strong>âš ï¸ Before provisioning:</strong> Add DNS A record in GoDaddy<br>
                            <code style="background: #1e293b; color: #22c55e; padding: 0.25rem 0.5rem; border-radius: 4px; margin-top: 0.5rem; display: inline-block;">[slug].custom â†’ 31.97.119.90</code>
                        </div>
                        <p style="color: #64748b; margin-bottom: 1rem;">Manually provision a custom site (after DNS A record is added)</p>
                        <form id="provision-site-form" onsubmit="provisionCustomSite(event)">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label>Site Slug *</label>
                                    <input type="text" id="provision-slug" class="form-input" placeholder="synergy" required pattern="[a-z0-9-]+">
                                    <small style="color: #64748b;">Will create: [slug].custom.gas.travel</small>
                                </div>
                                <div class="form-group">
                                    <label>Site Name *</label>
                                    <input type="text" id="provision-site-name" class="form-input" placeholder="Synergy Rentals" required>
                                </div>
                                <div class="form-group">
                                    <label>Admin Email *</label>
                                    <input type="email" id="provision-admin-email" class="form-input" placeholder="client@example.com" required>
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <button type="submit" class="btn" id="provision-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                    ðŸš€ Provision Site
                                </button>
                                <span id="provision-status" style="color: #64748b;"></span>
                            </div>
                        </form>
                        
                        <div id="provision-result" style="display: none; margin-top: 1.5rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem;">
                        </div>
                    </div>
                </div>
                
                <!-- SSH Reference -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 1px solid #334155;">
                        <h3 style="margin: 0; color: #94a3b8;">ðŸ’» SSH Quick Reference</h3>
                    </div>
                    <div class="card-body" style="background: #1e293b; color: #e2e8f0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div>
                                <h4 style="color: #f59e0b; margin: 0 0 0.5rem 0; font-size: 0.9rem;">Connect to Premium VPS</h4>
                                <code style="display: block; background: #0f172a; padding: 0.75rem; border-radius: 4px; font-size: 0.85rem; cursor: pointer;" onclick="navigator.clipboard.writeText('ssh root@31.97.119.90'); showNotification('Copied!', 'success');">ssh <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8bf9e4e4ffcbb8baa5b2bca5babab2a5b2bb">[email&#160;protected]</a></code>
                            </div>
                            <div>
                                <h4 style="color: #f59e0b; margin: 0 0 0.5rem 0; font-size: 0.9rem;">VPS IP Address</h4>
                                <code style="display: block; background: #0f172a; padding: 0.75rem; border-radius: 4px; font-size: 0.85rem; cursor: pointer;" onclick="navigator.clipboard.writeText('31.97.119.90'); showNotification('Copied!', 'success');">31.97.119.90</code>
                            </div>
                            <div>
                                <h4 style="color: #f59e0b; margin: 0 0 0.5rem 0; font-size: 0.9rem;">Site Files Location</h4>
                                <code style="display: block; background: #0f172a; padding: 0.75rem; border-radius: 4px; font-size: 0.85rem;">/var/www/[slug].custom.gas.travel</code>
                            </div>
                            <div>
                                <h4 style="color: #f59e0b; margin: 0 0 0.5rem 0; font-size: 0.9rem;">Restart Apache</h4>
                                <code style="display: block; background: #0f172a; padding: 0.75rem; border-radius: 4px; font-size: 0.85rem; cursor: pointer;" onclick="navigator.clipboard.writeText('systemctl restart apache2'); showNotification('Copied!', 'success');">systemctl restart apache2</code>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #334155;">
                            <h4 style="color: #22c55e; margin: 0 0 0.5rem 0; font-size: 0.9rem;">ðŸ”’ SSL Certificate Command (replace [slug])</h4>
                            <code style="display: block; background: #0f172a; padding: 0.75rem; border-radius: 4px; font-size: 0.85rem; cursor: pointer; word-break: break-all;" onclick="navigator.clipboard.writeText('certbot --apache -d [slug].custom.gas.travel --non-interactive --agree-tos -m steve@gas.travel'); showNotification('Copied! Remember to replace [slug]', 'success');">certbot --apache -d [slug].custom.gas.travel --non-interactive --agree-tos -m <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="116265746774517670623f65637067747d">[email&#160;protected]</a></code>
                        </div>
                        
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #334155;">
                            <small style="color: #64748b;">Click any command to copy to clipboard</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deploy Sites -->
            <div id="deploy-sites" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Create Sites</h2>
                            <p class="subtitle">Create and manage WordPress websites from GAS</p>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <span id="vps-status" style="padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; background: #fef3c7; color: #92400e;"> Checking VPS...</span>
                            <button class="btn" onclick="openDeployModal()" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">
                                + Create New Site
                            </button>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary);" id="deploy-stat-total">0</div>
                        <div style="color: #64748b; font-size: 0.9rem;">Total Sites</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: bold; color: #10b981;" id="deploy-stat-active">0</div>
                        <div style="color: #64748b; font-size: 0.9rem;">Live Sites</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: bold; color: #f59e0b;" id="deploy-stat-pending">0</div>
                        <div style="color: #64748b; font-size: 0.9rem;">In Development</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3> Deployed Sites</h3>
                    </div>
                    <div id="deployed-sites-list" style="padding: 1rem;">
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <p>Loading deployed sites...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plugin Licenses Management -->
            <div id="plugin-licenses" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ðŸ”‘ Plugin Licenses</h2>
                            <p class="subtitle">Manage plugin licenses and display settings</p>
                        </div>
                        <button class="btn" onclick="loadPluginLicenses()" style="background: var(--primary);">
                            ðŸ”„ Refresh
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Active Licenses</h3>
                    </div>
                    <div id="plugin-licenses-list" style="padding: 1rem;">
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ”‘</div>
                            <p>Loading licenses...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Styles & Colors -->
            <div id="wb-styles" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Styles & Colors</h2>
                            <p>Global styling for your website</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('styles', this)">ðŸ’¾ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Brand Colors</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Primary Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-primary-color-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-primary-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-primary-color" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-primary-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Secondary Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-secondary-color-picker" value="#7c3aed" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-secondary-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-secondary-color" value="#7c3aed" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-secondary-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Accent Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-accent-color-picker" value="#f59e0b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-accent-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-accent-color" value="#f59e0b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-accent-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Link Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-link-color-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-link-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-link-color" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-link-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Typography</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Heading Font</label>
                                <select class="form-select" id="wb-styles-heading-font">
                                    <option value="playfair">Playfair Display (Elegant Serif)</option>
                                    <option value="montserrat">Montserrat (Modern Sans)</option>
                                    <option value="lora">Lora (Classic Serif)</option>
                                    <option value="poppins">Poppins (Geometric)</option>
                                    <option value="merriweather">Merriweather (Traditional)</option>
                                    <option value="raleway">Raleway (Thin & Elegant)</option>
                                    <option value="oswald">Oswald (Bold Impact)</option>
                                    <option value="inter" selected>Inter (Clean Modern)</option>
                                    <option value="roboto">Roboto (Neutral)</option>
                                    <option value="nunito">Nunito (Rounded Friendly)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Body Font</label>
                                <select class="form-select" id="wb-styles-body-font">
                                    <option value="inter" selected>Inter (Modern & Readable)</option>
                                    <option value="roboto">Roboto (Clean)</option>
                                    <option value="opensans">Open Sans (Friendly)</option>
                                    <option value="lato">Lato (Warm)</option>
                                    <option value="sourcesans">Source Sans Pro (Professional)</option>
                                    <option value="nunito">Nunito (Rounded)</option>
                                    <option value="poppins">Poppins (Geometric)</option>
                                    <option value="montserrat">Montserrat (Modern)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Page Title Size: <span id="wb-styles-title-size-value">48</span>px</label>
                                <input type="range" id="wb-styles-title-size" min="24" max="72" value="48" style="width: 100%;" oninput="document.getElementById('wb-styles-title-size-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Body Text Size: <span id="wb-styles-body-size-value">16</span>px</label>
                                <input type="range" id="wb-styles-body-size" min="14" max="20" value="16" style="width: 100%;" oninput="document.getElementById('wb-styles-body-size-value').textContent = this.value">
                            </div>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.85rem; color: #64748b;">
                            ðŸ’¡ Tip: Pair a decorative heading font (like Playfair Display) with a clean body font (like Inter) for best readability.
                        </p>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Button Styles</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Primary Button BG</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-btn-primary-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-btn-primary-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-btn-primary-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-btn-primary-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Primary Button Text</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-btn-primary-text-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-btn-primary-text').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-btn-primary-text" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-btn-primary-text-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Radius: <span id="wb-styles-btn-radius-value">8</span>px</label>
                                <input type="range" id="wb-styles-btn-radius" min="0" max="24" value="8" style="width: 100%;" oninput="document.getElementById('wb-styles-btn-radius-value').textContent = this.value">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Section Backgrounds</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Featured BG</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-featured-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-featured-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-featured-bg" value="#ffffff" style="width: 80px; font-family: monospace; font-size: 12px;" oninput="syncColorToPicker(this.id, 'wb-styles-featured-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">About BG</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-about-bg-picker" value="#f8fafc" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-about-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-about-bg" value="#f8fafc" style="width: 80px; font-family: monospace; font-size: 12px;" oninput="syncColorToPicker(this.id, 'wb-styles-about-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Testimonials BG</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-testimonials-bg-picker" value="#0f172a" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-testimonials-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-testimonials-bg" value="#0f172a" style="width: 80px; font-family: monospace; font-size: 12px;" oninput="syncColorToPicker(this.id, 'wb-styles-testimonials-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CTA BG</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-cta-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-cta-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-cta-bg" value="#2563eb" style="width: 80px; font-family: monospace; font-size: 12px;" oninput="syncColorToPicker(this.id, 'wb-styles-cta-bg-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Custom CSS</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Additional CSS</label>
                            <textarea class="form-textarea" id="wb-styles-custom-css" rows="6" placeholder="/* Add custom CSS here */"></textarea>
                            <small class="form-hint">Advanced: Add custom CSS to override theme styles</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks View -->
            <div id="tasks" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Tasks & Roadmap</h2>
                            <p>Development priorities and progress</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="openTaskModal()">
                                <span>+</span>
                                <span>Add Task</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Tab Bar: Active vs Completed -->
                <div style="display: flex; border-bottom: 2px solid var(--border); margin-bottom: 1rem;">
                    <button class="tasks-main-tab active" id="tasks-main-active" onclick="switchTaskMainTab('active')">
                         Active Tasks
                    </button>
                    <button class="tasks-main-tab" id="tasks-main-completed" onclick="switchTaskMainTab('completed')">
                         Completed
                    </button>
                </div>

                <!-- Active Tasks Panel -->
                <div id="tasks-active-panel">
                    <!-- Filter Row -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <!-- View By Toggle -->
                        <div style="display: flex; background: var(--bg-secondary); border-radius: 8px; padding: 4px;">
                            <button class="tasks-view-btn active" id="view-by-category" onclick="setTasksView('category')">
                                 By Category
                            </button>
                            <button class="tasks-view-btn" id="view-by-priority" onclick="setTasksView('priority')">
                                 By Priority
                            </button>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div style="display: flex; gap: 1rem; margin-left: auto; align-items: center;">
                            <span class="tasks-stat" style="color: #ef4444;">
                                <span id="stat-critical">0</span> Critical
                            </span>
                            <span class="tasks-stat" style="color: #f59e0b;">
                                <span id="stat-urgent">0</span> Urgent
                            </span>
                            <span class="tasks-stat" style="color: #3b82f6;">
                                <span id="stat-high">0</span> High
                            </span>
                            <span class="tasks-stat" style="color: #6b7280;">
                                <span id="stat-medium">0</span> Medium
                            </span>
                        </div>
                    </div>

                    <!-- Category Tabs (horizontal menu) -->
                    <div id="tasks-category-tabs" class="tasks-category-tabs">
                        <button class="tasks-cat-tab active" data-cat="all" onclick="filterTasksCat('all')">
                            All
                        </button>
                        <!-- Categories populated by JS -->
                    </div>

                    <!-- Priority Tabs (hidden by default) -->
                    <div id="tasks-priority-tabs" class="tasks-category-tabs" style="display: none;">
                        <button class="tasks-cat-tab active" data-priority="all" onclick="filterTasksPriority('all')">
                            All
                        </button>
                        <button class="tasks-cat-tab" data-priority="critical" onclick="filterTasksPriority('critical')" style="border-left: 3px solid #ef4444;">
                             Critical
                        </button>
                        <button class="tasks-cat-tab" data-priority="urgent" onclick="filterTasksPriority('urgent')" style="border-left: 3px solid #f59e0b;">
                             Urgent
                        </button>
                        <button class="tasks-cat-tab" data-priority="high" onclick="filterTasksPriority('high')" style="border-left: 3px solid #3b82f6;">
                             High
                        </button>
                        <button class="tasks-cat-tab" data-priority="medium" onclick="filterTasksPriority('medium')" style="border-left: 3px solid #6b7280;">
                             Medium
                        </button>
                    </div>

                    <!-- Tasks List -->
                    <div id="tasks-list" style="margin-top: 1rem;">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Completed Tasks Panel -->
                <div id="tasks-completed-panel" style="display: none;">
                    <div id="tasks-completed-list">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Styles -->
            <style>
                .tasks-main-tab {
                    padding: 0.75rem 1.5rem;
                    background: none;
                    border: none;
                    font-size: 1rem;
                    font-weight: 500;
                    color: #64748b;
                    cursor: pointer;
                    border-bottom: 3px solid transparent;
                    margin-bottom: -2px;
                    transition: all 0.2s;
                }
                .tasks-main-tab:hover {
                    color: var(--text);
                }
                .tasks-main-tab.active {
                    color: var(--primary);
                    border-bottom-color: var(--primary);
                }
                .tasks-view-btn {
                    padding: 0.5rem 1rem;
                    background: none;
                    border: none;
                    font-size: 0.85rem;
                    color: #64748b;
                    cursor: pointer;
                    border-radius: 6px;
                    transition: all 0.2s;
                }
                .tasks-view-btn:hover {
                    background: var(--bg-tertiary);
                }
                .tasks-view-btn.active {
                    background: white;
                    color: var(--text);
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                .tasks-stat {
                    font-size: 0.85rem;
                    font-weight: 600;
                }
                .tasks-category-tabs {
                    display: flex;
                    gap: 0.5rem;
                    flex-wrap: wrap;
                    padding-bottom: 0.5rem;
                    border-bottom: 1px solid var(--border);
                }
                .tasks-cat-tab {
                    padding: 0.5rem 1rem;
                    background: #f8fafc;
                    border: 1px solid #e2e8f0;
                    border-radius: 20px;
                    font-size: 0.85rem;
                    color: #475569;
                    cursor: pointer;
                    transition: all 0.2s;
                    white-space: nowrap;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.25rem;
                }
                .tasks-cat-tab:hover {
                    background: #e2e8f0;
                    color: #1e293b;
                }
                .tasks-cat-tab.active,
                .tasks-cat-tab.active:hover,
                .tasks-cat-tab.active:focus {
                    background: #6366f1 !important;
                    color: #ffffff !important;
                    border-color: #6366f1 !important;
                }
                .tasks-cat-tab:focus {
                    outline: none;
                    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
                }
                .task-card {
                    background: white;
                    border: 1px solid var(--border);
                    border-radius: 10px;
                    padding: 1rem;
                    margin-bottom: 0.75rem;
                    transition: all 0.2s;
                    border-left: 4px solid var(--border);
                }
                .task-card:hover {
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                }
                .task-card.priority-critical {
                    border-left-color: #ef4444;
                    background: #fef2f2;
                }
                .task-card.priority-urgent {
                    border-left-color: #f59e0b;
                    background: #fffbeb;
                }
                .task-card.priority-high {
                    border-left-color: #3b82f6;
                }
                .task-card.priority-medium {
                    border-left-color: #6b7280;
                }
                .task-card-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    gap: 1rem;
                }
                .task-title {
                    font-weight: 600;
                    font-size: 0.95rem;
                    margin: 0;
                }
                .task-badges {
                    display: flex;
                    gap: 0.5rem;
                    flex-shrink: 0;
                }
                .task-badge {
                    font-size: 0.7rem;
                    padding: 0.2rem 0.5rem;
                    border-radius: 4px;
                    font-weight: 600;
                    text-transform: uppercase;
                }
                .task-badge-critical { background: #fecaca; color: #991b1b; }
                .task-badge-urgent { background: #fde68a; color: #92400e; }
                .task-badge-high { background: #bfdbfe; color: #1e40af; }
                .task-badge-medium { background: #e5e7eb; color: #374151; }
                .task-description {
                    color: #64748b;
                    font-size: 0.85rem;
                    margin: 0.5rem 0 0 0;
                }
                .task-subtasks {
                    margin-top: 0.75rem;
                    padding-top: 0.75rem;
                    border-top: 1px dashed var(--border);
                }
                .task-subtask {
                    font-size: 0.8rem;
                    color: #64748b;
                    padding: 0.25rem 0;
                    padding-left: 1.25rem;
                    position: relative;
                }
                .task-subtask:before {
                    content: "";
                    position: absolute;
                    left: 0;
                    color: var(--border);
                }
                .completed-task {
                    background: #f0fdf4;
                    border-left-color: #22c55e;
                    opacity: 0.9;
                }
                .completed-task .task-title {
                    text-decoration: line-through;
                    color: #64748b;
                }
            </style>

            <!-- Integrations View -->
            <div id="integrations" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Integrations</h2>
                            <p>Connected apps and services</p>
                        </div>
                        <button class="btn" onclick="openChannelManagerModal()">
                            <span>+</span>
                            <span>Add Integration</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Channel Managers</h3>
                    </div>
                    <div id="channel-connections">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> Real-time Booking Sync (Beds24 Webhook)</h3>
                        <button class="btn btn-secondary btn-small" onclick="testWebhookEndpoint()"> Test Endpoint</button>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1rem;">
                        <strong>Important:</strong> For instant updates when bookings arrive from Airbnb/Booking.com, configure the webhook <strong>for each property</strong> in Beds24:
                    </p>
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.85rem; margin: 0 0 0.5rem 0; color: #64748b;"><strong>Webhook URL:</strong></p>
                        <code id="webhook-url" style="display: block; background: #1e293b; color: #22c55e; padding: 0.75rem; border-radius: 4px; font-size: 0.85rem; word-break: break-all;"></code>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button onclick="copyWebhookUrl()" class="btn btn-secondary btn-small">ðŸ“‹ Copy URL</button>
                            <span id="webhook-status" style="font-size: 0.8rem; color: #6b7280; display: flex; align-items: center;"></span>
                        </div>
                    </div>
                    
                    <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.85rem; margin: 0 0 0.5rem 0; color: #1e40af;"><strong> Must be done for EACH property:</strong></p>
                        <ol style="font-size: 0.85rem; color: #1e40af; margin: 0; padding-left: 1.25rem; line-height: 1.8;">
                            <li>Go to <strong>Settings  Properties</strong> and select your property</li>
                            <li>Click <strong>Access</strong> tab</li>
                            <li>Find <strong>"Booking Webhooks"</strong> section</li>
                            <li>Set <strong>Webhook Version</strong> to <code style="background: white; padding: 0.15rem 0.3rem; border-radius: 3px;">2 - with personal data</code></li>
                            <li>Paste the webhook URL above</li>
                            <li>Leave Custom Header and Additional Data empty</li>
                            <li>Click <strong>Save</strong></li>
                            <li style="color: #dc2626; font-weight: 600;">Repeat steps 1-7 for each property!</li>
                        </ol>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 0.75rem; margin-top: 1rem;">
                        <p style="font-size: 0.85rem; margin: 0; color: #92400e;">
                            <strong> Sync Strategy:</strong><br>
                             <strong>Webhook</strong> = Real-time (~1 min delay per Beds24)<br>
                             <strong> Beds24 button</strong> = Manual quick sync<br>
                             <strong> Full button</strong> = Manual inventory/blackout sync<br><br>
                            <strong> Automatic Backup:</strong> Every 15 min (bookings), Every 6 hrs (inventory)
                        </p>
                    </div>
                </div>

                <!-- Hostaway Webhook Section -->
                <div class="card" id="hostaway-webhook-section" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">ðŸ“¡ Real-time Booking Sync (Hostaway Webhook)</h3>
                        <button class="btn btn-secondary btn-small" onclick="testHostawayWebhook()">ðŸ”„ Test Endpoint</button>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1rem;">
                        <strong>Recommended:</strong> For instant updates when bookings arrive from Airbnb, VRBO, Booking.com, etc., add this webhook URL in Hostaway:
                    </p>
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.85rem; margin: 0 0 0.5rem 0; color: #64748b;"><strong>Webhook URL:</strong></p>
                        <code id="hostaway-webhook-url" style="display: block; background: #1e293b; color: #22c55e; padding: 0.75rem; border-radius: 4px; font-size: 0.85rem; word-break: break-all;">https://admin.gas.travel/api/webhooks/hostaway</code>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button onclick="copyHostawayWebhookUrl()" class="btn btn-secondary btn-small">ðŸ“‹ Copy URL</button>
                            <span id="hostaway-webhook-status" style="font-size: 0.8rem; color: #6b7280; display: flex; align-items: center;"></span>
                        </div>
                    </div>
                    
                    <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.85rem; margin: 0 0 0.5rem 0; color: #1e40af;"><strong>ðŸ“ Setup Steps (one time only):</strong></p>
                        <ol style="font-size: 0.85rem; color: #1e40af; margin: 0; padding-left: 1.25rem; line-height: 1.8;">
                            <li>Log into your <strong>Hostaway Dashboard</strong></li>
                            <li>Go to <strong>Settings â†’ Integrations</strong></li>
                            <li>Find <strong>"Unified Webhooks"</strong> section</li>
                            <li>Click <strong>"Add Webhook"</strong></li>
                            <li>Paste the webhook URL above</li>
                            <li>Enable all reservation events (created, updated, cancelled)</li>
                            <li>Click <strong>Save</strong></li>
                        </ol>
                    </div>
                    
                    <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 0.75rem; margin-top: 1rem;">
                        <p style="font-size: 0.85rem; margin: 0; color: #166534;">
                            <strong>âœ… Sync Strategy:</strong><br>
                            ðŸ“¡ <strong>Webhook</strong> = Instant updates from all channels<br>
                            ðŸ”„ <strong>Hostaway button</strong> = Manual quick sync<br><br>
                            <strong>â° Automatic Backup:</strong> Every 15 min (bookings + availability)
                        </p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Review Apps</h3>
                        <button class="btn btn-secondary btn-small">Configure</button>
                    </div>
                    <p style="color: #64748b;">Connect to review platforms like TripAdvisor, Google Reviews, etc.</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Other Integrations</h3>
                        <button class="btn btn-secondary btn-small">Explore</button>
                    </div>
                    <p style="color: #64748b;">Payment gateways, analytics, marketing tools, and more...</p>
                </div>
            </div>

            <!-- Channel Manager Selection Modal -->
            <div id="channelManagerModal" class="modal" style="display: none;" onclick="if(event.target === this) closeChannelManagerModal()">
                <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;"> Select Your Channel Manager</h3>
                        <button onclick="closeChannelManagerModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; cursor: pointer; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; line-height: 1;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="color: #64748b; margin-bottom: 1.5rem;">Which channel manager do you use to manage your property?</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Beds24 - Ready -->
                            <a href="#" onclick="openWizard('beds24')" class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: inherit; transition: all 0.2s; position: relative;">
                                <span style="position: absolute; top: 0.5rem; right: 0.5rem; background: #10b981; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px;"> Ready</span>
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Beds24</div>
                                <div style="color: #64748b; font-size: 0.85rem;">PMS + Channel Manager</div>
                            </a>
                            
                            <!-- Hostaway - Ready -->
                            <a href="#" onclick="openWizard('hostaway')" class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: inherit; transition: all 0.2s; position: relative;">
                                <span style="position: absolute; top: 0.5rem; right: 0.5rem; background: #10b981; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px;"> Ready</span>
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Hostaway</div>
                                <div style="color: #64748b; font-size: 0.85rem;">Vacation Rental Software</div>
                            </a>
                            
                            <!-- Smoobu - Ready -->
                            <a href="#" onclick="openWizard('smoobu')" class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: inherit; transition: all 0.2s; position: relative;">
                                <span style="position: absolute; top: 0.5rem; right: 0.5rem; background: #10b981; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px;"> Ready</span>
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Smoobu</div>
                                <div style="color: #64748b; font-size: 0.85rem;">Channel Manager</div>
                            </a>
                            
                            <!-- Guesty - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Guesty</div>
                                <div style="color: #64748b; font-size: 0.85rem;">Property Management</div>
                            </div>
                            
                            <!-- Cloudbeds - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Cloudbeds</div>
                                <div style="color: #64748b; font-size: 0.85rem;">Hotel PMS</div>
                            </div>
                            
                            <!-- Lodgify - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Lodgify</div>
                                <div style="color: #64748b; font-size: 0.85rem;">Vacation Rental</div>
                            </div>
                            
                            <!-- OwnerRez - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">OwnerRez</div>
                                <div style="color: #64748b; font-size: 0.85rem;">Vacation Rental</div>
                            </div>
                            
                            <!-- Other -->
                            <div class="channel-option" onclick="alert('Contact us for custom integrations!')" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Other</div>
                                <div style="color: #64748b; font-size: 0.85rem;">Not listed here</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Account View -->
            <div id="my-account" class="view">
                <div class="header">
                    <h2> My Account</h2>
                    <p>Manage your profile and account settings</p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Profile Information -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Profile Information</h3>
                        </div>
                        <div style="padding: 1rem 0;">
                            <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
                                <div id="myAccountAvatar" style="width: 80px; height: 80px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 600;">?</div>
                                <div>
                                    <div id="myAccountName" style="font-size: 1.25rem; font-weight: 600;"></div>
                                    <div id="myAccountRole" style="color: #64748b;"></div>
                                </div>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label class="form-label">Full Name</label>
                                    <input type="text" id="myAccountNameInput" class="form-input" placeholder="Your name">
                                </div>
                                <div>
                                    <label class="form-label">Email Address</label>
                                    <input type="email" id="myAccountEmail" class="form-input" placeholder="your@email.com">
                                </div>
                                <div>
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" id="myAccountPhone" class="form-input" placeholder="+44 7700 000000">
                                </div>
                                <div>
                                    <label class="form-label">Business Name</label>
                                    <input type="text" id="myAccountBusiness" class="form-input" placeholder="Your business name">
                                </div>
                                <button class="btn" onclick="saveMyProfile()" style="margin-top: 0.5rem;">
                                     Save Profile
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Change Password -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Change Password</h3>
                        </div>
                        <div style="padding: 1rem 0;">
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label class="form-label">Current Password</label>
                                    <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password">
                                </div>
                                <div>
                                    <label class="form-label">New Password</label>
                                    <input type="password" id="newPassword" class="form-input" placeholder="Enter new password">
                                </div>
                                <div>
                                    <label class="form-label">Confirm New Password</label>
                                    <input type="password" id="confirmNewPassword" class="form-input" placeholder="Confirm new password">
                                </div>
                                <button class="btn" onclick="changeMyPassword()" style="margin-top: 0.5rem;">
                                     Change Password
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Master Admin Only: Create Master Admin -->
                <div id="createMasterAdminSection" class="card" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title"> Create Master Admin Account</h3>
                    </div>
                    <p style="color: #64748b; margin: 0.5rem 0 1rem;">Only visible to Master Admins. Create additional master admin accounts with full system access.</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div>
                            <label class="form-label">Name</label>
                            <input type="text" id="newMasterName" class="form-input" placeholder="Full name">
                        </div>
                        <div>
                            <label class="form-label">Email</label>
                            <input type="email" id="newMasterEmail" class="form-input" placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="form-label">Temporary Password</label>
                            <input type="password" id="newMasterPassword" class="form-input" placeholder="Min 8 characters">
                        </div>
                        <button class="btn" onclick="createMasterAdmin()">
                             Create Master Admin
                        </button>
                    </div>
                    
                    <!-- Existing Master Admins -->
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">Existing Master Admins</h4>
                        <div id="masterAdminsList">
                            <p style="color: #64748b;">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Agency Management (for Admin/SubMaster) -->
                <div id="agencyManagementSection" class="card" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title"> Agency Management</h3>
                    </div>
                    
                    <!-- Current Status -->
                    <div id="currentManagementStatus" style="padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div id="managementStatusIcon" style="width: 48px; height: 48px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;"></div>
                            <div>
                                <div style="font-weight: 600;" id="managementStatusTitle">Self-Managed</div>
                                <div style="font-size: 0.85rem; color: #64748b;" id="managementStatusDesc">You are managing your own account</div>
                            </div>
                            <button id="removeManagementBtn" class="btn btn-secondary" style="display: none; margin-left: auto;" onclick="removeAgencyManagement()">
                                 Remove Agency
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pending Request Banner -->
                    <div id="pendingRequestBanner" style="display: none; padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.25rem;"></span>
                            <div>
                                <div style="font-weight: 600; color: #92400e;">Request Pending</div>
                                <div style="font-size: 0.85rem; color: #a16207;" id="pendingRequestAgency">Awaiting response from agency</div>
                            </div>
                            <button class="btn btn-secondary btn-small" style="margin-left: auto;" onclick="cancelManagementRequest()">Cancel Request</button>
                        </div>
                    </div>
                    
                    <!-- Select Agency Form (only show if self-managed and no pending) -->
                    <div id="selectAgencyForm">
                        <p style="color: #64748b; margin-bottom: 1rem;">
                            Select an agency to manage your properties and bookings. They will be able to view and manage your account on your behalf.
                        </p>
                        
                        <div style="display: flex; gap: 1rem; align-items: end;">
                            <div style="flex: 1;">
                                <label class="form-label">Select Agency</label>
                                <select id="agencySelect" class="form-input">
                                    <option value="">Choose an agency...</option>
                                </select>
                            </div>
                            <button class="btn" onclick="requestAgencyManagement()">
                                 Send Request
                            </button>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem; color: #0369a1;">
                             The agency will receive your request and can approve or decline. You'll be notified of their response.
                        </div>
                    </div>
                    
                    <!-- My Requests History -->
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">Request History</h4>
                        <div id="myManagementRequests">
                            <p style="color: #64748b; font-size: 0.9rem;">No previous requests</p>
                        </div>
                    </div>
                </div>

                <!-- Account Info Card -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Account Information</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem 0;">
                        <div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">Account ID</div>
                            <div id="myAccountId" style="font-family: monospace; font-size: 0.9rem;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">Account Code</div>
                            <div id="myAccountCode" style="font-family: monospace; font-size: 0.9rem;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">Role</div>
                            <div id="myAccountRoleInfo" style="font-size: 0.9rem;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">Status</div>
                            <div id="myAccountStatus" style="font-size: 0.9rem;">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings" class="view">
                <div class="header">
                    <h2>Settings</h2>
                    <p>Configure your system</p>
                </div>

                <div class="card">
                    <h3 class="card-title">System Settings</h3>
                    <p style="color: #64748b; margin-top: 0.5rem;">Configure general system preferences, defaults, and behaviors.</p>
                </div>

                <div class="card">
                    <h3 class="card-title">User Management</h3>
                    <p style="color: #64748b; margin-top: 0.5rem;">Manage admin users and access permissions.</p>
                </div>

                <div class="card">
                    <h3 class="card-title">API Configuration</h3>
                    <p style="color: #64748b; margin-top: 0.5rem;">API keys, webhooks, and developer settings.</p>
                </div>
            </div>

            <!-- Blog App View -->
            <div id="app-blog" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Blog</h2>
                            <p>Create and manage blog posts for your properties</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-secondary" onclick="openIcalFeedsModal()" style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db;">iCal</button>
                            <button class="btn btn-secondary" onclick="openRssFeedsModal()" style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; font-weight: 600;">RSS</button>
                            <button class="btn" onclick="openBlogIdeasWizard()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Get Ideas</button>
                            <button class="btn" onclick="openBlogEditor()">+ New Post</button>
                        </div>
                    </div>
                </div>

                <!-- Property Filter -->
                <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <select id="blog-property-select" class="form-input" onchange="loadBlogByTab()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div style="flex: 2; min-width: 200px;">
                            <input type="text" id="blog-search" class="form-input" placeholder=" Search posts..." oninput="filterBlogPosts()">
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div style="display: flex; gap: 0; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; overflow-x: auto;">
                    <button class="blog-tab active" data-tab="ideas" onclick="switchBlogTab('ideas')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 600; color: #8b5cf6; border-bottom: 2px solid #8b5cf6; margin-bottom: -2px; cursor: pointer; white-space: nowrap;">
                         Ideas <span id="blog-count-ideas" style="background: #ede9fe; color: #7c3aed; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.25rem;">0</span>
                    </button>
                    <button class="blog-tab" data-tab="drafts" onclick="switchBlogTab('drafts')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 500; color: #6b7280; cursor: pointer; white-space: nowrap;">
                         Drafts <span id="blog-count-drafts" style="background: #f3f4f6; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.25rem;">0</span>
                    </button>
                    <button class="blog-tab" data-tab="scheduled" onclick="switchBlogTab('scheduled')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 500; color: #6b7280; cursor: pointer; white-space: nowrap;">
                         Scheduled <span id="blog-count-scheduled" style="background: #f3f4f6; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.25rem;">0</span>
                    </button>
                    <button class="blog-tab" data-tab="published" onclick="switchBlogTab('published')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 500; color: #6b7280; cursor: pointer; white-space: nowrap;">
                         Published <span id="blog-count-published" style="background: #f3f4f6; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.25rem;">0</span>
                    </button>
                    <button class="blog-tab" data-tab="settings" onclick="switchBlogTab('settings')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 500; color: #6b7280; cursor: pointer; white-space: nowrap; margin-left: auto;">
                        âš™ï¸ Settings
                    </button>
                </div>

                <!-- Tab Content -->
                <div id="blog-tab-content">
                    <!-- Ideas Tab (default) -->
                    <div id="blog-tab-ideas" class="blog-tab-panel">
                        <div id="blog-ideas-list">
                            <div class="card" style="text-align: center; padding: 3rem; color: #64748b;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                                <h3 style="margin-bottom: 0.5rem;">No blog ideas yet</h3>
                                <p style="margin-bottom: 1rem;">Get AI-powered blog topic suggestions for your property</p>
                                <button class="btn" onclick="openBlogIdeasWizard()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Get Ideas</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Drafts Tab -->
                    <div id="blog-tab-drafts" class="blog-tab-panel" style="display: none;">
                        <div id="blog-drafts-list"></div>
                    </div>
                    
                    <!-- Scheduled Tab -->
                    <div id="blog-tab-scheduled" class="blog-tab-panel" style="display: none;">
                        <div id="blog-scheduled-list"></div>
                    </div>
                    
                    <!-- Published Tab -->
                    <div id="blog-tab-published" class="blog-tab-panel" style="display: none;">
                        <div id="blog-published-list"></div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div id="blog-tab-settings" class="blog-tab-panel" style="display: none;">
                        <div class="card">
                            <h3 style="margin-bottom: 1.5rem;">ðŸŽ¨ Display Settings</h3>
                            <p style="color: #64748b; margin-bottom: 1.5rem;">Customize how your blog appears on your website. These colors are used by the GAS Blog WordPress plugin.</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                <!-- Colors Section -->
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem;">
                                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Colors</h4>
                                    
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Accent Color</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="blog-color-accent" value="#667eea" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="blog-color-accent-hex" value="#667eea" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Background</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="blog-color-bg" value="#ffffff" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="blog-color-bg-hex" value="#ffffff" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Card Background</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="blog-color-card" value="#ffffff" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="blog-color-card-hex" value="#ffffff" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Text Color</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="blog-color-text" value="#1a1a1a" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="blog-color-text-hex" value="#1a1a1a" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Secondary Text</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="blog-color-secondary" value="#666666" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="blog-color-secondary-hex" value="#666666" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Category Badge Section -->
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem;">
                                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Category Badges</h4>
                                    
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Badge Background</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="blog-color-cat-bg" value="#e0e7ff" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="blog-color-cat-bg-hex" value="#e0e7ff" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Badge Text</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="blog-color-cat-text" value="#4338ca" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="blog-color-cat-text-hex" value="#4338ca" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                        <label style="font-size: 0.8rem; color: #64748b; display: block; margin-bottom: 0.5rem;">Preview:</label>
                                        <span id="blog-category-preview" style="background: #e0e7ff; color: #4338ca; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">Travel Tips</span>
                                    </div>
                                </div>
                                
                                <!-- Presets Section -->
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem;">
                                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Quick Presets</h4>
                                    
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        <button onclick="applyAppColorPreset('blog', 'light')" class="btn btn-secondary" style="font-size: 0.85rem;">â˜€ï¸ Light</button>
                                        <button onclick="applyAppColorPreset('blog', 'dark')" class="btn btn-secondary" style="font-size: 0.85rem; background: #1e293b; color: white;">ðŸŒ™ Dark</button>
                                        <button onclick="applyAppColorPreset('blog', 'ocean')" class="btn btn-secondary" style="font-size: 0.85rem; background: #0ea5e9; color: white;">ðŸŒŠ Ocean</button>
                                        <button onclick="applyAppColorPreset('blog', 'forest')" class="btn btn-secondary" style="font-size: 0.85rem; background: #22c55e; color: white;">ðŸŒ² Forest</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem;">
                                <button class="btn" onclick="saveAppSettings('blog')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">ðŸ’¾ Save Settings</button>
                                <button class="btn btn-secondary" onclick="loadAppSettings('blog')">â†©ï¸ Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attractions App View -->
            <div id="app-attractions" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Attractions</h2>
                            <p>Local attractions and things to do near your properties</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="openAttractionIdeasWizard()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"> Suggest Places</button>
                            <button class="btn" onclick="openAttractionModal()">+ Add Attraction</button>
                        </div>
                    </div>
                </div>

                <!-- Property Filter -->
                <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <select id="attractions-property-select" class="form-input" onchange="loadAttractionsByTab()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div style="flex: 2; min-width: 200px;">
                            <input type="text" id="attractions-search" class="form-input" placeholder=" Search attractions..." oninput="filterAttractions()">
                        </div>
                    </div>
                </div>

                <!-- Tabs - matching Blog pattern -->
                <div style="display: flex; gap: 0; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; overflow-x: auto;">
                    <button class="attraction-tab" data-tab="ideas" onclick="switchAttractionTab('ideas')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 600; color: #f59e0b; border-bottom: 2px solid #f59e0b; margin-bottom: -2px; cursor: pointer; white-space: nowrap;">
                         Ideas <span id="attraction-count-ideas" style="background: #fef3c7; color: #b45309; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.25rem;">0</span>
                    </button>
                    <button class="attraction-tab" data-tab="drafts" onclick="switchAttractionTab('drafts')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 500; color: #6b7280; cursor: pointer; white-space: nowrap;">
                         Drafts <span id="attraction-count-drafts" style="background: #f3f4f6; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.25rem;">0</span>
                    </button>
                    <button class="attraction-tab" data-tab="scheduled" onclick="switchAttractionTab('scheduled')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 500; color: #6b7280; cursor: pointer; white-space: nowrap;">
                         Scheduled <span id="attraction-count-scheduled" style="background: #f3f4f6; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.25rem;">0</span>
                    </button>
                    <button class="attraction-tab" data-tab="published" onclick="switchAttractionTab('published')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 500; color: #6b7280; cursor: pointer; white-space: nowrap;">
                         Published <span id="attraction-count-published" style="background: #f3f4f6; padding: 0.125rem 0.5rem; border-radius: 10px; font-size: 0.75rem; margin-left: 0.25rem;">0</span>
                    </button>
                    <button class="attraction-tab" data-tab="settings" onclick="switchAttractionTab('settings')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 500; color: #6b7280; cursor: pointer; white-space: nowrap; margin-left: auto;">
                        âš™ï¸ Settings
                    </button>
                </div>

                <!-- Tab Content -->
                <div id="attraction-tab-content">
                    <!-- Ideas Tab -->
                    <div id="attraction-tab-ideas" class="attraction-tab-panel">
                        <div id="attraction-ideas-list">
                            <div class="card" style="text-align: center; padding: 3rem; color: #64748b;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                                <h3 style="margin-bottom: 0.5rem;">No attraction ideas yet</h3>
                                <p style="margin-bottom: 1rem;">Get AI suggestions for local places near your property</p>
                                <button class="btn" onclick="openAttractionIdeasWizard()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"> Suggest Places</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Drafts Tab -->
                    <div id="attraction-tab-drafts" class="attraction-tab-panel" style="display: none;">
                        <div id="attraction-drafts-list"></div>
                    </div>
                    
                    <!-- Scheduled Tab -->
                    <div id="attraction-tab-scheduled" class="attraction-tab-panel" style="display: none;">
                        <div id="attraction-scheduled-list"></div>
                    </div>
                    
                    <!-- Published Tab -->
                    <div id="attraction-tab-published" class="attraction-tab-panel" style="display: none;">
                        <div id="attraction-published-list"></div>
                    </div>
                    
                    <!-- Settings Tab -->
                    <div id="attraction-tab-settings" class="attraction-tab-panel" style="display: none;">
                        <div class="card">
                            <h3 style="margin-bottom: 1.5rem;">ðŸŽ¨ Display Settings</h3>
                            <p style="color: #64748b; margin-bottom: 1.5rem;">Customize how attractions appear on your website. These colors are used by the GAS Attractions WordPress plugin.</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                                <!-- Colors Section -->
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem;">
                                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Colors</h4>
                                    
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Accent Color</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="attractions-color-accent" value="#f59e0b" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="attractions-color-accent-hex" value="#f59e0b" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Background</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="attractions-color-bg" value="#ffffff" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="attractions-color-bg-hex" value="#ffffff" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Card Background</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="attractions-color-card" value="#ffffff" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="attractions-color-card-hex" value="#ffffff" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Text Color</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="attractions-color-text" value="#1a1a1a" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="attractions-color-text-hex" value="#1a1a1a" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Secondary Text</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="attractions-color-secondary" value="#666666" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="attractions-color-secondary-hex" value="#666666" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Category Badge Section -->
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem;">
                                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Category Badges</h4>
                                    
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Badge Background</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="attractions-color-cat-bg" value="#fef3c7" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="attractions-color-cat-bg-hex" value="#fef3c7" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <label style="font-size: 0.9rem;">Badge Text</label>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="color" id="attractions-color-cat-text" value="#92400e" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                                <input type="text" id="attractions-color-cat-text-hex" value="#92400e" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                        <label style="font-size: 0.8rem; color: #64748b; display: block; margin-bottom: 0.5rem;">Preview:</label>
                                        <span id="attractions-category-preview" style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem;">Restaurants</span>
                                    </div>
                                </div>
                                
                                <!-- Presets Section -->
                                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem;">
                                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Quick Presets</h4>
                                    
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        <button onclick="applyAppColorPreset('attractions', 'light')" class="btn btn-secondary" style="font-size: 0.85rem;">â˜€ï¸ Light</button>
                                        <button onclick="applyAppColorPreset('attractions', 'dark')" class="btn btn-secondary" style="font-size: 0.85rem; background: #1e293b; color: white;">ðŸŒ™ Dark</button>
                                        <button onclick="applyAppColorPreset('attractions', 'ocean')" class="btn btn-secondary" style="font-size: 0.85rem; background: #0ea5e9; color: white;">ðŸŒŠ Ocean</button>
                                        <button onclick="applyAppColorPreset('attractions', 'forest')" class="btn btn-secondary" style="font-size: 0.85rem; background: #22c55e; color: white;">ðŸŒ² Forest</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem;">
                                <button class="btn" onclick="saveAppSettings('attractions')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">ðŸ’¾ Save Settings</button>
                                <button class="btn btn-secondary" onclick="loadAppSettings('attractions')">â†©ï¸ Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews App View -->
            <div id="app-reviews" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>â­ Reviews</h2>
                            <p>Manage guest reviews and testimonials</p>
                        </div>
                        <button class="btn" onclick="openReviewModal()">+ Add Review</button>
                    </div>
                </div>

                <!-- Tabs -->
                <div style="display: flex; gap: 0; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                    <button class="reviews-tab active" data-tab="list" onclick="switchReviewsTab('list')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 600; color: #eab308; border-bottom: 2px solid #eab308; margin-bottom: -2px; cursor: pointer;">
                        â­ Reviews
                    </button>
                    <button class="reviews-tab" data-tab="settings" onclick="switchReviewsTab('settings')" style="padding: 0.75rem 1.25rem; border: none; background: none; font-weight: 500; color: #6b7280; cursor: pointer; margin-left: auto;">
                        âš™ï¸ Settings
                    </button>
                </div>

                <!-- Reviews List Tab -->
                <div id="reviews-tab-list" class="reviews-tab-panel">
                    <!-- Filters -->
                    <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <label style="font-weight: 600; white-space: nowrap;">Property:</label>
                                <select id="reviews-property-filter" class="form-input" style="min-width: 200px;" onchange="loadAppReviews()">
                                    <option value="">All Properties</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <label style="font-weight: 600; white-space: nowrap;">Min Rating:</label>
                                <select id="reviews-rating-filter" class="form-input" style="min-width: 120px;" onchange="loadAppReviews()">
                                    <option value="">All Ratings</option>
                                    <option value="9">9+ (Excellent)</option>
                                    <option value="8">8+ (Very Good)</option>
                                    <option value="7">7+ (Good)</option>
                                    <option value="5">5+ (Average)</option>
                                    <option value="1">1+ (All)</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <label style="font-weight: 600; white-space: nowrap;">Channel:</label>
                                <select id="reviews-channel-filter" class="form-input" style="min-width: 150px;" onchange="loadAppReviews()">
                                    <option value="">All Channels</option>
                                    <option value="Airbnb">Airbnb</option>
                                    <option value="Booking.com">Booking.com</option>
                                    <option value="VRBO">VRBO</option>
                                    <option value="Expedia">Expedia</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" onclick="loadAppReviews()" style="margin-left: auto;">ðŸ”„ Refresh</button>
                        </div>
                    </div>

                    <div class="card">
                        <div id="app-reviews-list">
                            <div style="text-align: center; padding: 3rem; color: #64748b;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">â­</div>
                                <h3 style="margin-bottom: 0.5rem;">No reviews yet</h3>
                                <p>Add guest reviews to build trust with potential guests</p>
                                <button class="btn" style="margin-top: 1rem;" onclick="openReviewModal()">Add Your First Review</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="reviews-tab-settings" class="reviews-tab-panel" style="display: none;">
                    <div class="card">
                        <h3 style="margin-bottom: 1.5rem;">ðŸŽ¨ Display Settings</h3>
                        <p style="color: #64748b; margin-bottom: 1.5rem;">Customize how reviews appear on your website. These colors are used by the GAS Reviews WordPress plugin.</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <!-- Colors Section -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem;">
                                <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Colors</h4>
                                
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <label style="font-size: 0.9rem;">Accent Color</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="color" id="reviews-color-accent" value="#667eea" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                            <input type="text" id="reviews-color-accent-hex" value="#667eea" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <label style="font-size: 0.9rem;">Background</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="color" id="reviews-color-bg" value="#ffffff" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                            <input type="text" id="reviews-color-bg-hex" value="#ffffff" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <label style="font-size: 0.9rem;">Card Background</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="color" id="reviews-color-card" value="#ffffff" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                            <input type="text" id="reviews-color-card-hex" value="#ffffff" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <label style="font-size: 0.9rem;">Text Color</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="color" id="reviews-color-text" value="#1e293b" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                            <input type="text" id="reviews-color-text-hex" value="#1e293b" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <label style="font-size: 0.9rem;">Secondary Text</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="color" id="reviews-color-secondary" value="#64748b" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                            <input type="text" id="reviews-color-secondary-hex" value="#64748b" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <label style="font-size: 0.9rem;">Star Color</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="color" id="reviews-color-star" value="#fbbf24" style="width: 40px; height: 32px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; padding: 2px;">
                                            <input type="text" id="reviews-color-star-hex" value="#fbbf24" style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Preview Section -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem;">
                                <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Preview</h4>
                                <div id="reviews-preview-card" style="background: white; border-radius: 12px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                        <div id="reviews-preview-avatar" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #8b5cf6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">J</div>
                                        <div style="flex: 1;">
                                            <div id="reviews-preview-name" style="font-weight: 600; color: #1e293b;">John D.</div>
                                            <div id="reviews-preview-meta" style="font-size: 0.8rem; color: #64748b;">Dec 2025 â€¢ Airbnb</div>
                                        </div>
                                        <div id="reviews-preview-stars" style="color: #fbbf24;">â˜…â˜…â˜…â˜…â˜…</div>
                                    </div>
                                    <p id="reviews-preview-text" style="color: #64748b; font-size: 0.9rem; margin: 0;">"Amazing stay! The location was perfect."</p>
                                </div>
                            </div>
                            
                            <!-- Presets Section -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem;">
                                <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Quick Presets</h4>
                                
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    <button onclick="applyAppColorPreset('reviews', 'light')" class="btn btn-secondary" style="font-size: 0.85rem;">â˜€ï¸ Light</button>
                                    <button onclick="applyAppColorPreset('reviews', 'dark')" class="btn btn-secondary" style="font-size: 0.85rem; background: #1e293b; color: white;">ðŸŒ™ Dark</button>
                                    <button onclick="applyAppColorPreset('reviews', 'ocean')" class="btn btn-secondary" style="font-size: 0.85rem; background: #0ea5e9; color: white;">ðŸŒŠ Ocean</button>
                                    <button onclick="applyAppColorPreset('reviews', 'forest')" class="btn btn-secondary" style="font-size: 0.85rem; background: #22c55e; color: white;">ðŸŒ² Forest</button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem;">
                            <button class="btn" onclick="saveAppSettings('reviews')" style="background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);">ðŸ’¾ Save Settings</button>
                            <button class="btn btn-secondary" onclick="loadAppSettings('reviews')">â†©ï¸ Reset</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEO Analytics View -->
            <div id="app-seo" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> SEO Analytics</h2>
                            <p>Search performance and keyword insights from Google Search Console</p>
                        </div>
                        <button class="btn" onclick="loadSeoData()" style="background: #4285f4;"> Refresh</button>
                    </div>
                </div>

                <!-- Site Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 300px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Website</label>
                            <select id="seo-site-select" class="form-input" onchange="loadSeoData()">
                                <option value="">Select a verified site...</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Period</label>
                            <select id="seo-period-select" class="form-input" onchange="loadSeoData()">
                                <option value="7">Last 7 days</option>
                                <option value="28" selected>Last 28 days</option>
                                <option value="90">Last 90 days</option>
                            </select>
                        </div>
                        <div class="master-only" style="align-self: flex-end;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">&nbsp;</label>
                            <button class="btn" onclick="deleteSeoSite()" style="background: #ef4444; padding: 0.5rem 1rem;"> Remove Site</button>
                        </div>
                    </div>
                </div>

                <!-- Google Quick Links (Master Only) -->
                <div class="card master-only" style="margin-bottom: 1rem; background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white;">
                    <h3 style="margin: 0 0 1rem 0; font-size: 1rem;"> Google Admin Quick Links</h3>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <a href="https://analytics.google.com" target="_blank" style="background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                             GA4 Dashboard
                        </a>
                        <a href="https://analytics.google.com/analytics/web/#/a378182832p517063872/admin" target="_blank" style="background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                             GA4 Admin
                        </a>
                        <a href="https://search.google.com/search-console" target="_blank" style="background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                             Search Console
                        </a>
                        <a href="https://console.cloud.google.com/apis/credentials?project=gas-travel-platform" target="_blank" style="background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                             API Credentials
                        </a>
                        <a href="https://console.cloud.google.com/apis/dashboard?project=gas-travel-platform" target="_blank" style="background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                             API Usage
                        </a>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div id="seo-summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold; color: #4285f4;" id="seo-total-clicks">-</div>
                        <div style="color: #64748b; margin-top: 0.25rem;">Total Clicks</div>
                        <div id="seo-clicks-change" style="font-size: 0.85rem; margin-top: 0.5rem;"></div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold; color: #34a853;" id="seo-total-impressions">-</div>
                        <div style="color: #64748b; margin-top: 0.25rem;">Impressions</div>
                        <div id="seo-impressions-change" style="font-size: 0.85rem; margin-top: 0.5rem;"></div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold; color: #fbbc04;" id="seo-avg-ctr">-</div>
                        <div style="color: #64748b; margin-top: 0.25rem;">Avg CTR</div>
                        <div id="seo-ctr-change" style="font-size: 0.85rem; margin-top: 0.5rem;"></div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2rem; font-weight: bold; color: #ea4335;" id="seo-avg-position">-</div>
                        <div style="color: #64748b; margin-top: 0.25rem;">Avg Position</div>
                        <div id="seo-position-change" style="font-size: 0.85rem; margin-top: 0.5rem;"></div>
                    </div>
                </div>

                <!-- Tabs for Keywords / Pages / Opportunities -->
                <div class="card">
                    <div style="display: flex; gap: 0; border-bottom: 1px solid var(--border); margin: -1.5rem -1.5rem 1rem -1.5rem; padding: 0 1.5rem;">
                        <button class="seo-tab active" data-tab="keywords" onclick="switchSeoTab('keywords')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid #4285f4; font-weight: 600; color: #4285f4;">
                             Top Keywords
                        </button>
                        <button class="seo-tab" data-tab="opportunities" onclick="switchSeoTab('opportunities')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #64748b;">
                             Opportunities
                        </button>
                        <button class="seo-tab" data-tab="pages" onclick="switchSeoTab('pages')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #64748b;">
                             Top Pages
                        </button>
                    </div>
                    
                    <!-- Tab Explanation -->
                    <div id="seo-tab-explanation" style="background: #f8fafc; border-radius: 6px; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.9rem; color: #64748b;">
                        <strong>Top Keywords:</strong> Search terms people use to find your site. Shows clicks, impressions, and your Google ranking position.
                    </div>

                    <!-- Keywords Tab -->
                    <div id="seo-tab-keywords" class="seo-tab-content">
                        <div id="seo-keywords-list">
                            <div style="text-align: center; padding: 3rem; color: #64748b;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                <h3 style="margin-bottom: 0.5rem;">No keyword data yet</h3>
                                <p>Google Search Console needs 2-3 days after verification to collect search data.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Opportunities Tab -->
                    <div id="seo-tab-opportunities" class="seo-tab-content" style="display: none;">
                        <div id="seo-opportunities-list">
                            <div style="text-align: center; padding: 3rem; color: #64748b;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                <h3 style="margin-bottom: 0.5rem;">No opportunities yet</h3>
                                <p>Once you have keyword data, we'll show keywords where you rank #5-20 with high search volume - these are your best chances to improve with new content.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Pages Tab -->
                    <div id="seo-tab-pages" class="seo-tab-content" style="display: none;">
                        <div id="seo-pages-list">
                            <div style="text-align: center; padding: 3rem; color: #64748b;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                <h3 style="margin-bottom: 0.5rem;">No page data yet</h3>
                                <p>Shows which pages on your site get the most search traffic, helping you understand what's working.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Site Health -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;"> Site Health</h3>
                        <button class="btn" onclick="loadSiteHealth()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Check Health</button>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1rem;">Google PageSpeed Insights - real performance data to ignore fake SEO salespeople.</p>
                    
                    <div id="site-health-results">
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <p>Select a site and click "Check Health" to run a performance audit.</p>
                        </div>
                    </div>
                </div>

                <!-- GA4 Traffic Stats -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;"> Traffic Overview</h3>
                        <button class="btn" onclick="loadGa4Traffic()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Load Traffic</button>
                    </div>
                    
                    <div id="ga4-traffic-results">
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <p>Select a site and click "Load Traffic" to see visitor analytics.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Documentation View -->
            <div id="api-docs" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Partner API Documentation</h2>
                            <p>GasSync & Website Builder API for channel managers and partners</p>
                        </div>
                    </div>
                </div>

                <!-- Partner Key Request -->
                <div class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                    <div class="card-header" style="border-bottom: 1px solid #fcd34d;">
                        <h3 class="card-title" style="color: #92400e;"> Request Partner API Access</h3>
                    </div>
                    <p style="color: #78350f; margin-bottom: 1rem;">
                        Integrate your PMS or booking platform with GAS. Fill out the form below to request API credentials.
                    </p>
                    
                    <div id="partner-request-form" style="max-width: 500px;">
                        <div class="form-group">
                            <label class="form-label" style="color: #78350f;">Company Name *</label>
                            <input type="text" class="form-input" id="partner-company-name" placeholder="e.g., Elevate PMS">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="color: #78350f;">Contact Name *</label>
                            <input type="text" class="form-input" id="partner-contact-name" placeholder="Your name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="color: #78350f;">Email *</label>
                            <input type="email" class="form-input" id="partner-contact-email" placeholder="api@yourcompany.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="color: #78350f;">Website</label>
                            <input type="url" class="form-input" id="partner-website" placeholder="https://yourcompany.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="color: #78350f;">Use Case</label>
                            <textarea class="form-input" id="partner-use-case" rows="3" placeholder="Describe how you plan to integrate with GAS..."></textarea>
                        </div>
                        <button class="btn" style="background: #f59e0b; border-color: #d97706;" onclick="submitPartnerRequest()">
                             Submit Request
                        </button>
                    </div>
                    <div id="partner-request-success" style="display: none; padding: 1rem; background: #dcfce7; border-radius: 8px; margin-top: 1rem;">
                        <strong style="color: #166534;"> Request submitted!</strong>
                        <p style="color: #166534; margin: 0.5rem 0 0;">We'll review your request and contact you within 2 business days.</p>
                    </div>
                </div>

                <!-- Authentication Info -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title"> Authentication</h3>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1rem;">
                        All Partner API endpoints require the <code style="background: #fee2e2; padding: 0.125rem 0.375rem; border-radius: 4px;">X-Partner-Key</code> header.
                    </p>
                    <pre style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.85rem;">curl -X GET "https://api.gas.com/api/partner/v1/properties" \
  -H "X-Partner-Key: gp_your_api_key_here"</pre>
                </div>

                <!-- GasSync API Summary -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card-title"> GasSync API</h3>
                        <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">Calry-Compatible</span>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1rem;">
                        Push property, room, availability, and booking data to GAS.
                    </p>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn" style="background: var(--accent);" onclick="showPartnerApiTab('properties')" id="partner-tab-properties">Properties</button>
                        <button class="btn" style="background: #64748b;" onclick="showPartnerApiTab('units')" id="partner-tab-units">Units</button>
                        <button class="btn" style="background: #64748b;" onclick="showPartnerApiTab('availability')" id="partner-tab-availability">Availability</button>
                        <button class="btn" style="background: #64748b;" onclick="showPartnerApiTab('reservations')" id="partner-tab-reservations">Reservations</button>
                        <button class="btn" style="background: #64748b;" onclick="showPartnerApiTab('rates')" id="partner-tab-rates">Rates</button>
                    </div>
                    
                    <div id="partner-api-properties" class="partner-api-section">
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/properties</code>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0.5rem 0 0;">Create/update property with external_id, name, address, etc.</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/properties</code>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0.5rem 0 0;">List all properties</p>
                        </div>
                    </div>
                    
                    <div id="partner-api-units" class="partner-api-section" style="display: none;">
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/units</code>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0.5rem 0 0;">Create/update room with external_id, property_external_id, name, max_occupancy, base_price</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/units?property_external_id=X</code>
                        </div>
                    </div>
                    
                    <div id="partner-api-availability" class="partner-api-section" style="display: none;">
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/availability</code>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0.5rem 0 0;">Push availability: { unit_external_id, availability: [{ date, available, price, min_stay }] }</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/availability?unit_external_id=X&start_date=Y&end_date=Z</code>
                        </div>
                    </div>
                    
                    <div id="partner-api-reservations" class="partner-api-section" style="display: none;">
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/reservations</code>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0.5rem 0 0;">Create/update booking: external_id, unit_external_id, check_in, check_out, guest details, total_price</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/reservations?property_external_id=X</code>
                        </div>
                    </div>
                    
                    <div id="partner-api-rates" class="partner-api-section" style="display: none;">
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/rates</code>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0.5rem 0 0;">Push rates: { unit_external_id, rates: [{ date, price }] }</p>
                        </div>
                    </div>
                </div>

                <!-- Website Builder API -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card-title"> Website Builder API</h3>
                        <span style="background: #f3e8ff; color: #7c3aed; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;">White-Label</span>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1rem;">
                        Create and customize websites for your clients via API.
                    </p>
                    
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn" style="background: var(--accent);" onclick="showWebsiteApiTab('websites')" id="website-tab-websites">Websites</button>
                        <button class="btn" style="background: #64748b;" onclick="showWebsiteApiTab('sections')" id="website-tab-sections">Sections</button>
                        <button class="btn" style="background: #64748b;" onclick="showWebsiteApiTab('deploy')" id="website-tab-deploy">Deploy</button>
                    </div>
                    
                    <div id="website-api-websites" class="website-api-section">
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/websites</code>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0.5rem 0 0;">Create website: { account_external_id, site_name, template, pricing_tier }</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/websites?account_external_id=X</code>
                        </div>
                    </div>
                    
                    <div id="website-api-sections" class="website-api-section" style="display: none;">
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                            <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">PUT</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/websites/{id}/{section}</code>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0.5rem 0 0;">
                                Sections: header, hero, intro, featured, about, reviews, contact, footer, colors, seo
                            </p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/websites/{id}/all-settings</code>
                        </div>
                    </div>
                    
                    <div id="website-api-deploy" class="website-api-section" style="display: none;">
                        <div style="background: #dcfce7; border: 1px solid #86efac; border-radius: 8px; padding: 1rem;">
                            <span style="background: #166534; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                            <code style="margin-left: 0.5rem;">/api/partner/v1/websites/{id}/deploy</code>
                            <p style="color: #166534; font-size: 0.85rem; margin: 0.5rem 0 0;"> Trigger WordPress deployment. Poll GET /websites to check status.</p>
                        </div>
                    </div>
                </div>

                <!-- API Keys Management (existing) -->
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card-title"> API Keys</h3>
                        <button class="btn" onclick="openApiKeyModal()">+ Create API Key</button>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1rem;">
                        API keys are required for secure endpoints. Create separate keys for different applications.
                    </p>
                    
                    <div id="api-keys-list">
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                            <p>No API keys yet. Create one to access secure endpoints.</p>
                        </div>
                    </div>
                </div>

                <!-- Base URL -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title"> API Base URL</h3>
                    </div>
                    <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="api-docs-base-url" value="" readonly style="font-family: monospace;">
                            <button class="btn" style="background: #64748b;" onclick="copyToClipboard(document.getElementById('api-docs-base-url').value)"> Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Secure API Endpoints -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title"> Secure API Endpoints (v1)</h3>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1rem;">
                        Require <code style="background: #fee2e2; padding: 0.125rem 0.375rem; border-radius: 4px;">X-API-Key</code> header. Full access to pricing, availability, offers.
                    </p>
                    
                    <!-- Tabs for endpoint categories -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn" style="background: var(--accent);" onclick="showApiTab('rooms')" id="api-tab-rooms">Rooms</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('availability')" id="api-tab-availability">Availability</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('pricing')" id="api-tab-pricing">Pricing</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('offers')" id="api-tab-offers">Offers</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('content')" id="api-tab-content">Content</button>
                    </div>
                    
                    <!-- Rooms Endpoints -->
                    <div id="api-endpoints-rooms" class="api-endpoints-section">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/rooms</code>
                                </div>
                                <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Get all rooms with images, amenities, and base pricing</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/rooms/{roomId}</code>
                                </div>
                                <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Get single room with full details</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Availability Endpoints -->
                    <div id="api-endpoints-availability" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/availability?start_date=X&end_date=Y&room_id=Z</code>
                                </div>
                                <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Get availability calendar for date range</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/availability/check</code>
                                </div>
                                <p style="color: #64748b; font-size: 0.85rem; margin: 0 0 0.5rem;">Check if room is available + calculate total price</p>
                                <code style="font-size: 0.8rem; color: #64748b;">Body: { room_id, check_in, check_out, guests }</code>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pricing Endpoints -->
                    <div id="api-endpoints-pricing" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/pricing?room_id=X&start_date=Y&end_date=Z</code>
                                </div>
                                <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Get base prices and seasonal pricing</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/taxes</code>
                                </div>
                                <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Get all taxes and fees</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Offers Endpoints -->
                    <div id="api-endpoints-offers" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/offers</code>
                                </div>
                                <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Get active offers and promotions</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/offers/validate</code>
                                </div>
                                <p style="color: #64748b; font-size: 0.85rem; margin: 0 0 0.5rem;">Validate promo code or voucher</p>
                                <code style="font-size: 0.8rem; color: #64748b;">Body: { code, room_id, check_in, check_out, subtotal }</code>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/upsells?room_id=X</code>
                                </div>
                                <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Get available upsells/add-ons</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Endpoints -->
                    <div id="api-endpoints-content" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/content</code>
                                </div>
                                <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Get all content: pages, contact, branding, blog, attractions</p>
                            </div>
                        </div>
                    </div>
                    
                    <details style="margin-top: 1.5rem;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--accent);"> View Example Code (Secure API)</summary>
                        <pre style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; overflow-x: auto; margin-top: 0.75rem; font-size: 0.85rem;">
// All secure endpoints require X-API-Key header
const API_KEY = 'gas_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
const headers = { 'X-API-Key': API_KEY };

// Get all rooms with full details
const rooms = await fetch('/api/v1/rooms', { headers });
const roomsData = await rooms.json();

// Check availability and get price
const availability = await fetch('/api/v1/availability/check', {
  method: 'POST',
  headers: { ...headers, 'Content-Type': 'application/json' },
  body: JSON.stringify({
    room_id: 123,
    check_in: '2025-02-15',
    check_out: '2025-02-18',
    guests: 2
  })
});
const availData = await availability.json();
// Returns: { available: true, pricing: { nights: 3, total: 450, currency: 'USD' } }

// Validate a promo code
const promo = await fetch('/api/v1/offers/validate', {
  method: 'POST',
  headers: { ...headers, 'Content-Type': 'application/json' },
  body: JSON.stringify({
    code: 'SUMMER20',
    subtotal: 450
  })
});
// Returns: { valid: true, type: 'voucher', calculated_discount: 90 }
                        </pre>
                    </details>
                </div>

                <!-- Public Endpoints -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title"> Public Endpoints (No Auth)</h3>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1rem;">
                        No API key required. Limited data, safe for frontend JavaScript.
                    </p>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace; font-size: 0.9rem;">/api/public/client/{clientId}/site-config</code>
                            </div>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Complete site config (contact, branding, navigation, pages)</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace; font-size: 0.9rem;">/api/public/client/{clientId}/rooms</code>
                            </div>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Public room listing</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                                <code style="font-family: monospace; font-size: 0.9rem;">/api/public/check-availability</code>
                            </div>
                            <p style="color: #64748b; font-size: 0.85rem; margin: 0;">Basic availability check</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Key Modal -->
            <div id="apiKeyModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px; border-radius: 16px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                        <h3 id="apiKeyModalTitle" style="margin: 0;"> Create API Key</h3>
                        <button class="modal-close" onclick="closeApiKeyModal()" style="color: white;"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Key Name *</label>
                            <input type="text" class="form-input" id="api-key-name" placeholder="e.g., WordPress Site, Mobile App">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Permissions</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-rooms" checked> Read Rooms
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-availability" checked> Read Availability
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-pricing" checked> Read Pricing
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-offers" checked> Read Offers
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-content" checked> Read Content
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Rate Limit (requests/minute)</label>
                            <input type="number" class="form-input" id="api-key-rate-limit" value="60">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Allowed Origins (optional, comma-separated)</label>
                            <input type="text" class="form-input" id="api-key-origins" placeholder="https://mysite.com, https://app.mysite.com">
                        </div>
                        
                        <input type="hidden" id="api-key-edit-id" value="">
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeApiKeyModal()">Cancel</button>
                        <button class="btn" onclick="saveApiKey()">Create Key</button>
                    </div>
                </div>
            </div>

            <!-- Service Credentials Vault View -->
            <div id="service-credentials" class="view">
                <div class="header">
                    <h2> Service Credentials Vault</h2>
                    <p>Centralized storage for all external service logins, API keys, and important links</p>
                </div>

                <!-- Quick Links Card -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); color: white;">
                    <div class="card-header" style="border-bottom-color: rgba(255,255,255,0.1);">
                        <h3 style="color: white;"> Quick Access Links</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                            <a href="https://dash.cloudflare.com" target="_blank" class="quick-link-btn" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; text-decoration: none; transition: all 0.2s;">
                                <span style="font-size: 1.5rem;"></span>
                                <div>
                                    <div style="font-weight: 600;">Cloudflare</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">R2 Storage & CDN</div>
                                </div>
                            </a>
                            <a href="https://railway.app/dashboard" target="_blank" class="quick-link-btn" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; text-decoration: none; transition: all 0.2s;">
                                <span style="font-size: 1.5rem;"></span>
                                <div>
                                    <div style="font-weight: 600;">Railway</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">GAS App & Database</div>
                                </div>
                            </a>
                            <a href="https://hpanel.hostinger.com" target="_blank" class="quick-link-btn" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; text-decoration: none; transition: all 0.2s;">
                                <span style="font-size: 1.5rem;"></span>
                                <div>
                                    <div style="font-weight: 600;">Hostinger</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">VPS & WordPress</div>
                                </div>
                            </a>
                            <a href="https://dcc.godaddy.com" target="_blank" class="quick-link-btn" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; text-decoration: none; transition: all 0.2s;">
                                <span style="font-size: 1.5rem;"></span>
                                <div>
                                    <div style="font-weight: 600;">GoDaddy</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Domains & DNS</div>
                                </div>
                            </a>
                            <a href="https://github.com" target="_blank" class="quick-link-btn" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; text-decoration: none; transition: all 0.2s;">
                                <span style="font-size: 1.5rem;"></span>
                                <div>
                                    <div style="font-weight: 600;">GitHub</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Code Repository</div>
                                </div>
                            </a>
                            <a href="https://dashboard.stripe.com" target="_blank" class="quick-link-btn" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; text-decoration: none; transition: all 0.2s;">
                                <span style="font-size: 1.5rem;"></span>
                                <div>
                                    <div style="font-weight: 600;">Stripe</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Payments</div>
                                </div>
                            </a>
                            <a href="https://analytics.google.com" target="_blank" class="quick-link-btn" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; text-decoration: none; transition: all 0.2s;">
                                <span style="font-size: 1.5rem;"></span>
                                <div>
                                    <div style="font-weight: 600;">Google Analytics</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Traffic & Analytics</div>
                                </div>
                            </a>
                            <a href="https://search.google.com/search-console" target="_blank" class="quick-link-btn" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; text-decoration: none; transition: all 0.2s;">
                                <span style="font-size: 1.5rem;"></span>
                                <div>
                                    <div style="font-weight: 600;">Search Console</div>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">SEO & Indexing</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Add New Credential Button -->
                <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                    <button class="btn" onclick="openAddCredentialModal()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                         Add Credential
                    </button>
                </div>

                <!-- Credentials List -->
                <div id="credentials-list">
                    <!-- Will be populated by loadCredentials() -->
                </div>

                <!-- Empty State -->
                <div id="credentials-empty" class="card" style="text-align: center; padding: 3rem; display: none;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                    <h3>No Credentials Stored Yet</h3>
                    <p style="color: #64748b; margin-bottom: 1rem;">Add your first service credential to get started</p>
                    <button class="btn" onclick="openAddCredentialModal()"> Add First Credential</button>
                </div>
            </div>

            <!-- Add/Edit Credential Modal -->
            <div id="credential-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 600px; border-radius: 12px; overflow: hidden;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); color: white; padding: 1.25rem 1.5rem;">
                        <h3 id="credential-modal-title" style="margin: 0; color: white;">Add Credential</h3>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <input type="hidden" id="credential-id">
                        
                        <div class="form-group">
                            <label class="form-label">Service Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" class="form-input" id="credential-name" placeholder="e.g., Cloudflare, Railway, Stripe">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="credential-category">
                                <option value="hosting"> Hosting & Infrastructure</option>
                                <option value="payments"> Payments</option>
                                <option value="analytics"> Analytics</option>
                                <option value="email"> Email</option>
                                <option value="api"> API & Integrations</option>
                                <option value="domains"> Domains & DNS</option>
                                <option value="other"> Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Dashboard URL</label>
                            <input type="url" class="form-input" id="credential-url" placeholder="https://dashboard.service.com">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Username / Email</label>
                            <input type="text" class="form-input" id="credential-username" placeholder="login@email.com">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <div style="position: relative;">
                                <input type="password" class="form-input" id="credential-password" placeholder="" style="padding-right: 40px;">
                                <button type="button" onclick="toggleCredentialPassword()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem;"></button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">API Key / Secret</label>
                            <div style="position: relative;">
                                <input type="password" class="form-input" id="credential-api-key" placeholder="sk_live_..." style="padding-right: 40px;">
                                <button type="button" onclick="toggleCredentialApiKey()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.2rem;"></button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="credential-notes" rows="3" placeholder="Any additional info, renewal dates, account numbers, etc."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="closeCredentialModal()">Cancel</button>
                        <button class="btn" onclick="saveCredential()"> Save</button>
                    </div>
                </div>
            </div>

            <!-- Calry Admin View -->
            <div id="calry-admin" class="view">
                <div class="header">
                    <h2>ðŸ”— Calry Admin</h2>
                    <p>Manage Calry API credentials and PMS integrations (Lodgify, Smoobu, Guesty, etc.)</p>
                </div>

                <!-- Calry API Credentials Card -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white;">
                    <div class="card-header" style="border-bottom-color: rgba(255,255,255,0.1);">
                        <h3 style="color: white;">ðŸ”‘ Calry API Credentials</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; gap: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="color: rgba(255,255,255,0.9); font-size: 0.85rem;">API Token (JWT)</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="password" id="calry-api-token" class="form-input" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white;" placeholder="eyJ...">
                                    <button class="btn btn-secondary" onclick="toggleCalryTokenVisibility()" style="background: rgba(255,255,255,0.2); border: none; color: white;">ðŸ‘ï¸</button>
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="color: rgba(255,255,255,0.9); font-size: 0.85rem;">Workspace ID</label>
                                <input type="text" id="calry-workspace-id" class="form-input" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white;" placeholder="d0799b62-8521-4577-8b9b-...">
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <button class="btn" onclick="saveCalryCredentials()" style="background: rgba(255,255,255,0.2); border: none;">ðŸ’¾ Save Credentials</button>
                                <button class="btn btn-secondary" onclick="testCalryConnection()" style="background: rgba(255,255,255,0.1); border: none; color: white;">ðŸ” Test Connection</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PMS Integrations Card -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>ðŸ“¡ PMS Integrations via Calry</h3>
                        <button class="btn btn-small" onclick="openAddCalryPMSModal()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            âž• Add PMS
                        </button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="table" style="margin: 0;">
                            <thead>
                                <tr>
                                    <th>PMS</th>
                                    <th>Integration Account ID</th>
                                    <th>Properties</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="calry-pms-list">
                                <!-- Will be populated by loadCalryPMSIntegrations() -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Calry Connected Properties -->
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>ðŸ  Connected Properties</h3>
                        <button class="btn btn-small btn-secondary" onclick="refreshCalryProperties()">ðŸ”„ Refresh</button>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="table" style="margin: 0;">
                            <thead>
                                <tr>
                                    <th>Property</th>
                                    <th>PMS</th>
                                    <th>Calry ID</th>
                                    <th>GAS Link</th>
                                    <th>Last Sync</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="calry-properties-list">
                                <!-- Will be populated by loadCalryProperties() -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add Calry PMS Modal -->
            <div id="calry-pms-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px; border-radius: 12px; overflow: hidden;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 1.25rem 1.5rem;">
                        <h3 id="calry-pms-modal-title" style="margin: 0; color: white;">Add PMS Integration</h3>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <input type="hidden" id="calry-pms-id">
                        
                        <div class="form-group">
                            <label class="form-label">PMS Type <span style="color: #ef4444;">*</span></label>
                            <select id="calry-pms-type" class="form-input">
                                <option value="">Select PMS...</option>
                                <option value="lodgify">Lodgify</option>
                                <option value="smoobu">Smoobu</option>
                                <option value="guesty">Guesty</option>
                                <option value="hostaway">Hostaway</option>
                                <option value="beds24">Beds24</option>
                                <option value="hostify">Hostify</option>
                                <option value="uplisting">Uplisting</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Integration Account ID <span style="color: #ef4444;">*</span></label>
                            <input type="text" class="form-input" id="calry-pms-account-id" placeholder="acc15bd3-eaac-42b0-b585-...">
                            <small style="color: #64748b;">Get this from the Calry dashboard for each connected PMS</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Account Name (optional)</label>
                            <input type="text" class="form-input" id="calry-pms-account-name" placeholder="e.g., John's Lodgify Account">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">GAS Account</label>
                            <select id="calry-pms-gas-account" class="form-input">
                                <option value="">Select GAS Account to link...</option>
                                <!-- Will be populated with accounts -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="closeCalryPMSModal()">Cancel</button>
                        <button class="btn" onclick="saveCalryPMS()">ðŸ’¾ Save Integration</button>
                    </div>
                </div>
            </div>

            <!-- WordPress View -->
            <div id="wordpress" class="view">
                <div class="header">
                    <h2>WordPress Integration</h2>
                    <p>Add booking functionality to your WordPress website</p>
                </div>

                <!-- Website Status Section (for selected account) -->
                <div id="wp-website-section" class="card" style="margin-bottom: 1.5rem; display: none;">
                    <div id="wp-no-website" style="display: none;">
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                            <h3 style="margin: 0 0 0.5rem 0;">No Website Yet</h3>
                            <p style="color: #64748b; margin-bottom: 1.5rem;">Create a WordPress website for this account with our booking system pre-installed.</p>
                            <button class="btn" onclick="openCreateWebsiteModal()" style="font-size: 1rem; padding: 0.75rem 2rem;">
                                 Create Website
                            </button>
                        </div>
                    </div>
                    
                    <div id="wp-has-website" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;"></span>
                                Account Website
                            </h3>
                            <span id="wp-website-status" class="badge badge-success">Active</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">Site URL</div>
                                <a id="wp-website-url" href="#" target="_blank" style="color: var(--accent); font-weight: 500; word-break: break-all;"></a>
                            </div>
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">WordPress Admin</div>
                                <a id="wp-website-admin" href="#" target="_blank" style="color: var(--accent); font-weight: 500;">Open Dashboard </a>
                            </div>
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">Template</div>
                                <span id="wp-website-template" style="font-weight: 500;">-</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <a id="wp-website-visit-btn" href="#" target="_blank" class="btn" style="text-decoration: none;">
                                 Visit Site
                            </a>
                            <a id="wp-website-admin-btn" href="#" target="_blank" class="btn btn-secondary" style="text-decoration: none;">
                                 WP Admin
                            </a>
                            <button class="btn btn-secondary" onclick="refreshWebsiteStatus()" style="margin-left: auto;">
                                 Refresh Status
                            </button>
                        </div>
                    </div>
                    
                    <div id="wp-website-creating" style="display: none; text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <h3 style="margin: 0 0 0.5rem 0;">Creating Website...</h3>
                        <p style="color: #64748b;">This usually takes 10-30 seconds</p>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="refreshWebsiteStatus()">Check Status</button>
                        </div>
                    </div>
                </div>

                <!-- WordPress Hosting Settings (Master Admin Only) -->
                <div id="wp-vps-settings" class="card billing-admin-only" style="margin-bottom: 1.5rem; border: 2px dashed var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                             WordPress Hosting Configuration
                        </h3>
                        <button class="btn btn-secondary btn-small" onclick="toggleVPSSettings()">
                            <span id="vps-toggle-text">Show Settings</span>
                        </button>
                    </div>
                    
                    <div id="vps-settings-panel" style="display: none;">
                        <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <p style="margin: 0; font-size: 0.9rem;"> <strong>Your WordPress hosting is active!</strong></p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #64748b;">API: sites.gas.travel</p>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label>API URL</label>
                            <input type="text" id="vps-api-url" class="form-input" value="https://sites.gas.travel/gas-api.php">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label>API Key</label>
                            <input type="password" id="vps-api-key" class="form-input" placeholder="Enter your WordPress API key">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label>Default Template (Optional)</label>
                            <input type="text" id="vps-default-template" class="form-input" placeholder="e.g., developer-theme">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="vps-enabled" style="width: 18px; height: 18px;">
                                Enable WordPress Site Creation
                            </label>
                        </div>
                        
                        <button class="btn" onclick="saveVPSSettings()">ðŸ’¾ Save Settings</button>
                    </div>
                </div>

                <!-- Your Settings -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white;">
                    <h3 style="margin: 0 0 1rem 0;"> Your WordPress Plugin Settings</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.25rem;">API URL</div>
                            <code style="font-size: 0.9rem; word-break: break-all;" id="wp-api-url"></code>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.25rem;">Client Account ID</div>
                            <code style="font-size: 1.2rem; font-weight: bold;" id="wp-client-id">-</code>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.25rem;">Property ID</div>
                            <code style="font-size: 1.2rem; font-weight: bold;" id="wp-property-id">-</code>
                        </div>
                    </div>
                </div>

                <!-- Download Section -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); color: white;">
                    <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                         Plugin Downloads
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
                        <!-- Core Booking Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;"></span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Booking</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v4.0  All Plans</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Search, rooms, calendar & checkout</p>
                            <a href="/downloads/gas-booking-wp-plugin.zip" download class="btn" style="background: white; color: #1e40af; width: 100%; text-align: center; text-decoration: none; display: block; font-size: 0.85rem;">
                                 Download
                            </a>
                        </div>
                        
                        <!-- Theme -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;"></span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">Developer Theme</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v2.0  All Plans</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Starter theme with auto-setup</p>
                            <a href="/downloads/gas-theme-developer.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                 Download
                            </a>
                        </div>
                        
                        <!-- Blog Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;"></span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Blog</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v1.0  Pro+</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Blog with SEO & schema markup</p>
                            <a href="/downloads/gas-blog.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                 Download
                            </a>
                        </div>
                        
                        <!-- Attractions Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;"></span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Attractions</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v1.0  Business+</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Nearby places & activities</p>
                            <a href="/downloads/gas-attractions.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                 Download
                            </a>
                        </div>
                        
                        <!-- Reviews Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;"></span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Reviews</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v1.0  Enterprise</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">TripAdvisor, Booking.com, Google</p>
                            <a href="/downloads/gas-reviews.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                 Download
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Setup Guide -->
                <div class="card" style="margin-bottom: 1.5rem; border: 2px solid var(--accent); border-radius: 12px;">
                    <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                         Setup Guide
                    </h3>
                    
                    <!-- Step 1 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Install the Plugin</h4>
                            <ol style="margin: 0; padding-left: 1.25rem; color: #64748b; font-size: 0.9rem; line-height: 1.8;">
                                <li>Download the <strong>GAS Booking Plugin</strong> ZIP file</li>
                                <li>In WordPress, go to <strong>Plugins  Add New  Upload Plugin</strong></li>
                                <li>Choose the ZIP file and click <strong>Install Now</strong></li>
                                <li>Click <strong>Activate Plugin</strong></li>
                            </ol>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Configure Plugin Settings</h4>
                            <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.75rem;">In WordPress, go to <strong>Settings  GAS Booking</strong> and enter:</p>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-size: 0.85rem;">
                                <div style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: center;">
                                    <strong>API URL:</strong>
                                    <div>
                                        <code style="background: #1e293b; color: #e2e8f0; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;" id="wp-api-url-guide"></code>
                                        <button onclick="copyShortcode(document.getElementById('wp-api-url-guide').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-left: 0.5rem;">Copy</button>
                                    </div>
                                    <strong>Client Account ID:</strong>
                                    <div>
                                        <code style="background: #1e293b; color: #e2e8f0; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;" id="wp-client-id-guide">1</code>
                                        <button onclick="copyShortcode(document.getElementById('wp-client-id-guide').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-left: 0.5rem;">Copy</button>
                                    </div>
                                </div>
                                <p style="margin: 0.75rem 0 0 0; color: #64748b; font-size: 0.8rem;">Leave other settings as default, then click <strong>Save Changes</strong></p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">3</div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Add Search Bar to Homepage</h4>
                            <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.75rem;">Edit your homepage, add a <strong>Shortcode</strong> block, and paste:</p>
                            <div style="background: #1e293b; border-radius: 6px; padding: 0.6rem 1rem; display: inline-flex; align-items: center; gap: 0.75rem;">
                                <code style="color: #e2e8f0; font-size: 0.9rem;">[gas_search]</code>
                                <button onclick="copyShortcode('[gas_search]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;"> Shows check-in/check-out date picker</p>
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">4</div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Create "Book Now" Page</h4>
                            <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.75rem;"><strong>Pages  Add New</strong>  Title: "Book Now"  Add Shortcode block:</p>
                            <div style="background: #1e293b; border-radius: 6px; padding: 0.6rem 1rem; display: inline-flex; align-items: center; gap: 0.75rem;">
                                <code style="color: #e2e8f0; font-size: 0.9rem;" id="wp-rooms-shortcode">[gas_rooms]</code>
                                <button onclick="copyShortcode('[gas_rooms]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;"> Shows grid of all rooms with availability</p>
                        </div>
                    </div>

                    <!-- Step 5 -->
                    <div style="display: flex; gap: 1rem;">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">5</div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Create "Room" Page</h4>
                            <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.75rem;"><strong>Pages  Add New</strong>  Title: "Room"  Add Shortcode block:</p>
                            <div style="background: #1e293b; border-radius: 6px; padding: 0.6rem 1rem; display: inline-flex; align-items: center; gap: 0.75rem;">
                                <code style="color: #e2e8f0; font-size: 0.9rem;">[gas_room]</code>
                                <button onclick="copyShortcode('[gas_room]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;"> Shows full room details, calendar & booking form</p>
                        </div>
                    </div>
                </div>

                <!-- Flow Diagram -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                    <h3 class="card-title" style="margin-bottom: 1rem;"> Booking Flow</h3>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex-wrap: wrap; font-size: 0.9rem;">
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;"></div>
                            <strong>Homepage</strong>
                            <div style="font-size: 0.75rem; color: #64748b;">[gas_search]</div>
                        </div>
                        <div style="font-size: 1.5rem; color: var(--accent);"></div>
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;"></div>
                            <strong>Book Now</strong>
                            <div style="font-size: 0.75rem; color: #64748b;">[gas_rooms]</div>
                        </div>
                        <div style="font-size: 1.5rem; color: var(--accent);"></div>
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;"></div>
                            <strong>Room Details</strong>
                            <div style="font-size: 0.75rem; color: #64748b;">[gas_room]</div>
                        </div>
                        <div style="font-size: 1.5rem; color: var(--accent);"></div>
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;"></div>
                            <strong>Booked!</strong>
                            <div style="font-size: 0.75rem; color: #64748b;">Confirmation</div>
                        </div>
                    </div>
                </div>

                <!-- Plugin Download & Settings -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="24" height="24" viewBox="0 0 122.5 122.5" fill="#21759b"><path d="M8.7 61.3c0 20.8 12.1 38.8 29.6 47.3L13 40.3c-2.8 6.5-4.3 13.7-4.3 21zm88.6-2.7c0-6.5-2.3-11-4.3-14.5-2.7-4.3-5.2-8-5.2-12.3 0-4.8 3.7-9.3 8.9-9.3h.7c-9.4-8.6-21.9-13.9-35.7-13.9-18.5 0-34.7 9.5-44.2 23.8h3.4c5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.8.3-6 .5l19.1 57 11.5-34.5-8.2-22.5c-2.8-.2-5.5-.5-5.5-.5-2.8-.2-2.5-4.5.3-4.3 0 0 8.7.7 13.9.7 5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.9.3-6 .5l19 56.5 5.2-17.5c2.3-7.3 4-12.5 4-17zm-36.3 7.6l-15.8 45.8c4.7 1.4 9.7 2.2 14.8 2.2 6.1 0 12-1.1 17.4-3-.1-.2-.3-.5-.4-.7l-16-43.3zm45.1-29.8c.5 3.4.7 7 .7 10.9 0 10.8-2 22.9-8 38l-21.8 63.1c21.2-12.4 35.5-35.5 35.5-62.1 0-17.9-6.2-34.3-16.4-47.9zM61.3 0C27.5 0 0 27.5 0 61.3c0 33.8 27.5 61.3 61.3 61.3 33.8 0 61.3-27.5 61.3-61.3C122.5 27.5 95 0 61.3 0zm0 119.7c-32.2 0-58.5-26.2-58.5-58.5 0-32.2 26.2-58.5 58.5-58.5 32.2 0 58.5 26.2 58.5 58.5-.1 32.3-26.3 58.5-58.5 58.5z"/></svg>
                                Your Settings
                            </h3>
                        </div>
                        <a href="/gas-widgets-preview.html" target="_blank" class="btn btn-secondary" style="text-decoration: none;">
                            Preview Widgets 
                        </a>
                    </div>
                    
                    <div style="background: var(--accent-light); border-radius: 8px; padding: 1rem;">
                        <div style="display: grid; grid-template-columns: 140px 1fr auto; gap: 0.75rem; align-items: center; font-size: 0.9rem;">
                            <span style="color: #64748b; font-weight: 500;">API URL:</span>
                            <code style="background: white; padding: 0.4rem 0.75rem; border-radius: 4px; font-size: 0.85rem;" id="wp-api-url"></code>
                            <button onclick="copyShortcode(document.getElementById('wp-api-url').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.3rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Copy</button>
                            
                            <span style="color: #64748b; font-weight: 500;">Property ID:</span>
                            <code style="background: white; padding: 0.4rem 0.75rem; border-radius: 4px; font-size: 0.85rem;" id="wp-property-id">1</code>
                            <button onclick="copyShortcode(document.getElementById('wp-property-id').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.3rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Shortcodes Reference -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem;"> Shortcode Reference</h3>
                    
                    <!-- Search Bar -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="background: #dbeafe; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;"></div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Search Bar</h4>
                                <span style="font-size: 0.75rem; color: #64748b;">Homepage</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_search]</code>
                                <button onclick="copyShortcode('[gas_search]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b;">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">style="vertical"</code>
                                <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px; margin-left: 0.25rem;">button_text="Search"</code>
                            </div>
                        </div>
                    </div>

                    <!-- Room Listing -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="background: #dcfce7; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;"></div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Room Listing</h4>
                                <span style="font-size: 0.75rem; color: #64748b;">Book Now page</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_rooms property_id="<span id="shortcode-property-id">1</span>"]</code>
                                <button onclick="copyShortcode('[gas_rooms property_id=&quot;' + (window.currentPropertyId || 1) + '&quot;]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b;">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">columns="2"</code>
                            </div>
                        </div>
                    </div>

                    <!-- Room Detail -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="background: #fef3c7; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;"></div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Room Detail Page</h4>
                                <span style="font-size: 0.75rem; color: #64748b;">Room page</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_room]</code>
                                <button onclick="copyShortcode('[gas_room]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b;">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">unit_id="190"</code>
                                <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px; margin-left: 0.25rem;">months="3"</code>
                            </div>
                        </div>
                    </div>

                    <!-- Compact Booking -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                        <div style="background: #fce7f3; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;"></div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Compact Booking Widget</h4>
                                <span style="font-size: 0.75rem; color: #64748b;">Sidebar / Embed</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_booking unit_id="190"]</code>
                                <button onclick="copyShortcode('[gas_booking unit_id=&quot;190&quot;]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b;">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">months="2"</code>
                                <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px; margin-left: 0.25rem;">show_prices="no"</code>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Room IDs Reference -->
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 0.5rem;">Your Room IDs</h3>
                    <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">Reference these IDs when using shortcodes for specific rooms:</p>
                    <div id="wp-room-ids" style="background: var(--bg-primary); border-radius: 8px; padding: 1rem;">
                        <p style="color: #64748b; font-size: 0.85rem;">Loading rooms...</p>
                    </div>
                </div>
            </div>

            <!-- =====================================================
                 SUB PAGES - About, Gallery, Blog, Attractions, Dining, Contact
                 ===================================================== -->
            
            <!-- Sub Page: Terms & Conditions -->
            <div id="wb-page-terms" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Terms & Conditions</h2>
                            <p>Your booking terms, cancellation policy, and house rules</p>
                        </div>
                        <button class="btn" onclick="saveSubPage('terms')">ðŸ’¾ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Page Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="wb-page-terms-title" value="Terms & Conditions">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Updated Date</label>
                            <input type="date" class="form-input" id="wb-page-terms-updated" style="width: 200px;">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Booking Terms</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-terms-booking-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-terms-booking-title" value="Booking & Reservations" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Booking & Reservation Terms</label>
                            <textarea class="form-textarea" id="wb-page-terms-booking" rows="5" placeholder="Describe how bookings are made, confirmation process, deposit requirements..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Cancellation Policy</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-terms-cancellation-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-terms-cancellation-title" value="Cancellation Policy" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cancellation Terms</label>
                            <textarea class="form-textarea" id="wb-page-terms-cancellation" rows="6" placeholder="e.g., Free cancellation up to 48 hours before check-in. Cancellations within 48 hours will be charged for the first night..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Check-in / Check-out</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-terms-checkin-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-terms-checkin-title" value="Check-in & Check-out" placeholder="Section heading...">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Check-in Time</label>
                                <input type="text" class="form-input" id="wb-page-terms-checkin-time" placeholder="3:00 PM">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Check-out Time</label>
                                <input type="text" class="form-input" id="wb-page-terms-checkout-time" placeholder="11:00 AM">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Additional Details</label>
                            <textarea class="form-textarea" id="wb-page-terms-checkin-details" rows="3" placeholder="Early check-in or late check-out subject to availability..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>House Rules</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-terms-house-rules-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-terms-house-rules-title" value="House Rules" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Property Rules</label>
                            <textarea class="form-textarea" id="wb-page-terms-house-rules" rows="6" placeholder="List your house rules:
 No smoking
 No pets (or pet policy)
 Quiet hours: 10 PM - 8 AM
 Maximum occupancy
 No parties or events"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Payment Terms</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-terms-payment-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-terms-payment-title" value="Payment Terms" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Methods & Terms</label>
                            <textarea class="form-textarea" id="wb-page-terms-payment" rows="4" placeholder="Accepted payment methods, deposit requirements, when payment is taken..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Liability & Damages</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-terms-liability-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-terms-liability-title" value="Liability & Damages" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Liability Terms</label>
                            <textarea class="form-textarea" id="wb-page-terms-liability" rows="4" placeholder="Guest responsibility for damages, security deposit terms, liability limitations..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Additional Terms</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-terms-additional-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-terms-additional-title" value="Additional Terms" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Other Terms & Conditions</label>
                            <textarea class="form-textarea" id="wb-page-terms-additional" rows="5" placeholder="Any other terms not covered above..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub Page: Privacy Policy -->
            <div id="wb-page-privacy" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Privacy Policy</h2>
                            <p>How you collect, use, and protect guest data</p>
                        </div>
                        <button class="btn" onclick="saveSubPage('privacy')">ðŸ’¾ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Page Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="wb-page-privacy-title" value="Privacy Policy">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Last Updated Date</label>
                                <input type="date" class="form-input" id="wb-page-privacy-updated">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Effective Date</label>
                                <input type="date" class="form-input" id="wb-page-privacy-effective">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Introduction</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-privacy-intro-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-privacy-intro-title" value="Introduction" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub-heading</label>
                            <input type="text" class="form-input" id="wb-page-privacy-intro-sub" value="" placeholder="Sub-heading (leave blank to hide)...">
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="wb-page-privacy-intro" rows="4" placeholder="We respect your privacy and are committed to protecting your personal data. This privacy policy explains how we collect, use, and safeguard your information when you visit our website or make a booking."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Data Collection</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-privacy-collection-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-privacy-collection-title" value="Information We Collect" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub-heading 1</label>
                            <input type="text" class="form-input" id="wb-page-privacy-collection-sub1" value="What Data We Collect" placeholder="Sub-heading...">
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="wb-page-privacy-collection" rows="5" placeholder="Types of personal data collected:
 Name, email, phone number
 Payment information
 Booking preferences
 Communication history
 Website usage data"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub-heading 2</label>
                            <input type="text" class="form-input" id="wb-page-privacy-how-collect-sub" value="How We Collect Data" placeholder="Sub-heading...">
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="wb-page-privacy-how-collect" rows="4" placeholder="How data is collected:
 Directly from you (booking forms, contact forms)
 Automatically (cookies, analytics)
 From third parties (booking platforms)"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Data Usage</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-privacy-usage-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-privacy-usage-title" value="How We Use Your Information" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub-heading</label>
                            <input type="text" class="form-input" id="wb-page-privacy-usage-sub" value="Data Usage" placeholder="Sub-heading (leave blank to hide)...">
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="wb-page-privacy-usage" rows="5" placeholder="We use your data to:
 Process and manage bookings
 Send booking confirmations and updates
 Respond to enquiries
 Improve our services
 Send marketing communications (with consent)"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Data Sharing</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-privacy-sharing-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-privacy-sharing-title" value="Information Sharing" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub-heading</label>
                            <input type="text" class="form-input" id="wb-page-privacy-sharing-sub" value="Who We Share Data With" placeholder="Sub-heading (leave blank to hide)...">
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="wb-page-privacy-sharing" rows="4" placeholder="We may share your data with:
 Payment processors
 Booking platforms (Booking.com, Airbnb, etc.)
 Email service providers
 Legal authorities when required"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Cookies</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-privacy-cookies-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-privacy-cookies-title" value="Cookies" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub-heading</label>
                            <input type="text" class="form-input" id="wb-page-privacy-cookies-sub" value="Cookie Policy" placeholder="Sub-heading (leave blank to hide)...">
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="wb-page-privacy-cookies" rows="4" placeholder="Our website uses cookies to improve your experience. We use:
 Essential cookies (required for site functionality)
 Analytics cookies (to understand usage)
 Marketing cookies (with your consent)"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Your Rights</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-privacy-rights-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-privacy-rights-title" value="Your Rights" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub-heading</label>
                            <input type="text" class="form-input" id="wb-page-privacy-rights-sub" value="Data Subject Rights (GDPR)" placeholder="Sub-heading (leave blank to hide)...">
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="wb-page-privacy-rights" rows="5" placeholder="Under data protection law, you have rights including:
 Right to access your personal data
 Right to rectification
 Right to erasure ('right to be forgotten')
 Right to restrict processing
 Right to data portability
 Right to object"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Data Retention</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-privacy-retention-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-privacy-retention-title" value="Data Retention" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub-heading</label>
                            <input type="text" class="form-input" id="wb-page-privacy-retention-sub" value="How Long We Keep Data" placeholder="Sub-heading (leave blank to hide)...">
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="wb-page-privacy-retention" rows="3" placeholder="We retain your personal data for as long as necessary to fulfill the purposes we collected it for, including legal, accounting, or reporting requirements."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Contact Information</h3>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem;">
                            <input type="checkbox" id="wb-page-privacy-contact-enabled" checked>
                            Show Section
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Heading on Website</label>
                            <input type="text" class="form-input" id="wb-page-privacy-contact-title" value="Contact Us" placeholder="Section heading...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub-heading</label>
                            <input type="text" class="form-input" id="wb-page-privacy-contact-sub" value="Data Controller Contact" placeholder="Sub-heading (leave blank to hide)...">
                        </div>
                        <div class="form-group">
                            <textarea class="form-textarea" id="wb-page-privacy-contact" rows="3" placeholder="For privacy-related enquiries, contact:
[Your Business Name]
[Email address]
[Phone number]"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Knowledge Base Articles View -->
            <div id="kb-articles" class="view">
                <div class="header">
                    <h2> Knowledge Base</h2>
                    <p>Manage AI assistant knowledge - articles the chatbot uses to answer questions</p>
                </div>

                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="kb-article-count">0</div>
                        <div style="font-size: 0.85rem; color: #64748b;">Articles</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="kb-category-count">0</div>
                        <div style="font-size: 0.85rem; color: #64748b;">Categories</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="kb-unanswered-count">0</div>
                        <div style="font-size: 0.85rem; color: #64748b;">Unanswered</div>
                    </div>
                </div>

                <!-- Actions Bar -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <button class="btn" onclick="openKBArticleModal()">+ Add Article</button>
                        <button class="btn btn-secondary" onclick="openKBImportModal()"> Import Articles</button>
                        <button class="btn btn-secondary" onclick="setupKnowledgeBase()"> Setup Tables</button>
                        <div style="flex: 1;"></div>
                        <select id="kb-category-filter" class="form-input" style="width: auto;" onchange="loadKBArticles()">
                            <option value="">All Categories</option>
                        </select>
                        <input type="text" id="kb-search" class="form-input" placeholder="Search articles..." style="width: 200px;" onkeyup="debounce(loadKBArticles, 300)()">
                    </div>
                </div>

                <!-- Articles List -->
                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Views</th>
                                    <th>Helpful</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="kb-articles-table">
                                <tr><td colspan="6" style="text-align: center; padding: 2rem; color: #64748b;">Loading articles...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Knowledge Base Unanswered View -->
            <div id="kb-unanswered" class="view">
                <div class="header">
                    <h2> Unanswered Questions</h2>
                    <p>Questions the AI couldn't answer - review and add missing knowledge</p>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="kb-unanswered-filter" class="form-input" style="width: auto;" onchange="loadKBUnanswered()">
                            <option value="new">New</option>
                            <option value="resolved">Resolved</option>
                            <option value="">All</option>
                        </select>
                        <div style="flex: 1;"></div>
                        <span id="kb-unanswered-total" style="color: #64748b; font-size: 0.9rem;">0 questions</span>
                    </div>
                </div>

                <div id="kb-unanswered-list">
                    <div class="card" style="text-align: center; padding: 2rem; color: #64748b;">
                        Loading unanswered questions...
                    </div>
                </div>
            </div>

            <!-- Billing Overview View -->
            <div id="billing-overview" class="view">
                <div class="header">
                    <h2> Billing Overview</h2>
                    <p>Revenue and subscription metrics</p>
                </div>

                <!-- MRR Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <div style="font-size: 2.5rem; font-weight: 700;" id="billing-mrr">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Monthly Recurring Revenue</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent);" id="billing-active-subs">0</div>
                        <div style="font-size: 0.9rem; color: #64748b;">Active Subscriptions</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning);" id="billing-credits-circulation">0</div>
                        <div style="font-size: 0.9rem; color: #64748b;">Credits in Circulation</div>
                    </div>
                </div>

                <!-- Setup Button -->
                <div id="billing-setup-section" class="card" style="margin-bottom: 1.5rem; background: #f0fdf4; border: 1px solid #bbf7d0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; color: #166534;"> Setup Billing Tables</h3>
                            <p style="margin: 0; color: #166534; font-size: 0.9rem;">Run this once to create billing tables and default plans/packages</p>
                        </div>
                        <button class="btn" onclick="setupBilling()">Setup Billing</button>
                    </div>
                </div>

                <!-- Subscriptions by Plan -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title">Subscriptions by Plan</h3>
                    <div id="billing-subs-by-plan">
                        <p style="color: #64748b;">Loading...</p>
                    </div>
                </div>

                <!-- Recent Payments -->
                <div class="card">
                    <h3 class="card-title">Recent Payments</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="billing-recent-payments">
                                <tr><td colspan="4" style="text-align: center; color: #64748b;">No payments yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Billing Plans View -->
            <div id="billing-plans" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Subscription Plans</h2>
                            <p>Bundle products into pricing tiers</p>
                        </div>
                        <button class="btn" onclick="openPlanModal()">+ Add Plan</button>
                    </div>
                </div>

                <div id="billing-plans-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 2rem; color: #64748b;">
                        Loading plans...
                    </div>
                </div>
            </div>

            <!-- Billing Products View -->
            <div id="billing-products" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Products</h2>
                            <p>Individual sellable items - templates, plugins, apps</p>
                        </div>
                        <button class="btn" onclick="openProductModal()">+ Add Product</button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Monthly</th>
                                    <th>Yearly</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billing-products-table">
                                <tr><td colspan="6" style="text-align: center; color: #64748b;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Billing Add-ons View -->
            <div id="billing-addons" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Add-ons</h2>
                            <p>Extra items customers can add to their subscription</p>
                        </div>
                        <button class="btn" onclick="openAddonModal()">+ Add Add-on</button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Add-on</th>
                                    <th>Monthly Price</th>
                                    <th>Extra Properties</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billing-addons-table">
                                <tr><td colspan="5" style="text-align: center; color: #64748b;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Billing Subscribers View -->
            <div id="billing-subscribers" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Subscribers</h2>
                            <p>Accounts with active subscriptions</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="subscribers-filter-plan" class="form-input" style="width: auto;" onchange="loadSubscribers()">
                                <option value="">All Plans</option>
                            </select>
                            <select id="subscribers-filter-status" class="form-input" style="width: auto;" onchange="loadSubscribers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="trialing">Trialing</option>
                                <option value="past_due">Past Due</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Plan</th>
                                    <th>Add-ons</th>
                                    <th>MRR</th>
                                    <th>Status</th>
                                    <th>Since</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billing-subscribers-table">
                                <tr><td colspan="7" style="text-align: center; color: #64748b;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Affiliates Admin View -->
            <div id="billing-affiliates" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Affiliate Program</h2>
                            <p>Manage affiliate tiers and referral partners</p>
                        </div>
                    </div>
                </div>

                <!-- Tier Cards -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="text-align: center; border-top: 4px solid #CD7F32;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <h3 style="margin: 0;">Bronze</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #CD7F32; margin: 0.5rem 0;">5%</div>
                        <p style="font-size: 0.85rem; color: #64748b; margin: 0;">Default tier</p>
                    </div>
                    <div class="card" style="text-align: center; border-top: 4px solid #C0C0C0;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <h3 style="margin: 0;">Silver</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #71717a; margin: 0.5rem 0;">10%</div>
                        <p style="font-size: 0.85rem; color: #64748b; margin: 0;">5+ active referrals</p>
                    </div>
                    <div class="card" style="text-align: center; border-top: 4px solid #FFD700;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                        <h3 style="margin: 0;">Gold</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #ca8a04; margin: 0.5rem 0;">15%</div>
                        <p style="font-size: 0.85rem; color: #64748b; margin: 0;">10+ referrals OR 500+/mo</p>
                    </div>
                </div>

                <!-- Stats Summary -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 700;" id="affiliate-total-count">0</div>
                            <div style="color: #64748b; font-size: 0.9rem;">Total Affiliates</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="affiliate-active-referrals">0</div>
                            <div style="color: #64748b; font-size: 0.9rem;">Active Referrals</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="affiliate-monthly-commission">0</div>
                            <div style="color: #64748b; font-size: 0.9rem;">This Month's Commission</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="affiliate-pending-payouts">0</div>
                            <div style="color: #64748b; font-size: 0.9rem;">Pending Payouts</div>
                        </div>
                    </div>
                </div>

                <!-- Affiliates Table -->
                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Affiliate</th>
                                    <th>Tier</th>
                                    <th>Referral Code</th>
                                    <th>Active Referrals</th>
                                    <th>Lifetime Earnings</th>
                                    <th>Pending</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billing-affiliates-table">
                                <tr><td colspan="7" style="text-align: center; color: #64748b;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- My Referrals View (User's Affiliate Dashboard) -->
            <div id="my-referrals" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> My Referrals</h2>
                            <p>Earn commission by referring properties to GAS</p>
                        </div>
                    </div>
                </div>

                <!-- Not an affiliate yet -->
                <div id="affiliate-signup-card" class="card" style="text-align: center; padding: 3rem; display: none;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                    <h2 style="margin: 0 0 1rem 0;">Join the GAS Affiliate Program</h2>
                    <p style="color: #64748b; margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto;">
                        Earn up to 15% commission on every subscription from properties you refer. 
                        Start at Bronze (5%) and level up as you grow!
                    </p>
                    <button class="btn" onclick="joinAffiliateProgram()" style="font-size: 1.1rem; padding: 0.75rem 2rem;">
                         Join Now - It's Free
                    </button>
                </div>

                <!-- Affiliate Dashboard -->
                <div id="affiliate-dashboard" style="display: none;">
                    <!-- My Stats -->
                    <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span id="my-tier-icon" style="font-size: 2rem;"></span>
                                    <span id="my-tier-name" style="font-size: 1.5rem; font-weight: 700;">Bronze</span>
                                </div>
                                <p style="margin: 0; color: #92400e;">
                                    You earn <strong id="my-commission-rate">5%</strong> on all referral subscriptions
                                </p>
                            </div>
                            <div id="tier-progress" style="text-align: right;">
                                <p style="margin: 0; font-size: 0.9rem; color: #92400e;">
                                    <span id="referrals-to-next">5</span> more referrals to reach Silver!
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Referral Link -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0;"> Your Referral Link</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="my-referral-link" class="form-input" readonly style="flex: 1; font-family: monospace;">
                            <button class="btn" onclick="copyReferralLink()"> Copy</button>
                        </div>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #64748b;">
                            Share this link with properties. When they sign up and subscribe, you earn commission!
                        </p>
                    </div>

                    <!-- My Earnings -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 0.5rem;">This Month</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="my-earnings-month">0.00</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 0.5rem;">Pending Payout</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="my-earnings-pending">0.00</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 0.5rem;">Lifetime Earnings</div>
                            <div style="font-size: 2rem; font-weight: 700;" id="my-earnings-lifetime">0.00</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 0.9rem; color: #64748b; margin-bottom: 0.5rem;">Active Referrals</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="my-referral-count">0</div>
                        </div>
                    </div>

                    <!-- Request Payout -->
                    <div class="card" style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h4 style="margin: 0;">Ready to cash out?</h4>
                            <p style="margin: 0.25rem 0 0 0; color: #64748b; font-size: 0.9rem;">
                                Minimum payout: 50  Payouts processed weekly via Airwallex
                            </p>
                        </div>
                        <button class="btn" id="request-payout-btn" onclick="requestPayout()" disabled style="background: var(--success);">
                             Request Payout
                        </button>
                    </div>

                    <!-- My Referrals List -->
                    <div class="card">
                        <h3 style="margin: 0 0 1rem 0;"> My Referrals</h3>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Signed Up</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Your Earnings</th>
                                    </tr>
                                </thead>
                                <tbody id="my-referrals-table">
                                    <tr><td colspan="5" style="text-align: center; color: #64748b;">No referrals yet. Share your link to get started!</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Billing (Client View) -->
            <div id="my-billing" class="view">
                <div class="header">
                    <h2> Plans & Extras</h2>
                    <p>Subscribe to a plan or purchase extras</p>
                </div>

                <!-- Subscription Plans -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem;"> Subscription Plans</h3>
                    <div id="my-billing-plans" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <p style="color: #64748b;">Loading plans...</p>
                    </div>
                </div>

                <!-- Buy Credits -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem;"> Credit Packages</h3>
                    <p style="color: #64748b; margin-bottom: 1rem;">Buy credits to spend on extras and services</p>
                    <div id="my-billing-credits" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                        <p style="color: #64748b;">Loading credit packages...</p>
                    </div>
                </div>

                <!-- Extras Shop -->
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem;"> Extras & Services</h3>
                    <p style="color: #64748b; margin-bottom: 1rem;">Services you can purchase with credits</p>
                    <div id="my-billing-extras" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <p style="color: #64748b;">Loading extras...</p>
                    </div>
                </div>
            </div>

            <!-- GasSync Dashboard View -->
            <div id="gas-sync-dashboard" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Channel Manager Sync Dashboard</h2>
                            <p>Overview of all channel manager integrations and sync status</p>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid" id="gasSyncStats">
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon"></span></div>
                        <div class="stat-value" id="syncStatConnections">-</div>
                        <div class="stat-label">Active Connections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon"></span></div>
                        <div class="stat-value" id="syncStatProperties">-</div>
                        <div class="stat-label">Synced Properties</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon"></span></div>
                        <div class="stat-value" id="syncStatRoomTypes">-</div>
                        <div class="stat-label">Room Types</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon"></span></div>
                        <div class="stat-value" id="syncStatReservations">-</div>
                        <div class="stat-label">Active Reservations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon"></span></div>
                        <div class="stat-value" id="syncStatImages">-</div>
                        <div class="stat-label">Images Synced</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon"></span></div>
                        <div class="stat-value" id="syncStatErrors">-</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;"> Connection Status</h3>
                    <div id="connectionStatusList">
                        <p style="color: #64748b;">Loading connections...</p>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;"> Recent Sync Activity</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Adapter</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Records</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                                <tr><td colspan="6" style="text-align:center; color: #64748b;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- GasSync Connections View -->
            <div id="gas-sync-connections" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Channel Manager Connections</h2>
                            <p>Manage your channel manager integrations</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="showAddConnectionModal()">
                                <span></span> Add Connection
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="connectionsGrid" class="connections-grid">
                    <p style="color: #64748b;">Loading connections...</p>
                </div>
            </div>

            <!-- GasSync Properties View -->
            <div id="gas-sync-properties" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Synced Properties</h2>
                            <p>Properties synchronized from channel managers</p>
                        </div>
                        <div class="header-actions" style="display: flex; gap: 1rem; align-items: center;">
                            <input type="text" id="syncPropertiesSearch" class="form-input" placeholder="Search properties..." style="width: 250px;" oninput="filterSyncedProperties()">
                            <select id="syncPropertiesConnectionFilter" class="form-control" style="width: 200px;" onchange="loadSyncedProperties()">
                                <option value="">All Connections</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">Status</th>
                                    <th>Property</th>
                                    <th>Location</th>
                                    <th>Rooms</th>
                                    <th>Last Sync</th>
                                </tr>
                            </thead>
                            <tbody id="syncedPropertiesTable">
                                <tr><td colspan="5" style="text-align:center; color: #64748b;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- GasSync Logs View -->
            <div id="gas-sync-logs" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2> Sync Logs</h2>
                            <p>History of synchronization operations</p>
                        </div>
                        <div class="header-actions">
                            <select id="syncLogsConnectionFilter" class="form-control" style="width: 200px;" onchange="loadSyncLogs()">
                                <option value="">All Connections</option>
                            </select>
                            <select id="syncLogsStatusFilter" class="form-control" style="width: 150px;" onchange="loadSyncLogs()">
                                <option value="">All Status</option>
                                <option value="success">Success</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Connection</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Updated</th>
                                    <th>Failed</th>
                                    <th>Duration</th>
                                    <th>Error</th>
                                </tr>
                            </thead>
                            <tbody id="syncLogsTable">
                                <tr><td colspan="9" style="text-align:center; color: #64748b;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- GasSync Add Connection Modal -->
    <div id="addConnectionModal" class="modal" onclick="if(event.target === this) closeModal('addConnectionModal')">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;"> Add Channel Manager Connection</h3>
                <button onclick="closeModal('addConnectionModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; cursor: pointer; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; line-height: 1;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Step 1: Select Adapter -->
                <div id="connectionStep1">
                    <h4 style="margin-bottom: 15px;">Select Channel Manager</h4>
                    <div id="adapterGrid" class="adapter-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Step 2: Enter Credentials -->
                <div id="connectionStep2" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-secondary btn-sm" onclick="showConnectionStep(1)"> Back</button>
                        <h4 id="selectedAdapterName" style="margin: 0;">Configure Connection</h4>
                    </div>
                    
                    <form id="connectionCredentialsForm">
                        <input type="hidden" id="selectedAdapterCode">
                        
                        <div id="credentialFields"></div>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Account</label>
                            <select id="connectionAccountId" class="form-control" required></select>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="connectionSyncEnabled" checked>
                                Enable automatic sync
                            </label>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Sync Interval</label>
                            <select id="connectionSyncInterval" class="form-control">
                                <option value="5">Every 5 minutes</option>
                                <option value="15" selected>Every 15 minutes</option>
                                <option value="30">Every 30 minutes</option>
                                <option value="60">Every hour</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addConnectionModal')">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="testAndSaveConnection()">
                                 Test & Connect
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- GasSync Connection Details Modal -->
    <div id="connectionDetailsModal" class="modal" onclick="if(event.target === this) closeModal('connectionDetailsModal')">
        <div class="modal-content" style="max-width: 1600px; width: 98%; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <h3 id="connectionDetailsTitle" style="margin: 0;">Connection Details</h3>
                <button onclick="closeModal('connectionDetailsModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; cursor: pointer; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; line-height: 1;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="gas-sync-tabs">
                    <button class="gas-sync-tab active" onclick="showConnectionTab('overview')">Overview</button>
                    <button class="gas-sync-tab" onclick="showConnectionTab('properties')">Properties</button>
                    <button class="gas-sync-tab" onclick="showConnectionTab('propertyCheck')">Property Check</button>
                    <button class="gas-sync-tab" onclick="showConnectionTab('reservations')">Reservations</button>
                    <button class="gas-sync-tab" onclick="showConnectionTab('reviews')">Reviews</button>
                    <button class="gas-sync-tab" onclick="showConnectionTab('settings')">Settings</button>
                </div>
                
                <div style="padding: 1.5rem;">
                    <div id="connectionTabOverview" class="gas-sync-tab-content">Loading...</div>
                    <div id="connectionTabProperties" class="gas-sync-tab-content" style="display:none;">Loading...</div>
                    <div id="connectionTabPropertyCheck" class="gas-sync-tab-content" style="display:none;">Loading...</div>
                    <div id="connectionTabReservations" class="gas-sync-tab-content" style="display:none;">Loading...</div>
                    <div id="connectionTabReviews" class="gas-sync-tab-content" style="display:none;">Loading...</div>
                    <div id="connectionTabSettings" class="gas-sync-tab-content" style="display:none;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Knowledge Base Article Modal -->
    <div id="kbArticleModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="kb-article-modal-title" style="margin: 0; font-size: 1.25rem;"> Add Knowledge Article</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Add content the AI can use to answer questions</p>
                </div>
                <button class="modal-close" onclick="closeModal('kbArticleModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="kb-article-form" onsubmit="saveKBArticle(event)">
                    <input type="hidden" id="kb-article-id">
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Title <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="kb-article-title" class="form-input" required placeholder="e.g., How to connect Beds24">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="kb-article-category" class="form-input">
                                <option value="">Select category...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Summary</label>
                        <textarea id="kb-article-summary" class="form-input" rows="2" placeholder="Brief summary shown in search results..."></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Content <span style="color: #ef4444;">*</span></label>
                        <textarea id="kb-article-content" class="form-input" rows="12" required placeholder="Full article content. The AI will use this to answer questions. Use markdown formatting."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Keywords (comma-separated)</label>
                            <input type="text" id="kb-article-keywords" class="form-input" placeholder="beds24, api, connect, invite code">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="kb-article-status" class="form-input">
                                <option value="published">Published</option>
                                <option value="draft">Draft</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('kbArticleModal')">Cancel</button>
                        <button type="submit" class="btn">ðŸ’¾ Save Article</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Knowledge Base Import Modal -->
    <div id="kbImportModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;"> Import Articles</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Bulk import articles from JSON</p>
                </div>
                <button class="modal-close" onclick="closeModal('kbImportModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #166534;">JSON Format</h4>
                    <pre style="margin: 0; font-size: 0.8rem; color: #166534; overflow-x: auto;">[
  {
    "title": "Article Title",
    "category": "getting-started",
    "summary": "Brief summary",
    "content": "Full content here...",
    "keywords": ["keyword1", "keyword2"]
  }
]</pre>
                </div>
                
                <div class="form-group">
                    <label>Paste JSON Array</label>
                    <textarea id="kb-import-json" class="form-input" rows="10" placeholder="Paste your JSON array of articles here..."></textarea>
                </div>
                
                <div id="kb-import-result" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 8px;"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('kbImportModal')">Cancel</button>
                    <button type="button" class="btn" onclick="importKBArticles()">Import Articles</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Billing Plan Modal -->
    <div id="billingPlanModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="plan-modal-title" style="margin: 0; font-size: 1.25rem;"> Add Subscription Plan</h3>
                </div>
                <button class="modal-close" onclick="closeModal('billingPlanModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="plan-form" onsubmit="savePlan(event)">
                    <input type="hidden" id="plan-id">
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Plan Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="plan-name" class="form-input" required placeholder="e.g., Professional">
                        </div>
                        <div class="form-group">
                            <label>Slug</label>
                            <input type="text" id="plan-slug" class="form-input" placeholder="professional">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <input type="text" id="plan-description" class="form-input" placeholder="For growing businesses">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Monthly Price <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="plan-price-monthly" class="form-input" required step="0.01" placeholder="59.00">
                        </div>
                        <div class="form-group">
                            <label>Yearly Price</label>
                            <input type="number" id="plan-price-yearly" class="form-input" step="0.01" placeholder="590.00">
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <select id="plan-currency" class="form-input">
                                <option value="GBP"> GBP</option>
                                <option value="EUR"> EUR</option>
                                <option value="USD">$ USD</option>
                                <option value="CHF">CHF</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Max Properties</label>
                            <input type="number" id="plan-max-properties" class="form-input" placeholder="Leave empty for unlimited">
                        </div>
                        <div class="form-group">
                            <label>Sort Order</label>
                            <input type="number" id="plan-sort-order" class="form-input" value="0">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Features (one per line)</label>
                        <textarea id="plan-features" class="form-input" rows="4" placeholder="Up to 5 properties&#10;All features&#10;Priority support"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="plan-is-active" checked>
                            Active (visible to customers)
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('billingPlanModal')">Cancel</button>
                        <button type="submit" class="btn">ðŸ’¾ Save Plan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assign Plan Modal -->
    <div id="assignPlanModal" class="modal">
        <div class="modal-content" style="max-width: 450px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;"> Assign Subscription Plan</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;">For: <span id="assign-plan-account-name"></span></p>
                </div>
                <button class="modal-close" onclick="closeModal('assignPlanModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="assign-plan-current" style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; display: none;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Select Plan</label>
                    <select id="assign-plan-select" class="form-input">
                        <option value="">-- Select Plan --</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Billing Cycle</label>
                    <select id="assign-plan-cycle" class="form-input">
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly (save ~17%)</option>
                    </select>
                </div>
                
                <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.75rem; color: var(--text-primary);"> Feature Overrides</div>
                    <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.75rem;">Enable features not included in the plan</p>
                    
                    <div style="display: grid; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="assign-plan-api-access" style="width: 18px; height: 18px;">
                            <span> API Access</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="assign-plan-blog-module" style="width: 18px; height: 18px;">
                            <span> Blog Module</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="assign-plan-attractions-module" style="width: 18px; height: 18px;">
                            <span> Attractions Module</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="assign-plan-reviews-widget" style="width: 18px; height: 18px;">
                            <span> Reviews Widget</span>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                    <button type="button" class="btn btn-secondary" style="color: #ef4444;" onclick="cancelAccountSubscription()">Cancel Subscription</button>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('assignPlanModal')">Close</button>
                        <button type="button" class="btn" onclick="saveAssignedPlan()">Assign Plan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Website Modal -->
    <div id="createWebsiteModal" class="modal">
        <div class="modal-content" style="max-width: 500px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;"> Create WordPress Website</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;">For: <span id="create-website-account-name"></span></p>
                </div>
                <button class="modal-close" onclick="closeModal('createWebsiteModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0; font-size: 0.9rem;"> A new WordPress site will be created with:</p>
                    <ul style="margin: 0.5rem 0 0 1.25rem; font-size: 0.85rem; color: #64748b;">
                        <li>GAS Booking Plugin pre-installed</li>
                        <li>Theme configured for your property</li>
                        <li>API connection set up automatically</li>
                    </ul>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Site Name</label>
                    <input type="text" id="create-website-name" class="form-input" placeholder="e.g., lehmannhouse">
                    <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                        Will be: <strong><span id="create-website-preview">yoursite</span>.vps.site</strong>
                    </p>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Template (Optional)</label>
                    <select id="create-website-template" class="form-input">
                        <option value="">Use default for plan</option>
                        <option value="gas-starter">GAS Starter</option>
                        <option value="gas-professional">GAS Professional</option>
                        <option value="gas-business">GAS Business</option>
                        <option value="gas-enterprise">GAS Enterprise</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createWebsiteModal')">Cancel</button>
                    <button type="button" class="btn" onclick="createWebsite()" id="create-website-btn">
                         Create Website
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Package Modal -->
    <div id="creditPackageModal" class="modal">
        <div class="modal-content" style="max-width: 500px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="credit-package-modal-title" style="margin: 0; font-size: 1.25rem;"> Add Credit Package</h3>
                </div>
                <button class="modal-close" onclick="closeModal('creditPackageModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="credit-package-form" onsubmit="saveCreditPackage(event)">
                    <input type="hidden" id="credit-package-id">
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Package Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="credit-package-name" class="form-input" required placeholder="e.g., 50 Credits">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Credits <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="credit-package-credits" class="form-input" required placeholder="50">
                        </div>
                        <div class="form-group">
                            <label>Bonus Credits</label>
                            <input type="number" id="credit-package-bonus" class="form-input" value="0" placeholder="0">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Price <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="credit-package-price" class="form-input" required step="0.01" placeholder="40.00">
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <select id="credit-package-currency" class="form-input">
                                <option value="GBP"> GBP</option>
                                <option value="EUR"> EUR</option>
                                <option value="USD">$ USD</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="credit-package-is-active" checked>
                            Active (available for purchase)
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('creditPackageModal')">Cancel</button>
                        <button type="submit" class="btn">ðŸ’¾ Save Package</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Extras Modal -->
    <div id="extraModal" class="modal">
        <div class="modal-content" style="max-width: 550px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="extra-modal-title" style="margin: 0; font-size: 1.25rem;"> Add Extra Service</h3>
                </div>
                <button class="modal-close" onclick="closeModal('extraModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="extra-form" onsubmit="saveExtra(event)">
                    <input type="hidden" id="extra-id">
                    
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="extra-name" class="form-input" required placeholder="e.g., Setup Assistance Call">
                        </div>
                        <div class="form-group">
                            <label>Icon</label>
                            <input type="text" id="extra-icon" class="form-input" placeholder="">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <textarea id="extra-description" class="form-input" rows="2" placeholder="What does the customer get?"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Credit Cost <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="extra-credit-cost" class="form-input" required placeholder="5">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" id="extra-category" class="form-input" placeholder="Support">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="extra-is-active" checked>
                            Active (available in shop)
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('extraModal')">Cancel</button>
                        <button type="submit" class="btn">ðŸ’¾ Save Extra</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="product-modal-title" style="margin: 0; font-size: 1.25rem;"> Add Product</h3>
                </div>
                <button class="modal-close" onclick="closeModal('productModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="product-form" onsubmit="saveProduct(event)">
                    <input type="hidden" id="product-id">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Product Code <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="product-code" class="form-input" required placeholder="e.g., wp-theme-developer">
                            <small style="color: #64748b;">Unique identifier (lowercase, hyphens)</small>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="product-category" class="form-input">
                                <option value="template">Template</option>
                                <option value="plugin">Plugin</option>
                                <option value="app">App</option>
                                <option value="service">Service</option>
                                <option value="addon">Add-on</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Product Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="product-name" class="form-input" required placeholder="e.g., Developer Theme">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <textarea id="product-description" class="form-input" rows="2" placeholder="Professional WordPress theme for hotels & B&Bs"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Monthly Price ()</label>
                            <input type="number" id="product-price-monthly" class="form-input" step="0.01" placeholder="15.00">
                        </div>
                        <div class="form-group">
                            <label>Yearly Price ()</label>
                            <input type="number" id="product-price-yearly" class="form-input" step="0.01" placeholder="150.00">
                            <small style="color: #64748b;">Usually 10 months (2 months free)</small>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="product-is-active" checked style="width: 18px; height: 18px;">
                            <span>Active (visible to customers)</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('productModal')">Cancel</button>
                        <button type="submit" class="btn">ðŸ’¾ Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add-on Modal -->
    <div id="addonModal" class="modal">
        <div class="modal-content" style="max-width: 550px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="addon-modal-title" style="margin: 0; font-size: 1.25rem;"> Add Add-on</h3>
                </div>
                <button class="modal-close" onclick="closeModal('addonModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="addon-form" onsubmit="saveAddon(event)">
                    <input type="hidden" id="addon-id">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Add-on Code <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="addon-code" class="form-input" required placeholder="e.g., extra-property">
                        </div>
                        <div class="form-group">
                            <label>Monthly Price () <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="addon-price-monthly" class="form-input" required step="0.01" placeholder="5.00">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Add-on Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="addon-name" class="form-input" required placeholder="e.g., Extra Property">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <input type="text" id="addon-description" class="form-input" placeholder="Add one additional property to your account">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Extra Properties Included</label>
                        <input type="number" id="addon-extra-properties" class="form-input" value="0" min="0" placeholder="0">
                        <small style="color: #64748b;">How many extra properties this add-on provides</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="addon-is-active" checked style="width: 18px; height: 18px;">
                            <span>Active (available for purchase)</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addonModal')">Cancel</button>
                        <button type="submit" class="btn">ðŸ’¾ Save Add-on</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="task-modal-title" style="margin: 0; font-size: 1.25rem;"> Add Task</h3>
                </div>
                <button class="modal-close" onclick="closeModal('taskModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="task-form" onsubmit="saveTask(event)">
                    <input type="hidden" id="task-id">
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Task Title <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="task-title" class="form-input" required placeholder="What needs to be done?">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <textarea id="task-description" class="form-input" rows="3" placeholder="Details about the task..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Priority <span style="color: #ef4444;">*</span></label>
                            <select id="task-priority" class="form-input" required>
                                <option value="critical"> Critical</option>
                                <option value="urgent"> Urgent</option>
                                <option value="high" selected> High</option>
                                <option value="medium"> Medium</option>
                                <option value="low"> Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category <span style="color: #ef4444;">*</span></label>
                            <select id="task-category" class="form-input" required>
                                <option value="critical"> Critical - Must Work</option>
                                <option value="billing"> Billing & Payments</option>
                                <option value="booking-flow"> Booking Flow</option>
                                <option value="ui"> UI/UX</option>
                                <option value="website-builder"> Website Builder</option>
                                <option value="apps"> Apps</option>
                                <option value="integrations"> Integrations</option>
                                <option value="wordpress"> WordPress</option>
                                <option value="bugs"> Bug Fixes</option>
                                <option value="ideas"> Ideas</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Status</label>
                        <select id="task-status" class="form-input">
                            <option value="todo"> To Do</option>
                            <option value="in_progress"> In Progress</option>
                            <option value="done"> Done</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Notes (optional)</label>
                        <input type="text" id="task-notes" class="form-input" placeholder="Any additional notes...">
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <button type="button" class="btn" id="task-delete-btn" style="background: #ef4444; display: none;" onclick="deleteTaskFromModal()"> Delete</button>
                        <div style="display: flex; gap: 1rem; margin-left: auto;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
                            <button type="submit" class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">ðŸ’¾ Save Task</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Blog Ideas Wizard Modal -->
    <div id="blog-ideas-wizard" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 style="margin: 0; color: white;"> Get Blog Ideas</h3>
                <button class="modal-close" onclick="closeBlogIdeasWizard()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Step 1: Property -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" style="font-weight: 600; font-size: 1rem;">Step 1: Select Property <span style="color: #ef4444;">*</span></label>
                    <select id="blog-wizard-property" class="form-input" style="width: 100%;" onchange="updateBlogWizardSubcategories()">
                        <option value="">Choose a property...</option>
                    </select>
                </div>
                
                <!-- Step 2: Category -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" style="font-weight: 600; font-size: 1rem;">Step 2: Blog Category <span style="color: #ef4444;">*</span></label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <label class="wizard-option" onclick="selectBlogCategory('attractions')" style="display: flex; align-items: center; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer;">
                            <input type="radio" name="blog-category" value="attractions" style="margin-right: 0.75rem;">
                            <div>
                                <div style="font-size: 1.25rem;"></div>
                                <div style="font-weight: 600;">Attractions & Places</div>
                            </div>
                        </label>
                        <label class="wizard-option" onclick="selectBlogCategory('events')" style="display: flex; align-items: center; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer;">
                            <input type="radio" name="blog-category" value="events" style="margin-right: 0.75rem;">
                            <div>
                                <div style="font-size: 1.25rem;"></div>
                                <div style="font-weight: 600;">Events & What's On</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Step 3: Subcategory -->
                <div id="blog-wizard-subcategory-section" class="form-group" style="margin-bottom: 1.5rem; display: none;">
                    <label class="form-label" style="font-weight: 600; font-size: 1rem;">Step 3: Specific Topic <span style="color: #ef4444;">*</span></label>
                    <select id="blog-wizard-subcategory" class="form-input" style="width: 100%;">
                        <option value="">Choose a topic...</option>
                    </select>
                </div>
                
                <!-- What You'll Get -->
                <div id="blog-wizard-preview" style="display: none; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #86efac; border-radius: 12px; padding: 1rem;">
                    <h4 style="margin: 0 0 0.5rem; color: #166534;"> What You'll Get:</h4>
                    <ul style="margin: 0; padding-left: 1.25rem; font-size: 0.875rem; color: #15803d;">
                        <li>5 blog post title ideas</li>
                        <li>Location-specific recommendations</li>
                        <li>Click any idea to generate full article</li>
                        <li>Meta tags + FAQ Schema included</li>
                    </ul>
                </div>
                
                <!-- Loading State -->
                <div id="blog-wizard-loading" style="display: none; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                    <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">Thinking, please wait...</div>
                    <div style="color: #6b7280;">AI is finding great blog topics for your property</div>
                    <div style="margin-top: 1rem; width: 200px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-left: auto; margin-right: auto; overflow: hidden;">
                        <div style="width: 30%; height: 100%; background: linear-gradient(90deg, #8b5cf6, #7c3aed); border-radius: 2px; animation: loading-bar 1.5s infinite;"></div>
                    </div>
                </div>
                
                <!-- Results -->
                <div id="blog-wizard-results" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0;"> Blog Ideas</h4>
                        <button class="btn btn-small btn-secondary" onclick="resetBlogWizard()"> Back</button>
                    </div>
                    <div id="blog-wizard-ideas-list"></div>
                </div>
            </div>
            <div class="modal-footer" id="blog-wizard-footer" style="display: flex; justify-content: flex-end; gap: 0.5rem; padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb;">
                <button class="btn btn-secondary" onclick="closeBlogIdeasWizard()">Cancel</button>
                <button class="btn" id="blog-wizard-generate-btn" onclick="generateBlogIdeas()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);" disabled>
                     Generate Ideas
                </button>
            </div>
        </div>
    </div>
    
    <!-- iCal Feeds Modal -->
    <div id="ical-feeds-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 style="margin: 0; color: white;">ðŸ“… iCal Event Feeds</h3>
                <button class="modal-close" onclick="closeModal('ical-feeds-modal')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p style="color: #6b7280; margin-bottom: 1rem;">Add iCal feeds from local event calendars to generate blog ideas about upcoming events in your area.</p>
                
                <!-- Property selector -->
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Property</label>
                    <select id="ical-property-select" class="form-input" style="width: 100%;">
                        <option value="">All Properties</option>
                    </select>
                </div>
                
                <!-- Add new feed -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="text" id="new-ical-url" class="form-input" placeholder="Paste iCal URL (.ics)" style="flex: 1;">
                    <input type="text" id="new-ical-name" class="form-input" placeholder="Feed name" style="width: 150px;">
                    <button class="btn btn-primary" onclick="addIcalFeed()">Add</button>
                </div>
                
                <!-- Existing feeds list -->
                <div id="ical-feeds-list" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #9ca3af; text-align: center; padding: 2rem;">Loading feeds...</p>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb;">
                <button class="btn btn-secondary" onclick="closeModal('ical-feeds-modal')">Close</button>
                <button class="btn" onclick="fetchIcalEvents()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">ðŸ”„ Fetch Events</button>
            </div>
        </div>
    </div>
    
    <!-- RSS Feeds Modal -->
    <div id="rss-feeds-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 style="margin: 0; color: white;">ðŸ“° RSS News Feeds</h3>
                <button class="modal-close" onclick="closeModal('rss-feeds-modal')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p style="color: #6b7280; margin-bottom: 1rem;">Add RSS feeds from local news sources, tourism boards, or event sites to inspire blog content.</p>
                
                <!-- Property selector -->
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Property</label>
                    <select id="rss-property-select" class="form-input" style="width: 100%;">
                        <option value="">All Properties</option>
                    </select>
                </div>
                
                <!-- Add new feed -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="text" id="new-rss-url" class="form-input" placeholder="Paste RSS feed URL" style="flex: 1;">
                    <input type="text" id="new-rss-name" class="form-input" placeholder="Feed name" style="width: 150px;">
                    <button class="btn btn-primary" onclick="addRssFeed()">Add</button>
                </div>
                
                <!-- Existing feeds list -->
                <div id="rss-feeds-list" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #9ca3af; text-align: center; padding: 2rem;">Loading feeds...</p>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb;">
                <button class="btn btn-secondary" onclick="closeModal('rss-feeds-modal')">Close</button>
                <button class="btn" onclick="fetchRssArticles()" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">ðŸ”„ Fetch Articles</button>
            </div>
        </div>
    </div>
    
    <!-- Attraction Ideas Wizard Modal -->
    <div id="attraction-ideas-wizard" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 style="margin: 0; color: white;"> Suggest Local Places</h3>
                <button class="modal-close" onclick="closeAttractionIdeasWizard()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Step 1: Property -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" style="font-weight: 600; font-size: 1rem;">Step 1: Select Property <span style="color: #ef4444;">*</span></label>
                    <select id="attraction-wizard-property" class="form-input" style="width: 100%;">
                        <option value="">Choose a property...</option>
                    </select>
                </div>
                
                <!-- Step 2: Category -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label" style="font-weight: 600; font-size: 1rem;">Step 2: What type of places? <span style="color: #ef4444;">*</span></label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem;">
                        <label class="wizard-option-small" onclick="selectAttractionCategory('museums')">
                            <input type="radio" name="attraction-category" value="museums" style="display: none;">
                            <span> Museums</span>
                        </label>
                        <label class="wizard-option-small" onclick="selectAttractionCategory('landmarks')">
                            <input type="radio" name="attraction-category" value="landmarks" style="display: none;">
                            <span> Landmarks</span>
                        </label>
                        <label class="wizard-option-small" onclick="selectAttractionCategory('parks')">
                            <input type="radio" name="attraction-category" value="parks" style="display: none;">
                            <span> Parks</span>
                        </label>
                        <label class="wizard-option-small" onclick="selectAttractionCategory('beaches')">
                            <input type="radio" name="attraction-category" value="beaches" style="display: none;">
                            <span> Beaches</span>
                        </label>
                        <label class="wizard-option-small" onclick="selectAttractionCategory('restaurants')">
                            <input type="radio" name="attraction-category" value="restaurants" style="display: none;">
                            <span> Restaurants</span>
                        </label>
                        <label class="wizard-option-small" onclick="selectAttractionCategory('cafes')">
                            <input type="radio" name="attraction-category" value="cafes" style="display: none;">
                            <span> Cafes</span>
                        </label>
                        <label class="wizard-option-small" onclick="selectAttractionCategory('nightlife')">
                            <input type="radio" name="attraction-category" value="nightlife" style="display: none;">
                            <span> Nightlife</span>
                        </label>
                        <label class="wizard-option-small" onclick="selectAttractionCategory('shopping')">
                            <input type="radio" name="attraction-category" value="shopping" style="display: none;">
                            <span> Shopping</span>
                        </label>
                        <label class="wizard-option-small" onclick="selectAttractionCategory('nature')">
                            <input type="radio" name="attraction-category" value="nature" style="display: none;">
                            <span> Nature</span>
                        </label>
                        <label class="wizard-option-small" onclick="selectAttractionCategory('family')">
                            <input type="radio" name="attraction-category" value="family" style="display: none;">
                            <span> Family</span>
                        </label>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="attraction-wizard-loading" style="display: none; text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                    <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">Thinking, please wait...</div>
                    <div style="color: #6b7280;">AI is finding local attractions nearby</div>
                    <div style="margin-top: 1rem; width: 200px; height: 4px; background: #e5e7eb; border-radius: 2px; margin-left: auto; margin-right: auto; overflow: hidden;">
                        <div style="width: 30%; height: 100%; background: linear-gradient(90deg, #f59e0b, #d97706); border-radius: 2px; animation: loading-bar 1.5s infinite;"></div>
                    </div>
                </div>
                
                <!-- Results -->
                <div id="attraction-wizard-results" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0;"> Suggested Places</h4>
                        <button class="btn btn-small btn-secondary" onclick="resetAttractionWizard()"> Back</button>
                    </div>
                    <div id="attraction-wizard-ideas-list"></div>
                </div>
            </div>
            <div class="modal-footer" id="attraction-wizard-footer" style="display: flex; justify-content: flex-end; gap: 0.5rem; padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb;">
                <button class="btn btn-secondary" onclick="closeAttractionIdeasWizard()">Cancel</button>
                <button class="btn" id="attraction-wizard-generate-btn" onclick="generateAttractionIdeas()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" disabled>
                     Find Places
                </button>
            </div>
        </div>
    </div>
    
    <style>
        .wizard-option-small {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .wizard-option-small:hover {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        .wizard-option-small.selected {
            border-color: #f59e0b;
            background: #fef3c7;
        }
        .wizard-option.selected {
            border-color: #8b5cf6;
            background: #ede9fe;
        }
        @keyframes loading-bar {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
    </style>


    <!-- Deploy Site Modal -->
    <div id="deployModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="deploy-modal-title" style="margin: 0; font-size: 1.25rem;"> Create New Website</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Select which rooms to display on this site</p>
                </div>
                <button class="modal-close" onclick="closeModal('deployModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <form id="deployForm" onsubmit="deployNewSite(event)" style="padding: 1.5rem;">
                
                <!-- Site Details -->
                <div id="site-details-fields" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label>Site Name *</label>
                        <input type="text" id="deploy-site-name" class="form-input" placeholder="e.g. Elevate Stays">
                    </div>
                    <div class="form-group">
                        <label>URL Slug *</label>
                        <div style="display: flex; align-items: center; gap: 0;">
                            <span style="background: #f1f5f9; padding: 0.5rem 0.5rem; border: 1px solid var(--border); border-right: none; border-radius: 8px 0 0 8px; color: #64748b; font-size: 0.8rem; white-space: nowrap;">sites.gas.travel/</span>
                            <input type="text" id="deploy-slug" class="form-input" style="border-radius: 0 8px 8px 0; flex: 1;" placeholder="elevate" pattern="[a-z0-9-]+">
                        </div>
                    </div>
                </div>
                
                <div id="admin-email-field" class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Admin Email *</label>
                    <input type="email" id="deploy-admin-email" class="form-input" placeholder="admin@example.com" required>
                </div>
                
                <!-- Template Selection -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">Select Product Type *</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; min-height: 220px;">
                        <!-- Instant Website - Opens Template Modal -->
                        <div class="template-option" onclick="openTemplateSelectionModal()" style="cursor: pointer; border: 2px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; display: flex; flex-direction: column;" id="instant-website-btn">
                            <input type="radio" name="deploy-template" value="developer-light" id="deploy-template-instant" style="display: none;">
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 2rem; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸŒ</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: white; margin-bottom: 0.25rem;">Instant Website</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.9); margin-bottom: 0.75rem;">Get a complete booking website in minutes</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: #fef3c7;">From $29/mo</div>
                                <div id="selected-template-badge" style="margin-top: 0.5rem; font-size: 0.8rem; color: white; display: none;">
                                    Selected: <span id="selected-template-name">Light</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column - Two Stacked -->
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <!-- Plugin Only -->
                            <label class="template-option" style="cursor: pointer; border: 2px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; flex: 1;">
                                <input type="radio" name="deploy-template" value="plugin-only" style="display: none;">
                                <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); padding: 1rem; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">ðŸ”Œ</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: white;">Plugin Only</div>
                                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">For your own WordPress site</div>
                                    <div style="font-size: 0.9rem; font-weight: 600; color: #fef3c7; margin-top: 0.25rem;">From $19.99/mo</div>
                                </div>
                            </label>
                            
                            <!-- Custom Bespoke -->
                            <label class="template-option" style="cursor: pointer; border: 2px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s; flex: 1;">
                                <input type="radio" name="deploy-template" value="custom-bespoke" style="display: none;">
                                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 1rem; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                    <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">âœ¨</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: white;">Custom Bespoke</div>
                                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.9);">Fully custom premium design</div>
                                    <div style="font-size: 0.9rem; font-weight: 600; color: #fef3c7; margin-top: 0.25rem;">From $199/mo</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Room Selection - Shown for ALL templates except Custom Bespoke -->
                <div id="room-selection-section">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <span style="font-weight: 600;"> Select Rooms to Display *</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-small" onclick="selectAllDeployRooms()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Select All</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="deselectAllDeployRooms()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Deselect All</button>
                        </div>
                    </label>
                    <div id="deploy-rooms-container" style="max-height: 350px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            Loading rooms...
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <small style="color: #64748b;">Select the rooms/units you want on this website</small>
                        <small id="deploy-room-count" style="color: var(--primary); font-weight: 500;">0 rooms selected</small>
                    </div>
                </div>
                </div>
                
                <!-- Standard Site Fields (hidden for Plugin Only and Custom) -->
                <div id="standard-site-fields">
                
                <!-- Template Options -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;"> Template Options</label>
                    <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; margin-bottom: 0.75rem;">
                            <input type="checkbox" id="deploy-use-theme" checked style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 500;">Install GAS Theme</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Professional booking-ready theme</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; margin-bottom: 0.75rem;">
                            <input type="checkbox" id="deploy-use-plugin" checked style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 500;">Install GAS Booking Plugin</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Calendar, availability & booking system</div>
                            </div>
                        </label>
                        <div style="border-top: 1px solid #e2e8f0; margin-top: 0.75rem; padding-top: 0.75rem;">
                            <div style="font-size: 0.85rem; font-weight: 500; color: #64748b; margin-bottom: 0.5rem;"> Additional Pages</div>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="deploy-enable-blog" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: 500;">Enable Blog</div>
                                    <div style="font-size: 0.8rem; color: #64748b;">Add blog page with GAS Blog plugin</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                <input type="checkbox" id="deploy-enable-attractions" style="width: 18px; height: 18px;">
                                <div>
                                    <div style="font-weight: 500;">Enable Things To Do</div>
                                    <div style="font-size: 0.8rem; color: #64748b;">Add attractions page with GAS Attractions plugin</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <small style="color: #64748b; margin-top: 0.5rem; display: block;">Uncheck to use your own theme/plugin instead</small>
                </div>
                
                <div id="deploy-summary" style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #166534;"> What will be created:</h4>
                    <ul style="margin: 0; padding-left: 1.25rem; color: #166534; font-size: 0.9rem;">
                        <li>Clean WordPress site</li>
                        <li>GAS theme & plugin (if selected)</li>
                        <li>Only selected rooms will display</li>
                        <li>Connected to GAS booking system</li>
                    </ul>
                </div>
                </div><!-- End standard-site-fields -->
                
                <!-- Plugin Only Content -->
                <div id="plugin-only-fields" style="display: none;">
                    <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border: 2px solid #c084fc; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #7c3aed; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸ”Œ GAS Booking Plugin
                        </h4>
                        <p style="color: #6b21a8; margin: 0 0 1rem 0; font-size: 0.95rem;">
                            Download our powerful booking plugin and install it on your own WordPress site. Perfect if you already have a website and just need the booking functionality.
                        </p>
                        <ul style="margin: 0 0 1.5rem 0; padding-left: 1.25rem; color: #6b21a8; font-size: 0.9rem;">
                            <li>Booking calendar & availability</li>
                            <li>Room/property shortcodes</li>
                            <li>Payment integration (Stripe)</li>
                            <li>Channel manager sync</li>
                            <li>Works with any WordPress theme</li>
                        </ul>
                        <div style="background: white; border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="font-weight: 600; color: #1e293b;">Plugin License</span>
                                <span style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;">$19.99<span style="font-size: 0.9rem; font-weight: 400;">/mo</span></span>
                            </div>
                            <p style="font-size: 0.8rem; color: #64748b; margin: 0;">Includes updates, support, and API access</p>
                        </div>
                    </div>
                    
                    <!-- Display Settings -->
                    <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                            ðŸŽ¨ Display Settings
                        </h4>
                        <p style="color: #64748b; margin: 0 0 1rem 0; font-size: 0.85rem;">
                            Configure how rooms display on the customer's website. These settings are fetched when the plugin loads.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Columns -->
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 500; font-size: 0.85rem; margin-bottom: 0.25rem; display: block;">Columns</label>
                                <select id="plugin-display-columns" class="form-input" style="width: 100%;">
                                    <option value="2">2 Columns</option>
                                    <option value="3" selected>3 Columns</option>
                                    <option value="4">4 Columns</option>
                                </select>
                            </div>
                            
                            <!-- Layout Style -->
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 500; font-size: 0.85rem; margin-bottom: 0.25rem; display: block;">Layout Style</label>
                                <select id="plugin-display-layout" class="form-input" style="width: 100%;">
                                    <option value="auto" selected>Auto (adapts to count)</option>
                                    <option value="grid">Grid</option>
                                    <option value="row">Row (horizontal)</option>
                                </select>
                            </div>
                            
                            <!-- Featured Count -->
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 500; font-size: 0.85rem; margin-bottom: 0.25rem; display: block;">Featured Count</label>
                                <select id="plugin-display-limit" class="form-input" style="width: 100%;">
                                    <option value="0">Show All</option>
                                    <option value="3">3 Rooms</option>
                                    <option value="4" selected>4 Rooms</option>
                                    <option value="6">6 Rooms</option>
                                    <option value="8">8 Rooms</option>
                                    <option value="12">12 Rooms</option>
                                </select>
                            </div>
                            
                            <!-- Background Color -->
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 500; font-size: 0.85rem; margin-bottom: 0.25rem; display: block;">Section Background</label>
                                <select id="plugin-display-bg" class="form-input" style="width: 100%;">
                                    <option value="light">Light (#ffffff)</option>
                                    <option value="dark" selected>Dark (#0f172a)</option>
                                    <option value="gray">Gray (#f1f5f9)</option>
                                    <option value="custom">Custom Color</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Custom Background Color (hidden by default) -->
                        <div id="plugin-custom-bg-wrapper" style="display: none; margin-top: 1rem;">
                            <label style="font-weight: 500; font-size: 0.85rem; margin-bottom: 0.25rem; display: block;">Custom Background Color</label>
                            <input type="color" id="plugin-display-bg-custom" value="#0f172a" style="width: 100%; height: 40px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <!-- Primary Color -->
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 500; font-size: 0.85rem; margin-bottom: 0.25rem; display: block;">Button Color</label>
                                <input type="color" id="plugin-display-primary" value="#2563eb" style="width: 100%; height: 40px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;">
                            </div>
                            
                            <!-- Card Style -->
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-weight: 500; font-size: 0.85rem; margin-bottom: 0.25rem; display: block;">Card Style</label>
                                <select id="plugin-display-card-style" class="form-input" style="width: 100%;">
                                    <option value="default" selected>Default (shadow)</option>
                                    <option value="bordered">Bordered</option>
                                    <option value="minimal">Minimal</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; display: flex; gap: 1.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="plugin-display-random" style="width: 18px; height: 18px;">
                                <span style="font-size: 0.85rem;">Randomize order</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="plugin-display-show-map" style="width: 18px; height: 18px;">
                                <span style="font-size: 0.85rem;">Show map</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="plugin-display-show-filters" checked style="width: 18px; height: 18px;">
                                <span style="font-size: 0.85rem;">Show filters</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="plugin-download-section" style="display: none; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #166534;">âœ… Plugin Ready!</h4>
                        <p style="color: #166534; margin: 0 0 1rem 0; font-size: 0.9rem;">Your plugin license is active. Download and install on your WordPress site.</p>
                        <a href="#" id="plugin-download-link" class="btn" style="background: #10b981; display: inline-block;">ðŸ“¥ Download Plugin (.zip)</a>
                    </div>
                </div>
                
                <!-- Custom Bespoke Content -->
                <div id="custom-bespoke-fields" style="display: none;">
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #b45309; display: flex; align-items: center; gap: 0.5rem;">
                            âœ¨ Custom Bespoke Website
                        </h4>
                        <p style="color: #92400e; margin: 0 0 1rem 0; font-size: 0.95rem;">
                            Get a fully custom-designed website tailored to your brand. Hosted on our premium servers with full WordPress access, Elementor Pro, and dedicated support.
                        </p>
                        <ul style="margin: 0 0 1.5rem 0; padding-left: 1.25rem; color: #92400e; font-size: 0.9rem;">
                            <li>Unique custom design</li>
                            <li>Premium hosting on custom.gas.travel</li>
                            <li>Full WordPress admin access</li>
                            <li>Elementor Pro included</li>
                            <li>GAS Booking Plugin included</li>
                            <li>Priority support</li>
                        </ul>
                        <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; color: #1e293b;">Custom Website</span>
                                <span style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">From $199<span style="font-size: 0.9rem; font-weight: 400;">/mo</span></span>
                            </div>
                            <p style="font-size: 0.8rem; color: #64748b; margin: 0;">Setup fee may apply depending on complexity</p>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Choose your subdomain *</label>
                        <div style="display: flex; align-items: center; gap: 0;">
                            <input type="text" id="custom-subdomain" class="form-input" placeholder="myhotel" style="border-radius: 6px 0 0 6px; border-right: none; flex: 1;" required>
                            <span style="background: #f1f5f9; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; color: #64748b; font-size: 0.9rem;">.custom.gas.travel</span>
                        </div>
                        <p style="font-size: 0.75rem; color: #64748b; margin: 0.25rem 0 0 0;">This will be your site URL while we build it. You can add a custom domain later.</p>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Tell us about your project *</label>
                        <textarea id="custom-project-description" rows="4" class="form-input" placeholder="Describe your ideal website - style, features, inspiration sites, etc." style="width: 100%; resize: vertical;" required></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Reference Website (optional)</label>
                        <input type="url" id="custom-reference-url" class="form-input" placeholder="https://example.com - A site style you like">
                    </div>
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Best contact number</label>
                        <input type="tel" id="custom-phone" class="form-input" placeholder="+1 234 567 8900">
                    </div>
                </div>
                
                <div id="deploy-progress" style="display: none; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;"></div>
                    <div id="deploy-progress-text">Creating your site...</div>
                </div>
                
                <div id="deploy-result" style="display: none; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #166534;"> Site Created!</h4>
                    <div id="deploy-result-content"></div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('deployModal')">Cancel</button>
                    <button type="submit" class="btn" id="deploy-submit-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">ðŸš€ Deploy Site</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Agency Modal -->
    <div id="agencyModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="agency-modal-title" style="margin: 0; font-size: 1.25rem;"> Add New Agency</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Create an agency partner account</p>
                </div>
                <button class="modal-close" onclick="closeModal('agencyModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="agency-form" onsubmit="saveAgency(event)">
                    <input type="hidden" id="agency-id">
                    <input type="hidden" id="agency-public-id">
                    
                    <!-- API Key Section (only shown when editing) -->
                    <div id="agency-api-key-section" style="display: none; margin-bottom: 1.5rem; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border-radius: 12px; padding: 1rem; color: white;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;"> Agency API Key</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="agency-api-key-display" readonly style="flex: 1; padding: 0.6rem; border-radius: 6px; border: none; font-size: 0.8rem; background: rgba(255,255,255,0.95); color: #1e293b; font-family: monospace;">
                            <button type="button" onclick="copyAgencyApiKey()" style="padding: 0.6rem 1rem; background: white; color: #4f46e5; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;"> Copy</button>
                        </div>
                    </div>
                    
                    <!-- Basic Info -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Basic Information</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Agency Name <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="agency-name" class="form-input" required placeholder="e.g., Elevate Schweiz GmbH">
                            </div>
                            <div class="form-group">
                                <label>Email <span style="color: #ef4444;">*</span></label>
                                <input type="email" id="agency-email" class="form-input" required placeholder="contact@agency.com">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="agency-phone" class="form-input" placeholder="+41 58 590 99 91">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Website</label>
                                <input type="url" id="agency-website" class="form-input" placeholder="https://www.agency.com">
                            </div>
                        </div>
                    </div>

                    <!-- Address -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Address</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Address Line 1</label>
                                <input type="text" id="agency-address1" class="form-input" placeholder="Street address">
                            </div>
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="agency-city" class="form-input" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <select id="agency-country" class="form-input">
                                    <option value="GB"> United Kingdom</option>
                                    <option value="US"> United States</option>
                                    <option value="CH" selected> Switzerland</option>
                                    <option value="DE"> Germany</option>
                                    <option value="FR"> France</option>
                                    <option value="IT"> Italy</option>
                                    <option value="ES"> Spain</option>
                                    <option value="NL"> Netherlands</option>
                                    <option value="AT"> Austria</option>
                                    <option value="PT"> Portugal</option>
                                    <option value="BE"> Belgium</option>
                                    <option value="IE"> Ireland</option>
                                    <option value="AU"> Australia</option>
                                    <option value="NZ"> New Zealand</option>
                                    <option value="CA"> Canada</option>
                                    <option value="AE"> UAE</option>
                                    <option value="JP"> Japan</option>
                                    <option value="TH"> Thailand</option>
                                    <option value="GR"> Greece</option>
                                    <option value="HR"> Croatia</option>
                                    <option value="CZ"> Czech Republic</option>
                                    <option value="PL"> Poland</option>
                                    <option value="HU"> Hungary</option>
                                    <option value="SE"> Sweden</option>
                                    <option value="NO"> Norway</option>
                                    <option value="DK"> Denmark</option>
                                    <option value="FI"> Finland</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Branding (for future white-label) -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Branding</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Primary Color</label>
                                <input type="color" id="agency-primary-color" class="form-input" value="#6366f1" style="height: 45px;">
                            </div>
                            <div class="form-group">
                                <label>Secondary Color</label>
                                <input type="color" id="agency-secondary-color" class="form-input" value="#8b5cf6" style="height: 45px;">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Logo URL</label>
                                <input type="url" id="agency-logo" class="form-input" placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Settings</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="agency-currency" class="form-input">
                                    <option value="CHF"> CHF</option>
                                    <option value="EUR"> EUR</option>
                                    <option value="GBP"> GBP</option>
                                    <option value="USD">$ USD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Plan</label>
                                <select id="agency-plan" class="form-input">
                                    <option value="agency">Agency</option>
                                    <option value="enterprise">Enterprise</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="agency-status" class="form-input">
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group">
                        <label>Internal Notes</label>
                        <textarea id="agency-notes" class="form-input" rows="2" placeholder="Any internal notes about this agency..."></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('agencyModal')">Cancel</button>
                        <button type="submit" class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">ðŸ’¾ Save Agency</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Agency Detail Modal -->
    <div id="agencyDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="agency-detail-title" style="margin: 0; font-size: 1.25rem;">Agency Details</h3>
                    <p id="agency-detail-subtitle" style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;"></p>
                </div>
                <button class="modal-close" onclick="closeModal('agencyDetailModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="agency-detail-content">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="client-modal-title" style="margin: 0; font-size: 1.25rem;"> Add New Client</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Create a new client account</p>
                </div>
                <button class="modal-close" onclick="closeModal('clientModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="client-form" onsubmit="saveClient(event)">
                    <input type="hidden" id="client-id">
                    <input type="hidden" id="client-public-id">
                    
                    <!-- Setup Link Section (only shown when editing) -->
                    <div id="client-setup-link-section" style="display: none; margin-bottom: 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 1rem; color: white;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;"> Client Setup Link</h4>
                        <p style="font-size: 0.8rem; margin: 0 0 0.75rem 0; opacity: 0.9;">Send this link to your client so they can connect their channel manager:</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="client-setup-link-display" readonly style="flex: 1; padding: 0.6rem; border-radius: 6px; border: none; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #1e293b;">
                            <button type="button" onclick="copyClientSetupLink()" style="padding: 0.6rem 1rem; background: white; color: #059669; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;"> Copy</button>
                        </div>
                        <p style="font-size: 0.75rem; margin: 0.5rem 0 0 0; opacity: 0.8;">UUID: <span id="client-uuid-display"></span></p>
                    </div>
                    
                    <!-- Basic Info -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Basic Information</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Company / Client Name <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="client-name" class="form-input" required placeholder="e.g., Lehmann House Ltd">
                            </div>
                            <div class="form-group">
                                <label>Email <span style="color: #ef4444;">*</span></label>
                                <input type="email" id="client-email" class="form-input" required placeholder="info@example.com">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="client-phone" class="form-input" placeholder="+44 1234 567890">
                            </div>
                        </div>
                    </div>

                    <!-- Address -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Address</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Address Line 1</label>
                                <input type="text" id="client-address1" class="form-input" placeholder="Street address">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Address Line 2</label>
                                <input type="text" id="client-address2" class="form-input" placeholder="Apartment, suite, etc.">
                            </div>
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="client-city" class="form-input" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label>Region / County</label>
                                <input type="text" id="client-region" class="form-input" placeholder="Region">
                            </div>
                            <div class="form-group">
                                <label>Postcode</label>
                                <input type="text" id="client-postcode" class="form-input" placeholder="Postcode">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <select id="client-country" class="form-input">
                                    <option value="GB" selected> United Kingdom</option>
                                    <option value="US"> United States</option>
                                    <option value="CH"> Switzerland</option>
                                    <option value="DE"> Germany</option>
                                    <option value="FR"> France</option>
                                    <option value="IT"> Italy</option>
                                    <option value="ES"> Spain</option>
                                    <option value="NL"> Netherlands</option>
                                    <option value="AT"> Austria</option>
                                    <option value="PT"> Portugal</option>
                                    <option value="BE"> Belgium</option>
                                    <option value="IE"> Ireland</option>
                                    <option value="AU"> Australia</option>
                                    <option value="NZ"> New Zealand</option>
                                    <option value="CA"> Canada</option>
                                    <option value="AE"> UAE</option>
                                    <option value="JP"> Japan</option>
                                    <option value="TH"> Thailand</option>
                                    <option value="GR"> Greece</option>
                                    <option value="HR"> Croatia</option>
                                    <option value="CZ"> Czech Republic</option>
                                    <option value="PL"> Poland</option>
                                    <option value="HU"> Hungary</option>
                                    <option value="SE"> Sweden</option>
                                    <option value="NO"> Norway</option>
                                    <option value="DK"> Denmark</option>
                                    <option value="FI"> Finland</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Settings</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="client-currency" class="form-input">
                                    <option value="GBP"> GBP</option>
                                    <option value="EUR"> EUR</option>
                                    <option value="USD">$ USD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Plan</label>
                                <select id="client-plan" class="form-input">
                                    <option value="free">Free</option>
                                    <option value="starter">Starter</option>
                                    <option value="professional">Professional</option>
                                    <option value="agency">Agency</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="client-status" class="form-input">
                                    <option value="active">Active</option>
                                    <option value="trial">Trial</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label>Internal Notes</label>
                        <textarea id="client-notes" class="form-input" rows="2" placeholder="Any internal notes about this client..."></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('clientModal')">Cancel</button>
                        <button type="submit" class="btn">ðŸ’¾ Save Client</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Client Detail Modal -->
    <div id="clientDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="client-detail-title" style="margin: 0; font-size: 1.25rem;">Client Details</h3>
                    <p id="client-detail-subtitle" style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;"></p>
                </div>
                <button class="modal-close" onclick="closeModal('clientDetailModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;" id="client-detail-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;">Loading client details...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Booking Modal -->
    <div id="edit-booking-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 style="margin: 0;"> Edit Booking <span id="edit-booking-ref" style="color: #fef3c7; font-weight: 600;"></span></h3>
                <button class="modal-close" onclick="closeEditBookingModal()" style="color: white;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-booking-id">
                <input type="hidden" id="edit-booking-beds24-id">
                
                <!-- Guest Details -->
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b;">Guest Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-input" id="edit-booking-first-name" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-input" id="edit-booking-last-name" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="edit-booking-email" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="edit-booking-phone">
                        </div>
                    </div>
                </div>
                
                <!-- Stay Details -->
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b;">Stay Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Check-in *</label>
                            <input type="date" class="form-input" id="edit-booking-checkin" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Check-out *</label>
                            <input type="date" class="form-input" id="edit-booking-checkout" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Adults</label>
                            <input type="number" class="form-input" id="edit-booking-adults" min="1" value="1">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Children</label>
                            <input type="number" class="form-input" id="edit-booking-children" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- Pricing -->
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #64748b;">Pricing & Payment</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Total Price</label>
                            <input type="number" class="form-input" id="edit-booking-total" step="0.01" min="0">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Deposit Paid</label>
                            <input type="number" class="form-input" id="edit-booking-deposit" step="0.01" min="0">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Balance Due</label>
                            <input type="number" class="form-input" id="edit-booking-balance" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                
                <!-- Status -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Booking Status</label>
                        <select class="form-input" id="edit-booking-status">
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="completed">Completed</option>
                            <option value="no_show">No Show</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Payment Status</label>
                        <select class="form-input" id="edit-booking-payment-status">
                            <option value="pending">Pending</option>
                            <option value="deposit_paid">Deposit Paid</option>
                            <option value="paid">Fully Paid</option>
                            <option value="refunded">Refunded</option>
                        </select>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="edit-booking-notes" rows="2" placeholder="Internal notes..."></textarea>
                </div>
                
                <!-- Sync info -->
                <div id="edit-booking-sync-info" style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; font-size: 0.85rem; color: #92400e; display: none;">
                     This booking is synced with <span id="edit-booking-sync-source"></span>. Changes will be pushed to the channel manager.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditBookingModal()">Cancel</button>
                <button class="btn" onclick="saveBookingEdit()" id="save-booking-btn">ðŸ’¾ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Offer Modal -->
    <div id="addOfferModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="offer-modal-title" style="margin: 0; font-size: 1.25rem;"> Create New Offer</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Set up a discount or price adjustment</p>
                </div>
                <button class="modal-close" onclick="closeModal('addOfferModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="offer-form">
                    <input type="hidden" id="offer-id">
                    
                    <!-- Offer Name -->
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Offer Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="offer-name" class="form-input" placeholder="e.g., Early Bird Discount" required
                            style="padding: 0.75rem; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <!-- Description -->
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Description <span style="color: #9ca3af; font-weight: normal;">(shown to guests)</span>
                        </label>
                        <textarea id="offer-description" class="form-input" rows="2" placeholder="Book 30 days in advance and save!"
                            style="padding: 0.75rem; border-radius: 8px; font-size: 0.95rem; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- Discount Section -->
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                             Discount Settings
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="offer-discount-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="fixed_amount">Fixed Amount ($)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Value <span style="color: #ef4444;">*</span></label>
                                <div style="position: relative;">
                                    <span id="discount-prefix" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;"></span>
                                    <input type="number" id="offer-discount-value" class="form-input" placeholder="10" required min="0" step="0.01"
                                        style="padding: 0.6rem; padding-left: 1.5rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600;">
                                    <span id="discount-suffix" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Property/Room Selection -->
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #475569; margin-bottom: 0.75rem; display: block;">
                             Apply To
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Properties</label>
                                <div id="offer-properties-list" style="border: 1px solid #d1d5db; border-radius: 8px; max-height: 150px; overflow-y: auto; padding: 0.5rem; background: white;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px;" class="offer-prop-option">
                                        <input type="checkbox" name="offer-properties" value="" checked onchange="filterRoomsBySelectedProperties()">
                                        <span style="font-size: 0.9rem;">All Properties</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Rooms</label>
                                <div id="offer-rooms-list" style="border: 1px solid #d1d5db; border-radius: 8px; max-height: 150px; overflow-y: auto; padding: 0.5rem; background: white;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px;" class="offer-room-option">
                                        <input type="checkbox" name="offer-rooms" value="" checked>
                                        <span style="font-size: 0.9rem;">All Rooms</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;"> Select multiple properties and/or rooms, or leave "All" checked</p>
                    </div>
                    
                    <!-- Advanced Conditions -->
                    <details style="margin-bottom: 1.25rem; background: #fefce8; border: 1px solid #fde68a; border-radius: 12px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #854d0e; padding: 1rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="transition: transform 0.2s;"></span>  Advanced Conditions
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Nights</label>
                                    <input type="number" id="offer-min-nights" class="form-input" placeholder="1" min="1" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Max Nights</label>
                                    <input type="number" id="offer-max-nights" class="form-input" placeholder="Any" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Days Advance</label>
                                    <input type="number" id="offer-min-advance" class="form-input" placeholder="e.g., 30" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Max Days Advance</label>
                                    <input type="number" id="offer-max-advance" class="form-input" placeholder="e.g., 7" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Valid From</label>
                                    <input type="date" id="offer-valid-from" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Valid Until</label>
                                    <input type="date" id="offer-valid-until" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <!-- Check-in Day Restrictions -->
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px;">
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                     Allowed Check-in Days
                                </label>
                                <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-sun" value="0" checked style="width: 14px; height: 14px;"> Sun
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-mon" value="1" checked style="width: 14px; height: 14px;"> Mon
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-tue" value="2" checked style="width: 14px; height: 14px;"> Tue
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-wed" value="3" checked style="width: 14px; height: 14px;"> Wed
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-thu" value="4" checked style="width: 14px; height: 14px;"> Thu
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-fri" value="5" checked style="width: 14px; height: 14px;"> Fri
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-sat" value="6" checked style="width: 14px; height: 14px;"> Sat
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Check-out Day Restrictions -->
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px;">
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                     Allowed Check-out Days
                                </label>
                                <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-sun" value="0" checked style="width: 14px; height: 14px;"> Sun
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-mon" value="1" checked style="width: 14px; height: 14px;"> Mon
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-tue" value="2" checked style="width: 14px; height: 14px;"> Tue
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-wed" value="3" checked style="width: 14px; height: 14px;"> Wed
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-thu" value="4" checked style="width: 14px; height: 14px;"> Thu
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-fri" value="5" checked style="width: 14px; height: 14px;"> Fri
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-sat" value="6" checked style="width: 14px; height: 14px;"> Sat
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Priority (higher = applied first)</label>
                                <input type="number" id="offer-priority" class="form-input" placeholder="0" value="0" style="padding: 0.5rem; border-radius: 6px; width: 100px;">
                            </div>
                        </div>
                    </details>
                    
                    <!-- Pricing Tier -->
                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                             Pricing Tier
                        </label>
                        <p style="font-size: 0.85rem; color: #78716c; margin-bottom: 0.75rem;">
                            Assign this offer to a pricing tier. Websites can be configured to show only specific tiers.
                        </p>
                        <select id="offer-pricing-tier" class="form-input" style="padding: 0.6rem; border-radius: 8px; max-width: 300px;" onchange="togglePricePerNightField()">
                            <option value="standard">Standard (default)</option>
                            <option value="corporate_1">Corporate 1</option>
                            <option value="corporate_2">Corporate 2</option>
                            <option value="corporate_3">Corporate 3</option>
                            <option value="agent_1">Travel Agent 1</option>
                            <option value="agent_2">Travel Agent 2</option>
                            <option value="agent_3">Travel Agent 3</option>
                        </select>
                    </div>
                    
                    <!-- Price Per Night (for non-standard tiers) -->
                    <div id="price-per-night-section" style="display: none; background: #fef3c7; padding: 1rem; border-radius: 8px; border: 1px solid #f59e0b;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">
                             Fixed Price Per Night
                        </label>
                        <p style="font-size: 0.85rem; color: #92400e; margin-bottom: 0.75rem;">
                            For Corporate/Agent tiers, set a fixed price per night (overrides standard pricing).
                        </p>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="number" id="offer-price-per-night" class="form-input" style="padding: 0.6rem; border-radius: 8px; max-width: 150px;" placeholder="e.g. 85" step="0.01" min="0">
                            <span style="color: #78716c;">per night</span>
                        </div>
                    </div>
                    
                    <!-- Active Toggle -->
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <label class="toggle-switch" style="position: relative; display: inline-block; width: 48px; height: 26px; cursor: pointer;">
                            <input type="checkbox" id="offer-active" checked style="opacity: 0; width: 0; height: 0;" onchange="updateOfferToggleVisual(this)">
                            <span class="toggle-slider" id="offer-active-slider" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #22c55e; transition: .3s; border-radius: 26px;">
                                <span class="toggle-dot" id="offer-active-dot" style="position: absolute; height: 20px; width: 20px; left: 25px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%;"></span>
                            </span>
                        </label>
                        <span style="font-weight: 500; color: #374151;">Active</span>
                        <span style="font-size: 0.85rem; color: #6b7280;"> Offer is live and can be used</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px; display: flex; justify-content: flex-end; gap: 0.75rem;">
                <button class="btn btn-secondary" onclick="closeModal('addOfferModal')" style="padding: 0.6rem 1.25rem; border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveOffer()" style="padding: 0.6rem 1.5rem; border-radius: 8px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                     Save Offer
                </button>
            </div>
        </div>
    </div>

    <!-- Add Voucher Modal -->
    <div id="addVoucherModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;"> Create New Voucher</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Gift cards, promo codes & discounts</p>
                </div>
                <button class="modal-close" onclick="closeModal('addVoucherModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="voucher-form">
                    <input type="hidden" id="voucher-id">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Voucher Code <span style="color: #ef4444;">*</span>
                            </label>
                            <input type="text" id="voucher-code" class="form-input" placeholder="e.g., WINTER20" required 
                                style="text-transform: uppercase; padding: 0.75rem; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Display Name <span style="color: #ef4444;">*</span>
                            </label>
                            <input type="text" id="voucher-name" class="form-input" placeholder="e.g., Winter Sale 20%" required
                                style="padding: 0.75rem; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">Description</label>
                        <textarea id="voucher-description" class="form-input" placeholder="Get 20% off your winter stay" rows="2"
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <!-- Internal/External Toggle -->
                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                             Service Provider
                        </label>
                        <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="voucher-provider-type" value="internal" checked onchange="toggleVoucherVendor()">
                                <span>Internal (provided by property)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="voucher-provider-type" value="external" onchange="toggleVoucherVendor()">
                                <span>External Vendor</span>
                            </label>
                        </div>
                        <div id="voucher-vendor-section" style="display: none;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Select Vendor</label>
                            <select id="voucher-vendor" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">-- Select a vendor --</option>
                            </select>
                            <p style="font-size: 0.8rem; color: #6b7280; margin: 0.5rem 0 0;">
                                <a href="#" onclick="showView('vendors'); closeModal('addVoucherModal'); return false;" style="color: #f59e0b;">+ Add new vendor</a>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                             Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                            <select id="voucher-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadVoucherUnits()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <select id="voucher-unit" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">All Units</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Voucher Type & Value -->
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                             Voucher Value
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="voucher-discount-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="percentage">Percentage Off (%)</option>
                                    <option value="fixed">Fixed Amount Off ()</option>
                                    <option value="monetary">Gift Card / Credit ()</option>
                                    <option value="free_nights">Free Night(s)</option>
                                    <option value="addon">Free Add-on</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Value <span style="color: #ef4444;">*</span></label>
                                <input type="number" id="voucher-discount-value" class="form-input" placeholder="e.g., 20" required min="0" step="0.01"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Validity Period -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">Valid From</label>
                            <input type="date" id="voucher-valid-from" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">Valid Until</label>
                            <input type="date" id="voucher-valid-until" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <details style="margin-bottom: 1.25rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #475569; padding: 1rem; list-style: none;">
                             Usage Limits & Restrictions
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div class="form-group">
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Max Total Uses</label>
                                    <input type="number" id="voucher-max-uses" class="form-input" placeholder="Unlimited" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Nights Required</label>
                                    <input type="number" id="voucher-min-nights" class="form-input" placeholder="1" min="1" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Booking Total ()</label>
                                <input type="number" id="voucher-min-total" class="form-input" placeholder="No minimum" step="0.01" style="padding: 0.5rem; border-radius: 6px;">
                            </div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #475569; cursor: pointer;">
                                <input type="checkbox" id="voucher-single-use" style="width: 16px; height: 16px;">
                                Single use per guest email
                            </label>
                        </div>
                    </details>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="voucher-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addVoucherModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveVoucher()" style="border-radius: 8px; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                     Save Voucher
                </button>
            </div>
        </div>
    </div>

    <!-- Add Upsell Modal -->
    <div id="addUpsellModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="upsell-modal-title" style="margin: 0;"> Add Upsell</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Extra service guests can add to their booking</p>
                </div>
                <button class="modal-close" onclick="closeModal('addUpsellModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="upsell-form">
                    <input type="hidden" id="upsell-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Upsell Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="upsell-name" class="form-input" placeholder="e.g., Champagne on arrival" required
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Description
                        </label>
                        <textarea id="upsell-description" class="form-input" rows="2" placeholder="Bottle of premium champagne waiting in your room"
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <!-- Internal/External Toggle -->
                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                             Service Provider
                        </label>
                        <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="upsell-provider-type" value="internal" checked onchange="toggleUpsellVendor()">
                                <span>Internal (provided by property)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="upsell-provider-type" value="external" onchange="toggleUpsellVendor()">
                                <span>External Vendor</span>
                            </label>
                        </div>
                        <div id="upsell-vendor-section" style="display: none;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Select Vendor</label>
                            <select id="upsell-vendor" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">-- Select a vendor --</option>
                            </select>
                            <p style="font-size: 0.8rem; color: #6b7280; margin: 0.5rem 0 0;">
                                <a href="#" onclick="showView('vendors'); closeModal('addUpsellModal'); return false;" style="color: #f59e0b;">+ Add new vendor</a>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                             Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                            <select id="upsell-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadUpsellRooms()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <div id="upsell-rooms-container">
                                <select id="upsell-room" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="">All Units</option>
                                </select>
                            </div>
                            <div id="upsell-rooms-checkboxes" style="display: none; max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.5rem; margin-top: 0.5rem; background: white;">
                                <!-- Unit checkboxes populated by JS -->
                            </div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.85rem; color: #475569; cursor: pointer;">
                                <input type="checkbox" id="upsell-multi-room" onchange="toggleUpsellMultiRoom()">
                                Select multiple units
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Price <span style="color: #ef4444;">*</span>
                            </label>
                            <div style="position: relative;">
                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">$</span>
                                <input type="number" id="upsell-price" class="form-input" placeholder="50.00" required min="0" step="0.01"
                                    style="padding: 0.75rem; padding-left: 1.75rem; border-radius: 8px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Charge Type
                            </label>
                            <select id="upsell-charge-type" class="form-input" style="padding: 0.75rem; border-radius: 8px;">
                                <option value="per_booking">Per Booking (one-time)</option>
                                <option value="per_night">Per Night</option>
                                <option value="per_day">Per Day</option>
                                <option value="per_guest">Per Guest</option>
                                <option value="per_guest_per_night">Per Guest/Night</option>
                                <option value="per_hour">Per Hour</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Max Quantity <span style="color: #9ca3af; font-weight: normal;">(optional)</span>
                        </label>
                        <input type="number" id="upsell-max-qty" class="form-input" placeholder="Unlimited" min="1"
                            style="padding: 0.75rem; border-radius: 8px; width: 120px;">
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="upsell-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addUpsellModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveUpsell()" style="border-radius: 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                     Save Upsell
                </button>
            </div>
        </div>
    </div>

    <!-- Add Fee Modal -->
    <div id="addFeeModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="fee-modal-title" style="margin: 0;"> Add Fee</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Mandatory charge applied to bookings</p>
                </div>
                <button class="modal-close" onclick="closeModal('addFeeModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="fee-form">
                    <input type="hidden" id="fee-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Fee Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="fee-name" class="form-input" placeholder="e.g., Cleaning Fee" required
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Description
                        </label>
                        <textarea id="fee-description" class="form-input" rows="2" placeholder="One-time cleaning fee"
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                             Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                            <select id="fee-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadFeeUnits()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <select id="fee-unit" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">All Units</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Amount Type
                            </label>
                            <select id="fee-amount-type" class="form-input" style="padding: 0.75rem; border-radius: 8px;" onchange="toggleFeeAmountInput()">
                                <option value="fixed">Fixed Amount ($)</option>
                                <option value="percentage">Percentage (%)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Amount <span style="color: #ef4444;">*</span>
                            </label>
                            <div style="position: relative;">
                                <span id="fee-amount-prefix" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">$</span>
                                <input type="number" id="fee-amount" class="form-input" placeholder="100.00" required min="0" step="0.01"
                                    style="padding: 0.75rem; padding-left: 1.75rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Apply Per
                        </label>
                        <select id="fee-apply-per" class="form-input" style="padding: 0.75rem; border-radius: 8px;">
                            <option value="per_booking">Per Booking</option>
                            <option value="per_night">Per Night</option>
                            <option value="per_guest">Per Guest</option>
                            <option value="per_guest_per_night">Per Guest/Night</option>
                        </select>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem; display: block;">
                            Tax Settings
                        </label>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="checkbox" id="fee-is-tax" style="width: 18px; height: 18px;">
                            <span style="color: #78350f;">This is a tax (shown separately on invoice)</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="fee-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addFeeModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveFee()" style="border-radius: 8px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                     Save Fee
                </button>
            </div>
        </div>
    </div>

    <!-- Add Tax Modal -->
    <div id="addTaxModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="tax-modal-title" style="margin: 0;"> Add Tourist Tax</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Government-mandated tax for your location</p>
                </div>
                <button class="modal-close" onclick="closeModal('addTaxModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="tax-form">
                    <input type="hidden" id="tax-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Tax Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="tax-name" class="form-input" placeholder="e.g., City Tourist Tax, Taxe de Sjour" required
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Country/Region
                        </label>
                        <select id="tax-country" class="form-input" style="padding: 0.75rem; border-radius: 8px;" onchange="updateTaxPresets()">
                            <option value="">Select country...</option>
                            <option value="FR"> France</option>
                            <option value="IT"> Italy</option>
                            <option value="ES"> Spain</option>
                            <option value="NL"> Netherlands</option>
                            <option value="DE"> Germany</option>
                            <option value="AT"> Austria</option>
                            <option value="PT"> Portugal</option>
                            <option value="GR"> Greece</option>
                            <option value="CH"> Switzerland</option>
                            <option value="BE"> Belgium</option>
                            <option value="CZ"> Czech Republic</option>
                            <option value="HU"> Hungary</option>
                            <option value="US"> United States</option>
                            <option value="AE"> UAE (Dubai)</option>
                            <option value="JP"> Japan</option>
                            <option value="TH"> Thailand</option>
                            <option value="ID"> Indonesia (Bali)</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                             Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property <span style="color: #ef4444;">*</span></label>
                            <select id="tax-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadTaxUnits()" required>
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <select id="tax-unit" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">All Units</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                             Tax Amount
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="tax-amount-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="toggleTaxAmountInput()">
                                    <option value="fixed">Fixed Amount</option>
                                    <option value="percentage">Percentage of Booking</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Amount <span style="color: #ef4444;">*</span></label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select id="tax-currency" class="form-input" style="padding: 0.6rem; border-radius: 8px; width: 80px;">
                                        <option value="EUR"></option>
                                        <option value="USD">$</option>
                                        <option value="GBP"></option>
                                        <option value="CHF">CHF</option>
                                        <option value="AED">AED</option>
                                        <option value="JPY"></option>
                                    </select>
                                    <input type="number" id="tax-amount" class="form-input" placeholder="4.00" required min="0" step="0.01"
                                        style="padding: 0.6rem; border-radius: 8px; flex: 1;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                             How is it charged?
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Charge Per</label>
                                <select id="tax-charge-per" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="per_person_per_night">Per Person Per Night (PPPN)</option>
                                    <option value="per_room_per_night">Per Room Per Night (PRPN)</option>
                                    <option value="per_booking">Per Booking (one-time)</option>
                                    <option value="percentage">% of Room Rate</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Max Nights <span style="color: #9ca3af;">(if capped)</span></label>
                                <input type="number" id="tax-max-nights" class="form-input" placeholder="e.g., 7" min="1"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <details style="margin-bottom: 1.25rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #475569; padding: 1rem; list-style: none;">
                             Advanced Options
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Age (exempt below)</label>
                                    <input type="number" id="tax-min-age" class="form-input" placeholder="e.g., 12" min="0" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Star Rating Tier</label>
                                    <select id="tax-star-tier" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                        <option value="">All ratings</option>
                                        <option value="1-2">1-2 Star</option>
                                        <option value="3">3 Star</option>
                                        <option value="4">4 Star</option>
                                        <option value="5">5 Star / Luxury</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Season Start</label>
                                    <input type="date" id="tax-season-start" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Season End</label>
                                    <input type="date" id="tax-season-end" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="tax-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addTaxModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveTax()" style="border-radius: 8px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                     Save Tax
                </button>
            </div>
        </div>
    </div>

    <div id="imageUploadModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 class="modal-title" style="margin: 0;"> Upload Images</h3>
                <button class="modal-close" onclick="closeModal('imageUploadModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="position: relative;">
                <!-- Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                    <h3>Drag & drop images here</h3>
                    <p style="color: #64748b; margin: 0.5rem 0;">or click to browse</p>
                    <p style="font-size: 0.85rem; color: #64748b;">
                         Minimum ratio 1.2:1 (e.g., 12001000)  Max 10MB per image
                    </p>
                    <input type="file" id="imageFileInput" multiple accept="image/*" style="display: none;">
                </div>

                <!-- Preview Area -->
                <div id="uploadPreview" class="upload-preview" style="display: none;"></div>

                <!-- Assignment Section -->
                <div class="assignment-section" id="assignmentSection">
                    <h4> Assign images to:</h4>
                    
                    <!-- Property Assignment -->
                    <div style="margin-bottom: 1rem;">
                        <label class="checkbox-label" style="cursor: pointer;">
                            <input type="checkbox" id="assign-property" value="property" style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                            <span style="flex: 1;"> Property Images (general photos)</span>
                        </label>
                    </div>

                    <!-- Location Assignment -->
                    <div style="margin-bottom: 1rem;">
                        <label class="checkbox-label" style="cursor: pointer;">
                            <input type="checkbox" id="assign-location" value="location" style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                            <span style="flex: 1;"> Location Images (area/neighborhood)</span>
                        </label>
                    </div>

                    <!-- Room Assignment -->
                    <div>
                        <div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">
                             Rooms (select one or more):
                        </div>
                        <div class="checkbox-group" id="roomCheckboxes">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>

                <!-- Upload Button -->
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('imageUploadModal')" style="flex: 1;">
                        Cancel
                    </button>
                    <button class="btn" id="uploadButton" onclick="uploadImages()" style="flex: 2;" disabled>
                        Upload Images
                    </button>
                </div>

                <!-- Progress (shown during upload) -->
                <div id="uploadProgress" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 10; border-radius: 12px; display: none; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                    <h3 style="margin-bottom: 1rem;">Uploading Images...</h3>
                    <div style="width: 80%; max-width: 300px; background: var(--bg-secondary); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 0.5rem;">
                        <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p style="text-align: center; color: #64748b; font-size: 1.1rem;" id="progressText">0%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Rule Modal -->
    <div id="depositRuleModal" class="modal">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;"> Deposit Rule</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Configure payment policy for bookings</p>
                </div>
                <button class="modal-close" onclick="closeModal('depositRuleModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="deposit-rule-form" onsubmit="event.preventDefault(); saveDepositRule();">
                    <input type="hidden" id="deposit-rule-id">
                    <input type="hidden" id="deposit-rule-property-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Rule Name
                        </label>
                        <input type="text" id="deposit-rule-name" class="form-input" placeholder="e.g., Standard Deposit, Peak Season"
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                             Deposit Amount
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="deposit-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="toggleDepositTypeFields()">
                                    <option value="percentage">Percentage of total</option>
                                    <option value="fixed">Fixed amount</option>
                                    <option value="first_night">First night only</option>
                                    <option value="full">Full payment</option>
                                </select>
                            </div>
                            <div id="percentage-field">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Percentage</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="number" id="deposit-percentage" class="form-input" value="30" min="1" max="100"
                                        style="padding: 0.6rem; border-radius: 8px; flex: 1;">
                                    <span style="font-weight: 600;">%</span>
                                </div>
                            </div>
                            <div id="fixed-amount-field" style="display: none;">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Fixed Amount ()</label>
                                <input type="number" id="deposit-fixed-amount" class="form-input" placeholder="100.00" min="0" step="0.01"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                             Balance Due
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Days Before Check-in</label>
                                <input type="number" id="balance-due-days" class="form-input" value="14" min="0"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                            <div style="display: flex; align-items: center; padding-top: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="auto-charge-balance" style="width: 18px; height: 18px;">
                                    <span>Auto-charge balance</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                             Refund Policy
                        </label>
                        <select id="refund-policy" class="form-input" style="padding: 0.75rem; border-radius: 8px;">
                            <option value="flexible">Flexible - Full refund up to 24h before check-in</option>
                            <option value="moderate">Moderate - Full refund up to 5 days before</option>
                            <option value="strict">Strict - 50% refund up to 7 days before</option>
                            <option value="non_refundable">Non-refundable</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <input type="checkbox" id="deposit-rule-active" checked style="width: 18px; height: 18px;">
                        <label for="deposit-rule-active" style="font-weight: 500;">Active</label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('depositRuleModal')">Cancel</button>
                        <button type="submit" class="btn" style="background: #059669;">ðŸ’¾ Save Rule</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Deposit Rule Modal -->
    <div id="bulkDepositRuleModal" class="modal">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;"> Apply Deposit Rule to Multiple Properties</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Select properties and configure the rule</p>
                </div>
                <button class="modal-close" onclick="closeModal('bulkDepositRuleModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
                <form id="bulk-deposit-rule-form" onsubmit="event.preventDefault(); saveBulkDepositRule();">
                    
                    <!-- Property Selection -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.75rem;">Select Properties</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <button type="button" class="btn btn-small" onclick="selectAllBulkProperties()" style="font-size: 0.8rem;">Select All</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="deselectAllBulkProperties()" style="font-size: 0.8rem;">Deselect All</button>
                        </div>
                        <div id="bulk-property-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.5rem;">
                            <!-- Property checkboxes populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Rule Name -->
                    <div class="form-group">
                        <label>Rule Name</label>
                        <input type="text" id="bulk-deposit-rule-name" class="form-input" value="Standard Deposit" required>
                    </div>
                    
                    <!-- Deposit Type -->
                    <div class="form-group">
                        <label>Deposit Type</label>
                        <select id="bulk-deposit-type" class="form-input" onchange="toggleBulkDepositTypeFields()">
                            <option value="percentage">Percentage of Total</option>
                            <option value="fixed">Fixed Amount</option>
                            <option value="first_night">First Night</option>
                            <option value="full">Full Payment</option>
                        </select>
                    </div>
                    
                    <!-- Percentage -->
                    <div class="form-group" id="bulk-percentage-field">
                        <label>Deposit Percentage (%)</label>
                        <input type="number" id="bulk-deposit-percentage" class="form-input" value="30" min="1" max="100">
                    </div>
                    
                    <!-- Fixed Amount -->
                    <div class="form-group" id="bulk-fixed-amount-field" style="display: none;">
                        <label>Fixed Amount ($)</label>
                        <input type="number" id="bulk-deposit-fixed-amount" class="form-input" step="0.01" min="0">
                    </div>
                    
                    <!-- Balance Due -->
                    <div class="form-group">
                        <label>Balance Due (days before check-in)</label>
                        <input type="number" id="bulk-balance-due-days" class="form-input" value="14" min="0">
                    </div>
                    
                    <!-- Refund Policy -->
                    <div class="form-group">
                        <label>Refund Policy</label>
                        <select id="bulk-refund-policy" class="form-input">
                            <option value="flexible">Flexible</option>
                            <option value="moderate">Moderate</option>
                            <option value="strict">Strict</option>
                            <option value="non_refundable">Non-refundable</option>
                        </select>
                    </div>
                    
                    <div class="modal-footer" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('bulkDepositRuleModal')">Cancel</button>
                        <button type="submit" class="btn" style="background: #6366f1;">Apply to Selected Properties</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Booking Modal -->
    <div id="addBookingModal" class="modal">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;"> Add Booking</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Create a manual booking</p>
                </div>
                <button class="modal-close" onclick="closeModal('addBookingModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
                <form id="add-booking-form" onsubmit="event.preventDefault(); saveNewBooking();">
                    
                    <!-- Property & Room Selection -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                             Property & Room
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property *</label>
                                <select id="booking-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadBookingRooms()" required>
                                    <option value="">Select Property...</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Room *</label>
                                <select id="booking-room" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                                    <option value="">Select Room...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dates -->
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                             Stay Dates
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Check-in *</label>
                                <input type="date" id="booking-checkin" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Check-out *</label>
                                <input type="date" id="booking-checkout" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Guests</label>
                                <input type="number" id="booking-guests" class="form-input" value="1" min="1" style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Guest Details -->
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                             Guest Details
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">First Name *</label>
                                <input type="text" id="booking-first-name" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Last Name *</label>
                                <input type="text" id="booking-last-name" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Email *</label>
                                <input type="email" id="booking-email" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Phone</label>
                                <input type="tel" id="booking-phone" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment & Status -->
                    <div style="background: #f5f3ff; border: 1px solid #ddd6fe; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #5b21b6; margin-bottom: 0.75rem; display: block;">
                             Payment & Status
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Total Price</label>
                                <input type="number" id="booking-total" class="form-input" step="0.01" min="0" style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Payment Status</label>
                                <select id="booking-payment-status" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="pending">Pending</option>
                                    <option value="deposit_paid">Deposit Paid</option>
                                    <option value="fully_paid">Fully Paid</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Booking Status</label>
                                <select id="booking-status" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="confirmed">Confirmed</option>
                                    <option value="pending">Pending</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;"> Notes</label>
                        <textarea id="booking-notes" class="form-input" rows="3" style="padding: 0.75rem; border-radius: 8px;" placeholder="Special requests, notes..."></textarea>
                    </div>
                    
                    <!-- Sync to Channel Manager -->
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                        <input type="checkbox" id="booking-sync-cm" checked style="width: 18px; height: 18px;">
                        <label for="booking-sync-cm" style="font-weight: 500;">Sync to Channel Manager (Beds24/Hostaway)</label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addBookingModal')">Cancel</button>
                        <button type="submit" class="btn" style="background: #4f46e5;">Create Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content" style="max-width: 650px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 id="account-modal-title" class="modal-title" style="margin: 0;">Edit Account</h3>
                    <div id="account-modal-subtitle" style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;"></div>
                </div>
                <button class="modal-close" onclick="closeModal('accountModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1rem; max-height: 70vh; overflow-y: auto;">
                <form id="account-form" onsubmit="saveAccount(event)">
                    <input type="hidden" id="edit-account-id">
                    <input type="hidden" id="account-code">
                    <input type="hidden" id="account-role">
                    <input type="hidden" id="account-status">
                    
                    <!-- Account Info Banner -->
                    <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #bae6fd;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <!-- Code (Read-Only) -->
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: #0369a1; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Code</div>
                                <div id="account-code-display" style="font-weight: 700; font-family: monospace; color: #0c4a6e; font-size: 1.1rem;"></div>
                            </div>
                            <!-- Role (Editable for Master Admin) -->
                            <div>
                                <div style="font-size: 0.7rem; color: #0369a1; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem; text-align: center;">Role</div>
                                <div id="account-role-display-container" style="text-align: center; font-weight: 600; color: #0c4a6e;"></div>
                                <select id="account-role-select" class="form-input" style="display: none; padding: 0.4rem; font-size: 0.85rem;">
                                    <option value="admin"> Admin</option>
                                    <option value="submaster_admin"> Sub Master</option>
                                    <option value="agency_admin"> Agency Admin</option>
                                    <option value="master_admin"> Master Admin</option>
                                </select>
                            </div>
                            <!-- Status (Editable for Master Admin) -->
                            <div>
                                <div style="font-size: 0.7rem; color: #0369a1; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem; text-align: center;">Status</div>
                                <div id="account-status-display-container" style="text-align: center; font-weight: 600; color: #0c4a6e;"></div>
                                <select id="account-status-select" class="form-input" style="display: none; padding: 0.4rem; font-size: 0.85rem;">
                                    <option value="active"> Active</option>
                                    <option value="inactive"> Inactive</option>
                                    <option value="pending"> Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Business Details Section -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #e2e8f0;">
                        <h4 style="margin: 0 0 1rem 0; font-size: 0.85rem; color: #475569; font-weight: 600;"> Business Details</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Business Name *</label>
                                <input type="text" id="account-name" class="form-input" required placeholder="e.g., Elevate Stays" style="padding: 0.5rem;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Contact Name</label>
                                <input type="text" id="account-contact-name" class="form-input" placeholder="e.g., John Smith" style="padding: 0.5rem;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Email</label>
                                <input type="email" id="account-email" class="form-input" placeholder="contact@example.com" style="padding: 0.5rem;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Phone</label>
                                <input type="tel" id="account-phone" class="form-input" placeholder="+1 234 567 8900" style="padding: 0.5rem;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Business Address Section -->
                    <div style="background: #fafafa; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #e5e5e5;">
                        <h4 style="margin: 0 0 1rem 0; font-size: 0.85rem; color: #525252; font-weight: 600;"> Business Address</h4>
                        
                        <div class="form-group" style="margin: 0 0 0.75rem 0;">
                            <label style="font-size: 0.8rem;">Address Line 1</label>
                            <input type="text" id="account-address1" class="form-input" placeholder="Street address" style="padding: 0.5rem;">
                        </div>
                        
                        <div class="form-group" style="margin: 0 0 0.75rem 0;">
                            <label style="font-size: 0.8rem;">Address Line 2</label>
                            <input type="text" id="account-address2" class="form-input" placeholder="Apartment, suite, etc." style="padding: 0.5rem;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">City</label>
                                <input type="text" id="account-city" class="form-input" placeholder="City" style="padding: 0.5rem;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Region</label>
                                <input type="text" id="account-region" class="form-input" placeholder="Region" style="padding: 0.5rem;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Postcode</label>
                                <input type="text" id="account-postcode" class="form-input" placeholder="Postcode" style="padding: 0.5rem;">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 0.8rem;">Country</label>
                            <input type="text" id="account-country" class="form-input" placeholder="Country" style="padding: 0.5rem;">
                        </div>
                    </div>
                    
                    <!-- Security Section -->
                    <div style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #fde047;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.25rem 0; font-size: 0.85rem; color: #854d0e; font-weight: 600;"> Security</h4>
                                <div style="font-size: 0.8rem; color: #a16207;">Set a new password for this account</div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="resetPasswordFromModal()" style="white-space: nowrap; font-size: 0.85rem;">
                                 Reset Password
                            </button>
                        </div>
                    </div>
                    
                    <!-- Agency Management Section (only for admin/submaster) -->
                    <div id="account-agency-section" style="display: none;">
                        <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #d8b4fe;">
                            <h4 style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: #6b21a8; font-weight: 600;"> Agency Management</h4>
                            <div id="account-agency-status">
                                <!-- Filled dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Travel Agent Access Section - Hidden until feature complete -->
                    
                    <!-- Form Actions -->
                    <div style="display: flex; gap: 0.75rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('accountModal')">Cancel</button>
                        <button type="submit" class="btn">ðŸ’¾ Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Booking Modal -->
    <div id="viewBookingModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;"> Booking Details</h3>
                    <p id="view-booking-ref" style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Reference #</p>
                </div>
                <button class="modal-close" onclick="closeModal('viewBookingModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0; max-height: 75vh; overflow-y: auto;">
                
                <!-- Status Bar -->
                <div id="view-booking-status-bar" style="display: flex; gap: 1rem; padding: 1rem 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                    <div id="view-booking-status"></div>
                    <div id="view-payment-status"></div>
                </div>
                
                <!-- Alert Banner (if any issues) -->
                <div id="view-booking-alert" style="display: none; padding: 1rem 1.5rem; background: #fef3c7; border-bottom: 1px solid #fde68a;">
                    <span style="font-weight: 600; color: #92400e;"> <span id="view-booking-alert-text"></span></span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                    
                    <!-- Left Column -->
                    <div style="padding: 1.5rem; border-right: 1px solid #e2e8f0;">
                        
                        <!-- Guest Info -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;"></span> Guest Information
                            </h4>
                            <div style="background: #f8fafc; border-radius: 12px; padding: 1rem;">
                                <div style="font-size: 1.1rem; font-weight: 600; color: #1e293b;" id="view-guest-name">-</div>
                                <div style="margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; color: #64748b; font-size: 0.9rem;">
                                        <span></span> <span id="view-guest-email">-</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; color: #64748b; font-size: 0.9rem;">
                                        <span></span> <span id="view-guest-phone">-</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; color: #64748b; font-size: 0.9rem;">
                                        <span></span> <span id="view-guest-country">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stay Details -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;"></span> Stay Details
                            </h4>
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 1rem;">
                                <div style="font-weight: 600; color: #166534; margin-bottom: 0.75rem;" id="view-property-name">-</div>
                                <div style="color: #374151; margin-bottom: 0.75rem;" id="view-room-name">-</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">Check-in</div>
                                        <div style="font-weight: 600; color: #1e293b;" id="view-checkin">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">Check-out</div>
                                        <div style="font-weight: 600; color: #1e293b;" id="view-checkout">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">Nights</div>
                                        <div style="font-weight: 600; color: #1e293b;" id="view-nights">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">Guests</div>
                                        <div style="font-weight: 600; color: #1e293b;" id="view-guests">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div>
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;"></span> Notes
                            </h4>
                            <div style="background: #f8fafc; border-radius: 12px; padding: 1rem; color: #64748b; font-size: 0.9rem;" id="view-notes">
                                No notes
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Right Column -->
                    <div style="padding: 1.5rem;">
                        
                        <!-- Financials -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;"></span> Financials
                            </h4>
                            <div style="background: #fffbeb; border-radius: 12px; padding: 1rem; border: 1px solid #fde68a;">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Accommodation</span>
                                    <span style="font-weight: 500;" id="view-accommodation">0.00</span>
                                </div>
                                <div id="view-upsells-row" style="display: none; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Extras/Upsells</span>
                                    <span style="font-weight: 500;" id="view-upsells">0.00</span>
                                </div>
                                <div id="view-discount-row" style="display: none; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Discount</span>
                                    <span style="font-weight: 500; color: #16a34a;" id="view-discount">-0.00</span>
                                </div>
                                <div id="view-tax-row" style="display: none; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Tax</span>
                                    <span style="font-weight: 500;" id="view-tax">0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; margin-top: 0.5rem; border-top: 2px solid #d97706;">
                                    <span style="font-weight: 700; color: #1e293b;">Total</span>
                                    <span style="font-weight: 700; font-size: 1.25rem; color: #d97706;" id="view-total">0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Summary -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;"></span> Payment Summary
                            </h4>
                            <div style="background: #f0f9ff; border-radius: 12px; padding: 1rem; border: 1px solid #bae6fd;">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Deposit Paid</span>
                                    <span style="font-weight: 500; color: #16a34a;" id="view-deposit-paid">0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Balance Due</span>
                                    <span style="font-weight: 600; color: #dc2626;" id="view-balance-due">0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.85rem;">
                                    <span style="color: #64748b;">Due Date</span>
                                    <span style="color: #374151;" id="view-due-date">At check-in</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Channel Manager Info -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;"></span> Channel Manager
                            </h4>
                            <div style="background: #f8fafc; border-radius: 12px; padding: 1rem; font-size: 0.9rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                    <span style="color: #64748b;">Source</span>
                                    <span style="font-weight: 500;" id="view-booking-source">Direct</span>
                                </div>
                                <div id="view-beds24-row" style="display: none; justify-content: space-between; padding: 0.25rem 0;">
                                    <span style="color: #64748b;">Beds24 ID</span>
                                    <span style="font-weight: 500;" id="view-beds24-id">-</span>
                                </div>
                                <div id="view-hostaway-row" style="display: none; justify-content: space-between; padding: 0.25rem 0;">
                                    <span style="color: #64748b;">Hostaway ID</span>
                                    <span style="font-weight: 500;" id="view-hostaway-id">-</span>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Actions Footer -->
                <div style="padding: 1.5rem; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="generateInvoice(currentViewingBookingId)" class="btn" style="background: #0ea5e9; display: flex; align-items: center; gap: 0.5rem;">
                        <span></span> Generate Invoice
                    </button>
                    <button onclick="sendPaymentReceipt(currentViewingBookingId)" class="btn" style="background: #8b5cf6; display: flex; align-items: center; gap: 0.5rem;">
                        <span></span> Send Receipt
                    </button>
                    <button onclick="processRefund(currentViewingBookingId)" class="btn" style="background: #f59e0b; display: flex; align-items: center; gap: 0.5rem;">
                        <span></span> Process Refund
                    </button>
                    <button onclick="cancelBooking(currentViewingBookingId)" class="btn" style="background: #ef4444; display: flex; align-items: center; gap: 0.5rem;">
                        <span></span> Cancel Booking
                    </button>
                </div>
                
            </div>
        </div>
    </div>

    <div id="editPropertyModal" class="modal">
        <div class="modal-content" style="max-width: 800px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 class="modal-title" style="margin: 0;">ðŸ  Edit Property</h3>
                <button class="modal-close" onclick="closeModal('editPropertyModal')" style="color: white;"></button>
            </div>
            <form id="editPropertyForm" onsubmit="return saveProperty(event)">
                <input type="hidden" id="edit-property-id">
                
                <!-- Master Admin: Account Assignment -->
                <div id="property-account-section" style="display: none; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;"> Admin: Account Assignment</h4>
                    <div class="form-group">
                        <label class="form-label">Assign to Account</label>
                        <select class="form-input" id="edit-property-account-id">
                            <option value="">Loading accounts...</option>
                        </select>
                        <small style="color: #64748b;">Master admin only - move this property to a different account</small>
                    </div>
                </div>
                
                <!-- Basic Info Section -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">Basic Information</h4>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Property Name *</label>
                        <input type="text" class="form-input" id="edit-property-name" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Property Type</label>
                            <select class="form-input" id="edit-property-type">
                                <option value="hotel">Hotel</option>
                                <option value="apartment">Apartment</option>
                                <option value="house">House</option>
                                <option value="townhouse">Townhouse</option>
                                <option value="condo">Condo</option>
                                <option value="bedAndBreakfast">Bed & Breakfast</option>
                                <option value="hostel">Hostel</option>
                                <option value="villa">Villa</option>
                                <option value="cottage">Cottage</option>
                                <option value="cabin">Cabin</option>
                                <option value="bungalow">Bungalow</option>
                                <option value="chalet">Chalet</option>
                                <option value="farmhouse">Farmhouse</option>
                                <option value="loft">Loft</option>
                                <option value="penthouse">Penthouse</option>
                                <option value="guesthouse">Guesthouse</option>
                                <option value="resort">Resort</option>
                                <option value="motel">Motel</option>
                                <option value="vacation_rental">Vacation Rental</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-input" id="edit-property-status">
                                <option value="active">Active</option>
                                <option value="draft">Draft</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Address Section -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;"> Address & Location</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Street Address</label>
                            <input type="text" class="form-input" id="edit-property-address" placeholder="123 High Street">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City / Town</label>
                            <input type="text" class="form-input" id="edit-property-city" placeholder="London">
                        </div>
                        <div class="form-group">
                            <label class="form-label">District / Area</label>
                            <input type="text" class="form-input" id="edit-property-district" placeholder="Westminster">
                        </div>
                        <div class="form-group">
                            <label class="form-label">State / County / Region</label>
                            <input type="text" class="form-input" id="edit-property-state" placeholder="Greater London">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Postcode / ZIP</label>
                            <input type="text" class="form-input" id="edit-property-zipcode" placeholder="SW1A 1AA">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Country</label>
                            <select class="form-input" id="edit-property-country" onchange="autoSetCurrencyFromCountry()">
                                <option value="">Select country...</option>
                                <option value="GB"> United Kingdom</option>
                                <option value="US"> United States</option>
                                <option value="CH"> Switzerland</option>
                                <option value="DE"> Germany</option>
                                <option value="FR"> France</option>
                                <option value="IT"> Italy</option>
                                <option value="ES"> Spain</option>
                                <option value="NL"> Netherlands</option>
                                <option value="AT"> Austria</option>
                                <option value="PT"> Portugal</option>
                                <option value="BE"> Belgium</option>
                                <option value="IE"> Ireland</option>
                                <option value="AU"> Australia</option>
                                <option value="NZ"> New Zealand</option>
                                <option value="CA"> Canada</option>
                                <option value="AE"> UAE</option>
                                <option value="JP"> Japan</option>
                                <option value="TH"> Thailand</option>
                                <option value="GR"> Greece</option>
                                <option value="HR"> Croatia</option>
                                <option value="CZ"> Czech Republic</option>
                                <option value="PL"> Poland</option>
                                <option value="HU"> Hungary</option>
                                <option value="SE"> Sweden</option>
                                <option value="NO"> Norway</option>
                                <option value="DK"> Denmark</option>
                                <option value="FI"> Finland</option>
                                <option value="ID"> Indonesia</option>
                                <option value="MY"> Malaysia</option>
                                <option value="SG"> Singapore</option>
                                <option value="PH"> Philippines</option>
                                <option value="VN"> Vietnam</option>
                                <option value="IN"> India</option>
                                <option value="ZA"> South Africa</option>
                                <option value="MX"> Mexico</option>
                                <option value="BR"> Brazil</option>
                                <option value="AR"> Argentina</option>
                                <option value="CO"> Colombia</option>
                                <option value="TR"> Turkey</option>
                                <option value="EG"> Egypt</option>
                                <option value="MA"> Morocco</option>
                                <option value="KE"> Kenya</option>
                                <option value="MU"> Mauritius</option>
                                <option value="MV"> Maldives</option>
                                <option value="LK"> Sri Lanka</option>
                                <option value="CN"> China</option>
                                <option value="KR"> South Korea</option>
                                <option value="TW"> Taiwan</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Coordinates Section -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;"> Map Coordinates</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Latitude</label>
                            <input type="text" class="form-input" id="edit-property-latitude" placeholder="51.5074">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Longitude</label>
                            <input type="text" class="form-input" id="edit-property-longitude" placeholder="-0.1278">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="geocodePropertyAddress()" style="height: 42px;">
                             Lookup
                        </button>
                    </div>
                    <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">
                        Coordinates are used for map display on your booking site.
                    </p>
                    
                    <!-- Mini Map Preview -->
                    <div id="property-map-preview" style="margin-top: 1rem; height: 200px; background: #e5e7eb; border-radius: 8px; display: none; position: relative; overflow: hidden;">
                        <div id="property-map-container" style="width: 100%; height: 100%;"></div>
                        <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">
                            Click map to set coordinates
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="togglePropertyMap()" style="margin-top: 0.5rem; font-size: 0.85rem;" id="toggle-map-btn">
                         Show Map
                    </button>
                </div>
                
                <!-- Stripe Payment Connection -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">ðŸ’³ Stripe Payment Connection</h4>
                    <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">Connect Stripe to receive payments. <a href="https://dashboard.stripe.com/apikeys" target="_blank" style="color: var(--accent);">Get your API Keys</a> - create a Restricted Key with: <strong>Charges, Payment Intents, Customers, Refunds</strong> (Write access).</p>
                    
                    <div id="property-stripe-status" style="padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; background: #f1f5f9;">
                        <span style="color: #64748b;">Checking Stripe status...</span>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Stripe Account Name</label>
                        <input type="text" class="form-input" id="edit-property-stripe-name" placeholder="e.g. Main Account, Beach Villas, etc.">
                        <small style="color: #64748b;">A friendly name to identify this Stripe account</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Restricted Secret Key</label>
                        <input type="password" class="form-input" id="edit-property-stripe-secret" placeholder="rk_live_... (from Stripe Dashboard â†’ API Keys â†’ Restricted Keys)">
                        <small style="color: #64748b;">Create a Restricted Key in Stripe with the permissions listed above</small>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                    <button type="button" class="btn" style="background: var(--error); border-color: #ef4444;" onclick="deleteProperty()">
                         Delete Property
                    </button>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editPropertyModal')">Cancel</button>
                        <button type="submit" class="btn">ðŸ’¾ Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Stripe Setup Modal -->
    <div id="bulkStripeModal" class="modal">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 class="modal-title" style="margin: 0;">ðŸ’³ Bulk Stripe Setup</h3>
                <button class="modal-close" onclick="closeModal('bulkStripeModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p style="color: #64748b; margin-bottom: 1.5rem;">Apply Stripe keys to multiple properties at once. Select the properties and enter your <a href="https://dashboard.stripe.com/apikeys" target="_blank" style="color: var(--accent);">Restricted API Keys</a>.</p>
                
                <!-- Stripe Keys Input -->
                <div style="background: #f8fafc; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid #e2e8f0;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #1e293b;">Stripe Restricted Key</h4>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Stripe Account Name</label>
                        <input type="text" class="form-input" id="bulk-stripe-name" placeholder="e.g. Main Account, Beach Villas, etc.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Restricted Secret Key</label>
                        <input type="password" class="form-input" id="bulk-stripe-secret" placeholder="rk_live_... (from Stripe Dashboard â†’ API Keys â†’ Restricted Keys)">
                    </div>
                </div>
                
                <!-- Property Selection -->
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h4 style="margin: 0; font-size: 0.9rem; color: #1e293b;">Select Properties</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-secondary btn-small" onclick="selectAllBulkStripeProperties(true)">Select All</button>
                            <button type="button" class="btn btn-secondary btn-small" onclick="selectAllBulkStripeProperties(false)">Deselect All</button>
                        </div>
                    </div>
                    <div id="bulk-stripe-properties" style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.5rem;">
                        <p style="color: #64748b; padding: 1rem; text-align: center;">Loading properties...</p>
                    </div>
                </div>
                
                <div id="bulk-stripe-selected-count" style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">
                    0 properties selected
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bulkStripeModal')">Cancel</button>
                    <button type="button" class="btn" onclick="applyBulkStripe()">ðŸ’³ Apply to Selected Properties</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Settings Modal -->
    <div id="paymentSettingsModal" class="modal">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;"> Payment Settings</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;" id="payment-settings-property-name"></p>
                </div>
                <button class="modal-close" onclick="closeModal('paymentSettingsModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <input type="hidden" id="payment-settings-property-id">
                <input type="hidden" id="payment-settings-account-id">
                
                <!-- Payment Provider Selection -->
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid #c7d2fe;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem; color: #4338ca;"> Payment Provider</h4>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- Stripe -->
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;" id="provider-stripe-label">
                            <input type="radio" name="payment-provider" value="stripe" id="payment-provider-stripe" style="width: 18px; height: 18px;" checked>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/ba/Stripe_Logo%2C_revised_2016.svg" alt="Stripe" style="height: 24px;">
                            <span style="flex: 1; font-weight: 500;">Stripe</span>
                            <span style="font-size: 0.75rem; background: #10b981; color: white; padding: 0.15rem 0.5rem; border-radius: 10px;">Recommended</span>
                        </label>
                        
                        <!-- PayPal -->
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid transparent; opacity: 0.5;" id="provider-paypal-label">
                            <input type="radio" name="payment-provider" value="paypal" id="payment-provider-paypal" style="width: 18px; height: 18px;" disabled>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" style="height: 24px;">
                            <span style="flex: 1; font-weight: 500;">PayPal</span>
                            <span style="font-size: 0.75rem; background: #94a3b8; color: white; padding: 0.15rem 0.5rem; border-radius: 10px;">Coming Soon</span>
                        </label>
                        
                        <!-- Airwallex -->
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid transparent; opacity: 0.5;" id="provider-airwallex-label">
                            <input type="radio" name="payment-provider" value="airwallex" id="payment-provider-airwallex" style="width: 18px; height: 18px;" disabled>
                            <span style="font-weight: 600; color: #e11d48;">Airwallex</span>
                            <span style="flex: 1;"></span>
                            <span style="font-size: 0.75rem; background: #94a3b8; color: white; padding: 0.15rem 0.5rem; border-radius: 10px;">Coming Soon</span>
                        </label>
                    </div>
                </div>
                
                <!-- Stripe API Keys Section -->
                <div id="stripe-keys-section" style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; font-size: 0.95rem;"> Stripe API Keys</h4>
                        <a href="https://dashboard.stripe.com/apikeys" target="_blank" style="font-size: 0.8rem; color: var(--accent);">
                            Get keys from Stripe Dashboard 
                        </a>
                    </div>
                    
                    <div id="stripe-keys-status" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 8px; display: none;">
                        <!-- Status will be shown here -->
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Publishable Key</label>
                        <input type="text" class="form-input" id="stripe-publishable-key" placeholder="pk_live_... or pk_test_...">
                        <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                            Starts with pk_live_ (production) or pk_test_ (testing)
                        </p>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Secret Key</label>
                        <input type="password" class="form-input" id="stripe-secret-key" placeholder="sk_live_... or sk_test_...">
                        <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                            Starts with sk_live_ (production) or sk_test_ (testing)
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="testStripeConnection()" style="font-size: 0.85rem;">
                             Test Connection
                        </button>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto; font-size: 0.85rem;">
                            <input type="checkbox" id="stripe-test-mode" style="width: 16px; height: 16px;">
                            Test Mode
                        </label>
                    </div>
                </div>
                
                <!-- Generate Setup Link (for property owners) -->
                <div style="background: #fef3c7; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #fcd34d;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem;"></span>
                        <div style="flex: 1;">
                            <strong style="font-size: 0.9rem;">Need to send to property owner?</strong>
                            <p style="font-size: 0.8rem; color: #92400e; margin: 0.25rem 0 0 0;">
                                Generate a secure link they can use to enter their own Stripe keys
                            </p>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="generatePaymentSetupLink()" style="font-size: 0.8rem; white-space: nowrap;">
                             Generate Link
                        </button>
                    </div>
                    <div id="setup-link-result" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: white; border-radius: 8px;">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="text" id="setup-link-url" class="form-input" readonly style="flex: 1; font-size: 0.8rem;">
                            <button type="button" class="btn btn-small" onclick="copySetupLink()" style="font-size: 0.75rem;"> Copy</button>
                        </div>
                        <p style="font-size: 0.75rem; color: #92400e; margin: 0.5rem 0 0 0;">
                            Link expires in 72 hours
                        </p>
                    </div>
                </div>
                
                <!-- Deposit Settings -->
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem;"> Deposit Settings</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Deposit Type</label>
                            <select id="payment-deposit-type" class="form-input">
                                <option value="percentage">Percentage of total</option>
                                <option value="fixed">Fixed amount</option>
                                <option value="full">Full payment required</option>
                                <option value="none">No deposit</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Deposit Amount</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="number" id="payment-deposit-amount" class="form-input" value="25" min="0" step="0.01">
                                <span id="payment-deposit-symbol" style="font-weight: 500;">%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1rem; margin-bottom: 0;">
                        <label>Balance Due (days before arrival)</label>
                        <input type="number" id="payment-balance-days" class="form-input" value="14" min="0" style="max-width: 150px;">
                        <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
                            0 = balance due on arrival
                        </p>
                    </div>
                </div>
                
                <!-- Currency -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Currency</label>
                    <select id="payment-currency" class="form-input" style="max-width: 200px;">
                        <option value="GBP"> GBP ()</option>
                        <option value="USD"> USD ($)</option>
                        <option value="EUR"> EUR ()</option>
                        <option value="CHF"> CHF</option>
                    </select>
                </div>
                
                <!-- Cancellation Policy -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Cancellation Policy (Optional)</label>
                    <textarea id="payment-cancellation" class="form-input" rows="3" placeholder="e.g., Free cancellation up to 48 hours before check-in. 50% refund for cancellations made 24-48 hours before. No refund for cancellations less than 24 hours before check-in."></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentSettingsModal')">Cancel</button>
                    <button type="button" class="btn" onclick="savePaymentSettings()">ðŸ’¾ Save Payment Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Room Modal -->
    <div id="editRoomModal" class="modal">
        <div class="modal-content" style="border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 class="modal-title" style="margin: 0;"> Edit Room</h3>
                <button class="modal-close" onclick="closeModal('editRoomModal')" style="color: white;"></button>
            </div>
            <form id="editRoomForm" onsubmit="return saveRoom(event)">
                <input type="hidden" id="edit-room-id">
                
                <!-- CM Data (reference) -->
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;"> From Channel Manager</div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Original Room Name</label>
                        <input type="text" class="form-input" id="edit-room-name" readonly style="background: var(--bg-primary);">
                    </div>
                </div>
                
                <!-- Display Name for Website -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label"> Display Name (shown on website)</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="edit-room-display-name" placeholder="Leave blank to use original name" style="flex: 1;">
                        <button type="button" class="btn" onclick="generateRoomDisplayName()" style="white-space: nowrap; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                             Generate
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">
                        AI-generated marketing-friendly name for your booking website
                    </div>
                </div>
                
                <!-- Short Description -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label"> Short Description</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="edit-room-short-description" placeholder="Brief tagline for listings" style="flex: 1;" maxlength="150">
                        <button type="button" class="btn" onclick="generateRoomShortDescription()" style="white-space: nowrap; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                             Generate
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">
                        Short tagline shown in search results (max 150 chars)
                    </div>
                </div>
                
                <!-- Full Description -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label"> Full Description</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <textarea class="form-input" id="edit-room-full-description" rows="4" placeholder="Detailed room description for the booking page"></textarea>
                        <button type="button" class="btn" onclick="generateRoomFullDescription()" style="align-self: flex-end; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                             Generate Full Description
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">
                        Detailed description shown on the room booking page
                    </div>
                </div>
                
                <!-- GAS Controls -->
                <div style="font-size: 0.75rem; color: var(--accent); margin-bottom: 0.5rem;"> GAS Controls</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Room Type</label>
                        <select class="form-input" id="edit-room-type">
                            <option value="single">Single</option>
                            <option value="double">Double</option>
                            <option value="twin">Twin</option>
                            <option value="triple">Triple</option>
                            <option value="quad">Quad</option>
                            <option value="suite">Suite</option>
                            <option value="studio">Studio</option>
                            <option value="apartment">Apartment</option>
                            <option value="house">House</option>
                            <option value="townhouse">Townhouse</option>
                            <option value="villa">Villa</option>
                            <option value="cottage">Cottage</option>
                            <option value="cabin">Cabin</option>
                            <option value="condo">Condo</option>
                            <option value="bungalow">Bungalow</option>
                            <option value="loft">Loft</option>
                            <option value="penthouse">Penthouse</option>
                            <option value="chalet">Chalet</option>
                            <option value="farmhouse">Farmhouse</option>
                            <option value="dormitory">Dormitory</option>
                            <option value="family">Family Room</option>
                            <option value="entire_home">Entire Home</option>
                            <option value="private_room">Private Room</option>
                            <option value="shared_room">Shared Room</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="edit-room-status">
                            <option value="available"> Available</option>
                            <option value="unavailable"> Unavailable</option>
                            <option value="maintenance"> Maintenance</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Max Guests</label>
                        <input type="number" class="form-input" id="edit-room-maxguests" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Adults</label>
                        <input type="number" class="form-input" id="edit-room-maxadults" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Children</label>
                        <input type="number" class="form-input" id="edit-room-maxchildren" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-input" id="edit-room-quantity" min="1">
                    </div>
                </div>
                
                <!-- Note about amenities -->
                <div style="background: #e0f2fe; border: 1px solid #0ea5e9; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <p style="margin: 0; color: #0369a1;">
                         <strong>Amenities:</strong> Manage room amenities from the <a href="#" onclick="closeModal('editRoomModal'); showView('amenities'); return false;" style="color: #0369a1; text-decoration: underline;">Amenities page</a>
                    </p>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem;">
                    <button type="button" class="btn" style="background: var(--error); border-color: #ef4444;" onclick="deleteRoom()">
                        Delete Room
                    </button>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editRoomModal')">Cancel</button>
                        <button type="submit" class="btn">ðŸ’¾ Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Occupancy Settings Modal -->
    <div id="occupancySettingsModal" class="modal">
        <div class="modal-content" style="max-width: 550px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;"> Occupancy Pricing Settings</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;" id="occupancy-room-name"></p>
                </div>
                <button class="modal-close" onclick="closeModal('occupancySettingsModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <input type="hidden" id="occupancy-room-id">
                
                <!-- Pricing Mode Toggle -->
                <div style="background: #f5f3ff; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" id="occupancy-enabled" style="width: 22px; height: 22px; accent-color: #7c3aed;">
                        <div>
                            <strong style="font-size: 1rem;">Enable Occupancy Pricing</strong>
                            <p style="font-size: 0.8rem; color: #6b7280; margin: 0.25rem 0 0 0;">
                                Charge different rates based on number of guests
                            </p>
                        </div>
                    </label>
                </div>
                
                <div id="occupancy-settings-fields">
                    <!-- Base Occupancy -->
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label class="form-label">Base Occupancy (included in standard price)</label>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <select id="occupancy-base" class="form-input" style="max-width: 100px;">
                                <!-- Options populated dynamically based on max_guests -->
                            </select>
                            <span style="font-size: 0.85rem; color: #6b7280;">Max guests: <span id="occupancy-max-guests">4</span></span>
                        </div>
                    </div>
                    
                    <!-- Single Occupancy Discount -->
                    <div id="single-discount-section" style="background: #f0fdf4; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                        <label class="form-label" style="color: #166534; margin-bottom: 0.75rem;"> Single Occupancy Discount</label>
                        <div id="single-discount-fields" style="display: flex; align-items: center; gap: 0.5rem;">
                            <select id="single-discount-type" class="form-input" style="width: 120px;">
                                <option value="fixed">Fixed ()</option>
                                <option value="percent">Percent (%)</option>
                            </select>
                            <input type="number" id="single-discount-value" class="form-input" value="0" min="0" style="width: 80px;">
                            <span style="font-size: 0.85rem; color: #166534;">off per night</span>
                        </div>
                        <p id="single-discount-disabled-msg" style="display: none; margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #6b7280; font-style: italic;">
                             Not applicable when base occupancy is 1 (can't book 0 guests)
                        </p>
                    </div>
                    
                    <!-- Extra Adult Charge -->
                    <div id="extra-adult-section" style="background: #fef2f2; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                        <label class="form-label" style="color: #991b1b; margin-bottom: 0.75rem;"> Extra Adult Charge</label>
                        <div id="extra-adult-fields" style="display: flex; align-items: center; gap: 0.5rem;">
                            <select id="extra-adult-type" class="form-input" style="width: 120px;">
                                <option value="fixed">Fixed ()</option>
                                <option value="percent">Percent (%)</option>
                            </select>
                            <input type="number" id="extra-adult-charge" class="form-input" value="0" min="0" style="width: 80px;">
                            <span style="font-size: 0.85rem; color: #991b1b;">per extra adult/night</span>
                        </div>
                        <p id="extra-adult-disabled-msg" style="display: none; margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #6b7280; font-style: italic;">
                             Not applicable when base occupancy equals max guests
                        </p>
                    </div>
                    
                    <!-- Children Allowed Toggle -->
                    <div style="background: #f0f9ff; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; border: 1px solid #bae6fd;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                            <input type="checkbox" id="children-allowed" checked style="width: 20px; height: 20px; accent-color: #0284c7;">
                            <div>
                                <strong style="color: #0369a1;">Allow Children</strong>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0.15rem 0 0 0;">
                                    Uncheck to hide children selector on booking widget
                                </p>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Child Charge -->
                    <div id="child-charge-section" style="background: #eff6ff; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                        <label class="form-label" style="color: #1e40af; margin-bottom: 0.75rem;"> Child Charge <span style="font-size: 0.75rem; font-weight: normal;">(under <span id="child-max-age-display">12</span> years)</span></label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <select id="child-charge-type" class="form-input" style="width: 120px;">
                                <option value="free">Free</option>
                                <option value="fixed">Fixed ()</option>
                                <option value="percent">Percent (%)</option>
                            </select>
                            <input type="number" id="child-charge" class="form-input" value="0" min="0" style="width: 80px;" disabled>
                            <span style="font-size: 0.85rem; color: #1e40af;">per child/night</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('occupancySettingsModal')">Cancel</button>
                    <button type="button" class="btn" style="background: #7c3aed; border-color: #7c3aed;" onclick="saveOccupancySettings()">ðŸ’¾ Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Amenity Modal -->
    <div id="addAmenityModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 class="modal-title" style="margin: 0;"> Manage Amenities</h3>
                <button class="modal-close" onclick="closeModal('addAmenityModal')" style="color: white;"></button>
            </div>
            <div class="modal-body">
                <!-- Category Selection -->
                <div class="form-group">
                    <label class="form-label">Select Category</label>
                    <select class="form-input" id="amenity-category-select" onchange="loadCategoryAmenities()">
                        <option value="">Choose a category...</option>
                    </select>
                </div>
                
                <!-- Current Amenities in Category -->
                <div id="category-amenities-list" style="display: none; margin: 1.5rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <h4 style="margin-bottom: 1rem;">Current Amenities</h4>
                    <div id="amenities-in-category" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <!-- Amenities will be loaded here -->
                    </div>
                </div>
                
                <!-- Add New Amenity Section -->
                <div id="add-amenity-section" style="display: none; border-top: 1px solid #e2e8f0; padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Add New Amenity to this Category</h4>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Amenity Name</label>
                            <input type="text" class="form-input" id="new-amenity-name" placeholder="e.g., Smart TV" oninput="autoSuggestIcon()">
                        </div>
                        <div class="form-group" style="width: 80px; margin-bottom: 0;">
                            <label class="form-label">Icon</label>
                            <input type="text" class="form-input" id="new-amenity-icon" placeholder="" maxlength="4" style="font-size: 1.5rem; text-align: center;">
                        </div>
                        <button class="btn" onclick="addAmenityToCategory()" style="height: 42px;">Add</button>
                    </div>
                </div>
                
                <!-- Create New Category Section -->
                <div style="border-top: 1px solid #e2e8f0; padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Or Create New Category</h4>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Category Name</label>
                            <input type="text" class="form-input" id="new-category-name" placeholder="e.g., Pet Friendly">
                        </div>
                        <button class="btn btn-secondary" onclick="createNewCategory()" style="height: 42px;">Create Category</button>
                    </div>
                </div>
                
                <!-- Danger Zone -->
                <div style="border-top: 1px solid var(--error); padding-top: 1.5rem; margin-top: 2rem; background: rgba(239, 68, 68, 0.05); padding: 1rem; border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem; color: #ef4444;"> Danger Zone</h4>
                    <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">These actions cannot be undone.</p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="deleteAllInCategory()" style="background: var(--error); border-color: #ef4444;">
                             Delete All in Selected Category
                        </button>
                        <button class="btn" onclick="deleteAllAmenities()" style="background: #7f1d1d; border-color: #7f1d1d;">
                             Delete ALL Amenities
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; text-align: right;">
                    <button class="btn btn-secondary" onclick="closeModal('addAmenityModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Turbine Post Modal -->
    <div id="createPostModal" class="modal">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">ðŸ“ Create Social Media Post</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Promote your offer across social media channels</p>
                </div>
                <button class="modal-close" onclick="closeModal('createPostModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                
                <!-- Step 1: Select Offer -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                        1ï¸âƒ£ Select Offer to Promote
                    </label>
                    <select id="post-offer-select" class="form-input" onchange="loadOfferDetails()">
                        <option value="">Choose an offer...</option>
                    </select>
                    <div id="post-offer-details" style="display: none; margin-top: 0.75rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong id="post-offer-name" style="color: #1e293b;"></strong>
                                <p id="post-offer-discount" style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #10b981;"></p>
                            </div>
                            <span id="post-offer-dates" style="font-size: 0.8rem; color: #64748b;"></span>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Select GAS Lite -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                        2ï¸âƒ£ Select Landing Page (GAS Lite)
                    </label>
                    <select id="post-lite-select" class="form-input">
                        <option value="">Choose a GAS Lite...</option>
                    </select>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #64748b;">
                        This is where people will land when they click your post
                    </p>
                </div>

                <!-- Step 3: Post Content -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                        3ï¸âƒ£ Post Content
                    </label>
                    <textarea id="post-content" class="form-input" rows="4" placeholder="Write your post content here... Use emojis to make it engaging! ðŸ–ï¸âœ¨" style="resize: vertical;"></textarea>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="generatePostContent()" style="font-size: 0.85rem; padding: 0.4rem 0.75rem;">
                            âœ¨ AI Generate
                        </button>
                        <span id="post-char-count" style="font-size: 0.8rem; color: #64748b;">0 / 280</span>
                    </div>
                </div>

                <!-- Step 4: Select Platforms -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; color: #374151; margin-bottom: 0.75rem; display: block;">
                        4ï¸âƒ£ Post To
                    </label>
                    <div id="post-platforms-list" style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                        <div style="text-align: center; padding: 1rem; color: #64748b; width: 100%;">
                            No social media accounts connected.<br>
                            <a href="#" onclick="navClick(document.querySelector('[data-view=turbine-connections]'), 'turbine-connections'); closeModal('createPostModal'); return false;" style="color: #3b82f6;">Connect accounts first â†’</a>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Schedule -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <label style="font-weight: 600; color: #374151; margin-bottom: 0.75rem; display: block;">
                        5ï¸âƒ£ When to Post
                    </label>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="post-timing" value="now" checked>
                            <span>Post Now</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="post-timing" value="schedule">
                            <span>Schedule</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="post-timing" value="draft">
                            <span>Save as Draft</span>
                        </label>
                    </div>
                    <div id="post-schedule-datetime" style="display: none; margin-top: 1rem;">
                        <input type="datetime-local" id="post-scheduled-at" class="form-input" style="max-width: 250px;">
                    </div>
                </div>

                <!-- Actions -->
                <div style="display: flex; justify-content: flex-end; gap: 0.75rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                    <button class="btn btn-secondary" onclick="closeModal('createPostModal')">Cancel</button>
                    <button class="btn" onclick="savePost()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <span>ðŸš€</span>
                        <span>Create Post</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div id="bulkEditModal" class="modal">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;"> Bulk Edit</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Update prices, min stays, and restrictions across multiple rooms and dates</p>
                </div>
                <button class="modal-close" onclick="closeModal('bulkEditModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                
                <!-- What to Edit -->
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #475569; margin-bottom: 0.75rem; display: block;">
                         What do you want to edit?
                    </label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb; flex: 1; min-width: 150px;">
                            <input type="radio" name="bulk-edit-type" value="price" checked onchange="toggleBulkEditType()"> 
                            <span> Prices</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb; flex: 1; min-width: 150px;">
                            <input type="radio" name="bulk-edit-type" value="minstay" onchange="toggleBulkEditType()"> 
                            <span> Min Stay</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb; flex: 1; min-width: 150px;">
                            <input type="radio" name="bulk-edit-type" value="closed" onchange="toggleBulkEditType()"> 
                            <span> Closed Days</span>
                        </label>
                    </div>
                </div>
                
                <!-- Value Input (changes based on type) -->
                <div id="bulk-value-section" style="margin-bottom: 1.25rem;">
                    <!-- Price input -->
                    <div id="bulk-price-input" class="form-group">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                             Price Action
                        </label>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <select id="bulk-price-action" class="form-input" style="width: auto; padding: 0.6rem;">
                                <option value="set">Set price to</option>
                                <option value="increase">Increase by</option>
                                <option value="decrease">Decrease by</option>
                                <option value="increase_pct">Increase by %</option>
                                <option value="decrease_pct">Decrease by %</option>
                            </select>
                            <input type="number" id="bulk-price-value" class="form-input" min="0" value="100"
                                style="width: 100px; padding: 0.6rem; font-size: 1.1rem; font-weight: 600;">
                            <span id="bulk-price-symbol" style="color: #6b7280;">$</span>
                        </div>
                    </div>
                    
                    <!-- Min Stay input (hidden by default) -->
                    <div id="bulk-minstay-input" class="form-group" style="display: none;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                             Min Stay Nights
                        </label>
                        <input type="number" id="bulk-minstay-value" class="form-input" min="1" max="30" value="2"
                            style="width: 100px; padding: 0.6rem; font-size: 1.1rem; font-weight: 600;">
                    </div>
                    
                    <!-- Closed days input (hidden by default) -->
                    <div id="bulk-closed-input" class="form-group" style="display: none;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                             Close for
                        </label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: #fee2e2; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="bulk-close-checkin" checked> <span>Check-in</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: #fee2e2; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="bulk-close-checkout" checked> <span>Check-out</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Date Range -->
                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                         Date Range
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">From</label>
                            <input type="date" id="bulk-date-from" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">To</label>
                            <input type="date" id="bulk-date-to" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                    </div>
                </div>
                
                <!-- Days of Week -->
                <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #1e40af; margin-bottom: 0.75rem; display: block;">
                         Apply to Days
                    </label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="1" checked> <span>Mon</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="2" checked> <span>Tue</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="3" checked> <span>Wed</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="4" checked> <span>Thu</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="5" checked> <span>Fri</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: #fef3c7; border-radius: 6px; cursor: pointer; border: 1px solid #fde68a;">
                            <input type="checkbox" class="bulk-day-cb" data-day="6" checked> <span>Sat</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: #fef3c7; border-radius: 6px; cursor: pointer; border: 1px solid #fde68a;">
                            <input type="checkbox" class="bulk-day-cb" data-day="0" checked> <span>Sun</span>
                        </label>
                    </div>
                </div>
                
                <!-- Offers Selection (shown for min stay and closed) -->
                <div id="bulk-offers-section" style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem; display: none;">
                    <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                         Apply to Offers
                    </label>
                    <div style="margin-bottom: 0.5rem;">
                        <a href="#" onclick="document.querySelectorAll('.bulk-offer-cb').forEach(c=>c.checked=true); return false;" style="font-size: 0.85rem; color: #2563eb;">select all</a>
                        <span style="color: #9ca3af; margin: 0 0.5rem;">|</span>
                        <a href="#" onclick="document.querySelectorAll('.bulk-offer-cb').forEach(c=>c.checked=false); return false;" style="font-size: 0.85rem; color: #2563eb;">deselect all</a>
                    </div>
                    <div id="bulk-offers-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                        <p style="padding: 0.75rem; color: #6b7280;">Loading offers...</p>
                    </div>
                </div>
                
                <!-- Room Selection -->
                <div style="background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #7c3aed; margin-bottom: 0.75rem; display: block;">
                         Apply to Rooms
                    </label>
                    <div style="margin-bottom: 0.5rem;">
                        <a href="#" onclick="document.querySelectorAll('.bulk-room-cb').forEach(c=>c.checked=true); return false;" style="font-size: 0.85rem; color: #2563eb;">select all</a>
                        <span style="color: #9ca3af; margin: 0 0.5rem;">|</span>
                        <a href="#" onclick="document.querySelectorAll('.bulk-room-cb').forEach(c=>c.checked=false); return false;" style="font-size: 0.85rem; color: #2563eb;">deselect all</a>
                    </div>
                    <div id="bulk-rooms-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                        <p style="padding: 0.75rem; color: #6b7280;">Loading rooms...</p>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <button class="btn btn-secondary" onclick="closeModal('bulkEditModal')">Cancel</button>
                    <button class="btn" id="bulk-apply-btn" onclick="applyBulkEdit()" style="background: #16a34a; border-color: #16a34a;">
                         Apply Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Room Changes Modal -->
    <div id="roomChangesModal" class="modal" onclick="if(event.target === this) closeModal('roomChangesModal')">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 id="room-changes-title" style="margin: 0;"> Room Changes</h3>
                    <p style="margin: 0.25rem 0 0; opacity: 0.9; font-size: 0.85rem;">Compare Beds24 rooms with GAS</p>
                </div>
                <button class="modal-close" onclick="closeModal('roomChangesModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="room-changes-loading" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 2rem;"></div>
                    <p>Checking for room changes...</p>
                </div>
                <div id="room-changes-content" style="display: none;">
                    <!-- Summary -->
                    <div id="room-changes-summary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;"></div>
                    
                    <!-- New Rooms Section -->
                    <div id="new-rooms-section" style="display: none; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 0.5rem; color: #059669;"> New Rooms in Beds24</h4>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.75rem;">These rooms exist in Beds24 but not in GAS. Select to import.</p>
                        <div id="new-rooms-list" style="border: 1px solid #d1fae5; border-radius: 8px; overflow: hidden;"></div>
                        <button class="btn" onclick="importSelectedRooms()" style="margin-top: 0.75rem; background: #059669;">
                             Import Selected Rooms
                        </button>
                    </div>
                    
                    <!-- Removed Rooms Section -->
                    <div id="removed-rooms-section" style="display: none; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 0.5rem; color: #dc2626;"> Rooms No Longer in Beds24</h4>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.75rem;">These rooms exist in GAS but were removed from Beds24. Select to archive.</p>
                        <div id="removed-rooms-list" style="border: 1px solid #fee2e2; border-radius: 8px; overflow: hidden;"></div>
                        <button class="btn" onclick="archiveSelectedRooms()" style="margin-top: 0.75rem; background: #dc2626;">
                             Archive Selected Rooms
                        </button>
                    </div>
                    
                    <!-- Name Changes Section -->
                    <div id="name-changes-section" style="display: none; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 0.5rem; color: #d97706;"> Name Changes</h4>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.75rem;">Room names differ between Beds24 and GAS. Select to update.</p>
                        <div id="name-changes-list" style="border: 1px solid #fef3c7; border-radius: 8px; overflow: hidden;"></div>
                        <button class="btn" onclick="updateSelectedNames()" style="margin-top: 0.75rem; background: #d97706;">
                             Update Selected Names
                        </button>
                    </div>
                    
                    <!-- Matched Rooms Section -->
                    <div id="matched-rooms-section" style="margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem; color: #6b7280;"> Matched Rooms</h4>
                        <div id="matched-rooms-list" style="font-size: 0.85rem; color: #6b7280;"></div>
                    </div>
                    
                    <!-- Website Reminder -->
                    <div id="website-reminder" style="display: none; margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 8px; border: 1px solid #f59e0b;">
                        <strong> Remember:</strong> After making changes, update your property websites to reflect the new room configuration.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Modal -->
    <div id="vendorModal" class="modal" onclick="if(event.target === this) closeModal('vendorModal')">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 id="vendor-modal-title" style="margin: 0;"> Add Vendor</h3>
                    <p style="margin: 0.25rem 0 0; opacity: 0.9; font-size: 0.85rem;">External service provider</p>
                </div>
                <button class="modal-close" onclick="closeModal('vendorModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="vendor-form">
                    <input type="hidden" id="vendor-id">
                    
                    <!-- Basic Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Company Name *</label>
                            <input type="text" class="form-input" id="vendor-name" required placeholder="e.g., ABC Taxis">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Name</label>
                            <input type="text" class="form-input" id="vendor-contact-name" placeholder="Main contact person">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="vendor-email" required placeholder="contact@vendor.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="vendor-phone" placeholder="+44 1234 567890">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-input" id="vendor-address" placeholder="Full address">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-input" id="vendor-website" placeholder="https://www.vendor.com">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label">Notes</label>
                        <textarea class="form-input" id="vendor-notes" rows="2" placeholder="Internal notes about this vendor"></textarea>
                    </div>
                    
                    <!-- Vendor Portal Access -->
                    <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e2e8f0;">
                        <h4 style="margin: 0 0 0.75rem; font-size: 0.95rem;"> Vendor Portal Access</h4>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.75rem;">Vendors can log in to view and confirm service requests</p>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Login Email</label>
                            <input type="email" class="form-input" id="vendor-login-email" placeholder="Same as email if left blank">
                        </div>
                        <div id="vendor-temp-password" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px;">
                            <strong>Temporary Password:</strong> <code id="vendor-temp-password-value" style="background: white; padding: 2px 6px; border-radius: 4px;"></code>
                            <p style="font-size: 0.8rem; color: #92400e; margin: 0.5rem 0 0;">Share this with the vendor. They can log in at <code>/vendor</code></p>
                        </div>
                    </div>
                    
                    <!-- Permissions -->
                    <div style="background: #f0fdf4; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #bbf7d0;">
                        <h4 style="margin: 0 0 0.75rem; font-size: 0.95rem;"> What can this vendor see?</h4>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.75rem;">Control what booking details the vendor can access</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="perm-guest-name" checked> Guest name
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="perm-guest-phone" checked> Guest phone
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="perm-guest-email"> Guest email
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="perm-booking-dates" checked> Check-in/out dates
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="perm-room-details"> Room details
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="perm-booking-notes"> Booking notes
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="perm-price-paid"> Price paid
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('vendorModal')">Cancel</button>
                        <button type="submit" class="btn" style="background: #f59e0b; border-color: #f59e0b;">ðŸ’¾ Save Vendor</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Blog Post Modal -->
    <div id="blogModal" class="modal" onclick="if(event.target === this) closeModal('blogModal')">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 id="blog-modal-title" style="margin: 0;"> New Blog Post</h3>
                    <p style="margin: 0.25rem 0 0; opacity: 0.9; font-size: 0.85rem;">Create engaging content for your guests</p>
                </div>
                <button class="modal-close" onclick="closeModal('blogModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="blog-form">
                    <input type="hidden" id="blog-id">
                    
                    <!-- Property Selector -->
                    <div class="form-group" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <label class="form-label">Property / Website *</label>
                        <select class="form-input" id="blog-property-id" required>
                            <option value="">Select property...</option>
                        </select>
                        <small style="color: #64748b;">Choose which website this blog post belongs to</small>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                        <!-- Left Column: Content -->
                        <div>
                            <div class="form-group">
                                <label class="form-label">Title *</label>
                                <input type="text" class="form-input" id="blog-title" required placeholder="Enter a compelling title...">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Slug</label>
                                <input type="text" class="form-input" id="blog-slug" placeholder="auto-generated-from-title">
                                <small style="color: #64748b;">Leave blank to auto-generate from title</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Excerpt</label>
                                <textarea class="form-input" id="blog-excerpt" rows="2" placeholder="A short summary for listings and SEO..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Content *</label>
                                <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                                    <div style="background: #f8fafc; padding: 0.5rem; border-bottom: 1px solid var(--border); display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                        <button type="button" onclick="formatBlogText('bold')" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" title="Bold"><b>B</b></button>
                                        <button type="button" onclick="formatBlogText('italic')" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" title="Italic"><i>I</i></button>
                                        <button type="button" onclick="formatBlogText('h2')" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" title="Heading">H2</button>
                                        <button type="button" onclick="formatBlogText('h3')" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" title="Subheading">H3</button>
                                        <button type="button" onclick="formatBlogText('ul')" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" title="Bullet List"> List</button>
                                        <button type="button" onclick="formatBlogText('link')" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" title="Link"></button>
                                    </div>
                                    <textarea class="form-input" id="blog-content" rows="12" required placeholder="Write your blog post content here... Use the formatting buttons above or write HTML directly." style="border: none; border-radius: 0; font-family: monospace;"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Settings -->
                        <div>
                            <div class="form-group">
                                <label class="form-label">Featured Image URL</label>
                                <input type="url" class="form-input" id="blog-featured-image" placeholder="https://...">
                                <div id="blog-image-preview" style="margin-top: 0.5rem; border-radius: 8px; overflow: hidden;"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <div style="display: flex; gap: 8px;">
                                    <select class="form-input" id="blog-category" style="flex: 1;">
                                        <option value="">Select category...</option>
                                    </select>
                                    <button type="button" class="btn" onclick="showAddCategoryModal()" style="padding: 8px 12px; background: #10b981;" title="Add New Category">+</button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Author Name</label>
                                <input type="text" class="form-input" id="blog-author" placeholder="e.g., The Team">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Read Time (minutes)</label>
                                <input type="number" class="form-input" id="blog-read-time" min="1" placeholder="5">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="blog-published" style="width: 18px; height: 18px;">
                                    Publish immediately
                                </label>
                            </div>
                            
                            <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e2e8f0;">
                            
                            <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border: 1px solid #86efac;">
                                <h4 style="margin: 0 0 0.75rem; color: #166534; font-size: 0.9rem;"> SEO Settings</h4>
                                <div class="form-group" style="margin-bottom: 0.75rem;">
                                    <label class="form-label" style="font-size: 0.85rem;">Meta Title</label>
                                    <input type="text" class="form-input" id="blog-meta-title" placeholder="SEO title (50-60 chars)">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 0.85rem;">Meta Description</label>
                                    <textarea class="form-input" id="blog-meta-description" rows="2" placeholder="SEO description (150-160 chars)"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0;">
                <button type="button" class="btn btn-secondary" id="blog-delete-btn" onclick="deleteBlogPost()" style="background: #fee2e2; color: #dc2626; border-color: #fecaca; display: none;"> Delete</button>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('blogModal')">Cancel</button>
                    <button type="button" class="btn" onclick="saveBlogPost()" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">ðŸ’¾ Save Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attraction Modal -->
    <div id="attractionModal" class="modal" onclick="if(event.target === this) closeModal('attractionModal')">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 id="attraction-modal-title" style="margin: 0;"> Add Attraction</h3>
                    <p style="margin: 0.25rem 0 0; opacity: 0.9; font-size: 0.85rem;">Help guests discover things to do nearby</p>
                </div>
                <button class="modal-close" onclick="closeModal('attractionModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="attraction-form">
                    <input type="hidden" id="attraction-id">
                    <input type="hidden" id="attraction-content-idea-id">
                    
                    <!-- Property Selector -->
                    <div class="form-group" style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <label class="form-label">Property / Website *</label>
                        <select class="form-input" id="attraction-property-id" required>
                            <option value="">Select property...</option>
                        </select>
                    </div>
                    
                    <!-- AI Fill Section -->
                    <div id="attraction-ai-section" style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); border-radius: 8px; border: 1px solid #c4b5fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #5b21b6;"> AI Assistant</strong>
                                <p style="margin: 0.25rem 0 0; font-size: 0.85rem; color: #6d28d9;">Auto-fill details based on attraction name</p>
                            </div>
                            <button type="button" class="btn" onclick="aiGenerateAttractionDetails()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                 AI Fill Details
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Attraction Name *</label>
                            <input type="text" class="form-input" id="attraction-name" required placeholder="e.g., Liverpool Cathedral">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Distance from Property *</label>
                            <input type="text" class="form-input" id="attraction-distance" required placeholder="e.g., 5 min walk">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <select class="form-input" id="attraction-category" required>
                                <option value="">Select category...</option>
                                <option value="museums"> Museums & Galleries</option>
                                <option value="landmarks"> Historic Sites & Landmarks</option>
                                <option value="parks"> Parks & Gardens</option>
                                <option value="beaches"> Beaches</option>
                                <option value="entertainment"> Entertainment</option>
                                <option value="shopping"> Shopping</option>
                                <option value="restaurants"> Restaurants & Dining</option>
                                <option value="cafes"> Cafes & Coffee</option>
                                <option value="nightlife"> Nightlife & Bars</option>
                                <option value="sports"> Sports & Activities</option>
                                <option value="nature"> Nature & Outdoors</option>
                                <option value="family"> Family Fun</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price Range</label>
                            <select class="form-input" id="attraction-price">
                                <option value="">Select...</option>
                                <option value="Free">Free</option>
                                <option value=""> Budget</option>
                                <option value=""> Mid-range</option>
                                <option value=""> Premium</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Short Description * <span style="font-weight: normal; color: #6b7280;">(for cards, 1-2 sentences)</span></label>
                        <textarea class="form-input" id="attraction-short-desc" rows="2" required placeholder="Brief description that will appear on attraction cards..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Full Description <span style="font-weight: normal; color: #6b7280;">(optional, for detail page)</span></label>
                        <textarea class="form-input" id="attraction-description" rows="4" placeholder="Detailed description mentioning why guests from your property would enjoy this..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Featured Image URL <span style="font-weight: normal; color: #6b7280;">(optional)</span></label>
                            <input type="url" class="form-input" id="attraction-image" placeholder="https://...">
                            <small style="color: #6b7280;">Paste URL or leave blank</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Website URL <span style="font-weight: normal; color: #6b7280;">(optional)</span></label>
                            <input type="url" class="form-input" id="attraction-website" placeholder="https://...">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Address <span style="font-weight: normal; color: #6b7280;">(optional)</span></label>
                            <input type="text" class="form-input" id="attraction-address" placeholder="Full address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Google Maps URL <span style="font-weight: normal; color: #6b7280;">(optional)</span></label>
                            <input type="url" class="form-input" id="attraction-maps-url" placeholder="https://maps.google.com/...">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Typical Duration</label>
                            <input type="text" class="form-input" id="attraction-duration" placeholder="e.g., 1-2 hours">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Display Order</label>
                            <input type="number" class="form-input" id="attraction-order" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Slug</label>
                            <input type="text" class="form-input" id="attraction-slug" placeholder="auto-generated">
                        </div>
                    </div>
                    
                    <!-- Featured Image -->
                    <div class="form-group">
                        <label class="form-label">Featured Image</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('attraction-image-upload').click()" style="white-space: nowrap;"> Upload Image</button>
                            <input type="file" id="attraction-image-upload" accept="image/*" style="display: none;" onchange="uploadAttractionImage(this)">
                            <span style="color: #64748b;">or</span>
                            <input type="text" class="form-input" id="attraction-image" placeholder="Paste image URL" style="flex: 1;">
                        </div>
                        <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;"> Upload your own image or paste a URL</p>
                    </div>
                    
                    <!-- Scheduling Options -->
                    <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <label style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="attraction-schedule" onchange="toggleAttractionSchedule()" />
                             Schedule for later
                        </label>
                        <div id="attraction-schedule-options" style="display: none; margin-top: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label class="form-label">Publish Date</label>
                                    <input type="date" id="attraction-schedule-date" class="form-input" />
                                </div>
                                <div>
                                    <label class="form-label">Publish Time</label>
                                    <input type="time" id="attraction-schedule-time" class="form-input" value="09:00" />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden field for published state -->
                    <input type="hidden" id="attraction-published" value="false">
                    
                    <!-- SEO Section -->
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border: 1px solid #86efac; margin-top: 1rem;">
                        <h4 style="margin: 0 0 0.75rem; color: #166534; font-size: 0.9rem;"> SEO Settings</h4>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label class="form-label" style="font-size: 0.85rem;">Meta Title</label>
                            <input type="text" class="form-input" id="attraction-meta-title" placeholder="SEO title (50-60 chars)">
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label class="form-label" style="font-size: 0.85rem;">Meta Description</label>
                            <textarea class="form-input" id="attraction-meta-description" rows="2" placeholder="SEO description (150-160 chars)"></textarea>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 0.85rem;">FAQ Schema (JSON-LD)</label>
                            <textarea class="form-input" id="attraction-faq-schema" rows="3" style="font-family: monospace; font-size: 0.8rem;" placeholder="Generated by AI or paste your own"></textarea>
                            <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;"> Add this to your page's &lt;head&gt; section for rich FAQ snippets in Google</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0;">
                <button type="button" class="btn btn-secondary" id="attraction-delete-btn" onclick="deleteAttraction()" style="background: #fee2e2; color: #dc2626; border-color: #fecaca; display: none;"> Delete</button>
                <div style="display: flex; gap: 0.5rem;">
                    <button type="button" class="btn" onclick="saveAttractionAsDraft()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">ðŸ’¾ Save as Draft</button>
                    <button type="button" class="btn" onclick="saveAttractionAndPublish()" style="background: #10b981;"> Publish</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('attractionModal')"> Back</button>
                </div>
            </div>
        </div>
    </div>

<!-- Bedroom Modal -->
<div id="bedroom-modal" class="gas-modal-overlay">
    <div style="background: #ffffff; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
        <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="bedroom-modal-title" style="margin: 0; font-size: 1.25rem;">ðŸ›ï¸ Add Bedroom</h3>
            <button onclick="closeBedroomModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">Ã—</button>
        </div>
        <div style="padding: 1.5rem;">
            <input type="hidden" id="bedroom-edit-id">
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">Bedroom Name *</label>
                <input type="text" class="form-input" id="bedroom-name" placeholder="e.g., Master Bedroom, Bedroom 2, Kids Room">
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">Bed Configuration</label>
                <div id="bedroom-beds-config">
                    <div class="bed-config-row" style="display: grid; grid-template-columns: 1fr auto auto; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                        <select class="form-input bed-type-modal">
                            <option value="">Select bed type...</option>
                            <option value="king">King Bed</option>
                            <option value="super-king">Super King Bed</option>
                            <option value="queen">Queen Bed</option>
                            <option value="double">Double Bed</option>
                            <option value="single">Single/Twin Bed</option>
                            <option value="sofa-bed">Sofa Bed</option>
                            <option value="bunk">Bunk Bed</option>
                            <option value="murphy">Murphy Bed</option>
                            <option value="daybed">Daybed</option>
                            <option value="trundle">Trundle Bed</option>
                            <option value="cot">Cot/Crib</option>
                            <option value="toddler">Toddler Bed</option>
                            <option value="air-mattress">Air Mattress</option>
                            <option value="futon">Futon</option>
                            <option value="floor-mattress">Floor Mattress</option>
                        </select>
                        <input type="number" class="form-input bed-qty-modal" min="1" max="10" value="1" style="width: 60px;">
                        <button type="button" onclick="removeBedroomBedRow(this)" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;">ðŸ—‘ï¸</button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary btn-small" onclick="addBedroomBedRow()" style="margin-top: 0.5rem;">+ Add Bed</button>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="bedroom-has-ensuite" style="width: 18px; height: 18px;">
                    <span>Has Ensuite Bathroom</span>
                </label>
            </div>
            
            <div id="ensuite-link-section" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <label class="form-label">Link to Bathroom</label>
                <select class="form-input" id="bedroom-ensuite-bathroom">
                    <option value="">Select ensuite bathroom...</option>
                </select>
                <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">Or add the bathroom in the Bathrooms tab first</p>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">Description (optional)</label>
                <textarea class="form-input" id="bedroom-description" rows="3" placeholder="Any special features or notes about this bedroom..."></textarea>
            </div>
        </div>
        <div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="closeBedroomModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveBedroom()">Save Bedroom</button>
        </div>
    </div>
</div>

<!-- Bathroom Modal -->
<div id="bathroom-modal" class="gas-modal-overlay">
    <div style="background: #ffffff; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
        <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="bathroom-modal-title" style="margin: 0; font-size: 1.25rem;">ðŸš¿ Add Bathroom</h3>
            <button onclick="closeBathroomModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">Ã—</button>
        </div>
        <div style="padding: 1.5rem;">
            <input type="hidden" id="bathroom-edit-id">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label class="form-label">Bathroom Name *</label>
                    <input type="text" class="form-input" id="bathroom-name" placeholder="e.g., Master Ensuite, Hallway Bath">
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="bathroom-location" placeholder="e.g., Upstairs, Ground Floor">
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">Bathroom Type *</label>
                <select class="form-input" id="bathroom-type">
                    <option value="">Select type...</option>
                    <option value="full-private">Full Private (Shower/Bath + Toilet + Sink)</option>
                    <option value="full-shared">Full Shared (Shower/Bath + Toilet + Sink)</option>
                    <option value="half-private">Half Private (Toilet + Sink only)</option>
                    <option value="half-shared">Half Shared (Toilet + Sink only)</option>
                    <option value="shower-room">Shower Room (Shower + Sink)</option>
                    <option value="wc">WC (Toilet only)</option>
                    <option value="outdoor">Outdoor Shower</option>
                </select>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="bathroom-is-ensuite" style="width: 18px; height: 18px;">
                    <span>This is an Ensuite (attached to bedroom)</span>
                </label>
            </div>
            
            <div id="ensuite-bedroom-link-section" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px;">
                <label class="form-label">Linked to Bedroom</label>
                <select class="form-input" id="bathroom-linked-bedroom">
                    <option value="">Select bedroom...</option>
                </select>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">Features</label>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="bath-feat-shower" style="width: 16px; height: 16px;">
                        <span style="font-size: 0.9rem;">Shower</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="bath-feat-bathtub" style="width: 16px; height: 16px;">
                        <span style="font-size: 0.9rem;">Bathtub</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="bath-feat-rainfall" style="width: 16px; height: 16px;">
                        <span style="font-size: 0.9rem;">Rainfall Shower</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="bath-feat-walkin" style="width: 16px; height: 16px;">
                        <span style="font-size: 0.9rem;">Walk-in Shower</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="bath-feat-jacuzzi" style="width: 16px; height: 16px;">
                        <span style="font-size: 0.9rem;">Jacuzzi/Spa</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="bath-feat-bidet" style="width: 16px; height: 16px;">
                        <span style="font-size: 0.9rem;">Bidet</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="bath-feat-heated-floor" style="width: 16px; height: 16px;">
                        <span style="font-size: 0.9rem;">Heated Floor</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="bath-feat-double-vanity" style="width: 16px; height: 16px;">
                        <span style="font-size: 0.9rem;">Double Vanity</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="bath-feat-accessible" style="width: 16px; height: 16px;">
                        <span style="font-size: 0.9rem;">Accessible</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">Description (optional)</label>
                <textarea class="form-input" id="bathroom-description" rows="2" placeholder="Any special features or notes about this bathroom..."></textarea>
            </div>
        </div>
        <div style="padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn btn-secondary" onclick="closeBathroomModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveBathroom()">Save Bathroom</button>
        </div>
    </div>
</div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // =====================================================
        // AUTHENTICATION
        // =====================================================
        let currentAccount = null;
        
        // AI Chat global variables (declared early for navClick access)
        var aiChatOpen = false;
        var aiChatMessages = [];
        var aiChatLoading = false;
        var aiChatCurrentView = 'Dashboard';
        
        // Country name to ISO code mapping for backward compatibility
        const countryNameToCode = {
            'united kingdom': 'GB', 'uk': 'GB', 'great britain': 'GB', 'england': 'GB',
            'united states': 'US', 'usa': 'US', 'america': 'US',
            'switzerland': 'CH', 'suisse': 'CH', 'schweiz': 'CH',
            'germany': 'DE', 'deutschland': 'DE',
            'france': 'FR',
            'italy': 'IT', 'italia': 'IT',
            'spain': 'ES', 'espaa': 'ES',
            'netherlands': 'NL', 'holland': 'NL',
            'austria': 'AT', 'sterreich': 'AT',
            'portugal': 'PT',
            'belgium': 'BE', 'belgique': 'BE',
            'ireland': 'IE',
            'australia': 'AU',
            'new zealand': 'NZ',
            'canada': 'CA',
            'uae': 'AE', 'united arab emirates': 'AE', 'dubai': 'AE',
            'japan': 'JP',
            'thailand': 'TH',
            'greece': 'GR',
            'croatia': 'HR',
            'czech republic': 'CZ', 'czechia': 'CZ',
            'poland': 'PL',
            'hungary': 'HU',
            'sweden': 'SE',
            'norway': 'NO',
            'denmark': 'DK',
            'finland': 'FI'
        };
        
        function normalizeCountryCode(country) {
            if (!country) return 'GB';
            // If already a 2-letter code, return uppercase
            if (country.length === 2) return country.toUpperCase();
            // Try to find in mapping
            const code = countryNameToCode[country.toLowerCase()];
            return code || country; // Return original if not found
        }
        
        // Check authentication on page load
        async function checkAuth() {
            const token = localStorage.getItem('gas_token');
            
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            
            try {
                const response = await fetch('/api/accounts/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                
                if (data.success) {
                    currentAccount = data.account;
                    updateUserProfile();
                    applyRoleBasedAccess();
                    // Update billing nav visibility after auth
                    if (typeof updateBillingNavVisibility === 'function') {
                        updateBillingNavVisibility();
                    }
                    // Load feature entitlements
                    if (typeof loadAccountEntitlements === 'function') {
                        loadAccountEntitlements();
                    }
                    // Reload dashboard with correct filters
                    if (typeof loadDashboard === 'function') {
                        loadDashboard();
                    }
                    return true;
                } else {
                    // Token invalid, clear and redirect
                    localStorage.removeItem('gas_token');
                    localStorage.removeItem('gas_account');
                    window.location.href = '/login.html';
                    return false;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // On network error, try using cached account
                const cachedAccount = localStorage.getItem('gas_account');
                if (cachedAccount) {
                    currentAccount = JSON.parse(cachedAccount);
                    updateUserProfile();
                    applyRoleBasedAccess();
                    // Update billing nav visibility after auth
                    if (typeof updateBillingNavVisibility === 'function') {
                        updateBillingNavVisibility();
                    }
                    // Load feature entitlements
                    if (typeof loadAccountEntitlements === 'function') {
                        loadAccountEntitlements();
                    }
                    if (typeof loadDashboard === 'function') {
                        loadDashboard();
                    }
                    return true;
                }
                window.location.href = '/login.html';
                return false;
            }
        }
        
        // Apply role-based access control
        function applyRoleBasedAccess() {
            if (!currentAccount) return;
            
            // Check if user has a custom site (for all roles)
            checkCustomSiteAccess();
            
            // Master admin sees everything
            if (currentAccount.role === 'master_admin') {
                // Master admin sees everything including agency management requests
                document.querySelectorAll('.agency-only').forEach(el => {
                    el.style.display = 'flex';
                });
                // Show/hide master-only sections based on whether viewing a client
                updateMasterOnlyVisibility();
                // Show Clear button for master admin
                const clearBtn = document.getElementById('clearFilterBtn');
                if (clearBtn) clearBtn.style.display = 'block';
                return;
            }
            
            // Non-master: hide master-only sections (already hidden via style="display:none")
            // They stay hidden by default
            
            // Agency Admin: show management requests, can switch between managed accounts
            if (currentAccount.role === 'agency_admin') {
                document.querySelectorAll('.agency-only').forEach(el => {
                    el.style.display = 'flex';
                });
                // Agency admins can clear to see all their managed accounts
                const clearBtn = document.getElementById('clearFilterBtn');
                if (clearBtn) clearBtn.style.display = 'block';
            }
            
            // Admin/SubMaster: show Management Requests (so they can see their requests)
            if (currentAccount.role === 'admin' || currentAccount.role === 'submaster_admin') {
                // Show Management Requests for admins (they need to see requests they've made)
                const mgmtRequestsNav = document.querySelector('[data-view="management-requests"]');
                if (mgmtRequestsNav) mgmtRequestsNav.style.display = 'flex';
            }
            
            // Non-master admins: auto-filter to their own account
            selectedAccountId = currentAccount.id;
            selectedAccountName = currentAccount.name;
            
            // Show the filter banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            if (banner && nameEl) {
                banner.style.display = 'flex';
                nameEl.textContent = currentAccount.name;
                
                // Hide the clear button for regular admins (not agency_admin)
                if (currentAccount.role !== 'agency_admin') {
                    const clearBtn = document.getElementById('clearFilterBtn');
                    if (clearBtn) clearBtn.style.display = 'none';
                    
                    // Also hide manage button
                    const manageBtn = document.getElementById('managePlanBtn');
                    if (manageBtn) manageBtn.style.display = 'none';
                }
            }
            
            // Hide "All Accounts" nav item for non-master-admins (but keep section visible)
            const accountsNavItem = document.querySelector('[data-view="accounts"]');
            if (accountsNavItem) {
                accountsNavItem.style.display = 'none';
            }
            
            // Hide Agencies and Clients nav items
            const agenciesNavItem = document.querySelector('[data-view="agencies"]');
            const clientsNavItem = document.querySelector('[data-view="clients"]');
            if (agenciesNavItem) agenciesNavItem.style.display = 'none';
            if (clientsNavItem) clientsNavItem.style.display = 'none';
            
            console.log('Role-based access applied for:', currentAccount.role, '- filtering to account:', selectedAccountId);
        }
        
        function updateUserProfile() {
            if (!currentAccount) return;
            
            const avatarEl = document.getElementById('userAvatar');
            const nameEl = document.getElementById('userName');
            const roleEl = document.getElementById('userRole');
            
            if (avatarEl) {
                avatarEl.textContent = currentAccount.name.charAt(0).toUpperCase();
            }
            if (nameEl) {
                nameEl.textContent = currentAccount.name;
            }
            if (roleEl) {
                const roleLabels = {
                    'master_admin': 'Master Admin',
                    'agency_admin': 'Agency Admin',
                    'submaster_admin': 'Sub Admin',
                    'admin': 'Admin'
                };
                roleEl.textContent = roleLabels[currentAccount.role] || currentAccount.role;
            }
        }
        
        async function handleLogout() {
            const token = localStorage.getItem('gas_token');
            
            try {
                await fetch('/api/accounts/logout', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('gas_token');
            localStorage.removeItem('gas_account');
            window.location.href = '/home.html';
        }
        
        // Helper to sync color text to picker (only when valid hex)
        function syncColorToPicker(textId, pickerId) {
            const text = document.getElementById(textId);
            const picker = document.getElementById(pickerId);
            if (text && picker && /^#[0-9A-Fa-f]{6}$/.test(text.value)) {
                picker.value = text.value;
            }
        }
        
        // Toggle Reviews App fields visibility
        function toggleReviewsAppFields() {
            const useApp = document.getElementById('wb-reviews-use-app')?.checked;
            const appFields = document.getElementById('wb-reviews-app-fields');
            const manualSection = document.getElementById('wb-reviews-manual-section');
            
            if (appFields) {
                appFields.style.display = useApp ? 'block' : 'none';
            }
            if (manualSection) {
                manualSection.style.display = useApp ? 'none' : 'block';
            }
        }
        
        // Helper to add auth header to fetch requests
        function authHeaders() {
            const token = localStorage.getItem('gas_token');
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        }
        
        // =====================================================
        // GLOBAL STATE
        // =====================================================
        // Global client tracking - uses public_id (UUID) for security
        let currentClientPublicId = null; // UUID or null for all clients
        let clientIdMap = {}; // Maps public_id -> internal id
        
        // Agency filter - when set, all views filter by this agency
        let selectedAgencyId = null;
        let selectedAgencyName = null;
        
        // Account filter (new unified system) - when set, all views filter by this account
        let selectedAccountId = null;
        let selectedWebsiteId = null;
        let selectedDeployedSiteId = null; // NEW: For clean per-site settings
        let selectedWebsiteData = null;
        let availableWebsites = [];
        let deployedSitesCache = [];
        
        // Template-specific defaults
        const templateDefaults = {
            'developer-light': {
                header: {
                    'bg-color': '#ffffff',
                    'text-color': '#1e293b',
                    'logo-color': '#0f172a',
                    'cta-bg': '#2563eb',
                    'cta-text': '#ffffff',
                    'border-color': '#e5e7eb'
                },
                hero: {
                    'overlay-color': '#0f172a',
                    'title-color': '#ffffff',
                    'subtitle-color': '#ffffff',
                    'search-max-guests': '4'
                },
                intro: {
                    'bg': '#ffffff',
                    'text-color': '#1e293b'
                },
                featured: {
                    'bg': '#f8fafc',
                    'text-color': '#1e293b'
                },
                footer: {
                    'bg-color': '#0f172a',
                    'text-color': '#ffffff'
                },
                styles: {
                    'primary-color': '#2563eb',
                    'secondary-color': '#0f172a',
                    'body-bg': '#ffffff',
                    'text-color': '#1e293b'
                }
            },
            'developer-dark': {
                header: {
                    'bg-color': '#0f172a',
                    'text-color': '#e2e8f0',
                    'logo-color': '#f8fafc',
                    'cta-bg': '#6366f1',
                    'cta-text': '#ffffff',
                    'border-color': '#334155'
                },
                hero: {
                    'overlay-color': '#0f172a',
                    'title-color': '#ffffff',
                    'subtitle-color': '#e2e8f0',
                    'search-max-guests': '4'
                },
                intro: {
                    'bg': '#1e293b',
                    'text-color': '#e2e8f0'
                },
                featured: {
                    'bg': '#0f172a',
                    'text-color': '#e2e8f0'
                },
                footer: {
                    'bg-color': '#020617',
                    'text-color': '#e2e8f0'
                },
                styles: {
                    'primary-color': '#6366f1',
                    'secondary-color': '#f8fafc',
                    'body-bg': '#0f172a',
                    'text-color': '#e2e8f0'
                }
            }
        };
        
        // Get template defaults for current website
        function getTemplateDefaults(section) {
            const template = selectedWebsiteData?.template || 'developer-light';
            return templateDefaults[template]?.[section] || templateDefaults['developer-light'][section] || {};
        }
        
        // Website selection functions
        async function loadAccountWebsites() {
            if (!selectedAccountId) {
                availableWebsites = [];
                return;
            }
            
            try {
                const response = await fetch(`/api/websites?owner_type=account&owner_id=${selectedAccountId}`);
                const data = await response.json();
                availableWebsites = data.success ? (data.websites || []) : [];
            } catch (error) {
                console.error('Error loading websites:', error);
                availableWebsites = [];
            }
        }
        
        function selectWebsite(websiteId, websiteData = null) {
            console.log('selectWebsite called:', websiteId, websiteData);
            
            selectedWebsiteId = websiteId;
            selectedWebsiteData = websiteData;
            
            // DON'T change selectedAccountId here - it breaks navigation back to master view
            // The website builder sections will use selectedWebsiteId directly
            
            // Update all website selector dropdowns
            document.querySelectorAll('.website-selector-dropdown').forEach(select => {
                select.value = websiteId || '';
            });
            
            // Update the website banner
            updateWebsiteBanner();
            
            // Reload current section if in website builder
            const currentView = document.querySelector('.view[style*="display: block"], .view.active');
            if (currentView && currentView.id.startsWith('wb-')) {
                const section = currentView.id.replace('wb-', '');
                loadWebsiteSection(section);
            }
        }
        
        function updateWebsiteBanner() {
            console.log('updateWebsiteBanner called - selectedWebsiteId:', selectedWebsiteId, 'selectedWebsiteData:', selectedWebsiteData);
            
            const banners = document.querySelectorAll('.website-edit-banner');
            console.log('Found banners:', banners.length);
            
            banners.forEach(banner => {
                if (selectedWebsiteId && selectedWebsiteData) {
                    banner.style.display = 'block';
                    const nameEl = banner.querySelector('.website-name');
                    const urlEl = banner.querySelector('.website-url');
                    const statusEl = banner.querySelector('.website-status');
                    
                    if (nameEl) nameEl.textContent = selectedWebsiteData.name || 'Unnamed Website';
                    if (urlEl) {
                        urlEl.href = selectedWebsiteData.site_url || '#';
                        urlEl.textContent = selectedWebsiteData.site_url || 'No URL';
                        urlEl.style.display = selectedWebsiteData.site_url ? 'inline' : 'none';
                    }
                    if (statusEl) {
                        statusEl.textContent = selectedWebsiteData.status || 'draft';
                        statusEl.className = 'website-status status-' + (selectedWebsiteData.status || 'draft');
                        console.log('Set status to:', selectedWebsiteData.status);
                    }
                } else {
                    banner.style.display = 'none';
                }
            });
            
            // Update selectors
            updateWebsiteSelectors();
        }
        
        function updateWebsiteSelectors() {
            document.querySelectorAll('.website-selector-dropdown').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select Website --</option>';
                
                availableWebsites.forEach(website => {
                    const option = document.createElement('option');
                    option.value = website.id;
                    option.textContent = `${website.name} (${website.status})`;
                    if (website.id == selectedWebsiteId) option.selected = true;
                    select.appendChild(option);
                });
                
                // Add "Create New" option
                const newOption = document.createElement('option');
                newOption.value = 'new';
                newOption.textContent = '+ Create New Website';
                select.appendChild(newOption);
            });
        }
        
        async function onWebsiteSelected(selectElement) {
            const value = selectElement.value;
            
            if (value === 'new') {
                // Open deploy modal or create website modal
                selectElement.value = selectedWebsiteId || '';
                openDeployModal();
                return;
            }
            
            if (value) {
                const website = availableWebsites.find(w => w.id == value);
                selectWebsite(value, website);
            } else {
                selectWebsite(null, null);
            }
        }
        
        function editWebsite(websiteId) {
            console.log('editWebsite called with ID:', websiteId);
            console.log('availableWebsites:', availableWebsites);
            
            // Find the website data from availableWebsites (populated from deployed sites)
            let website = availableWebsites.find(w => w.id == websiteId);
            
            // Fallback to deployedSitesCache if not found
            if (!website && deployedSitesCache.length > 0) {
                const cached = deployedSitesCache.find(s => s.id == websiteId);
                if (cached) {
                    website = {
                        id: cached.id,
                        name: cached.site_name || cached.slug,
                        site_url: cached.site_url,
                        admin_url: cached.admin_url,
                        status: cached.status,
                        account_id: cached.account_id,
                        template: cached.template || 'developer-light'
                    };
                }
            }
            
            console.log('Found website:', website);
            console.log('Website template:', website?.template);
            
            if (website) {
                // Set the deployed site ID for the new clean endpoints
                selectedDeployedSiteId = parseInt(websiteId);
                console.log('Set selectedDeployedSiteId:', selectedDeployedSiteId);
                
                selectWebsite(websiteId, website);
                
                // Note: We do NOT set selectedAccountId here anymore
                // The website editor should use selectedDeployedSiteId for API calls
                // Setting selectedAccountId was causing bugs when returning to Accounts view
                
                // Update editor header with site info
                document.getElementById('editor-site-name').textContent = website.name || 'Website Editor';
                document.getElementById('editor-site-url-display').innerHTML = website.site_url ? 
                    `<a href="${website.site_url}" target="_blank" style="color: #6366f1;">${website.site_url}</a>` : 
                    'Customize your website settings';
                
                // Show preview button if we have a URL
                const previewBtn = document.getElementById('editor-preview-btn');
                if (previewBtn && website.site_url) {
                    previewBtn.href = website.site_url;
                    previewBtn.style.display = 'inline-flex';
                }
                
                // Initialize the editor content
                initializeWebsiteEditor();
                
                // Navigate to the tabbed editor view
                navClick(null, 'website-editor');
            } else {
                // If not in list, show error
                showNotification('Website not found. Try refreshing the page.', 'error');
            }
        }
        
        // Initialize Website Editor - copy content from hidden wb-* views
        function initializeWebsiteEditor() {
            // First, apply template defaults to the SOURCE elements BEFORE cloning
            const template = selectedWebsiteData?.template || 'developer-light';
            console.log('Initializing editor with template:', template);
            
            const allDefaults = templateDefaults[template] || templateDefaults['developer-light'];
            
            // Apply all section defaults to source elements
            Object.keys(allDefaults).forEach(section => {
                const sectionDefaults = allDefaults[section];
                Object.keys(sectionDefaults).forEach(key => {
                    const elId = `wb-${section}-${key}`;
                    const pickerId = `wb-${section}-${key}-picker`;
                    const el = document.getElementById(elId);
                    const pickerEl = document.getElementById(pickerId);
                    if (el) {
                        el.value = sectionDefaults[key];
                        if (pickerEl) pickerEl.value = sectionDefaults[key];
                    }
                });
            });
            
            // Clone content from existing views into editor panels
            const mappings = [
                { source: 'wb-header', target: 'editor-header-content', section: 'header' },
                { source: 'wb-hero', target: 'editor-hero-content', section: 'hero' },
                { source: 'wb-intro', target: 'editor-intro-content', section: 'intro' },
                { source: 'wb-featured', target: 'editor-featured-content', section: 'featured' },
                { source: 'wb-about', target: 'editor-about-content', section: 'about' },
                { source: 'wb-reviews', target: 'editor-reviews-content', section: 'reviews' },
                { source: 'wb-cta', target: 'editor-cta-content', section: 'cta' },
                { source: 'wb-footer', target: 'editor-footer-content', section: 'footer' },
                { source: 'wb-styles', target: 'editor-styles-content', section: 'styles' },
                { source: 'wb-page-terms', target: 'editor-terms-content', section: 'page-terms' },
                { source: 'wb-page-privacy', target: 'editor-privacy-content', section: 'page-privacy' }
            ];
            
            mappings.forEach(map => {
                const sourceEl = document.getElementById(map.source);
                const targetEl = document.getElementById(map.target);
                if (sourceEl && targetEl) {
                    // Get the cards from the source (skip the header)
                    const cards = sourceEl.querySelectorAll('.card');
                    targetEl.innerHTML = '';
                    cards.forEach(card => {
                        const clone = card.cloneNode(true);
                        targetEl.appendChild(clone);
                    });
                }
            });
            
            // Load saved data for the header section (will overwrite defaults if data exists)
            loadWebsiteBuilderSection('header');
            
            // Apply feature locks to sub-page tabs based on account entitlements
            if (typeof applyFeatureLocks === 'function') {
                applyFeatureLocks();
            }
        }
        
        // Switch main editor tabs
        function switchEditorTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.editor-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                    tab.style.color = '#7c3aed';
                    tab.style.borderBottomColor = '#7c3aed';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = '#64748b';
                    tab.style.borderBottomColor = 'transparent';
                }
            });
            
            // Show/hide panels
            document.querySelectorAll('.editor-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const activePanel = document.getElementById('editor-panel-' + tabName);
            if (activePanel) {
                activePanel.style.display = 'block';
            }
            
            // Load data for the selected tab
            const sectionMap = {
                'header': 'header',
                'homepage': 'hero',
                'subpages': 'page-rooms',
                'footer': 'footer',
                'styles': 'styles',
                'seo': 'seo'
            };
            if (sectionMap[tabName]) {
                loadWebsiteBuilderSection(sectionMap[tabName]);
            }
            if (tabName === 'customdomain') {
                loadCustomDomainStatus();
            }
        }
        
        // Switch Home Page sub-tabs
        function switchHomeSubTab(subTabName) {
            // Update sub-tab buttons
            document.querySelectorAll('#editor-panel-homepage .sub-tab').forEach(tab => {
                if (tab.dataset.subtab === subTabName) {
                    tab.classList.add('active');
                    tab.style.background = '#7c3aed';
                    tab.style.color = 'white';
                } else {
                    tab.classList.remove('active');
                    tab.style.background = 'white';
                    tab.style.color = '#64748b';
                }
            });
            
            // Show/hide sub-panels
            document.querySelectorAll('.home-subtab-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const activePanel = document.getElementById('editor-homepage-' + subTabName);
            if (activePanel) {
                activePanel.style.display = 'block';
            }
            
            // Load data for this section
            loadWebsiteBuilderSection(subTabName);
        }
        
        // Custom Domain Functions
        async function loadCustomDomainStatus() {
            if (!selectedDeployedSiteId) return;
            
            const container = document.getElementById('custom-domain-current');
            const formDiv = document.getElementById('custom-domain-form');
            const successDiv = document.getElementById('custom-domain-success');
            const wpAdminContent = document.getElementById('wp-admin-access-content');
            
            try {
                const response = await fetch(`/api/deployed-sites/${selectedDeployedSiteId}`, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.site) {
                    const customDomain = data.site.custom_domain;
                    const originalUrl = data.site.site_url;
                    const blogId = data.site.blog_id;
                    
                    // Update custom domain section
                    if (customDomain) {
                        container.innerHTML = `
                            <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #166534;">âœ… Custom Domain Active</div>
                                        <a href="https://${customDomain}" target="_blank" style="color: #15803d; font-size: 1.1rem;">https://${customDomain}</a>
                                    </div>
                                    <button onclick="removeCustomDomain()" class="btn btn-sm" style="background: #ef4444; color: white;">Remove</button>
                                </div>
                            </div>
                            <div style="background: #f1f5f9; border-radius: 8px; padding: 0.75rem; font-size: 0.9rem; color: #64748b;">
                                <strong>Original URL:</strong> <a href="${originalUrl}" target="_blank">${originalUrl}</a>
                            </div>
                        `;
                        formDiv.style.display = 'none';
                        successDiv.style.display = 'none';
                    } else {
                        container.innerHTML = `
                            <div style="background: #f1f5f9; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                                <strong>Current URL:</strong> <a href="${originalUrl}" target="_blank">${originalUrl}</a>
                            </div>
                        `;
                        formDiv.style.display = 'block';
                        successDiv.style.display = 'none';
                    }
                    
                    // Update WordPress admin access section
                    const wpAdminUrl = originalUrl.replace(/\/$/, '') + '/wp-admin/';
                    wpAdminContent.innerHTML = `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-weight: 600;">Admin URL:</span>
                                <a href="${wpAdminUrl}" target="_blank" style="color: #7c3aed;">${wpAdminUrl}</a>
                            </div>
                            <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="color: #64748b;">Username:</span>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <code style="background: #e2e8f0; padding: 4px 8px; border-radius: 4px;">gasadmin</code>
                                        <button onclick="copyToClipboard('gasadmin')" class="btn btn-sm" style="padding: 4px 8px;">ðŸ“‹</button>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #64748b;">Password:</span>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <code id="wp-password-display" style="background: #e2e8f0; padding: 4px 8px; border-radius: 4px;">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</code>
                                        <button onclick="toggleWpPassword()" class="btn btn-sm" style="padding: 4px 8px;">ðŸ‘ï¸</button>
                                        <button onclick="copyWpPassword()" class="btn btn-sm" style="padding: 4px 8px;">ðŸ“‹</button>
                                    </div>
                                </div>
                            </div>
                            <button onclick="window.open('${wpAdminUrl}', '_blank')" class="btn" style="width: 100%; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                ðŸš€ Open WordPress Admin
                            </button>
                        </div>
                        <p style="margin: 0; color: #64748b; font-size: 0.85rem;">
                            <strong>Note:</strong> All multisite subsites use the same network admin credentials. Contact support if you need to reset the password.
                        </p>
                    `;
                }
            } catch (error) {
                console.error('Error loading custom domain status:', error);
            }
        }
        
        // WP Password helpers
        let wpPasswordVisible = false;
        const wpNetworkPassword = 'GAS-Admin-2024!'; // Network admin password
        
        function toggleWpPassword() {
            wpPasswordVisible = !wpPasswordVisible;
            const display = document.getElementById('wp-password-display');
            if (display) {
                display.textContent = wpPasswordVisible ? wpNetworkPassword : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            }
        }
        
        function copyWpPassword() {
            copyToClipboard(wpNetworkPassword);
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy', 'error');
            });
        }
        
        async function connectCustomDomain() {
            const domain = document.getElementById('custom-domain-input').value.trim().toLowerCase();
            
            if (!domain) {
                showNotification('Please enter a domain', 'error');
                return;
            }
            
            // Clean domain (remove http/https/www)
            const cleanDomain = domain.replace(/^(https?:\/\/)?(www\.)?/, '').replace(/\/$/, '');
            
            if (!selectedDeployedSiteId) {
                showNotification('No website selected', 'error');
                return;
            }
            
            const formDiv = document.getElementById('custom-domain-form');
            const progressDiv = document.getElementById('custom-domain-progress');
            const successDiv = document.getElementById('custom-domain-success');
            const progressText = document.getElementById('custom-domain-progress-text');
            
            formDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            progressText.textContent = 'Checking DNS...';
            
            try {
                // Step 1: Verify DNS
                progressText.textContent = 'Verifying DNS configuration...';
                
                // Step 2: Connect domain
                progressText.textContent = 'Creating SSL certificate...';
                
                const response = await fetch('/api/deployed-sites/connect-domain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        site_id: selectedDeployedSiteId,
                        domain: cleanDomain
                    })
                });
                
                const data = await response.json();
                
                progressDiv.style.display = 'none';
                
                if (data.success) {
                    successDiv.style.display = 'block';
                    document.getElementById('custom-domain-success-url').innerHTML = `
                        Your site is now live at:<br>
                        <a href="https://${cleanDomain}" target="_blank" style="color: #15803d; font-size: 1.1rem;">https://${cleanDomain}</a>
                    `;
                    
                    // Update the site URL shown in the header
                    setTimeout(() => loadCustomDomainStatus(), 2000);
                    
                    showNotification('Domain connected successfully!', 'success');
                } else {
                    formDiv.style.display = 'block';
                    showNotification(data.error || 'Failed to connect domain', 'error');
                }
            } catch (error) {
                progressDiv.style.display = 'none';
                formDiv.style.display = 'block';
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        async function removeCustomDomain() {
            if (!confirm('Are you sure you want to remove the custom domain? Your site will only be accessible via the sites.gas.travel URL.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/deployed-sites/remove-domain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        site_id: selectedDeployedSiteId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Domain removed', 'success');
                    loadCustomDomainStatus();
                } else {
                    showNotification(data.error || 'Failed to remove domain', 'error');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        // Switch Sub Pages tabs
        // Toggle page enabled status
        async function togglePageEnabled(pageType, enabled) {
            const statusDot = document.getElementById(`status-page-${pageType}`);
            if (statusDot) {
                statusDot.style.background = enabled ? '#10b981' : '#94a3b8';
            }
            
            // The enabled status will be saved when user clicks Save button
            console.log(`Page ${pageType} enabled: ${enabled}`);
        }
        
        // Update page status dots based on saved settings
        function updatePageStatusDots(settings) {
            const pages = ['about', 'gallery', 'offers', 'properties', 'dining', 'blog', 'attractions', 'reviews'];
            pages.forEach(page => {
                const checkbox = document.getElementById(`wb-page-${page}-enabled`);
                const statusDot = document.getElementById(`status-page-${page}`);
                if (checkbox && settings && settings[`page-${page}`]) {
                    const isEnabled = settings[`page-${page}`].enabled === true || settings[`page-${page}`].enabled === 'true';
                    checkbox.checked = isEnabled;
                    if (statusDot) {
                        statusDot.style.background = isEnabled ? '#10b981' : '#94a3b8';
                    }
                }
            });
        }
        
        // Trigger WordPress page sync - called automatically after saving page sections
        async function triggerWordPressPageSync() {
            // Get the deployed site URL from cached data
            if (!selectedDeployedSiteId) {
                console.log('No deployed site selected, skipping WordPress page sync');
                return;
            }
            
            try {
                // Use the site URL from cached website data
                const siteUrl = selectedWebsiteData?.site_url;
                
                if (!siteUrl) {
                    console.log('No site URL available, skipping WordPress page sync');
                    return;
                }
                
                const cleanSiteUrl = siteUrl.replace(/\/$/, ''); // Remove trailing slash
                
                // Try REST API first
                const restUrl = `${cleanSiteUrl}/wp-json/gas-booking/v1/sync-pages`;
                console.log('Triggering WordPress page sync via REST:', restUrl);
                
                try {
                    const syncResponse = await fetch(restUrl, { 
                        method: 'POST',
                        mode: 'cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const syncResult = await syncResponse.json();
                    console.log('REST sync result:', syncResult);
                } catch (e) {
                    console.log('REST sync failed, trying query string method:', e);
                    
                    // Fallback to query string method
                    const directSyncUrl = `${cleanSiteUrl}/?gas_sync_pages=1&format=json&t=${Date.now()}`;
                    fetch(directSyncUrl, { 
                        mode: 'no-cors',
                        cache: 'no-cache' 
                    }).catch(e => console.log('Direct page sync request sent (no-cors)'));
                }
            } catch (error) {
                console.log('Could not trigger WordPress page sync:', error);
            }
        }
        
        // Manual sync button handler
        async function syncPagesToWordPress(btn) {
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'â³ Syncing...';
            
            try {
                await triggerWordPressPageSync();
                btn.innerHTML = 'âœ… Sync Triggered!';
                showNotification('Page sync triggered! Changes will appear on your site within a few seconds.', 'success');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            } catch (error) {
                btn.innerHTML = 'âŒ Failed';
                showNotification('Could not trigger sync. Please refresh your WordPress site manually.', 'error');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }
        
        function switchSubPageTab(subTabName) {
            // Check if user is master_admin AND not viewing a different account
            // If viewing another account, show client experience (restricted)
            const baseAllowedForClients = ['page-rooms', 'page-contact'];
            const isMasterAdmin = currentAccount && currentAccount.role === 'master_admin';
            const isViewingOwnAccount = !selectedAccountId || selectedAccountId === currentAccount.id;
            const hasFullAccess = isMasterAdmin && isViewingOwnAccount;
            
            // Build allowed tabs based on plan features
            const allowedForClients = [...baseAllowedForClients];
            const features = accountEntitlements?.features || {};
            
            // Add Blog if plan includes it
            if (features.blog_module === true) {
                allowedForClients.push('page-blog');
            }
            // Add Attractions if plan includes it
            if (features.attractions_module === true) {
                allowedForClients.push('page-attractions');
            }
            // Add Reviews if plan includes it
            if (features.reviews_widget === true) {
                allowedForClients.push('page-reviews');
            }
            // About, Gallery, Dining, Offers, Properties are always available (free)
            allowedForClients.push('page-about', 'page-gallery', 'page-dining', 'page-offers', 'page-properties');
            
            if (!hasFullAccess && !allowedForClients.includes(subTabName)) {
                // Show upgrade prompt for locked features
                document.querySelectorAll('#editor-panel-subpages .sub-tab').forEach(tab => {
                    if (tab.dataset.subtab === subTabName) {
                        tab.classList.add('active');
                        tab.style.background = '#7c3aed';
                        tab.style.color = 'white';
                    } else {
                        tab.classList.remove('active');
                        tab.style.background = 'white';
                        tab.style.color = '#64748b';
                    }
                });
                
                document.querySelectorAll('.subpage-panel').forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // Determine which feature is needed
                let featureName = '';
                let featureLabel = '';
                if (subTabName === 'page-blog') {
                    featureName = 'blog_module';
                    featureLabel = 'Blog Module';
                } else if (subTabName === 'page-attractions') {
                    featureName = 'attractions_module';
                    featureLabel = 'Attractions Module';
                } else if (subTabName === 'page-reviews') {
                    featureName = 'reviews_widget';
                    featureLabel = 'Reviews Widget';
                }
                
                // Show upgrade panel
                let upgradePanel = document.getElementById('editor-subpage-upgrade');
                if (!upgradePanel) {
                    upgradePanel = document.createElement('div');
                    upgradePanel.id = 'editor-subpage-upgrade';
                    upgradePanel.className = 'subpage-panel';
                    document.getElementById('editor-panel-subpages').appendChild(upgradePanel);
                }
                upgradePanel.innerHTML = `
                    <div style="text-align: center; padding: 80px 40px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; border: 2px solid #f59e0b; border-radius: 12px; overflow: hidden;">
                        <div style="font-size: 64px; margin-bottom: 20px;"></div>
                        <h2 style="color: #92400e; margin-bottom: 10px;">Upgrade Required</h2>
                        <p style="color: #a16207; max-width: 400px; margin: 0 auto 20px;">The ${featureLabel} is available on our Professional plan and above.</p>
                        <button onclick="showView('billing')" class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-size: 1rem;">
                             Upgrade Plan
                        </button>
                    </div>
                `;
                upgradePanel.style.display = 'block';
                return;
            }
            
            // Update sub-tab buttons
            document.querySelectorAll('#editor-panel-subpages .sub-tab').forEach(tab => {
                if (tab.dataset.subtab === subTabName) {
                    tab.classList.add('active');
                    tab.style.background = '#7c3aed';
                    tab.style.color = 'white';
                } else {
                    tab.classList.remove('active');
                    tab.style.background = 'white';
                    tab.style.color = '#64748b';
                }
            });
            
            // Hide coming soon panel if it exists
            const comingSoonPanel = document.getElementById('editor-subpage-coming-soon');
            if (comingSoonPanel) comingSoonPanel.style.display = 'none';
            
            // Hide upgrade panel if it exists
            const upgradePanel = document.getElementById('editor-subpage-upgrade');
            if (upgradePanel) upgradePanel.style.display = 'none';
            
            // Show/hide sub-panels
            document.querySelectorAll('.subpage-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const activePanel = document.getElementById('editor-subpage-' + subTabName);
            if (activePanel) {
                activePanel.style.display = 'block';
            }
            
            // Load data for this section
            loadWebsiteBuilderSection(subTabName);
        }
        
        // Switch Footer tabs
        function switchFooterTab(subTabName) {
            // Update sub-tab buttons
            document.querySelectorAll('#editor-panel-footer .sub-tab').forEach(tab => {
                if (tab.dataset.subtab === subTabName) {
                    tab.classList.add('active');
                    tab.style.background = '#7c3aed';
                    tab.style.color = 'white';
                } else {
                    tab.classList.remove('active');
                    tab.style.background = 'white';
                    tab.style.color = '#64748b';
                }
            });
            
            // Show/hide sub-panels
            document.querySelectorAll('.footer-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const activePanel = document.getElementById('editor-footer-' + subTabName);
            if (activePanel) {
                activePanel.style.display = 'block';
            }
            
            // Load data for this section
            const sectionMap = {
                'footer-main': 'footer',
                'footer-terms': 'page-terms',
                'footer-privacy': 'page-privacy'
            };
            if (sectionMap[subTabName]) {
                loadWebsiteBuilderSection(sectionMap[subTabName]);
            }
        }
        
        // Back to Sites List - clears website selection and returns to Create Sites view
        function backToSitesList() {
            // Clear selected website
            selectedWebsiteId = null;
            selectedWebsiteData = null;
            selectedDeployedSiteId = null;
            
            // Note: Do NOT clear selectedAccountId here - that's the user's account filter
            // If they were viewing a specific account's sites, keep that context
            
            // Navigate back to sites list
            navClick(null, 'deploy-sites');
            
            // Reload the sites list to ensure we see all sites for current account context
            setTimeout(() => loadDeployedSites(), 100);
        }
        
        let selectedAccountName = null;
        
        // Run auth check after global state is declared
        checkAuth();
        
        // Restore nav collapsed states
        restoreNavState();
        
        // Helper function to get account query param
        function getAccountParam() {
            if (selectedAccountId) {
                return `account_id=${selectedAccountId}`;
            }
            return '';
        }
        
        // Helper to build query string with account filter
        function buildQueryString(additionalParams = []) {
            let params = [];
            if (selectedAccountId) {
                params.push(`account_id=${selectedAccountId}`);
            }
            params = params.concat(additionalParams.filter(p => p));
            return params.length > 0 ? '?' + params.join('&') : '';
        }
        
        // Set agency filter
        function setAgencyFilter(agencyId, agencyName) {
            selectedAgencyId = agencyId;
            selectedAgencyName = agencyName;
            
            // Show banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            banner.style.display = 'flex';
            nameEl.textContent = agencyName;
            
            // Reload current view with filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                showView(viewName);
            }
        }
        
        // Clear agency filter
        function clearAgencyFilter() {
            selectedAgencyId = null;
            selectedAgencyName = null;
            
            // Hide banner
            document.getElementById('agencyFilterBanner').style.display = 'none';
            
            // Reload current view without filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                showView(viewName);
            }
        }
        
        // Get current client internal ID for API calls
        function getClientId() {
            if (!currentClientPublicId) return null;
            return clientIdMap[currentClientPublicId] || null;
        }
        
        // Get client ID param for API URLs
        function getClientParam() {
            const clientId = getClientId();
            return clientId ? `client_id=${clientId}` : '';
        }
        
        // Load clients into the selector dropdown
        async function loadClientSelector() {
            try {
                const [accountsRes, agenciesRes] = await Promise.all([
                    fetch('/api/admin/accounts'),
                    fetch('/api/admin/agencies')
                ]);
                const accountsData = await accountsRes.json();
                const agenciesData = await agenciesRes.json();
                
                const selector = document.getElementById('globalClientSelector');
                if (!selector) return;
                
                // Check if current user is master_admin
                const isMaster = currentAccount && currentAccount.role === 'master_admin';
                
                selector.innerHTML = '';
                clientIdMap = {}; // Reset map
                
                // Only show "All Clients" option for master admins
                if (isMaster) {
                    selector.innerHTML = '<option value=""> All Clients (Admin View)</option>';
                }
                
                const agencies = agenciesData.agencies || [];
                const accounts = accountsData.accounts || [];
                
                // Filter out master_admin accounts - they shouldn't appear in the selector
                const clientAccounts = accounts.filter(a => a.role !== 'master_admin');
                
                // Add agencies first (only for master admins)
                if (isMaster && agencies.length > 0) {
                    const agencyGroup = document.createElement('optgroup');
                    agencyGroup.label = ' Agencies';
                    agencies.forEach(agency => {
                        const option = document.createElement('option');
                        option.value = `agency_${agency.id}`;
                        option.textContent = agency.name;
                        agencyGroup.appendChild(option);
                    });
                    selector.appendChild(agencyGroup);
                }
                
                // Add client accounts
                if (clientAccounts.length > 0) {
                    const clientGroup = document.createElement('optgroup');
                    clientGroup.label = ' Accounts';
                    clientAccounts.forEach(account => {
                        const option = document.createElement('option');
                        const publicId = account.public_id || account.id;
                        option.value = publicId;
                        option.textContent = account.business_name || account.name || 'Account';
                        clientGroup.appendChild(option);
                        clientIdMap[publicId] = account.id;
                    });
                    selector.appendChild(clientGroup);
                }
                
                // For non-master users, auto-select their own account and hide selector
                if (!isMaster && currentAccount) {
                    const ownPublicId = currentAccount.public_id;
                    if (ownPublicId) {
                        selector.value = ownPublicId;
                        switchClient(ownPublicId, false);
                        // Hide the selector for non-master users - they can only see their own data
                        selector.style.display = 'none';
                    }
                } else {
                    selector.style.display = '';
                    // Check URL for client parameter and select it
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlClientId = urlParams.get('client');
                    if (urlClientId && clientIdMap[urlClientId]) {
                        selector.value = urlClientId;
                        switchClient(urlClientId, false);
                    }
                }
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }
        
        // Switch to a different client
        function switchClient(publicId, updateUrl = true) {
            currentClientPublicId = publicId || null;
            
            // Update URL so it's bookmarkable/shareable
            if (updateUrl) {
                const url = new URL(window.location);
                if (publicId) {
                    url.searchParams.set('client', publicId);
                } else {
                    url.searchParams.delete('client');
                }
                window.history.pushState({}, '', url);
            }
            
            // Update indicator
            const indicator = document.getElementById('clientIndicator');
            const indicatorText = document.getElementById('clientIndicatorText');
            
            if (!currentClientPublicId) {
                indicator.className = 'client-indicator all-clients';
                indicatorText.textContent = 'Viewing all clients';
            } else {
                indicator.className = 'client-indicator';
                const selector = document.getElementById('globalClientSelector');
                const selectedOption = selector.options[selector.selectedIndex];
                indicatorText.textContent = ' ' + selectedOption.textContent;
            }
            
            // Reload current view with new client context
            const activeNav = document.querySelector('.nav-item.active');
            if (activeNav) {
                const viewName = activeNav.dataset.view;
                showView(viewName);
            }
        }
        
        // Simple navigation click handler
        // Toggle nav section collapse/expand
        function toggleNavSection(labelEl) {
            const section = labelEl.closest('.nav-section');
            section.classList.toggle('collapsed');
            
            // Save collapsed state to localStorage
            saveNavState();
        }
        
        // Toggle sub-section dropdowns (Home Page, Sub Pages)
        function toggleSubSection(toggleEl) {
            const subsection = toggleEl.closest('.nav-subsection');
            const items = subsection.querySelector('.nav-subsection-items');
            const arrow = subsection.querySelector('.nav-subsection-arrow');
            
            if (items.style.display === 'none') {
                items.style.display = 'block';
                arrow.textContent = '';
                subsection.classList.add('expanded');
            } else {
                items.style.display = 'none';
                arrow.textContent = '';
                subsection.classList.remove('expanded');
            }
        }
        
        // Save nav collapsed states
        function saveNavState() {
            const sections = document.querySelectorAll('.nav-section');
            const states = {};
            sections.forEach((section, index) => {
                const label = section.querySelector('.nav-label');
                if (label) {
                    states[label.textContent.trim()] = section.classList.contains('collapsed');
                }
            });
            localStorage.setItem('gas_nav_states', JSON.stringify(states));
        }
        
        // Restore nav collapsed states
        function restoreNavState() {
            try {
                // Clear old states to apply new collapsed-by-default behavior
                // Remove this line after a few days once all users have updated
                const version = localStorage.getItem('gas_nav_version');
                if (version !== '2') {
                    localStorage.removeItem('gas_nav_states');
                    localStorage.setItem('gas_nav_version', '2');
                }
                
                const states = JSON.parse(localStorage.getItem('gas_nav_states') || '{}');
                
                document.querySelectorAll('.nav-section').forEach(section => {
                    const label = section.querySelector('.nav-label');
                    if (label) {
                        const sectionName = label.textContent.trim();
                        // Only apply saved state if it exists
                        if (states[sectionName] !== undefined) {
                            if (states[sectionName]) {
                                section.classList.add('collapsed');
                            } else {
                                section.classList.remove('collapsed');
                            }
                        }
                        // If no saved state, keep the HTML default (collapsed)
                    }
                });
                
                // Always expand the section with the active item
                const activeItem = document.querySelector('.nav-item.active');
                if (activeItem) {
                    const section = activeItem.closest('.nav-section');
                    if (section) section.classList.remove('collapsed');
                }
            } catch (e) {
                console.error('Error restoring nav state:', e);
            }
        }
        
        function navClick(el, viewName) {
            // Update active state
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if (el) {
                el.classList.add('active');
                
                // Expand the section if it's collapsed
                const section = el.closest('.nav-section');
                if (section && section.classList.contains('collapsed')) {
                    section.classList.remove('collapsed');
                    saveNavState();
                }
            } else {
                // Find and activate the nav item for this view
                const navItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                    const section = navItem.closest('.nav-section');
                    if (section && section.classList.contains('collapsed')) {
                        section.classList.remove('collapsed');
                        saveNavState();
                    }
                }
            }
            
            // Show the view
            showView(viewName);
            
            // Update AI chat context if open
            if (typeof updateAIChatContext === 'function') {
                updateAIChatContext();
            }
        }

        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            // Show requested view
            const viewEl = document.getElementById(viewName);
            if (viewEl) {
                viewEl.classList.add('active');
            } else {
                console.error('View not found:', viewName);
                return;
            }
            
            // Load data for specific views
            if (viewName === 'dashboard') loadDashboard();
            if (viewName === 'my-account') loadMyAccount();
            if (viewName === 'management-requests') loadManagementRequests();
            if (viewName === 'accounts') loadAccounts();
            if (viewName === 'agencies') loadAgencies();
            if (viewName === 'clients') loadClients();
            if (viewName === 'properties') loadProperties();
            if (viewName === 'rooms') loadRooms();
            if (viewName === 'images') loadImages();
            if (viewName === 'amenities') loadAmenities();
            if (viewName === 'availability') loadAvailabilityView();
            if (viewName === 'tasks') loadTasks();
            if (viewName === 'deploy-sites') {
                checkVpsStatus();
                loadDeployedSites();
            }
            if (viewName === 'my-custom-site') {
                loadMyCustomSite();
            }
            if (viewName === 'custom-sites') {
                loadCustomSiteRequests();
            }
            if (viewName === 'plugin-licenses') {
                loadPluginLicenses();
            }
            if (viewName === 'integrations') loadIntegrations();
            if (viewName === 'offers') loadOffers();
            if (viewName === 'vouchers') loadVouchers();
            if (viewName === 'upsells') loadUpsells();
            if (viewName === 'vendors') loadVendors();
            if (viewName === 'vendor-requests') loadVendorRequests();
            if (viewName === 'service-credentials') loadCredentials();
            if (viewName === 'fees') loadFees();
            if (viewName === 'taxes') loadTaxes();
            if (viewName === 'payments') initPaymentsView();
            if (viewName === 'deposit-rules') initDepositRulesView();
            if (viewName === 'bookings') loadBookings();
            if (viewName === 'marketing') loadMarketingProperties();
            if (viewName === 'turbine-connections') loadTurbineConnections();
            if (viewName === 'turbine-campaigns') loadTurbineCampaigns();
            if (viewName === 'turbine-generator') { loadTurbineConnections(); loadTurbinePosts(); }
            if (viewName === 'network-contacts') loadNetworkContacts();
            if (viewName === 'network-tags') loadNetworkTags();
            if (viewName === 'network-segments') loadNetworkSegments();
            if (viewName === 'wb-header') loadWebsiteSection('header');
            if (viewName === 'wb-hero') loadWebsiteSection('hero');
            if (viewName === 'wb-intro') loadWebsiteSection('intro');
            if (viewName === 'wb-featured') loadWebsiteSection('featured');
            if (viewName === 'wb-about') loadWebsiteSection('about');
            if (viewName === 'wb-reviews') {
                loadWebsiteSection('reviews');
                // Check if user has reviews_widget feature
                const features = accountEntitlements?.features || {};
                const hasReviews = features.reviews_widget === true;
                const upgradeBanner = document.getElementById('wb-reviews-upgrade-banner');
                const content = document.getElementById('wb-reviews-content');
                const saveBtn = document.getElementById('wb-reviews-save-btn');
                if (upgradeBanner && content) {
                    if (hasReviews) {
                        upgradeBanner.style.display = 'none';
                        content.style.display = 'block';
                        if (saveBtn) saveBtn.style.display = 'block';
                    } else {
                        upgradeBanner.style.display = 'block';
                        content.style.display = 'none';
                        if (saveBtn) saveBtn.style.display = 'none';
                    }
                }
            }
            if (viewName === 'wb-cta') loadWebsiteSection('cta');
            if (viewName === 'wb-footer') loadWebsiteSection('footer');
            if (viewName === 'wb-styles') loadWebsiteSection('styles');
            
            // Sub Pages
            if (viewName === 'wb-page-about') loadSubPage('about');
            if (viewName === 'wb-page-gallery') loadSubPage('gallery');
            if (viewName === 'wb-page-blog') loadSubPage('blog');
            if (viewName === 'wb-page-attractions') loadSubPage('attractions');
            if (viewName === 'wb-page-dining') loadSubPage('dining');
            if (viewName === 'wb-page-contact') {
                loadSubPage('contact');
                // Also populate contact info from footer settings
                setTimeout(() => {
                    const footerEmail = document.getElementById('wb-footer-email')?.value;
                    const footerPhone = document.getElementById('wb-footer-phone')?.value;
                    const footerAddress = document.getElementById('wb-footer-address')?.value;
                    if (footerEmail) document.getElementById('wb-page-contact-email').value = footerEmail;
                    if (footerPhone) document.getElementById('wb-page-contact-phone').value = footerPhone;
                    if (footerAddress) document.getElementById('wb-page-contact-address').value = footerAddress;
                }, 100);
            }
            if (viewName === 'wb-page-terms') loadSubPage('terms');
            if (viewName === 'wb-page-privacy') loadSubPage('privacy');
            
            if (viewName === 'wordpress') loadWordPressView();
            
            // GasSync views
            if (viewName === 'gas-sync-dashboard') loadGasSyncDashboard();
            if (viewName === 'gas-sync-connections') {
                loadGasSyncConnections().then(() => {
                    // Check if we should auto-open a connection modal (from wizard redirect)
                    const openConnectionId = sessionStorage.getItem('openConnectionId');
                    if (openConnectionId) {
                        sessionStorage.removeItem('openConnectionId');
                        showConnectionDetails(parseInt(openConnectionId));
                    }
                });
            }
            if (viewName === 'gas-sync-properties') { loadGasSyncConnections().then(() => loadSyncedProperties()); }
            if (viewName === 'gas-sync-logs') { loadGasSyncConnections().then(() => loadSyncLogs()); }
            if (viewName === 'sync-review') { window.location.href = '/sync-review'; return; }
            
            // New sidebar views
            if (viewName === 'app-blog') loadBlogByTab();
            if (viewName === 'app-attractions') loadAttractionsByTab();
            if (viewName === 'app-reviews') loadAppReviews();
            if (viewName === 'app-seo') loadSeoSites();
            if (viewName === 'api-docs') {
                const urlInput = document.getElementById('api-docs-base-url');
                if (urlInput) urlInput.value = window.location.origin;
                loadApiKeys();
            }
            
            // Website Builder views
            if (viewName.startsWith('wb-')) {
                const section = viewName.replace('wb-', '');
                loadWebsiteSection(section);
            }
        }

        // =========================================================
        // WEBSITE BUILDER FUNCTIONS
        // =========================================================
        
        async function loadWebsiteBuilderSection(section) {
            try {
                // Determine which container to update - editor panel (visible) or original view
                const editorPanelMap = {
                    'header': 'wb-header',
                    'hero': 'wb-hero',
                    'intro': 'editor-intro-content',
                    'featured': 'editor-featured-content',
                    'about': 'editor-about-content',
                    'reviews': 'editor-reviews-content',
                    'cta': 'editor-cta-content',
                    'footer': 'editor-footer-content',
                    'styles': 'editor-styles-content',
                    'seo': 'editor-seo-content',
                    'page-rooms': 'editor-subpage-page-rooms',
                    'page-about': 'editor-subpage-page-about',
                    'page-gallery': 'editor-subpage-page-gallery',
                    'page-offers': 'editor-subpage-page-offers',
                    'page-properties': 'editor-subpage-page-properties',
                    'page-blog': 'editor-subpage-page-blog',
                    'page-attractions': 'editor-subpage-page-attractions',
                    'page-dining': 'editor-subpage-page-dining',
                    'page-reviews': 'editor-subpage-page-reviews',
                    'page-contact': 'editor-subpage-page-contact',
                    'page-terms': 'editor-footer-footer-terms',
                    'page-privacy': 'editor-footer-footer-privacy'
                };
                
                // Get container for this section
                const editorContainerId = editorPanelMap[section];
                const editorContainer = editorContainerId ? document.getElementById(editorContainerId) : null;
                
                // Helper to get element - prefer editor container if visible
                const getEl = (id) => {
                    if (editorContainer) {
                        const el = editorContainer.querySelector(`[id="${id}"]`);
                        if (el) return el;
                    }
                    return document.getElementById(id);
                };
                
                // Get template defaults for this section
                const template = selectedWebsiteData?.template || 'developer-light';
                const defaults = getTemplateDefaults(section);
                console.log(`Loading section "${section}" with template "${template}"`, defaults);
                
                // Apply template defaults first (will be overwritten by saved values)
                Object.keys(defaults).forEach(key => {
                    const elId = `wb-${section}-${key}`;
                    const pickerId = `wb-${section}-${key}-picker`;
                    const el = getEl(elId);
                    const pickerEl = getEl(pickerId);
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = defaults[key];
                        } else {
                            el.value = defaults[key];
                        }
                        if (pickerEl) pickerEl.value = defaults[key];
                    }
                });
                
                // Use NEW clean endpoint for deployed sites
                let data = null;
                
                if (selectedDeployedSiteId) {
                    // PRIMARY: Use new per-deployed-site endpoint
                    try {
                        const response = await fetch(`/api/deployed-sites/${selectedDeployedSiteId}/settings/${section}`);
                        data = await response.json();
                        console.log(`Deployed site ${selectedDeployedSiteId} settings response:`, data);
                    } catch (e) {
                        console.error('Failed to load from deployed site endpoint:', e);
                    }
                }
                
                // Apply saved settings if we got any
                if (data && data.success && data.settings) {
                    console.log(`Applying saved ${section} settings from source: ${data.source}`);
                    
                    // Map sections to their cloned editor panel IDs
                    const clonedPanelMap = {
                        'header': 'editor-header-content',
                        'hero': 'editor-hero-content',
                        'intro': 'editor-intro-content',
                        'featured': 'editor-featured-content',
                        'about': 'editor-about-content',
                        'reviews': 'editor-reviews-content',
                        'cta': 'editor-cta-content'
                    };
                    
                    const clonedPanelId = clonedPanelMap[section];
                    const clonedPanel = clonedPanelId ? document.getElementById(clonedPanelId) : null;
                    
                    Object.keys(data.settings).forEach(key => {
                        const elId = `wb-${section}-${key}`;
                        const pickerId = `wb-${section}-${key}-picker`;
                        
                        // Update original element
                        const el = getEl(elId);
                        const pickerEl = getEl(pickerId);
                        if (el) {
                            if (el.type === 'checkbox') {
                                el.checked = data.settings[key] === true || data.settings[key] === 'true' || data.settings[key] === '1' || data.settings[key] === 1;
                            } else {
                                el.value = data.settings[key] ?? '';
                            }
                            if (pickerEl && data.settings[key]) {
                                pickerEl.value = data.settings[key];
                            }
                        }
                        
                        // Also update cloned panel element if it exists
                        if (clonedPanel) {
                            const clonedEl = clonedPanel.querySelector(`#${elId}`);
                            const clonedPickerEl = clonedPanel.querySelector(`#${pickerId}`);
                            if (clonedEl) {
                                if (clonedEl.type === 'checkbox') {
                                    clonedEl.checked = data.settings[key] === true || data.settings[key] === 'true' || data.settings[key] === '1' || data.settings[key] === 1;
                                } else {
                                    clonedEl.value = data.settings[key] ?? '';
                                }
                            }
                            if (clonedPickerEl && data.settings[key]) {
                                clonedPickerEl.value = data.settings[key];
                            }
                        }
                    });
                    
                    // Handle image preview
                    if (data.settings.image) {
                        const preview = getEl(`wb-${section}-image-preview`);
                        if (preview) {
                            preview.innerHTML = `<img src="${data.settings.image}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                        }
                    }
                    
                    // Handle hero video URL - set toggle and preview
                    if (section === 'hero' && data.settings['video-url']) {
                        // Set radio to video
                        const videoRadio = document.querySelector('input[name="hero-bg-type"][value="video"]');
                        if (videoRadio) {
                            videoRadio.checked = true;
                            toggleHeroBackgroundType('video');
                        }
                        // Preview the video
                        previewHeroVideo(data.settings['video-url']);
                    }
                    
                    // Handle hero background type and slider images
                    if (section === 'hero') {
                        const bgType = data.settings['background-type'] || 'image';
                        const bgRadio = document.querySelector(`input[name="hero-bg-type"][value="${bgType}"]`);
                        if (bgRadio) {
                            bgRadio.checked = true;
                            toggleHeroBackgroundType(bgType);
                        }
                        
                        // Load slider images if present
                        for (let i = 1; i <= 4; i++) {
                            const slideUrl = data.settings[`slide-${i}-url`];
                            // Skip if empty, null, undefined, or the literal string "undefined"
                            if (slideUrl && slideUrl !== 'undefined' && slideUrl !== '') {
                                const preview = document.getElementById(`wb-hero-slide-${i}-preview`);
                                const urlField = document.getElementById(`wb-hero-slide-${i}-url`);
                                if (preview) {
                                    preview.style.backgroundImage = `url(${slideUrl})`;
                                    const placeholder = preview.querySelector('.slide-placeholder');
                                    const removeBtn = preview.querySelector('.remove-slide-btn');
                                    if (placeholder) placeholder.style.display = 'none';
                                    if (removeBtn) removeBtn.style.display = 'block';
                                }
                                if (urlField) urlField.value = slideUrl;
                            }
                        }
                    }
                    
                    // Handle reviews app toggle
                    if (section === 'reviews') {
                        toggleReviewsAppFields();
                    }
                } else {
                    console.log(`No saved ${section} settings, using template defaults`);
                }
            } catch (error) {
                console.error('Error loading website builder section:', error);
            }
        }
        
        // Generate SEO Meta Title & Description with AI
        async function generateSEOMeta(section) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Generating...';
            btn.disabled = true;
            
            try {
                let businessName = document.getElementById('wb-header-site-name')?.value || 'Our Property';
                
                const pageTypes = {
                    'hero': 'homepage',
                    'rooms': 'rooms and accommodation',
                    'about': 'about us',
                    'gallery': 'photo gallery',
                    'blog': 'blog',
                    'attractions': 'local attractions',
                    'dining': 'restaurant and dining',
                    'contact': 'contact',
                    'terms': 'terms and conditions',
                    'privacy': 'privacy policy'
                };
                
                const pageContext = pageTypes[section] || section;
                
                const response = await fetch('/api/admin/generate-seo-meta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        page_type: pageContext,
                        business_name: businessName,
                        account_id: selectedAccountId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Set the meta title and description
                    const titleId = section === 'hero' ? 'wb-hero-meta-title' : `wb-page-${section}-meta-title`;
                    const descId = section === 'hero' ? 'wb-hero-meta-description' : `wb-page-${section}-meta-description`;
                    
                    const titleEl = document.getElementById(titleId);
                    const descEl = document.getElementById(descId);
                    
                    if (titleEl && data.meta_title) titleEl.value = data.meta_title;
                    if (descEl && data.meta_description) descEl.value = data.meta_description;
                    
                    showNotification(`Generated SEO meta for ${pageContext}!`, 'success');
                } else {
                    showNotification('Failed to generate: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error generating SEO meta:', error);
                showNotification('Error generating SEO meta', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // FAQ Schema Management Functions
        function addFAQItem(section, question = '', answer = '') {
            const listId = section === 'hero' ? 'wb-hero-faq-list' : `wb-page-${section}-faq-list`;
            const list = document.getElementById(listId);
            if (!list) return;
            
            const index = list.children.length;
            const item = document.createElement('div');
            item.className = 'faq-item';
            item.style.cssText = 'background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;';
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: #64748b; font-size: 0.85rem;">FAQ ${index + 1}</span>
                    <button type="button" onclick="this.closest('.faq-item').remove()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.75rem;"> Remove</button>
                </div>
                <div class="form-group" style="margin-bottom: 0.5rem;">
                    <label class="form-label" style="font-size: 0.85rem;">Question</label>
                    <input type="text" class="form-input faq-question" value="${escapeHtml(question)}" placeholder="e.g., What is your cancellation policy?">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label" style="font-size: 0.85rem;">Answer</label>
                    <textarea class="form-textarea faq-answer" rows="3" style="resize: none;" placeholder="Provide a helpful, concise answer...">${escapeHtml(answer)}</textarea>
                </div>
            `;
            list.appendChild(item);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getFAQsFromSection(section) {
            const listId = section === 'hero' ? 'wb-hero-faq-list' : `wb-page-${section}-faq-list`;
            const list = document.getElementById(listId);
            if (!list) return [];
            
            const faqs = [];
            list.querySelectorAll('.faq-item').forEach(item => {
                const question = item.querySelector('.faq-question')?.value?.trim();
                const answer = item.querySelector('.faq-answer')?.value?.trim();
                if (question && answer) {
                    faqs.push({ question, answer });
                }
            });
            return faqs;
        }
        
        function loadFAQsToSection(section, faqs) {
            const listId = section === 'hero' ? 'wb-hero-faq-list' : `wb-page-${section}-faq-list`;
            const list = document.getElementById(listId);
            if (!list || !faqs) return;
            
            list.innerHTML = '';
            faqs.forEach(faq => {
                addFAQItem(section, faq.question, faq.answer);
            });
        }
        
        async function generateFAQs(section) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Generating...';
            btn.disabled = true;
            
            try {
                // Get page context
                let pageContext = '';
                let businessName = document.getElementById('wb-header-site-name')?.value || 'Our Property';
                
                // Map section to page type for context
                const pageTypes = {
                    'hero': 'homepage',
                    'rooms': 'accommodation/rooms',
                    'about': 'about us',
                    'gallery': 'photo gallery',
                    'blog': 'blog',
                    'attractions': 'local attractions and things to do',
                    'dining': 'restaurant and dining',
                    'contact': 'contact information',
                    'terms': 'terms and conditions',
                    'privacy': 'privacy policy'
                };
                
                pageContext = pageTypes[section] || section;
                
                const response = await fetch('/api/admin/generate-faqs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        page_type: pageContext,
                        business_name: businessName,
                        account_id: selectedAccountId
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.faqs) {
                    // Clear existing and add new FAQs
                    const listId = section === 'hero' ? 'wb-hero-faq-list' : `wb-page-${section}-faq-list`;
                    const list = document.getElementById(listId);
                    if (list) list.innerHTML = '';
                    
                    data.faqs.forEach(faq => {
                        addFAQItem(section, faq.question, faq.answer);
                    });
                    
                    showNotification(`Generated ${data.faqs.length} FAQs for ${pageContext}`, 'success');
                } else {
                    showNotification('Failed to generate FAQs: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error generating FAQs:', error);
                showNotification('Error generating FAQs', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // AI Generation for Intro Section
        async function generateIntroTitle() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ¨ Generating...';
            btn.disabled = true;
            
            try {
                const businessName = document.getElementById('wb-header-site-name')?.value || 
                                    document.getElementById('wb-hero-headline')?.value || 'Our Property';
                const location = document.getElementById('wb-hero-subheadline')?.value || '';
                
                const response = await fetch('/api/admin/ai/generate-website-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        type: 'intro_title',
                        business_name: businessName,
                        location: location,
                        account_id: selectedAccountId
                    })
                });
                
                const data = await response.json();
                if (data.success && data.content) {
                    document.getElementById('wb-intro-title').value = data.content;
                    showNotification('Title generated!', 'success');
                } else {
                    showNotification('Failed to generate: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Generate intro title error:', error);
                showNotification('Generation failed: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generateIntroText() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ¨ Generating...';
            btn.disabled = true;
            
            try {
                const businessName = document.getElementById('wb-header-site-name')?.value || 
                                    document.getElementById('wb-hero-headline')?.value || 'Our Property';
                const location = document.getElementById('wb-hero-subheadline')?.value || '';
                const introTitle = document.getElementById('wb-intro-title')?.value || '';
                
                const response = await fetch('/api/admin/ai/generate-website-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        type: 'intro_text',
                        business_name: businessName,
                        location: location,
                        title: introTitle,
                        account_id: selectedAccountId
                    })
                });
                
                const data = await response.json();
                if (data.success && data.content) {
                    document.getElementById('wb-intro-text').value = data.content;
                    showNotification('Intro text generated!', 'success');
                } else {
                    showNotification('Failed to generate: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Generate intro text error:', error);
                showNotification('Generation failed: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // AI Generation for About Section
        async function generateAboutTitle() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ¨ Generating...';
            btn.disabled = true;
            
            try {
                const businessName = document.getElementById('wb-header-site-name')?.value || 
                                    document.getElementById('wb-hero-headline')?.value || 'Our Property';
                const location = document.getElementById('wb-hero-subheadline')?.value || '';
                
                const response = await fetch('/api/admin/ai/generate-website-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        type: 'about_title',
                        business_name: businessName,
                        location: location,
                        account_id: selectedAccountId
                    })
                });
                
                const data = await response.json();
                if (data.success && data.content) {
                    document.getElementById('wb-about-title').value = data.content;
                    showNotification('Title generated!', 'success');
                } else {
                    showNotification('Failed to generate: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Generate about title error:', error);
                showNotification('Generation failed: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generateAboutText() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ¨ Generating...';
            btn.disabled = true;
            
            try {
                const businessName = document.getElementById('wb-header-site-name')?.value || 
                                    document.getElementById('wb-hero-headline')?.value || 'Our Property';
                const location = document.getElementById('wb-hero-subheadline')?.value || '';
                const aboutTitle = document.getElementById('wb-about-title')?.value || '';
                
                const response = await fetch('/api/admin/ai/generate-website-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        type: 'about_text',
                        business_name: businessName,
                        location: location,
                        title: aboutTitle,
                        account_id: selectedAccountId
                    })
                });
                
                const data = await response.json();
                if (data.success && data.content) {
                    document.getElementById('wb-about-text').value = data.content;
                    showNotification('About text generated!', 'success');
                } else {
                    showNotification('Failed to generate: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Generate about text error:', error);
                showNotification('Generation failed: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // AI Generation for About Page (standalone page, not homepage section)
        async function generatePageAboutTitle() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ¨ Generating...';
            btn.disabled = true;
            
            try {
                const businessName = document.getElementById('wb-header-site-name')?.value || 'Our Property';
                
                const response = await fetch('/api/admin/ai/generate-website-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        type: 'page_about_title',
                        business_name: businessName,
                        account_id: selectedAccountId
                    })
                });
                
                const data = await response.json();
                if (data.success && data.content) {
                    document.getElementById('wb-page-about-title').value = data.content;
                    showNotification('Title generated!', 'success');
                } else {
                    showNotification('Failed to generate: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Generate page about title error:', error);
                showNotification('Generation failed: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generatePageAboutContent() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ¨ Generating...';
            btn.disabled = true;
            
            try {
                const businessName = document.getElementById('wb-header-site-name')?.value || 'Our Property';
                const location = document.getElementById('wb-hero-subheadline')?.value || '';
                const pageTitle = document.getElementById('wb-page-about-title')?.value || 'About Us';
                
                const response = await fetch('/api/admin/ai/generate-website-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        type: 'page_about_content',
                        business_name: businessName,
                        location: location,
                        title: pageTitle,
                        account_id: selectedAccountId
                    })
                });
                
                const data = await response.json();
                if (data.success && data.content) {
                    document.getElementById('wb-page-about-content').value = data.content;
                    showNotification('About page content generated!', 'success');
                } else {
                    showNotification('Failed to generate: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Generate page about content error:', error);
                showNotification('Generation failed: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Preview and upload images for sub-pages (about, gallery, etc.)
        async function previewPageImage(page, field) {
            const fileInput = document.getElementById(`wb-page-${page}-${field}-file`);
            const preview = document.getElementById(`wb-page-${page}-${field}-preview`);
            const urlField = document.getElementById(`wb-page-${page}-${field}`);
            
            if (!fileInput || !fileInput.files || !fileInput.files[0]) return;
            
            const file = fileInput.files[0];
            
            // Show preview immediately
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.style.backgroundImage = `url(${e.target.result})`;
                const placeholder = preview.querySelector('span');
                if (placeholder) placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            // Upload to server
            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('section', `page-${page}-${field}`);
                
                const siteId = selectedDeployedSiteId || localStorage.getItem('gas_selected_client_id') || getClientId();
                if (siteId) {
                    formData.append('deployed_site_id', siteId);
                }
                
                const token = localStorage.getItem('gas_token');
                const response = await fetch('/api/admin/website-builder/upload-image', {
                    method: 'POST',
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (urlField && data.url) {
                        urlField.value = data.url;
                    }
                    showNotification('Image uploaded successfully', 'success');
                } else {
                    showNotification('Failed to upload image', 'error');
                }
            } catch (error) {
                console.error('Page image upload error:', error);
                showNotification('Upload failed: ' + error.message, 'error');
            }
        }
        
        async function saveWebsiteSection(section, buttonEl = null) {
            // Find the save button if not passed
            const saveBtn = buttonEl || document.querySelector(`button[onclick*="saveWebsiteSection('${section}', this)"]`);
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            
            try {
                // Show loading state
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = ' Saving...';
                    saveBtn.style.opacity = '0.7';
                }
                
                // Must have a deployed site selected
                if (!selectedDeployedSiteId) {
                    showNotification('Please select a website to edit first', 'error');
                    return;
                }
                
                // Collect all form values from the VISIBLE editor container
                const settings = {};
                const prefix = `wb-${section}-`;
                
                const editorPanelMap = {
                    'header': 'wb-header',
                    'hero': 'wb-hero',
                    'intro': 'editor-intro-content',
                    'featured': 'editor-featured-content',
                    'about': 'editor-about-content',
                    'reviews': 'editor-reviews-content',
                    'cta': 'editor-cta-content',
                    'footer': 'editor-footer-content',
                    'styles': 'editor-styles-content',
                    'seo': 'editor-seo-content',
                    'page-rooms': 'editor-subpage-page-rooms',
                    'page-about': 'editor-subpage-page-about',
                    'page-gallery': 'editor-subpage-page-gallery',
                    'page-offers': 'editor-subpage-page-offers',
                    'page-properties': 'editor-subpage-page-properties',
                    'page-blog': 'editor-subpage-page-blog',
                    'page-attractions': 'editor-subpage-page-attractions',
                    'page-dining': 'editor-subpage-page-dining',
                    'page-reviews': 'editor-subpage-page-reviews',
                    'page-contact': 'editor-subpage-page-contact',
                    'page-terms': 'editor-footer-footer-terms',
                    'page-privacy': 'editor-footer-footer-privacy'
                };
                
                const editorContainerId = editorPanelMap[section];
                let editorContainer = editorContainerId ? document.getElementById(editorContainerId) : null;
                
                // For sections that are cloned into editor panels, prefer collecting from the clone
                // because that's where the user edits when in Homepage/Content tabs
                const clonedPanelMap = {
                    'header': 'editor-header-content',
                    'hero': 'editor-hero-content',
                    'intro': 'editor-intro-content',
                    'featured': 'editor-featured-content',
                    'about': 'editor-about-content',
                    'reviews': 'editor-reviews-content',
                    'cta': 'editor-cta-content',
                    'styles': 'editor-styles-content'
                };
                
                const clonedContainerId = clonedPanelMap[section];
                const clonedContainer = clonedContainerId ? document.getElementById(clonedContainerId) : null;
                
                // Collect from BOTH original and clone, with clone values taking priority
                // This ensures we get all fields (some may only exist in original)
                // For page-* sections, the editorContainer IS the container with the fields
                let originalContainer = document.getElementById(`wb-${section}`);
                
                // For page-* sections, use the editorContainer as the source
                if (!originalContainer && section.startsWith('page-') && editorContainer) {
                    originalContainer = editorContainer;
                }
                
                // First collect from original
                let elementsToCheck = originalContainer 
                    ? originalContainer.querySelectorAll(`[id^="${prefix}"]`)
                    : document.querySelectorAll(`[id^="${prefix}"]`);
                
                elementsToCheck.forEach(el => {
                    const key = el.id.replace(prefix, '');
                    if (key.endsWith('-picker') || key.endsWith('-value') || key.endsWith('-preview')) {
                        return;
                    }
                    if (el.type === 'checkbox') {
                        settings[key] = el.checked;
                    } else if (el.type === 'file') {
                        // Skip file inputs
                    } else if (el.value !== undefined) {
                        let value = el.value;
                        // Sanitize color values - remove any invalid characters
                        if (key.includes('color') || key.includes('bg') || key.includes('text')) {
                            if (value.startsWith('#')) {
                                // Keep only valid hex characters after #
                                value = '#' + value.slice(1).replace(/[^0-9A-Fa-f]/g, '').slice(0, 6);
                            }
                        }
                        settings[key] = value;
                    }
                });
                
                // Debug: log what we collected for page-about
                if (section.startsWith('page-') || section === 'styles') {
                    console.log(`Saving ${section}:`, {
                        editorContainerId,
                        originalContainerFound: !!originalContainer,
                        clonedContainerFound: !!clonedContainer,
                        settingsCount: Object.keys(settings).length,
                        settings
                    });
                }
                
                // Then override with values from clone (user's edits)
                // BUT don't override non-empty values with empty values (preserves uploaded images etc.)
                if (clonedContainer) {
                    clonedContainer.querySelectorAll(`[id^="${prefix}"]`).forEach(el => {
                        const key = el.id.replace(prefix, '');
                        if (key.endsWith('-picker') || key.endsWith('-value') || key.endsWith('-preview')) {
                            return;
                        }
                        if (el.type === 'checkbox') {
                            settings[key] = el.checked;
                        } else if (el.type === 'file') {
                            // Skip file inputs
                        } else if (el.value !== undefined) {
                            // Only override if clone value is not empty, OR original was also empty
                            if (el.value !== '' || !settings[key]) {
                                settings[key] = el.value;
                            }
                        }
                    });
                }
                
                // Collect FAQs if this section has them
                const faqSection = section.replace('page-', '');
                const faqs = getFAQsFromSection(faqSection);
                if (faqs.length > 0) {
                    settings['faqs'] = JSON.stringify(faqs);
                }
                
                // Check for FAQ enabled checkbox
                const faqEnabledId = section === 'hero' ? 'wb-hero-faq-enabled' : `wb-page-${faqSection}-faq-enabled`;
                const faqEnabledEl = document.getElementById(faqEnabledId);
                if (faqEnabledEl) {
                    settings['faq-enabled'] = faqEnabledEl.checked;
                }
                
                // Handle hero background type (radio buttons)
                if (section === 'hero') {
                    const bgTypeRadio = document.querySelector('input[name="hero-bg-type"]:checked');
                    if (bgTypeRadio) {
                        settings['background-type'] = bgTypeRadio.value;
                    }
                }
                
                console.log(`Saving ${section} for deployed site ${selectedDeployedSiteId}:`, settings);
                
                // Use NEW clean endpoint
                if (saveBtn) saveBtn.innerHTML = ' Saving to database...';
                
                const response = await fetch(`/api/deployed-sites/${selectedDeployedSiteId}/settings/${section}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ settings })
                });
                
                const data = await response.json();
                console.log('Save response:', data);
                
                if (data.success) {
                    // Check WordPress push result
                    if (data.wordpress_push) {
                        if (data.wordpress_push.success) {
                            showNotification(' Saved and synced to WordPress!', 'success');
                        } else {
                            console.warn('WordPress sync failed:', data.wordpress_push.error);
                            showNotification(' Saved! WordPress sync: ' + (data.wordpress_push.error || 'pending'), 'warning');
                        }
                    } else {
                        showNotification(' Settings saved!', 'success');
                    }
                    
                    // For page sections, trigger WordPress page sync
                    if (section.startsWith('page-')) {
                        await triggerWordPressPageSync();
                    }
                } else {
                    showNotification('Error: ' + (data.error || 'Failed to save'), 'error');
                }
                
            } catch (error) {
                console.error('Error saving website section:', error);
                showNotification('Error saving. Please try again.', 'error');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.opacity = '1';
                }
            }
        }
        
        async function loadWebsiteSection(section) {
            const websiteId = selectedWebsiteId;
            const clientId = getClientId() || localStorage.getItem('gas_selected_client_id');
            
            // Update website selectors when loading a section
            updateWebsiteSelectors();
            
            // Try to load from per-website endpoint first, fallback to account-based
            let data = null;
            
            if (websiteId) {
                try {
                    const response = await fetch(`/api/websites/${websiteId}/builder/${section}`);
                    data = await response.json();
                    console.log(`Loaded section ${section} for website ${websiteId}:`, data);
                } catch (error) {
                    console.log(`Per-website load failed for ${section}, trying account-based...`);
                }
            }
            
            // Fallback to account-based if no website data
            if ((!data || !data.settings) && accountId) {
                try {
                    const response = await fetch(`/api/admin/website-builder/${section}?account_id=${accountId}`);
                    data = await response.json();
                    console.log(`Loaded section ${section} for account ${accountId}:`, data);
                } catch (error) {
                    console.error(`Account-based load also failed for ${section}:`, error);
                }
            }
            
            if (!data || !data.success) {
                console.log(`No settings found for section ${section}`);
                return;
            }
            
            if (data.settings) {
                const prefix = `wb-${section}-`;
                Object.entries(data.settings).forEach(([key, value]) => {
                    const el = document.getElementById(`${prefix}${key}`);
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = value;
                        } else if (el.type !== 'file') {
                            el.value = value;
                        }
                    }
                });
                
                // Update image preview if image-url exists
                if (data.settings['image-url']) {
                    const preview = document.getElementById(`wb-${section}-image-preview`);
                    if (preview) {
                        preview.style.backgroundImage = `url(${data.settings['image-url']})`;
                        preview.style.backgroundSize = 'cover';
                        preview.style.backgroundPosition = 'center';
                        preview.innerHTML = '';
                    }
                }
                
                // Sync color pickers with their text inputs
                Object.entries(data.settings).forEach(([key, value]) => {
                    if (value && typeof value === 'string') {
                        // Check if it looks like a hex color (with or without #)
                        const hexMatch = value.match(/^#?([0-9A-Fa-f]{6})$/);
                        if (hexMatch) {
                            const hexColor = '#' + hexMatch[1];
                            const picker = document.getElementById(`${prefix}${key}-picker`);
                            const textInput = document.getElementById(`${prefix}${key}`);
                            if (picker) {
                                picker.value = hexColor;
                            }
                            // Also ensure text input has # prefix
                            if (textInput && !textInput.value.startsWith('#')) {
                                textInput.value = hexColor;
                            }
                        }
                    }
                });
                
                // Update range slider value displays
                const rangeKeys = ['search-opacity', 'search-radius', 'search-padding', 'search-max-width', 'search-scale',
                                   'overlay', 'height', 'font-size', 'title-size', 'text-size', 'max-width', 'btn-radius', 'body-size', 'count'];
                rangeKeys.forEach(key => {
                    const valueEl = document.getElementById(`wb-${section}-${key}-value`);
                    if (valueEl && data.settings[key]) {
                        valueEl.textContent = data.settings[key];
                    }
                });
            }
        }
        
        let currentSiteUrl = null;
        
        async function loadSiteBanner() {
            const clientId = getClientId() || localStorage.getItem('gas_selected_client_id');
            if (!accountId) return;
            
            try {
                const response = await fetch(`/api/account/${accountId}/website`);
                const data = await response.json();
                
                const banner = document.getElementById('wb-site-banner');
                const previewBtn = document.getElementById('wb-preview-btn');
                const urlLink = document.getElementById('wb-site-url');
                
                if (data.success && data.data?.site_url) {
                    currentSiteUrl = data.data.site_url;
                    if (banner) {
                        banner.style.display = 'block';
                        urlLink.href = currentSiteUrl;
                        urlLink.textContent = currentSiteUrl;
                    }
                    if (previewBtn) previewBtn.style.display = 'flex';
                } else {
                    if (banner) banner.style.display = 'none';
                    if (previewBtn) previewBtn.style.display = 'none';
                    currentSiteUrl = null;
                }
            } catch (error) {
                console.error('Error loading site info:', error);
            }
        }
        
        function openSitePreview() {
            if (currentSiteUrl) {
                window.open(currentSiteUrl, '_blank');
            } else {
                alert('No website configured for this account. Create one in the WordPress section.');
            }
        }
        
        async function pushToWordPress(section, settings) {
            const clientId = getClientId() || localStorage.getItem('gas_selected_client_id');
            const siteUrl = selectedWebsiteData?.site_url;
            
            console.log('pushToWordPress called:', { accountId, section, siteUrl, settings });
            
            if (!siteUrl) {
                console.log('No site_url available, skipping push');
                return;
            }
            
            try {
                // Push settings to WordPress via our API
                console.log('Pushing to WordPress via /api/admin/push-to-wordpress...');
                const response = await fetch('/api/admin/push-to-wordpress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: accountId,
                        section,
                        settings,
                        site_url: siteUrl
                    })
                });
                
                const result = await response.json();
                console.log('Push to WordPress result:', result);
                
                if (!result.success) {
                    console.error('Push to WordPress failed:', result.error);
                }
            } catch (error) {
                console.error('Could not push to WordPress:', error);
            }
        }
        
        // =====================================================
        // SUB PAGES FUNCTIONS
        // =====================================================
        
        async function saveSubPage(pageName) {
            try {
                const clientId = getClientId() || localStorage.getItem('gas_selected_client_id');
                if (!accountId) {
                    alert('Please select a client/property first');
                    return;
                }
                
                const settings = {};
                const prefix = `wb-page-${pageName}`;
                
                // Collect all inputs for this page
                document.querySelectorAll(`[id^="${prefix}"]`).forEach(el => {
                    const key = el.id.replace(prefix + '-', '');
                    if (el.type === 'checkbox') {
                        settings[key] = el.checked;
                    } else if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        settings[key] = el.value;
                    }
                });
                
                console.log(`Saving sub page ${pageName}:`, JSON.stringify(settings, null, 2));
                
                const response = await fetch(`/api/admin/website-builder/page/${pageName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: accountId,
                        settings: settings
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(`${pageName.charAt(0).toUpperCase() + pageName.slice(1)} page saved!`, 'success');
                } else {
                    showNotification('Error saving page: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error saving sub page:', error);
                showNotification('Error saving page', 'error');
            }
        }
        
        async function loadSubPage(pageName) {
            try {
                const clientId = getClientId() || localStorage.getItem('gas_selected_client_id');
                if (!accountId) return;
                
                const response = await fetch(`/api/admin/website-builder/page/${pageName}?account_id=${accountId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const settings = data.data;
                    const prefix = `wb-page-${pageName}`;
                    
                    Object.keys(settings).forEach(key => {
                        const el = document.getElementById(`${prefix}-${key}`);
                        if (el) {
                            if (el.type === 'checkbox') {
                                el.checked = settings[key];
                            } else {
                                el.value = settings[key] || '';
                            }
                            
                            // Handle image previews
                            if (key.endsWith('-url') && settings[key]) {
                                const previewId = el.id.replace('-url', '-preview');
                                const preview = document.getElementById(previewId);
                                if (preview) {
                                    preview.style.backgroundImage = `url(${settings[key]})`;
                                    preview.innerHTML = '';
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading sub page:', error);
            }
        }
        
        function previewSubPageImage(pageName, imageType) {
            const input = document.getElementById(`wb-page-${pageName}-${imageType}`);
            const preview = document.getElementById(`wb-page-${pageName}-${imageType}-preview`);
            const urlField = document.getElementById(`wb-page-${pageName}-${imageType}-url`);
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.innerHTML = '';
                    
                    // Upload the image
                    const formData = new FormData();
                    formData.append('image', file);
                    formData.append('deployed_site_id', selectedDeployedSiteId || getClientId() || localStorage.getItem('gas_selected_client_id'));
                    formData.append('type', `page-${pageName}-${imageType}`);
                    
                    try {
                        const response = await fetch('/api/admin/website-builder/upload-image', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        if (data.success && data.url) {
                            urlField.value = data.url;
                            showNotification('Image uploaded!', 'success');
                        }
                    } catch (error) {
                        console.error('Error uploading image:', error);
                    }
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        async function previewWebsiteImage(section) {
            const input = document.getElementById(`wb-${section}-image`);
            const preview = document.getElementById(`wb-${section}-image-preview`);
            const urlField = document.getElementById(`wb-${section}-image-url`);
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Show preview immediately
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.style.backgroundSize = 'cover';
                    preview.style.backgroundPosition = 'center';
                    preview.innerHTML = '<span style="background: rgba(0,0,0,0.5); color: white; padding: 8px 16px; border-radius: 4px;">Uploading...</span>';
                };
                reader.readAsDataURL(file);
                
                // Upload to server - use deployed_site_id from website editor
                const siteId = selectedDeployedSiteId || getClientId() || localStorage.getItem('gas_selected_client_id');
                if (!siteId) {
                    alert('Please select a website first');
                    return;
                }
                
                const formData = new FormData();
                formData.append('image', file);
                formData.append('deployed_site_id', siteId);
                formData.append('section', section);
                
                try {
                    const response = await fetch('/api/admin/website-builder/upload-image', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.url) {
                        // Fill the URL field
                        if (urlField) {
                            urlField.value = data.url;
                        }
                        preview.innerHTML = '<span style="background: rgba(16,185,129,0.9); color: white; padding: 8px 16px; border-radius: 4px;"> Uploaded</span>';
                        setTimeout(() => {
                            preview.innerHTML = '';
                        }, 2000);
                    } else {
                        preview.innerHTML = '<span style="background: rgba(239,68,68,0.9); color: white; padding: 8px 16px; border-radius: 4px;">Upload failed</span>';
                        alert('Upload failed: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    preview.innerHTML = '<span style="background: rgba(239,68,68,0.9); color: white; padding: 8px 16px; border-radius: 4px;">Upload error</span>';
                    alert('Upload error: ' + error.message);
                }
            }
        }
        
        // Hero video background functions
        function toggleHeroBackgroundType(type) {
            const imageSection = document.getElementById('hero-image-upload-section');
            const sliderSection = document.getElementById('hero-slider-upload-section');
            const videoSection = document.getElementById('hero-video-upload-section');
            
            imageSection.style.display = 'none';
            sliderSection.style.display = 'none';
            videoSection.style.display = 'none';
            
            if (type === 'video') {
                videoSection.style.display = 'block';
            } else if (type === 'slider') {
                sliderSection.style.display = 'block';
            } else {
                imageSection.style.display = 'block';
            }
        }
        
        // Slider image preview and upload functions
        async function previewSliderImage(slot, input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const preview = document.getElementById(`wb-hero-slide-${slot}-preview`);
            const placeholder = preview.querySelector('.slide-placeholder');
            const removeBtn = preview.querySelector('.remove-slide-btn');
            const urlField = document.getElementById(`wb-hero-slide-${slot}-url`);
            
            console.log(`Slider image ${slot}: Starting upload for`, file.name);
            
            // Show preview immediately (before upload)
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.style.backgroundImage = `url(${e.target.result})`;
                if (placeholder) placeholder.style.display = 'none';
                if (removeBtn) removeBtn.style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            // Upload the file to server
            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('section', `hero-slide-${slot}`);
                
                // Server needs deployed_site_id - use the selected deployed site
                const siteId = selectedDeployedSiteId || localStorage.getItem('gas_selected_client_id') || getClientId();
                if (siteId) {
                    formData.append('deployed_site_id', siteId);
                } else {
                    showNotification('No website selected - cannot upload', 'error');
                    return;
                }
                
                // Don't set Content-Type header - browser sets it automatically for FormData
                const token = localStorage.getItem('gas_token');
                console.log(`Slider image ${slot}: Uploading to /api/admin/website-builder/upload-image with deployed_site_id:`, siteId);
                
                const response = await fetch('/api/admin/website-builder/upload-image', {
                    method: 'POST',
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                    body: formData
                });
                
                console.log(`Slider image ${slot}: Response status`, response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`Slider image ${slot}: Upload success, URL:`, data.url);
                    if (urlField && data.url) {
                        urlField.value = data.url;
                        console.log(`Slider image ${slot}: Set urlField value to`, urlField.value);
                        
                        // Also update any cloned hidden inputs with the same ID
                        // This ensures saves from cloned containers also get the value
                        document.querySelectorAll(`#wb-hero-slide-${slot}-url`).forEach(el => {
                            el.value = data.url;
                        });
                    } else {
                        console.error(`Slider image ${slot}: urlField not found or no URL in response`, { urlField, data });
                    }
                    showNotification(`Slide ${slot} uploaded successfully`, 'success');
                } else {
                    const err = await response.json().catch(() => ({}));
                    console.error(`Slider image ${slot}: Upload failed`, err);
                    showNotification('Failed to upload image: ' + (err.error || response.statusText), 'error');
                }
            } catch (error) {
                console.error(`Slider image ${slot}: Upload error`, error);
                showNotification('Upload failed: ' + error.message, 'error');
            }
        }
        
        function removeSliderImage(slot) {
            const preview = document.getElementById(`wb-hero-slide-${slot}-preview`);
            const placeholder = preview.querySelector('.slide-placeholder');
            const removeBtn = preview.querySelector('.remove-slide-btn');
            const urlField = document.getElementById(`wb-hero-slide-${slot}-url`);
            const fileInput = preview.parentElement.querySelector('input[type="file"]');
            
            preview.style.backgroundImage = '';
            if (placeholder) {
                placeholder.style.display = 'block';
                placeholder.textContent = `Slide ${slot} ${slot === 1 ? '(required)' : '(optional)'}`;
            }
            if (removeBtn) removeBtn.style.display = 'none';
            if (urlField) urlField.value = '';
            if (fileInput) fileInput.value = '';
        }
        
        function previewHeroVideo(url) {
            const placeholder = document.getElementById('hero-video-placeholder');
            const video = document.getElementById('hero-video-player');
            
            if (url && url.match(/\.(mp4|webm|ogg)($|\?)/i)) {
                video.src = url;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                video.play().catch(() => {});
            } else if (url) {
                placeholder.textContent = ' Please enter a valid video URL (.mp4, .webm)';
                placeholder.style.display = 'block';
                video.style.display = 'none';
            } else {
                placeholder.textContent = ' Upload or enter video URL below';
                placeholder.style.display = 'block';
                video.style.display = 'none';
            }
        }
        
        async function uploadHeroVideo(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const placeholder = document.getElementById('hero-video-placeholder');
            const video = document.getElementById('hero-video-player');
            const urlField = document.getElementById('wb-hero-video-url');
            
            // Check file size (100MB limit)
            if (file.size > 100 * 1024 * 1024) {
                showNotification('Video must be under 100MB', 'error');
                return;
            }
            
            // Show uploading state
            placeholder.textContent = ' Uploading video...';
            placeholder.style.display = 'block';
            video.style.display = 'none';
            
            const formData = new FormData();
            formData.append('video', file);
            formData.append('deployed_site_id', selectedDeployedSiteId || getClientId() || localStorage.getItem('gas_selected_client_id'));
            formData.append('section', 'hero');
            
            try {
                const response = await fetch('/api/admin/website-builder/upload-video', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && data.url) {
                    // Set URL field and preview
                    urlField.value = data.url;
                    previewHeroVideo(data.url);
                    showNotification('Video uploaded successfully!', 'success');
                } else {
                    placeholder.textContent = ' Upload failed: ' + (data.error || 'Unknown error');
                    showNotification('Video upload failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Video upload error:', error);
                placeholder.textContent = ' Upload error';
                showNotification('Video upload error: ' + error.message, 'error');
            }
        }
        
        function addWebsiteReview() {
            const container = document.getElementById('wb-reviews-list');
            const reviewId = Date.now();
            
            container.innerHTML += `
                <div class="review-item" id="review-${reviewId}" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Guest Name</label>
                        <input type="text" class="form-input review-name" placeholder="e.g., John D.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Review Text</label>
                        <textarea class="form-textarea review-text" rows="2" placeholder="Their testimonial..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rating</label>
                        <select class="form-select review-rating">
                            <option value="5"> (5 stars)</option>
                            <option value="4"> (4 stars)</option>
                            <option value="3"> (3 stars)</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="document.getElementById('review-${reviewId}').remove()"> Remove</button>
                </div>
            `;
        }

        // =========================================================
        // AGENCY MANAGEMENT FUNCTIONS
        // =========================================================

        // =====================================================
        // ACCOUNTS MANAGEMENT (New unified system)
        // =====================================================
        // MY ACCOUNT FUNCTIONS
        // =====================================================
        
        async function loadMyAccount() {
            try {
                const response = await fetch('/api/accounts/me', { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.account) {
                    const account = data.account;
                    
                    // Update avatar and name display
                    const initial = (account.name || 'U').charAt(0).toUpperCase();
                    document.getElementById('myAccountAvatar').textContent = initial;
                    document.getElementById('myAccountName').textContent = account.name || 'Unknown';
                    document.getElementById('myAccountRole').textContent = formatRole(account.role);
                    
                    // Fill form fields
                    document.getElementById('myAccountNameInput').value = account.name || '';
                    document.getElementById('myAccountEmail').value = account.email || '';
                    document.getElementById('myAccountPhone').value = account.phone || '';
                    document.getElementById('myAccountBusiness').value = account.business_name || '';
                    
                    // Account info
                    document.getElementById('myAccountId').textContent = account.id;
                    document.getElementById('myAccountCode').textContent = account.account_code || 'Not set';
                    document.getElementById('myAccountRoleInfo').textContent = formatRole(account.role);
                    document.getElementById('myAccountStatus').textContent = account.status || 'active';
                    
                    // Show master admin section if applicable
                    if (account.role === 'master_admin') {
                        document.getElementById('createMasterAdminSection').style.display = 'block';
                        loadMasterAdmins();
                    } else {
                        document.getElementById('createMasterAdminSection').style.display = 'none';
                    }
                    
                    // Show agency management section for Admin and SubMaster
                    if (account.role === 'admin' || account.role === 'submaster_admin') {
                        document.getElementById('agencyManagementSection').style.display = 'block';
                        loadAgencyManagementStatus(account);
                    } else {
                        document.getElementById('agencyManagementSection').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading my account:', error);
                showNotification('Error loading account details', 'error');
            }
        }
        
        // Load agency management status and available agencies
        async function loadAgencyManagementStatus(account) {
            try {
                // Load available agencies for the dropdown
                const agenciesRes = await fetch('/api/agencies/available', { headers: authHeaders() });
                const agenciesData = await agenciesRes.json();
                
                const agencySelect = document.getElementById('agencySelect');
                agencySelect.innerHTML = '<option value="">Choose an agency...</option>';
                
                if (agenciesData.success && agenciesData.agencies) {
                    agenciesData.agencies.forEach(agency => {
                        const option = document.createElement('option');
                        option.value = agency.id;
                        option.textContent = agency.business_name || agency.name;
                        agencySelect.appendChild(option);
                    });
                }
                
                // Check current management status
                if (account.managed_by_id) {
                    // Currently managed by an agency
                    const managingAgency = agenciesData.agencies?.find(a => a.id === account.managed_by_id);
                    document.getElementById('managementStatusIcon').textContent = '';
                    document.getElementById('managementStatusIcon').style.background = '#dbeafe';
                    document.getElementById('managementStatusTitle').textContent = 'Managed by Agency';
                    document.getElementById('managementStatusDesc').textContent = `Your account is managed by ${managingAgency?.business_name || managingAgency?.name || 'an agency'}`;
                    document.getElementById('removeManagementBtn').style.display = 'block';
                    document.getElementById('selectAgencyForm').style.display = 'none';
                    document.getElementById('pendingRequestBanner').style.display = 'none';
                } else {
                    // Self-managed - check for pending requests
                    const requestsRes = await fetch(`/api/management-requests?account_id=${account.id}&role=requester`, { headers: authHeaders() });
                    const requestsData = await requestsRes.json();
                    
                    const pendingRequest = requestsData.requests?.find(r => r.status === 'pending');
                    
                    if (pendingRequest) {
                        document.getElementById('pendingRequestBanner').style.display = 'block';
                        document.getElementById('pendingRequestAgency').textContent = `Awaiting response from ${pendingRequest.agency_business || pendingRequest.agency_name}`;
                        document.getElementById('selectAgencyForm').style.display = 'none';
                        
                        // Store pending request ID for cancellation
                        document.getElementById('pendingRequestBanner').dataset.requestId = pendingRequest.id;
                    } else {
                        document.getElementById('pendingRequestBanner').style.display = 'none';
                        document.getElementById('selectAgencyForm').style.display = 'block';
                    }
                    
                    document.getElementById('managementStatusIcon').textContent = '';
                    document.getElementById('managementStatusIcon').style.background = '#e5e7eb';
                    document.getElementById('managementStatusTitle').textContent = 'Self-Managed';
                    document.getElementById('managementStatusDesc').textContent = 'You are managing your own account';
                    document.getElementById('removeManagementBtn').style.display = 'none';
                    
                    // Show request history
                    renderMyManagementRequests(requestsData.requests || []);
                }
            } catch (error) {
                console.error('Error loading agency management status:', error);
            }
        }
        
        function renderMyManagementRequests(requests) {
            const container = document.getElementById('myManagementRequests');
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<p style="color: #64748b; font-size: 0.9rem;">No previous requests</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Agency</th>
                                <th>Status</th>
                                <th>Requested</th>
                                <th>Response</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requests.map(req => `
                                <tr>
                                    <td><strong>${req.agency_business || req.agency_name}</strong></td>
                                    <td>${getRequestStatusBadge(req.status)}</td>
                                    <td>${new Date(req.requested_at).toLocaleDateString()}</td>
                                    <td>${req.response_message || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function getRequestStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge" style="background: #fef3c7; color: #92400e;"> Pending</span>',
                'approved': '<span class="badge badge-success"> Approved</span>',
                'rejected': '<span class="badge" style="background: #fee2e2; color: #dc2626;"> Rejected</span>',
                'cancelled': '<span class="badge badge-secondary">Cancelled</span>'
            };
            return badges[status] || status;
        }
        
        async function requestAgencyManagement() {
            const agencyId = document.getElementById('agencySelect').value;
            
            if (!agencyId) {
                showNotification('Please select an agency', 'error');
                return;
            }
            
            try {
                // Get current account ID
                const meRes = await fetch('/api/accounts/me', { headers: authHeaders() });
                const meData = await meRes.json();
                
                if (!meData.success) {
                    showNotification('Could not verify account', 'error');
                    return;
                }
                
                const response = await fetch('/api/management-requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        requesting_account_id: meData.account.id,
                        agency_id: parseInt(agencyId),
                        message: 'Request to manage my account'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Request sent successfully', 'success');
                    loadMyAccount(); // Refresh the view
                } else {
                    showNotification(data.error || 'Error sending request', 'error');
                }
            } catch (error) {
                console.error('Error requesting management:', error);
                showNotification('Error sending request', 'error');
            }
        }
        
        async function cancelManagementRequest() {
            const requestId = document.getElementById('pendingRequestBanner').dataset.requestId;
            
            if (!requestId) {
                showNotification('No pending request found', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/management-requests/${requestId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status: 'cancelled' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Request cancelled', 'success');
                    loadMyAccount();
                } else {
                    showNotification(data.error || 'Error cancelling request', 'error');
                }
            } catch (error) {
                showNotification('Error cancelling request', 'error');
            }
        }
        
        async function removeAgencyManagement() {
            if (!confirm('Are you sure you want to remove agency management? You will manage your own account again.')) {
                return;
            }
            
            try {
                const meRes = await fetch('/api/accounts/me', { headers: authHeaders() });
                const meData = await meRes.json();
                
                const response = await fetch(`/api/accounts/${meData.account.id}/remove-management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Now self-managed', 'success');
                    loadMyAccount();
                } else {
                    showNotification(data.error || 'Error removing management', 'error');
                }
            } catch (error) {
                showNotification('Error removing management', 'error');
            }
        }
        
        function formatRole(role) {
            const roles = {
                'master_admin': ' Master Admin',
                'agency_admin': ' Agency Admin',
                'submaster_admin': ' Sub Master',
                'admin': ' Admin',
                'travel_agent': ' Travel Agent'
            };
            return roles[role] || role;
        }
        
        async function saveMyProfile() {
            const name = document.getElementById('myAccountNameInput').value.trim();
            const email = document.getElementById('myAccountEmail').value.trim();
            const phone = document.getElementById('myAccountPhone').value.trim();
            const business_name = document.getElementById('myAccountBusiness').value.trim();
            
            if (!name || !email) {
                showNotification('Name and email are required', 'error');
                return;
            }
            
            try {
                // Get current account ID
                const meResponse = await fetch('/api/accounts/me', { headers: authHeaders() });
                const meData = await meResponse.json();
                
                if (!meData.success) {
                    showNotification('Could not verify account', 'error');
                    return;
                }
                
                const response = await fetch(`/api/accounts/${meData.account.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ name, email, phone, business_name })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Profile updated successfully', 'success');
                    // Update sidebar display
                    document.getElementById('userName').textContent = name;
                    document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
                    document.getElementById('myAccountAvatar').textContent = name.charAt(0).toUpperCase();
                    document.getElementById('myAccountName').textContent = name;
                } else {
                    showNotification(data.error || 'Error updating profile', 'error');
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                showNotification('Error saving profile', 'error');
            }
        }
        
        async function changeMyPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showNotification('All password fields are required', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showNotification('New password must be at least 8 characters', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/accounts/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Password changed successfully', 'success');
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } else {
                    showNotification(data.error || 'Error changing password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showNotification('Error changing password', 'error');
            }
        }
        
        async function createMasterAdmin() {
            const name = document.getElementById('newMasterName').value.trim();
            const email = document.getElementById('newMasterEmail').value.trim();
            const password = document.getElementById('newMasterPassword').value;
            
            if (!name || !email || !password) {
                showNotification('All fields are required', 'error');
                return;
            }
            
            if (password.length < 8) {
                showNotification('Password must be at least 8 characters', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/create-master-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ name, email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Master Admin created successfully', 'success');
                    // Clear form
                    document.getElementById('newMasterName').value = '';
                    document.getElementById('newMasterEmail').value = '';
                    document.getElementById('newMasterPassword').value = '';
                    // Reload list
                    loadMasterAdmins();
                } else {
                    showNotification(data.error || 'Error creating master admin', 'error');
                }
            } catch (error) {
                console.error('Error creating master admin:', error);
                showNotification('Error creating master admin', 'error');
            }
        }
        
        async function loadMasterAdmins() {
            const container = document.getElementById('masterAdminsList');
            try {
                const response = await fetch('/api/admin/accounts', { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.accounts) {
                    const masterAdmins = data.accounts.filter(a => a.role === 'master_admin');
                    
                    if (masterAdmins.length === 0) {
                        container.innerHTML = '<p style="color: #64748b;">No master admins found</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Last Login</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${masterAdmins.map(admin => `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">${(admin.name || 'M').charAt(0).toUpperCase()}</div>
                                                    <strong>${admin.name || 'Unnamed'}</strong>
                                                </div>
                                            </td>
                                            <td>${admin.email}</td>
                                            <td><span class="badge badge-success">${admin.status || 'active'}</span></td>
                                            <td>${admin.last_login_at ? new Date(admin.last_login_at).toLocaleDateString() : 'Never'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading master admins:', error);
                container.innerHTML = '<p style="color: #ef4444;">Error loading master admins</p>';
            }
        }
        
        // =====================================================
        // MANAGEMENT REQUESTS FUNCTIONS (Agency View)
        // =====================================================
        
        let allManagementRequests = [];
        let currentRequestFilter = 'pending';
        
        async function loadManagementRequests() {
            try {
                // Determine the viewing context
                let accountId = selectedAccountId;
                let accountRole = null;
                let viewMode = 'agency'; // 'agency' = requests TO this account, 'requester' = requests FROM this account
                
                if (selectedAccountId) {
                    // Get the selected account's role
                    const accountRes = await fetch(`/api/admin/accounts?account_id=${selectedAccountId}`, { headers: authHeaders() });
                    const accountData = await accountRes.json();
                    if (accountData.success && accountData.accounts && accountData.accounts.length > 0) {
                        accountRole = accountData.accounts[0].role;
                    }
                } else {
                    // Use logged-in user
                    const meRes = await fetch('/api/accounts/me', { headers: authHeaders() });
                    const meData = await meRes.json();
                    if (meData.success) {
                        accountId = meData.account.id;
                        accountRole = meData.account.role;
                    }
                }
                
                // Determine view mode based on role
                if (accountRole === 'agency_admin') {
                    viewMode = 'agency'; // Agency sees requests TO them
                } else if (accountRole === 'admin' || accountRole === 'submaster_admin') {
                    viewMode = 'requester'; // Admin sees their own requests TO agencies
                } else if (accountRole === 'master_admin' && !selectedAccountId) {
                    viewMode = 'all'; // Master admin with no filter sees ALL requests
                }
                
                // Load requests based on view mode
                let response;
                if (viewMode === 'all') {
                    response = await fetch(`/api/management-requests?all=true`, { headers: authHeaders() });
                } else {
                    response = await fetch(`/api/management-requests?account_id=${accountId}&role=${viewMode}`, { headers: authHeaders() });
                }
                
                const data = await response.json();
                
                if (data.success) {
                    allManagementRequests = data.requests || [];
                    
                    // Update stats
                    const pending = allManagementRequests.filter(r => r.status === 'pending');
                    const approved = allManagementRequests.filter(r => r.status === 'approved');
                    
                    document.getElementById('stat-pending-requests').textContent = pending.length;
                    document.getElementById('stat-managed-accounts').textContent = approved.length;
                    
                    // Calculate properties under management
                    const totalProperties = approved.reduce((sum, r) => sum + (r.property_count || 0), 0);
                    document.getElementById('stat-managed-properties').textContent = totalProperties;
                    
                    // Store view mode for rendering
                    window.managementRequestsViewMode = viewMode;
                    
                    // Render filtered list
                    filterManagementRequests(currentRequestFilter);
                }
            } catch (error) {
                console.error('Error loading management requests:', error);
                document.getElementById('managementRequestsList').innerHTML = 
                    '<p style="text-align: center; padding: 2rem; color: #ef4444;">Error loading requests</p>';
            }
        }
        
        function filterManagementRequests(status) {
            currentRequestFilter = status;
            
            // Update button states
            document.querySelectorAll('.request-filter').forEach(btn => {
                if (btn.dataset.status === status) {
                    btn.classList.remove('btn-secondary');
                    btn.style.background = 'var(--accent)';
                } else {
                    btn.classList.add('btn-secondary');
                    btn.style.background = '';
                }
            });
            
            // Filter requests
            const filtered = status === 'all' 
                ? allManagementRequests 
                : allManagementRequests.filter(r => r.status === status);
            
            renderManagementRequests(filtered);
        }
        
        function renderManagementRequests(requests) {
            const container = document.getElementById('managementRequestsList');
            const viewMode = window.managementRequestsViewMode || 'agency';
            
            if (!requests || requests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <p>No ${currentRequestFilter === 'all' ? '' : currentRequestFilter} requests</p>
                    </div>
                `;
                return;
            }
            
            // Build table headers based on view mode
            let headers = '';
            if (viewMode === 'all') {
                headers = '<th>Account</th><th>Agency</th><th>Properties</th><th>Status</th><th>Requested</th><th>Actions</th>';
            } else if (viewMode === 'requester') {
                headers = '<th>Agency</th><th>Status</th><th>Requested</th><th>Response</th><th>Actions</th>';
            } else {
                headers = '<th>Account</th><th>Properties</th><th>Status</th><th>Requested</th><th>Actions</th>';
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>${headers}</tr>
                        </thead>
                        <tbody>
                            ${requests.map(req => {
                                if (viewMode === 'all') {
                                    // Master admin sees both account and agency
                                    return `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem;">
                                                        ${(req.requester_name || 'U').charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div style="font-weight: 600;">${req.requester_business || req.requester_name}</div>
                                                        <div style="font-size: 0.75rem; color: #64748b;">${req.requester_email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div style="font-weight: 500; color: #6366f1;">${req.agency_business || req.agency_name}</div>
                                            </td>
                                            <td><span style="font-weight: 600;">${req.property_count || 0}</span></td>
                                            <td>${getRequestStatusBadge(req.status)}</td>
                                            <td>${new Date(req.requested_at).toLocaleDateString()}</td>
                                            <td>
                                                ${req.status === 'pending' ? `
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn btn-small" onclick="respondToRequest(${req.id}, 'approved')" style="background: #10b981;"></button>
                                                        <button class="btn btn-secondary btn-small" onclick="respondToRequest(${req.id}, 'rejected')"></button>
                                                        <button class="btn btn-small" onclick="deleteManagementRequest(${req.id})" style="background: #ef4444;"></button>
                                                    </div>
                                                ` : req.status === 'approved' ? `
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn btn-small" onclick="endManagementFromRequest(${req.id}, ${req.requesting_account_id})" style="background: #f59e0b;" title="End Management">
                                                             End
                                                        </button>
                                                        <button class="btn btn-small" onclick="deleteManagementRequest(${req.id})" style="background: #ef4444;" title="Delete Request">
                                                            
                                                        </button>
                                                    </div>
                                                ` : `
                                                    <button class="btn btn-small" onclick="deleteManagementRequest(${req.id})" style="background: #ef4444;"> Delete</button>
                                                `}
                                            </td>
                                        </tr>
                                    `;
                                } else if (viewMode === 'requester') {
                                    // Admin sees their requests TO agencies
                                    return `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <div style="width: 36px; height: 36px; border-radius: 50%; background: #6366f1; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem;">
                                                        
                                                    </div>
                                                    <div>
                                                        <div style="font-weight: 600;">${req.agency_business || req.agency_name}</div>
                                                        <div style="font-size: 0.75rem; color: #64748b;">${req.agency_email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>${getRequestStatusBadge(req.status)}</td>
                                            <td>${new Date(req.requested_at).toLocaleDateString()}</td>
                                            <td style="color: #64748b; font-size: 0.85rem;">
                                                ${req.response_message || '-'}
                                            </td>
                                            <td>
                                                ${req.status === 'pending' ? `
                                                    <button class="btn btn-secondary btn-small" onclick="cancelOwnRequest(${req.id})">
                                                        Cancel Request
                                                    </button>
                                                ` : req.status === 'approved' ? `
                                                    <button class="btn btn-small" onclick="requestEndManagement(${req.id})" style="background: #f59e0b;">
                                                        End Management
                                                    </button>
                                                ` : '-'}
                                            </td>
                                        </tr>
                                    `;
                                } else {
                                    // Agency sees requests FROM accounts
                                    return `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                                        ${(req.requester_name || 'U').charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div style="font-weight: 600;">${req.requester_business || req.requester_name}</div>
                                                        <div style="font-size: 0.8rem; color: #64748b;">${req.requester_email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span style="font-weight: 600; font-size: 1.1rem;">${req.property_count || 0}</span>
                                                <span style="color: #64748b; font-size: 0.85rem;"> properties</span>
                                            </td>
                                            <td>${getRequestStatusBadge(req.status)}</td>
                                            <td>${new Date(req.requested_at).toLocaleDateString()}</td>
                                            <td>
                                                ${req.status === 'pending' ? `
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn btn-small" onclick="respondToRequest(${req.id}, 'approved')" style="background: #10b981;">
                                                             Approve
                                                        </button>
                                                        <button class="btn btn-secondary btn-small" onclick="respondToRequest(${req.id}, 'rejected')">
                                                             Decline
                                                        </button>
                                                    </div>
                                                ` : req.status === 'approved' ? `
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn btn-small" onclick="endManagementFromRequest(${req.id}, ${req.requesting_account_id})" style="background: #f59e0b;">
                                                            End Management
                                                        </button>
                                                        <button class="btn btn-small" onclick="deleteManagementRequest(${req.id})" style="background: #ef4444;">
                                                            
                                                        </button>
                                                    </div>
                                                ` : `
                                                    <button class="btn btn-small" onclick="deleteManagementRequest(${req.id})" style="background: #ef4444;">
                                                         Delete
                                                    </button>
                                                `}
                                            </td>
                                        </tr>
                                    `;
                                }
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        async function respondToRequest(requestId, status) {
            const action = status === 'approved' ? 'approve' : 'decline';
            
            if (!confirm(`Are you sure you want to ${action} this request?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/management-requests/${requestId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Request ${status}`, 'success');
                    loadManagementRequests(); // Refresh
                } else {
                    showNotification(data.error || 'Error responding to request', 'error');
                }
            } catch (error) {
                console.error('Error responding to request:', error);
                showNotification('Error responding to request', 'error');
            }
        }
        
        async function deleteManagementRequest(requestId) {
            if (!confirm('Are you sure you want to delete this management request? This will also remove any agency relationship.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/management-requests/${requestId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Request deleted', 'success');
                    loadManagementRequests(); // Refresh
                } else {
                    showNotification(data.error || 'Error deleting request', 'error');
                }
            } catch (error) {
                console.error('Error deleting request:', error);
                showNotification('Error deleting request', 'error');
            }
        }
        
        async function endManagementFromRequest(requestId, accountId) {
            if (!confirm('Are you sure you want to end management of this account? They will become self-managed.')) {
                return;
            }
            
            try {
                // First remove management
                const removeRes = await fetch(`/api/accounts/${accountId}/remove-management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const removeData = await removeRes.json();
                
                if (removeData.success) {
                    // Then update the request status to cancelled
                    await fetch(`/api/management-requests/${requestId}/respond`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ status: 'cancelled', response_message: 'Management ended by agency' })
                    });
                    
                    showNotification('Management ended', 'success');
                    loadManagementRequests(); // Refresh
                } else {
                    showNotification(removeData.error || 'Error ending management', 'error');
                }
            } catch (error) {
                console.error('Error ending management:', error);
                showNotification('Error ending management', 'error');
            }
        }
        
        async function cancelOwnRequest(requestId) {
            if (!confirm('Are you sure you want to cancel this request?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/management-requests/${requestId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status: 'cancelled', response_message: 'Cancelled by requester' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Request cancelled', 'success');
                    loadManagementRequests();
                    loadMyAccount(); // Refresh My Account view too
                } else {
                    showNotification(data.error || 'Error cancelling request', 'error');
                }
            } catch (error) {
                console.error('Error cancelling request:', error);
                showNotification('Error cancelling request', 'error');
            }
        }
        
        async function requestEndManagement(requestId) {
            if (!confirm('Are you sure you want to end this management relationship? You will become self-managed.')) {
                return;
            }
            
            try {
                // Get current account
                const meRes = await fetch('/api/accounts/me', { headers: authHeaders() });
                const meData = await meRes.json();
                
                if (!meData.success) {
                    showNotification('Could not verify account', 'error');
                    return;
                }
                
                // Remove management
                const response = await fetch(`/api/accounts/${meData.account.id}/remove-management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update request status
                    await fetch(`/api/management-requests/${requestId}/respond`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ status: 'cancelled', response_message: 'Ended by account owner' })
                    });
                    
                    showNotification('Management ended - you are now self-managed', 'success');
                    loadManagementRequests();
                    loadMyAccount();
                } else {
                    showNotification(data.error || 'Error ending management', 'error');
                }
            } catch (error) {
                console.error('Error ending management:', error);
                showNotification('Error ending management', 'error');
            }
        }
        
        // =====================================================
        // ACCOUNTS MANAGEMENT FUNCTIONS
        // =====================================================
        
        let allAccounts = [];
        let currentAccountFilter = 'all';
        
        async function loadAccounts() {
            const container = document.getElementById('accounts-list');
            console.log('loadAccounts called - selectedAccountId:', selectedAccountId);
            try {
                // Build query params based on current filter
                let queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                    console.log('Filtering accounts by account_id:', selectedAccountId);
                } else {
                    console.log('No account filter - loading all accounts');
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                const response = await fetch(`/api/admin/accounts${queryString}`, { headers: authHeaders() });
                const data = await response.json();
                
                console.log('loadAccounts response:', data);
                
                if (data.success && data.accounts) {
                    allAccounts = data.accounts;
                    
                    // Update stats
                    const masterAdmins = data.accounts.filter(a => a.role === 'master_admin');
                    const agencyAdmins = data.accounts.filter(a => a.role === 'agency_admin');
                    const subMasters = data.accounts.filter(a => a.role === 'submaster_admin');
                    const admins = data.accounts.filter(a => a.role === 'admin');
                    
                    document.getElementById('stat-total-accounts').textContent = data.accounts.length;
                    document.getElementById('stat-agency-admins').textContent = agencyAdmins.length;
                    document.getElementById('stat-submaster-admins').textContent = subMasters.length;
                    document.getElementById('stat-admins').textContent = admins.length;
                    
                    // Show generate codes button if master admin and accounts missing codes
                    const missingCodes = data.accounts.filter(a => !a.account_code);
                    const generateBtn = document.getElementById('generateCodesBtn');
                    if (generateBtn && currentAccount && currentAccount.role === 'master_admin' && missingCodes.length > 0) {
                        generateBtn.style.display = 'flex';
                        generateBtn.textContent = ` Generate ${missingCodes.length} Missing Codes`;
                    } else if (generateBtn) {
                        generateBtn.style.display = 'none';
                    }
                    
                    renderAccountsTable(data.accounts);
                } else {
                    console.error('Accounts API error:', data.error);
                    container.innerHTML = `<p style="color: #ef4444; padding: 2rem; text-align: center;">Error loading accounts: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
                container.innerHTML = `<p style="color: #ef4444; padding: 2rem; text-align: center;">Error loading accounts: ${error.message}</p>`;
            }
        }
        
        function filterAccounts(role) {
            currentAccountFilter = role;
            
            // Update button states
            document.querySelectorAll('.account-filter').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '';
                btn.style.color = '';
                if (btn.dataset.role === role) {
                    btn.classList.add('active');
                    btn.style.background = '#6366f1';
                    btn.style.color = 'white';
                }
            });
            
            // Filter and render
            let filtered = allAccounts;
            if (role !== 'all') {
                filtered = allAccounts.filter(a => a.role === role);
            }
            // Don't show master_admin in filtered views unless specifically viewing "all"
            if (role === 'all') {
                // Show everyone
            } else {
                filtered = allAccounts.filter(a => a.role === role);
            }
            
            renderAccountsTable(filtered);
        }
        
        function getRoleBadge(role) {
            const badges = {
                'master_admin': '<span class="badge" style="background: linear-gradient(135deg, #9333ea, #7c3aed); color: white;"> Master Admin</span>',
                'agency_admin': '<span class="badge" style="background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white;"> Agency Admin</span>',
                'submaster_admin': '<span class="badge" style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white;"> Sub Master</span>',
                'admin': '<span class="badge" style="background: linear-gradient(135deg, #16a34a, #15803d); color: white;"> Admin</span>'
            };
            return badges[role] || `<span class="badge">${role}</span>`;
        }
        
        function renderAccountsTable(accounts) {
            const container = document.getElementById('accounts-list');
            
            if (accounts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b;">
                        <p style="font-size: 3rem; margin-bottom: 1rem;"></p>
                        <p>No accounts found.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Account</th>
                                <th>Code</th>
                                <th>Role</th>
                                <th>Managed By</th>
                                <th>Stripe</th>
                                <th>Plan</th>
                                <th>Properties</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accounts.map(account => `
                                <tr>
                                    <td><code style="background: var(--bg-secondary); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;" onclick="navigator.clipboard.writeText('${account.id}'); showNotification('Account ID copied!', 'success');" title="Click to copy">${account.id}</code></td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, ${account.primary_color || '#6366f1'} 0%, ${account.secondary_color || '#8b5cf6'} 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                                                ${account.name.charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <strong>${account.name}</strong>
                                                <div style="font-size: 0.8rem; color: #64748b;">${account.email || '-'}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        ${account.account_code 
                                            ? `<code style="background: var(--bg-secondary); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">${account.account_code}</code>`
                                            : `<button class="btn btn-secondary btn-small" onclick="generateAccountCode(${account.id}, '${account.name}')" style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">+ Add</button>`
                                        }
                                    </td>
                                    <td>${getRoleBadge(account.role)}</td>
                                    <td>
                                        ${account.role === 'admin' || account.role === 'submaster_admin' 
                                            ? (account.managed_by_name 
                                                ? `<span style="color: #1e40af; font-weight: 500;"> ${account.managed_by_name}</span>`
                                                : `<span style="color: var(--text-muted); font-size: 0.85rem;">Self-managed</span>`)
                                            : `<span style="color: var(--text-muted);"></span>`
                                        }
                                    </td>
                                    <td>
                                        ${(() => {
                                            const propCount = parseInt(account.property_count) || 0;
                                            const stripePropsCount = parseInt(account.stripe_properties_count) || 0;
                                            const hasAccountStripe = !!account.stripe_account_id;
                                            
                                            if (hasAccountStripe) {
                                                return `<div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span class="badge badge-success"> Connected</span>
                                                    <button class="btn btn-secondary btn-small" onclick="disconnectStripe(${account.id}, '${account.name}')" style="font-size: 0.7rem; padding: 0.15rem 0.4rem; color: #dc2626;">Disconnect</button>
                                                </div>`;
                                            } else if (stripePropsCount > 0 && stripePropsCount >= propCount && propCount > 0) {
                                                return `<span class="badge badge-success" style="cursor: default;"> ${stripePropsCount}/${propCount} Properties</span>`;
                                            } else if (stripePropsCount > 0) {
                                                return `<span class="badge badge-warning" style="cursor: default;"> ${stripePropsCount}/${propCount} Properties</span>`;
                                            } else if (propCount === 0) {
                                                return `<span style="color: var(--text-muted); font-size: 0.85rem;">No properties</span>`;
                                            } else {
                                                return `<button class="btn btn-secondary btn-small" onclick="connectStripeForAccount(${account.id})" style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">Connect</button>`;
                                            }
                                        })()}
                                    </td>
                                    <td>
                                        <span id="account-plan-${account.id}" class="badge badge-secondary" style="cursor: pointer;" onclick="openAssignPlanModal(${account.id}, \`${account.name.replace(/`/g, "'")}\`)">
                                            Loading...
                                        </span>
                                    </td>
                                    <td><span class="badge">${account.property_count || 0}</span></td>
                                    <td>
                                        <span class="badge ${account.status === 'active' ? 'badge-success' : account.status === 'pending' ? 'badge-warning' : 'badge-secondary'}">
                                            ${account.status || 'active'}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            <button class="btn btn-secondary btn-small" onclick="viewAccount(${account.id})">View</button>
                                            ${currentAccount && currentAccount.role === 'master_admin' ? `
                                                <button class="btn btn-secondary btn-small" onclick="editAccount(${account.id})">Edit</button>
                                                <button class="btn btn-secondary btn-small" onclick="deleteAccount(${account.id}, \`${account.name.replace(/`/g, "'")}\`)" style="color: #dc2626;">Delete</button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Load plan badges for each account
            accounts.forEach(account => loadAccountPlanBadge(account.id));
        }
        
        function connectStripeForAccount(accountId) {
            window.location.href = `/api/stripe/connect/${accountId}`;
        }
        
        async function disconnectStripe(accountId, accountName) {
            if (!confirm(`Are you sure you want to disconnect Stripe from "${accountName}"?\n\nThis will prevent this account from accepting card payments until reconnected.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${accountId}/stripe-disconnect`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Stripe disconnected successfully');
                    loadAccounts();
                } else {
                    alert('Error disconnecting Stripe: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error disconnecting Stripe:', error);
                alert('Error disconnecting Stripe');
            }
        }
        
        // Generate account code from name
        async function generateAccountCode(accountId, accountName) {
            const code = prompt('Enter account code (e.g., ELEVATE, LH001):', 
                accountName.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10));
            
            if (!code) return;
            
            try {
                const response = await fetch(`/api/accounts/${accountId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ account_code: code.toUpperCase() })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Account code saved!', 'success');
                    loadAccounts();
                } else {
                    showNotification(data.error || 'Error saving code', 'error');
                }
            } catch (error) {
                showNotification('Error saving code', 'error');
            }
        }
        
        async function generateMissingCodes() {
            if (!confirm('Generate codes for all accounts that don\'t have one?')) return;
            
            try {
                const response = await fetch('/api/admin/generate-account-codes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(`Generated ${data.count} account codes`, 'success');
                    loadAccounts();
                } else {
                    showNotification(data.error || 'Error generating codes', 'error');
                }
            } catch (error) {
                showNotification('Error generating codes', 'error');
            }
        }
        
        function viewAccount(accountId) {
            const account = allAccounts.find(a => a.id === accountId);
            if (!account) return;
            
            // Set the filter variables
            selectedAccountId = accountId;
            selectedAccountName = account.name;
            
            // SYNC with client selector system for blog/attractions filtering
            if (account.public_id) {
                currentClientPublicId = account.public_id;
                clientIdMap[account.public_id] = account.id;
                // Update the dropdown if visible
                const selector = document.getElementById('globalClientSelector');
                if (selector) selector.value = account.public_id;
            }
            
            // Show banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            if (banner && nameEl) {
                banner.style.display = 'flex';
                nameEl.textContent = account.name;
            }
            
            // Hide master-only sections when viewing a client
            updateMasterOnlyVisibility();
            
            // Reload entitlements for selected account
            if (typeof loadAccountEntitlements === 'function') {
                loadAccountEntitlements();
            }
            
            // Navigate to dashboard with new filter
            showView('dashboard');
        }
        
        // Show/hide master-only sections based on whether viewing a client
        function updateMasterOnlyVisibility() {
            const isMaster = currentAccount && currentAccount.role === 'master_admin';
            const isViewingClient = selectedAccountId !== null;
            
            // Master-only sections: show only when master AND not viewing a client
            const showMasterSections = isMaster && !isViewingClient;
            
            document.querySelectorAll('.master-only').forEach(el => {
                el.style.display = showMasterSections ? 'block' : 'none';
            });
            
            // Billing admin items: same logic
            document.querySelectorAll('.billing-admin-only').forEach(el => {
                if (el.tagName === 'A') {
                    el.style.display = showMasterSections ? 'flex' : 'none';
                } else if (el.tagName === 'BUTTON') {
                    el.style.display = showMasterSections ? 'inline-flex' : 'none';
                } else {
                    el.style.display = showMasterSections ? 'block' : 'none';
                }
            });
            
            console.log('updateMasterOnlyVisibility - isMaster:', isMaster, 'isViewingClient:', isViewingClient, 'showMasterSections:', showMasterSections);
        }
        
        // Load plan badge for an account
        async function loadAccountPlanBadge(accountId) {
            const badge = document.getElementById(`account-plan-${accountId}`);
            if (!badge) return;
            
            try {
                const response = await fetch(`/api/admin/billing/subscription/${accountId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const planColors = {
                        'starter': '#6b7280',
                        'professional': '#2563eb',
                        'business': '#7c3aed',
                        'enterprise': '#dc2626'
                    };
                    const color = planColors[data.data.plan_slug] || '#6b7280';
                    badge.innerHTML = data.data.plan_name;
                    badge.style.background = color;
                    badge.style.color = 'white';
                } else {
                    badge.innerHTML = 'No Plan';
                    badge.style.background = '#e5e7eb';
                    badge.style.color = '#6b7280';
                }
            } catch (error) {
                badge.innerHTML = 'Error';
                badge.style.background = '#fee2e2';
                badge.style.color = '#dc2626';
            }
        }
        
        // Open assign plan modal
        let assignPlanAccountId = null;
        let assignPlanAccountName = null;
        
        async function openAssignPlanModal(accountId, accountName) {
            assignPlanAccountId = accountId;
            assignPlanAccountName = accountName;
            
            // Reset all checkboxes
            document.getElementById('assign-plan-api-access').checked = false;
            document.getElementById('assign-plan-blog-module').checked = false;
            document.getElementById('assign-plan-attractions-module').checked = false;
            document.getElementById('assign-plan-reviews-widget').checked = false;
            
            // Load plans for dropdown
            try {
                const response = await fetch('/api/admin/billing/plans');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const select = document.getElementById('assign-plan-select');
                    select.innerHTML = '<option value="">-- Select Plan --</option>' + 
                        data.data.filter(p => p.is_active).map(plan => 
                            `<option value="${plan.id}">${plan.name} - ${parseFloat(plan.price_monthly).toFixed(2)}/mo</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading plans:', error);
            }
            
            // Get current subscription
            try {
                const response = await fetch(`/api/admin/billing/subscription/${accountId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    document.getElementById('assign-plan-select').value = data.data.plan_id;
                    document.getElementById('assign-plan-current').innerHTML = `Current plan: <strong>${data.data.plan_name}</strong>`;
                    document.getElementById('assign-plan-current').style.display = 'block';
                    
                    // Load feature overrides
                    const overrides = data.data.feature_overrides || {};
                    document.getElementById('assign-plan-api-access').checked = overrides.api_access === true;
                    document.getElementById('assign-plan-blog-module').checked = overrides.blog_module === true;
                    document.getElementById('assign-plan-attractions-module').checked = overrides.attractions_module === true;
                    document.getElementById('assign-plan-reviews-widget').checked = overrides.reviews_widget === true;
                } else {
                    document.getElementById('assign-plan-current').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('assign-plan-current').style.display = 'none';
            }
            
            document.getElementById('assign-plan-account-name').textContent = accountName;
            openModal('assignPlanModal');
        }
        
        async function saveAssignedPlan() {
            const planId = document.getElementById('assign-plan-select').value;
            const billingCycle = document.getElementById('assign-plan-cycle').value;
            const apiAccess = document.getElementById('assign-plan-api-access').checked;
            const blogModule = document.getElementById('assign-plan-blog-module').checked;
            const attractionsModule = document.getElementById('assign-plan-attractions-module').checked;
            const reviewsWidget = document.getElementById('assign-plan-reviews-widget').checked;
            
            if (!planId) {
                showNotification('Please select a plan', 'error');
                return;
            }
            
            // Build feature overrides (only include if checked)
            const featureOverrides = {};
            if (apiAccess) featureOverrides.api_access = true;
            if (blogModule) featureOverrides.blog_module = true;
            if (attractionsModule) featureOverrides.attractions_module = true;
            if (reviewsWidget) featureOverrides.reviews_widget = true;
            
            try {
                const response = await fetch('/api/admin/billing/assign-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: assignPlanAccountId,
                        plan_id: parseInt(planId),
                        billing_cycle: billingCycle,
                        feature_overrides: featureOverrides
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(`Plan assigned to ${assignPlanAccountName}!`, 'success');
                    closeModal('assignPlanModal');
                    loadAccountPlanBadge(assignPlanAccountId);
                    // Reload entitlements if viewing this account
                    if (selectedAccountId === assignPlanAccountId) {
                        loadAccountEntitlements();
                    }
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error assigning plan', 'error');
            }
        }
        
        async function cancelAccountSubscription() {
            if (!confirm(`Cancel subscription for ${assignPlanAccountName}?`)) return;
            
            try {
                const response = await fetch('/api/admin/billing/cancel-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ account_id: assignPlanAccountId })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Subscription cancelled', 'success');
                    closeModal('assignPlanModal');
                    loadAccountPlanBadge(assignPlanAccountId);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error cancelling subscription', 'error');
            }
        }
        
        // Account filter (like the old agency filter)
        // selectedAccountId and selectedAccountName are declared at the top with other globals
        
        function setAccountFilter(accountId, accountName) {
            selectedAccountId = accountId;
            selectedAccountName = accountName;
            
            // SYNC with client selector system for blog/attractions filtering
            const account = allAccounts.find(a => a.id === accountId);
            if (account && account.public_id) {
                currentClientPublicId = account.public_id;
                clientIdMap[account.public_id] = account.id;
                const selector = document.getElementById('globalClientSelector');
                if (selector) selector.value = account.public_id;
            }
            
            // Show banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            if (banner && nameEl) {
                banner.style.display = 'flex';
                nameEl.textContent = accountName;
            }
            
            // Hide master-only sections when viewing a client
            updateMasterOnlyVisibility();
            
            // Reload entitlements for selected account
            if (typeof loadAccountEntitlements === 'function') {
                loadAccountEntitlements();
            }
            
            // Reload current view with filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                showView(viewName);
            }
        }
        
        function clearAccountFilter() {
            // Only master_admin can clear the filter
            if (currentAccount && currentAccount.role !== 'master_admin') {
                console.log('Non-master admin cannot clear account filter');
                return;
            }
            
            console.log('clearAccountFilter called - previous selectedAccountId:', selectedAccountId);
            
            selectedAccountId = null;
            selectedAccountName = null;
            
            // SYNC with client selector system
            currentClientPublicId = null;
            const selector = document.getElementById('globalClientSelector');
            if (selector) selector.value = '';
            
            // Clear URL parameter
            const url = new URL(window.location);
            url.searchParams.delete('client');
            window.history.pushState({}, '', url);
            
            // Also clear old agency filter
            selectedAgencyId = null;
            selectedAgencyName = null;
            
            // Clear deployed site selection too
            selectedDeployedSiteId = null;
            
            console.log('Account filter cleared - selectedAccountId is now:', selectedAccountId);
            
            // Hide banner
            const banner = document.getElementById('agencyFilterBanner');
            if (banner) banner.style.display = 'none';
            
            // Show master-only sections again
            updateMasterOnlyVisibility();
            
            // Reload entitlements (will show master admin's defaults)
            if (typeof loadAccountEntitlements === 'function') {
                loadAccountEntitlements();
            }
            
            // Reload current view without filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                console.log('Reloading view after clear:', viewName);
                showView(viewName);
            }
        }
        
        function openChangeRoleModal(accountId, currentRole, accountName) {
            const roles = ['admin', 'submaster_admin', 'agency_admin'];
            const roleLabels = {
                'admin': ' Admin',
                'submaster_admin': ' Sub Master Admin',
                'agency_admin': ' Agency Admin'
            };
            
            const options = roles.map(r => 
                `<option value="${r}" ${r === currentRole ? 'selected' : ''}>${roleLabels[r]}</option>`
            ).join('');
            
            // Remove existing modal if any
            const existingModal = document.getElementById('changeRoleModal');
            if (existingModal) existingModal.remove();
            
            const modalHtml = `
                <div class="modal active" id="changeRoleModal">
                    <div class="modal-content" style="max-width: 400px; border-radius: 16px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                            <h3 class="modal-title" style="margin: 0;"> Change Role</h3>
                            <button class="modal-close" onclick="closeModal('changeRoleModal')" style="color: white;">&times;</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <p style="margin-bottom: 1rem;">Change role for <strong>${accountName}</strong>:</p>
                            <select id="newRoleSelect" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                                ${options}
                            </select>
                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button class="btn btn-secondary" onclick="closeModal('changeRoleModal')" style="flex: 1;">Cancel</button>
                                <button class="btn" onclick="saveAccountRole(${accountId})" style="flex: 1;">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        async function saveAccountRole(accountId) {
            const newRole = document.getElementById('newRoleSelect').value;
            
            try {
                const response = await fetch(`/api/admin/accounts/${accountId}/update-role`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ role: newRole })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('changeRoleModal');
                    loadAccounts();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // =====================================================
        // AGENCY ASSIGNMENT (Master Admin)
        // =====================================================
        
        async function openAssignAgencyModal(accountId, accountName) {
            console.log('openAssignAgencyModal called:', accountId, accountName);
            try {
                // Load available agencies
                const response = await fetch('/api/agencies/available', { headers: authHeaders() });
                const data = await response.json();
                
                console.log('Available agencies:', data);
                
                if (!data.success) {
                    alert('Error loading agencies: ' + data.error);
                    return;
                }
                
                if (!data.agencies || data.agencies.length === 0) {
                    alert('No agencies available. Create an Agency Admin account first.');
                    return;
                }
                
                const options = data.agencies.map(a => 
                    `<option value="${a.id}">${a.business_name || a.name}</option>`
                ).join('');
                
                // Remove existing modal if any
                const existingModal = document.getElementById('assignAgencyModal');
                if (existingModal) existingModal.remove();
                
                const modalHtml = `
                    <div class="modal active" id="assignAgencyModal">
                        <div class="modal-content" style="max-width: 450px; border-radius: 16px;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                                <h3 class="modal-title" style="margin: 0;"> Assign Agency</h3>
                                <button class="modal-close" onclick="closeModal('assignAgencyModal')" style="color: white;">&times;</button>
                            </div>
                            <div style="padding: 1.5rem;">
                                <p style="margin-bottom: 1rem;">Assign an agency to manage <strong>${accountName}</strong>:</p>
                                <select id="agencySelectModal" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                                    <option value="">Select agency...</option>
                                    ${options}
                                </select>
                                <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem; color: #0369a1;">
                                     The agency will be able to view and manage this account's properties and bookings.
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button class="btn btn-secondary" onclick="closeModal('assignAgencyModal')" style="flex: 1;">Cancel</button>
                                    <button class="btn" onclick="saveAgencyAssignment(${accountId})" style="flex: 1;">Assign</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            } catch (error) {
                console.error('Error in openAssignAgencyModal:', error);
                alert('Error loading agencies: ' + error.message);
            }
        }
        
        async function saveAgencyAssignment(accountId) {
            const agencyId = document.getElementById('agencySelectModal').value;
            
            if (!agencyId) {
                alert('Please select an agency');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/accounts/${accountId}/assign-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ agency_id: parseInt(agencyId) })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('assignAgencyModal');
                    showNotification('Agency assigned successfully', 'success');
                    loadAccounts();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function removeAccountManagement(accountId, accountName) {
            if (!confirm(`Remove agency management from "${accountName}"?\n\nThey will become self-managed.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${accountId}/remove-management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Management removed', 'success');
                    loadAccounts();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function resetAccountPassword(accountId, email) {
            // Remove existing modal if any
            const existingModal = document.getElementById('passwordResetModal');
            if (existingModal) existingModal.remove();
            
            const modalHtml = `
                <div class="modal active" id="passwordResetModal">
                    <div class="modal-content" style="max-width: 450px; border-radius: 16px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                            <h3 class="modal-title" style="margin: 0;"> Reset Password</h3>
                            <button class="modal-close" onclick="closeModal('passwordResetModal')" style="color: white;">&times;</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <p style="margin-bottom: 1rem;">Set new password for <strong>${email}</strong></p>
                            
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label>New Password *</label>
                                <input type="password" id="new-password-input" class="form-input" placeholder="Enter new password (min 8 characters)" minlength="8" required>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label>Confirm Password *</label>
                                <input type="password" id="confirm-password-input" class="form-input" placeholder="Confirm new password" required>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="closeModal('passwordResetModal')" style="flex: 1;">Cancel</button>
                                <button class="btn" onclick="saveNewPassword(${accountId}, '${email}')" style="flex: 1;">Set Password</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('new-password-input').focus();
        }
        
        async function saveNewPassword(accountId, email) {
            const newPassword = document.getElementById('new-password-input').value;
            const confirmPassword = document.getElementById('confirm-password-input').value;
            
            if (!newPassword || newPassword.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/set-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ account_id: accountId, password: newPassword })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('passwordResetModal');
                    showNotification('Password updated successfully', 'success');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function openAddAccountModal() {
            document.getElementById('account-modal-title').textContent = 'Add Account';
            document.getElementById('account-form').reset();
            document.getElementById('edit-account-id').value = '';
            openModal('accountModal');
        }
        
        async function editAccount(accountId) {
            try {
                const response = await fetch(`/api/accounts/${accountId}`, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.account) {
                    const account = data.account;
                    
                    // Header
                    document.getElementById('account-modal-title').textContent = account.name || 'Edit Account';
                    document.getElementById('account-modal-subtitle').textContent = account.email || '';
                    
                    // Hidden fields
                    document.getElementById('edit-account-id').value = account.id;
                    document.getElementById('account-code').value = account.account_code || '';
                    document.getElementById('account-role').value = account.role || 'admin';
                    document.getElementById('account-status').value = account.status || 'active';
                    
                    // Display fields (read-only)
                    document.getElementById('account-code-display').textContent = account.account_code || '';
                    
                    // Role and Status - show dropdowns for Master Admin, text for others
                    const roleDisplayContainer = document.getElementById('account-role-display-container');
                    const roleSelect = document.getElementById('account-role-select');
                    const statusDisplayContainer = document.getElementById('account-status-display-container');
                    const statusSelect = document.getElementById('account-status-select');
                    
                    if (currentAccount && currentAccount.role === 'master_admin') {
                        // Master Admin can edit role and status
                        roleDisplayContainer.style.display = 'none';
                        roleSelect.style.display = 'block';
                        roleSelect.value = account.role || 'admin';
                        
                        statusDisplayContainer.style.display = 'none';
                        statusSelect.style.display = 'block';
                        statusSelect.value = account.status || 'active';
                    } else {
                        // Others see read-only text
                        roleDisplayContainer.style.display = 'block';
                        roleDisplayContainer.textContent = formatRole(account.role);
                        roleSelect.style.display = 'none';
                        
                        statusDisplayContainer.style.display = 'block';
                        statusDisplayContainer.textContent = (account.status || 'active').charAt(0).toUpperCase() + (account.status || 'active').slice(1);
                        statusSelect.style.display = 'none';
                    }
                    
                    // Editable fields
                    document.getElementById('account-name').value = account.name || '';
                    document.getElementById('account-contact-name').value = account.contact_name || '';
                    document.getElementById('account-email').value = account.email || '';
                    document.getElementById('account-phone').value = account.phone || '';
                    document.getElementById('account-address1').value = account.address_line1 || '';
                    document.getElementById('account-address2').value = account.address_line2 || '';
                    document.getElementById('account-city').value = account.city || '';
                    document.getElementById('account-region').value = account.region || '';
                    document.getElementById('account-postcode').value = account.postcode || '';
                    document.getElementById('account-country').value = account.country || '';
                    
                    // Agency Management section (only for admin/submaster)
                    const agencySection = document.getElementById('account-agency-section');
                    const agencyStatus = document.getElementById('account-agency-status');
                    
                    if (account.role === 'admin' || account.role === 'submaster_admin') {
                        agencySection.style.display = 'block';
                        
                        if (account.managed_by_id) {
                            // Currently managed by an agency
                            agencyStatus.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #1e40af;"> Managed by Agency</div>
                                        <div style="font-size: 0.85rem; color: #64748b;">${account.managed_by_name || 'Agency ID: ' + account.managed_by_id}</div>
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="removeAgencyFromModal(${account.id})">
                                         Remove Agency
                                    </button>
                                </div>
                            `;
                        } else {
                            // Self-managed
                            agencyStatus.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600;"> Self-Managed</div>
                                        <div style="font-size: 0.85rem; color: #64748b;">No agency assigned</div>
                                    </div>
                                    <button type="button" class="btn" onclick="assignAgencyFromModal(${account.id}, '${(account.name || '').replace(/'/g, '')}')">
                                        + Assign Agency
                                    </button>
                                </div>
                            `;
                        }
                    } else {
                        agencySection.style.display = 'none';
                    }
                    
                    // Store account ID for password reset
                    document.getElementById('accountModal').dataset.accountId = account.id;
                    document.getElementById('accountModal').dataset.accountEmail = account.email;
                    
                    openModal('accountModal');
                } else {
                    alert('Error loading account: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading account:', error);
                alert('Error loading account: ' + error.message);
            }
        }
        
        function resetPasswordFromModal() {
            const modal = document.getElementById('accountModal');
            const accountId = modal.dataset.accountId;
            const email = modal.dataset.accountEmail;
            
            if (confirm(`Reset password for ${email}?\n\nThis will clear their password and they'll need to use "Set Password" to create a new one.`)) {
                resetAccountPassword(accountId, email);
            }
        }
        
        function assignAgencyFromModal(accountId, accountName) {
            closeModal('accountModal');
            openAssignAgencyModal(accountId, accountName);
        }
        
        async function removeAgencyFromModal(accountId) {
            if (!confirm('Remove agency management? The account will become self-managed.')) return;
            
            try {
                const response = await fetch(`/api/accounts/${accountId}/remove-management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Agency removed', 'success');
                    closeModal('accountModal');
                    loadAccounts();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error removing agency');
            }
        }
        
        async function deleteAccount(accountId, accountName) {
            if (!confirm(` DELETE ACCOUNT "${accountName}"?\n\nThis will permanently delete:\n The account\n All properties\n All rooms\n All reservations\n All related data\n\nThis action cannot be undone!`)) {
                return;
            }
            
            // Double confirm for safety
            if (!confirm(`FINAL CONFIRMATION\n\nType "DELETE" in the next prompt to confirm deletion of "${accountName}".`)) {
                return;
            }
            
            const confirmText = prompt(`Type DELETE to confirm deletion of "${accountName}":`);
            if (confirmText !== 'DELETE') {
                showNotification('Deletion cancelled', 'info');
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${accountId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Account "${accountName}" deleted successfully`, 'success');
                    loadAccounts();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting account: ' + error.message);
            }
        }
        
        async function saveAccount(event) {
            event.preventDefault();
            
            const accountId = document.getElementById('edit-account-id').value;
            const accountData = {
                name: document.getElementById('account-name').value,
                contact_name: document.getElementById('account-contact-name').value,
                email: document.getElementById('account-email').value,
                phone: document.getElementById('account-phone').value,
                address_line1: document.getElementById('account-address1').value,
                address_line2: document.getElementById('account-address2').value,
                city: document.getElementById('account-city').value,
                region: document.getElementById('account-region').value,
                postcode: document.getElementById('account-postcode').value,
                country: document.getElementById('account-country').value
            };
            
            // Master Admin can also update role and status
            if (currentAccount && currentAccount.role === 'master_admin') {
                const roleSelect = document.getElementById('account-role-select');
                const statusSelect = document.getElementById('account-status-select');
                if (roleSelect && roleSelect.style.display !== 'none') {
                    accountData.role = roleSelect.value;
                }
                if (statusSelect && statusSelect.style.display !== 'none') {
                    accountData.status = statusSelect.value;
                }
            }
            
            try {
                const url = `/api/accounts/${accountId}`;
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(accountData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('accountModal');
                    loadAccounts();
                    showNotification('Account saved successfully', 'success');
                } else {
                    alert('Error saving account: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving account:', error);
                alert('Error saving account');
            }
        }

        async function loadAgencies() {
            const container = document.getElementById('agencies-list');
            try {
                const response = await fetch('/api/admin/agencies');
                const data = await response.json();
                
                // Also get direct clients count (clients without agency)
                const clientsRes = await fetch('/api/admin/clients');
                const clientsData = await clientsRes.json();
                const directClients = clientsData.clients?.filter(c => !c.agency_id) || [];
                const agencyClients = clientsData.clients?.filter(c => c.agency_id) || [];
                
                if (data.success && data.agencies) {
                    // Update stats
                    document.getElementById('stat-total-agencies').textContent = data.agencies.length;
                    document.getElementById('stat-agency-clients').textContent = agencyClients.length;
                    document.getElementById('stat-agency-properties').textContent = data.agencies.reduce((sum, a) => sum + parseInt(a.property_count || 0), 0);
                    document.getElementById('stat-direct-clients').textContent = directClients.length;
                    
                    if (data.agencies.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #64748b;">
                                <p style="font-size: 3rem; margin-bottom: 1rem;"></p>
                                <p>No agencies yet.</p>
                                <p style="font-size: 0.9rem; margin-top: 0.5rem;">Agencies are partners who manage multiple property owners.</p>
                                <button class="btn" onclick="openAddAgencyModal()" style="margin-top: 1rem;">Add Your First Agency</button>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Agency</th>
                                        <th>Clients</th>
                                        <th>Properties</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.agencies.map(agency => `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, ${agency.primary_color || '#10b981'} 0%, ${agency.secondary_color || '#059669'} 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                                                        ${agency.name.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <strong>${agency.name}</strong>
                                                        <div style="font-size: 0.8rem; color: #64748b;">${agency.email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="badge">${agency.client_count || 0}</span></td>
                                            <td><span class="badge">${agency.property_count || 0}</span></td>
                                            <td>
                                                <span class="badge ${agency.plan === 'enterprise' ? 'badge-warning' : 'badge-success'}">
                                                    ${agency.plan}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${agency.status === 'active' ? 'badge-success' : agency.status === 'pending' ? 'badge-warning' : 'badge-secondary'}">
                                                    ${agency.status}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewAgency(${agency.id})">View</button>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="editAgency(${agency.id})">Edit</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">Error loading agencies. Run /api/setup-clients first.</p>';
                }
            } catch (error) {
                console.error('Error loading agencies:', error);
                container.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 2rem;">Error loading agencies: ${error.message}</p>`;
            }
        }

        function openAddAgencyModal() {
            document.getElementById('agency-id').value = '';
            document.getElementById('agency-public-id').value = '';
            document.getElementById('agency-form').reset();
            document.getElementById('agency-modal-title').textContent = ' Add New Agency';
            document.getElementById('agency-country').value = 'CH';
            document.getElementById('agency-primary-color').value = '#6366f1';
            document.getElementById('agency-secondary-color').value = '#8b5cf6';
            document.getElementById('agency-api-key-section').style.display = 'none';
            openModal('agencyModal');
        }

        async function editAgency(agencyId) {
            try {
                const response = await fetch(`/api/admin/agencies/${agencyId}`);
                const data = await response.json();
                
                if (data.success && data.agency) {
                    const a = data.agency;
                    document.getElementById('agency-id').value = a.id;
                    document.getElementById('agency-public-id').value = a.public_id || '';
                    document.getElementById('agency-name').value = a.name || '';
                    document.getElementById('agency-email').value = a.email || '';
                    document.getElementById('agency-phone').value = a.phone || '';
                    document.getElementById('agency-website').value = a.website_url || '';
                    document.getElementById('agency-address1').value = a.address_line1 || '';
                    document.getElementById('agency-city').value = a.city || '';
                    document.getElementById('agency-country').value = normalizeCountryCode(a.country) || 'CH';
                    document.getElementById('agency-primary-color').value = a.primary_color || '#6366f1';
                    document.getElementById('agency-secondary-color').value = a.secondary_color || '#8b5cf6';
                    document.getElementById('agency-logo').value = a.logo_url || '';
                    document.getElementById('agency-currency').value = a.currency || 'CHF';
                    document.getElementById('agency-plan').value = a.plan || 'agency';
                    document.getElementById('agency-status').value = a.status || 'active';
                    document.getElementById('agency-notes').value = a.notes || '';
                    
                    // Show API key
                    if (a.api_key) {
                        document.getElementById('agency-api-key-display').value = a.api_key;
                        document.getElementById('agency-api-key-section').style.display = 'block';
                    } else {
                        document.getElementById('agency-api-key-section').style.display = 'none';
                    }
                    
                    document.getElementById('agency-modal-title').textContent = ' Edit Agency';
                    openModal('agencyModal');
                }
            } catch (error) {
                alert('Error loading agency: ' + error.message);
            }
        }

        async function saveAgency(event) {
            event.preventDefault();
            
            const agencyId = document.getElementById('agency-id').value;
            const agencyData = {
                name: document.getElementById('agency-name').value,
                email: document.getElementById('agency-email').value,
                phone: document.getElementById('agency-phone').value,
                website_url: document.getElementById('agency-website').value,
                address_line1: document.getElementById('agency-address1').value,
                city: document.getElementById('agency-city').value,
                country: document.getElementById('agency-country').value,
                primary_color: document.getElementById('agency-primary-color').value,
                secondary_color: document.getElementById('agency-secondary-color').value,
                logo_url: document.getElementById('agency-logo').value,
                currency: document.getElementById('agency-currency').value,
                plan: document.getElementById('agency-plan').value,
                status: document.getElementById('agency-status').value,
                notes: document.getElementById('agency-notes').value
            };
            
            try {
                const url = agencyId ? `/api/admin/agencies/${agencyId}` : '/api/admin/agencies';
                const method = agencyId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(agencyData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('agencyModal');
                    loadAgencies();
                    // If new agency, show success with API key
                    if (!agencyId && result.agency?.api_key) {
                        alert(` Agency created!\n\nAPI Key: ${result.agency.api_key}\n\nSave this key - it's needed for API access.`);
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving agency: ' + error.message);
            }
        }

        async function viewAgency(agencyId) {
            try {
                const response = await fetch(`/api/admin/agencies/${agencyId}`);
                const data = await response.json();
                
                if (data.success) {
                    const a = data.agency;
                    // Set the filter and navigate to dashboard
                    setAgencyFilter(a.id, a.name);
                    showView('dashboard');
                }
            } catch (error) {
                alert('Error loading agency: ' + error.message);
            }
        }
        
        // View agency details in modal (for Edit button)
        async function viewAgencyDetails(agencyId) {
            try {
                const response = await fetch(`/api/admin/agencies/${agencyId}`);
                const data = await response.json();
                
                if (data.success) {
                    const a = data.agency;
                    const properties = data.properties || [];
                    const totalRooms = properties.reduce((sum, p) => sum + parseInt(p.room_count || 0), 0);
                    
                    document.getElementById('agency-detail-title').textContent = a.name;
                    document.getElementById('agency-detail-subtitle').textContent = `${properties.length} properties  ${a.email}`;
                    
                    document.getElementById('agency-detail-content').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${properties.length}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Properties</div>
                            </div>
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${totalRooms}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Rooms</div>
                            </div>
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700;">${a.plan}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">Plan</div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem 0;">Agency Properties</h4>
                        ${properties.length === 0 ? `
                            <div style="text-align: center; padding: 2rem; color: #64748b; background: var(--bg-primary); border-radius: 8px;">
                                <p>No properties assigned to this agency yet.</p>
                                <p style="font-size: 0.85rem; margin-top: 0.5rem;">Go to Properties and use the Agency dropdown to assign properties.</p>
                            </div>
                        ` : `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Property</th>
                                            <th>Location</th>
                                            <th>Rooms</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${properties.map(p => `
                                            <tr>
                                                <td><strong>${p.name}</strong></td>
                                                <td style="font-size: 0.85rem; color: #64748b;">${p.city || 'N/A'}, ${p.country || ''}</td>
                                                <td><span class="badge">${p.room_count || 0}</span></td>
                                                <td>
                                                    <span class="badge ${p.status === 'active' ? 'badge-success' : 'badge-secondary'}">${p.status || 'active'}</span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-secondary btn-small" onclick="editProperty(${p.id}); closeModal('agencyDetailModal');" style="font-size: 0.75rem;">Edit</button>
                                                    <button class="btn btn-secondary btn-small" onclick="removePropertyFromAgency(${p.id}, ${a.id})" style="font-size: 0.75rem;">Remove</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0; display: flex; gap: 1rem;">
                            <button onclick="editAgency(${a.id}); closeModal('agencyDetailModal');" class="btn btn-secondary">Edit Agency</button>
                            <button onclick="closeModal('agencyDetailModal')" class="btn">Close</button>
                        </div>
                    `;
                    
                    openModal('agencyDetailModal');
                }
            } catch (error) {
                alert('Error loading agency: ' + error.message);
            }
        }
        
        async function removePropertyFromAgency(propertyId, agencyId) {
            if (!confirm('Remove this property from the agency?')) return;
            
            try {
                const response = await fetch(`/api/admin/properties/${propertyId}/assign-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ agency_id: null })
                });
                const result = await response.json();
                if (result.success) {
                    viewAgency(agencyId);
                    loadAgencies();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function copyAgencyApiKey() {
            const keyInput = document.getElementById('agency-api-key-display');
            keyInput.select();
            navigator.clipboard.writeText(keyInput.value).then(() => {
                alert(' API key copied!');
            }).catch(() => {
                document.execCommand('copy');
                alert(' Copied!');
            });
        }

        async function assignClientToAgency(agencyId) {
            // Get unassigned clients
            const response = await fetch('/api/admin/clients');
            const data = await response.json();
            const unassignedClients = data.clients?.filter(c => !c.agency_id) || [];
            
            if (unassignedClients.length === 0) {
                alert('No unassigned clients available. Create a new client first.');
                return;
            }
            
            const clientOptions = unassignedClients.map(c => `${c.id}: ${c.business_name || c.name}`).join('\n');
            const selectedId = prompt(`Enter client ID to assign:\n\n${clientOptions}`);
            
            if (selectedId) {
                try {
                    const res = await fetch(`/api/admin/agencies/${agencyId}/assign-client`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ client_id: parseInt(selectedId) })
                    });
                    const result = await res.json();
                    if (result.success) {
                        alert(' Client assigned to agency!');
                        viewAgency(agencyId);
                        loadAgencies();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        async function removeClientFromAgency(agencyId, clientId) {
            if (!confirm('Remove this client from the agency? They will become a direct client.')) return;
            
            try {
                const res = await fetch(`/api/admin/agencies/${agencyId}/remove-client`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ client_id: clientId })
                });
                const result = await res.json();
                if (result.success) {
                    alert(' Client removed from agency');
                    viewAgency(agencyId);
                    loadAgencies();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function selectClientAndClose(clientId) {
            closeModal('agencyDetailModal');
            // Select the client in the dropdown and switch to their view
            document.getElementById('client-selector').value = clientId;
            clientId = clientId;
            selectedClientId = clientId;
            localStorage.setItem('selectedClientId', clientId);
            showView('dashboard');
        }

        // =========================================================
        // CLIENT MANAGEMENT FUNCTIONS
        // =========================================================

        async function loadClients() {
            const container = document.getElementById('clients-list');
            try {
                const [clientsRes, unassignedRes] = await Promise.all([
                    fetch('/api/admin/clients'),
                    fetch('/api/admin/properties/unassigned')
                ]);
                const data = await clientsRes.json();
                const unassignedData = await unassignedRes.json();
                
                if (data.success && data.clients) {
                    // Update stats
                    document.getElementById('stat-total-clients').textContent = data.clients.length;
                    document.getElementById('stat-active-clients').textContent = data.clients.filter(c => c.status === 'active').length;
                    document.getElementById('stat-paid-clients').textContent = data.clients.filter(c => c.plan !== 'free').length;
                    document.getElementById('stat-unassigned-props').textContent = unassignedData.properties?.length || 0;
                    
                    if (data.clients.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #64748b;">
                                <p style="font-size: 3rem; margin-bottom: 1rem;"></p>
                                <p>No direct clients. All accounts are agencies.</p>
                                <button class="btn" onclick="openAddClientModal()" style="margin-top: 1rem;">Add Direct Client</button>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Client</th>
                                        <th>Properties</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Setup Link</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.clients.map(client => `
                                        <tr>
                                            <td>
                                                <strong>${client.business_name || client.name}</strong>
                                                <div style="font-size: 0.8rem; color: #64748b;">${client.email}</div>
                                            </td>
                                            <td><span class="badge">${client.property_count || 0}</span></td>
                                            <td>
                                                <span class="badge ${client.plan === 'free' ? 'badge-secondary' : 'badge-warning'}">
                                                    ${client.plan}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${client.status === 'active' ? 'badge-success' : client.status === 'pending' ? 'badge-warning' : 'badge-secondary'}">
                                                    ${client.status}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: #10b981;" onclick="copySetupLink('${client.public_id || client.id}')">
                                                     Copy Link
                                                </button>
                                            </td>
                                            <td>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewClient(${client.id})">View</button>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="editClient(${client.id})">Edit</button>
                                                ${parseInt(client.property_count) > 1 ? `
                                                    <button class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: #6366f1;" onclick="convertToAgency(${client.id}, '${client.name}')">
                                                         Make Agency
                                                    </button>
                                                ` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No clients table found. Run the migration first.</p>';
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                container.innerHTML = `<p style="color: #ef4444; text-align: center; padding: 2rem;">Error loading clients: ${error.message}</p>`;
            }
        }
        
        // Copy setup link for client
        function copySetupLink(publicId) {
            const baseUrl = window.location.origin;
            const setupLink = `${baseUrl}/setup.html?c=${publicId}`;
            
            navigator.clipboard.writeText(setupLink).then(() => {
                alert(' Setup link copied!\n\n' + setupLink);
            }).catch(() => {
                prompt('Copy this setup link:', setupLink);
            });
        }

        // Convert client to agency
        async function convertToAgency(clientId, clientName) {
            if (!confirm(`Convert "${clientName}" to an Agency?\n\nThis will:\n Create an agency account for them\n Remove them from the Clients list\n They'll appear under Agencies instead`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/convert-to-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(` ${clientName} is now an Agency!\n\nAPI Key: ${result.agency.api_key}`);
                    loadClients();
                    loadAgencies();
                    loadClientSelector();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error converting to agency: ' + error.message);
            }
        }

        function openAddClientModal() {
            document.getElementById('client-id').value = '';
            document.getElementById('client-public-id').value = '';
            document.getElementById('client-form').reset();
            document.getElementById('client-modal-title').textContent = ' Add New Client';
            document.getElementById('client-country').value = 'GB';
            document.getElementById('client-setup-link-section').style.display = 'none';
            openModal('clientModal');
        }

        async function editClient(clientId) {
            try {
                const response = await fetch(`/api/admin/clients/${clientId}`);
                const data = await response.json();
                
                if (data.success && data.client) {
                    const c = data.client;
                    document.getElementById('client-id').value = c.id;
                    document.getElementById('client-public-id').value = c.public_id || '';
                    document.getElementById('client-name').value = c.name || '';
                    document.getElementById('client-email').value = c.email || '';
                    document.getElementById('client-phone').value = c.phone || '';
                    document.getElementById('client-address1').value = c.address_line1 || '';
                    document.getElementById('client-address2').value = c.address_line2 || '';
                    document.getElementById('client-city').value = c.city || '';
                    document.getElementById('client-region').value = c.region || '';
                    document.getElementById('client-postcode').value = c.postcode || '';
                    document.getElementById('client-country').value = normalizeCountryCode(c.country) || 'GB';
                    document.getElementById('client-currency').value = c.currency || 'GBP';
                    document.getElementById('client-plan').value = c.plan || 'free';
                    document.getElementById('client-status').value = c.status || 'active';
                    document.getElementById('client-notes').value = c.notes || '';
                    
                    // Show setup link section with UUID
                    const setupLinkSection = document.getElementById('client-setup-link-section');
                    if (c.public_id) {
                        const setupLink = `${window.location.origin}/smoobu-wizard.html?c=${c.public_id}`;
                        document.getElementById('client-setup-link-display').value = setupLink;
                        document.getElementById('client-uuid-display').textContent = c.public_id;
                        setupLinkSection.style.display = 'block';
                    } else {
                        setupLinkSection.style.display = 'none';
                    }
                    
                    document.getElementById('client-modal-title').textContent = ' Edit Client';
                    openModal('clientModal');
                }
            } catch (error) {
                alert('Error loading client: ' + error.message);
            }
        }
        
        function copyClientSetupLink() {
            const linkInput = document.getElementById('client-setup-link-display');
            linkInput.select();
            navigator.clipboard.writeText(linkInput.value).then(() => {
                alert(' Setup link copied!\n\n' + linkInput.value);
            }).catch(() => {
                document.execCommand('copy');
                alert(' Copied!');
            });
        }

        async function saveClient(event) {
            event.preventDefault();
            
            const clientId = document.getElementById('client-id').value;
            const clientData = {
                name: document.getElementById('client-name').value,
                email: document.getElementById('client-email').value,
                phone: document.getElementById('client-phone').value,
                address_line1: document.getElementById('client-address1').value,
                address_line2: document.getElementById('client-address2').value,
                city: document.getElementById('client-city').value,
                region: document.getElementById('client-region').value,
                postcode: document.getElementById('client-postcode').value,
                country: document.getElementById('client-country').value,
                currency: document.getElementById('client-currency').value,
                plan: document.getElementById('client-plan').value,
                status: document.getElementById('client-status').value,
                notes: document.getElementById('client-notes').value
            };
            
            try {
                const url = clientId ? `/api/admin/clients/${clientId}` : '/api/admin/clients';
                const method = clientId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(clientData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('clientModal');
                    loadClients();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving client: ' + error.message);
            }
        }

        async function viewClient(clientId) {
            openModal('clientDetailModal');
            document.getElementById('client-detail-content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;">Loading client details...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}`);
                const data = await response.json();
                
                if (data.success) {
                    const c = data.client;
                    document.getElementById('client-detail-title').textContent = c.name;
                    document.getElementById('client-detail-subtitle').textContent = c.email;
                    
                    document.getElementById('client-detail-content').innerHTML = `
                        <!-- API Key Section -->
                        <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8;">API Key</span>
                                <span class="badge ${c.plan === 'free' ? 'badge-secondary' : 'badge-success'}">${c.plan === 'free' ? ' Requires Paid Plan' : ' Active'}</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <code style="flex: 1; background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; word-break: break-all;">
                                    ${c.api_key || 'No API key generated'}
                                </code>
                                <button onclick="copyShortcode('${c.api_key}')" class="btn" style="padding: 0.5rem 1rem;">Copy</button>
                                <button onclick="regenerateApiKey(${c.id})" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Regenerate</button>
                            </div>
                            ${c.plan === 'free' ? '<p style="margin-top: 0.75rem; font-size: 0.8rem; opacity: 0.8;"> Upgrade to a paid plan to enable WordPress plugin API access</p>' : ''}
                        </div>

                        <!-- Properties -->
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <h4 style="margin: 0;">Properties (${data.properties?.length || 0})</h4>
                                <button onclick="assignPropertyToClient(${c.id})" class="btn btn-secondary" style="padding: 0.3rem 0.75rem; font-size: 0.8rem;">+ Assign Property</button>
                            </div>
                            ${data.properties && data.properties.length > 0 ? `
                                <div style="background: var(--bg-primary); border-radius: 8px; overflow: hidden;">
                                    ${data.properties.map(p => `
                                        <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${p.name}</strong>
                                                <span style="font-size: 0.8rem; color: #64748b; margin-left: 0.5rem;">${p.room_count || 0} rooms</span>
                                            </div>
                                            <code style="font-size: 0.75rem; background: var(--bg-secondary); padding: 0.2rem 0.5rem; border-radius: 3px;">ID: ${p.id}</code>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: #64748b; font-size: 0.9rem;">No properties assigned</p>'}
                        </div>

                        <!-- Client Info Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div>
                                <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: #64748b;">Contact</h4>
                                <p style="margin: 0.25rem 0;"><strong>Phone:</strong> ${c.phone || '-'}</p>
                                <p style="margin: 0.25rem 0;"><strong>Address:</strong> ${[c.address_line1, c.city, c.postcode, c.country].filter(Boolean).join(', ') || '-'}</p>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: #64748b;">Settings</h4>
                                <p style="margin: 0.25rem 0;"><strong>Currency:</strong> ${c.currency || 'GBP'}</p>
                                <p style="margin: 0.25rem 0;"><strong>Created:</strong> ${new Date(c.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>

                        ${c.notes ? `
                            <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                                <strong style="color: #92400e;">Notes:</strong>
                                <p style="margin: 0.5rem 0 0 0; color: #78350f;">${c.notes}</p>
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                            <button onclick="editClient(${c.id}); closeModal('clientDetailModal');" class="btn btn-secondary">Edit Client</button>
                            <button onclick="deleteClient(${c.id})" class="btn" style="background: var(--error); border-color: #ef4444;">Delete Client</button>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('client-detail-content').innerHTML = `<p style="color: #ef4444;">Error loading client: ${error.message}</p>`;
            }
        }

        async function regenerateApiKey(clientId) {
            if (!confirm('Are you sure you want to regenerate the API key? The old key will stop working immediately.')) return;
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/regenerate-api-key`, { method: 'POST', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    alert('API key regenerated! New key: ' + result.api_key);
                    viewClient(clientId);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error regenerating API key: ' + error.message);
            }
        }

        async function deleteClient(clientId) {
            if (!confirm('Are you sure you want to delete this client? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}`, { method: 'DELETE', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('clientDetailModal');
                    loadClients();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error deleting client: ' + error.message);
            }
        }

        async function assignPropertyToClient(clientId) {
            try {
                const response = await fetch('/api/admin/properties/unassigned');
                const data = await response.json();
                
                if (!data.properties || data.properties.length === 0) {
                    alert('No unassigned properties available');
                    return;
                }
                
                const propertyId = prompt(
                    'Enter property ID to assign:\n\nUnassigned properties:\n' + 
                    data.properties.map(p => `ID ${p.id}: ${p.name}`).join('\n')
                );
                
                if (propertyId) {
                    const assignResponse = await fetch(`/api/admin/clients/${clientId}/assign-property`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ property_id: parseInt(propertyId) })
                    });
                    
                    const result = await assignResponse.json();
                    if (result.success) {
                        viewClient(clientId);
                    } else {
                        alert('Error: ' + result.error);
                    }
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Copy shortcode to clipboard
        function copyShortcode(shortcode) {
            navigator.clipboard.writeText(shortcode).then(() => {
                const notification = document.createElement('div');
                notification.textContent = 'Copied!';
                notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; z-index: 9999; animation: fadeIn 0.2s;';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            });
        }
        
        // Copy webhook URL to clipboard
        function copyWebhookUrl() {
            const webhookUrl = 'https://admin.gas.travel/api/webhooks/beds24';
            navigator.clipboard.writeText(webhookUrl).then(() => {
                const notification = document.createElement('div');
                notification.textContent = ' Webhook URL copied!';
                notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; z-index: 9999; animation: fadeIn 0.2s;';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            });
        }
        
        async function testWebhookEndpoint() {
            const statusEl = document.getElementById('webhook-status');
            statusEl.innerHTML = ' Testing...';
            
            try {
                // First test GET endpoint
                const getResponse = await fetch('/api/webhooks/beds24');
                const getData = await getResponse.json();
                
                if (getData.status === 'active') {
                    statusEl.innerHTML = '<span style="color: #10b981;"> Endpoint active and reachable</span>';
                    
                    // Now test POST with simulated webhook data
                    const testResponse = await fetch('/api/webhooks/beds24', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({
                            type: 'test',
                            message: 'GAS Admin test webhook',
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    if (testResponse.ok) {
                        statusEl.innerHTML = '<span style="color: #10b981;"> Endpoint working! Check Railway logs for webhook receipt.</span>';
                    }
                } else {
                    statusEl.innerHTML = '<span style="color: #ef4444;"> Endpoint not responding correctly</span>';
                }
            } catch (error) {
                console.error('Webhook test error:', error);
                statusEl.innerHTML = '<span style="color: #ef4444;"> Failed to reach endpoint</span>';
            }
        }
        
        // Initialize webhook URL display
        function initWebhookUrl() {
            const webhookUrlEl = document.getElementById('webhook-url');
            if (webhookUrlEl) {
                webhookUrlEl.textContent = 'https://admin.gas.travel/api/webhooks/beds24';
            }
        }

        // Hostaway webhook functions
        function copyHostawayWebhookUrl() {
            const webhookUrl = 'https://admin.gas.travel/api/webhooks/hostaway';
            navigator.clipboard.writeText(webhookUrl).then(() => {
                const notification = document.createElement('div');
                notification.textContent = 'âœ… Hostaway Webhook URL copied!';
                notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; z-index: 9999; animation: fadeIn 0.2s;';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            });
        }
        
        async function testHostawayWebhook() {
            const statusEl = document.getElementById('hostaway-webhook-status');
            statusEl.innerHTML = 'â³ Testing...';
            
            try {
                const getResponse = await fetch('/api/webhooks/hostaway');
                const getData = await getResponse.json();
                
                if (getData.status === 'active') {
                    statusEl.innerHTML = '<span style="color: #10b981;">âœ… Endpoint active and reachable</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: #ef4444;">âŒ Endpoint not responding correctly</span>';
                }
            } catch (error) {
                console.error('Hostaway webhook test error:', error);
                statusEl.innerHTML = '<span style="color: #ef4444;">âŒ Failed to reach endpoint</span>';
            }
        }
        
        // Show/hide Hostaway webhook section based on connections
        async function checkHostawayConnection() {
            try {
                const response = await fetch('/api/gas-sync/connections?account_id=' + currentAccountId, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.connections) {
                    const hasHostaway = data.connections.some(c => c.adapter_code === 'hostaway');
                    const hostawaySection = document.getElementById('hostaway-webhook-section');
                    if (hostawaySection) {
                        hostawaySection.style.display = hasHostaway ? 'block' : 'none';
                    }
                }
            } catch (error) {
                console.log('Could not check Hostaway connection:', error);
            }
        }

        // Load WordPress view data
        async function loadWordPressView() {
            // Load account website status first
            if (typeof loadAccountWebsite === 'function') {
                loadAccountWebsite();
            }
            
            // Set API URL in all locations
            const apiUrl = window.location.origin;
            document.getElementById('wp-api-url').textContent = apiUrl;
            document.getElementById('wp-api-url-guide').textContent = apiUrl;
            
            // Get client ID
            const clientId = selectedAccountId || JSON.parse(localStorage.getItem('gas_user') || '{}').account_id || '';
            document.getElementById('wp-client-id').textContent = clientId || '-';
            if (document.getElementById('wp-client-id-guide')) {
                document.getElementById('wp-client-id-guide').textContent = clientId || '1';
            }
            
            // Build query params for filtering by account
            let queryParams = [];
            if (selectedAccountId) {
                queryParams.push(`account_id=${selectedAccountId}`);
            } else {
                const user = JSON.parse(localStorage.getItem('gas_user') || '{}');
                if (user.account_id) {
                    queryParams.push(`account_id=${user.account_id}`);
                }
            }
            const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
            
            // Load rooms for reference (filtered by account)
            try {
                const response = await fetch('/api/admin/units' + queryString);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    // Set first property ID in all locations
                    const firstPropertyId = data.data[0].property_id;
                    window.currentPropertyId = firstPropertyId;
                    document.getElementById('shortcode-property-id').textContent = firstPropertyId;
                    document.getElementById('wp-property-id').textContent = firstPropertyId;
                    if (document.getElementById('wp-property-id-guide')) {
                        document.getElementById('wp-property-id-guide').textContent = firstPropertyId;
                    }
                    document.getElementById('wp-rooms-shortcode').textContent = `[gas_rooms]`;
                    
                    // Build rooms table
                    let html = '<table style="width: 100%; font-size: 0.85rem;">';
                    html += '<thead><tr style="text-align: left; border-bottom: 1px solid var(--border);"><th style="padding: 0.5rem;">Room Name</th><th style="padding: 0.5rem;">ID</th><th style="padding: 0.5rem;">Shortcode</th></tr></thead>';
                    html += '<tbody>';
                    
                    data.data.forEach(room => {
                        html += `<tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 0.5rem;">${room.name}</td>
                            <td style="padding: 0.5rem;"><code style="background: #e2e8f0; padding: 0.15rem 0.4rem; border-radius: 3px;">${room.id}</code></td>
                            <td style="padding: 0.5rem;">
                                <code style="background: #1e293b; color: #e2e8f0; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">[gas_booking unit_id="${room.id}"]</code>
                                <button onclick="copyShortcode('[gas_booking unit_id=&quot;${room.id}&quot;]')" style="background: var(--accent); border: none; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-left: 0.5rem;">Copy</button>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    document.getElementById('wp-room-ids').innerHTML = html;
                } else {
                    document.getElementById('wp-room-ids').innerHTML = '<p style="color: #64748b;">No rooms found. Add rooms first or select a client.</p>';
                }
            } catch (error) {
                console.error('Error loading rooms for WordPress view:', error);
                document.getElementById('wp-room-ids').innerHTML = '<p style="color: #ef4444;">Error loading rooms</p>';
            }
        }

        // Open channel manager wizard with current account context
        function openWizard(cm) {
            let url = `/${cm}-wizard.html`;
            // Pass current account's public_id if available
            if (currentAccount && currentAccount.public_id) {
                url += `?c=${currentAccount.public_id}`;
            }
            window.location.href = url;
        }

        // Data Loading
        async function loadDashboard() {
            try {
                // Build query params - prioritize account_id (new system)
                let queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                } else {
                    const clientId = getClientId();
                    if (clientId) {
                        queryParams.push(`client_id=${clientId}`);
                    }
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                console.log('loadDashboard - selectedAccountId:', selectedAccountId, 'queryString:', queryString);
                
                const response = await fetch(`/api/admin/stats${queryString}`);
                const stats = await response.json();
                
                console.log('loadDashboard - stats:', stats);
                
                if (stats.success) {
                    document.getElementById('stat-properties').textContent = stats.properties || 0;
                    document.getElementById('stat-rooms').textContent = stats.units || 0;
                    document.getElementById('stat-bookings').textContent = stats.bookings || 0;
                    document.getElementById('stat-integrations').textContent = stats.connections || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadProperties() {
            const container = document.getElementById('properties-list');
            try {
                // Build query params - prioritize account_id (new system)
                let queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                } else if (selectedAgencyId) {
                    queryParams.push(`agency_id=${selectedAgencyId}`);
                }
                const clientId = getClientId();
                if (clientId) {
                    queryParams.push(`client_id=${clientId}`);
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                // Fetch properties and agencies
                const [propsRes, agenciesRes] = await Promise.all([
                    fetch(`/api/db/properties${queryString}`),
                    fetch('/api/admin/agencies')
                ]);
                const data = await propsRes.json();
                const agenciesData = await agenciesRes.json();
                const agencies = agenciesData.agencies || [];
                
                // Also fetch accounts for the dropdown
                const accountsRes = await fetch('/api/admin/accounts', { headers: authHeaders() });
                const accountsData = await accountsRes.json();
                const allAccounts = accountsData.accounts || [];
                
                // Properties are already filtered by server based on account_id
                // No need for client-side filtering - server handles agency logic
                let properties = data.data || [];
                
                if (properties.length > 0) {
                    const html = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Property Name</th>
                                        <th>Type</th>
                                        <th>Location</th>
                                        <th>Currency</th>
                                        <th>Account</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${properties.map(prop => {
                                        const currentAccount = allAccounts.find(a => a.id === prop.account_id);
                                        return `
                                        <tr>
                                            <td><code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">${prop.id}</code></td>
                                            <td><strong>${prop.name || 'Unnamed Property'}</strong></td>
                                            <td>${prop.property_type || 'N/A'}</td>
                                            <td>${prop.city || 'N/A'}, ${prop.country || 'N/A'}</td>
                                            <td>
                                                <select onchange="updatePropertyCurrency(${prop.id}, this.value)" style="padding: 0.25rem; border-radius: 4px; border: 1px solid #e5e7eb; font-size: 0.85rem;">
                                                    <option value="GBP" ${prop.currency === 'GBP' ? 'selected' : ''}> GBP</option>
                                                    <option value="USD" ${prop.currency === 'USD' ? 'selected' : ''}>$ USD</option>
                                                    <option value="EUR" ${prop.currency === 'EUR' ? 'selected' : ''}> EUR</option>
                                                    <option value="AUD" ${prop.currency === 'AUD' ? 'selected' : ''}>$ AUD</option>
                                                    <option value="CAD" ${prop.currency === 'CAD' ? 'selected' : ''}>$ CAD</option>
                                                    <option value="CHF" ${prop.currency === 'CHF' ? 'selected' : ''}>CHF</option>
                                                    <option value="NZD" ${prop.currency === 'NZD' ? 'selected' : ''}>$ NZD</option>
                                                    <option value="THB" ${prop.currency === 'THB' ? 'selected' : ''}> THB</option>
                                                    <option value="JPY" ${prop.currency === 'JPY' ? 'selected' : ''}> JPY</option>
                                                    <option value="ZAR" ${prop.currency === 'ZAR' ? 'selected' : ''}>R ZAR</option>
                                                    <option value="AED" ${prop.currency === 'AED' ? 'selected' : ''}>. AED</option>
                                                    <option value="SGD" ${prop.currency === 'SGD' ? 'selected' : ''}>$ SGD</option>
                                                    <option value="MYR" ${prop.currency === 'MYR' ? 'selected' : ''}>RM MYR</option>
                                                    <option value="INR" ${prop.currency === 'INR' ? 'selected' : ''}> INR</option>
                                                    <option value="IDR" ${prop.currency === 'IDR' ? 'selected' : ''}>Rp IDR</option>
                                                    <option value="PHP" ${prop.currency === 'PHP' ? 'selected' : ''}> PHP</option>
                                                    <option value="VND" ${prop.currency === 'VND' ? 'selected' : ''}> VND</option>
                                                    <option value="CNY" ${prop.currency === 'CNY' ? 'selected' : ''}> CNY</option>
                                                    <option value="KRW" ${prop.currency === 'KRW' ? 'selected' : ''}> KRW</option>
                                                    <option value="MXN" ${prop.currency === 'MXN' ? 'selected' : ''}>$ MXN</option>
                                                    <option value="BRL" ${prop.currency === 'BRL' ? 'selected' : ''}>R$ BRL</option>
                                                </select>
                                            </td>
                                            <td>
                                                ${currentAccount ? `<span style="color: #10b981; font-weight: 500;">${currentAccount.name}</span>` : '<span style="color: #94a3b8;">-- None --</span>'}
                                            </td>
                                            <td><span class="badge ${prop.status === 'active' ? 'badge-success' : prop.status === 'draft' ? 'badge-warning' : 'badge-secondary'}">${prop.status || 'active'}</span></td>
                                            <td>
                                                <div style="display: flex; gap: 0.25rem;">
                                                    <button class="btn btn-secondary btn-small" onclick="editProperty(${prop.id})">âœï¸ Edit</button>
                                                    <button class="btn btn-secondary btn-small" onclick="openPropertyStripeSettings(${prop.id}, '${(prop.name || '').replace(/'/g, "\\'")}')" title="Stripe Payment Settings" style="${prop.stripe_secret_key ? 'color: #10b981;' : 'color: #f59e0b;'}">ðŸ’³</button>
                                                    <button class="btn btn-secondary btn-small" onclick="openPaymentSettings(${prop.id}, '${(prop.name || '').replace(/'/g, "\\'")}')" title="Payment Settings">âš™ï¸</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <h3>No Properties ${selectedAgencyId ? 'for this Agency' : 'Yet'}</h3>
                            <p>${selectedAgencyId ? 'Assign properties to this agency from the Properties view.' : 'Import your first property from Beds24'}</p>
                            ${!selectedAgencyId ? '<a href="#" onclick="openWizard(\'beds24\')" class="btn">Import Property</a>' : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading properties:', error);
                container.innerHTML = '<p style="color: #ef4444; padding: 2rem; text-align: center;">Error loading properties</p>';
            }
        }
        
        async function resyncProperty(propertyId) {
            if (!confirm('Resync this property from the channel manager? This will update property details, rooms, and images.')) return;
            
            try {
                showNotification('Starting resync...', 'info');
                
                // Find the gas_sync_property linked to this GAS property
                const syncPropResponse = await fetch(`/api/gas-sync/properties/by-gas-property/${propertyId}`, { headers: authHeaders() });
                const syncPropData = await syncPropResponse.json();
                
                if (!syncPropData.success || !syncPropData.syncProperty) {
                    showNotification('This property is not linked to a channel manager', 'error');
                    return;
                }
                
                const syncPropertyId = syncPropData.syncProperty.id;
                const connectionId = syncPropData.syncProperty.connection_id;
                
                // Step 1: Trigger sync for the connection
                showNotification('Syncing from channel manager...', 'info');
                await fetch(`/api/gas-sync/connections/${connectionId}/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                // Step 2: Download images
                showNotification('Downloading images...', 'info');
                await fetch(`/api/gas-sync/properties/${syncPropertyId}/download-images`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                // Step 3: Re-link to update GAS property and rooms
                showNotification('Updating property and rooms...', 'info');
                const linkResponse = await fetch(`/api/gas-sync/properties/${syncPropertyId}/link-to-gas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({})
                });
                const linkData = await linkResponse.json();
                
                if (linkData.success) {
                    const stats = linkData.stats || {};
                    showNotification(` Resync complete! Rooms: ${stats.roomsCreated || 0} created, ${stats.roomsUpdated || 0} updated. Images: ${stats.imagesLinked || 0}`, 'success');
                    loadProperties();
                } else {
                    showNotification('Resync failed: ' + (linkData.error || 'Unknown error'), 'error');
                }
                
            } catch (error) {
                console.error('Resync error:', error);
                showNotification('Resync failed: ' + error.message, 'error');
            }
        }
        
        async function assignPropertyToAgency(propertyId, agencyId) {
            try {
                const response = await fetch(`/api/admin/properties/${propertyId}/assign-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ agency_id: agencyId || null })
                });
                const result = await response.json();
                if (!result.success) {
                    alert('Error: ' + result.error);
                    loadProperties();
                }
            } catch (error) {
                alert('Error assigning agency: ' + error.message);
                loadProperties();
            }
        }

        async function loadRoomsPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('rooms-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for rooms:', error);
            }
        }
        
        async function loadRoomsForProperty() {
            const propertyId = document.getElementById('rooms-property-select')?.value;
            const container = document.getElementById('rooms-list');
            
            if (!propertyId) {
                container.innerHTML = `
                    <p style="color: #64748b; text-align: center; padding: 2rem;">
                        Select a property to view rooms
                    </p>
                `;
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const html = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Room Name</th>
                                        <th>Room Type</th>
                                        <th>Type</th>
                                        <th>Capacity</th>
                                        <th>Qty</th>
                                        <th>Status</th>
                                        <th>Visible</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.map(unit => `
                                        <tr style="${unit.is_hidden ? 'opacity: 0.6;' : ''}">
                                            <td><code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${unit.id}</code></td>
                                            <td><strong>${unit.name}</strong>${unit.is_hidden ? ' <span style="color: #9ca3af; font-size: 0.8rem;">(hidden)</span>' : ''}</td>
                                            <td>${unit.room_type_name ? `<span class="badge badge-info">${unit.room_type_name}</span>` : '<span style="color: #9ca3af;">â€”</span>'}</td>
                                            <td>${unit.unit_type || 'N/A'}</td>
                                            <td>${unit.max_guests || '-'} guests</td>
                                            <td>${unit.quantity || 1}</td>
                                            <td>
                                                <span class="badge ${(unit.status === 'available' || unit.status === 'active') ? 'badge-success' : unit.status === 'maintenance' ? 'badge-warning' : 'badge-secondary'}">
                                                    ${(unit.status === 'available' || unit.status === 'active') ? '' : unit.status === 'maintenance' ? '' : ''} ${unit.status || 'available'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-secondary btn-small" onclick="toggleRoomVisibility(${unit.id}, ${!unit.is_hidden})" title="${unit.is_hidden ? 'Show on calendar' : 'Hide from calendar'}">
                                                    ${unit.is_hidden ? ' Show' : ' Hide'}
                                                </button>
                                            </td>
                                            <td style="display: flex; gap: 4px;">
                                                <button class="btn btn-small" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 6px 10px;" onclick="showLitePreview(${unit.id})" title="Preview Room Page">ðŸ‘ï¸</button>
                                                <button class="btn btn-secondary btn-small" onclick="editRoom(${unit.id})">Edit</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"></div>
                            <h3>No Rooms for This Property</h3>
                            <p>Add rooms to this property or import from Beds24</p>
                            <button class="btn" onclick="openAddRoomModal()">Add Room</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
                container.innerHTML = '<p style="color: #ef4444; padding: 2rem; text-align: center;">Error loading rooms</p>';
            }
        }
        
        async function toggleRoomVisibility(roomId, hide) {
            try {
                const response = await fetch(`/api/admin/rooms/${roomId}/visibility`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_hidden: hide })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(hide ? 'Room hidden from calendar' : 'Room visible on calendar', 'success');
                    loadRoomsForProperty(); // Refresh the list
                } else {
                    showNotification('Error updating room visibility', 'error');
                }
            } catch (error) {
                console.error('Error toggling visibility:', error);
                showNotification('Error updating room visibility', 'error');
            }
        }
        
        async function loadRooms() {
            // Load property selector first
            await loadRoomsPropertySelect();
            
            // Show message to select property
            document.getElementById('rooms-list').innerHTML = `
                <p style="color: #64748b; text-align: center; padding: 2rem;">
                    Select a property to view rooms
                </p>
            `;
        }

        async function loadAmenitiesPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('amenities-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                // Reset room select
                const roomSelect = document.getElementById('amenities-room-select');
                if (roomSelect) {
                    roomSelect.innerHTML = '<option value="">Select Room...</option>';
                }
            } catch (error) {
                console.error('Error loading properties for amenities:', error);
            }
        }
        
        async function loadAmenitiesRooms() {
            const propertyId = document.getElementById('amenities-property-select')?.value;
            const roomSelect = document.getElementById('amenities-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">Select Room...</option>';
            
            // Reset room-specific amenities display
            const roomList = document.getElementById('room-amenities-list');
            const featuresList = document.getElementById('features-amenities-list');
            if (roomList) roomList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 1rem;">Select a room to load amenities</p>';
            if (featuresList) featuresList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 1rem;">Select a room to load amenities</p>';
            
            if (!propertyId) return;
            
            // Load property-level terms
            await loadPropertyTerms(propertyId);
            
            // Load bedrooms and bathrooms for this property
            if (typeof loadBedrooms === 'function') await loadBedrooms(propertyId);
            if (typeof loadBathrooms === 'function') await loadBathrooms(propertyId);
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadAmenitiesForRoom() {
            const roomId = document.getElementById('amenities-room-select')?.value;
            
            // Get tab containers
            const roomList = document.getElementById('room-amenities-list');
            const bathroomList = document.getElementById('bathroom-amenities-list');
            const featuresList = document.getElementById('features-amenities-list');
            
            if (!roomId) {
                if (roomList) roomList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 1rem;">Select a room to load amenities</p>';
                if (bathroomList) bathroomList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 1rem;">Select a room to load amenities</p>';
                if (featuresList) featuresList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 1rem;">Select a room to load amenities</p>';
                return;
            }
            
            try {
                // Get all master amenities
                const allAmenitiesResp = await fetch('/api/admin/amenities');
                const allAmenitiesData = await allAmenitiesResp.json();
                
                // Get this room's current amenities
                const roomAmenitiesResp = await fetch(`/api/admin/units/${roomId}/amenities`);
                const roomAmenitiesData = await roomAmenitiesResp.json();
                
                if (allAmenitiesData.success) {
                    const allAmenities = allAmenitiesData.amenities || [];
                    
                    // Get selected amenity IDs
                    const selectedIds = new Set();
                    if (roomAmenitiesData.success && roomAmenitiesData.data) {
                        roomAmenitiesData.data.forEach(a => selectedIds.add(a.amenity_id));
                    }
                    
                    // Define which categories go in which tab
                    const roomCategories = ['beds', 'essentials', 'laundry'];
                    const bathroomCategories = ['bathrooms'];
                    const featureCategories = ['entertainment', 'kitchen', 'wellness', 'work', 'safety', 'outdoor', 'parking', 'family', 'other'];
                    
                    // Group amenities by category
                    const categorizedAmenities = {};
                    allAmenities.forEach(a => {
                        const cat = a.category || 'other';
                        if (!categorizedAmenities[cat]) categorizedAmenities[cat] = [];
                        categorizedAmenities[cat].push(a);
                    });
                    
                    // Render function for amenity checkboxes
                    const renderAmenityGrid = (categories, container) => {
                        let html = '';
                        categories.forEach(cat => {
                            const items = categorizedAmenities[cat] || [];
                            if (items.length === 0) return;
                            
                            // Sort: selected first
                            items.sort((a, b) => {
                                const aSelected = selectedIds.has(a.id);
                                const bSelected = selectedIds.has(b.id);
                                if (aSelected && !bSelected) return -1;
                                if (!aSelected && bSelected) return 1;
                                return (a.display_order || 0) - (b.display_order || 0);
                            });
                            
                            const categoryNames = {
                                'beds': ' Beds & Linens',
                                'bathrooms': ' Facilities',
                                'essentials': ' Essentials',
                                'kitchen': ' Kitchen & Refreshments',
                                'entertainment': ' Entertainment',
                                'wellness': ' Wellness',
                                'parking': ' Parking',
                                'outdoor': ' Outdoor',
                                'family': ' Family',
                                'work': ' Work',
                                'safety': ' Safety',
                                'laundry': ' Laundry',
                                'other': ' Other'
                            };
                            
                            html += `
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0; color: #64748b;">${categoryNames[cat] || cat}</h4>
                                        <span style="font-size: 0.8rem; color: #64748b;">${items.filter(a => selectedIds.has(a.id)).length}/${items.length}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                                        ${items.map(a => {
                                            const name = typeof a.amenity_name === 'string' ? 
                                                (a.amenity_name.startsWith('{') ? JSON.parse(a.amenity_name).en : a.amenity_name) :
                                                a.amenity_name?.en || a.amenity_code;
                                            const isSelected = selectedIds.has(a.id);
                                            return `
                                                <label style="display: flex; align-items: center; gap: 0.5rem; background: ${isSelected ? '#dcfce7' : 'var(--bg-secondary)'}; border: 1px solid ${isSelected ? '#10b981' : 'var(--border)'}; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                                    <input type="checkbox" class="room-amenity-checkbox" value="${a.id}" ${isSelected ? 'checked' : ''} style="width: 16px; height: 16px; cursor: pointer;">
                                                    <span>${a.icon || ''} ${name}</span>
                                                </label>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        });
                        
                        if (html === '') {
                            html = '<p style="color: #64748b; text-align: center; padding: 1rem;">No amenities in this category</p>';
                        }
                        
                        if (container) container.innerHTML = html;
                    };
                    
                    // Render each tab
                    renderAmenityGrid(roomCategories, roomList);
                    renderAmenityGrid(bathroomCategories, bathroomList);
                    renderAmenityGrid(featureCategories, featuresList);
                    
                } else {
                    const emptyMsg = '<p style="color: #64748b; text-align: center; padding: 1rem;">No amenities available</p>';
                    if (roomList) roomList.innerHTML = emptyMsg;
                    if (bathroomList) bathroomList.innerHTML = emptyMsg;
                    if (featuresList) featuresList.innerHTML = emptyMsg;
                }
                
                // Load unit data for num_bedrooms and num_bathrooms
                try {
                    const unitResp = await fetch(`/api/admin/units/${roomId}`);
                    const unitData = await unitResp.json();
                    if (unitData.success && unitData.data) {
                        const numBedroomsInput = document.getElementById('unit-num-bedrooms');
                        const numBathroomsInput = document.getElementById('unit-num-bathrooms');
                        if (numBedroomsInput) numBedroomsInput.value = unitData.data.num_bedrooms || 1;
                        if (numBathroomsInput) numBathroomsInput.value = unitData.data.num_bathrooms || 1;
                    }
                } catch (e) {
                    console.log('Error loading unit data:', e);
                }
                
                // Load bedrooms and bathrooms for this specific room
                const propertyId = document.getElementById('amenities-property-select')?.value;
                if (propertyId) {
                    if (typeof loadBedrooms === 'function') await loadBedrooms(propertyId, roomId);
                    if (typeof loadBathrooms === 'function') await loadBathrooms(propertyId, roomId);
                }
            } catch (error) {
                console.error('Error loading amenities:', error);
                const errorMsg = '<p style="color: #ef4444; text-align: center; padding: 1rem;">Error loading amenities</p>';
                if (roomList) roomList.innerHTML = errorMsg;
                if (bathroomList) bathroomList.innerHTML = errorMsg;
                if (featuresList) featuresList.innerHTML = errorMsg;
            }
        }
        
        // Amenities Tab Switching
        function switchAmenityTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('#amenities-tabs .filter-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.amenityTab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // Show/hide tab panels
            document.querySelectorAll('.amenity-tab-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const activePanel = document.getElementById(`amenities-tab-${tabName}`);
            if (activePanel) {
                activePanel.style.display = 'block';
            }
        }
        
        // Bed Configuration
        function addBedRow() {
            const container = document.getElementById('bed-configuration');
            const newRow = document.createElement('div');
            newRow.className = 'bed-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 1rem; align-items: center; margin-bottom: 0.75rem;';
            newRow.innerHTML = `
                <select class="form-input bed-type-select">
                    <option value="">Select bed type...</option>
                    <option value="king">King Bed</option>
                    <option value="queen">Queen Bed</option>
                    <option value="double">Double Bed</option>
                    <option value="single">Single Bed</option>
                    <option value="twin">Twin Beds</option>
                    <option value="sofa">Sofa Bed</option>
                    <option value="bunk">Bunk Bed</option>
                    <option value="cot">Cot/Crib</option>
                </select>
                <input type="number" class="form-input bed-qty" min="1" max="10" value="1" style="width: 80px;">
                <button class="btn btn-secondary btn-small" onclick="removeBedRow(this)" style="color: #ef4444;"></button>
            `;
            container.appendChild(newRow);
        }
        
        function removeBedRow(btn) {
            const row = btn.closest('.bed-row');
            const container = document.getElementById('bed-configuration');
            // Keep at least one row
            if (container.querySelectorAll('.bed-row').length > 1) {
                row.remove();
            } else {
                // Reset the row instead of removing
                row.querySelector('.bed-type-select').value = '';
                row.querySelector('.bed-qty').value = '1';
            }
        }
        
        function addBathroomRow() {
            const container = document.getElementById('bathroom-configuration');
            const newRow = document.createElement('div');
            newRow.className = 'bathroom-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 1rem; align-items: center; margin-bottom: 0.75rem;';
            newRow.innerHTML = `
                <select class="form-input bathroom-type-select">
                    <option value="">Select bathroom type...</option>
                    <option value="full-ensuite">Full Ensuite (Private, in room)</option>
                    <option value="half-ensuite">Half Bath Ensuite (Toilet & Sink only)</option>
                    <option value="full-adjacent">Full Adjacent (Private, outside room)</option>
                    <option value="full-shared">Full Shared Bathroom</option>
                    <option value="half-shared">Half Shared (Toilet & Sink only)</option>
                    <option value="outdoor-shower">Outdoor Shower</option>
                </select>
                <input type="number" class="form-input bathroom-qty" min="1" max="10" value="1" style="width: 80px;">
                <button class="btn btn-secondary btn-small" onclick="removeBathroomRow(this)" style="color: #ef4444;"></button>
            `;
            container.appendChild(newRow);
        }
        
        function removeBathroomRow(btn) {
            const row = btn.closest('.bathroom-row');
            const container = document.getElementById('bathroom-configuration');
            // Keep at least one row
            if (container.querySelectorAll('.bathroom-row').length > 1) {
                row.remove();
            } else {
                // Reset the row instead of removing
                row.querySelector('.bathroom-type-select').value = '';
                row.querySelector('.bathroom-qty').value = '1';
            }
        }
        
        // Pet policy toggle
        document.addEventListener('change', function(e) {
            if (e.target.name === 'pet-policy') {
                const petDetails = document.getElementById('pet-details');
                if (petDetails) {
                    petDetails.style.display = (e.target.value === 'yes' || e.target.value === 'request') ? 'block' : 'none';
                }
            }
        });
        
        // =========================================================
        // NEW BEDROOM MODAL FUNCTIONS
        // =========================================================
        
        let currentPropertyIdForBedrooms = null;
        let currentRoomIdForBedrooms = null;
        let bedroomsData = [];
        let bathroomsData = [];
        
        function openBedroomModal(bedroomId = null) {
            const modal = document.getElementById('bedroom-modal');
            modal.classList.add('active');
            
            // Reset form
            document.getElementById('bedroom-edit-id').value = bedroomId || '';
            document.getElementById('bedroom-name').value = '';
            document.getElementById('bedroom-has-ensuite').checked = false;
            document.getElementById('bedroom-ensuite-bathroom').value = '';
            document.getElementById('bedroom-description').value = '';
            document.getElementById('ensuite-link-section').style.display = 'none';
            
            // Reset bed config to one empty row
            const bedsContainer = document.getElementById('bedroom-beds-config');
            bedsContainer.innerHTML = `
                <div class="bed-config-row" style="display: grid; grid-template-columns: 1fr auto auto; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                    <select class="form-input bed-type-modal">
                        <option value="">Select bed type...</option>
                        <option value="king">King Bed</option>
                        <option value="super-king">Super King Bed</option>
                        <option value="queen">Queen Bed</option>
                        <option value="double">Double Bed</option>
                        <option value="single">Single/Twin Bed</option>
                        <option value="sofa-bed">Sofa Bed</option>
                        <option value="bunk">Bunk Bed</option>
                        <option value="murphy">Murphy Bed</option>
                        <option value="daybed">Daybed</option>
                        <option value="trundle">Trundle Bed</option>
                        <option value="cot">Cot/Crib</option>
                        <option value="toddler">Toddler Bed</option>
                        <option value="air-mattress">Air Mattress</option>
                        <option value="futon">Futon</option>
                        <option value="floor-mattress">Floor Mattress</option>
                    </select>
                    <input type="number" class="form-input bed-qty-modal" min="1" max="10" value="1" style="width: 60px;">
                    <button type="button" onclick="removeBedroomBedRow(this)" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;">ðŸ—‘ï¸</button>
                </div>
            `;
            
            // Populate ensuite bathroom dropdown
            populateEnsuiteBathroomDropdown();
            
            // If editing, load existing data
            if (bedroomId) {
                document.getElementById('bedroom-modal-title').textContent = 'ðŸ›ï¸ Edit Bedroom';
                const bedroom = bedroomsData.find(b => b.id == bedroomId);
                if (bedroom) {
                    document.getElementById('bedroom-name').value = bedroom.name || '';
                    document.getElementById('bedroom-has-ensuite').checked = bedroom.has_ensuite || false;
                    document.getElementById('bedroom-ensuite-bathroom').value = bedroom.ensuite_bathroom_id || '';
                    document.getElementById('bedroom-description').value = bedroom.description || '';
                    
                    if (bedroom.has_ensuite) {
                        document.getElementById('ensuite-link-section').style.display = 'block';
                    }
                    
                    // Load bed config
                    const bedConfig = typeof bedroom.bed_config === 'string' ? JSON.parse(bedroom.bed_config) : (bedroom.bed_config || []);
                    if (bedConfig.length > 0) {
                        bedsContainer.innerHTML = '';
                        bedConfig.forEach(bed => {
                            addBedroomBedRow(bed.type, bed.qty || bed.quantity || 1);
                        });
                    }
                }
            } else {
                document.getElementById('bedroom-modal-title').textContent = 'ðŸ›ï¸ Add Bedroom';
            }
            
            // Toggle ensuite section visibility
            document.getElementById('bedroom-has-ensuite').addEventListener('change', function() {
                document.getElementById('ensuite-link-section').style.display = this.checked ? 'block' : 'none';
            });
        }
        
        function closeBedroomModal() {
            document.getElementById('bedroom-modal').classList.remove('active');
        }
        
        function addBedroomBedRow(type = '', qty = 1) {
            const container = document.getElementById('bedroom-beds-config');
            const row = document.createElement('div');
            row.className = 'bed-config-row';
            row.style.cssText = 'display: grid; grid-template-columns: 1fr auto auto; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;';
            row.innerHTML = `
                <select class="form-input bed-type-modal">
                    <option value="">Select bed type...</option>
                    <option value="king" ${type === 'king' ? 'selected' : ''}>King Bed</option>
                    <option value="super-king" ${type === 'super-king' ? 'selected' : ''}>Super King Bed</option>
                    <option value="queen" ${type === 'queen' ? 'selected' : ''}>Queen Bed</option>
                    <option value="double" ${type === 'double' ? 'selected' : ''}>Double Bed</option>
                    <option value="single" ${type === 'single' ? 'selected' : ''}>Single/Twin Bed</option>
                    <option value="sofa-bed" ${type === 'sofa-bed' ? 'selected' : ''}>Sofa Bed</option>
                    <option value="bunk" ${type === 'bunk' ? 'selected' : ''}>Bunk Bed</option>
                    <option value="murphy" ${type === 'murphy' ? 'selected' : ''}>Murphy Bed</option>
                    <option value="daybed" ${type === 'daybed' ? 'selected' : ''}>Daybed</option>
                    <option value="trundle" ${type === 'trundle' ? 'selected' : ''}>Trundle Bed</option>
                    <option value="cot" ${type === 'cot' ? 'selected' : ''}>Cot/Crib</option>
                    <option value="toddler" ${type === 'toddler' ? 'selected' : ''}>Toddler Bed</option>
                    <option value="air-mattress" ${type === 'air-mattress' ? 'selected' : ''}>Air Mattress</option>
                    <option value="futon" ${type === 'futon' ? 'selected' : ''}>Futon</option>
                    <option value="floor-mattress" ${type === 'floor-mattress' ? 'selected' : ''}>Floor Mattress</option>
                </select>
                <input type="number" class="form-input bed-qty-modal" min="1" max="10" value="${qty}" style="width: 60px;">
                <button type="button" onclick="removeBedroomBedRow(this)" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;">ðŸ—‘ï¸</button>
            `;
            container.appendChild(row);
        }
        
        function removeBedroomBedRow(btn) {
            const row = btn.closest('.bed-config-row');
            const container = document.getElementById('bedroom-beds-config');
            if (container.querySelectorAll('.bed-config-row').length > 1) {
                row.remove();
            }
        }
        
        function populateEnsuiteBathroomDropdown() {
            const select = document.getElementById('bedroom-ensuite-bathroom');
            select.innerHTML = '<option value="">Select ensuite bathroom...</option>';
            bathroomsData.filter(b => !b.linked_bedroom_id).forEach(bath => {
                select.innerHTML += `<option value="${bath.id}">${bath.name || bath.bathroom_type}</option>`;
            });
        }
        
        async function saveBedroom() {
            const editId = document.getElementById('bedroom-edit-id').value;
            const name = document.getElementById('bedroom-name').value.trim();
            
            if (!name) {
                alert('Please enter a bedroom name');
                return;
            }
            
            // Collect bed config
            const bedConfig = [];
            document.querySelectorAll('#bedroom-beds-config .bed-config-row').forEach(row => {
                const type = row.querySelector('.bed-type-modal').value;
                const qty = parseInt(row.querySelector('.bed-qty-modal').value) || 1;
                if (type) {
                    bedConfig.push({ type, qty });
                }
            });
            
            const data = {
                name,
                bed_config: bedConfig,
                has_ensuite: document.getElementById('bedroom-has-ensuite').checked,
                ensuite_bathroom_id: document.getElementById('bedroom-ensuite-bathroom').value || null,
                description: document.getElementById('bedroom-description').value.trim(),
                room_id: currentRoomIdForBedrooms
            };
            
            try {
                let response;
                if (editId) {
                    response = await fetch(`/api/admin/bedrooms/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`/api/admin/properties/${currentPropertyIdForBedrooms}/bedrooms`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                }
                
                const result = await response.json();
                if (result.success) {
                    closeBedroomModal();
                    loadBedrooms(currentPropertyIdForBedrooms, currentRoomIdForBedrooms);
                } else {
                    alert('Error: ' + (result.error || 'Failed to save bedroom'));
                }
            } catch (error) {
                console.error('Error saving bedroom:', error);
                alert('Error saving bedroom');
            }
        }
        
        async function loadBedrooms(propertyId, roomId = null) {
            currentPropertyIdForBedrooms = propertyId;
            currentRoomIdForBedrooms = roomId;
            
            try {
                const url = roomId 
                    ? `/api/admin/properties/${propertyId}/bedrooms?room_id=${roomId}`
                    : `/api/admin/properties/${propertyId}/bedrooms`;
                    
                const response = await fetch(url, { headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    bedroomsData = result.bedrooms || [];
                    renderBedroomsList(bedroomsData);
                    
                    // Load bedroom amenities checkboxes
                    const amenities = result.bedroom_amenities || {};
                    Object.keys(amenities).forEach(key => {
                        const checkbox = document.getElementById(`bedroom-${key}`);
                        if (checkbox) checkbox.checked = amenities[key];
                    });
                }
            } catch (error) {
                console.error('Error loading bedrooms:', error);
            }
        }
        
        function renderBedroomsList(bedrooms) {
            const container = document.getElementById('bedrooms-list');
            
            if (!bedrooms || bedrooms.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No bedrooms configured yet. Click "Add Bedroom" to get started.</p>';
                return;
            }
            
            container.innerHTML = bedrooms.map(bedroom => {
                let bedConfig = typeof bedroom.bed_config === 'string' ? JSON.parse(bedroom.bed_config) : (bedroom.bed_config || []);
                
                // Handle both formats: {beds: [...]} and flat array [...]
                if (bedConfig && bedConfig.beds && Array.isArray(bedConfig.beds)) {
                    bedConfig = bedConfig.beds;
                }
                if (!Array.isArray(bedConfig)) {
                    bedConfig = [];
                }
                
                const bedSummary = bedConfig.map(b => {
                    const bedNames = {
                        'king': 'King', 'super-king': 'Super King', 'queen': 'Queen', 'double': 'Double',
                        'single': 'Single', 'sofa-bed': 'Sofa Bed', 'sofa-bed-single': 'Sofa Bed (Single)', 
                        'bunk': 'Bunk', 'murphy': 'Murphy', 'daybed': 'Daybed', 'trundle': 'Trundle', 
                        'cot': 'Cot', 'toddler': 'Toddler', 'air-mattress': 'Air Mattress', 
                        'futon': 'Futon', 'floor-mattress': 'Floor Mattress',
                        // Also handle bed_ prefix versions
                        'bed_king': 'King', 'bed_queen': 'Queen', 'bed_double': 'Double', 
                        'bed_single': 'Single', 'bed_sofa_double': 'Sofa Bed', 'bed_sofa_single': 'Sofa Bed (Single)',
                        'bed_bunk': 'Bunk', 'bed_cot': 'Cot', 'bed_futon': 'Futon'
                    };
                    const qty = b.qty || b.count || 1;
                    const typeName = bedNames[b.type] || b.type;
                    return `${qty}Ã— ${typeName}`;
                }).join(', ') || 'No beds configured';
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div>
                            <strong style="font-size: 1rem;">${bedroom.name}</strong>
                            ${bedroom.has_ensuite ? '<span style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Ensuite</span>' : ''}
                            <div style="color: #64748b; font-size: 0.85rem; margin-top: 0.25rem;">ðŸ›ï¸ ${bedSummary}</div>
                            ${bedroom.description ? `<div style="color: #64748b; font-size: 0.8rem; margin-top: 0.25rem; font-style: italic;">${bedroom.description}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-small" onclick="openBedroomModal(${bedroom.id})">Edit</button>
                            <button class="btn btn-secondary btn-small" onclick="deleteBedroom(${bedroom.id})" style="color: #ef4444;">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function deleteBedroom(bedroomId) {
            if (!confirm('Are you sure you want to delete this bedroom?')) return;
            
            try {
                const response = await fetch(`/api/admin/bedrooms/${bedroomId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                const result = await response.json();
                if (result.success) {
                    loadBedrooms(currentPropertyIdForBedrooms, currentRoomIdForBedrooms);
                }
            } catch (error) {
                console.error('Error deleting bedroom:', error);
            }
        }
        
        // =========================================================
        // NEW BATHROOM MODAL FUNCTIONS
        // =========================================================
        
        function openBathroomModal(bathroomId = null) {
            const modal = document.getElementById('bathroom-modal');
            modal.classList.add('active');
            
            // Reset form
            document.getElementById('bathroom-edit-id').value = bathroomId || '';
            document.getElementById('bathroom-name').value = '';
            document.getElementById('bathroom-location').value = '';
            document.getElementById('bathroom-type').value = '';
            document.getElementById('bathroom-is-ensuite').checked = false;
            document.getElementById('bathroom-linked-bedroom').value = '';
            document.getElementById('bathroom-description').value = '';
            document.getElementById('ensuite-bedroom-link-section').style.display = 'none';
            
            // Reset feature checkboxes
            ['shower', 'bathtub', 'rainfall', 'walkin', 'jacuzzi', 'bidet', 'heated-floor', 'double-vanity', 'accessible'].forEach(feat => {
                const cb = document.getElementById(`bath-feat-${feat}`);
                if (cb) cb.checked = false;
            });
            
            // Populate bedroom dropdown
            populateLinkedBedroomDropdown();
            
            // If editing, load existing data
            if (bathroomId) {
                document.getElementById('bathroom-modal-title').textContent = 'ðŸš¿ Edit Bathroom';
                const bathroom = bathroomsData.find(b => b.id == bathroomId);
                if (bathroom) {
                    document.getElementById('bathroom-name').value = bathroom.name || '';
                    document.getElementById('bathroom-location').value = bathroom.location || '';
                    document.getElementById('bathroom-type').value = bathroom.bathroom_type || '';
                    document.getElementById('bathroom-is-ensuite').checked = bathroom.is_ensuite || false;
                    document.getElementById('bathroom-linked-bedroom').value = bathroom.linked_bedroom_id || '';
                    document.getElementById('bathroom-description').value = bathroom.description || '';
                    
                    if (bathroom.is_ensuite) {
                        document.getElementById('ensuite-bedroom-link-section').style.display = 'block';
                    }
                    
                    // Load features
                    const features = typeof bathroom.features === 'string' ? JSON.parse(bathroom.features) : (bathroom.features || {});
                    Object.keys(features).forEach(key => {
                        const cb = document.getElementById(`bath-feat-${key}`);
                        if (cb) cb.checked = features[key];
                    });
                }
            } else {
                document.getElementById('bathroom-modal-title').textContent = 'ðŸš¿ Add Bathroom';
            }
            
            // Toggle ensuite section visibility
            document.getElementById('bathroom-is-ensuite').addEventListener('change', function() {
                document.getElementById('ensuite-bedroom-link-section').style.display = this.checked ? 'block' : 'none';
            });
        }
        
        function closeBathroomModal() {
            document.getElementById('bathroom-modal').classList.remove('active');
        }
        
        function populateLinkedBedroomDropdown() {
            const select = document.getElementById('bathroom-linked-bedroom');
            select.innerHTML = '<option value="">Select bedroom...</option>';
            bedroomsData.forEach(bedroom => {
                select.innerHTML += `<option value="${bedroom.id}">${bedroom.name}</option>`;
            });
        }
        
        async function saveBathroom() {
            const editId = document.getElementById('bathroom-edit-id').value;
            const name = document.getElementById('bathroom-name').value.trim();
            const bathroomType = document.getElementById('bathroom-type').value;
            
            if (!name) {
                alert('Please enter a bathroom name');
                return;
            }
            if (!bathroomType) {
                alert('Please select a bathroom type');
                return;
            }
            
            // Collect features
            const features = {};
            ['shower', 'bathtub', 'rainfall', 'walkin', 'jacuzzi', 'bidet', 'heated-floor', 'double-vanity', 'accessible'].forEach(feat => {
                const cb = document.getElementById(`bath-feat-${feat}`);
                if (cb) features[feat] = cb.checked;
            });
            
            const data = {
                name,
                bathroom_type: bathroomType,
                location: document.getElementById('bathroom-location').value.trim(),
                is_ensuite: document.getElementById('bathroom-is-ensuite').checked,
                linked_bedroom_id: document.getElementById('bathroom-linked-bedroom').value || null,
                features,
                description: document.getElementById('bathroom-description').value.trim(),
                quantity: 1,
                room_id: currentRoomIdForBedrooms
            };
            
            try {
                let response;
                if (editId) {
                    response = await fetch(`/api/admin/bathrooms/${editId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`/api/admin/properties/${currentPropertyIdForBedrooms}/bathrooms-detailed`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                }
                
                const result = await response.json();
                if (result.success) {
                    closeBathroomModal();
                    loadBathrooms(currentPropertyIdForBedrooms, currentRoomIdForBedrooms);
                } else {
                    alert('Error: ' + (result.error || 'Failed to save bathroom'));
                }
            } catch (error) {
                console.error('Error saving bathroom:', error);
                alert('Error saving bathroom');
            }
        }
        
        async function loadBathrooms(propertyId, roomId = null) {
            try {
                const url = roomId 
                    ? `/api/admin/properties/${propertyId}/bathrooms-detailed?room_id=${roomId}`
                    : `/api/admin/properties/${propertyId}/bathrooms-detailed`;
                    
                const response = await fetch(url, { headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    bathroomsData = result.bathrooms || [];
                    renderBathroomsList(bathroomsData);
                    
                    // Load bathroom amenities checkboxes
                    const amenities = result.bathroom_amenities || {};
                    Object.keys(amenities).forEach(key => {
                        const checkbox = document.getElementById(`bath-${key}`);
                        if (checkbox) checkbox.checked = amenities[key];
                    });
                }
            } catch (error) {
                console.error('Error loading bathrooms:', error);
            }
        }
        
        function renderBathroomsList(bathrooms) {
            const container = document.getElementById('bathrooms-list');
            
            if (!bathrooms || bathrooms.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No bathrooms configured yet. Click "Add Bathroom" to get started.</p>';
                return;
            }
            
            const typeNames = {
                'full-private': 'Full Private', 'full-shared': 'Full Shared',
                'half-private': 'Half Private', 'half-shared': 'Half Shared',
                'shower-room': 'Shower Room', 'wc': 'WC', 'outdoor': 'Outdoor Shower',
                'full-ensuite': 'Full Ensuite', 'half-ensuite': 'Half Ensuite',
                'full-adjacent': 'Full Adjacent'
            };
            
            container.innerHTML = bathrooms.map(bathroom => {
                const features = typeof bathroom.features === 'string' ? JSON.parse(bathroom.features) : (bathroom.features || {});
                const activeFeatures = Object.entries(features).filter(([k, v]) => v).map(([k]) => {
                    const names = { 'shower': 'Shower', 'bathtub': 'Bathtub', 'rainfall': 'Rainfall', 'walkin': 'Walk-in', 'jacuzzi': 'Jacuzzi', 'bidet': 'Bidet', 'heated-floor': 'Heated Floor', 'double-vanity': 'Double Vanity', 'accessible': 'Accessible' };
                    return names[k] || k;
                });
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div>
                            <strong style="font-size: 1rem;">${bathroom.name || typeNames[bathroom.bathroom_type] || bathroom.bathroom_type}</strong>
                            ${bathroom.is_ensuite ? '<span style="background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Ensuite</span>' : ''}
                            ${bathroom.location ? `<span style="color: #64748b; font-size: 0.85rem; margin-left: 0.5rem;">ðŸ“ ${bathroom.location}</span>` : ''}
                            <div style="color: #64748b; font-size: 0.85rem; margin-top: 0.25rem;">${typeNames[bathroom.bathroom_type] || bathroom.bathroom_type}</div>
                            ${activeFeatures.length > 0 ? `<div style="color: #64748b; font-size: 0.8rem; margin-top: 0.25rem;">âœ¨ ${activeFeatures.join(', ')}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-small" onclick="openBathroomModal(${bathroom.id})">Edit</button>
                            <button class="btn btn-secondary btn-small" onclick="deleteBathroom(${bathroom.id})" style="color: #ef4444;">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function deleteBathroom(bathroomId) {
            if (!confirm('Are you sure you want to delete this bathroom?')) return;
            
            try {
                const response = await fetch(`/api/admin/bathrooms/${bathroomId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                const result = await response.json();
                if (result.success) {
                    loadBathrooms(currentPropertyIdForBedrooms, currentRoomIdForBedrooms);
                }
            } catch (error) {
                console.error('Error deleting bathroom:', error);
            }
        }
        
        // Save all amenities (Terms & Policies)
        async function saveAllAmenities() {
            const propertyId = document.getElementById('amenities-property-select')?.value;
            const roomId = document.getElementById('amenities-room-select')?.value;
            
            if (!propertyId) {
                alert('Please select a property first');
                return;
            }
            
            // Collect bed configuration
            const beds = [];
            document.querySelectorAll('.bed-row').forEach(row => {
                const type = row.querySelector('.bed-type-select')?.value;
                const qty = row.querySelector('.bed-qty')?.value || 1;
                if (type) {
                    beds.push({ type, quantity: parseInt(qty) });
                }
            });
            
            // Collect bathroom configuration
            const bathrooms = [];
            document.querySelectorAll('.bathroom-row').forEach(row => {
                const type = row.querySelector('.bathroom-type-select')?.value;
                const qty = row.querySelector('.bathroom-qty')?.value || 1;
                if (type) {
                    bathrooms.push({ type, quantity: parseInt(qty) });
                }
            });
            
            // Collect bathroom features
            const bathroom_features = {
                shower: document.getElementById('bath-shower')?.checked || false,
                bathtub: document.getElementById('bath-bathtub')?.checked || false,
                rainfall: document.getElementById('bath-rainfall')?.checked || false,
                walkin: document.getElementById('bath-walkin')?.checked || false,
                jacuzzi: document.getElementById('bath-jacuzzi')?.checked || false,
                bidet: document.getElementById('bath-bidet')?.checked || false,
                heated_floor: document.getElementById('bath-heated-floor')?.checked || false,
                double_vanity: document.getElementById('bath-double-vanity')?.checked || false,
                hairdryer: document.getElementById('bath-hairdryer')?.checked || false,
                toiletries: document.getElementById('bath-toiletries')?.checked || false,
                towels: document.getElementById('bath-towels')?.checked || false,
                robes: document.getElementById('bath-robes')?.checked || false
            };
            
            // Collect terms & policies
            const terms = {
                checkin_from: document.getElementById('terms-checkin-from')?.value,
                checkin_until: document.getElementById('terms-checkin-until')?.value,
                checkout: document.getElementById('terms-checkout')?.value,
                late_checkout_fee: document.getElementById('terms-late-checkout-fee')?.value || null,
                self_checkin: document.getElementById('terms-self-checkin')?.checked,
                checkin_24hr: document.getElementById('terms-24hr-checkin')?.checked,
                
                smoking_policy: document.querySelector('input[name="smoking-policy"]:checked')?.value,
                smoking_fine: document.getElementById('terms-smoking-fine')?.value || null,
                
                pet_policy: document.querySelector('input[name="pet-policy"]:checked')?.value,
                pet_deposit: document.getElementById('terms-pet-deposit')?.value || null,
                pet_fee: document.getElementById('terms-pet-fee')?.value || null,
                dogs_allowed: document.getElementById('terms-dogs-allowed')?.checked,
                cats_allowed: document.getElementById('terms-cats-allowed')?.checked,
                small_pets_only: document.getElementById('terms-small-pets-only')?.checked,
                max_pets: document.getElementById('terms-max-pets')?.value,
                
                children_policy: document.querySelector('input[name="children-policy"]:checked')?.value,
                cots_available: document.getElementById('terms-cots-available')?.checked,
                highchairs_available: document.getElementById('terms-highchairs')?.checked,
                cot_fee: document.getElementById('terms-cot-fee')?.value || null,
                
                events_policy: document.querySelector('input[name="events-policy"]:checked')?.value,
                
                wheelchair_accessible: document.getElementById('access-wheelchair')?.checked,
                step_free: document.getElementById('access-step-free')?.checked,
                accessible_bathroom: document.getElementById('access-bathroom')?.checked,
                grab_rails: document.getElementById('access-grab-rails')?.checked,
                roll_in_shower: document.getElementById('access-roll-in-shower')?.checked,
                elevator_access: document.getElementById('access-elevator')?.checked,
                ground_floor: document.getElementById('access-ground-floor')?.checked,
                
                quiet_hours_from: document.getElementById('terms-quiet-from')?.value,
                quiet_hours_until: document.getElementById('terms-quiet-until')?.value,
                no_outside_guests: document.getElementById('terms-no-outside-guests')?.checked,
                id_required: document.getElementById('terms-id-required')?.checked,
                additional_rules: document.getElementById('terms-additional-rules')?.value,
                
                cancellation_policy: document.getElementById('terms-cancellation-policy')?.value || null
            };
            
            // Also save room amenities if a room is selected
            if (roomId) {
                await saveRoomAmenities();
                
                // Save num_bedrooms and num_bathrooms to the unit
                const numBedrooms = document.getElementById('unit-num-bedrooms')?.value || 1;
                const numBathrooms = document.getElementById('unit-num-bathrooms')?.value || 1;
                try {
                    await fetch(`/api/admin/units/${roomId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ num_bedrooms: parseInt(numBedrooms), num_bathrooms: parseFloat(numBathrooms) })
                    });
                } catch (e) {
                    console.log('Error saving bedrooms/bathrooms:', e);
                }
            }
            
            // Save property-level terms
            try {
                const response = await fetch(`/api/admin/properties/${propertyId}/terms`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ terms, beds, bathrooms, bathroom_features })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(' All changes saved successfully!');
                } else {
                    alert('Error saving: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving amenities:', error);
                alert('Error saving changes');
            }
        }
        
        // Load property terms when property is selected
        async function loadPropertyTerms(propertyId) {
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/admin/properties/${propertyId}/terms`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const terms = result.data.terms || {};
                    const beds = result.data.beds || [];
                    const bathrooms = result.data.bathrooms || [];
                    
                    // Populate check-in/out (using database column names)
                    if (terms.checkin_from) document.getElementById('terms-checkin-from').value = terms.checkin_from;
                    if (terms.checkin_until) document.getElementById('terms-checkin-until').value = terms.checkin_until;
                    if (terms.checkout_by) document.getElementById('terms-checkout').value = terms.checkout_by;
                    if (terms.late_checkout_fee) document.getElementById('terms-late-checkout-fee').value = terms.late_checkout_fee;
                    if (terms.self_checkin) document.getElementById('terms-self-checkin').checked = true;
                    if (terms.checkin_24hr) document.getElementById('terms-24hr-checkin').checked = true;
                    
                    // Smoking
                    if (terms.smoking_policy) {
                        const radio = document.querySelector(`input[name="smoking-policy"][value="${terms.smoking_policy}"]`);
                        if (radio) radio.checked = true;
                    }
                    if (terms.smoking_fine) document.getElementById('terms-smoking-fine').value = terms.smoking_fine;
                    
                    // Pets
                    if (terms.pet_policy) {
                        const radio = document.querySelector(`input[name="pet-policy"][value="${terms.pet_policy}"]`);
                        if (radio) radio.checked = true;
                        // Show pet details if pets allowed
                        if (terms.pet_policy === 'yes' || terms.pet_policy === 'request') {
                            document.getElementById('pet-details').style.display = 'block';
                        }
                    }
                    if (terms.pet_deposit) document.getElementById('terms-pet-deposit').value = terms.pet_deposit;
                    if (terms.pet_fee_per_night) document.getElementById('terms-pet-fee').value = terms.pet_fee_per_night;
                    if (terms.dogs_allowed) document.getElementById('terms-dogs-allowed').checked = true;
                    if (terms.cats_allowed) document.getElementById('terms-cats-allowed').checked = true;
                    if (terms.small_pets_only) document.getElementById('terms-small-pets-only').checked = true;
                    if (terms.max_pets) document.getElementById('terms-max-pets').value = terms.max_pets;
                    
                    // Children
                    if (terms.children_policy) {
                        const radio = document.querySelector(`input[name="children-policy"][value="${terms.children_policy}"]`);
                        if (radio) radio.checked = true;
                    }
                    if (terms.cots_available) document.getElementById('terms-cots-available').checked = true;
                    if (terms.highchairs_available) document.getElementById('terms-highchairs').checked = true;
                    if (terms.cot_fee_per_night) document.getElementById('terms-cot-fee').value = terms.cot_fee_per_night;
                    
                    // Events
                    if (terms.events_policy) {
                        const radio = document.querySelector(`input[name="events-policy"][value="${terms.events_policy}"]`);
                        if (radio) radio.checked = true;
                    }
                    
                    // Accessibility
                    if (terms.wheelchair_accessible) document.getElementById('access-wheelchair').checked = true;
                    if (terms.step_free_access) document.getElementById('access-step-free').checked = true;
                    if (terms.accessible_bathroom) document.getElementById('access-bathroom').checked = true;
                    if (terms.grab_rails) document.getElementById('access-grab-rails').checked = true;
                    if (terms.roll_in_shower) document.getElementById('access-roll-in-shower').checked = true;
                    if (terms.elevator_access) document.getElementById('access-elevator').checked = true;
                    if (terms.ground_floor_available) document.getElementById('access-ground-floor').checked = true;
                    
                    // House rules
                    if (terms.quiet_hours_from) document.getElementById('terms-quiet-from').value = terms.quiet_hours_from;
                    if (terms.quiet_hours_until) document.getElementById('terms-quiet-until').value = terms.quiet_hours_until;
                    if (terms.no_outside_guests) document.getElementById('terms-no-outside-guests').checked = true;
                    if (terms.id_required) document.getElementById('terms-id-required').checked = true;
                    if (terms.additional_rules) document.getElementById('terms-additional-rules').value = terms.additional_rules;
                    if (terms.cancellation_policy) document.getElementById('terms-cancellation-policy').value = terms.cancellation_policy;
                    
                    // Beds (using bed_type from database) - OLD FORMAT
                    // Only load into old UI if container exists
                    const bedContainer = document.getElementById('bed-configuration');
                    if (bedContainer && beds.length > 0) {
                        bedContainer.innerHTML = '';
                        beds.forEach((bed, index) => {
                            const bedType = bed.bed_type || bed.type; // Handle both formats
                            const row = document.createElement('div');
                            row.className = 'bed-row';
                            row.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 1rem; align-items: center; margin-bottom: 0.75rem;';
                            row.innerHTML = `
                                <select class="form-input bed-type-select">
                                    <option value="">Select bed type...</option>
                                    <option value="king" ${bedType === 'king' ? 'selected' : ''}>King Bed</option>
                                    <option value="queen" ${bedType === 'queen' ? 'selected' : ''}>Queen Bed</option>
                                    <option value="double" ${bedType === 'double' ? 'selected' : ''}>Double Bed</option>
                                    <option value="single" ${bedType === 'single' ? 'selected' : ''}>Single Bed</option>
                                    <option value="twin" ${bedType === 'twin' ? 'selected' : ''}>Twin Beds</option>
                                    <option value="sofa" ${bedType === 'sofa' ? 'selected' : ''}>Sofa Bed</option>
                                    <option value="bunk" ${bedType === 'bunk' ? 'selected' : ''}>Bunk Bed</option>
                                    <option value="cot" ${bedType === 'cot' ? 'selected' : ''}>Cot/Crib</option>
                                </select>
                                <input type="number" class="form-input bed-qty" min="1" max="10" value="${bed.quantity || 1}" style="width: 80px;">
                                <button class="btn btn-secondary btn-small" onclick="removeBedRow(this)" style="color: #ef4444;"></button>
                            `;
                            bedContainer.appendChild(row);
                        });
                    }
                    
                    // Bathrooms (using bathroom_type from database) - OLD FORMAT
                    // Only load into old UI if container exists
                    const bathroomContainer = document.getElementById('bathroom-configuration');
                    if (bathroomContainer && bathrooms.length > 0) {
                        bathroomContainer.innerHTML = '';
                        bathrooms.forEach((bathroom, index) => {
                            const bathroomType = bathroom.bathroom_type || bathroom.type;
                            const row = document.createElement('div');
                            row.className = 'bathroom-row';
                            row.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 1rem; align-items: center; margin-bottom: 0.75rem;';
                            row.innerHTML = `
                                <select class="form-input bathroom-type-select">
                                    <option value="">Select bathroom type...</option>
                                    <option value="full-ensuite" ${bathroomType === 'full-ensuite' ? 'selected' : ''}>Full Ensuite (Private, in room)</option>
                                    <option value="half-ensuite" ${bathroomType === 'half-ensuite' ? 'selected' : ''}>Half Bath Ensuite (Toilet & Sink only)</option>
                                    <option value="full-adjacent" ${bathroomType === 'full-adjacent' ? 'selected' : ''}>Full Adjacent (Private, outside room)</option>
                                    <option value="full-shared" ${bathroomType === 'full-shared' ? 'selected' : ''}>Full Shared Bathroom</option>
                                    <option value="half-shared" ${bathroomType === 'half-shared' ? 'selected' : ''}>Half Shared (Toilet & Sink only)</option>
                                    <option value="outdoor-shower" ${bathroomType === 'outdoor-shower' ? 'selected' : ''}>Outdoor Shower</option>
                                </select>
                                <input type="number" class="form-input bathroom-qty" min="1" max="10" value="${bathroom.quantity || 1}" style="width: 80px;">
                                <button class="btn btn-secondary btn-small" onclick="removeBathroomRow(this)" style="color: #ef4444;"></button>
                            `;
                            bathroomContainer.appendChild(row);
                        });
                    }
                    
                    // Bathroom features (from JSONB in property_terms)
                    const bathFeatures = terms.bathroom_features || {};
                    if (document.getElementById('bath-shower')) document.getElementById('bath-shower').checked = bathFeatures.shower || false;
                    if (document.getElementById('bath-bathtub')) document.getElementById('bath-bathtub').checked = bathFeatures.bathtub || false;
                    if (document.getElementById('bath-rainfall')) document.getElementById('bath-rainfall').checked = bathFeatures.rainfall || false;
                    if (document.getElementById('bath-walkin')) document.getElementById('bath-walkin').checked = bathFeatures.walkin || false;
                    if (document.getElementById('bath-jacuzzi')) document.getElementById('bath-jacuzzi').checked = bathFeatures.jacuzzi || false;
                    if (document.getElementById('bath-bidet')) document.getElementById('bath-bidet').checked = bathFeatures.bidet || false;
                    if (document.getElementById('bath-heated-floor')) document.getElementById('bath-heated-floor').checked = bathFeatures.heated_floor || false;
                    if (document.getElementById('bath-double-vanity')) document.getElementById('bath-double-vanity').checked = bathFeatures.double_vanity || false;
                    if (document.getElementById('bath-hairdryer')) document.getElementById('bath-hairdryer').checked = bathFeatures.hairdryer || false;
                    if (document.getElementById('bath-toiletries')) document.getElementById('bath-toiletries').checked = bathFeatures.toiletries || false;
                    if (document.getElementById('bath-towels')) document.getElementById('bath-towels').checked = bathFeatures.towels || false;
                    if (document.getElementById('bath-robes')) document.getElementById('bath-robes').checked = bathFeatures.robes || false;
                }
            } catch (error) {
                console.error('Error loading property terms:', error);
            }
        }
        
        async function saveRoomAmenities() {
            const roomId = document.getElementById('amenities-room-select')?.value;
            if (!roomId) {
                alert('Please select a room first');
                return;
            }
            
            // Get selected amenities
            const selectedAmenities = [];
            document.querySelectorAll('.room-amenity-checkbox:checked').forEach(checkbox => {
                selectedAmenities.push(checkbox.value);
            });
            
            try {
                const response = await fetch(`/api/admin/units/${roomId}/amenities`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ amenities: selectedAmenities })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(' Amenities saved successfully!');
                    loadAmenitiesForRoom(); // Refresh to update counts
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving amenities:', error);
                alert('Error saving amenities');
            }
        }
        
        async function loadAmenities() {
            // Load property selector first
            await loadAmenitiesPropertySelect();
            
            // Show message to select property/room
            document.getElementById('amenities-list').innerHTML = `
                <p style="color: #64748b; text-align: center; padding: 2rem;">
                    Select a property and room to manage amenities
                </p>
            `;
        }
        
        async function deleteAmenity(id) {
            if (!confirm('Delete this amenity? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/amenities/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Amenity deleted successfully!');
                    loadAmenitiesForRoom();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting amenity:', error);
                alert('Error deleting amenity');
            }
        }

        // Images functions

        // =========================================================
        // IMAGE MANAGEMENT FUNCTIONS
        // =========================================================
        
        let selectedFiles = [];
        let currentFilter = 'all';
        let allImages = [];

        async function loadImagesPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('images-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for images:', error);
            }
        }
        
        async function loadImagesRooms() {
            const propertyId = document.getElementById('images-property-select')?.value;
            const roomSelect = document.getElementById('images-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">All Rooms</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadImagesForProperty() {
            const propertyId = document.getElementById('images-property-select')?.value;
            const roomId = document.getElementById('images-room-select')?.value;
            
            // Also load rooms when property changes
            if (!roomId) {
                await loadImagesRooms();
            }
            
            if (!propertyId) {
                document.getElementById('images-stats').style.display = 'none';
                document.getElementById('images-filter-tabs').style.display = 'none';
                document.getElementById('images-gallery').innerHTML = `
                    <p style="color: #64748b; text-align: center; padding: 2rem;">
                        Select a property to view and manage images
                    </p>
                `;
                return;
            }
            
            // Show stats and filter tabs
            document.getElementById('images-stats').style.display = 'grid';
            document.getElementById('images-filter-tabs').style.display = 'flex';
            
            try {
                allImages = [];
                let propertyCount = 0;
                let roomCount = 0;
                let locationCount = 0;
                
                // Load property images
                try {
                    const imgResp = await fetch(`/api/admin/properties/${propertyId}/images`);
                    if (imgResp.ok) {
                        const imgData = await imgResp.json();
                        if (imgData.success && imgData.images) {
                            const propSelect = document.getElementById('images-property-select');
                            const propName = propSelect.options[propSelect.selectedIndex]?.text || 'Property';
                            imgData.images.forEach(img => {
                                allImages.push({
                                    ...img,
                                    type: 'property',
                                    entityId: propertyId,
                                    entityName: propName
                                });
                            });
                            propertyCount = imgData.images.length;
                        }
                    }
                } catch (e) {
                    console.log('Error loading property images:', e.message);
                }
                
                // Load room images (either specific room or all rooms for property)
                let rooms = [];
                if (roomId) {
                    const roomSelect = document.getElementById('images-room-select');
                    rooms = [{ id: roomId, name: roomSelect.options[roomSelect.selectedIndex]?.text || 'Room' }];
                } else {
                    try {
                        const roomsResp = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                        if (roomsResp.ok) {
                            const roomsData = await roomsResp.json();
                            rooms = roomsData.data || [];
                        }
                    } catch (e) {
                        console.log('No rooms found:', e.message);
                    }
                }
                
                for (const room of rooms) {
                    try {
                        const imgResp = await fetch(`/api/admin/rooms/${room.id}/images`);
                        if (imgResp.ok) {
                            const imgData = await imgResp.json();
                            if (imgData.success && imgData.images) {
                                imgData.images.forEach(img => {
                                    allImages.push({
                                        ...img,
                                        type: 'room',
                                        entityId: room.id,
                                        entityName: room.name
                                    });
                                });
                                roomCount += imgData.images.length;
                            }
                        }
                    } catch (e) {
                        console.log(`Error loading images for room ${room.id}:`, e.message);
                    }
                }

                // Update counters
                document.getElementById('property-image-count').textContent = propertyCount;
                document.getElementById('room-image-count').textContent = roomCount;
                document.getElementById('location-image-count').textContent = locationCount;
                document.getElementById('total-image-count').textContent = propertyCount + roomCount + locationCount;

                // Display gallery
                displayImages();
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }
        
        async function loadImages() {
            // Load property selector first
            await loadImagesPropertySelect();
            
            // Hide stats and filter tabs until property selected
            document.getElementById('images-stats').style.display = 'none';
            document.getElementById('images-filter-tabs').style.display = 'none';
            
            // Show message to select property
            document.getElementById('images-gallery').innerHTML = `
                <p style="color: #64748b; text-align: center; padding: 2rem;">
                    Select a property to view and manage images
                </p>
            `;
        }

        function filterImages(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.filter === filter) {
                    tab.classList.add('active');
                }
            });

            displayImages();
        }

        function displayImages() {
            const gallery = document.getElementById('images-gallery');
            const propertyId = document.getElementById('images-property-select')?.value;
            
            if (!propertyId) {
                gallery.innerHTML = `
                    <p style="color: #64748b; text-align: center; padding: 2rem;">
                        Select a property to view and manage images
                    </p>
                `;
                return;
            }
            
            let filteredImages = allImages;
            if (currentFilter !== 'all') {
                if (currentFilter === 'rooms') {
                    filteredImages = allImages.filter(img => img.type === 'room');
                } else {
                    filteredImages = allImages.filter(img => img.type === currentFilter);
                }
            }

            if (filteredImages.length === 0) {
                gallery.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>No Images for This Property</h3>
                        <p>Upload images to showcase this property</p>
                        <button class="btn" onclick="openImageUploadModal()">Upload Images</button>
                    </div>
                `;
                return;
            }

            // Group images by entity (room or property)
            const groupedImages = {};
            filteredImages.forEach(img => {
                const key = `${img.type}-${img.entityId}`;
                if (!groupedImages[key]) {
                    groupedImages[key] = {
                        type: img.type,
                        entityId: img.entityId,
                        entityName: img.entityName,
                        images: []
                    };
                }
                groupedImages[key].images.push(img);
            });

            // Sort images within each group by display_order
            Object.values(groupedImages).forEach(group => {
                group.images.sort((a, b) => a.display_order - b.display_order);
            });

            let html = '';
            
            Object.values(groupedImages).forEach(group => {
                const icon = group.type === 'room' ? '' : (group.type === 'property' ? '' : '');
                
                html += `
                    <div class="room-image-section" style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border);">
                            ${icon} ${group.entityName}
                            <span style="font-size: 0.85rem; color: #64748b; font-weight: normal; margin-left: 0.5rem;">
                                (${group.images.length} image${group.images.length !== 1 ? 's' : ''})
                            </span>
                        </h3>
                        <div class="image-gallery">
                            ${group.images.map((img, idx) => {
                                const isFirst = idx === 0;
                                const isLast = idx === group.images.length - 1;
                                
                                return `
                                <div class="image-card" draggable="true" data-id="${img.id}" data-image-id="${img.id}" data-type="${img.type}" data-entity="${img.entityId}" data-order="${idx}"
                                     ondragstart="handleImageDragStart(event)" ondragend="handleImageDragEnd(event)" 
                                     ondragover="handleImageDragOver(event)" ondragleave="handleImageDragLeave(event)" ondrop="handleImageDrop(event)">
                                    <img src="${img.thumbnail_url || img.image_url}" alt="${img.alt_text || ''}" loading="lazy">
                                    <div class="image-card-info">
                                        <div class="image-tags">
                                            ${img.is_primary ? '<span class="image-tag" style="background: gold; color: #000;">â­ Primary</span>' : ''}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">
                                            ${img.width && img.height ? `${img.width} Ã— ${img.height} px Â· ` : ""}Order: ${idx + 1}
                                        </div>
                                        <div class="image-actions" style="display: flex; gap: 4px; flex-wrap: wrap; justify-content: center;">
                                            <button class="btn btn-small" onclick="moveImage('${img.type}', ${img.entityId}, ${img.id}, -1)" ${isFirst ? 'disabled style="opacity:0.3"' : ''} title="Move Left">â—€ï¸</button>
                                            <button class="btn btn-small" onclick="moveImage('${img.type}', ${img.entityId}, ${img.id}, 1)" ${isLast ? 'disabled style="opacity:0.3"' : ''} title="Move Right">â–¶ï¸</button>
                                            ${!img.is_primary ? `<button class="btn btn-small" onclick="setPrimaryImage('${img.type}', ${img.entityId}, ${img.id})" title="Set as Primary">â­</button>` : ''}
                                            <button class="btn btn-secondary btn-small" onclick="deleteImage('${img.type}', ${img.id})" style="color: #ef4444;" title="Delete">ðŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
            });

            gallery.innerHTML = html;
        }

        function openImageUploadModal() {
            selectedFiles = [];
            document.getElementById('uploadPreview').innerHTML = '';
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('assignmentSection').style.display = 'block'; // Show by default
            document.getElementById('uploadButton').disabled = true;
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            
            // Load rooms for checkboxes
            loadRoomCheckboxes();
            
            openModal('imageUploadModal');
            
            // Setup drag and drop
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('imageFileInput');
            
            uploadZone.onclick = () => fileInput.click();
            
            fileInput.onchange = (e) => handleFiles(e.target.files);
            
            uploadZone.ondragover = (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            };
            
            uploadZone.ondragleave = () => {
                uploadZone.classList.remove('dragover');
            };
            
            uploadZone.ondrop = (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            };
        }

        async function loadRoomCheckboxes() {
            try {
                // Get property from page selector
                const propertyId = document.getElementById('images-property-select')?.value;
                
                let url = '/api/db/bookable-units';
                if (propertyId) {
                    url += `?property_id=${propertyId}`;
                } else {
                    // Fall back to account filtering
                    let queryParams = [];
                    if (selectedAccountId) {
                        queryParams.push(`account_id=${selectedAccountId}`);
                    } else {
                        const user = JSON.parse(localStorage.getItem('gas_account') || '{}');
                        if (user.account_id) {
                            queryParams.push(`account_id=${user.account_id}`);
                        }
                    }
                    if (queryParams.length > 0) {
                        url += '?' + queryParams.join('&');
                    }
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to load rooms');
                }
                const data = await response.json();
                const rooms = data.data || [];
                
                const container = document.getElementById('roomCheckboxes');
                if (rooms.length === 0) {
                    container.innerHTML = '<p style="color: #64748b;">No rooms available. Select a property first.</p>';
                    return;
                }
                
                container.innerHTML = rooms.map(room => `
                    <label class="checkbox-label" style="cursor: pointer;">
                        <input type="checkbox" class="room-checkbox" value="${room.id}" style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                        <span style="flex: 1;">${room.name}</span>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Error loading rooms:', error);
                const container = document.getElementById('roomCheckboxes');
                container.innerHTML = '<p style="color: #ef4444; padding: 1rem;">Error loading rooms. Make sure server is deployed.</p>';
            }
        }

        async function handleFiles(files) {
            const preview = document.getElementById('uploadPreview');
            preview.innerHTML = '';
            preview.style.display = 'grid';
            // Assignment section already visible from modal open
            
            selectedFiles = [];
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                
                const reader = new FileReader();
                const previewId = 'preview-' + Math.random().toString(36).substr(2, 9);
                
                reader.onload = async (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = () => {
                        const ratio = img.width / img.height;
                        const isLandscape = ratio >= 1.2; // At least 1.2:1 ratio
                        
                        const previewHtml = `
                            <div class="upload-preview-item" id="${previewId}">
                                <img src="${e.target.result}">
                                ${!isLandscape ? '<div class="error">Ratio too narrow - Min 1.2:1</div>' : ''}
                                <button class="remove" onclick="removePreview('${previewId}', '${file.name}')"></button>
                            </div>
                        `;
                        preview.insertAdjacentHTML('beforeend', previewHtml);
                        
                        if (isLandscape) {
                            selectedFiles.push({ file, previewId });
                        }
                        
                        document.getElementById('uploadButton').disabled = selectedFiles.length === 0;
                    };
                };
                
                reader.readAsDataURL(file);
            }
        }

        function removePreview(previewId, filename) {
            document.getElementById(previewId)?.remove();
            selectedFiles = selectedFiles.filter(f => f.previewId !== previewId);
            document.getElementById('uploadButton').disabled = selectedFiles.length === 0;
        }

        async function uploadImages() {
            if (selectedFiles.length === 0) {
                alert('No valid images selected');
                return;
            }

            // Get assignments
            const isProperty = document.getElementById('assign-property').checked;
            const isLocation = document.getElementById('assign-location').checked;
            const selectedRooms = Array.from(document.querySelectorAll('.room-checkbox:checked')).map(cb => cb.value);

            if (!isProperty && !isLocation && selectedRooms.length === 0) {
                alert('Please assign images to at least one category (Property, Location, or Rooms)');
                return;
            }

            document.getElementById('uploadButton').disabled = true;
            // Show centered progress overlay
            const progressDiv = document.getElementById('uploadProgress');
            progressDiv.style.display = 'flex';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            
            let uploadedCount = 0;
            let errorCount = 0;

            // Upload to each selected destination
            const destinations = [];
            
            if (isProperty) {
                // Use the property selected on the page
                const propertyId = document.getElementById('images-property-select')?.value;
                if (propertyId) {
                    destinations.push({ type: 'property', id: propertyId });
                } else {
                    // Fall back to first property if none selected
                    const propsResp = await fetch('/api/db/properties');
                    const propsData = await propsResp.json();
                    if (propsData.data && propsData.data.length > 0) {
                        destinations.push({ type: 'property', id: propsData.data[0].id });
                    }
                }
            }

            selectedRooms.forEach(roomId => {
                destinations.push({ type: 'room', id: roomId });
            });

            const totalUploads = destinations.length * selectedFiles.length;
            let completed = 0;

            for (const dest of destinations) {
                const formData = new FormData();
                selectedFiles.forEach(item => formData.append('images', item.file));

                try {
                    const endpoint = dest.type === 'property' 
                        ? `/api/admin/properties/${dest.id}/images`
                        : `/api/admin/rooms/${dest.id}/images`;
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.success) {
                        uploadedCount += result.images.length;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    errorCount++;
                }

                completed += selectedFiles.length;
                const progress = (completed / totalUploads) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
            }

            // Show completion
            document.getElementById('progressText').textContent = ` ${uploadedCount} images uploaded${errorCount > 0 ? ` (${errorCount} errors)` : ''}`;
            
            setTimeout(() => {
                closeModal('imageUploadModal');
                loadImagesForProperty();
            }, 1500);
        }

        async function setPrimaryImage(type, entityId, imageId) {
            // Show loading state on the image
            const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imgCard) {
                imgCard.style.opacity = '0.5';
                imgCard.style.pointerEvents = 'none';
            }
            
            try {
                const endpoint = type === 'property'
                    ? `/api/admin/properties/${entityId}/images/${imageId}/primary`
                    : `/api/admin/rooms/${entityId}/images/${imageId}/primary`;
                
                const response = await fetch(endpoint, { method: 'PUT' });
                const result = await response.json();
                
                if (result.success) {
                    await loadImagesForProperty(); // await the refresh
                } else {
                    alert('Error: ' + result.error);
                    if (imgCard) {
                        imgCard.style.opacity = '1';
                        imgCard.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Error setting primary:', error);
                alert('Error setting primary image');
                if (imgCard) {
                    imgCard.style.opacity = '1';
                    imgCard.style.pointerEvents = 'auto';
                }
            }
        }

        async function deleteImage(type, imageId) {
            if (!confirm('Delete this image? This cannot be undone.')) return;
            
            // Show loading state
            const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imgCard) {
                imgCard.style.opacity = '0.5';
                imgCard.style.pointerEvents = 'none';
            }
            
            try {
                const endpoint = type === 'property'
                    ? `/api/admin/properties/images/${imageId}`
                    : `/api/admin/rooms/images/${imageId}`;
                
                const response = await fetch(endpoint, { method: 'DELETE', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    // Remove the card immediately for instant feedback
                    const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
                    if (imgCard) {
                        imgCard.style.transition = 'opacity 0.3s, transform 0.3s';
                        imgCard.style.opacity = '0';
                        imgCard.style.transform = 'scale(0.8)';
                        setTimeout(() => imgCard.remove(), 300);
                    }
                    // Then refresh to update counts etc
                    await loadImagesForProperty();
                } else {
                    alert('Error: ' + result.error);
                    const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
                    if (imgCard) {
                        imgCard.style.opacity = '1';
                        imgCard.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('Error deleting image');
            }
        }

        async function moveImage(type, entityId, imageId, direction) {
            // Show loading state
            const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imgCard) {
                imgCard.style.opacity = '0.5';
                imgCard.style.pointerEvents = 'none';
            }
            
            // Get images for this entity
            const entityImages = allImages.filter(img => 
                img.type === type && img.entityId === entityId
            ).sort((a, b) => a.display_order - b.display_order);
            
            const currentIndex = entityImages.findIndex(img => img.id === imageId);
            const newIndex = currentIndex + direction;
            
            if (newIndex < 0 || newIndex >= entityImages.length) {
                if (imgCard) {
                    imgCard.style.opacity = '1';
                    imgCard.style.pointerEvents = 'auto';
                }
                return;
            }
            
            // Swap positions
            const newOrder = entityImages.map(img => img.id);
            [newOrder[currentIndex], newOrder[newIndex]] = [newOrder[newIndex], newOrder[currentIndex]];
            
            try {
                const endpoint = type === 'property'
                    ? `/api/admin/properties/${entityId}/images/reorder`
                    : `/api/admin/rooms/${entityId}/images/reorder`;
                
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ imageIds: newOrder })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadImagesForProperty();
                } else {
                    alert('Error: ' + result.error);
                    if (imgCard) {
                        imgCard.style.opacity = '1';
                        imgCard.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Error reordering:', error);
                alert('Error reordering images');
                if (imgCard) {
                    imgCard.style.opacity = '1';
                    imgCard.style.pointerEvents = 'auto';
                }
            }
        }

        // =====================================================
        // IMAGE DRAG AND DROP
        // =====================================================
        let draggedImage = null;
        
        function handleImageDragStart(e) {
            draggedImage = e.target.closest('.image-card');
            if (draggedImage) {
                draggedImage.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', draggedImage.dataset.imageId);
            }
        }
        
        function handleImageDragEnd(e) {
            if (draggedImage) {
                draggedImage.classList.remove('dragging');
            }
            document.querySelectorAll('.image-card.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedImage = null;
        }
        
        function handleImageDragOver(e) {
            e.preventDefault();
            const card = e.target.closest('.image-card');
            if (card && card !== draggedImage && card.dataset.type === draggedImage?.dataset.type && card.dataset.entity === draggedImage?.dataset.entity) {
                card.classList.add('drag-over');
                e.dataTransfer.dropEffect = 'move';
            }
        }
        
        function handleImageDragLeave(e) {
            const card = e.target.closest('.image-card');
            if (card) {
                card.classList.remove('drag-over');
            }
        }
        
        async function handleImageDrop(e) {
            e.preventDefault();
            const targetCard = e.target.closest('.image-card');
            targetCard?.classList.remove('drag-over');
            
            if (!draggedImage || !targetCard || draggedImage === targetCard) return;
            
            // Must be same type and entity
            if (draggedImage.dataset.type !== targetCard.dataset.type || 
                draggedImage.dataset.entity !== targetCard.dataset.entity) {
                return;
            }
            
            const type = draggedImage.dataset.type;
            const entityId = parseInt(draggedImage.dataset.entity);
            const draggedId = parseInt(draggedImage.dataset.imageId);
            const targetId = parseInt(targetCard.dataset.imageId);
            
            // Get all cards in this group and build new order
            const gallery = targetCard.closest('.image-gallery');
            const cards = Array.from(gallery.querySelectorAll('.image-card'));
            const imageIds = cards.map(c => parseInt(c.dataset.imageId));
            
            // Remove dragged from current position and insert at target position
            const draggedIdx = imageIds.indexOf(draggedId);
            const targetIdx = imageIds.indexOf(targetId);
            
            imageIds.splice(draggedIdx, 1);
            imageIds.splice(targetIdx, 0, draggedId);
            
            // Show loading
            gallery.style.opacity = '0.5';
            
            try {
                const endpoint = type === 'property'
                    ? `/api/admin/properties/${entityId}/images/reorder`
                    : `/api/admin/rooms/${entityId}/images/reorder`;
                
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ imageIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadImagesForProperty();
                } else {
                    alert('Error: ' + result.error);
                    gallery.style.opacity = '1';
                }
            } catch (error) {
                console.error('Error reordering:', error);
                alert('Error reordering images');
                gallery.style.opacity = '1';
            }
        }

        // =====================================================
        // TASKS - Tabbed Menu Navigation
        // =====================================================
        let tasksData = null;
        let currentTasksView = 'category'; // 'category' or 'priority'
        let currentTaskCategory = 'all';
        let currentTaskPriority = 'all';
        
        async function loadTasks() {
            try {
                // Try loading from JSON file first (primary source)
                const jsonResponse = await fetch('/tasks.json?t=' + Date.now());
                if (jsonResponse.ok) {
                    tasksData = await jsonResponse.json();
                    // Ensure tasks and completed arrays exist
                    if (!tasksData.tasks) tasksData.tasks = [];
                    if (!tasksData.completed) tasksData.completed = [];
                } else {
                    throw new Error('JSON file not found');
                }
            } catch (jsonError) {
                console.log('JSON load failed, trying API:', jsonError);
                try {
                    // Fallback to database API
                    const response = await fetch('/api/admin/tasks');
                    const data = await response.json();
                    const tasksArray = data.tasks || data.data || [];
                    
                    tasksData = {
                        tasks: tasksArray.filter(t => t.status !== 'done'),
                        completed: tasksArray.filter(t => t.status === 'done'),
                        categories: [
                            { id: 'critical', name: 'Critical - Must Work', icon: 'ðŸš¨' },
                            { id: 'billing', name: 'Billing & Payments', icon: 'ðŸ’³' },
                            { id: 'booking-flow', name: 'Booking Flow', icon: 'ðŸ“…' },
                            { id: 'ui', name: 'UI/UX', icon: 'ðŸŽ¨' },
                            { id: 'website-builder', name: 'Website Builder', icon: 'ðŸŒ' },
                            { id: 'apps', name: 'Apps', icon: 'ðŸ“±' },
                            { id: 'integrations', name: 'Integrations', icon: 'ðŸ”—' },
                            { id: 'wordpress', name: 'WordPress', icon: 'ðŸ“' },
                            { id: 'bugs', name: 'Bug Fixes', icon: 'ðŸ”§' },
                            { id: 'ideas', name: 'Ideas', icon: 'ðŸ’¡' }
                        ]
                    };
                } catch (apiError) {
                    console.error('Both JSON and API failed:', apiError);
                    tasksData = {
                        tasks: [],
                        completed: [],
                        categories: [
                            { id: 'critical', name: 'Critical - Must Work', icon: 'ðŸš¨' },
                            { id: 'billing', name: 'Billing & Payments', icon: 'ðŸ’³' },
                            { id: 'ideas', name: 'Ideas', icon: 'ðŸ’¡' }
                        ]
                    };
                }
            }
            
            buildCategoryTabs();
            updateTaskStats();
            renderTasks();
            renderCompletedTasks();
        }
        
        function buildCategoryTabs() {
            if (!tasksData || !tasksData.categories) return;
            
            const container = document.getElementById('tasks-category-tabs');
            if (!container) return;
            
            let html = `<button class="tasks-cat-tab ${currentTaskCategory === 'all' ? 'active' : ''}" data-cat="all" onclick="filterTasksCat('all')">All</button>`;
            
            tasksData.categories.forEach(cat => {
                const count = tasksData.tasks ? tasksData.tasks.filter(t => t.category === cat.id && t.status !== 'done').length : 0;
                const isActive = currentTaskCategory === cat.id ? 'active' : '';
                html += `<button class="tasks-cat-tab ${isActive}" data-cat="${cat.id}" onclick="filterTasksCat('${cat.id}')">${cat.icon} ${cat.name} ${count > 0 ? `<span style="opacity: 0.7;">(${count})</span>` : ''}</button>`;
            });
            
            container.innerHTML = html;
        }
        
        function updateTaskStats() {
            if (!tasksData) return;
            
            const activeTasks = tasksData.tasks.filter(t => t.status !== 'done');
            
            document.getElementById('stat-critical').textContent = activeTasks.filter(t => t.priority === 'critical').length;
            document.getElementById('stat-urgent').textContent = activeTasks.filter(t => t.priority === 'urgent').length;
            document.getElementById('stat-high').textContent = activeTasks.filter(t => t.priority === 'high').length;
            document.getElementById('stat-medium').textContent = activeTasks.filter(t => t.priority === 'medium').length;
        }
        
        function switchTaskMainTab(tab) {
            document.querySelectorAll('.tasks-main-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tasks-main-' + tab).classList.add('active');
            
            if (tab === 'active') {
                document.getElementById('tasks-active-panel').style.display = 'block';
                document.getElementById('tasks-completed-panel').style.display = 'none';
            } else {
                document.getElementById('tasks-active-panel').style.display = 'none';
                document.getElementById('tasks-completed-panel').style.display = 'block';
            }
        }
        
        function setTasksView(view) {
            currentTasksView = view;
            
            document.querySelectorAll('.tasks-view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-by-' + view).classList.add('active');
            
            if (view === 'category') {
                document.getElementById('tasks-category-tabs').style.display = 'flex';
                document.getElementById('tasks-priority-tabs').style.display = 'none';
            } else {
                document.getElementById('tasks-category-tabs').style.display = 'none';
                document.getElementById('tasks-priority-tabs').style.display = 'flex';
            }
            
            renderTasks();
        }
        
        function filterTasksCat(cat) {
            currentTaskCategory = cat;
            
            document.querySelectorAll('#tasks-category-tabs .tasks-cat-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.cat === cat);
            });
            
            renderTasks();
        }
        
        function filterTasksPriority(priority) {
            currentTaskPriority = priority;
            
            document.querySelectorAll('#tasks-priority-tabs .tasks-cat-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.priority === priority);
            });
            
            renderTasks();
        }
        
        function renderTasks() {
            if (!tasksData) return;
            
            const container = document.getElementById('tasks-list');
            let tasks = tasksData.tasks.filter(t => t.status !== 'done');
            
            // Apply filters
            if (currentTasksView === 'category' && currentTaskCategory !== 'all') {
                tasks = tasks.filter(t => t.category === currentTaskCategory);
            }
            if (currentTasksView === 'priority' && currentTaskPriority !== 'all') {
                tasks = tasks.filter(t => t.priority === currentTaskPriority);
            }
            
            // Sort by priority
            const priorityOrder = { 'critical': 0, 'urgent': 1, 'high': 2, 'medium': 3, 'low': 4 };
            tasks.sort((a, b) => (priorityOrder[a.priority] || 3) - (priorityOrder[b.priority] || 3));
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <h3>No tasks here</h3>
                        <p style="color: #64748b;">Try a different filter</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            tasks.forEach(task => {
                const priorityClass = `priority-${task.priority || 'medium'}`;
                const badgeClass = `task-badge-${task.priority || 'medium'}`;
                const priorityLabels = { 'critical': ' CRITICAL', 'urgent': ' URGENT', 'high': ' HIGH', 'medium': ' MEDIUM' };
                const taskId = task.id || task.title.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                
                let subtasksHtml = '';
                if (task.subtasks && task.subtasks.length > 0) {
                    subtasksHtml = `
                        <div class="task-subtasks">
                            ${task.subtasks.map(st => `<div class="task-subtask">${st}</div>`).join('')}
                        </div>
                    `;
                }
                
                let notesHtml = '';
                if (task.notes) {
                    notesHtml = `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: #b45309; background: #fef3c7; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block;"> ${task.notes}</div>`;
                }
                
                html += `
                    <div class="task-card ${priorityClass}" data-task-id="${taskId}" style="cursor: pointer;">
                        <div class="task-card-header">
                            <h4 class="task-title">${task.title}</h4>
                            <div class="task-badges">
                                <span class="task-badge ${badgeClass}">${priorityLabels[task.priority] || 'MEDIUM'}</span>
                                <button class="btn btn-small task-edit-btn" data-id="${taskId}" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;"> Edit</button>
                                <button class="btn btn-small task-done-btn" data-id="${taskId}" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #22c55e;"> Done</button>
                            </div>
                        </div>
                        ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                        ${notesHtml}
                        ${subtasksHtml}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Attach event listeners
            container.querySelectorAll('.task-edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = btn.dataset.id;
                    editTaskById(taskId);
                });
            });
            
            container.querySelectorAll('.task-done-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = btn.dataset.id;
                    markTaskDoneById(taskId);
                });
            });
        }
        
        function renderCompletedTasks() {
            if (!tasksData) return;
            
            const container = document.getElementById('tasks-completed-list');
            const completed = tasksData.completed || [];
            const doneTasks = tasksData.tasks.filter(t => t.status === 'done');
            const allCompleted = [...completed, ...doneTasks];
            
            allCompleted.sort((a, b) => (b.completed || '').localeCompare(a.completed || ''));
            
            if (allCompleted.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                        <h3>No completed tasks yet</h3>
                    </div>
                `;
                return;
            }
            
            // Group by date
            const grouped = {};
            allCompleted.forEach(task => {
                const date = task.completed || 'Unknown';
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(task);
            });
            
            let html = `
                <div style="padding: 1rem; background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-radius: 8px; margin-bottom: 1rem;">
                    <span style="color: #065f46;"><strong>${allCompleted.length}</strong> tasks completed </span>
                </div>
            `;
            
            Object.entries(grouped).forEach(([date, tasks]) => {
                html += `<div style="margin-bottom: 0.5rem; font-weight: 600; color: #065f46;"> ${date}</div>`;
                tasks.forEach(task => {
                    html += `
                        <div class="task-card completed-task">
                            <h4 class="task-title">${task.title}</h4>
                            ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                        </div>
                    `;
                });
            });
            
            container.innerHTML = html;
        }
        
        // Task CRUD Functions
        function openTaskModal(task = null) {
            document.getElementById('task-id').value = task?.id || '';
            document.getElementById('task-title').value = task?.title || '';
            document.getElementById('task-description').value = task?.description || '';
            document.getElementById('task-priority').value = task?.priority || 'high';
            document.getElementById('task-category').value = task?.category || 'ideas';
            document.getElementById('task-status').value = task?.status || 'todo';
            document.getElementById('task-notes').value = task?.notes || '';
            
            // Show/hide delete button
            const deleteBtn = document.getElementById('task-delete-btn');
            if (deleteBtn) {
                deleteBtn.style.display = task?.id ? 'block' : 'none';
            }
            
            document.getElementById('task-modal-title').textContent = task ? ' Edit Task' : ' Add Task';
            openModal('taskModal');
        }
        
        function deleteTaskFromModal() {
            const taskId = document.getElementById('task-id').value;
            if (taskId) {
                closeModal('taskModal');
                deleteTask(taskId);
            }
        }
        
        function editTaskById(taskId) {
            if (!tasksData) return;
            
            // Find task in active tasks or completed
            let task = tasksData.tasks?.find(t => String(t.id) === String(taskId));
            if (!task && tasksData.completed) {
                task = tasksData.completed.find(t => String(t.id) === String(taskId));
            }
            
            if (task) {
                openTaskModal(task);
            } else {
                showNotification('Task not found', 'error');
            }
        }
        
        async function saveTask(event) {
            event.preventDefault();
            
            const id = document.getElementById('task-id').value;
            const taskData = {
                id: id || 'task-' + Date.now(),
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                priority: document.getElementById('task-priority').value,
                category: document.getElementById('task-category').value,
                status: document.getElementById('task-status').value,
                notes: document.getElementById('task-notes').value
            };
            
            // Update local state
            if (!tasksData) tasksData = { tasks: [], completed: [], categories: [] };
            if (!tasksData.tasks) tasksData.tasks = [];
            
            if (id) {
                // Update existing task
                const idx = tasksData.tasks.findIndex(t => String(t.id) === String(id));
                if (idx !== -1) {
                    tasksData.tasks[idx] = { ...tasksData.tasks[idx], ...taskData };
                } else {
                    // Check in completed
                    const compIdx = tasksData.completed?.findIndex(t => String(t.id) === String(id));
                    if (compIdx !== -1) {
                        tasksData.completed[compIdx] = { ...tasksData.completed[compIdx], ...taskData };
                    }
                }
            } else {
                // Add new task at the beginning
                tasksData.tasks.unshift(taskData);
            }
            
            // Try to save to database (for persistence)
            try {
                const url = '/api/admin/tasks' + (id && !isNaN(id) ? `/${id}` : '');
                const method = id && !isNaN(id) ? 'PUT' : 'POST';
                
                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(taskData)
                });
            } catch (error) {
                console.log('DB save failed (task saved locally):', error);
            }
            
            closeModal('taskModal');
            
            // Reset to "All" view to show the new/updated task
            currentTaskCategory = 'all';
            
            // Rebuild UI
            buildCategoryTabs();
            updateTaskStats();
            renderTasks();
            renderCompletedTasks();
            
            showNotification(id ? 'Task updated!' : 'Task added to ' + taskData.category + '!', 'success');
        }
        
        async function markTaskDoneById(taskId) {
            if (!tasksData) return;
            
            // Try database first
            if (!isNaN(taskId)) {
                try {
                    const response = await fetch(`/api/admin/tasks/${taskId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ status: 'done', completed: new Date().toISOString().split('T')[0] })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showNotification('Task completed! ', 'success');
                        loadTasks();
                        return;
                    }
                } catch (error) {
                    console.log('DB update failed:', error);
                }
            }
            
            // Fallback: Update local state
            const idx = tasksData.tasks.findIndex(t => String(t.id) === String(taskId));
            if (idx !== -1) {
                const task = tasksData.tasks[idx];
                task.status = 'done';
                task.completed = new Date().toISOString().split('T')[0];
                
                // Move to completed
                tasksData.tasks.splice(idx, 1);
                if (!tasksData.completed) tasksData.completed = [];
                tasksData.completed.unshift(task);
                
                showNotification('Task completed! ', 'success');
                updateTaskStats();
                renderTasks();
                renderCompletedTasks();
            }
        }
        
        async function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;
            
            // Try database first
            if (!isNaN(taskId)) {
                try {
                    const response = await fetch(`/api/admin/tasks/${taskId}`, { method: 'DELETE', headers: authHeaders() });
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('Task deleted', 'success');
                        loadTasks();
                        return;
                    }
                } catch (error) {
                    console.log('DB delete failed:', error);
                }
            }
            
            // Fallback: Update local state
            if (tasksData?.tasks) {
                tasksData.tasks = tasksData.tasks.filter(t => String(t.id) !== String(taskId));
                showNotification('Task deleted', 'success');
                updateTaskStats();
                renderTasks();
            }
        }

        // =====================================================
        // WEBSITE DEPLOYMENT FUNCTIONS
        // =====================================================
        
        let deployRoomsData = []; // Store loaded rooms grouped by property
        
        async function checkVpsStatus() {
            const statusEl = document.getElementById('vps-status');
            if (!statusEl) return;
            
            try {
                const response = await fetch('/api/deploy/status');
                const data = await response.json();
                
                if (data.success && data.status === 'ready') {
                    statusEl.style.background = '#dcfce7';
                    statusEl.style.color = '#166534';
                    statusEl.innerHTML = ' VPS Connected';
                } else {
                    statusEl.style.background = '#fef2f2';
                    statusEl.style.color = '#991b1b';
                    statusEl.innerHTML = ' VPS Offline';
                }
            } catch (error) {
                statusEl.style.background = '#fef2f2';
                statusEl.style.color = '#991b1b';
                statusEl.innerHTML = ' VPS Unreachable';
            }
        }
        
        // My Custom Site Function (Client View)
        async function loadMyCustomSite() {
            const container = document.getElementById('my-custom-site-container');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 3rem;"><div class="spinner" style="margin: 0 auto 1rem;"></div>Loading...</div>';
            
            try {
                const response = await fetch('/api/my-custom-site' + buildQueryString(), { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.site) {
                    const site = data.site;
                    const creds = site.credentials ? JSON.parse(site.credentials) : {};
                    
                    container.innerHTML = `
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-bottom: 1px solid #3b82f6;">
                                <h3 style="margin: 0; color: #1e40af;">ðŸŒ ${site.site_name || site.slug}</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                    <div>
                                        <h4 style="margin: 0 0 1rem 0; color: #1e293b;">Site Links</h4>
                                        <div style="margin-bottom: 1rem;">
                                            <label style="font-weight: 600; color: #64748b; font-size: 0.85rem;">Website URL</label>
                                            <div style="margin-top: 0.25rem;">
                                                <a href="https://${site.domain}" target="_blank" style="color: #2563eb; font-size: 1.1rem;">
                                                    https://${site.domain}
                                                </a>
                                            </div>
                                        </div>
                                        <div style="margin-bottom: 1rem;">
                                            <label style="font-weight: 600; color: #64748b; font-size: 0.85rem;">WordPress Admin</label>
                                            <div style="margin-top: 0.25rem;">
                                                <a href="https://${site.domain}/wp-admin" target="_blank" style="color: #2563eb;">
                                                    https://${site.domain}/wp-admin
                                                </a>
                                            </div>
                                        </div>
                                        <div>
                                            <label style="font-weight: 600; color: #64748b; font-size: 0.85rem;">Created</label>
                                            <div style="margin-top: 0.25rem; color: #1e293b;">
                                                ${site.created_at ? new Date(site.created_at).toLocaleDateString() : 'N/A'}
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0 0 1rem 0; color: #1e293b;">ðŸ” Login Credentials</h4>
                                        <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 1rem;">
                                            <div style="margin-bottom: 0.75rem;">
                                                <label style="font-weight: 600; color: #92400e; font-size: 0.85rem;">Username</label>
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem;">
                                                    <code style="background: #1e293b; color: #22c55e; padding: 0.5rem 0.75rem; border-radius: 4px; flex: 1;">${creds.username || creds.wp_user || 'admin'}</code>
                                                    <button onclick="navigator.clipboard.writeText('${creds.username || creds.wp_user || 'admin'}'); this.textContent='âœ“'; setTimeout(() => this.textContent='ðŸ“‹', 1500);" class="btn btn-sm" style="padding: 0.5rem;">ðŸ“‹</button>
                                                </div>
                                            </div>
                                            <div>
                                                <label style="font-weight: 600; color: #92400e; font-size: 0.85rem;">Password</label>
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem;">
                                                    <code style="background: #1e293b; color: #22c55e; padding: 0.5rem 0.75rem; border-radius: 4px; flex: 1;" id="custom-site-password">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</code>
                                                    <button onclick="toggleCustomSitePassword()" class="btn btn-sm" style="padding: 0.5rem;" id="toggle-password-btn">ðŸ‘ï¸</button>
                                                    <button onclick="navigator.clipboard.writeText('${creds.password || creds.wp_pass || ''}'); this.textContent='âœ“'; setTimeout(() => this.textContent='ðŸ“‹', 1500);" class="btn btn-sm" style="padding: 0.5rem;">ðŸ“‹</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-bottom: 1px solid #10b981;">
                                <h3 style="margin: 0; color: #065f46;">ðŸ“‹ Quick Actions</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <a href="https://${site.domain}" target="_blank" class="btn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                                        ðŸŒ Visit Site
                                    </a>
                                    <a href="https://${site.domain}/wp-admin" target="_blank" class="btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                        âš™ï¸ WordPress Admin
                                    </a>
                                    <a href="https://${site.domain}/wp-admin/admin.php?page=elementor" target="_blank" class="btn" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                                        ðŸŽ¨ Elementor
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Store password for toggle
                    window.customSitePassword = creds.password || creds.wp_pass || '';
                    
                } else {
                    container.innerHTML = `
                        <div class="card">
                            <div class="card-body" style="text-align: center; padding: 3rem;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ—ï¸</div>
                                <h3 style="margin: 0 0 0.5rem 0; color: #1e293b;">No Custom Site Yet</h3>
                                <p style="color: #64748b; margin: 0 0 1.5rem 0;">You don't have a custom bespoke site. Request one to get a fully custom-designed website!</p>
                                <button onclick="navClick(null, 'deploy-sites')" class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                    âœ¨ Request Custom Site
                                </button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading custom site:', error);
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body" style="text-align: center; padding: 2rem; color: #ef4444;">
                            Error loading custom site: ${error.message}
                        </div>
                    </div>
                `;
            }
        }
        
        function toggleCustomSitePassword() {
            const el = document.getElementById('custom-site-password');
            const btn = document.getElementById('toggle-password-btn');
            if (el.textContent === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
                el.textContent = window.customSitePassword;
                btn.textContent = 'ðŸ™ˆ';
            } else {
                el.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
                btn.textContent = 'ðŸ‘ï¸';
            }
        }
        
        // Check if user has custom site and show menu item
        async function checkCustomSiteAccess() {
            try {
                const response = await fetch('/api/my-custom-site' + buildQueryString(), { headers: authHeaders() });
                const data = await response.json();
                const menuItem = document.getElementById('nav-my-custom-site');
                if (menuItem && data.success && data.site) {
                    menuItem.style.display = 'flex';
                }
            } catch (e) {
                // Ignore - menu stays hidden
            }
        }
        
        // Custom Sites Functions
        async function loadCustomSiteRequests() {
            const container = document.getElementById('custom-site-requests-container');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch('/api/custom-site/requests', { headers: authHeaders() });
                const data = await response.json();
                
                // Filter to only pending requests
                const pendingRequests = (data.requests || []).filter(r => r.status === 'pending');
                
                if (data.success && pendingRequests.length > 0) {
                    let html = '<div class="table-container"><table><thead><tr><th>Date</th><th>Email</th><th>Description</th><th>Reference</th><th>Actions</th></tr></thead><tbody>';
                    
                    for (const req of pendingRequests) {
                        const date = new Date(req.created_at).toLocaleDateString();
                        
                        html += `<tr>
                            <td>${date}</td>
                            <td>${req.email}</td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${req.project_description || '-'}</td>
                            <td>${req.reference_url ? '<a href="' + req.reference_url + '" target="_blank">View</a>' : '-'}</td>
                            <td>
                                <button class="btn btn-small" onclick="fillProvisionForm('${req.email}')" style="margin-right: 0.5rem;">Provision</button>
                                <button class="btn btn-small btn-secondary" onclick="deleteCustomSiteRequest(${req.id})" style="background: #fee2e2; color: #991b1b;">Delete</button>
                            </td>
                        </tr>`;
                    }
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">No pending requests</div>';
                }
            } catch (error) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Error loading requests</div>';
            }
            
            // Also load provisioned sites
            loadProvisionedSites();
        }
        
        async function loadProvisionedSites() {
            const container = document.getElementById('provisioned-sites-container');
            if (!container) return;
            
            try {
                const response = await fetch('/api/custom-site/provisioned', { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.sites && data.sites.length > 0) {
                    let html = '<div class="table-container"><table><thead><tr><th>Site</th><th>Admin Email</th><th>Created</th><th>Links</th><th>Credentials</th><th>SSL Command</th></tr></thead><tbody>';
                    
                    for (const site of data.sites) {
                        const date = new Date(site.created_at).toLocaleDateString();
                        const creds = site.credentials ? JSON.parse(site.credentials) : {};
                        const sslCmd = `certbot --apache -d ${site.domain} --non-interactive --agree-tos -m steve@gas.travel`;
                        
                        html += `<tr>
                            <td>
                                <strong>${site.site_name}</strong><br>
                                <small style="color: #64748b;">${site.domain}</small>
                            </td>
                            <td>${site.admin_email}</td>
                            <td>${date}</td>
                            <td>
                                <a href="https://${site.domain}" target="_blank" class="btn btn-small" style="margin-right: 0.25rem;">ðŸŒ Site</a>
                                <a href="https://${site.domain}/wp-admin" target="_blank" class="btn btn-small">âš™ï¸ Admin</a>
                            </td>
                            <td>
                                <button class="btn btn-small btn-secondary" onclick="showCredentials('${creds.wp_user || 'admin'}', '${creds.wp_pass || 'Check VPS'}')">ðŸ”‘ Show</button>
                            </td>
                            <td>
                                <button class="btn btn-small" style="background: #1e293b; font-size: 0.7rem;" onclick="navigator.clipboard.writeText('${sslCmd}'); showNotification('SSL command copied!', 'success');">ðŸ“‹ Copy SSL</button>
                            </td>
                        </tr>`;
                    }
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">No provisioned sites yet</div>';
                }
            } catch (error) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">No provisioned sites yet</div>';
            }
        }
        
        function showCredentials(username, password) {
            showNotification(`Username: ${username} | Password: ${password}`, 'success', 10000);
        }
        
        async function deleteCustomSiteRequest(id) {
            if (!confirm('Delete this request?')) return;
            
            try {
                const response = await fetch(`/api/custom-site/requests/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Request deleted', 'success');
                    loadCustomSiteRequests();
                } else {
                    showNotification(data.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        function refreshCustomSiteRequests() {
            loadCustomSiteRequests();
        }
        
        function fillProvisionForm(email) {
            document.getElementById('provision-admin-email').value = email;
            document.getElementById('provision-slug').focus();
        }
        
        async function provisionCustomSite(event) {
            event.preventDefault();
            
            const slug = document.getElementById('provision-slug').value.toLowerCase().trim();
            const siteName = document.getElementById('provision-site-name').value.trim();
            const adminEmail = document.getElementById('provision-admin-email').value.trim();
            const btn = document.getElementById('provision-btn');
            const statusEl = document.getElementById('provision-status');
            const resultEl = document.getElementById('provision-result');
            
            if (!slug || !siteName || !adminEmail) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            btn.disabled = true;
            statusEl.textContent = 'â³ Provisioning site... (this may take 30-60 seconds)';
            resultEl.style.display = 'none';
            
            try {
                const response = await fetch('/api/custom-site/provision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ slug, site_name: siteName, admin_email: adminEmail })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.textContent = 'âœ… Site provisioned!';
                    resultEl.style.display = 'block';
                    resultEl.innerHTML = `
                        <h4 style="margin: 0 0 1rem 0; color: #166534;">ðŸŽ‰ Site Created Successfully!</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <strong>Site URL:</strong><br>
                                <a href="${data.site.url}" target="_blank">${data.site.url}</a>
                            </div>
                            <div>
                                <strong>Admin URL:</strong><br>
                                <a href="${data.site.admin_url}" target="_blank">${data.site.admin_url}</a>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                            <strong>ðŸ”‘ WordPress Credentials:</strong><br>
                            <code>Username: ${data.credentials.wp_user}</code><br>
                            <code>Password: ${data.credentials.wp_pass}</code>
                        </div>
                        <div style="margin-top: 1rem; padding: 1rem; background: #1e293b; border-radius: 8px;">
                            <strong style="color: #f59e0b;">ðŸ”’ SSL Setup (run in SSH):</strong><br>
                            <code style="color: #22c55e; cursor: pointer; display: block; margin-top: 0.5rem;" onclick="navigator.clipboard.writeText('certbot --apache -d ${slug}.custom.gas.travel --non-interactive --agree-tos -m steve@gas.travel'); showNotification('SSL command copied!', 'success');">certbot --apache -d ${slug}.custom.gas.travel --non-interactive --agree-tos -m steve@gas.travel</code>
                            <small style="color: #64748b; display: block; margin-top: 0.5rem;">Click to copy</small>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.85rem; color: #64748b;">
                            âš ï¸ Make sure DNS A record is set: <strong>${slug}.custom</strong> â†’ <strong>31.97.119.90</strong>
                        </p>
                    `;
                    
                    // Clear form
                    document.getElementById('provision-site-form').reset();
                    loadCustomSiteRequests();
                    showNotification('Site provisioned successfully!', 'success');
                } else {
                    statusEl.textContent = 'âŒ Failed: ' + (data.error || 'Unknown error');
                    showNotification(data.error || 'Provisioning failed', 'error');
                }
            } catch (error) {
                statusEl.textContent = 'âŒ Error: ' + error.message;
                showNotification('Error: ' + error.message, 'error');
            }
            
            btn.disabled = false;
        }

        async function loadDeployedSites() {
            const container = document.getElementById('deployed-sites-list');
            if (!container) return;
            
            try {
                let url = '/api/admin/deployed-sites';
                if (selectedAccountId) {
                    url += '?account_id=' + selectedAccountId;
                }
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success || !data.sites || data.sites.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <h3>No sites deployed yet</h3>
                            <p>Click "Create New Site" to create your first website</p>
                        </div>
                    `;
                    updateDeployStats([]);
                    return;
                }
                
                const sites = data.sites;
                updateDeployStats(sites);
                
                // Cache deployed sites for editWebsite lookups
                deployedSitesCache = sites;
                
                // Also update availableWebsites for the selector (include template!)
                availableWebsites = sites.map(s => ({
                    id: s.id,
                    name: s.site_name || s.slug,
                    site_url: s.site_url,
                    admin_url: s.admin_url,
                    status: s.status,
                    account_id: s.account_id,
                    template: s.template || 'developer-light'
                }));
                updateWebsiteSelectors();
                
                let html = '<div style="display: grid; gap: 1rem;">';
                
                sites.forEach(site => {
                    // Determine effective status
                    // Auto-promote to 'live' if custom_domain is set and status is 'deployed'
                    let effectiveStatus = site.status || 'development';
                    if (site.custom_domain && effectiveStatus === 'deployed') {
                        effectiveStatus = 'live';
                    }
                    
                    // Status configuration
                    const statusConfig = {
                        'development': { color: '#f59e0b', icon: 'ðŸ”¨', label: 'Development' },
                        'deployed': { color: '#7c3aed', icon: 'ðŸš€', label: 'Deployed' },
                        'live': { color: '#10b981', icon: 'âœ…', label: 'Live' },
                        'on-hold': { color: '#6b7280', icon: 'â¸ï¸', label: 'On Hold' },
                        // Legacy status mappings
                        'active': { color: '#10b981', icon: 'âœ…', label: 'Live' },
                        'pending': { color: '#f59e0b', icon: 'ðŸ”¨', label: 'Development' },
                        'creating': { color: '#f59e0b', icon: 'â³', label: 'Creating...' }
                    };
                    
                    const status = statusConfig[effectiveStatus] || statusConfig['development'];
                    const statusColor = status.color;
                    const statusLabel = `${status.icon} ${status.label}`;
                    
                    let roomCount = 0;
                    try {
                        const roomIds = typeof site.room_ids === 'string' ? JSON.parse(site.room_ids || '[]') : (site.room_ids || []);
                        roomCount = Array.isArray(roomIds) ? roomIds.length : 0;
                    } catch (e) { roomCount = 0; }
                    
                    // Master override dropdown (only show for master accounts)
                    const isMaster = currentAccount && currentAccount.role === 'master_admin';
                    const statusDropdown = isMaster ? `
                        <select onchange="updateSiteStatus(${site.id}, this.value)" 
                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid #e2e8f0; background: white; cursor: pointer; margin-top: 0.5rem;">
                            <option value="development" ${effectiveStatus === 'development' ? 'selected' : ''}> Development</option>
                            <option value="deployed" ${effectiveStatus === 'deployed' ? 'selected' : ''}> Deployed</option>
                            <option value="live" ${effectiveStatus === 'live' ? 'selected' : ''}> Live</option>
                            <option value="on-hold" ${effectiveStatus === 'on-hold' ? 'selected' : ''}> On Hold</option>
                        </select>
                    ` : '';
                    
                    // Pricing tier dropdown
                    const pricingTier = site.pricing_tier || 'standard';
                    const pricingTierLabel = {
                        'standard': ' Standard',
                        'corporate': ' Corporate',
                        'wholesale': ' Wholesale',
                        'agent': ' Agent',
                        'vip': ' VIP'
                    }[pricingTier] || ' Standard';
                    
                    const pricingDropdown = `
                        <select onchange="updateSitePricingTier(${site.id}, this.value)" 
                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid #fcd34d; background: #fefce8; cursor: pointer; margin-top: 0.5rem;">
                            <option value="standard" ${pricingTier === 'standard' ? 'selected' : ''}> Standard</option>
                            <option value="corporate_1" ${pricingTier === 'corporate_1' ? 'selected' : ''}> Corporate 1</option>
                            <option value="corporate_2" ${pricingTier === 'corporate_2' ? 'selected' : ''}> Corporate 2</option>
                            <option value="corporate_3" ${pricingTier === 'corporate_3' ? 'selected' : ''}> Corporate 3</option>
                            <option value="agent_1" ${pricingTier === 'agent_1' ? 'selected' : ''}> Travel Agent 1</option>
                            <option value="agent_2" ${pricingTier === 'agent_2' ? 'selected' : ''}> Travel Agent 2</option>
                            <option value="agent_3" ${pricingTier === 'agent_3' ? 'selected' : ''}> Travel Agent 3</option>
                        </select>
                    `;
                    
                    // Template badge
                    const templateLabel = site.template === 'developer-dark' ? ' Dark' : ' Light';
                    
                    html += `
                        <div class="card" style="padding: 1rem; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                                <div style="flex: 1; min-width: 200px;">
                                    <h4 style="margin: 0 0 0.5rem 0;">${site.site_name || site.slug}</h4>
                                    <p style="margin: 0; color: #64748b; font-size: 0.9rem;">
                                        ${site.account_name || 'Unknown Account'}
                                        ${roomCount > 0 ? `<span style="color: #6366f1;">  ${roomCount} rooms</span>` : ''}
                                        <span style="color: #94a3b8;">  ${templateLabel}</span>
                                    </p>
                                    <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button onclick="editWebsite(${site.id})" class="btn btn-small" style="font-size: 0.75rem; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-color: #6366f1;">âœï¸ Edit</button>
                                        <a href="${site.site_url}" target="_blank" class="btn btn-small" style="font-size: 0.75rem;">ðŸŒ View Site</a>
                                        <a href="${site.admin_url}" target="_blank" class="btn btn-small btn-secondary" style="font-size: 0.75rem;">âš™ï¸ WP Admin</a>
                                        <button onclick="manageWebsiteRooms(${site.id}, ${site.property_id}, '${(site.site_name || site.slug).replace(/'/g, "\\'")}')" class="btn btn-small" style="font-size: 0.75rem; background: #10b981; border-color: #10b981;">ðŸ›ï¸ Rooms</button>
                                                                                <button onclick="deleteDeployedSite(${site.id}, '${(site.site_name || site.slug).replace(/'/g, "\\'")}')" class="btn btn-small" style="font-size: 0.75rem; background: #ef4444; border-color: #ef4444;">ðŸ—‘ï¸ Delete</button>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; background: ${statusColor}20; color: ${statusColor}; font-weight: 600;">
                                        ${statusLabel}
                                    </span>
                                    ${site.custom_domain ? `
                                        <div style="margin-top: 0.5rem; font-size: 0.7rem; color: #10b981;">
                                             ${site.custom_domain}
                                        </div>
                                    ` : ''}
                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #64748b;">
                                        Created: ${site.deployed_at ? new Date(site.deployed_at).toLocaleDateString() : 'N/A'}
                                    </div>
                                    ${site.wp_username ? `
                                        <div style="margin-top: 0.5rem; font-size: 0.7rem; background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px;">
                                             ${site.wp_username}
                                        </div>
                                    ` : ''}
                                    ${statusDropdown}
                                    ${pricingDropdown}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading deployed sites:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #991b1b;">
                        <p> Error loading sites</p>
                        <button class="btn btn-secondary" onclick="loadDeployedSites()">Try Again</button>
                    </div>
                `;
            }
        }
        
        function updateDeployStats(sites) {
            const totalEl = document.getElementById('deploy-stat-total');
            const activeEl = document.getElementById('deploy-stat-active');
            const pendingEl = document.getElementById('deploy-stat-pending');
            if (totalEl) totalEl.textContent = sites.length;
            // Count 'live' and 'active' (legacy) as active
            if (activeEl) activeEl.textContent = sites.filter(s => s.status === 'live' || s.status === 'active' || (s.status === 'deployed' && s.custom_domain)).length;
            // Count 'development', 'deployed' (without domain), and 'pending' (legacy) 
            if (pendingEl) pendingEl.textContent = sites.filter(s => s.status === 'development' || s.status === 'pending' || (s.status === 'deployed' && !s.custom_domain)).length;
        }
        
        // Plugin Licenses Management
        async function loadPluginLicenses() {
            const container = document.getElementById('plugin-licenses-list');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><p>Loading licenses...</p></div>';
            
            try {
                // Build URL with account filter if selected
                let url = '/api/plugin-licenses';
                if (selectedAccountId) {
                    url += '?account_id=' + selectedAccountId;
                }
                
                const response = await fetch(url, {
                    headers: authHeaders()
                });
                const data = await response.json();
                
                if (!data.success || !data.licenses || data.licenses.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ”‘</div>
                            <p>No plugin licenses found</p>
                            <p style="font-size: 0.85rem;">Create a license in Custom Sites â†’ Plugin Only</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                
                data.licenses.forEach(license => {
                    const displaySettings = license.display_settings || {};
                    const roomIds = license.room_ids || [];
                    const statusColor = license.status === 'active' ? '#10b981' : '#ef4444';
                    const statusBg = license.status === 'active' ? '#f0fdf4' : '#fef2f2';
                    
                    html += `
                        <div class="license-card" style="border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <span style="font-weight: 600; font-size: 1.1rem;">${license.account_name || license.email}</span>
                                        <span style="background: ${statusBg}; color: ${statusColor}; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">${license.status}</span>
                                    </div>
                                    <div style="font-family: monospace; font-size: 0.85rem; color: #64748b; background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block;">
                                        ${license.license_key}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-small" onclick="editLicenseSettings(${license.id})" style="padding: 0.4rem 0.75rem; font-size: 0.85rem;">
                                        âš™ï¸ Edit Settings
                                    </button>
                                    ${license.status === 'active' ? `
                                        <button class="btn btn-small btn-secondary" onclick="deactivateLicense(${license.id})" style="padding: 0.4rem 0.75rem; font-size: 0.85rem; color: #f59e0b;">
                                            âœ• Deactivate
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-small btn-secondary" onclick="deleteLicense(${license.id})" style="padding: 0.4rem 0.75rem; font-size: 0.85rem; color: #ef4444;">
                                        ðŸ—‘ï¸ Delete
                                    </button>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.85rem;">
                                <div>
                                    <div style="color: #64748b; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem;">Email</div>
                                    <div>${license.email}</div>
                                </div>
                                <div>
                                    <div style="color: #64748b; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem;">Rooms</div>
                                    <div>${roomIds.length} rooms selected</div>
                                </div>
                                <div>
                                    <div style="color: #64748b; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem;">Layout</div>
                                    <div>${displaySettings.columns || 3} columns, ${displaySettings.layout || 'auto'}</div>
                                </div>
                                <div>
                                    <div style="color: #64748b; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem;">Created</div>
                                    <div>${license.created_at ? new Date(license.created_at).toLocaleDateString() : 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="color: #64748b; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem;">Last Used</div>
                                    <div>${license.last_used_at ? new Date(license.last_used_at).toLocaleString() : 'Never'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading licenses:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #991b1b;">
                        <p>Error loading licenses</p>
                        <button class="btn btn-secondary" onclick="loadPluginLicenses()">Try Again</button>
                    </div>
                `;
            }
        }
        
        async function editLicenseSettings(licenseId) {
            try {
                const response = await fetch(`/api/plugin-licenses/${licenseId}`, {
                    headers: authHeaders()
                });
                const data = await response.json();
                
                if (!data.success || !data.license) {
                    showNotification('Could not load license', 'error');
                    return;
                }
                
                const license = data.license;
                const ds = license.display_settings || {};
                
                // Create modal for editing
                const modalHtml = `
                    <div id="edit-license-modal" class="modal" style="display: flex;">
                        <div class="modal-backdrop" onclick="closeModal('edit-license-modal')"></div>
                        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h3>âš™ï¸ Edit License Settings</h3>
                                <button class="modal-close" onclick="closeModal('edit-license-modal')">Ã—</button>
                            </div>
                            <div class="modal-body">
                                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f1f5f9; border-radius: 8px;">
                                    <div style="font-size: 0.85rem; color: #64748b;">License Key</div>
                                    <div style="font-family: monospace;">${license.license_key}</div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label style="font-weight: 500; font-size: 0.85rem;">Columns</label>
                                        <select id="edit-display-columns" class="form-input">
                                            <option value="2" ${ds.columns == 2 ? 'selected' : ''}>2 Columns</option>
                                            <option value="3" ${ds.columns == 3 || !ds.columns ? 'selected' : ''}>3 Columns</option>
                                            <option value="4" ${ds.columns == 4 ? 'selected' : ''}>4 Columns</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label style="font-weight: 500; font-size: 0.85rem;">Layout Style</label>
                                        <select id="edit-display-layout" class="form-input">
                                            <option value="auto" ${ds.layout === 'auto' || !ds.layout ? 'selected' : ''}>Auto</option>
                                            <option value="grid" ${ds.layout === 'grid' ? 'selected' : ''}>Grid</option>
                                            <option value="row" ${ds.layout === 'row' ? 'selected' : ''}>Row</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label style="font-weight: 500; font-size: 0.85rem;">Featured Count</label>
                                        <select id="edit-display-limit" class="form-input">
                                            <option value="0" ${ds.limit == 0 || !ds.limit ? 'selected' : ''}>Show All</option>
                                            <option value="3" ${ds.limit == 3 ? 'selected' : ''}>3 Rooms</option>
                                            <option value="4" ${ds.limit == 4 ? 'selected' : ''}>4 Rooms</option>
                                            <option value="6" ${ds.limit == 6 ? 'selected' : ''}>6 Rooms</option>
                                            <option value="8" ${ds.limit == 8 ? 'selected' : ''}>8 Rooms</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label style="font-weight: 500; font-size: 0.85rem;">Background</label>
                                        <select id="edit-display-bg" class="form-input">
                                            <option value="light" ${ds.background === 'light' ? 'selected' : ''}>Light</option>
                                            <option value="dark" ${ds.background === 'dark' || !ds.background ? 'selected' : ''}>Dark</option>
                                            <option value="gray" ${ds.background === 'gray' ? 'selected' : ''}>Gray</option>
                                            <option value="custom" ${ds.background === 'custom' ? 'selected' : ''}>Custom</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label style="font-weight: 500; font-size: 0.85rem;">Button Color</label>
                                        <input type="color" id="edit-display-primary" value="${ds.primary_color || '#2563eb'}" style="width: 100%; height: 40px; border: 1px solid var(--border); border-radius: 8px;">
                                    </div>
                                    <div class="form-group">
                                        <label style="font-weight: 500; font-size: 0.85rem;">Card Style</label>
                                        <select id="edit-display-card-style" class="form-input">
                                            <option value="default" ${ds.card_style === 'default' || !ds.card_style ? 'selected' : ''}>Default</option>
                                            <option value="bordered" ${ds.card_style === 'bordered' ? 'selected' : ''}>Bordered</option>
                                            <option value="minimal" ${ds.card_style === 'minimal' ? 'selected' : ''}>Minimal</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 1rem; display: flex; gap: 1.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="edit-display-random" ${ds.random ? 'checked' : ''} style="width: 18px; height: 18px;">
                                        <span style="font-size: 0.85rem;">Randomize order</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="edit-display-show-map" ${ds.show_map ? 'checked' : ''} style="width: 18px; height: 18px;">
                                        <span style="font-size: 0.85rem;">Show map</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="edit-display-show-filters" ${ds.show_filters !== false ? 'checked' : ''} style="width: 18px; height: 18px;">
                                        <span style="font-size: 0.85rem;">Show filters</span>
                                    </label>
                                </div>
                                
                                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 0.75rem;">
                                    <button class="btn btn-secondary" onclick="closeModal('edit-license-modal')">Cancel</button>
                                    <button class="btn" onclick="saveLicenseSettings(${licenseId})">ðŸ’¾ Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('edit-license-modal');
                if (existingModal) existingModal.remove();
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error loading license:', error);
                showNotification('Error loading license: ' + error.message, 'error');
            }
        }
        
        async function saveLicenseSettings(licenseId) {
            const displaySettings = {
                columns: parseInt(document.getElementById('edit-display-columns')?.value || '3'),
                layout: document.getElementById('edit-display-layout')?.value || 'auto',
                limit: parseInt(document.getElementById('edit-display-limit')?.value || '0'),
                background: document.getElementById('edit-display-bg')?.value || 'dark',
                primary_color: document.getElementById('edit-display-primary')?.value || '#2563eb',
                card_style: document.getElementById('edit-display-card-style')?.value || 'default',
                random: document.getElementById('edit-display-random')?.checked || false,
                show_map: document.getElementById('edit-display-show-map')?.checked || false,
                show_filters: document.getElementById('edit-display-show-filters')?.checked !== false
            };
            
            try {
                const response = await fetch(`/api/plugin-licenses/${licenseId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ display_settings: displaySettings })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Settings saved! Changes will apply on next page load on the customer site.', 'success');
                    closeModal('edit-license-modal');
                    loadPluginLicenses();
                } else {
                    showNotification(data.error || 'Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        async function deactivateLicense(licenseId) {
            if (!confirm('Are you sure you want to deactivate this license? The plugin will stop working on the customer site.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/plugin-licenses/${licenseId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('License deactivated', 'success');
                    loadPluginLicenses();
                } else {
                    showNotification(data.error || 'Failed to deactivate', 'error');
                }
            } catch (error) {
                console.error('Error deactivating license:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        async function deleteLicense(licenseId) {
            if (!confirm('Are you sure you want to PERMANENTLY DELETE this license? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/plugin-licenses/${licenseId}/delete`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('License deleted permanently', 'success');
                    loadPluginLicenses();
                } else {
                    showNotification(data.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                console.error('Error deleting license:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        // Master override - update site status
        async function updateSiteStatus(siteId, newStatus) {
            try {
                const response = await fetch(`/api/deployed-sites/${siteId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status: newStatus })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Site status updated to ${newStatus}`, 'success');
                    loadDeployedSites(); // Refresh the list
                } else {
                    showNotification(data.error || 'Failed to update status', 'error');
                }
            } catch (error) {
                console.error('Error updating site status:', error);
                showNotification('Failed to update status', 'error');
            }
        }
        
        async function updateSitePricingTier(siteId, pricingTier) {
            try {
                const response = await fetch(`/api/deployed-sites/${siteId}/pricing-tier`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ pricing_tier: pricingTier })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Pricing tier updated to ${pricingTier}`, 'success');
                    loadDeployedSites(); // Refresh the list
                } else {
                    showNotification(data.error || 'Failed to update pricing tier', 'error');
                }
            } catch (error) {
                console.error('Error updating pricing tier:', error);
                showNotification('Failed to update pricing tier', 'error');
            }
        }
        
        async function deleteDeployedSite(siteId, siteName) {
            // Prevent double-clicks
            if (window.deleteInProgress) {
                console.log('Delete already in progress, ignoring click');
                return;
            }
            
            // Two-step confirmation
            const firstConfirm = confirm(` DELETE "${siteName}"?\n\nThis will permanently remove this website record.\n\nClick OK to proceed to final confirmation.`);
            if (!firstConfirm) return;
            
            const typedName = prompt(`To confirm deletion, type the site name exactly:\n\n${siteName}`);
            if (typedName !== siteName) {
                if (typedName !== null) {
                    showNotification('Site name did not match. Deletion cancelled.', 'error');
                }
                return;
            }
            
            window.deleteInProgress = true;
            
            // Fade out the card immediately to prevent UI bounce
            const card = document.querySelector(`[onclick*="deleteDeployedSite(${siteId}"]`)?.closest('.card');
            if (card) {
                card.style.transition = 'opacity 0.3s, transform 0.3s';
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
            }
            
            try {
                const response = await fetch(`/api/admin/deployed-sites/${siteId}?permanent=true`, {
                    method: 'DELETE'
                });
                
                // Handle non-JSON responses
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error('Non-JSON response:', text);
                    data = { success: false, error: 'Server returned invalid response' };
                }
                
                if (data.success) {
                    // Remove the card with animation
                    if (card) {
                        card.style.height = card.offsetHeight + 'px';
                        card.style.overflow = 'hidden';
                        setTimeout(() => {
                            card.style.height = '0';
                            card.style.padding = '0';
                            card.style.margin = '0';
                            card.style.opacity = '0';
                        }, 50);
                        setTimeout(() => {
                            loadDeployedSites();
                        }, 350);
                    } else {
                        loadDeployedSites();
                    }
                    showNotification('Site deleted successfully', 'success');
                } else {
                    // Restore card if delete failed
                    if (card) {
                        card.style.opacity = '1';
                        card.style.pointerEvents = 'auto';
                    }
                    showNotification('Error: ' + (data.error || 'Failed to delete site'), 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                // Restore card on error
                if (card) {
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                }
                showNotification('Error deleting site: ' + error.message, 'error');
            } finally {
                window.deleteInProgress = false;
            }
        }
        
        async function manageWebsiteRooms(siteId, propertyId, siteName) {
            try {
                // Get all properties and rooms for the account from the deployed-sites endpoint
                const linkedResp = await fetch(`/api/admin/deployed-sites/${siteId}/rooms`, { headers: authHeaders() });
                const linkedData = await linkedResp.json();
                
                const propertyGroups = linkedData.propertyGroups || [];
                const linkedRoomIds = new Set(linkedData.linkedRoomIds || []);
                
                console.log('Property groups:', propertyGroups.length, 'Linked IDs:', linkedData.linkedRoomIds);
                
                if (propertyGroups.length === 0) {
                    showNotification('No properties found for this account', 'error');
                    return;
                }
                
                // Build hierarchical checkbox list
                let checkboxHtml = '';
                propertyGroups.forEach((group, groupIdx) => {
                    const propRooms = group.rooms || [];
                    const allRoomsLinked = propRooms.length > 0 && propRooms.every(r => linkedRoomIds.has(r.id));
                    const someRoomsLinked = propRooms.some(r => linkedRoomIds.has(r.id));
                    
                    checkboxHtml += `
                        <div class="manage-property-group" style="border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.5rem; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); cursor: pointer;" onclick="toggleManagePropertyGroup(${groupIdx})">
                                <input type="checkbox" class="manage-property-checkbox" data-group="${groupIdx}" 
                                    onchange="toggleManagePropertyRooms(${groupIdx}, this.checked); event.stopPropagation();" 
                                    ${allRoomsLinked ? 'checked' : ''} ${someRoomsLinked && !allRoomsLinked ? 'indeterminate' : ''}
                                    style="width: 18px; height: 18px;">
                                <div style="flex: 1;">
                                    <strong>${group.property.name}</strong>
                                    <div style="font-size: 0.75rem; color: #64748b;">${propRooms.length} room${propRooms.length !== 1 ? 's' : ''}</div>
                                </div>
                                <span class="manage-group-arrow" id="manage-arrow-${groupIdx}" style="transition: transform 0.2s;">â–¼</span>
                            </div>
                            <div class="manage-rooms-list" id="manage-rooms-${groupIdx}" style="padding: 0.5rem 1rem 0.5rem 2.5rem; display: none;">
                    `;
                    
                    propRooms.forEach(room => {
                        checkboxHtml += `
                            <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; cursor: pointer;">
                                <input type="checkbox" class="manage-room-checkbox" data-group="${groupIdx}" 
                                    name="website-room" value="${room.id}" 
                                    ${linkedRoomIds.has(room.id) ? 'checked' : ''} 
                                    onchange="updateManagePropertyCheckbox(${groupIdx})"
                                    style="width: 16px; height: 16px;">
                                <div>
                                    <span>${room.name}</span>
                                    <div style="font-size: 0.75rem; color: #64748b;">
                                        ${room.max_guests || '?'} guests Â· ${room.num_bedrooms || '?'} bed Â· Â£${room.base_price || '?'}/night
                                    </div>
                                </div>
                            </label>
                        `;
                    });
                    
                    checkboxHtml += `
                            </div>
                        </div>
                    `;
                });
                
                // Show modal
                const modalHtml = `
                    <div id="manageRoomsModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                        <div style="background: var(--bg-primary); border-radius: 12px; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h3 style="margin: 0 0 1rem;">ðŸ  Manage Properties & Rooms for ${siteName}</h3>
                            <p style="color: #64748b; margin-bottom: 1rem;">Select which properties and rooms to display on this website:</p>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <button onclick="selectAllManageRooms(true)" class="btn btn-secondary btn-small">Select All</button>
                                <button onclick="selectAllManageRooms(false)" class="btn btn-secondary btn-small">Deselect All</button>
                            </div>
                            <div style="margin-bottom: 1.5rem;">
                                ${checkboxHtml}
                            </div>
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                <button onclick="document.getElementById('manageRoomsModal').remove()" class="btn btn-secondary">Cancel</button>
                                <button onclick="saveWebsiteRooms(${siteId})" class="btn btn-primary">ðŸ’¾ Save Changes</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Set indeterminate state for partially selected properties
                propertyGroups.forEach((group, groupIdx) => {
                    updateManagePropertyCheckbox(groupIdx);
                });
                
            } catch (error) {
                showNotification('Failed to load rooms: ' + error.message, 'error');
            }
        }
        
        function toggleManagePropertyGroup(groupIdx) {
            const roomsList = document.getElementById(`manage-rooms-${groupIdx}`);
            const arrow = document.getElementById(`manage-arrow-${groupIdx}`);
            if (roomsList.style.display === 'none') {
                roomsList.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                roomsList.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        function toggleManagePropertyRooms(groupIdx, checked) {
            document.querySelectorAll(`.manage-room-checkbox[data-group="${groupIdx}"]`).forEach(cb => {
                cb.checked = checked;
            });
        }
        
        function updateManagePropertyCheckbox(groupIdx) {
            const roomCheckboxes = document.querySelectorAll(`.manage-room-checkbox[data-group="${groupIdx}"]`);
            const propCheckbox = document.querySelector(`.manage-property-checkbox[data-group="${groupIdx}"]`);
            if (!propCheckbox || roomCheckboxes.length === 0) return;
            
            const checkedCount = Array.from(roomCheckboxes).filter(cb => cb.checked).length;
            propCheckbox.checked = checkedCount === roomCheckboxes.length;
            propCheckbox.indeterminate = checkedCount > 0 && checkedCount < roomCheckboxes.length;
        }
        
        function selectAllManageRooms(select) {
            document.querySelectorAll('.manage-room-checkbox').forEach(cb => cb.checked = select);
            document.querySelectorAll('.manage-property-checkbox').forEach(cb => {
                cb.checked = select;
                cb.indeterminate = false;
            });
        }
        
        async function saveWebsiteRooms(siteId) {
            const checkboxes = document.querySelectorAll('input[name="website-room"]:checked');
            const selectedRoomIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            try {
                const response = await fetch(`/api/admin/deployed-sites/${siteId}/rooms`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ roomIds: selectedRoomIds })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`âœ… Updated! ${selectedRoomIds.length} room(s) now on website`, 'success');
                    document.getElementById('manageRoomsModal').remove();
                    loadDeployedSites();
                } else {
                    showNotification(data.error || 'Failed to update rooms', 'error');
                }
            } catch (error) {
                showNotification('Failed to save: ' + error.message, 'error');
            }
        }
        
        async function openDeployModal() {
            // Reset form
            document.getElementById('deployForm').reset();
            document.getElementById('deploy-progress').style.display = 'none';
            document.getElementById('deploy-result').style.display = 'none';
            document.getElementById('deploy-submit-btn').disabled = false;
            document.getElementById('deploy-submit-btn').textContent = 'ðŸš€ Deploy Site';
            
            // Reset to show standard fields by default
            handleTemplateChange('developer-light');
            
            // Add template change listeners
            document.querySelectorAll('input[name="deploy-template"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    handleTemplateChange(this.value);
                });
            });
            
            const container = document.getElementById('deploy-rooms-container');
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">Loading rooms...</div>';
            
            try {
                // Load properties and rooms
                let propsUrl = '/api/db/properties';
                let roomsUrl = '/api/db/bookable-units';
                
                if (selectedAccountId) {
                    propsUrl += '?account_id=' + selectedAccountId;
                    roomsUrl += '?account_id=' + selectedAccountId;
                }
                
                const [propsRes, roomsRes] = await Promise.all([
                    fetch(propsUrl),
                    fetch(roomsUrl)
                ]);
                
                const propsData = await propsRes.json();
                const roomsData = await roomsRes.json();
                
                const properties = propsData.data || [];
                const rooms = roomsData.data || [];
                
                // Group rooms by property
                deployRoomsData = properties.map(prop => ({
                    property: prop,
                    rooms: rooms.filter(r => r.property_id === prop.id)
                })).filter(group => group.rooms.length > 0);
                
                if (deployRoomsData.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <p>No rooms found for this account</p>
                            <p style="font-size: 0.85rem;">Add rooms to your properties first</p>
                        </div>
                    `;
                    openModal('deployModal');
                    return;
                }
                
                // Build the room selection UI
                let html = '';
                
                deployRoomsData.forEach((group, groupIdx) => {
                    const propRoomCount = group.rooms.length;
                    
                    html += `
                        <div class="deploy-property-group" style="border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.5rem; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); cursor: pointer;" onclick="toggleDeployPropertyGroup(${groupIdx})">
                                <input type="checkbox" class="deploy-property-checkbox" data-group="${groupIdx}" onchange="togglePropertyRooms(${groupIdx}, this.checked); event.stopPropagation();" checked style="width: 18px; height: 18px;">
                                <div style="flex: 1;">
                                    <strong>${group.property.name}</strong>
                                    <div style="font-size: 0.75rem; color: #64748b;">${propRoomCount} room${propRoomCount !== 1 ? 's' : ''}</div>
                                </div>
                                <span class="deploy-group-arrow" id="deploy-arrow-${groupIdx}" style="transition: transform 0.2s;">â–¼</span>
                            </div>
                            <div class="deploy-rooms-list" id="deploy-rooms-${groupIdx}" style="padding: 0.5rem 1rem 0.5rem 2.5rem; display: none;">
                    `;
                    
                    group.rooms.forEach(room => {
                        html += `
                            <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; cursor: pointer;">
                                <input type="checkbox" class="deploy-room-checkbox" data-group="${groupIdx}" data-room-id="${room.id}" data-room-name="${room.name}" data-property-id="${group.property.id}" data-property-name="${group.property.name}" checked style="width: 16px; height: 16px;" onchange="updateDeployRoomCount(); updateDeployPropertyCheckbox(${groupIdx})">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${room.name}</div>
                                    <div style="font-size: 0.75rem; color: #64748b;">
                                        ${room.max_guests ? `${room.max_guests} guests` : ''}
                                    </div>
                                </div>
                            </label>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                updateDeployRoomCount();
                
            } catch (error) {
                console.error('Error loading rooms:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #991b1b;">
                        <p>Error loading rooms</p>
                    </div>
                `;
            }
            
            openModal('deployModal');
        }
        
        function handleTemplateChange(templateValue) {
            const standardFields = document.getElementById('standard-site-fields');
            const pluginOnlyFields = document.getElementById('plugin-only-fields');
            const customBespokeFields = document.getElementById('custom-bespoke-fields');
            const submitBtn = document.getElementById('deploy-submit-btn');
            const siteDetailsFields = document.getElementById('site-details-fields');
            const adminEmailField = document.getElementById('admin-email-field');
            const roomSelectionSection = document.getElementById('room-selection-section');
            
            // Hide all optional sections first
            if (standardFields) standardFields.style.display = 'none';
            if (pluginOnlyFields) pluginOnlyFields.style.display = 'none';
            if (customBespokeFields) customBespokeFields.style.display = 'none';
            
            // Update visual selection on template cards
            document.querySelectorAll('.template-option').forEach(opt => {
                const radio = opt.querySelector('input[type="radio"]');
                if (radio && radio.value === templateValue) {
                    opt.style.borderColor = '#10b981';
                    opt.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.2)';
                } else {
                    opt.style.borderColor = 'var(--border)';
                    opt.style.boxShadow = 'none';
                }
            });
            
            switch(templateValue) {
                case 'plugin-only':
                    // Hide site name/slug for plugin only, keep email and room selection
                    if (siteDetailsFields) siteDetailsFields.style.display = 'none';
                    if (pluginOnlyFields) pluginOnlyFields.style.display = 'block';
                    if (roomSelectionSection) roomSelectionSection.style.display = 'block';
                    submitBtn.textContent = 'ðŸ”Œ Get Plugin License';
                    submitBtn.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)';
                    break;
                    
                case 'custom-bespoke':
                    // Hide site name/slug and room selection, show contact form
                    if (siteDetailsFields) siteDetailsFields.style.display = 'none';
                    if (customBespokeFields) customBespokeFields.style.display = 'block';
                    if (roomSelectionSection) roomSelectionSection.style.display = 'none';
                    submitBtn.textContent = 'âœ¨ Request Custom Quote';
                    submitBtn.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                    break;
                    
                case 'developer-light':
                case 'developer-dark':
                default:
                    // Show all standard fields
                    if (siteDetailsFields) siteDetailsFields.style.display = 'grid';
                    if (standardFields) standardFields.style.display = 'block';
                    if (roomSelectionSection) roomSelectionSection.style.display = 'block';
                    submitBtn.textContent = 'ðŸš€ Deploy Site';
                    submitBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    break;
            }
        }
        
        function openTemplateSelectionModal() {
            // Mark Instant Website as selected product type
            document.getElementById('deploy-template-instant').checked = true;
            
            const modalHtml = `
                <div id="templateSelectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;">
                    <div style="background: var(--bg-primary); border-radius: 16px; padding: 2rem; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="margin: 0; font-size: 1.5rem;">ðŸŽ¨ Choose Your Template</h2>
                            <button onclick="document.getElementById('templateSelectionModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">âœ•</button>
                        </div>
                        
                        <p style="color: #64748b; margin-bottom: 1.5rem;">Select a template style for your instant website</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                            <!-- Light Template -->
                            <div class="template-card" onclick="selectInstantTemplate('developer-light', 'Light')" style="cursor: pointer; border: 2px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s;" id="template-card-light">
                                <div style="aspect-ratio: 16/10; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border);">
                                    <div style="text-align: center; color: #64748b;">
                                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">â˜€ï¸</div>
                                        <div style="font-size: 0.9rem;">Preview Coming Soon</div>
                                    </div>
                                </div>
                                <div style="padding: 1rem; background: white;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="instant-template" value="developer-light" id="template-light" style="width: 18px; height: 18px;">
                                        <label for="template-light" style="font-weight: 600; cursor: pointer;">Light Theme</label>
                                    </div>
                                    <p style="font-size: 0.85rem; color: #64748b; margin: 0.5rem 0 0 1.6rem;">Clean, bright design with white backgrounds</p>
                                </div>
                            </div>
                            
                            <!-- Dark Template -->
                            <div class="template-card" onclick="selectInstantTemplate('developer-dark', 'Dark')" style="cursor: pointer; border: 2px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s;" id="template-card-dark">
                                <div style="aspect-ratio: 16/10; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border);">
                                    <div style="text-align: center; color: #94a3b8;">
                                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">ðŸŒ™</div>
                                        <div style="font-size: 0.9rem;">Preview Coming Soon</div>
                                    </div>
                                </div>
                                <div style="padding: 1rem; background: white;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="instant-template" value="developer-dark" id="template-dark" style="width: 18px; height: 18px;">
                                        <label for="template-dark" style="font-weight: 600; cursor: pointer;">Dark Theme</label>
                                    </div>
                                    <p style="font-size: 0.85rem; color: #64748b; margin: 0.5rem 0 0 1.6rem;">Elegant, modern design with dark backgrounds</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button onclick="document.getElementById('templateSelectionModal').remove()" class="btn btn-secondary">Cancel</button>
                            <button onclick="confirmTemplateSelection()" class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Select & Continue</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Pre-select light by default
            selectInstantTemplate('developer-light', 'Light');
        }
        
        function selectInstantTemplate(value, name) {
            // Update radio buttons
            document.querySelectorAll('input[name="instant-template"]').forEach(r => r.checked = r.value === value);
            
            // Update card styling
            document.querySelectorAll('.template-card').forEach(card => {
                card.style.borderColor = 'var(--border)';
                card.style.boxShadow = 'none';
            });
            
            const selectedCard = document.getElementById(`template-card-${name.toLowerCase()}`);
            if (selectedCard) {
                selectedCard.style.borderColor = '#10b981';
                selectedCard.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.2)';
            }
            
            // Store selection
            window.selectedInstantTemplate = value;
            window.selectedInstantTemplateName = name;
        }
        
        function confirmTemplateSelection() {
            const selectedValue = window.selectedInstantTemplate || 'developer-light';
            const selectedName = window.selectedInstantTemplateName || 'Light';
            
            // Set the hidden radio value
            document.getElementById('deploy-template-instant').value = selectedValue;
            document.getElementById('deploy-template-instant').checked = true;
            
            // Show selected template badge
            document.getElementById('selected-template-badge').style.display = 'block';
            document.getElementById('selected-template-name').textContent = selectedName;
            
            // Highlight the Instant Website card
            handleTemplateChange(selectedValue);
            
            // Close modal
            document.getElementById('templateSelectionModal').remove();
        }
        
        function toggleDeployPropertyGroup(groupIdx) {
            const roomsList = document.getElementById(`deploy-rooms-${groupIdx}`);
            const arrow = document.getElementById(`deploy-arrow-${groupIdx}`);
            
            if (roomsList.style.display === 'none') {
                roomsList.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                roomsList.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        function togglePropertyRooms(groupIdx, checked) {
            const checkboxes = document.querySelectorAll(`.deploy-room-checkbox[data-group="${groupIdx}"]`);
            checkboxes.forEach(cb => cb.checked = checked);
            updateDeployRoomCount();
        }
        
        function updateDeployPropertyCheckbox(groupIdx) {
            const roomCheckboxes = document.querySelectorAll(`.deploy-room-checkbox[data-group="${groupIdx}"]`);
            const propCheckbox = document.querySelector(`.deploy-property-checkbox[data-group="${groupIdx}"]`);
            if (!propCheckbox || roomCheckboxes.length === 0) return;
            
            const checkedCount = Array.from(roomCheckboxes).filter(cb => cb.checked).length;
            propCheckbox.checked = checkedCount === roomCheckboxes.length;
            propCheckbox.indeterminate = checkedCount > 0 && checkedCount < roomCheckboxes.length;
        }
        
        function selectAllDeployRooms() {
            document.querySelectorAll('.deploy-room-checkbox').forEach(cb => cb.checked = true);
            document.querySelectorAll('.deploy-property-checkbox').forEach(cb => {
                cb.checked = true;
                cb.indeterminate = false;
            });
            updateDeployRoomCount();
        }
        
        function deselectAllDeployRooms() {
            document.querySelectorAll('.deploy-room-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.deploy-property-checkbox').forEach(cb => {
                cb.checked = false;
                cb.indeterminate = false;
            });
            updateDeployRoomCount();
        }
        
        function updateDeployRoomCount() {
            const checked = document.querySelectorAll('.deploy-room-checkbox:checked');
            const countEl = document.getElementById('deploy-room-count');
            if (countEl) {
                countEl.textContent = `${checked.length} room${checked.length !== 1 ? 's' : ''} selected`;
                countEl.style.color = checked.length > 0 ? '#10b981' : '#ef4444';
            }
            
            // Update property checkboxes based on room selection
            deployRoomsData.forEach((group, idx) => {
                const groupRooms = document.querySelectorAll(`.deploy-room-checkbox[data-group="${idx}"]`);
                const checkedRooms = document.querySelectorAll(`.deploy-room-checkbox[data-group="${idx}"]:checked`);
                const propCheckbox = document.querySelector(`.deploy-property-checkbox[data-group="${idx}"]`);
                
                if (propCheckbox) {
                    propCheckbox.checked = checkedRooms.length > 0;
                    propCheckbox.indeterminate = checkedRooms.length > 0 && checkedRooms.length < groupRooms.length;
                }
            });
        }
        
        function getSelectedRooms() {
            const selected = [];
            document.querySelectorAll('.deploy-room-checkbox:checked').forEach(cb => {
                selected.push({
                    room_id: parseInt(cb.dataset.roomId),
                    room_name: cb.dataset.roomName,
                    property_id: parseInt(cb.dataset.propertyId),
                    property_name: cb.dataset.propertyName
                });
            });
            return selected;
        }
        
        async function deployNewSite(event) {
            event.preventDefault();
            
            const selectedTemplate = document.querySelector('input[name="deploy-template"]:checked')?.value || 'developer-light';
            const adminEmail = document.getElementById('deploy-admin-email').value;
            
            // Handle Plugin Only
            if (selectedTemplate === 'plugin-only') {
                await handlePluginOnlyRequest(adminEmail);
                return;
            }
            
            // Handle Custom Bespoke
            if (selectedTemplate === 'custom-bespoke') {
                await handleCustomBespokeRequest(adminEmail);
                return;
            }
            
            // Standard site deployment
            const siteName = document.getElementById('deploy-site-name').value;
            const slug = document.getElementById('deploy-slug').value;
            const selectedRooms = getSelectedRooms();
            
            // Validation
            if (selectedRooms.length === 0) {
                showNotification('Please select at least one room', 'error');
                return;
            }
            
            if (!siteName || !slug || !adminEmail) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            // Get unique property IDs
            const propertyIds = [...new Set(selectedRooms.map(r => r.property_id))];
            const roomIds = selectedRooms.map(r => r.room_id);
            
            // Show progress
            document.getElementById('deploy-progress').style.display = 'block';
            document.getElementById('deploy-result').style.display = 'none';
            document.getElementById('deploy-submit-btn').disabled = true;
            document.getElementById('deploy-progress-text').textContent = `Creating site with ${selectedRooms.length} rooms...`;
            
            // Get template options
            const useTheme = document.getElementById('deploy-use-theme').checked;
            const usePlugin = document.getElementById('deploy-use-plugin').checked;
            const enableBlog = document.getElementById('deploy-enable-blog').checked;
            const enableAttractions = document.getElementById('deploy-enable-attractions').checked;
            
            try {
                const response = await fetch('/api/deploy/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        site_name: siteName,
                        property_ids: propertyIds,
                        room_ids: roomIds,
                        rooms: selectedRooms,
                        slug: slug,
                        admin_email: adminEmail,
                        account_id: selectedAccountId,
                        use_theme: useTheme,
                        use_plugin: usePlugin,
                        template: selectedTemplate,
                        enable_blog: enableBlog,
                        enable_attractions: enableAttractions
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('deploy-progress').style.display = 'none';
                
                if (data.success) {
                    document.getElementById('deploy-result').style.display = 'block';
                    
                    let resultHtml = `
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Site URL:</strong> <a href="${data.site.url}" target="_blank">${data.site.url}</a>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Admin URL:</strong> <a href="${data.site.admin_url}" target="_blank">${data.site.admin_url}</a>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Rooms:</strong> ${selectedRooms.length} from ${propertyIds.length} propert${propertyIds.length !== 1 ? 'ies' : 'y'}
                        </div>
                    `;
                    
                    if (data.credentials && data.credentials.password) {
                        resultHtml += `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 4px;">
                                <strong> Save these login credentials:</strong>
                                <div style="margin-top: 0.5rem; font-family: monospace;">
                                    Username: ${data.credentials.username}<br>
                                    Password: ${data.credentials.password}
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('deploy-result-content').innerHTML = resultHtml;
                    document.getElementById('deploy-submit-btn').textContent = ' Done';
                    document.getElementById('deploy-submit-btn').disabled = false;
                    document.getElementById('deploy-submit-btn').onclick = function() { 
                        closeModal('deployModal'); 
                        // Navigate to Deployed Sites view to see the new site
                        const deployedSitesNav = document.querySelector('[data-view="deployed-sites"]');
                        if (deployedSitesNav) {
                            navClick(deployedSitesNav, 'deployed-sites');
                        }
                    };
                    
                    showNotification('Site deployed successfully!', 'success');
                    loadDeployedSites(); // Refresh the list
                } else {
                    document.getElementById('deploy-submit-btn').disabled = false;
                    showNotification(data.error || 'Deployment failed', 'error');
                }
            } catch (error) {
                document.getElementById('deploy-progress').style.display = 'none';
                document.getElementById('deploy-submit-btn').disabled = false;
                showNotification('Deployment failed: ' + error.message, 'error');
            }
        }

        // Copy license key to clipboard
        function copyLicenseKey() {
            const licenseKey = document.getElementById('plugin-license-key');
            if (licenseKey) {
                navigator.clipboard.writeText(licenseKey.textContent).then(() => {
                    showNotification('License key copied!', 'success');
                }).catch(() => {
                    // Fallback
                    const range = document.createRange();
                    range.selectNode(licenseKey);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                    document.execCommand('copy');
                    window.getSelection().removeAllRanges();
                    showNotification('License key copied!', 'success');
                });
            }
        }
        window.copyLicenseKey = copyLicenseKey;

        async function handlePluginOnlyRequest(email) {
            const submitBtn = document.getElementById('deploy-submit-btn');
            const progressDiv = document.getElementById('deploy-progress');
            const resultDiv = document.getElementById('deploy-result');
            
            if (!email) {
                showNotification('Please enter your email address', 'error');
                return;
            }
            
            // Get selected rooms
            const selectedRooms = getSelectedRooms();
            if (selectedRooms.length === 0) {
                showNotification('Please select at least one room', 'error');
                return;
            }
            
            const roomIds = selectedRooms.map(r => r.room_id);
            
            // Get display settings
            const displaySettings = {
                columns: parseInt(document.getElementById('plugin-display-columns')?.value || '3'),
                layout: document.getElementById('plugin-display-layout')?.value || 'auto',
                limit: parseInt(document.getElementById('plugin-display-limit')?.value || '0'),
                background: document.getElementById('plugin-display-bg')?.value || 'dark',
                background_custom: document.getElementById('plugin-display-bg-custom')?.value || '#0f172a',
                primary_color: document.getElementById('plugin-display-primary')?.value || '#2563eb',
                card_style: document.getElementById('plugin-display-card-style')?.value || 'default',
                random: document.getElementById('plugin-display-random')?.checked || false,
                show_map: document.getElementById('plugin-display-show-map')?.checked || false,
                show_filters: document.getElementById('plugin-display-show-filters')?.checked !== false
            };
            
            submitBtn.disabled = true;
            progressDiv.style.display = 'block';
            document.getElementById('deploy-progress-text').textContent = 'Setting up your plugin license...';
            
            try {
                const response = await fetch('/api/plugin-license/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        email: email,
                        account_id: selectedAccountId,
                        room_ids: roomIds,
                        display_settings: displaySettings,
                        product: 'gas-booking-plugin'
                    })
                });
                
                const data = await response.json();
                console.log('Plugin license API response:', data);
                
                if (!data.success) {
                    alert('License creation failed: ' + (data.error || JSON.stringify(data)));
                }
                
                progressDiv.style.display = 'none';
                
                if (data.success) {
                    // Show success result - scroll modal to show result
                    const licenseKey = data.license_key || 'ERROR';
                    const downloadUrl = data.download_url || 'https://github.com/rezintelhelp-hub/gas-booking-plugin/releases';
                    const pluginVersion = data.version || 'latest';
                    
                    // Build the result HTML
                    const resultHTML = `
                        <h4 style="margin: 0 0 0.75rem 0; color: #7c3aed;">ðŸ”Œ Plugin License Created!</h4>
                        <p style="color: #6b21a8; margin: 0 0 1rem 0;">Your GAS Booking Plugin license is now active.</p>
                        <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="margin-bottom: 0.5rem;"><strong>License Key:</strong></div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <code id="plugin-license-key" style="flex: 1; background: #1e293b; color: #22c55e; padding: 0.75rem; border-radius: 4px; word-break: break-all; font-size: 0.9rem;">${licenseKey}</code>
                                <button onclick="navigator.clipboard.writeText('${licenseKey}'); this.textContent='âœ“ Copied!'; setTimeout(() => this.textContent='ðŸ“‹ Copy', 2000);" style="background: #7c3aed; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; white-space: nowrap;">ðŸ“‹ Copy</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                            <a href="${downloadUrl}" class="btn" style="background: #10b981; display: inline-block;" target="_blank">ðŸ“¥ Download Plugin v${pluginVersion}</a>
                        </div>
                        <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 1rem;">
                            <strong style="color: #92400e;">ðŸ“‹ Installation Steps:</strong>
                            <ol style="margin: 0.5rem 0 0 1.25rem; padding: 0; color: #92400e; font-size: 0.9rem;">
                                <li>Download the plugin ZIP file</li>
                                <li>In WordPress: Plugins â†’ Add New â†’ Upload Plugin</li>
                                <li>Upload the ZIP and activate</li>
                                <li>Go to Settings â†’ GAS Booking</li>
                                <li>Enter your license key above</li>
                                <li>Save - your account will be configured automatically</li>
                            </ol>
                        </div>
                    `;
                    
                    // Set content and display
                    resultDiv.innerHTML = resultHTML;
                    resultDiv.style.cssText = 'display: block !important; background: #f3e8ff; border: 2px solid #c084fc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;';
                    
                    // Scroll to make result visible
                    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    submitBtn.textContent = 'âœ… Done - View Licenses';
                    submitBtn.disabled = false;
                    submitBtn.onclick = function() { 
                        closeModal('deployModal');
                        // Go to Plugin Licenses view
                        navClick(null, 'plugin-licenses');
                        loadPluginLicenses();
                    };
                    
                    showNotification('License created successfully!', 'success');
                } else {
                    submitBtn.disabled = false;
                    showNotification(data.error || 'Failed to create license', 'error');
                }
            } catch (error) {
                progressDiv.style.display = 'none';
                submitBtn.disabled = false;
                showNotification('Error: ' + error.message, 'error');
            }
        }
        
        // Toggle custom background color field
        document.getElementById('plugin-display-bg')?.addEventListener('change', function() {
            const customWrapper = document.getElementById('plugin-custom-bg-wrapper');
            if (customWrapper) {
                customWrapper.style.display = this.value === 'custom' ? 'block' : 'none';
            }
        });
        
        async function handleCustomBespokeRequest(email) {
            const submitBtn = document.getElementById('deploy-submit-btn');
            const progressDiv = document.getElementById('deploy-progress');
            const resultDiv = document.getElementById('deploy-result');
            
            const subdomain = document.getElementById('custom-subdomain')?.value?.trim().toLowerCase().replace(/[^a-z0-9-]/g, '') || '';
            const projectDescription = document.getElementById('custom-project-description')?.value || '';
            const referenceUrl = document.getElementById('custom-reference-url')?.value || '';
            const phone = document.getElementById('custom-phone')?.value || '';
            
            if (!email) {
                showNotification('Please enter your email address', 'error');
                return;
            }
            
            if (!subdomain) {
                showNotification('Please choose a subdomain for your site', 'error');
                return;
            }
            
            if (!projectDescription) {
                showNotification('Please describe your project', 'error');
                return;
            }
            
            submitBtn.disabled = true;
            progressDiv.style.display = 'block';
            document.getElementById('deploy-progress-text').textContent = 'Creating your custom site...';
            
            try {
                const response = await fetch('/api/custom-site/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        subdomain: subdomain,
                        email: email,
                        phone: phone,
                        account_id: selectedAccountId,
                        project_description: projectDescription,
                        reference_url: referenceUrl
                    })
                });
                
                const data = await response.json();
                progressDiv.style.display = 'none';
                
                if (data.success) {
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = '#f0fdf4';
                    resultDiv.style.borderColor = '#22c55e';
                    document.getElementById('deploy-result-content').innerHTML = `
                        <h4 style="margin: 0 0 0.75rem 0; color: #166534;">âœ¨ Custom Site Created!</h4>
                        <p style="color: #15803d; margin: 0 0 1rem 0;">Your custom bespoke site is ready for you to explore.</p>
                        
                        <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="margin-bottom: 0.75rem;">
                                <strong>Site URL:</strong><br>
                                <a href="https://${subdomain}.custom.gas.travel" target="_blank" style="color: #2563eb;">https://${subdomain}.custom.gas.travel</a>
                            </div>
                            <div style="margin-bottom: 0.75rem;">
                                <strong>WordPress Admin:</strong><br>
                                <a href="https://${subdomain}.custom.gas.travel/wp-admin" target="_blank" style="color: #2563eb;">https://${subdomain}.custom.gas.travel/wp-admin</a>
                            </div>
                        </div>
                        
                        ${data.credentials ? `
                        <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <strong style="color: #92400e;">ðŸ” Save these login credentials:</strong>
                            <div style="margin-top: 0.5rem; font-family: monospace; background: white; padding: 0.75rem; border-radius: 4px;">
                                <div>Username: <strong>${data.credentials.username}</strong></div>
                                <div>Password: <strong>${data.credentials.password}</strong></div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 1rem;">
                            <strong style="color: #1e40af;">ðŸ“‹ What happens next:</strong>
                            <ol style="margin: 0.5rem 0 0 1.25rem; padding: 0; color: #1e40af; font-size: 0.9rem;">
                                <li>Log in and explore your new site</li>
                                <li>We'll review your project requirements</li>
                                <li>You'll receive a custom quote within 24-48 hours</li>
                                <li>Once approved, we'll start designing your site</li>
                            </ol>
                        </div>
                        
                        <p style="font-size: 0.8rem; color: #64748b; margin: 1rem 0 0 0;">Confirmation sent to ${email}</p>
                    `;
                    submitBtn.textContent = 'âœ… Done';
                    submitBtn.disabled = false;
                    submitBtn.onclick = () => closeModal('deployModal');
                } else {
                    submitBtn.disabled = false;
                    showNotification(data.error || 'Failed to create site', 'error');
                }
            } catch (error) {
                progressDiv.style.display = 'none';
                submitBtn.disabled = false;
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function loadIntegrations() {
            const container = document.getElementById('channel-connections');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                // Fetch actual channel connections for this account
                const response = await fetch('/api/channel-connections' + buildQueryString(), { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.connections && data.connections.length > 0) {
                    let html = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Account</th>
                                        <th>Status</th>
                                        <th>Properties</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    for (const conn of data.connections) {
                        const cmName = conn.cm_code === 'beds24' ? ' Beds24' : 
                                       conn.cm_code === 'hostaway' ? ' Hostaway' : 
                                       conn.cm_code === 'smoobu' ? ' Smoobu' : conn.cm_name;
                        const statusBadge = conn.status === 'active' ? 
                            '<span class="badge badge-success">Active</span>' : 
                            '<span class="badge badge-warning">Inactive</span>';
                        
                        html += `
                            <tr>
                                <td><strong>${cmName}</strong></td>
                                <td>${conn.account_name || 'Unknown'}</td>
                                <td>${statusBadge}</td>
                                <td>${conn.property_count || 0}</td>
                                <td>
                                    <button class="btn btn-secondary btn-small" onclick="refreshCMProperties('${conn.cm_code}', ${conn.id})" title="Check for new/removed properties">
                                         Refresh
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: #64748b;">
                            <p style="margin-bottom: 1rem;">No channel managers connected yet.</p>
                            <button class="btn btn-primary" onclick="openChannelManagerModal()">+ Connect Channel Manager</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading integrations:', error);
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #64748b;">
                        <p>Error loading integrations. <a href="#" onclick="loadIntegrations(); return false;">Retry</a></p>
                    </div>
                `;
            }
            
            // Initialize webhook URL display
            initWebhookUrl();
            
            // Check if Hostaway connection exists to show webhook section
            checkHostawayConnection();
        }
        
        // Refresh properties from Channel Manager
        async function refreshCMProperties(cmCode, connectionId) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = ' Checking...';
            
            try {
                // Get connection details (token) from server
                const connResponse = await fetch(`/api/channel-connection/${connectionId}`, { headers: authHeaders() });
                const connData = await connResponse.json();
                
                if (!connData.success) {
                    throw new Error(connData.error || 'Failed to get connection details');
                }
                
                // Call refresh endpoint
                const response = await fetch(`/api/${cmCode}/refresh-properties`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        token: connData.connection.access_token,
                        apiKey: connData.connection.api_key,
                        accountId: getAccountParam() ? new URLSearchParams(window.location.search).get('account') : connData.connection.account_id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showRefreshResultsModal(data, cmCode, connectionId);
                } else {
                    throw new Error(data.error || 'Failed to refresh properties');
                }
            } catch (error) {
                console.error('Error refreshing:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // Show modal with refresh results
        function showRefreshResultsModal(data, cmCode, connectionId) {
            const cmName = cmCode === 'beds24' ? 'Beds24' : cmCode === 'hostaway' ? 'Hostaway' : 'Smoobu';
            
            let html = `
                <div id="refresh-results-modal" class="modal active">
                    <div class="modal-content" style="max-width: 500px; border-radius: 16px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                            <h3 style="margin: 0;"> ${cmName} Property Comparison</h3>
                            <button class="modal-close" onclick="closeRefreshResultsModal()" style="color: white;"></button>
                        </div>
                        <div class="modal-body">
            `;
            
            // Existing properties
            html += `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="color: #10b981; font-size: 1.2rem;"></span>
                        <strong>${data.existing.length} existing properties matched</strong>
                    </div>
                </div>
            `;
            
            // New properties
            if (data.new.length > 0) {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="color: #3b82f6; font-size: 1.2rem;"></span>
                            <strong>${data.new.length} new properties found:</strong>
                        </div>
                        <div style="background: #eff6ff; border-radius: 8px; padding: 1rem;">
                `;
                
                data.new.forEach((prop, i) => {
                    html += `
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; ${i > 0 ? 'border-top: 1px solid #bfdbfe;' : ''}">
                            <input type="checkbox" class="new-prop-checkbox" data-cm-id="${prop.cm_id}" data-name="${prop.name.replace(/"/g, '&quot;')}" checked>
                            <div>
                                <div style="font-weight: 500;">${prop.name}</div>
                                <div style="font-size: 0.85rem; color: #64748b;">${prop.city || 'No location'}  ${prop.rooms || 1} room(s)</div>
                            </div>
                        </label>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Removed properties
            if (data.removed.length > 0) {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="color: #f59e0b; font-size: 1.2rem;"></span>
                            <strong>${data.removed.length} properties no longer in ${cmName}:</strong>
                        </div>
                        <div style="background: #fef3c7; border-radius: 8px; padding: 1rem;">
                `;
                
                data.removed.forEach((prop, i) => {
                    html += `
                        <div style="padding: 0.5rem 0; ${i > 0 ? 'border-top: 1px solid #fde68a;' : ''}">
                            <div style="font-weight: 500;">${prop.name}</div>
                            <div style="font-size: 0.85rem; color: #92400e;">GAS ID: ${prop.gas_id}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <p style="font-size: 0.85rem; color: #92400e; margin-top: 0.5rem;">
                             Removed properties remain in GAS. You can archive them manually if needed.
                        </p>
                    </div>
                `;
            }
            
            // No changes message
            if (data.new.length === 0 && data.removed.length === 0) {
                html += `
                    <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 8px; color: #166534;">
                         All properties are in sync - no changes detected!
                    </div>
                `;
            }
            
            html += `
                        </div>
                        <div class="modal-footer" style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
            `;
            
            if (data.new.length > 0) {
                html += `<button class="btn btn-primary" onclick="importSelectedNewProperties('${cmCode}', ${connectionId})">Import Selected</button>`;
            }
            
            html += `
                            <button class="btn btn-secondary" onclick="closeRefreshResultsModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeRefreshResultsModal() {
            const modal = document.getElementById('refresh-results-modal');
            if (modal) modal.remove();
        }
        
        async function importSelectedNewProperties(cmCode, connectionId) {
            const checkboxes = document.querySelectorAll('.new-prop-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one property to import');
                return;
            }
            
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = ' Importing...';
            
            try {
                // Get connection details
                const connResponse = await fetch(`/api/channel-connection/${connectionId}`, { headers: authHeaders() });
                const connData = await connResponse.json();
                
                let imported = 0;
                let failed = 0;
                
                for (const checkbox of checkboxes) {
                    const cmId = checkbox.dataset.cmId;
                    const name = checkbox.dataset.name;
                    
                    try {
                        const endpoint = cmCode === 'beds24' ? '/api/beds24/import-complete-property' :
                                        cmCode === 'hostaway' ? '/api/hostaway/import-property' :
                                        '/api/smoobu/import-property';
                        
                        const body = cmCode === 'beds24' ? {
                            propertyId: cmId,
                            connectionId: connectionId,
                            token: connData.connection.access_token
                        } : cmCode === 'hostaway' ? {
                            property: { id: cmId, name: name },
                            token: connData.connection.access_token,
                            connectionId: connectionId
                        } : {
                            apiKey: connData.connection.api_key,
                            apartmentId: cmId,
                            clientId: connData.connection.account_id
                        };
                        
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify(body)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            imported++;
                        } else {
                            failed++;
                        }
                    } catch (e) {
                        failed++;
                    }
                }
                
                closeRefreshResultsModal();
                alert(`Imported ${imported} properties${failed > 0 ? ` (${failed} failed)` : ''}`);
                loadIntegrations();
                
            } catch (error) {
                console.error('Error importing:', error);
                alert('Error importing properties: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Import Selected';
            }
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = '';  // Reset display in case it was set to 'none'
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // List of dynamically created modals that should be removed
                const dynamicModals = ['assignAgencyModal', 'changeRoleModal', 'passwordResetModal'];
                
                if (dynamicModals.includes(modalId)) {
                    modal.remove();
                } else {
                    modal.classList.remove('active');
                    modal.style.display = 'none';
                    // Don't set display:none - let CSS handle visibility via .active class
                }
            }
        }

        let allAmenitiesData = [];
        
        async function openAddAmenityModal() {
            // Load all amenities
            await loadAllAmenitiesData();
            
            // Reset form
            document.getElementById('new-amenity-name').value = '';
            document.getElementById('new-amenity-icon').value = '';
            document.getElementById('new-category-name').value = '';
            document.getElementById('category-amenities-list').style.display = 'none';
            document.getElementById('add-amenity-section').style.display = 'none';
            document.getElementById('amenity-category-select').value = '';
            
            openModal('addAmenityModal');
        }
        
        async function loadAllAmenitiesData() {
            try {
                const response = await fetch('/api/admin/amenities');
                const data = await response.json();
                
                if (data.success && data.amenities) {
                    allAmenitiesData = data.amenities;
                    
                    // Get unique categories
                    const categories = [...new Set(data.amenities.map(a => a.category))].sort();
                    
                    const categoryIcons = {
                        'essentials': '', 'beds': '', 'bathrooms': '', 'kitchen': '',
                        'parking': '', 'entertainment': '', 'wellness': '', 'outdoor': '',
                        'safety': '', 'accessibility': '', 'services': '', 'room_features': ''
                    };
                    
                    const select = document.getElementById('amenity-category-select');
                    select.innerHTML = '<option value="">Choose a category...</option>';
                    
                    categories.forEach(cat => {
                        const icon = categoryIcons[cat] || '';
                        const displayName = cat.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        const count = data.amenities.filter(a => a.category === cat).length;
                        select.innerHTML += `<option value="${cat}">${icon} ${displayName} (${count})</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading amenities:', error);
            }
        }
        
        function loadCategoryAmenities() {
            const category = document.getElementById('amenity-category-select').value;
            const listContainer = document.getElementById('category-amenities-list');
            const amenitiesContainer = document.getElementById('amenities-in-category');
            const addSection = document.getElementById('add-amenity-section');
            
            if (!category) {
                listContainer.style.display = 'none';
                addSection.style.display = 'none';
                return;
            }
            
            // Filter amenities by category
            const categoryAmenities = allAmenitiesData.filter(a => a.category === category);
            
            // Display amenities
            amenitiesContainer.innerHTML = categoryAmenities.map(a => {
                const name = typeof a.amenity_name === 'object' ? a.amenity_name.en : a.amenity_name;
                return `
                    <span style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--bg-card); border-radius: 6px; font-size: 0.9rem;">
                        ${a.icon || ''} ${name}
                        <button onclick="deleteSingleAmenity(${a.id}, '${name.replace(/'/g, "\\'")}')" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0; margin-left: 0.25rem; font-size: 1.1rem; line-height: 1;"></button>
                    </span>
                `;
            }).join('');
            
            listContainer.style.display = 'block';
            addSection.style.display = 'block';
        }
        
        async function deleteSingleAmenity(id, name) {
            if (!confirm(`Delete "${name}"?`)) return;
            
            try {
                const response = await fetch(`/api/admin/amenities/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    await loadAllAmenitiesData();
                    loadCategoryAmenities();
                    loadAmenities();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting amenity:', error);
                alert('Error deleting amenity');
            }
        }
        
        async function addAmenityToCategory() {
            const category = document.getElementById('amenity-category-select').value;
            const name = document.getElementById('new-amenity-name').value.trim();
            const icon = document.getElementById('new-amenity-icon').value.trim();
            
            if (!category || !name) {
                alert('Please select a category and enter an amenity name');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/amenities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ name, category, icon })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('new-amenity-name').value = '';
                    document.getElementById('new-amenity-icon').value = '';
                    await loadAllAmenitiesData();
                    loadCategoryAmenities();
                    loadAmenities(); // Refresh main amenities view
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding amenity:', error);
                alert('Error adding amenity');
            }
        }
        
        async function createNewCategory() {
            const categoryName = document.getElementById('new-category-name').value.trim();
            
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }
            
            // Convert to code format
            const categoryCode = categoryName.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
            
            // Add a placeholder amenity to create the category
            try {
                const response = await fetch('/api/admin/amenities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        name: categoryName + ' (default)', 
                        category: categoryCode, 
                        icon: '' 
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('new-category-name').value = '';
                    await loadAllAmenitiesData();
                    document.getElementById('amenity-category-select').value = categoryCode;
                    loadCategoryAmenities();
                    loadAmenities();
                    alert('Category created! You can now add amenities to it.');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating category:', error);
                alert('Error creating category');
            }
        }
        
        function autoSuggestIcon() {
            const name = document.getElementById('new-amenity-name').value.toLowerCase();
            const iconInput = document.getElementById('new-amenity-icon');
            
            // Only suggest if icon field is empty
            if (iconInput.value) return;
            
            const iconMap = {
                // TV & Entertainment
                'tv': '', 'television': '', 'smart tv': '', 'netflix': '', 'streaming': '',
                'cable': '', 'satellite': '', 'dvd': '', 'blu-ray': '', 'gaming': '',
                'playstation': '', 'xbox': '', 'nintendo': '', 'speaker': '', 'sound': '',
                'bluetooth': '', 'radio': '', 'music': '', 'stereo': '',
                
                // Beds
                'bed': '', 'king': '', 'queen': '', 'double': '', 'single': '',
                'twin': '', 'bunk': '', 'sofa bed': '', 'futon': '', 'cot': '',
                'crib': '', 'mattress': '', 'pillow': '', 'duvet': '', 'blanket': '',
                
                // Bathroom
                'shower': '', 'bath': '', 'bathtub': '', 'toilet': '', 'bidet': '',
                'towel': '', 'hairdryer': '', 'hair dryer': '', 'shampoo': '', 'soap': '',
                'vanity': '', 'mirror': '', 'jacuzzi': '', 'hot tub': '', 'sauna': '',
                
                // Kitchen
                'kitchen': '', 'stove': '', 'oven': '', 'microwave': '', 'fridge': '',
                'refrigerator': '', 'freezer': '', 'dishwasher': '', 'coffee': '',
                'espresso': '', 'kettle': '', 'tea': '', 'toaster': '', 'blender': '',
                'utensils': '', 'cookware': '', 'dishes': '', 'wine': '', 'glasses': '',
                
                // Temperature
                'air conditioning': '', 'ac': '', 'cooling': '', 'heating': '',
                'heater': '', 'fireplace': '', 'fan': '', 'thermostat': '',
                
                // Internet & Tech
                'wifi': '', 'internet': '', 'ethernet': '', 'computer': '',
                'laptop': '', 'desk': '', 'workspace': '', 'printer': '', 'charger': '',
                'usb': '', 'outlet': '', 'phone': '', 'telephone': '',
                
                // Laundry
                'washer': '', 'washing': '', 'dryer': '', 'laundry': '', 'iron': '',
                'ironing': '', 'hanger': '', 'closet': '', 'wardrobe': '',
                
                // Outdoor
                'pool': '', 'swimming': '', 'garden': '', 'patio': '', 'balcony': '',
                'terrace': '', 'deck': '', 'bbq': '', 'grill': '', 'barbecue': '',
                'beach': '', 'lake': '', 'ocean': '', 'view': '', 'mountain': '',
                
                // Parking
                'parking': '', 'garage': '', 'car': '', 'ev': '', 'charging': '',
                'electric': '', 'bike': '', 'bicycle': '',
                
                // Safety
                'safe': '', 'lock': '', 'security': '', 'alarm': '', 'camera': '',
                'smoke': '', 'fire': '', 'extinguisher': '', 'first aid': '',
                'detector': '', 'carbon': '',
                
                // Accessibility
                'wheelchair': '', 'accessible': '', 'elevator': '', 'lift': '',
                'ramp': '', 'grab bar': '', 'step-free': '',
                
                // Pets
                'pet': '', 'dog': '', 'cat': '', 'animal': '',
                
                // Kids
                'child': '', 'kid': '', 'baby': '', 'high chair': '', 'toys': '',
                
                // Wellness
                'gym': '', 'fitness': '', 'yoga': '', 'spa': '', 'massage': '',
                
                // Other
                'key': '', 'keyless': '', 'luggage': '', 'storage': '',
                'breakfast': '', 'food': '', 'dining': '', 'room service': '',
                'concierge': '', 'reception': '', 'housekeeping': '', 'cleaning': ''
            };
            
            // Check for matches
            for (const [keyword, icon] of Object.entries(iconMap)) {
                if (name.includes(keyword)) {
                    iconInput.value = icon;
                    return;
                }
            }
        }
        
        async function deleteAllInCategory() {
            const category = document.getElementById('amenity-category-select').value;
            
            if (!category) {
                alert('Please select a category first');
                return;
            }
            
            const categoryAmenities = allAmenitiesData.filter(a => a.category === category);
            const displayName = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            if (!confirm(`Delete ALL ${categoryAmenities.length} amenities in "${displayName}"?\n\nThis cannot be undone!`)) {
                return;
            }
            
            try {
                let deleted = 0;
                for (const amenity of categoryAmenities) {
                    const response = await fetch(`/api/admin/amenities/${amenity.id}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) deleted++;
                }
                
                alert(`Deleted ${deleted} amenities from ${displayName}`);
                await loadAllAmenitiesData();
                loadCategoryAmenities();
                loadAmenities();
            } catch (error) {
                console.error('Error deleting amenities:', error);
                alert('Error deleting amenities');
            }
        }
        
        async function deleteAllAmenities() {
            const totalCount = allAmenitiesData.length;
            
            if (!confirm(` DELETE ALL ${totalCount} AMENITIES?\n\nThis will remove EVERY amenity from your system.\n\nThis action CANNOT be undone!\n\nType "DELETE" to confirm.`)) {
                return;
            }
            
            const confirmation = prompt('Type DELETE to confirm:');
            if (confirmation !== 'DELETE') {
                alert('Deletion cancelled');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/amenities/delete-all', {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`Deleted ${result.deleted} amenities`);
                    await loadAllAmenitiesData();
                    document.getElementById('amenity-category-select').value = '';
                    document.getElementById('category-amenities-list').style.display = 'none';
                    document.getElementById('add-amenity-section').style.display = 'none';
                    loadAmenities();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting all amenities:', error);
                alert('Error deleting amenities');
            }
        }

        // AVAILABILITY GRID FUNCTIONS
        // ========================================
        
        let gridStartDate = new Date();
        let gridRooms = [];
        let gridData = {}; // roomId -> { date -> data }
        const GRID_DAYS = 14; // Show 2 weeks at a time
        
        let allRooms = []; // Store all rooms for filtering
        let availabilityViewLoaded = false;
        
        async function loadAvailabilityView() {
            // Reset loaded flag when account filter changes
            availabilityViewLoaded = false;
            
            // Set start date to today
            gridStartDate = new Date();
            gridStartDate.setHours(0, 0, 0, 0);
            
            // Set default edit dates
            const today = new Date();
            document.getElementById('edit-from-date').value = today.toISOString().split('T')[0];
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('edit-to-date').value = nextWeek.toISOString().split('T')[0];
            
            // Load properties for filter (filtered by account)
            try {
                const queryString = buildQueryString();
                const propsResponse = await fetch(`/api/db/properties${queryString}`);
                const propsData = await propsResponse.json();
                
                const propFilter = document.getElementById('grid-property-filter');
                if (propFilter && propsData.success) {
                    propFilter.innerHTML = '<option value="">All Properties</option>' +
                        propsData.data.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
            
            // Load rooms (filtered by account) - include hidden for toggle functionality
            try {
                let queryString = buildQueryString();
                // Add include_hidden to get all rooms, we'll filter in JS based on checkbox
                queryString = queryString ? `${queryString}&include_hidden=true` : '?include_hidden=true';
                const response = await fetch(`/api/db/bookable-units${queryString}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    allRooms = data.data;
                    // Filter out hidden rooms by default
                    const showHidden = document.getElementById('show-hidden-rooms')?.checked || false;
                    gridRooms = showHidden ? data.data : data.data.filter(r => !r.is_hidden);
                    
                    // Populate edit room select (only visible rooms by default)
                    const select = document.getElementById('edit-room-select');
                    select.innerHTML = '<option value="">All Rooms</option>' +
                        gridRooms.map(r => `<option value="${r.id}">${r.name}${r.is_hidden ? ' (hidden)' : ''}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
            
            await loadGridData();
        }
        
        function filterGridByProperty() {
            const propFilter = document.getElementById('grid-property-filter');
            const propertyId = propFilter.value;
            const showHidden = document.getElementById('show-hidden-rooms')?.checked || false;
            
            console.log('=== FILTER DEBUG ===');
            console.log('Selected property ID:', propertyId);
            console.log('Show hidden:', showHidden);
            console.log('allRooms count:', allRooms.length);
            
            // Start with all rooms
            let filteredRooms = [...allRooms];
            
            // Filter by property if selected
            if (propertyId) {
                filteredRooms = filteredRooms.filter(r => String(r.property_id) === String(propertyId));
                console.log('After property filter:', filteredRooms.length, 'rooms');
            }
            
            // Filter out hidden rooms unless checkbox is checked
            if (!showHidden) {
                filteredRooms = filteredRooms.filter(r => !r.is_hidden);
                console.log('After hidden filter:', filteredRooms.length, 'rooms');
            }
            
            gridRooms = filteredRooms;
            console.log('Final gridRooms:', gridRooms.length, 'rooms');
            
            // Update edit room select with filtered rooms
            const select = document.getElementById('edit-room-select');
            select.innerHTML = '<option value="">All Rooms</option>' +
                gridRooms.map(r => `<option value="${r.id}">${r.name}${r.is_hidden ? ' (hidden)' : ''}</option>`).join('');
            
            // Make sure we preserve the dropdown selection
            propFilter.value = propertyId;
            
            loadGridData();
        }
        
        function shiftGridDays(days) {
            gridStartDate.setDate(gridStartDate.getDate() + days);
            loadGridData();
        }
        
        function jumpToDate(dateStr) {
            if (dateStr) {
                gridStartDate = new Date(dateStr);
                loadGridData();
            }
        }
        
        function jumpToMonth(monthStr) {
            if (monthStr) {
                gridStartDate = new Date(monthStr + '-01');
                loadGridData();
            }
        }
        
        function populateMonthSelector() {
            const select = document.getElementById('grid-month-select');
            if (!select) return;
            
            select.innerHTML = '';
            const today = new Date();
            const currentMonth = gridStartDate.getMonth();
            const currentYear = gridStartDate.getFullYear();
            
            // Generate 12 months from today
            for (let i = 0; i < 12; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const value = date.toISOString().slice(0, 7); // YYYY-MM
                const label = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }
        
        function goToToday() {
            gridStartDate = new Date();
            gridStartDate.setHours(0, 0, 0, 0);
            loadGridData();
        }
        
        async function refreshCalendar() {
            // Refresh calendar data without changing the current date position
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³';
            btn.disabled = true;
            
            try {
                await loadGridData();
            } finally {
                btn.innerHTML = 'ðŸ”„';
                btn.disabled = false;
            }
        }
        
        async function loadGridData() {
            const fromDate = gridStartDate.toISOString().split('T')[0];
            const endDate = new Date(gridStartDate);
            endDate.setDate(endDate.getDate() + GRID_DAYS - 1);
            const toDate = endDate.toISOString().split('T')[0];
            
            // Update date range display and date picker with month name
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const startMonth = monthNames[gridStartDate.getMonth()];
            const endMonth = monthNames[endDate.getMonth()];
            const startYear = gridStartDate.getFullYear();
            const endYear = endDate.getFullYear();
            
            let dateRangeText = '';
            if (startMonth === endMonth && startYear === endYear) {
                dateRangeText = `${startMonth} ${startYear} (${gridStartDate.getDate()} - ${endDate.getDate()})`;
            } else if (startYear === endYear) {
                dateRangeText = `${startMonth} ${gridStartDate.getDate()} - ${endMonth} ${endDate.getDate()}, ${startYear}`;
            } else {
                dateRangeText = `${startMonth} ${gridStartDate.getDate()}, ${startYear} - ${endMonth} ${endDate.getDate()}, ${endYear}`;
            }
            
            const dateRangeEl = document.getElementById('grid-date-range');
            if (dateRangeEl) dateRangeEl.textContent = dateRangeText;
            
            const datePickerEl = document.getElementById('grid-date-picker');
            if (datePickerEl) datePickerEl.value = fromDate;
            
            // Update month selector
            populateMonthSelector();
            
            // Load availability for all rooms
            gridData = {};
            
            for (const room of gridRooms) {
                try {
                    const response = await fetch(`/api/availability/${room.id}?from=${fromDate}&to=${toDate}`);
                    const data = await response.json();
                    
                    if (data.success && data.availability) {
                        gridData[room.id] = {};
                        data.availability.forEach(a => {
                            gridData[room.id][a.date] = a;
                        });
                    }
                } catch (error) {
                    console.error(`Error loading availability for room ${room.id}:`, error);
                }
            }
            
            renderGrid();
        }
        
        function renderGrid() {
            const table = document.getElementById('availability-grid');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate dates array
            const dates = [];
            for (let i = 0; i < GRID_DAYS; i++) {
                const d = new Date(gridStartDate);
                d.setDate(d.getDate() + i);
                dates.push(d);
            }
            
            // Build header row
            let html = '<thead><tr>';
            html += '<th style="position: sticky; left: 0; background: #f9fafb; z-index: 10; padding: 8px; min-width: 180px; text-align: left; font-weight: 600; color: #374151;">Room</th>';
            html += '<th style="padding: 4px; min-width: 45px; text-align: center; background: #f9fafb;">Row</th>';
            
            dates.forEach(d => {
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = d.getDate();
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const isToday = d.getTime() === today.getTime();
                
                html += `<th style="padding: 4px 2px; min-width: 52px; text-align: center; font-weight: normal; 
                    background: ${isWeekend ? '#f3f4f6' : '#f9fafb'};
                    ${isToday ? 'background: #dbeafe; font-weight: 600;' : ''}">
                    <div style="font-size: 0.65rem; color: #9ca3af;">${dayName}</div>
                    <div style="color: #374151;">${dayNum}</div>
                </th>`;
            });
            html += '</tr></thead>';
            
            // Build body rows - one row per room per data type
            html += '<tbody>';
            
            gridRooms.forEach(room => {
                const roomData = gridData[room.id] || {};
                
                // Row 1: Status (Available/Blocked/Booked)
                html += '<tr>';
                html += `<td rowspan="2" style="position: sticky; left: 0; background: #ffffff; z-index: 5; padding: 8px; font-weight: 500; border-bottom: 2px solid #e5e7eb; color: #1f2937;">${room.name}</td>`;
                html += `<td rowspan="2" style="padding: 4px; text-align: center; background: #fafafa; border-bottom: 2px solid #e5e7eb;">
                    <button onclick="syncRoomPricing(${room.id}, '${room.name}')" class="btn btn-sm" style="padding: 2px 6px; font-size: 0.7rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Sync pricing from channel manager">&#8635;</button>
                </td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = roomData[dateStr];
                    const isPast = d < today;
                    
                    let bgColor = '#d1fae5'; // green - available
                    let text = '';
                    let textColor = '#065f46';
                    let isBooked = false;
                    let bookingId = null;
                    
                    if (dayData) {
                        if (dayData.is_booked || (!dayData.is_available && !dayData.is_blocked)) {
                            bgColor = '#fee2e2'; // red - booked
                            text = dayData.guest_name ? dayData.guest_name.split(' ')[0] : '';
                            textColor = '#991b1b';
                            isBooked = true;
                            bookingId = dayData.booking_id || null;
                        } else if (dayData.is_blocked) {
                            bgColor = '#fef3c7'; // yellow
                            text = '';
                            textColor = '#92400e';
                        }
                    }
                    
                    if (isPast) {
                        bgColor = '#f3f4f6';
                        textColor = '#9ca3af';
                    }
                    
                    // If booked, clicking opens booking detail; otherwise select date range
                    const clickHandler = isBooked && bookingId 
                        ? `openBookingDetail(${bookingId})`
                        : `selectDateRange('${room.id}', '${dateStr}')`;
                    const cursorStyle = isPast ? 'default' : 'pointer';
                    const titleAttr = isBooked && dayData.guest_name ? `title="View booking: ${dayData.guest_name}"` : '';
                    
                    html += `<td style="padding: 2px; text-align: center; background: ${bgColor}; color: ${textColor}; font-size: 0.7rem; cursor: ${cursorStyle};"
                        ${titleAttr}
                        onclick="${clickHandler}">${text}</td>`;
                });
                html += '</tr>';
                
                // Row 2: Price
                html += '<tr style="border-bottom: 2px solid #e5e7eb;">';
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = roomData[dateStr];
                    const isPast = d < today;
                    
                    let priceText = '-';
                    let priceStyle = 'color: #64748b;';
                    
                    if (dayData && !isPast) {
                        if (dayData.direct_price && dayData.cm_price && dayData.direct_price != dayData.cm_price) {
                            // Show direct price in green (discounted)
                            priceText = `${Math.round(dayData.direct_price)}`;
                            priceStyle = 'color: #10b981; font-weight: 500;';
                        } else if (dayData.cm_price) {
                            priceText = `${Math.round(dayData.cm_price)}`;
                        } else if (dayData.direct_price) {
                            priceText = `${Math.round(dayData.direct_price)}`;
                        }
                    }
                    
                    html += `<td style="padding: 2px; text-align: center; font-size: 0.7rem; ${priceStyle} ${isPast ? 'opacity: 0.4;' : ''}">${priceText}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        async function syncRoomPricing(roomId, roomName) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³';
            btn.disabled = true;
            
            try {
                // Get the room's property ID first
                const roomResponse = await fetch(`/api/db/rooms/${roomId}`, { headers: authHeaders() });
                const roomData = await roomResponse.json();
                
                if (!roomData.success || !roomData.data) {
                    throw new Error('Room not found');
                }
                
                const propertyId = roomData.data.property_id;
                
                // Get the sync property ID from gas_sync_properties
                const syncPropResponse = await fetch(`/api/gas-sync/property-by-gas-id/${propertyId}`, { headers: authHeaders() });
                const syncPropData = await syncPropResponse.json();
                
                if (!syncPropData.success || !syncPropData.syncPropertyId) {
                    throw new Error('Sync property not found - is this property linked to a channel manager?');
                }
                
                // Call the pricing sync endpoint
                const syncResponse = await fetch(`/api/gas-sync/properties/${syncPropData.syncPropertyId}/sync-prices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ force: true })
                });
                const syncResult = await syncResponse.json();
                
                if (syncResult.success) {
                    showNotification(`âœ… Synced pricing for ${roomName}: ${syncResult.daysUpdated || 0} days updated`, 'success');
                    // Reload the grid data
                    await loadGridData();
                } else {
                    showNotification(syncResult.error || 'Sync failed', 'error');
                }
            } catch (error) {
                showNotification(`Failed to sync: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = '&#8635;';
                btn.disabled = false;
            }
        }
        
        function selectDateRange(roomId, dateStr) {
            document.getElementById('edit-room-select').value = roomId;
            document.getElementById('edit-from-date').value = dateStr;
            document.getElementById('edit-to-date').value = dateStr;
        }
        
        function toggleEditInputs() {
            const action = document.getElementById('edit-action').value;
            document.getElementById('edit-price-group').style.display = action === 'price' ? 'block' : 'none';
            document.getElementById('edit-discount-group').style.display = action === 'discount' ? 'block' : 'none';
        }
        
        async function applyQuickEdit() {
            const roomId = document.getElementById('edit-room-select').value;
            const fromDate = document.getElementById('edit-from-date').value;
            const toDate = document.getElementById('edit-to-date').value;
            const action = document.getElementById('edit-action').value;
            const price = document.getElementById('edit-price').value;
            const discount = document.getElementById('edit-discount').value;
            
            if (!fromDate || !toDate) return alert('Please select dates');
            
            // Determine which rooms to update
            const roomsToUpdate = roomId ? [roomId] : gridRooms.map(r => r.id);
            
            let totalUpdated = 0;
            
            for (const rid of roomsToUpdate) {
                const payload = {
                    room_id: rid,
                    from_date: fromDate,
                    to_date: toDate,
                    status: (action === 'block') ? 'blocked' : 'available'
                };
                
                if (action === 'price' && price) {
                    payload.price = price;
                } else if (action === 'discount' && discount) {
                    payload.discount_percent = discount;
                }
                
                try {
                    const response = await fetch('/api/admin/availability', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.success) {
                        totalUpdated += result.days_updated;
                    }
                } catch (error) {
                    console.error('Error updating:', error);
                }
            }
            
            alert(`Updated ${totalUpdated} day(s) across ${roomsToUpdate.length} room(s)`);
            loadGridData();
        }
        
        async function syncBeds24() {
            if (!confirm('Sync bookings from Beds24? (Fast - just new bookings)')) return;
            
            const btn = document.getElementById('sync-beds24-btn');
            btn.disabled = true;
            btn.textContent = ' Syncing...';
            
            let message = '';
            
            try {
                // First sync prices/availability
                btn.textContent = ' Syncing prices...';
                const priceResponse = await fetch('/api/admin/sync-all-availability-quick', { method: 'POST', headers: authHeaders() });
                const priceResult = await priceResponse.json();
                
                if (priceResult.success) {
                    message += ` Prices: ${priceResult.roomsCount || 0} rooms synced\n`;
                } else {
                    message += ` Price sync: ${priceResult.error || 'Failed'}\n`;
                }
                
                // Sync bookings
                btn.textContent = ' Syncing bookings...';
                const bookingResponse = await fetch('/api/admin/sync-beds24-bookings', { method: 'POST', headers: authHeaders() });
                const bookingResult = await bookingResponse.json();
                
                if (bookingResult.success) {
                    message += ` Bookings: ${bookingResult.bookingsFound || 0} found, ${bookingResult.datesUpdated || 0} blocked, ${bookingResult.datesUnblocked || 0} unblocked`;
                    if (bookingResult.gasBookingsCancelled > 0) {
                        message += `\n ${bookingResult.gasBookingsCancelled} GAS bookings marked cancelled`;
                    }
                } else {
                    message += ` Booking sync: ${bookingResult.error || 'Failed'}`;
                }
                
                alert(' Beds24 Sync complete!\n\n' + message);
            } catch (error) {
                alert(` Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = ' Beds24';
            loadGridData();
        }
        
        async function syncBeds24FullInventory() {
            // Get selected property
            const propertyId = document.getElementById('grid-property-filter')?.value;
            
            if (!propertyId) {
                alert('âš ï¸ Please select a property first.\n\nThe Full sync is property-specific to use the correct Beds24 credentials.');
                return;
            }
            
            const propertyName = document.getElementById('grid-property-filter')?.selectedOptions[0]?.text || 'Selected property';
            
            if (!confirm(`Run FULL Pricing & Availability sync for "${propertyName}"?\n\nThis syncs prices and availability for 365 days. May take 1-2 minutes.`)) return;
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'â³ Syncing...';
            
            try {
                const response = await fetch('/api/admin/sync-beds24-full-pricing', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ propertyId: parseInt(propertyId) })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`âœ… Full Pricing Sync Complete!\n\nðŸ“Š ${result.roomsSynced || 0} rooms synced\nðŸ“… ${result.totalDaysUpdated || 0} days updated${result.errors?.length ? '\n\nâš ï¸ Some errors occurred' : ''}`);
                } else {
                    alert(`âŒ Sync failed: ${result.error}`);
                }
            } catch (error) {
                alert(`âŒ Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = originalText;
            loadGridData();
        }
        
        async function syncHostaway() {
            if (!confirm('Sync availability and pricing from Hostaway?')) return;
            
            const btn = document.getElementById('sync-hostaway-btn');
            btn.disabled = true;
            btn.textContent = ' Syncing...';
            
            try {
                const response = await fetch('/api/admin/sync-hostaway-availability', { method: 'POST', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    alert(` Hostaway Sync complete!\n\n${result.roomsSynced} listings\n${result.totalPricesUpdated} prices`);
                } else {
                    alert(` Hostaway Sync failed: ${result.error}`);
                }
            } catch (error) {
                alert(` Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = ' Hostaway';
            loadGridData();
        }

        async function syncSmoobu() {
            if (!confirm('Sync availability and pricing from Smoobu?')) return;
            
            const btn = document.getElementById('sync-smoobu-btn');
            btn.disabled = true;
            btn.textContent = ' Syncing...';
            
            try {
                const response = await fetch('/api/admin/sync-smoobu-availability', { method: 'POST', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    alert(` Smoobu Sync complete!\n\n${result.roomsSynced || result.apartmentsSynced || 0} apartments\n${result.totalPricesUpdated || 0} prices updated`);
                } else {
                    alert(` Smoobu Sync failed: ${result.error}`);
                }
            } catch (error) {
                alert(` Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = ' Smoobu';
            loadGridData();
        }

        // =====================================================
        // OFFERS FUNCTIONS
        // =====================================================
        
        let offersStartDate = new Date();
        offersStartDate.setHours(0, 0, 0, 0);
        
        async function loadOffers() {
            // Load properties dropdown (filtered by account)
            try {
                const queryString = buildQueryString();
                const propsResponse = await fetch(`/api/db/properties${queryString}`);
                const propsData = await propsResponse.json();
                
                const propSelect = document.getElementById('offers-property-select');
                if (propSelect) {
                    propSelect.innerHTML = '<option value="">Select Property...</option>';
                    if (propsData.success && propsData.data) {
                        propsData.data.forEach(p => {
                            propSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadOffersRooms() {
            const propertyId = document.getElementById('offers-property-select').value;
            const roomSelect = document.getElementById('offers-room-select');
            
            roomSelect.innerHTML = '<option value="">Select Room...</option>';
            document.getElementById('offers-pricing-grid').innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">Select a room to view pricing</p>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const rooms = data.data.filter(r => r.property_id == propertyId);
                    rooms.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}" data-property-id="${r.property_id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadOffersPricingGrid() {
            const roomId = document.getElementById('offers-room-select').value;
            const container = document.getElementById('offers-pricing-grid');
            const distributionCard = document.getElementById('offer-distribution-card');
            
            if (!roomId) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">Select a room to view pricing</p>';
                distributionCard.style.display = 'none';
                return;
            }
            
            // Calculate date range (14 days)
            const dates = [];
            for (let i = 0; i < 14; i++) {
                const d = new Date(offersStartDate);
                d.setDate(d.getDate() + i);
                dates.push(d);
            }
            
            const fromDate = dates[0].toISOString().split('T')[0];
            const toDate = dates[dates.length - 1].toISOString().split('T')[0];
            
            try {
                // Get availability data
                const response = await fetch(`/api/availability/${roomId}?from=${fromDate}&to=${toDate}`);
                const data = await response.json();
                
                // Get currency from response (defaults to  for UK properties)
                const currencySymbol = data.currency_symbol || '';
                
                // Get occupancy settings for this room
                let occupancySettings = {};
                try {
                    const occResponse = await fetch(`/api/rooms/${roomId}/occupancy-settings`);
                    const occData = await occResponse.json();
                    if (occData.success) {
                        occupancySettings = occData.data;
                    }
                } catch (e) {
                    console.log('Could not load occupancy settings:', e);
                }
                
                // Attach occupancy settings to data for grid rendering
                data.occupancy_settings = occupancySettings;
                data.currency_symbol = currencySymbol;
                
                // Get offers for this room
                const offersQueryString = buildQueryString();
                const offersResponse = await fetch(`/api/admin/offers${offersQueryString}`);
                const offersData = await offersResponse.json();
                
                // Get property_id for this room
                const roomSelect = document.getElementById('offers-room-select');
                const selectedOption = roomSelect.options[roomSelect.selectedIndex];
                const roomPropertyId = selectedOption ? selectedOption.dataset.propertyId : null;
                
                // Filter offers by property_id AND room_id
                const roomOffers = (offersData.data || []).filter(o => {
                    // Check property match - offer applies if no property_id OR matches this room's property
                    const propertyMatch = !o.property_id || o.property_id == roomPropertyId;
                    // Check room match - offer applies if no room_id OR matches this room
                    const roomMatch = !o.room_id || o.room_id == roomId;
                    return propertyMatch && roomMatch;
                });
                
                // Ensure "Standard Price" offer exists (create virtually if not in DB)
                let standardOffer = roomOffers.find(o => o.name === 'Standard Price');
                const otherOffers = roomOffers.filter(o => o.name !== 'Standard Price' && o.active);
                
                // Build the new grid
                let html = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 900px;">
                            <thead>
                                <tr style="background: var(--bg-secondary);">
                                    <th style="padding: 0.75rem; text-align: left; position: sticky; left: 0; background: var(--bg-secondary); min-width: 180px; z-index: 2;">PRICE TYPE</th>
                `;
                
                // Date headers
                dates.forEach(d => {
                    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                    const dayNum = d.getDate();
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<th style="padding: 0.5rem; text-align: center; min-width: 75px; ${isWeekend ? 'background: #fef3c7;' : ''}">${dayName}<br><span style="font-size: 1.1rem;">${dayNum}</span></th>`;
                });
                
                html += `</tr></thead><tbody>`;
                
                // 
                // ROW 1: Reference (CM) - LOCKED
                // 
                html += `
                    <tr style="background: #f1f5f9; border-bottom: 2px solid #cbd5e1;">
                        <td style="padding: 0.75rem; position: sticky; left: 0; background: #f1f5f9; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;"></span>
                                <div>
                                    <strong>Reference (CM)</strong>
                                    <div style="font-size: 0.75rem; color: #64748b;">Locked - from Channel Manager</div>
                                </div>
                            </div>
                        </td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                    const refPrice = dayData.cm_price || '-';
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<td style="padding: 0.75rem; text-align: center; background: ${isWeekend ? '#fef9e7' : '#f1f5f9'}; color: #475569; font-weight: 600;">
                        ${refPrice !== '-' ? currencySymbol + parseFloat(refPrice).toFixed(0) : '-'}
                    </td>`;
                });
                html += `</tr>`;
                
                // 
                // ROW 1b: Min Stay (CM) - Shows CM min stay, editable override
                // 
                html += `
                    <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 0.5rem 0.75rem; position: sticky; left: 0; background: #f8fafc; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1rem;"></span>
                                <div>
                                    <strong style="font-size: 0.85rem;">Min Stay</strong>
                                    <div style="font-size: 0.7rem; color: #64748b;">CM default / Override</div>
                                </div>
                            </div>
                        </td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                    const cmMinStay = dayData.cm_min_stay || dayData.min_stay || 1;
                    const override = dayData.min_stay_override;
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<td style="padding: 0.25rem; text-align: center; background: ${isWeekend ? '#fef9e7' : '#f8fafc'}; font-size: 0.85rem;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                            <span style="color: #94a3b8; font-size: 0.7rem;">${cmMinStay}</span>
                            <input type="number" 
                                value="${override || ''}" 
                                data-room="${roomId}" 
                                data-date="${dateStr}"
                                data-field="min_stay"
                                class="min-stay-input"
                                style="width: 40px; padding: 0.2rem; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.8rem;"
                                onchange="markMinStayChanged(this)"
                                placeholder="-"
                                min="1"
                                max="30">
                        </div>
                    </td>`;
                });
                html += `</tr>`;
                
                // 
                // ROW 2: Standard Price - YOUR BASE WEBSITE PRICE, EDITABLE
                // 
                html += `
                    <tr style="background: #f0fdf4; border-bottom: 2px solid #86efac;">
                        <td style="padding: 0.75rem; position: sticky; left: 0; background: #f0fdf4; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;"></span>
                                <div>
                                    <strong style="color: #166534;">Standard Price</strong>
                                    <div style="font-size: 0.75rem; color: #15803d;">Displayed on your website - editable</div>
                                </div>
                            </div>
                        </td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                    const stdPrice = dayData.standard_price || dayData.cm_price || '';
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<td style="padding: 0.25rem; text-align: center; background: ${isWeekend ? '#ecfdf5' : '#f0fdf4'};">
                        <input type="number" 
                            value="${stdPrice ? parseFloat(stdPrice).toFixed(0) : ''}" 
                            data-room="${roomId}" 
                            data-date="${dateStr}"
                            data-original="${stdPrice ? parseFloat(stdPrice).toFixed(0) : ''}"
                            class="standard-price-input"
                            style="width: 65px; padding: 0.4rem; text-align: center; border: 1px solid #86efac; border-radius: 4px; font-weight: 500;"
                            onchange="markPriceChanged(this)"
                            placeholder="-">
                    </td>`;
                });
                html += `</tr>`;
                
                // 
                // OCCUPANCY PRICING SECTION - Based on room settings
                // 
                const occSettings = data.occupancy_settings || {};
                const pricingMode = occSettings.pricing_mode || 'per_room';
                const maxGuests = occSettings.max_guests || 4;
                const baseOccupancy = occSettings.base_occupancy || 2;
                
                html += `
                    <tr>
                        <td colspan="${dates.length + 1}" style="padding: 0.5rem 0.75rem; background: #ede9fe; border-top: 2px solid #c4b5fd;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1rem;"></span>
                                    <strong style="color: #5b21b6;">OCCUPANCY PRICING</strong>
                                    <span style="font-size: 0.75rem; color: #7c3aed; background: white; padding: 0.15rem 0.5rem; border-radius: 10px;">
                                        ${pricingMode === 'per_occupancy' ? 'Active' : 'Per Room (flat)'}
                                    </span>
                                </div>
                                <button onclick="openOccupancySettings(${roomId})" class="btn btn-small" style="font-size: 0.75rem; padding: 0.25rem 0.75rem; background: #7c3aed; border-color: #7c3aed;">
                                     Configure
                                </button>
                            </div>
                        </td>
                    </tr>`;
                
                // Only show occupancy rows if pricing_mode is 'per_occupancy'
                if (pricingMode === 'per_occupancy') {
                    // Generate rows for each occupancy level
                    for (let guests = 1; guests <= maxGuests; guests++) {
                        const isBase = guests === baseOccupancy;
                        const label = guests === 1 ? '1 Adult' : `${guests} Guests`;
                        const sublabel = isBase ? '(base rate)' : (guests < baseOccupancy ? 'discount applied' : 'extra charge');
                        
                        html += `
                            <tr style="background: #faf5ff; border-bottom: 1px solid #e9d5ff;">
                                <td style="padding: 0.5rem 0.75rem; position: sticky; left: 0; background: #faf5ff; z-index: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding-left: 1rem;">
                                        <span style="font-size: 0.9rem;">${''.repeat(Math.min(guests, 4))}</span>
                                        <div>
                                            <span style="font-weight: ${isBase ? '600' : '400'}; color: ${isBase ? '#5b21b6' : '#6b7280'};">${label}</span>
                                            <div style="font-size: 0.65rem; color: #9ca3af;">${sublabel}</div>
                                        </div>
                                    </div>
                                </td>`;
                        
                        dates.forEach(d => {
                            const dateStr = d.toISOString().split('T')[0];
                            const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                            const stdPrice = parseFloat(dayData.standard_price || dayData.cm_price) || 0;
                            
                            // Calculate occupancy-adjusted price
                            let adjPrice = stdPrice;
                            // Single discount only applies when base occupancy is more than 1
                            // (i.e., room is for 2+ people but only 1 is staying)
                            if (guests === 1 && baseOccupancy > 1 && parseFloat(occSettings.single_discount_value) > 0) {
                                // Single occupancy discount
                                if (occSettings.single_discount_type === 'percent') {
                                    adjPrice = stdPrice * (1 - parseFloat(occSettings.single_discount_value) / 100);
                                } else {
                                    adjPrice = stdPrice - parseFloat(occSettings.single_discount_value);
                                }
                            } else if (guests > baseOccupancy) {
                                // Extra guests charge
                                const extraGuests = guests - baseOccupancy;
                                if (occSettings.extra_adult_type === 'percent') {
                                    adjPrice = stdPrice * (1 + (parseFloat(occSettings.extra_adult_charge) / 100) * extraGuests);
                                } else {
                                    adjPrice = stdPrice + (parseFloat(occSettings.extra_adult_charge) * extraGuests);
                                }
                            }
                            
                            const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                            const priceColor = isBase ? '#5b21b6' : (adjPrice < stdPrice ? '#16a34a' : (adjPrice > stdPrice ? '#dc2626' : '#6b7280'));
                            
                            html += `<td style="padding: 0.5rem; text-align: center; background: ${isWeekend ? '#f5f3ff' : '#faf5ff'}; color: ${priceColor}; font-size: 0.85rem;">
                                ${stdPrice > 0 ? currencySymbol + Math.round(adjPrice) : '-'}
                            </td>`;
                        });
                        html += `</tr>`;
                    }
                } else {
                    // Just show a helper row when per_room mode
                    html += `
                        <tr style="background: #faf5ff;">
                            <td colspan="${dates.length + 1}" style="padding: 0.75rem; text-align: center; color: #7c3aed; font-size: 0.85rem;">
                                 Enable "Per Occupancy" pricing to set different rates for 1, 2, 3+ guests
                            </td>
                        </tr>`;
                }
                
                // 
                // OFFERS SECTION - Calculated from STANDARD PRICE
                // 
                if (otherOffers.length > 0) {
                    html += `
                        <tr>
                            <td colspan="${dates.length + 1}" style="padding: 0.5rem 0.75rem; background: #fef3c7; font-weight: 600; color: #92400e;">
                                 OFFERS (discounts/increases from Standard Price)
                            </td>
                        </tr>`;
                    
                    for (const offer of otherOffers) {
                        const isDiscount = offer.discount_value > 0;
                        const discountLabel = offer.discount_type === 'percentage' 
                            ? `${isDiscount ? '-' : '+'}${Math.abs(offer.discount_value)}%` 
                            : `${isDiscount ? '-' : '+'}$${Math.abs(offer.discount_value)}`;
                        
                        // Pricing tier badge
                        const tierColors = {
                            'standard': { bg: '#f3f4f6', text: '#4b5563' },
                            'corporate': { bg: '#dbeafe', text: '#1d4ed8' },
                            'wholesale': { bg: '#fef3c7', text: '#92400e' },
                            'agent': { bg: '#d1fae5', text: '#065f46' },
                            'vip': { bg: '#fce7f3', text: '#be185d' }
                        };
                        const tier = offer.pricing_tier || 'standard';
                        const tierColor = tierColors[tier] || tierColors.standard;
                        const tierBadge = tier !== 'standard' ? `<span style="font-size: 0.65rem; padding: 0.1rem 0.4rem; border-radius: 4px; background: ${tierColor.bg}; color: ${tierColor.text}; margin-left: 0.5rem;">${tier.toUpperCase()}</span>` : '';
                        
                        html += `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 0.75rem; position: sticky; left: 0; background: #fffbeb; z-index: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.2rem;"></span>
                                        <div>
                                            <strong>${offer.name}</strong>${tierBadge}
                                            <div style="font-size: 0.75rem; color: ${isDiscount ? '#dc2626' : '#16a34a'};">${discountLabel} from Standard</div>
                                        </div>
                                    </div>
                                </td>`;
                        
                        dates.forEach(d => {
                            const dateStr = d.toISOString().split('T')[0];
                            const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                            // Calculate from STANDARD PRICE, not Reference
                            const stdPrice = parseFloat(dayData.standard_price || dayData.cm_price) || 0;
                            
                            let offerPrice = stdPrice;
                            if (offer.discount_type === 'percentage') {
                                offerPrice = stdPrice * (1 - offer.discount_value / 100);
                            } else {
                                offerPrice = stdPrice - offer.discount_value;
                            }
                            
                            const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                            html += `<td style="padding: 0.75rem; text-align: center; background: ${isWeekend ? '#fef9c3' : '#fffbeb'}; color: #b45309; font-weight: 500;">
                                ${stdPrice > 0 ? currencySymbol + offerPrice.toFixed(0) : '-'}
                            </td>`;
                        });
                        
                        html += `</tr>`;
                    }
                }
                
                // Add new offer row
                html += `
                    <tr>
                        <td colspan="${dates.length + 1}" style="padding: 1rem; text-align: center; background: #fafafa;">
                            <button class="btn btn-secondary" onclick="openAddOfferModal()" style="border-style: dashed;">
                                + Add Another Offer
                            </button>
                        </td>
                    </tr>`;
                
                html += `</tbody></table></div>`;
                
                // Save button
                html += `
                    <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 1rem; align-items: center;">
                        <span id="unsaved-indicator" style="color: #f59e0b; display: none;"> Unsaved changes</span>
                        <button class="btn btn-secondary" onclick="saveOfferRestrictions()" id="save-restrictions-btn" style="background: #fef3c7; border-color: #fbbf24; color: #92400e;">
                             Save Offer Restrictions
                        </button>
                        <button class="btn" onclick="saveAllStandardPrices()" id="save-standard-prices-btn">
                             Save Standard Prices
                        </button>
                    </div>`;
                
                container.innerHTML = html;
                
                // Show distribution settings
                distributionCard.style.display = 'block';
                renderOfferDistribution([{ id: 'standard', name: 'Standard Price', active: true }, ...otherOffers]);
                
            } catch (error) {
                console.error('Error loading pricing grid:', error);
                container.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 2rem;">Error loading pricing data</p>';
            }
        }
        
        function markPriceChanged(input) {
            const original = input.dataset.original;
            const current = input.value;
            
            if (original !== current) {
                input.style.background = '#fef3c7';
                input.style.borderColor = '#f59e0b';
                document.getElementById('unsaved-indicator').style.display = 'inline';
                document.getElementById('save-standard-prices-btn').style.background = '#f59e0b';
            } else {
                input.style.background = '';
                input.style.borderColor = '#86efac';
            }
        }
        
        // =====================================================
        // MIN STAY HANDLING
        // =====================================================
        function markMinStayChanged(input) {
            input.style.background = '#fef3c7';
            input.style.borderColor = '#f59e0b';
        }
        
        async function saveMinStayChanges() {
            const inputs = document.querySelectorAll('.min-stay-input');
            let saved = 0;
            
            for (const input of inputs) {
                if (input.style.background === 'rgb(254, 243, 199)') { // Changed inputs
                    const roomId = input.dataset.room;
                    const date = input.dataset.date;
                    const value = input.value ? parseInt(input.value) : null;
                    
                    try {
                        await fetch(`/api/rooms/${roomId}/min-stay`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({
                                start_date: date,
                                end_date: date,
                                min_stay_override: value
                            })
                        });
                        input.style.background = '';
                        input.style.borderColor = '#cbd5e1';
                        saved++;
                    } catch (e) {
                        console.error('Error saving min stay:', e);
                    }
                }
            }
            
            if (saved > 0) {
                showNotification(`Saved ${saved} min stay change(s)`, 'success');
            }
        }
        
        // =====================================================
        // OCCUPANCY SETTINGS MODAL
        // =====================================================
        async function openOccupancySettings(roomId) {
            document.getElementById('occupancy-room-id').value = roomId;
            
            // Load room data
            try {
                const response = await fetch(`/api/rooms/${roomId}/occupancy-settings`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const settings = data.data;
                    const maxGuests = settings.max_guests || 4;
                    
                    document.getElementById('occupancy-room-name').textContent = settings.name || 'Room';
                    document.getElementById('occupancy-max-guests').textContent = maxGuests;
                    
                    // Populate base occupancy dropdown based on max_guests
                    const baseSelect = document.getElementById('occupancy-base');
                    baseSelect.innerHTML = '';
                    for (let i = 1; i <= maxGuests; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i === 1 ? '1 adult' : `${i} adults`;
                        baseSelect.appendChild(option);
                    }
                    
                    document.getElementById('occupancy-enabled').checked = settings.pricing_mode === 'per_occupancy';
                    document.getElementById('occupancy-base').value = settings.base_occupancy || Math.min(2, maxGuests);
                    
                    document.getElementById('single-discount-type').value = settings.single_discount_type || 'fixed';
                    document.getElementById('single-discount-value').value = settings.single_discount_value || 0;
                    
                    document.getElementById('extra-adult-type').value = settings.extra_adult_type || 'fixed';
                    document.getElementById('extra-adult-charge').value = settings.extra_adult_charge || 0;
                    
                    // Children allowed toggle
                    document.getElementById('children-allowed').checked = settings.children_allowed !== false;
                    toggleChildrenAllowed();
                    
                    document.getElementById('child-charge-type').value = settings.child_charge_type || 'free';
                    document.getElementById('child-charge').value = settings.child_charge || 0;
                    document.getElementById('child-max-age-display').textContent = settings.child_max_age || 12;
                    
                    // Enable/disable child charge input based on type
                    toggleChildChargeInput();
                    // Update fields visibility based on enabled state
                    toggleOccupancyFields();
                    // Update which fields are available based on base vs max
                    updateOccupancyFieldsAvailability();
                }
            } catch (error) {
                console.error('Error loading occupancy settings:', error);
            }
            
            openModal('occupancySettingsModal');
        }
        
        function toggleOccupancyFields() {
            const enabled = document.getElementById('occupancy-enabled').checked;
            const fieldsContainer = document.getElementById('occupancy-settings-fields');
            fieldsContainer.style.opacity = enabled ? '1' : '0.5';
            fieldsContainer.style.pointerEvents = enabled ? 'auto' : 'none';
        }
        
        function toggleChildChargeInput() {
            const type = document.getElementById('child-charge-type').value;
            const input = document.getElementById('child-charge');
            input.disabled = type === 'free';
            if (type === 'free') input.value = 0;
        }
        
        function toggleChildrenAllowed() {
            const allowed = document.getElementById('children-allowed').checked;
            const childChargeSection = document.getElementById('child-charge-section');
            if (childChargeSection) {
                childChargeSection.style.opacity = allowed ? '1' : '0.4';
                childChargeSection.style.pointerEvents = allowed ? 'auto' : 'none';
            }
        }
        
        // Update which occupancy fields are available based on base vs max
        function updateOccupancyFieldsAvailability() {
            const baseOccupancy = parseInt(document.getElementById('occupancy-base').value) || 1;
            const maxGuests = parseInt(document.getElementById('occupancy-max-guests').textContent) || 4;
            
            // Single Discount: only available if base > 1 (someone can book fewer than base)
            const singleSection = document.getElementById('single-discount-section');
            const singleFields = document.getElementById('single-discount-fields');
            const singleMsg = document.getElementById('single-discount-disabled-msg');
            
            if (baseOccupancy <= 1) {
                singleSection.style.opacity = '0.5';
                singleFields.style.pointerEvents = 'none';
                singleMsg.style.display = 'block';
                document.getElementById('single-discount-type').disabled = true;
                document.getElementById('single-discount-value').disabled = true;
            } else {
                singleSection.style.opacity = '1';
                singleFields.style.pointerEvents = 'auto';
                singleMsg.style.display = 'none';
                document.getElementById('single-discount-type').disabled = false;
                document.getElementById('single-discount-value').disabled = false;
            }
            
            // Extra Adult: only available if base < max (someone can book more than base)
            const extraSection = document.getElementById('extra-adult-section');
            const extraFields = document.getElementById('extra-adult-fields');
            const extraMsg = document.getElementById('extra-adult-disabled-msg');
            
            if (baseOccupancy >= maxGuests) {
                extraSection.style.opacity = '0.5';
                extraFields.style.pointerEvents = 'none';
                extraMsg.style.display = 'block';
                document.getElementById('extra-adult-type').disabled = true;
                document.getElementById('extra-adult-charge').disabled = true;
            } else {
                extraSection.style.opacity = '1';
                extraFields.style.pointerEvents = 'auto';
                extraMsg.style.display = 'none';
                document.getElementById('extra-adult-type').disabled = false;
                document.getElementById('extra-adult-charge').disabled = false;
            }
        }
        
        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const occupancyEnabled = document.getElementById('occupancy-enabled');
            if (occupancyEnabled) {
                occupancyEnabled.addEventListener('change', toggleOccupancyFields);
            }
            const childChargeType = document.getElementById('child-charge-type');
            if (childChargeType) {
                childChargeType.addEventListener('change', toggleChildChargeInput);
            }
            const childrenAllowed = document.getElementById('children-allowed');
            if (childrenAllowed) {
                childrenAllowed.addEventListener('change', toggleChildrenAllowed);
            }
            const occupancyBase = document.getElementById('occupancy-base');
            if (occupancyBase) {
                occupancyBase.addEventListener('change', updateOccupancyFieldsAvailability);
            }
        });
        
        async function saveOccupancySettings() {
            const roomId = document.getElementById('occupancy-room-id').value;
            const enabled = document.getElementById('occupancy-enabled').checked;
            
            const settings = {
                pricing_mode: enabled ? 'per_occupancy' : 'per_room',
                base_occupancy: parseInt(document.getElementById('occupancy-base').value) || 2,
                single_discount_type: document.getElementById('single-discount-type').value,
                single_discount_value: parseFloat(document.getElementById('single-discount-value').value) || 0,
                extra_adult_type: document.getElementById('extra-adult-type').value,
                extra_adult_charge: parseFloat(document.getElementById('extra-adult-charge').value) || 0,
                children_allowed: document.getElementById('children-allowed').checked,
                child_charge_type: document.getElementById('child-charge-type').value,
                child_charge: parseFloat(document.getElementById('child-charge').value) || 0
            };
            
            try {
                const response = await fetch(`/api/rooms/${roomId}/occupancy-settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Occupancy settings saved!', 'success');
                    closeModal('occupancySettingsModal');
                    // Reload the pricing grid to show changes
                    loadOffersPricingGrid();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        }
        
        async function saveAllStandardPrices() {
            const inputs = document.querySelectorAll('.standard-price-input');
            const btn = document.getElementById('save-standard-prices-btn');
            
            // Find changed inputs
            const changes = [];
            inputs.forEach(input => {
                if (input.value !== input.dataset.original) {
                    changes.push({
                        roomId: input.dataset.room,
                        date: input.dataset.date,
                        price: input.value
                    });
                }
            });
            
            if (changes.length === 0) {
                alert('No changes to save');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = ' Saving...';
            
            let saved = 0;
            let errors = 0;
            
            for (const change of changes) {
                try {
                    const response = await fetch('/api/admin/availability', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({
                            room_id: change.roomId,
                            from_date: change.date,
                            to_date: change.date,
                            standard_price: parseFloat(change.price) || null
                        })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        saved++;
                    } else {
                        errors++;
                    }
                } catch (error) {
                    errors++;
                }
            }
            
            btn.disabled = false;
            btn.style.background = '';
            btn.textContent = ' Save Standard Prices';
            document.getElementById('unsaved-indicator').style.display = 'none';
            
            // Update original values and reset styles
            inputs.forEach(input => {
                input.dataset.original = input.value;
                input.style.background = '';
                input.style.borderColor = '#86efac';
            });
            
            if (errors > 0) {
                alert(`Saved ${saved} prices, ${errors} errors`);
            } else {
                alert(` Saved ${saved} price${saved !== 1 ? 's' : ''} successfully!`);
            }
        }
        
        // 
        // TURBINES FUNCTIONS (Social Media)
        // 
        
        let turbineConnections = [];
        let turbinePosts = [];
        
        // Connect to social media platform
        function connectTurbine(platform) {
            // For now, show coming soon message
            showNotification(`${platform.charAt(0).toUpperCase() + platform.slice(1)} connection coming soon! OAuth integration required.`, 'info');
            
            // When API is ready, this will redirect to OAuth:
            // window.location.href = `/api/turbines/connect/${platform}`;
        }
        
        // Load connected accounts
        async function loadTurbineConnections() {
            const container = document.getElementById('turbine-connections-list');
            if (!container) return;
            
            try {
                // For now, show empty state (will load from API later)
                turbineConnections = [];
                
                if (turbineConnections.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <p>No accounts connected yet</p>
                            <p style="font-size: 0.85rem;">Connect your first social media account below</p>
                        </div>
                    `;
                } else {
                    // Render connected accounts
                    container.innerHTML = turbineConnections.map(conn => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="width: 40px; height: 40px; background: ${getPlatformColor(conn.platform)}; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                                    ${getPlatformIcon(conn.platform)}
                                </div>
                                <div>
                                    <strong>${conn.platform_username || conn.platform}</strong>
                                    <p style="margin: 0; font-size: 0.8rem; color: #64748b;">${conn.platform}</p>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="disconnectTurbine(${conn.id})" style="color: #ef4444; border-color: #fecaca;">
                                Disconnect
                            </button>
                        </div>
                    `).join('');
                }
                
                // Update stats
                document.getElementById('turbine-stat-connections').textContent = turbineConnections.length;
            } catch (error) {
                console.error('Error loading turbine connections:', error);
            }
        }
        
        function getPlatformColor(platform) {
            const colors = {
                facebook: '#1877f2',
                instagram: '#e4405f',
                twitter: '#000000',
                tiktok: '#000000',
                linkedin: '#0a66c2'
            };
            return colors[platform] || '#64748b';
        }
        
        function getPlatformIcon(platform) {
            const icons = {
                facebook: 'f',
                instagram: 'ðŸ“·',
                twitter: 'ð•',
                tiktok: 'â™ª',
                linkedin: 'in'
            };
            return icons[platform] || '?';
        }
        
        function disconnectTurbine(id) {
            if (!confirm('Are you sure you want to disconnect this account?')) return;
            showNotification('Disconnect feature coming soon', 'info');
        }
        
        // Open Create Post Modal
        async function openCreatePostModal() {
            // Load offers
            await loadPostOffers();
            // Load GAS Lites
            await loadPostLites();
            // Load connected platforms
            loadPostPlatforms();
            
            // Setup timing toggle
            document.querySelectorAll('input[name="post-timing"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('post-schedule-datetime').style.display = 
                        this.value === 'schedule' ? 'block' : 'none';
                });
            });
            
            // Setup char counter
            document.getElementById('post-content').addEventListener('input', function() {
                document.getElementById('post-char-count').textContent = `${this.value.length} / 280`;
            });
            
            document.getElementById('createPostModal').classList.add('active');
        }
        
        async function loadPostOffers() {
            const select = document.getElementById('post-offer-select');
            try {
                const queryString = buildQueryString();
                const res = await fetch(`/api/db/offers${queryString}`);
                const data = await res.json();
                
                select.innerHTML = '<option value="">Choose an offer...</option>';
                if (data.success && data.data) {
                    data.data.forEach(offer => {
                        select.innerHTML += `<option value="${offer.id}" data-offer='${JSON.stringify(offer)}'>${offer.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading offers:', error);
            }
        }
        
        async function loadPostLites() {
            const select = document.getElementById('post-lite-select');
            try {
                const queryString = buildQueryString();
                const res = await fetch(`/api/db/gas-lites${queryString}`);
                const data = await res.json();
                
                select.innerHTML = '<option value="">Choose a GAS Lite...</option>';
                if (data.success && data.data) {
                    data.data.forEach(lite => {
                        select.innerHTML += `<option value="${lite.id}" data-slug="${lite.slug}">${lite.custom_title || lite.slug}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading lites:', error);
            }
        }
        
        function loadOfferDetails() {
            const select = document.getElementById('post-offer-select');
            const details = document.getElementById('post-offer-details');
            const option = select.options[select.selectedIndex];
            
            if (!option.value) {
                details.style.display = 'none';
                return;
            }
            
            try {
                const offer = JSON.parse(option.dataset.offer);
                document.getElementById('post-offer-name').textContent = offer.name;
                document.getElementById('post-offer-discount').textContent = 
                    offer.discount_type === 'percentage' ? `${offer.discount_value}% off` : `$${offer.discount_value} off`;
                document.getElementById('post-offer-dates').textContent = 
                    `${new Date(offer.start_date).toLocaleDateString()} - ${new Date(offer.end_date).toLocaleDateString()}`;
                details.style.display = 'block';
            } catch (e) {
                details.style.display = 'none';
            }
        }
        
        function loadPostPlatforms() {
            const container = document.getElementById('post-platforms-list');
            
            if (turbineConnections.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: #64748b; width: 100%;">
                        No social media accounts connected.<br>
                        <a href="#" onclick="navClick(document.querySelector('[data-view=turbine-connections]'), 'turbine-connections'); closeModal('createPostModal'); return false;" style="color: #3b82f6;">Connect accounts first â†’</a>
                    </div>
                `;
            } else {
                container.innerHTML = turbineConnections.map(conn => `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                        <input type="checkbox" class="post-platform-cb" data-turbine-id="${conn.id}" checked>
                        <span style="background: ${getPlatformColor(conn.platform)}; color: white; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">${getPlatformIcon(conn.platform)}</span>
                        <span>${conn.platform_username || conn.platform}</span>
                    </label>
                `).join('');
            }
        }
        
        function generatePostContent() {
            const offerSelect = document.getElementById('post-offer-select');
            const option = offerSelect.options[offerSelect.selectedIndex];
            
            if (!option.value) {
                showNotification('Please select an offer first', 'error');
                return;
            }
            
            try {
                const offer = JSON.parse(option.dataset.offer);
                const discount = offer.discount_type === 'percentage' ? `${offer.discount_value}%` : `$${offer.discount_value}`;
                
                const templates = [
                    `ðŸ”¥ Limited Time Offer! Get ${discount} off your stay. Book now before it's gone! âœ¨\n\n#travel #vacation #deals`,
                    `âœ¨ Special Deal Alert! ${discount} off - Don't miss out on this amazing offer! ðŸ–ï¸\n\n#traveldeals #getaway #holiday`,
                    `ðŸŽ‰ Save ${discount} on your next getaway! Limited availability. Book today! ðŸŒ´\n\n#vacation #travel #specialoffer`
                ];
                
                const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
                document.getElementById('post-content').value = randomTemplate;
                document.getElementById('post-char-count').textContent = `${randomTemplate.length} / 280`;
                
                showNotification('Post content generated!', 'success');
            } catch (e) {
                showNotification('Error generating content', 'error');
            }
        }
        
        async function savePost() {
            const offerId = document.getElementById('post-offer-select').value;
            const liteId = document.getElementById('post-lite-select').value;
            const content = document.getElementById('post-content').value;
            const timing = document.querySelector('input[name="post-timing"]:checked').value;
            const scheduledAt = document.getElementById('post-scheduled-at').value;
            
            if (!content.trim()) {
                showNotification('Please enter post content', 'error');
                return;
            }
            
            // For now, just show success and close
            showNotification('Post feature coming soon! Post saved as draft.', 'info');
            closeModal('createPostModal');
            
            // When API is ready:
            // const res = await fetch('/api/turbines/posts', { method: 'POST', ... });
        }
        
        function filterTurbinePosts(filter) {
            // Update active button
            document.querySelectorAll('.turbine-filter').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '';
                btn.style.color = '';
            });
            const activeBtn = document.querySelector(`.turbine-filter[data-filter="${filter}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = '#3b82f6';
                activeBtn.style.color = 'white';
            }
            
            // Filter posts (will implement when we have data)
            loadTurbinePosts(filter);
        }
        
        async function loadTurbinePosts(filter = 'all') {
            const container = document.getElementById('turbine-posts-list');
            if (!container) return;
            
            // For now, show empty state
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“</div>
                    <h3 style="margin-bottom: 0.5rem; color: #1e293b;">No Posts Yet</h3>
                    <p style="color: #64748b; margin-bottom: 1.5rem;">Create your first social media post to promote your offers</p>
                    <button class="btn" onclick="openCreatePostModal()">
                        <span>+</span>
                        <span>Create Your First Post</span>
                    </button>
                </div>
            `;
            
            // Update stats
            document.getElementById('turbine-stat-scheduled').textContent = '0';
            document.getElementById('turbine-stat-posted').textContent = '0';
            document.getElementById('turbine-stat-drafts').textContent = '0';
        }
        
        // ============================================
        // TURBINE CAMPAIGNS FUNCTIONS
        // ============================================
        
        let allCampaigns = [];
        let availabilityGaps = [];
        
        async function loadTurbineCampaigns() {
            const container = document.getElementById('campaigns-list');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner"></div></div>';
            
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                if (!accountId) return;
                
                const response = await fetch(`/api/turbines/campaigns?account_id=${accountId}`);
                const data = await response.json();
                
                if (data.success) {
                    allCampaigns = data.campaigns || [];
                    renderCampaigns();
                    updateCampaignStats();
                    checkAvailabilityGaps();
                }
            } catch (error) {
                console.error('Error loading campaigns:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Error loading campaigns</div>';
            }
        }
        
        function renderCampaigns() {
            const container = document.getElementById('campaigns-list');
            
            if (allCampaigns.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“£</div>
                        <h3 style="margin-bottom: 0.5rem; color: #1e293b;">No campaigns yet</h3>
                        <p style="margin-bottom: 1.5rem;">Create your first campaign to fill availability gaps and boost bookings</p>
                        <button class="btn" onclick="openCreateCampaignModal()">+ Create Campaign</button>
                    </div>
                `;
                return;
            }
            
            const statusColors = {
                draft: { bg: '#f1f5f9', text: '#64748b', icon: 'ðŸ“' },
                scheduled: { bg: '#dbeafe', text: '#1d4ed8', icon: 'ðŸ“…' },
                sent: { bg: '#dcfce7', text: '#166534', icon: 'âœ…' },
                completed: { bg: '#f3e8ff', text: '#7c3aed', icon: 'ðŸ' }
            };
            
            let html = '<div class="table-container"><table><thead><tr><th>Campaign</th><th>Property</th><th>Dates</th><th>Discount</th><th>Channels</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
            
            allCampaigns.forEach(c => {
                const status = statusColors[c.status] || statusColors.draft;
                const channels = c.channels || {};
                const channelIcons = [];
                if (channels.email) channelIcons.push('ðŸ“§');
                if (channels.facebook) channelIcons.push('ðŸ“˜');
                if (channels.instagram) channelIcons.push('ðŸ“·');
                
                html += `<tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.property_name || '-'}</td>
                    <td>${c.start_date ? new Date(c.start_date).toLocaleDateString() : '-'} - ${c.end_date ? new Date(c.end_date).toLocaleDateString() : '-'}</td>
                    <td>${c.discount_type === 'percent' ? c.discount_value + '%' : c.discount_type === 'fixed' ? 'Â£' + c.discount_value : c.custom_price ? 'Â£' + c.custom_price : '-'}</td>
                    <td>${channelIcons.join(' ') || '-'}</td>
                    <td><span style="background: ${status.bg}; color: ${status.text}; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${status.icon} ${c.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editCampaign(${c.id})">Edit</button>
                        <button class="btn btn-sm btn-secondary" onclick="deleteCampaign(${c.id})" style="color: #ef4444;">Delete</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        function updateCampaignStats() {
            const active = allCampaigns.filter(c => c.status === 'scheduled').length;
            const sent = allCampaigns.filter(c => c.status === 'sent' || c.status === 'completed').length;
            const draft = allCampaigns.filter(c => c.status === 'draft').length;
            
            document.getElementById('campaign-stat-active').textContent = active;
            document.getElementById('campaign-stat-sent').textContent = sent;
            document.getElementById('campaign-stat-draft').textContent = draft;
        }
        
        async function checkAvailabilityGaps() {
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                if (!accountId) return;
                
                const response = await fetch(`/api/turbines/availability-gaps?account_id=${accountId}&min_gap_nights=3&days_ahead=60`);
                const data = await response.json();
                
                if (data.success && data.gaps && data.gaps.length > 0) {
                    availabilityGaps = data.gaps;
                    document.getElementById('availability-gaps-alert').style.display = 'block';
                    document.getElementById('gaps-summary').textContent = `You have ${data.gaps.length} gap${data.gaps.length > 1 ? 's' : ''} (3+ nights) in the next 60 days that could be filled with a promotion`;
                } else {
                    document.getElementById('availability-gaps-alert').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking gaps:', error);
            }
        }
        
        function showAvailabilityGaps() {
            if (availabilityGaps.length === 0) {
                showNotification('No availability gaps found', 'info');
                return;
            }
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            availabilityGaps.forEach(gap => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div>
                            <strong>${gap.property_name}</strong> - ${gap.room_name}
                            <div style="color: #64748b; font-size: 0.85rem;">${gap.gap_start} to ${gap.gap_end} (${gap.nights} nights)</div>
                        </div>
                        <button class="btn btn-sm" onclick="createCampaignFromGap(${JSON.stringify(gap).replace(/"/g, '&quot;')})">Create Campaign</button>
                    </div>
                `;
            });
            html += '</div>';
            
            showModal('Availability Gaps', html);
        }
        
        let campaignWizardStep = 1;
        let campaignData = {};
        let campaignProperties = [];
        let campaignRooms = [];
        
        async function openCreateCampaignModal(prefillGap = null) {
            // Reset wizard
            campaignWizardStep = 1;
            campaignData = {
                name: '',
                property_id: null,
                room_id: null,
                discount_type: 'percent',
                discount_value: 10,
                custom_price: null,
                start_date: '',
                end_date: '',
                min_nights: 1,
                target_type: 'all',
                target_tags: [],
                channels: { email: false, facebook: false, instagram: false },
                email_subject: '',
                email_body: '',
                social_caption: '',
                include_gas_lite: true,
                gas_lite_slug: ''
            };
            
            // Prefill from gap if provided
            if (prefillGap) {
                campaignData.property_id = prefillGap.property_id;
                campaignData.room_id = prefillGap.room_id;
                campaignData.start_date = prefillGap.gap_start;
                campaignData.end_date = prefillGap.gap_end;
                campaignData.name = `${prefillGap.room_name} - Gap Filler`;
            }
            
            // Load properties
            await loadCampaignProperties();
            
            renderCampaignWizard();
        }
        
        async function loadCampaignProperties() {
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                const response = await fetch(`/api/db/properties?account_id=${accountId}`);
                const data = await response.json();
                campaignProperties = data.success ? data.data : [];
            } catch (e) {
                campaignProperties = [];
            }
        }
        
        async function loadCampaignRooms(propertyId) {
            try {
                const response = await fetch(`/api/admin/units?property_id=${propertyId}`);
                const data = await response.json();
                campaignRooms = data.success ? (data.units || data.data || []) : [];
            } catch (e) {
                campaignRooms = [];
            }
        }
        
        function renderCampaignWizard() {
            const steps = ['Property', 'Dates & Discount', 'Audience', 'Channels', 'Review'];
            
            let stepIndicator = '<div style="display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem;">';
            steps.forEach((step, idx) => {
                const stepNum = idx + 1;
                const isActive = stepNum === campaignWizardStep;
                const isComplete = stepNum < campaignWizardStep;
                stepIndicator += `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem;
                            ${isActive ? 'background: #6366f1; color: white;' : isComplete ? 'background: #10b981; color: white;' : 'background: #e2e8f0; color: #64748b;'}">
                            ${isComplete ? 'âœ“' : stepNum}
                        </div>
                        <span style="font-size: 0.85rem; color: ${isActive ? '#1e293b' : '#64748b'}; display: ${idx < 3 ? 'block' : 'none'};">${step}</span>
                        ${idx < steps.length - 1 ? '<div style="width: 30px; height: 2px; background: #e2e8f0;"></div>' : ''}
                    </div>
                `;
            });
            stepIndicator += '</div>';
            
            let content = '';
            
            // Step 1: Property Selection
            if (campaignWizardStep === 1) {
                content = `
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Campaign Name *</label>
                        <input type="text" id="campaign-name" class="form-input" placeholder="e.g., Summer Gap Filler" value="${campaignData.name}" onchange="campaignData.name = this.value">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Property *</label>
                        <select id="campaign-property" class="form-input" onchange="onCampaignPropertyChange(this.value)">
                            <option value="">Select a property...</option>
                            ${campaignProperties.map(p => `<option value="${p.id}" ${campaignData.property_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Room/Unit (optional)</label>
                        <select id="campaign-room" class="form-input" onchange="campaignData.room_id = this.value || null">
                            <option value="">All rooms</option>
                            ${campaignRooms.map(r => `<option value="${r.id}" ${campaignData.room_id == r.id ? 'selected' : ''}>${r.name}</option>`).join('')}
                        </select>
                    </div>
                `;
            }
            
            // Step 2: Dates & Discount
            else if (campaignWizardStep === 2) {
                content = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Start Date *</label>
                            <input type="date" id="campaign-start" class="form-input" value="${campaignData.start_date}" onchange="campaignData.start_date = this.value">
                        </div>
                        <div>
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">End Date *</label>
                            <input type="date" id="campaign-end" class="form-input" value="${campaignData.end_date}" onchange="campaignData.end_date = this.value">
                        </div>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Minimum Nights</label>
                        <input type="number" id="campaign-min-nights" class="form-input" min="1" value="${campaignData.min_nights}" onchange="campaignData.min_nights = parseInt(this.value) || 1" style="width: 100px;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Discount Type</label>
                        <div style="display: flex; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="discount-type" value="percent" ${campaignData.discount_type === 'percent' ? 'checked' : ''} onchange="onDiscountTypeChange('percent')"> % Off
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="discount-type" value="fixed" ${campaignData.discount_type === 'fixed' ? 'checked' : ''} onchange="onDiscountTypeChange('fixed')"> Fixed Amount Off
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="radio" name="discount-type" value="custom" ${campaignData.discount_type === 'custom' ? 'checked' : ''} onchange="onDiscountTypeChange('custom')"> Custom Price
                            </label>
                        </div>
                    </div>
                    <div style="margin-bottom: 1.5rem;" id="discount-value-container">
                        ${campaignData.discount_type === 'percent' ? `
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Discount Percentage</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="number" id="campaign-discount" class="form-input" min="1" max="100" value="${campaignData.discount_value}" onchange="campaignData.discount_value = parseFloat(this.value)" style="width: 100px;">
                                <span>%</span>
                            </div>
                        ` : campaignData.discount_type === 'fixed' ? `
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Amount Off Per Night</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>Â£</span>
                                <input type="number" id="campaign-discount" class="form-input" min="1" value="${campaignData.discount_value}" onchange="campaignData.discount_value = parseFloat(this.value)" style="width: 100px;">
                            </div>
                        ` : `
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Custom Price Per Night</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span>Â£</span>
                                <input type="number" id="campaign-custom-price" class="form-input" min="1" value="${campaignData.custom_price || ''}" onchange="campaignData.custom_price = parseFloat(this.value)" style="width: 100px;">
                            </div>
                        `}
                    </div>
                `;
            }
            
            // Step 3: Audience
            else if (campaignWizardStep === 3) {
                content = `
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Target Audience</label>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 1rem; border: 2px solid ${campaignData.target_type === 'all' ? '#6366f1' : '#e2e8f0'}; border-radius: 8px;">
                                <input type="radio" name="target-type" value="all" ${campaignData.target_type === 'all' ? 'checked' : ''} onchange="onTargetTypeChange('all')">
                                <div>
                                    <strong>All Contacts</strong>
                                    <p style="margin: 0; font-size: 0.85rem; color: #64748b;">Send to everyone in your network</p>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 1rem; border: 2px solid ${campaignData.target_type === 'tags' ? '#6366f1' : '#e2e8f0'}; border-radius: 8px;">
                                <input type="radio" name="target-type" value="tags" ${campaignData.target_type === 'tags' ? 'checked' : ''} onchange="onTargetTypeChange('tags')">
                                <div>
                                    <strong>By Tags</strong>
                                    <p style="margin: 0; font-size: 0.85rem; color: #64748b;">Target contacts with specific interests</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div id="tags-selection" style="display: ${campaignData.target_type === 'tags' ? 'block' : 'none'}; margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Select Tags</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; max-height: 200px; overflow-y: auto; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 8px;">
                            ${allTags.map(t => `
                                <label style="display: flex; align-items: center; gap: 0.25rem; background: #f1f5f9; padding: 6px 10px; border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" value="${t.id}" ${campaignData.target_tags.includes(t.id) ? 'checked' : ''} onchange="onTagSelectionChange(${t.id}, this.checked)">
                                    ${t.icon || 'ðŸ·ï¸'} ${t.name}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Step 4: Channels
            else if (campaignWizardStep === 4) {
                const room = campaignRooms.find(r => r.id == campaignData.room_id);
                const property = campaignProperties.find(p => p.id == campaignData.property_id);
                const hasGasLite = campaignData.room_id && room; // Only show GAS Lite option if specific room selected
                
                content = `
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Select Channels</label>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">Choose where to publish this campaign</p>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid ${campaignData.channels.email ? '#6366f1' : '#e2e8f0'}; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" ${campaignData.channels.email ? 'checked' : ''} onchange="campaignData.channels.email = this.checked; renderCampaignWizard();">
                                <div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem;">ðŸ“§</div>
                                <div>
                                    <strong>Email</strong>
                                    <p style="margin: 0; font-size: 0.85rem; color: #64748b;">Send to your contact list</p>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid ${campaignData.channels.facebook ? '#6366f1' : '#e2e8f0'}; border-radius: 8px; cursor: pointer; opacity: 0.5;">
                                <input type="checkbox" disabled ${campaignData.channels.facebook ? 'checked' : ''}>
                                <div style="width: 40px; height: 40px; background: #1877f2; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem;">f</div>
                                <div>
                                    <strong>Facebook</strong>
                                    <p style="margin: 0; font-size: 0.85rem; color: #64748b;">Coming soon - Connect your page first</p>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid ${campaignData.channels.instagram ? '#6366f1' : '#e2e8f0'}; border-radius: 8px; cursor: pointer; opacity: 0.5;">
                                <input type="checkbox" disabled ${campaignData.channels.instagram ? 'checked' : ''}>
                                <div style="width: 40px; height: 40px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem;">ðŸ“·</div>
                                <div>
                                    <strong>Instagram</strong>
                                    <p style="margin: 0; font-size: 0.85rem; color: #64748b;">Coming soon - Connect your account first</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    ${campaignData.channels.email ? `
                        <div style="background: #f8fafc; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">ðŸ“§ Email Content</h4>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Subject Line *</label>
                                <input type="text" id="campaign-email-subject" class="form-input" 
                                    placeholder="e.g., Exclusive Offer: ${campaignData.discount_type === 'percent' ? campaignData.discount_value + '% off' : 'Â£' + campaignData.discount_value + ' off'} at ${property?.name || 'our property'}!" 
                                    value="${campaignData.email_subject}" 
                                    onchange="campaignData.email_subject = this.value">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Email Body *</label>
                                
                                <!-- WYSIWYG Toolbar -->
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; padding: 0.5rem; background: #f1f5f9; border: 1px solid #e2e8f0; border-bottom: none; border-radius: 8px 8px 0 0;">
                                    <button type="button" onclick="execEmailCmd('bold')" style="padding: 6px 10px; border: none; background: white; border-radius: 4px; cursor: pointer; font-weight: bold;" title="Bold">B</button>
                                    <button type="button" onclick="execEmailCmd('italic')" style="padding: 6px 10px; border: none; background: white; border-radius: 4px; cursor: pointer; font-style: italic;" title="Italic">I</button>
                                    <button type="button" onclick="execEmailCmd('underline')" style="padding: 6px 10px; border: none; background: white; border-radius: 4px; cursor: pointer; text-decoration: underline;" title="Underline">U</button>
                                    <div style="width: 1px; background: #cbd5e1; margin: 0 4px;"></div>
                                    <button type="button" onclick="execEmailCmd('insertUnorderedList')" style="padding: 6px 10px; border: none; background: white; border-radius: 4px; cursor: pointer;" title="Bullet List">â€¢ List</button>
                                    <button type="button" onclick="execEmailCmd('insertOrderedList')" style="padding: 6px 10px; border: none; background: white; border-radius: 4px; cursor: pointer;" title="Numbered List">1. List</button>
                                    <div style="width: 1px; background: #cbd5e1; margin: 0 4px;"></div>
                                    <button type="button" onclick="execEmailCmd('justifyLeft')" style="padding: 6px 10px; border: none; background: white; border-radius: 4px; cursor: pointer;" title="Align Left">â¬›</button>
                                    <button type="button" onclick="execEmailCmd('justifyCenter')" style="padding: 6px 10px; border: none; background: white; border-radius: 4px; cursor: pointer;" title="Align Center">â¬›</button>
                                    <div style="width: 1px; background: #cbd5e1; margin: 0 4px;"></div>
                                    <button type="button" onclick="insertEmailLink()" style="padding: 6px 10px; border: none; background: white; border-radius: 4px; cursor: pointer;" title="Insert Link">ðŸ”— Link</button>
                                    <select onchange="execEmailCmd('fontSize', this.value); this.value='';" style="padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 4px; background: white; cursor: pointer;">
                                        <option value="">Size</option>
                                        <option value="1">Small</option>
                                        <option value="3">Normal</option>
                                        <option value="5">Large</option>
                                        <option value="7">Huge</option>
                                    </select>
                                    <input type="color" onchange="execEmailCmd('foreColor', this.value)" value="#000000" style="width: 32px; height: 28px; border: none; cursor: pointer;" title="Text Color">
                                </div>
                                
                                <!-- Editable Area -->
                                <div id="campaign-email-editor" contenteditable="true" 
                                    style="min-height: 200px; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0 0 8px 8px; background: white; outline: none;"
                                    oninput="campaignData.email_body = this.innerHTML"
                                >${campaignData.email_body || '<p>Dear Guest,</p><p>We have a special offer just for you!</p><p><br></p><p>Best regards,<br>' + (property?.name || 'The Team') + '</p>'}</div>
                            </div>
                            
                            ${hasGasLite ? `
                                <div style="background: #ecfdf5; border: 1px solid #10b981; border-radius: 8px; padding: 1rem;">
                                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                                        <input type="checkbox" id="include-gas-lite" ${campaignData.include_gas_lite ? 'checked' : ''} 
                                            onchange="campaignData.include_gas_lite = this.checked" style="margin-top: 3px;">
                                        <div>
                                            <label for="include-gas-lite" style="font-weight: 600; cursor: pointer;">Include GAS Lite Booking Link</label>
                                            <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #047857;">
                                                Add a "Book Now" button linking directly to <strong>${room?.name}</strong>'s booking page
                                            </p>
                                            <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #64748b;">
                                                Link: lite.gas.travel/${campaignData.gas_lite_slug || '[auto-generated]'}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem;">
                                    <p style="margin: 0; font-size: 0.85rem; color: #92400e;">
                                        <strong>ðŸ’¡ Tip:</strong> Select a specific room in Step 1 to include a direct GAS Lite booking link in your email.
                                    </p>
                                </div>
                            `}
                        </div>
                    ` : ''}
                `;
            }
            
            // Step 5: Review
            else if (campaignWizardStep === 5) {
                const property = campaignProperties.find(p => p.id == campaignData.property_id);
                const room = campaignRooms.find(r => r.id == campaignData.room_id);
                const selectedTags = allTags.filter(t => campaignData.target_tags.includes(t.id));
                
                content = `
                    <div style="background: #f8fafc; border-radius: 8px; padding: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #1e293b;">${campaignData.name || 'Untitled Campaign'}</h3>
                        
                        <div style="display: grid; gap: 1rem;">
                            <div style="display: flex; justify-content: space-between; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #64748b;">Property</span>
                                <strong>${property?.name || 'Not selected'}</strong>
                            </div>
                            ${room ? `
                                <div style="display: flex; justify-content: space-between; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                                    <span style="color: #64748b;">Room</span>
                                    <strong>${room.name}</strong>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #64748b;">Dates</span>
                                <strong>${campaignData.start_date} to ${campaignData.end_date}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #64748b;">Discount</span>
                                <strong style="color: #10b981;">
                                    ${campaignData.discount_type === 'percent' ? campaignData.discount_value + '% off' : 
                                      campaignData.discount_type === 'fixed' ? 'Â£' + campaignData.discount_value + ' off' : 
                                      'Â£' + campaignData.custom_price + '/night'}
                                </strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #64748b;">Minimum Nights</span>
                                <strong>${campaignData.min_nights}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-bottom: 0.75rem; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #64748b;">Audience</span>
                                <strong>${campaignData.target_type === 'all' ? 'All Contacts' : selectedTags.map(t => t.icon + ' ' + t.name).join(', ') || 'No tags selected'}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #64748b;">Channels</span>
                                <strong>
                                    ${campaignData.channels.email ? 'ðŸ“§ Email ' : ''}
                                    ${campaignData.channels.facebook ? 'ðŸ“˜ Facebook ' : ''}
                                    ${campaignData.channels.instagram ? 'ðŸ“· Instagram' : ''}
                                    ${!campaignData.channels.email && !campaignData.channels.facebook && !campaignData.channels.instagram ? 'None selected' : ''}
                                </strong>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Navigation buttons
            const navButtons = `
                <div style="display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                    <button class="btn btn-secondary" onclick="${campaignWizardStep === 1 ? 'closeModal(\'campaignWizardModal\')' : 'prevCampaignStep()'}" style="min-width: 100px;">
                        ${campaignWizardStep === 1 ? 'Cancel' : 'â† Back'}
                    </button>
                    <button class="btn" onclick="${campaignWizardStep === 5 ? 'saveCampaign()' : 'nextCampaignStep()'}" style="min-width: 100px;">
                        ${campaignWizardStep === 5 ? 'ðŸš€ Create Campaign' : 'Next â†’'}
                    </button>
                </div>
            `;
            
            // Show modal
            let modal = document.getElementById('campaignWizardModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'campaignWizardModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>Create Campaign</h3>
                            <button onclick="closeModal('campaignWizardModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
                        </div>
                        <div id="campaignWizardBody" style="padding: 1.5rem;"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('campaignWizardBody').innerHTML = stepIndicator + content + navButtons;
            modal.classList.add('active');
        }
        
        async function onCampaignPropertyChange(propertyId) {
            campaignData.property_id = propertyId || null;
            campaignData.room_id = null;
            if (propertyId) {
                await loadCampaignRooms(propertyId);
            } else {
                campaignRooms = [];
            }
            renderCampaignWizard();
        }
        
        function onDiscountTypeChange(type) {
            campaignData.discount_type = type;
            if (type === 'percent') campaignData.discount_value = 10;
            else if (type === 'fixed') campaignData.discount_value = 20;
            else campaignData.custom_price = 100;
            renderCampaignWizard();
        }
        
        function onTargetTypeChange(type) {
            campaignData.target_type = type;
            if (type === 'all') campaignData.target_tags = [];
            renderCampaignWizard();
        }
        
        function onTagSelectionChange(tagId, checked) {
            if (checked) {
                if (!campaignData.target_tags.includes(tagId)) {
                    campaignData.target_tags.push(tagId);
                }
            } else {
                campaignData.target_tags = campaignData.target_tags.filter(id => id !== tagId);
            }
        }
        
        function prevCampaignStep() {
            if (campaignWizardStep > 1) {
                campaignWizardStep--;
                renderCampaignWizard();
            }
        }
        
        async function nextCampaignStep() {
            // Validation
            if (campaignWizardStep === 1) {
                campaignData.name = document.getElementById('campaign-name')?.value || '';
                if (!campaignData.name) {
                    showNotification('Please enter a campaign name', 'error');
                    return;
                }
                if (!campaignData.property_id) {
                    showNotification('Please select a property', 'error');
                    return;
                }
            }
            if (campaignWizardStep === 2) {
                if (!campaignData.start_date || !campaignData.end_date) {
                    showNotification('Please select start and end dates', 'error');
                    return;
                }
            }
            if (campaignWizardStep === 3) {
                // Load tags if not loaded
                if (allTags.length === 0) {
                    await loadTagsForFilter();
                }
            }
            
            if (campaignWizardStep < 5) {
                campaignWizardStep++;
                renderCampaignWizard();
            }
        }
        
        // WYSIWYG Editor Functions
        function execEmailCmd(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('campaign-email-editor')?.focus();
        }
        
        function insertEmailLink() {
            const url = prompt('Enter URL:', 'https://');
            if (url) {
                document.execCommand('createLink', false, url);
            }
        }
        
        async function saveCampaign() {
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                
                const response = await fetch('/api/turbines/campaigns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: accountId,
                        name: campaignData.name,
                        property_id: campaignData.property_id,
                        room_id: campaignData.room_id,
                        discount_type: campaignData.discount_type,
                        discount_value: campaignData.discount_type !== 'custom' ? campaignData.discount_value : null,
                        custom_price: campaignData.discount_type === 'custom' ? campaignData.custom_price : null,
                        start_date: campaignData.start_date,
                        end_date: campaignData.end_date,
                        min_nights: campaignData.min_nights,
                        target_type: campaignData.target_type,
                        target_tags: campaignData.target_tags.length > 0 ? campaignData.target_tags : null,
                        channels: campaignData.channels,
                        email_subject: campaignData.email_subject,
                        email_body: campaignData.email_body,
                        social_caption: campaignData.social_caption,
                        status: 'draft'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Campaign created!', 'success');
                    closeModal('campaignWizardModal');
                    loadTurbineCampaigns();
                } else {
                    showNotification(data.error || 'Failed to create campaign', 'error');
                }
            } catch (error) {
                showNotification('Error creating campaign', 'error');
            }
        }
        
        function createCampaignFromGap(gap) {
            openCreateCampaignModal(gap);
        }
        
        function editCampaign(id) {
            showNotification('Campaign editor coming soon!', 'info');
        }
        
        async function deleteCampaign(id) {
            if (!confirm('Delete this campaign?')) return;
            
            try {
                const response = await fetch(`/api/turbines/campaigns/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Campaign deleted', 'success');
                    loadTurbineCampaigns();
                } else {
                    showNotification(data.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                showNotification('Error deleting campaign', 'error');
            }
        }
        
        // ============================================
        // GAS NETWORK FUNCTIONS
        // ============================================
        
        let allContacts = [];
        let allTags = [];
        let allSegments = [];
        let contactSearchTimeout;
        
        async function loadNetworkContacts() {
            const container = document.getElementById('contacts-list');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner"></div></div>';
            
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                if (!accountId) return;
                
                // Load stats
                const statsResponse = await fetch(`/api/network/stats?account_id=${accountId}`);
                const statsData = await statsResponse.json();
                if (statsData.success) {
                    document.getElementById('contact-stat-total').textContent = statsData.stats.total_contacts || 0;
                    document.getElementById('contact-stat-bookings').textContent = statsData.stats.from_bookings || 0;
                    document.getElementById('contact-stat-import').textContent = statsData.stats.from_import || 0;
                    document.getElementById('contact-stat-repeat').textContent = statsData.stats.repeat_guests || 0;
                }
                
                // Load tags for filter dropdown
                await loadTagsForFilter();
                
                // Load contacts
                const search = document.getElementById('contact-search')?.value || '';
                const tagId = document.getElementById('contact-tag-filter')?.value || '';
                
                let url = `/api/network/contacts?account_id=${accountId}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (tagId) url += `&tag_id=${tagId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    allContacts = data.contacts || [];
                    renderContacts();
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Error loading contacts</div>';
            }
        }
        
        async function loadTagsForFilter() {
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                const response = await fetch(`/api/network/tags?account_id=${accountId}`);
                const data = await response.json();
                
                if (data.success) {
                    allTags = data.tags || [];
                    const select = document.getElementById('contact-tag-filter');
                    if (select) {
                        select.innerHTML = '<option value="">All Tags</option>';
                        allTags.forEach(tag => {
                            select.innerHTML += `<option value="${tag.id}">${tag.icon || 'ðŸ·ï¸'} ${tag.name}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading tags for filter:', error);
            }
        }
        
        function renderContacts() {
            const container = document.getElementById('contacts-list');
            
            if (allContacts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ‘¥</div>
                        <h3 style="margin-bottom: 0.5rem; color: #1e293b;">No contacts found</h3>
                        <p style="margin-bottom: 1.5rem;">Add contacts manually or import from a CSV file</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-secondary" onclick="openImportContactsModal()">ðŸ“¤ Import CSV</button>
                            <button class="btn" onclick="openAddContactModal()">+ Add Contact</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="table-container"><table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Tags</th><th>Source</th><th>Bookings</th><th>Actions</th></tr></thead><tbody>';
            
            allContacts.forEach(c => {
                const tags = c.tags || [];
                const tagHtml = tags.slice(0, 3).map(t => `<span style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px;">${t.icon || 'ðŸ·ï¸'} ${t.name}</span>`).join('');
                const moreTags = tags.length > 3 ? `<span style="color: #64748b; font-size: 0.75rem;">+${tags.length - 3} more</span>` : '';
                
                html += `<tr>
                    <td><strong>${c.first_name || ''} ${c.last_name || ''}</strong></td>
                    <td>${c.email}</td>
                    <td>${c.phone || '-'}</td>
                    <td>${tagHtml}${moreTags}</td>
                    <td><span style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">${c.source || 'manual'}</span></td>
                    <td>${c.total_bookings || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editContact(${c.id})">Edit</button>
                        <button class="btn btn-sm btn-secondary" onclick="deleteContact(${c.id})" style="color: #ef4444;">Delete</button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        
        function debounceContactSearch() {
            clearTimeout(contactSearchTimeout);
            contactSearchTimeout = setTimeout(() => loadNetworkContacts(), 300);
        }
        
        function openAddContactModal() {
            const html = `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">First Name</label>
                            <input type="text" id="new-contact-first" class="form-input" placeholder="John">
                        </div>
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">Last Name</label>
                            <input type="text" id="new-contact-last" class="form-input" placeholder="Smith">
                        </div>
                    </div>
                    <div>
                        <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">Email *</label>
                        <input type="email" id="new-contact-email" class="form-input" placeholder="john@example.com" required>
                    </div>
                    <div>
                        <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">Phone</label>
                        <input type="text" id="new-contact-phone" class="form-input" placeholder="+44 7123 456789">
                    </div>
                    <div>
                        <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">Tags</label>
                        <div id="new-contact-tags" style="display: flex; flex-wrap: wrap; gap: 0.5rem; max-height: 150px; overflow-y: auto;">
                            ${allTags.map(t => `<label style="display: flex; align-items: center; gap: 0.25rem; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" value="${t.id}"> ${t.icon || 'ðŸ·ï¸'} ${t.name}
                            </label>`).join('')}
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="closeModal('dynamicModal')">Cancel</button>
                        <button class="btn" onclick="saveNewContact()">Add Contact</button>
                    </div>
                </div>
            `;
            showModal('Add Contact', html);
        }
        
        async function saveNewContact() {
            const email = document.getElementById('new-contact-email').value;
            if (!email) {
                showNotification('Email is required', 'error');
                return;
            }
            
            const tags = [];
            document.querySelectorAll('#new-contact-tags input:checked').forEach(cb => tags.push(parseInt(cb.value)));
            
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                const response = await fetch('/api/network/contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: accountId,
                        email: email,
                        first_name: document.getElementById('new-contact-first').value,
                        last_name: document.getElementById('new-contact-last').value,
                        phone: document.getElementById('new-contact-phone').value,
                        tags: tags
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Contact added', 'success');
                    closeModal('dynamicModal');
                    loadNetworkContacts();
                } else {
                    showNotification(data.error || 'Failed to add contact', 'error');
                }
            } catch (error) {
                showNotification('Error adding contact', 'error');
            }
        }
        
        function editContact(id) {
            showNotification('Contact editor coming soon!', 'info');
        }
        
        async function deleteContact(id) {
            if (!confirm('Delete this contact?')) return;
            
            try {
                const response = await fetch(`/api/network/contacts/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Contact deleted', 'success');
                    loadNetworkContacts();
                } else {
                    showNotification(data.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                showNotification('Error deleting contact', 'error');
            }
        }
        
        function openImportContactsModal() {
            const html = `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <p style="color: #64748b;">Upload a CSV file with columns: email, first_name, last_name, phone</p>
                    <div style="background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 2rem; text-align: center;">
                        <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="handleCsvUpload(this)">
                        <button class="btn btn-secondary" onclick="document.getElementById('csv-file-input').click()">ðŸ“ Choose CSV File</button>
                        <p id="csv-file-name" style="margin-top: 0.5rem; color: #64748b; font-size: 0.85rem;">No file selected</p>
                    </div>
                    <div>
                        <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">Apply tags to all imported contacts:</label>
                        <div id="import-contact-tags" style="display: flex; flex-wrap: wrap; gap: 0.5rem; max-height: 100px; overflow-y: auto;">
                            ${allTags.map(t => `<label style="display: flex; align-items: center; gap: 0.25rem; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                                <input type="checkbox" value="${t.id}"> ${t.icon || 'ðŸ·ï¸'} ${t.name}
                            </label>`).join('')}
                        </div>
                    </div>
                    <div id="csv-preview" style="display: none;"></div>
                    <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="closeModal('dynamicModal')">Cancel</button>
                        <button class="btn" id="import-btn" onclick="importContacts()" disabled>Import Contacts</button>
                    </div>
                </div>
            `;
            showModal('Import Contacts from CSV', html);
        }
        
        let csvData = [];
        
        function handleCsvUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            document.getElementById('csv-file-name').textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                
                csvData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length >= 1 && values[0]) {
                        const row = {};
                        headers.forEach((h, idx) => {
                            if (h === 'email' || h === 'first_name' || h === 'firstname' || h === 'last_name' || h === 'lastname' || h === 'phone') {
                                const key = h.replace('firstname', 'first_name').replace('lastname', 'last_name');
                                row[key] = values[idx] || '';
                            }
                        });
                        if (row.email) csvData.push(row);
                    }
                }
                
                document.getElementById('csv-preview').style.display = 'block';
                document.getElementById('csv-preview').innerHTML = `<p style="color: #10b981;"><strong>${csvData.length}</strong> contacts found in file</p>`;
                document.getElementById('import-btn').disabled = csvData.length === 0;
            };
            reader.readAsText(file);
        }
        
        async function importContacts() {
            if (csvData.length === 0) return;
            
            const tags = [];
            document.querySelectorAll('#import-contact-tags input:checked').forEach(cb => tags.push(parseInt(cb.value)));
            
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                const response = await fetch('/api/network/contacts/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: accountId,
                        contacts: csvData,
                        default_tags: tags
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(`Imported ${data.imported} new, updated ${data.updated} existing`, 'success');
                    closeModal('dynamicModal');
                    loadNetworkContacts();
                } else {
                    showNotification(data.error || 'Import failed', 'error');
                }
            } catch (error) {
                showNotification('Error importing contacts', 'error');
            }
        }
        
        // TAGS VIEW
        async function loadNetworkTags() {
            const container = document.getElementById('tags-container');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner"></div></div>';
            
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                const response = await fetch(`/api/network/tags?account_id=${accountId}`);
                const data = await response.json();
                
                if (data.success) {
                    allTags = data.tags || [];
                    renderTags();
                }
            } catch (error) {
                console.error('Error loading tags:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Error loading tags</div>';
            }
        }
        
        function renderTags() {
            const container = document.getElementById('tags-container');
            
            // Group by category
            const categories = {};
            allTags.forEach(tag => {
                const cat = tag.category || 'other';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(tag);
            });
            
            const categoryLabels = {
                pets: 'ðŸ¾ Pets',
                travel_style: 'âœˆï¸ Travel Style',
                interests: 'â­ Interests',
                status: 'ðŸ† Status',
                source: 'ðŸ“¥ Source',
                custom: 'ðŸ·ï¸ Custom',
                other: 'ðŸ“Œ Other'
            };
            
            let html = '';
            for (const [cat, tags] of Object.entries(categories)) {
                html += `
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem;">${categoryLabels[cat] || cat}</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${tags.map(t => `
                                <div style="display: flex; align-items: center; gap: 0.5rem; background: ${t.color || '#f1f5f9'}20; border: 1px solid ${t.color || '#e2e8f0'}; padding: 8px 12px; border-radius: 8px;">
                                    <span style="font-size: 1.25rem;">${t.icon || 'ðŸ·ï¸'}</span>
                                    <span>${t.name}</span>
                                    ${!t.is_system ? `<button onclick="deleteTag(${t.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0 4px;">Ã—</button>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<div style="text-align: center; padding: 2rem; color: #64748b;">No tags found</div>';
        }
        
        function openAddTagModal() {
            const html = `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div>
                        <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">Tag Name *</label>
                        <input type="text" id="new-tag-name" class="form-input" placeholder="e.g., Pet Friendly">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">Category</label>
                            <select id="new-tag-category" class="form-input">
                                <option value="custom">Custom</option>
                                <option value="pets">Pets</option>
                                <option value="travel_style">Travel Style</option>
                                <option value="interests">Interests</option>
                                <option value="status">Status</option>
                                <option value="source">Source</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.25rem; display: block;">Icon</label>
                            <input type="text" id="new-tag-icon" class="form-input" placeholder="ðŸ·ï¸" maxlength="2">
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="closeModal('dynamicModal')">Cancel</button>
                        <button class="btn" onclick="saveNewTag()">Create Tag</button>
                    </div>
                </div>
            `;
            showModal('Create Custom Tag', html);
        }
        
        async function saveNewTag() {
            const name = document.getElementById('new-tag-name').value;
            if (!name) {
                showNotification('Tag name is required', 'error');
                return;
            }
            
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                const response = await fetch('/api/network/tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: accountId,
                        name: name,
                        category: document.getElementById('new-tag-category').value,
                        icon: document.getElementById('new-tag-icon').value || 'ðŸ·ï¸'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Tag created', 'success');
                    closeModal('dynamicModal');
                    loadNetworkTags();
                } else {
                    showNotification(data.error || 'Failed to create tag', 'error');
                }
            } catch (error) {
                showNotification('Error creating tag', 'error');
            }
        }
        
        async function deleteTag(id) {
            if (!confirm('Delete this tag? It will be removed from all contacts.')) return;
            
            try {
                const response = await fetch(`/api/network/tags/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Tag deleted', 'success');
                    loadNetworkTags();
                } else {
                    showNotification(data.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                showNotification('Error deleting tag', 'error');
            }
        }
        
        // SEGMENTS VIEW
        async function loadNetworkSegments() {
            const container = document.getElementById('segments-list');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner"></div></div>';
            
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                const response = await fetch(`/api/network/segments?account_id=${accountId}`);
                const data = await response.json();
                
                if (data.success) {
                    allSegments = data.segments || [];
                    renderSegments();
                }
            } catch (error) {
                console.error('Error loading segments:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;">Error loading segments</div>';
            }
        }
        
        function renderSegments() {
            const container = document.getElementById('segments-list');
            
            if (allSegments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“Š</div>
                        <h3 style="margin-bottom: 0.5rem; color: #1e293b;">No segments yet</h3>
                        <p style="margin-bottom: 1.5rem;">Create segments to target specific groups of contacts</p>
                        <button class="btn" onclick="openCreateSegmentModal()">+ Create Segment</button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 1rem;">';
            allSegments.forEach(s => {
                html += `
                    <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong style="font-size: 1.1rem;">${s.name}</strong>
                                <p style="color: #64748b; margin: 0.25rem 0 0 0; font-size: 0.9rem;">${s.description || 'No description'}</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm btn-secondary" onclick="deleteSegment(${s.id})" style="color: #ef4444;">Delete</button>
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem; color: #64748b; font-size: 0.85rem;">
                            <span style="background: #f1f5f9; padding: 2px 8px; border-radius: 4px;">${s.contact_count || 0} contacts</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        function openCreateSegmentModal() {
            showNotification('Segment builder coming soon!', 'info');
        }
        
        async function deleteSegment(id) {
            if (!confirm('Delete this segment?')) return;
            
            try {
                const response = await fetch(`/api/network/segments/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Segment deleted', 'success');
                    loadNetworkSegments();
                } else {
                    showNotification(data.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                showNotification('Error deleting segment', 'error');
            }
        }
        
        // Simple modal helper
        function showModal(title, content) {
            // Check if dynamicModal exists, if not create it
            let modal = document.getElementById('dynamicModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'dynamicModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 id="dynamicModalTitle"></h3>
                            <button onclick="closeModal('dynamicModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
                        </div>
                        <div id="dynamicModalBody" style="padding: 1.5rem;"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('dynamicModalTitle').textContent = title;
            document.getElementById('dynamicModalBody').innerHTML = content;
            modal.classList.add('active');
        }
        
        // 
        // MARKETING FEATURES FUNCTIONS
        // 
        
        let currentPropertyFeatures = [];
        let customFeatures = [];
        let propertyRooms = [];
        let featureRoomExclusions = {};
        
        async function loadMarketingProperties() {
            const select = document.getElementById('marketing-property-select');
            if (!select) return;
            
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                select.innerHTML = '<option value="">Select Property...</option>';
                if (data.success && data.data) {
                    data.data.forEach(prop => {
                        select.innerHTML += `<option value="${prop.id}">${prop.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadPropertyFeatures() {
            const propertyId = document.getElementById('marketing-property-select').value;
            const roomId = document.getElementById('marketing-room-select')?.value;
            const content = document.getElementById('marketing-content');
            const empty = document.getElementById('marketing-empty');
            const saveBtn = document.getElementById('marketing-save-btn');
            const applyAllContainer = document.getElementById('apply-all-rooms-container');
            const statusDiv = document.getElementById('marketing-room-status');
            
            if (!propertyId) {
                content.style.display = 'none';
                empty.style.display = 'block';
                saveBtn.style.display = 'none';
                if (applyAllContainer) applyAllContainer.style.display = 'none';
                if (statusDiv) statusDiv.style.display = 'none';
                return;
            }
            
            content.style.display = 'block';
            empty.style.display = 'none';
            saveBtn.style.display = 'block';
            
            // Show apply-all checkbox when a specific room is selected
            if (applyAllContainer) {
                applyAllContainer.style.display = roomId ? 'block' : 'none';
            }
            
            // Show status indicator
            if (statusDiv) {
                if (roomId) {
                    const roomName = document.getElementById('marketing-room-select').selectedOptions[0]?.text || 'this room';
                    statusDiv.innerHTML = `<span style="color: #2563eb;"> Editing features for: <strong>${roomName}</strong></span>`;
                    statusDiv.style.background = '#eff6ff';
                    statusDiv.style.display = 'block';
                } else {
                    statusDiv.innerHTML = `<span style="color: #059669;"> Editing property-wide features (applies to all rooms by default)</span>`;
                    statusDiv.style.background = '#ecfdf5';
                    statusDiv.style.display = 'block';
                }
            }
            
            // Reset all checkboxes
            document.querySelectorAll('.feature-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            customFeatures = [];
            featureRoomExclusions = {};
            renderCustomFeatures();
            
            // Load rooms for this property
            try {
                const roomsRes = await fetch('/api/db/bookable-units');
                const roomsData = await roomsRes.json();
                propertyRooms = roomsData.success ? (roomsData.data || []).filter(r => r.property_id == propertyId) : [];
            } catch (e) {
                propertyRooms = [];
            }
            
            // Load saved features (either room-specific or property-wide)
            try {
                const endpoint = roomId 
                    ? `/api/rooms/${roomId}/features`
                    : `/api/properties/${propertyId}/features`;
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (data.success && data.features) {
                    data.features.forEach(f => {
                        const cb = document.querySelector(`input[data-feature="${f.feature_name}"]`);
                        if (cb) {
                            cb.checked = true;
                        } else if (f.is_custom) {
                            customFeatures.push(f.feature_name);
                        }
                        if (f.excluded_room_ids && f.excluded_room_ids.length) {
                            featureRoomExclusions[f.feature_name] = f.excluded_room_ids;
                        }
                    });
                    renderCustomFeatures();
                }
            } catch (error) {
                console.log('No saved features yet or API not available');
            }
        }
        
        // Load rooms when property is selected
        async function loadMarketingRooms() {
            const propertyId = document.getElementById('marketing-property-select').value;
            const roomSelect = document.getElementById('marketing-room-select');
            
            // Reset room dropdown
            roomSelect.innerHTML = '<option value="">All Rooms (Property-wide)</option>';
            
            if (!propertyId) {
                loadPropertyFeatures();
                return;
            }
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(room => {
                        roomSelect.innerHTML += `<option value="${room.id}">${room.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
            
            // Load property-wide features
            loadPropertyFeatures();
        }
        
        // Load features for selected room
        function loadRoomFeatures() {
            loadPropertyFeatures();
        }
        
        // Save features (room or property level)
        async function saveMarketingFeatures() {
            const propertyId = document.getElementById('marketing-property-select').value;
            const roomId = document.getElementById('marketing-room-select')?.value;
            const applyToAll = document.getElementById('apply-to-all-rooms')?.checked;
            
            if (!propertyId) return;
            
            // Collect all selected features
            const features = [];
            
            // Standard features
            document.querySelectorAll('.feature-item input[type="checkbox"]:checked').forEach(cb => {
                features.push({
                    feature_name: cb.dataset.feature,
                    category: cb.closest('.feature-grid')?.dataset.category || 'custom',
                    is_custom: false,
                    excluded_room_ids: featureRoomExclusions[cb.dataset.feature] || []
                });
            });
            
            // Custom features
            customFeatures.forEach(f => {
                features.push({
                    feature_name: f,
                    category: 'custom',
                    is_custom: true,
                    excluded_room_ids: featureRoomExclusions[f] || []
                });
            });
            
            // Determine endpoint based on selection
            let endpoint, successMsg;
            
            if (roomId && !applyToAll) {
                // Save for specific room only
                endpoint = `/api/rooms/${roomId}/features`;
                successMsg = ' Room features saved successfully!';
            } else if (roomId && applyToAll) {
                // Save to all rooms in property
                endpoint = `/api/properties/${propertyId}/features?apply_to_rooms=true`;
                successMsg = ' Features saved to ALL rooms in this property!';
            } else {
                // Save property-wide defaults
                endpoint = `/api/properties/${propertyId}/features`;
                successMsg = ' Property-wide features saved successfully!';
            }
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ features, property_id: propertyId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(successMsg);
                } else {
                    alert('Error saving features: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                // API might not exist yet - show success anyway for demo
                alert(successMsg + ' (Note: API endpoint may need to be created)');
                console.log('Features to save:', { endpoint, features, roomId, applyToAll });
            }
        }
        
        // Keep old function name for backward compatibility
        async function savePropertyFeatures() {
            return saveMarketingFeatures();
        }
        
        function renderCustomFeatures() {
            const container = document.getElementById('custom-features-list');
            if (customFeatures.length === 0) {
                container.innerHTML = '<p style="color: #64748b; font-style: italic; font-size: 0.9rem;">No custom features added yet</p>';
                return;
            }
            
            container.innerHTML = customFeatures.map(f => `
                <span class="custom-feature-tag">
                     ${f}
                    <button onclick="removeCustomFeature('${f}')" title="Remove">&times;</button>
                </span>
            `).join('');
        }
        
        function addCustomFeature() {
            const input = document.getElementById('new-custom-feature');
            const value = input.value.trim();
            
            if (!value) return;
            if (customFeatures.includes(value)) {
                alert('This feature already exists');
                return;
            }
            
            customFeatures.push(value);
            renderCustomFeatures();
            input.value = '';
        }
        
        function removeCustomFeature(feature) {
            customFeatures = customFeatures.filter(f => f !== feature);
            delete featureRoomExclusions[feature];
            renderCustomFeatures();
        }
        
        function showRoomExclusions(featureName) {
            const card = document.getElementById('room-exclusions-card');
            const content = document.getElementById('room-exclusions-content');
            
            if (propertyRooms.length === 0) {
                content.innerHTML = '<p style="color: #64748b;">No rooms found for this property</p>';
                card.style.display = 'block';
                return;
            }
            
            const excluded = featureRoomExclusions[featureName] || [];
            
            let html = `
                <p style="margin-bottom: 0.75rem;"><strong>Feature:</strong> ${featureName}</p>
                <p style="margin-bottom: 0.75rem; font-size: 0.9rem; color: #64748b;">Uncheck rooms where this feature does NOT apply:</p>
                <div class="feature-grid">
            `;
            
            propertyRooms.forEach(room => {
                const isExcluded = excluded.includes(room.id);
                html += `
                    <label class="feature-item">
                        <input type="checkbox" 
                            ${!isExcluded ? 'checked' : ''} 
                            onchange="toggleRoomExclusion('${featureName}', ${room.id}, this.checked)">
                         ${room.name}
                    </label>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
            card.style.display = 'block';
        }
        
        function toggleRoomExclusion(featureName, roomId, isIncluded) {
            if (!featureRoomExclusions[featureName]) {
                featureRoomExclusions[featureName] = [];
            }
            
            if (isIncluded) {
                // Remove from exclusions
                featureRoomExclusions[featureName] = featureRoomExclusions[featureName].filter(id => id !== roomId);
            } else {
                // Add to exclusions
                if (!featureRoomExclusions[featureName].includes(roomId)) {
                    featureRoomExclusions[featureName].push(roomId);
                }
            }
        }
        
        async function aiSuggestFeatures() {
            const propertyId = document.getElementById('marketing-property-select').value;
            
            if (!propertyId) {
                alert('Please select a property first');
                return;
            }
            
            const prompt = document.getElementById('marketing-ai-prompt').value;
            if (!prompt.trim()) {
                alert('Please describe your property to get AI suggestions');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Analyzing...';
            btn.disabled = true;
            
            try {
                // Call the AI API with a special type for marketing features
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: 'marketing_features', 
                        property_id: propertyId, 
                        prompt: prompt 
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.content) {
                    // Parse the AI response to extract feature suggestions
                    displayAISuggestions(result.content);
                } else {
                    // Fallback to local analysis if API fails
                    const localSuggestions = analyzePromptForFeatures(prompt);
                    if (localSuggestions.length > 0) {
                        displayAISuggestions(localSuggestions.join('\n'));
                    } else {
                        alert('Could not generate suggestions. Try adding more detail to your description.');
                    }
                }
            } catch (error) {
                console.error('AI suggestion error:', error);
                // Fallback to local analysis
                const localSuggestions = analyzePromptForFeatures(prompt);
                if (localSuggestions.length > 0) {
                    displayAISuggestions(localSuggestions.join('\n'));
                } else {
                    alert('Error connecting to AI service. Please try again.');
                }
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function analyzePromptForFeatures(prompt) {
            const suggestions = [];
            const text = prompt.toLowerCase();
            
            // Activities
            if (text.includes('walk') || text.includes('hik') || text.includes('trail')) {
                suggestions.push('walking| Walking / Hiking');
            }
            if (text.includes('cycl') || text.includes('bike') || text.includes('bicycle')) {
                suggestions.push('cycling| Cycling');
            }
            if (text.includes('golf')) {
                suggestions.push('golf| Golf');
            }
            if (text.includes('fish')) {
                suggestions.push('fishing| Fishing');
            }
            if (text.includes('surf') || text.includes('water sport') || text.includes('kayak') || text.includes('sail')) {
                suggestions.push('water-sports| Water Sports');
            }
            if (text.includes('horse') || text.includes('riding') || text.includes('equestrian')) {
                suggestions.push('horse-riding| Horse Riding');
            }
            if (text.includes('ski') || text.includes('snow') || text.includes('winter sport')) {
                suggestions.push('skiing| Skiing / Winter Sports');
            }
            if (text.includes('bird') || text.includes('wildlife') || text.includes('nature')) {
                suggestions.push('birdwatching| Birdwatching / Wildlife');
            }
            if (text.includes('wine') || text.includes('vineyard')) {
                suggestions.push('wine-tasting| Wine Tasting');
            }
            if (text.includes('cook') || text.includes('culinary') || text.includes('food')) {
                suggestions.push('cooking-classes| Cooking Classes');
            }
            
            // Guest Types
            if (text.includes('pet') || text.includes('dog') || text.includes('cat')) {
                suggestions.push('pet-friendly| Pet Friendly');
            }
            if (text.includes('family') || text.includes('children') || text.includes('kids')) {
                suggestions.push('family-friendly| Family Friendly');
            }
            if (text.includes('adult only') || text.includes('adults only') || text.includes('no children')) {
                suggestions.push('adults-only| Adults Only');
            }
            if (text.includes('wheelchair') || text.includes('accessible') || text.includes('mobility')) {
                suggestions.push('wheelchair-accessible| Wheelchair Accessible');
            }
            if (text.includes('business') || text.includes('corporate') || text.includes('conference')) {
                suggestions.push('business-travelers| Business Travelers');
            }
            if (text.includes('remote work') || text.includes('digital nomad') || text.includes('work from')) {
                suggestions.push('digital-nomads| Digital Nomads');
            }
            
            // Themes
            if (text.includes('romantic') || text.includes('couples') || text.includes('honeymoon') || text.includes('anniversary')) {
                suggestions.push('romantic| Romantic / Couples');
            }
            if (text.includes('spa') || text.includes('wellness') || text.includes('yoga') || text.includes('meditation')) {
                suggestions.push('wellness-spa| Wellness / Spa');
            }
            if (text.includes('adventure') || text.includes('outdoor') || text.includes('active')) {
                suggestions.push('adventure| Adventure');
            }
            if (text.includes('eco') || text.includes('sustainable') || text.includes('green') || text.includes('organic')) {
                suggestions.push('eco-friendly| Eco-Friendly / Sustainable');
            }
            if (text.includes('luxury') || text.includes('premium') || text.includes('upscale') || text.includes('5 star')) {
                suggestions.push('luxury| Luxury');
            }
            if (text.includes('budget') || text.includes('affordable') || text.includes('cheap') || text.includes('value')) {
                suggestions.push('budget-friendly| Budget Friendly');
            }
            if (text.includes('historic') || text.includes('heritage') || text.includes('victorian') || text.includes('period')) {
                suggestions.push('historic| Historic / Heritage');
            }
            if (text.includes('boutique') || text.includes('unique') || text.includes('character')) {
                suggestions.push('boutique| Boutique / Unique');
            }
            if (text.includes('farm') || text.includes('agri') || text.includes('rural retreat')) {
                suggestions.push('farm-stay| Farm Stay / Agritourism');
            }
            if (text.includes('glamping') || text.includes('tent') || text.includes('yurt') || text.includes('treehouse')) {
                suggestions.push('glamping| Glamping');
            }
            
            // Location
            if (text.includes('beach') || text.includes('seafront') || text.includes('oceanfront')) {
                suggestions.push('beachfront| Beachfront');
            }
            if (text.includes('mountain') || text.includes('hill') || text.includes('peak')) {
                suggestions.push('mountain-view| Mountain View');
            }
            if (text.includes('countryside') || text.includes('rural') || text.includes('pastoral')) {
                suggestions.push('countryside| Countryside');
            }
            if (text.includes('city') || text.includes('urban') || text.includes('downtown') || text.includes('town centre')) {
                suggestions.push('city-centre| City Centre');
            }
            if (text.includes('lake') || text.includes('loch')) {
                suggestions.push('lakeside| Lakeside');
            }
            if (text.includes('river')) {
                suggestions.push('riverside| Riverside');
            }
            if (text.includes('forest') || text.includes('woodland') || text.includes('woods')) {
                suggestions.push('forest| Forest / Woodland');
            }
            if (text.includes('village') || text.includes('hamlet')) {
                suggestions.push('village| Village / Rural');
            }
            if (text.includes('coast') || text.includes('seaside') || text.includes('sea view')) {
                suggestions.push('coastal| Coastal');
            }
            if (text.includes('island')) {
                suggestions.push('island| Island');
            }
            
            // Amenities
            if (text.includes('ev') || text.includes('electric car') || text.includes('charging')) {
                suggestions.push('ev-charging| EV Charging');
            }
            if (text.includes('pool') || text.includes('swimming')) {
                suggestions.push('swimming-pool| Swimming Pool');
            }
            if (text.includes('hot tub') || text.includes('jacuzzi') || text.includes('spa bath')) {
                suggestions.push('hot-tub| Hot Tub / Jacuzzi');
            }
            if (text.includes('sauna')) {
                suggestions.push('sauna| Sauna');
            }
            if (text.includes('gym') || text.includes('fitness')) {
                suggestions.push('gym| Gym / Fitness');
            }
            if (text.includes('garden')) {
                suggestions.push('garden| Garden');
            }
            if (text.includes('bbq') || text.includes('barbecue') || text.includes('grill')) {
                suggestions.push('bbq| BBQ Area');
            }
            if (text.includes('fireplace') || text.includes('log fire') || text.includes('wood burner')) {
                suggestions.push('fireplace| Fireplace');
            }
            if (text.includes('parking')) {
                suggestions.push('private-parking| Private Parking');
            }
            if (text.includes('restaurant') || text.includes('dining') || text.includes('breakfast')) {
                suggestions.push('restaurant| On-site Restaurant');
            }
            
            return suggestions;
        }
        
        function displayAISuggestions(content) {
            const container = document.getElementById('ai-suggestions-list');
            const resultsDiv = document.getElementById('ai-suggestions-results');
            
            let suggestions = [];
            
            // If content is already in our format (feature|label)
            if (content.includes('|')) {
                suggestions = content.split('\n').filter(s => s.includes('|'));
            } else {
                // Parse AI text response to extract features
                suggestions = analyzePromptForFeatures(content);
            }
            
            if (suggestions.length === 0) {
                container.innerHTML = '<p style="color: #64748b;">No specific features detected. Try adding more detail to your description.</p>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '';
            suggestions.forEach(s => {
                const [featureKey, label] = s.split('|');
                html += `
                    <button type="button" class="ai-suggestion-btn" onclick="applySuggestion('${featureKey}')" 
                        style="padding: 0.5rem 1rem; background: #f0fdf4; border: 1px solid #86efac; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
                        ${label} <span style="color: #16a34a;">+ Add</span>
                    </button>
                `;
            });
            
            container.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function applySuggestion(featureKey) {
            const checkbox = document.querySelector(`input[data-feature="${featureKey}"]`);
            if (checkbox) {
                checkbox.checked = true;
                // Visual feedback
                const btn = event.target.closest('.ai-suggestion-btn');
                if (btn) {
                    btn.style.background = '#dcfce7';
                    btn.style.borderColor = '#22c55e';
                    btn.innerHTML = btn.innerHTML.replace('+ Add', ' Added');
                    btn.disabled = true;
                }
            } else {
                // It's a custom feature, add it
                if (!customFeatures.includes(featureKey)) {
                    customFeatures.push(featureKey);
                    renderCustomFeatures();
                }
            }
        }

        // 
        // BULK EDIT FUNCTIONS
        // 
        
        function openBulkEditModal() {
            try {
                // Set default dates
                const today = new Date();
                const threeMonths = new Date();
                threeMonths.setMonth(threeMonths.getMonth() + 3);
                
                document.getElementById('bulk-date-from').value = today.toISOString().split('T')[0];
                document.getElementById('bulk-date-to').value = threeMonths.toISOString().split('T')[0];
                
                // Reset to price type
                document.querySelector('input[name="bulk-edit-type"][value="price"]').checked = true;
                toggleBulkEditType();
                
                // Load rooms and offers
                loadBulkRooms();
                loadBulkOffers();
                
                document.getElementById('bulkEditModal').classList.add('active');
            } catch (error) {
                console.error('Error opening Bulk Edit modal:', error);
                showNotification('Error opening Bulk Edit: ' + error.message, 'error');
            }
        }
        
        function toggleBulkEditType() {
            const editType = document.querySelector('input[name="bulk-edit-type"]:checked').value;
            
            // Hide all value inputs
            document.getElementById('bulk-price-input').style.display = 'none';
            document.getElementById('bulk-minstay-input').style.display = 'none';
            document.getElementById('bulk-closed-input').style.display = 'none';
            document.getElementById('bulk-offers-section').style.display = 'none';
            
            // Show relevant input
            if (editType === 'price') {
                document.getElementById('bulk-price-input').style.display = 'block';
            } else if (editType === 'minstay') {
                document.getElementById('bulk-minstay-input').style.display = 'block';
                document.getElementById('bulk-offers-section').style.display = 'block';
            } else if (editType === 'closed') {
                document.getElementById('bulk-closed-input').style.display = 'block';
                document.getElementById('bulk-offers-section').style.display = 'block';
            }
            
            // Update price symbol based on action
            const priceAction = document.getElementById('bulk-price-action');
            if (priceAction) {
                priceAction.onchange = function() {
                    const symbol = this.value.includes('pct') ? '%' : '$';
                    document.getElementById('bulk-price-symbol').textContent = symbol;
                };
            }
        }
        
        async function loadBulkRooms() {
            const container = document.getElementById('bulk-rooms-list');
            container.innerHTML = '<p style="padding: 0.75rem; color: #6b7280;">Loading rooms...</p>';
            
            try {
                // Get all properties (filtered by account)
                const queryString = buildQueryString();
                const propsRes = await fetch(`/api/db/properties${queryString}`);
                const propsData = await propsRes.json();
                
                if (!propsData.success || !propsData.data?.length) {
                    container.innerHTML = '<p style="padding: 0.75rem; color: #6b7280;">No properties found</p>';
                    return;
                }
                
                let html = '';
                for (const prop of propsData.data) {
                    // Get rooms for this property
                    const roomsRes = await fetch(`/api/db/bookable-units?property_id=${prop.id}`);
                    const roomsData = await roomsRes.json();
                    
                    if (roomsData.success && roomsData.data?.length) {
                        html += `<div style="padding: 0.5rem 0.75rem; background: #f8fafc; font-weight: 600; font-size: 0.85rem; border-bottom: 1px solid #e5e7eb;">${prop.name}</div>`;
                        
                        for (const room of roomsData.data) {
                            html += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid #f1f5f9;">
                                    <input type="checkbox" class="bulk-room-cb" data-room-id="${room.id}" data-property-id="${prop.id}" checked>
                                    <span style="font-size: 0.9rem;">${room.name}</span>
                                </label>
                            `;
                        }
                    }
                }
                
                container.innerHTML = html || '<p style="padding: 0.75rem; color: #6b7280;">No rooms found</p>';
            } catch (error) {
                console.error('Error loading rooms:', error);
                container.innerHTML = '<p style="padding: 0.75rem; color: #ef4444;">Error loading rooms</p>';
            }
        }
        
        async function loadBulkOffers() {
            const container = document.getElementById('bulk-offers-list');
            container.innerHTML = '<p style="padding: 0.75rem; color: #6b7280;">Loading offers...</p>';
            
            try {
                // Always include Standard Price
                let html = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid #f1f5f9; background: #ecfdf5;">
                        <input type="checkbox" class="bulk-offer-cb" data-offer-id="standard" checked>
                        <span style="font-size: 0.9rem; font-weight: 600;"> Standard Price</span>
                    </label>
                `;
                
                // Get other offers
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/offers${queryString}`);
                const data = await response.json();
                
                if (data.success && data.data?.length) {
                    for (const offer of data.data) {
                        if (offer.name !== 'Standard Price') {
                            html += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid #f1f5f9;">
                                    <input type="checkbox" class="bulk-offer-cb" data-offer-id="${offer.id}" checked>
                                    <span style="font-size: 0.9rem;"> ${offer.name}</span>
                                </label>
                            `;
                        }
                    }
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading offers:', error);
                // Still show Standard Price even if API fails
                container.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; background: #ecfdf5;">
                        <input type="checkbox" class="bulk-offer-cb" data-offer-id="standard" checked>
                        <span style="font-size: 0.9rem; font-weight: 600;"> Standard Price</span>
                    </label>
                `;
            }
        }
        
        async function applyBulkEdit() {
            const editType = document.querySelector('input[name="bulk-edit-type"]:checked').value;
            const fromDate = new Date(document.getElementById('bulk-date-from').value);
            const toDate = new Date(document.getElementById('bulk-date-to').value);
            
            // Get selected days
            const selectedDays = [];
            document.querySelectorAll('.bulk-day-cb:checked').forEach(cb => {
                selectedDays.push(parseInt(cb.dataset.day));
            });
            
            // Get selected rooms
            const selectedRooms = [];
            document.querySelectorAll('.bulk-room-cb:checked').forEach(cb => {
                selectedRooms.push({
                    roomId: cb.dataset.roomId,
                    propertyId: cb.dataset.propertyId
                });
            });
            
            if (selectedRooms.length === 0) {
                alert('Please select at least one room');
                return;
            }
            
            if (selectedDays.length === 0) {
                alert('Please select at least one day of the week');
                return;
            }
            
            // Generate dates to update
            const datesToUpdate = [];
            const current = new Date(fromDate);
            while (current <= toDate) {
                if (selectedDays.includes(current.getDay())) {
                    datesToUpdate.push(current.toISOString().split('T')[0]);
                }
                current.setDate(current.getDate() + 1);
            }
            
            if (datesToUpdate.length === 0) {
                alert('No dates match your criteria');
                return;
            }
            
            // Get value based on type
            let actionDesc = '';
            if (editType === 'price') {
                const action = document.getElementById('bulk-price-action').value;
                const value = parseFloat(document.getElementById('bulk-price-value').value) || 0;
                actionDesc = `Price: ${action} ${value}`;
            } else if (editType === 'minstay') {
                const value = parseInt(document.getElementById('bulk-minstay-value').value) || 1;
                actionDesc = `Min Stay: ${value} nights`;
            } else if (editType === 'closed') {
                const closeCheckin = document.getElementById('bulk-close-checkin').checked;
                const closeCheckout = document.getElementById('bulk-close-checkout').checked;
                actionDesc = `Close: ${closeCheckin ? 'Check-in' : ''} ${closeCheckout ? 'Check-out' : ''}`;
            }
            
            // Confirm
            const confirmMsg = `This will apply:\n${actionDesc}\n\nTo:\n ${selectedRooms.length} room(s)\n ${datesToUpdate.length} date(s)\n\nContinue?`;
            if (!confirm(confirmMsg)) return;
            
            // Show progress
            const btn = document.getElementById('bulk-apply-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Applying...';
            btn.disabled = true;
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const room of selectedRooms) {
                    for (const date of datesToUpdate) {
                        try {
                            let payload = { date };
                            
                            if (editType === 'price') {
                                const action = document.getElementById('bulk-price-action').value;
                                const value = parseFloat(document.getElementById('bulk-price-value').value) || 0;
                                
                                // For set, just set the price
                                // For increase/decrease, we'd need to get current price first
                                if (action === 'set') {
                                    payload.standard_price = value;
                                } else {
                                    // Get current price first
                                    const currentRes = await fetch(`/api/availability/${room.roomId}?from=${date}&to=${date}`);
                                    const currentData = await currentRes.json();
                                    const currentPrice = parseFloat(currentData.availability?.[0]?.standard_price || currentData.availability?.[0]?.cm_price || 0);
                                    
                                    if (action === 'increase') {
                                        payload.standard_price = currentPrice + value;
                                    } else if (action === 'decrease') {
                                        payload.standard_price = Math.max(0, currentPrice - value);
                                    } else if (action === 'increase_pct') {
                                        payload.standard_price = currentPrice * (1 + value / 100);
                                    } else if (action === 'decrease_pct') {
                                        payload.standard_price = currentPrice * (1 - value / 100);
                                    }
                                }
                            } else if (editType === 'minstay') {
                                payload.min_stay = parseInt(document.getElementById('bulk-minstay-value').value) || 1;
                            }
                            
                            const response = await fetch(`/api/rooms/${room.roomId}/daily-rates`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                                body: JSON.stringify(payload)
                            });
                            
                            if (response.ok) {
                                successCount++;
                            } else {
                                errorCount++;
                            }
                        } catch (e) {
                            errorCount++;
                        }
                    }
                }
                
                alert(`Bulk update complete!\n ${successCount} successful\n ${errorCount} failed`);
                
                // Refresh the grid
                if (typeof loadOffersPricingGrid === 'function') {
                    loadOffersPricingGrid();
                }
                
                closeModal('bulkEditModal');
            } catch (error) {
                alert('Error applying bulk update: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Track offer changes for saving
        const offerChanges = {};
        
        // Track standard price restriction changes
        let standardRestrictions = {
            min_nights: 1,
            allowed_checkin_days: '0,1,2,3,4,5,6',
            allowed_checkout_days: '0,1,2,3,4,5,6',
            changed: false
        };
        
        function markStandardRestrictionChanged(input) {
            input.style.background = '#fef3c7';
            input.style.borderColor = '#f59e0b';
            standardRestrictions.min_nights = parseInt(input.value) || 1;
            standardRestrictions.changed = true;
            document.getElementById('unsaved-indicator').style.display = 'inline';
        }
        
        function toggleStandardClosedDay(btn) {
            // Cycle through states: Open -> No CI -> No CO -> Closed -> Open
            let ci = parseInt(btn.dataset.ci);
            let co = parseInt(btn.dataset.co);
            
            if (ci && co) {
                ci = 0; co = 1;
            } else if (!ci && co) {
                ci = 1; co = 0;
            } else if (ci && !co) {
                ci = 0; co = 0;
            } else {
                ci = 1; co = 1;
            }
            
            btn.dataset.ci = ci;
            btn.dataset.co = co;
            
            let display = '';
            if (!ci && !co) {
                display = '';
            } else if (!ci) {
                display = 'CI';
            } else if (!co) {
                display = 'CO';
            }
            
            btn.innerHTML = display || '';
            btn.style.background = display ? '#fee2e2' : 'white';
            btn.style.borderColor = display ? '#fca5a5' : '#d1d5db';
            btn.style.color = display ? '#dc2626' : '#9ca3af';
            
            standardRestrictions.changed = true;
            document.getElementById('unsaved-indicator').style.display = 'inline';
            
            // Recalculate allowed days from all buttons
            updateStandardClosedDays();
        }
        
        function updateStandardClosedDays() {
            const buttons = document.querySelectorAll('.closed-toggle-btn[data-offer="standard"]');
            const checkinDays = new Set();
            const checkoutDays = new Set();
            
            buttons.forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (parseInt(btn.dataset.ci)) checkinDays.add(day);
                if (parseInt(btn.dataset.co)) checkoutDays.add(day);
            });
            
            standardRestrictions.allowed_checkin_days = Array.from(checkinDays).sort().join(',') || '0,1,2,3,4,5,6';
            standardRestrictions.allowed_checkout_days = Array.from(checkoutDays).sort().join(',') || '0,1,2,3,4,5,6';
        }
        
        function markOfferChanged(input, offerId) {
            input.style.background = '#fef3c7';
            input.style.borderColor = '#f59e0b';
            
            if (!offerChanges[offerId]) {
                offerChanges[offerId] = { min_nights: input.value };
            } else {
                offerChanges[offerId].min_nights = input.value;
            }
            
            document.getElementById('unsaved-indicator').style.display = 'inline';
        }
        
        function toggleClosedDay(btn, offerId) {
            // Cycle through states: Open -> No CI -> No CO -> Closed -> Open
            let ci = parseInt(btn.dataset.ci);
            let co = parseInt(btn.dataset.co);
            
            if (ci && co) {
                // Currently open -> close for check-in
                ci = 0;
                co = 1;
            } else if (!ci && co) {
                // No CI -> close for check-out
                ci = 1;
                co = 0;
            } else if (ci && !co) {
                // No CO -> close for both
                ci = 0;
                co = 0;
            } else {
                // Closed -> open
                ci = 1;
                co = 1;
            }
            
            btn.dataset.ci = ci;
            btn.dataset.co = co;
            
            // Update display
            let display = '';
            let title = 'Open for check-in and check-out';
            if (!ci && !co) {
                display = '';
                title = 'Closed for both check-in and check-out';
            } else if (!ci) {
                display = 'CI';
                title = 'Closed for check-in';
            } else if (!co) {
                display = 'CO';
                title = 'Closed for check-out';
            }
            
            btn.innerHTML = display || '';
            btn.style.background = display ? '#fee2e2' : 'white';
            btn.style.borderColor = display ? '#fca5a5' : '#d1d5db';
            btn.style.color = display ? '#dc2626' : '#9ca3af';
            btn.title = title;
            
            // Mark as changed
            document.getElementById('unsaved-indicator').style.display = 'inline';
            
            // Collect all buttons for this offer to recalculate allowed days
            updateOfferClosedDays(offerId);
        }
        
        function updateOfferClosedDays(offerId) {
            const buttons = document.querySelectorAll(`.closed-toggle-btn[data-offer="${offerId}"]`);
            const checkinDays = new Set();
            const checkoutDays = new Set();
            
            buttons.forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (parseInt(btn.dataset.ci)) checkinDays.add(day);
                if (parseInt(btn.dataset.co)) checkoutDays.add(day);
            });
            
            if (!offerChanges[offerId]) offerChanges[offerId] = {};
            offerChanges[offerId].allowed_checkin_days = Array.from(checkinDays).sort().join(',') || '0,1,2,3,4,5,6';
            offerChanges[offerId].allowed_checkout_days = Array.from(checkoutDays).sort().join(',') || '0,1,2,3,4,5,6';
        }
        
        async function saveOfferRestrictions() {
            const offerIds = Object.keys(offerChanges);
            const hasStandardChanges = standardRestrictions.changed;
            
            if (offerIds.length === 0 && !hasStandardChanges) {
                alert('No restriction changes to save');
                return;
            }
            
            let saved = 0;
            let errors = 0;
            
            // Save standard price restrictions (stored in availability or a separate endpoint)
            if (hasStandardChanges) {
                try {
                    // For now, we'll create/update a "Standard Price" offer to store these restrictions
                    // Or you can store in room settings - this is a placeholder
                    const roomId = document.getElementById('offers-room-select').value;
                    
                    // Check if Standard Price offer exists for this room
                    const offersCheckQuery = buildQueryString();
                    const checkResp = await fetch(`/api/admin/offers${offersCheckQuery}`);
                    const checkData = await checkResp.json();
                    const existingStdOffer = (checkData.data || []).find(o => o.name === 'Standard Price' && o.room_id == roomId);
                    
                    if (existingStdOffer) {
                        // Update existing
                        const response = await fetch(`/api/admin/offers/${existingStdOffer.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({
                                ...existingStdOffer,
                                min_nights: standardRestrictions.min_nights,
                                allowed_checkin_days: standardRestrictions.allowed_checkin_days,
                                allowed_checkout_days: standardRestrictions.allowed_checkout_days
                            })
                        });
                        const result = await response.json();
                        if (result.success) saved++;
                        else errors++;
                    } else {
                        // Create new Standard Price offer for this room
                        const response = await fetch('/api/admin/offers', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({
                                name: 'Standard Price',
                                description: 'Standard website price with restrictions',
                                room_id: roomId,
                                discount_type: 'percentage',
                                discount_value: 0,
                                min_nights: standardRestrictions.min_nights,
                                allowed_checkin_days: standardRestrictions.allowed_checkin_days,
                                allowed_checkout_days: standardRestrictions.allowed_checkout_days,
                                active: true,
                                available_website: true
                            })
                        });
                        const result = await response.json();
                        if (result.success) saved++;
                        else errors++;
                    }
                    
                    standardRestrictions.changed = false;
                } catch (error) {
                    console.error('Error saving standard restrictions:', error);
                    errors++;
                }
            }
            
            // Save other offer restrictions
            for (const offerId of offerIds) {
                try {
                    // Get current offer data first
                    const getResp = await fetch(`/api/admin/offers/${offerId}`);
                    const getData = await getResp.json();
                    
                    if (getData.success) {
                        const offer = getData.data;
                        const changes = offerChanges[offerId];
                        
                        // Merge changes
                        const updateData = {
                            ...offer,
                            min_nights: changes.min_nights || offer.min_nights,
                            allowed_checkin_days: changes.allowed_checkin_days || offer.allowed_checkin_days,
                            allowed_checkout_days: changes.allowed_checkout_days || offer.allowed_checkout_days
                        };
                        
                        const response = await fetch(`/api/admin/offers/${offerId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify(updateData)
                        });
                        const result = await response.json();
                        
                        if (result.success) saved++;
                        else errors++;
                    }
                } catch (error) {
                    console.error('Error saving offer:', error);
                    errors++;
                }
            }
            
            // Clear changes
            Object.keys(offerChanges).forEach(k => delete offerChanges[k]);
            document.getElementById('unsaved-indicator').style.display = 'none';
            
            if (errors > 0) {
                alert(`Saved ${saved} offers, ${errors} errors`);
            } else {
                alert(` Saved ${saved} offer restriction${saved !== 1 ? 's' : ''} successfully!`);
            }
            
            // Reload the grid
            loadOffersPricingGrid();
        }
        
        function renderOfferDistribution(offers) {
            const container = document.getElementById('offer-distribution-list');
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.5rem;">Offer</th>
                            <th style="text-align: left; padding: 0.5rem;">Applies To</th>
                            <th style="text-align: center; padding: 0.5rem;">Own Website</th>
                            <th style="text-align: center; padding: 0.5rem;">Travel Agents</th>
                            <th style="text-align: center; padding: 0.5rem;">Status</th>
                            <th style="text-align: right; padding: 0.5rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const offer of offers) {
                const isStandard = offer.id === 'standard' || offer.name === 'Standard Price';
                
                // Build "Applies To" text - handle arrays
                let appliesTo = 'All Properties';
                if (offer.room_ids && offer.room_ids.length > 0) {
                    appliesTo = offer.room_ids.length + ' Room' + (offer.room_ids.length > 1 ? 's' : '');
                } else if (offer.property_ids && offer.property_ids.length > 0) {
                    appliesTo = offer.property_ids.length + ' Propert' + (offer.property_ids.length > 1 ? 'ies' : 'y');
                } else if (offer.room_name) {
                    appliesTo = offer.room_name;
                } else if (offer.property_name) {
                    appliesTo = offer.property_name;
                } else if (offer.room_id) {
                    appliesTo = 'Room #' + offer.room_id;
                } else if (offer.property_id) {
                    appliesTo = 'Property #' + offer.property_id;
                }
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${isStandard ? ' ' : ' '}${offer.name}</strong>
                        </td>
                        <td style="padding: 0.75rem; font-size: 0.85rem; color: #6b7280;">
                            ${appliesTo}
                        </td>
                        <td style="text-align: center; padding: 0.75rem;">
                            <input type="checkbox" ${isStandard || offer.available_website !== false ? 'checked' : ''} 
                                onchange="updateOfferDistribution(${offer.id}, 'website', this.checked)"
                                ${isStandard ? 'disabled' : ''}>
                        </td>
                        <td style="text-align: center; padding: 0.75rem;">
                            <input type="checkbox" ${offer.available_agents ? 'checked' : ''} 
                                onchange="updateOfferDistribution(${offer.id}, 'agents', this.checked)"
                                ${isStandard ? 'disabled' : ''}>
                        </td>
                        <td style="text-align: center; padding: 0.75rem;">
                            <span class="badge ${offer.active !== false ? 'badge-success' : 'badge-secondary'}">
                                ${offer.active !== false ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="text-align: right; padding: 0.75rem;">
                            ${!isStandard ? `
                                <button onclick="editOffer(${offer.id})" style="background: none; border: none; cursor: pointer;" title="Edit">&#9998;</button>
                                <button onclick="deleteOffer(${offer.id})" style="background: none; border: none; cursor: pointer; color: #ef4444;" title="Delete">&#10006;</button>
                            ` : '<span style="color: #9ca3af; font-size: 0.8rem;">Default</span>'}
                        </td>
                    </tr>
                `;
            }
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        
        async function updateOfferDistribution(offerId, channel, enabled) {
            if (offerId === 'standard') return;
            
            try {
                const field = channel === 'website' ? 'available_website' : 'available_agents';
                await fetch(`/api/admin/offers/${offerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ [field]: enabled })
                });
            } catch (error) {
                console.error('Error updating offer distribution:', error);
            }
        }
        
        function shiftOffersDays(days) {
            offersStartDate.setDate(offersStartDate.getDate() + days);
            loadOffersPricingGrid();
        }
        
        function offersGoToToday() {
            offersStartDate = new Date();
            offersStartDate.setHours(0, 0, 0, 0);
            loadOffersPricingGrid();
        }
        
        function togglePricePerNightField() {
            const tier = document.getElementById('offer-pricing-tier').value;
            const section = document.getElementById('price-per-night-section');
            const discountSection = document.getElementById('offer-discount-value')?.parentElement;
            
            if (tier !== 'standard') {
                section.style.display = 'block';
                // Hide discount fields for non-standard tiers
                if (discountSection) discountSection.style.opacity = '0.5';
            } else {
                section.style.display = 'none';
                if (discountSection) discountSection.style.opacity = '1';
            }
        }
        
        function openAddOfferModal() {
            document.getElementById('offer-form').reset();
            document.getElementById('offer-id').value = '';
            document.getElementById('offer-modal-title').innerHTML = ' Create New Offer';
            document.getElementById('offer-active').checked = true;
            document.getElementById('offer-pricing-tier').value = 'standard';
            document.getElementById('offer-price-per-night').value = '';
            togglePricePerNightField();
            updateOfferToggleVisual(document.getElementById('offer-active'));
            
            // Reset all check-in/check-out day checkboxes to checked
            ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach(day => {
                const checkinCb = document.getElementById('checkin-' + day);
                const checkoutCb = document.getElementById('checkout-' + day);
                if (checkinCb) checkinCb.checked = true;
                if (checkoutCb) checkoutCb.checked = true;
            });
            
            updateDiscountDisplay();
            loadPropertiesForOfferDropdown();
            openModal('addOfferModal');
        }
        
        function updateDiscountDisplay() {
            const type = document.getElementById('offer-discount-type').value;
            const suffix = document.getElementById('discount-suffix');
            if (type === 'percentage') {
                suffix.textContent = '%';
            } else {
                suffix.textContent = '$';
            }
        }
        
        // Add event listener for discount type change
        document.addEventListener('DOMContentLoaded', function() {
            const discountType = document.getElementById('offer-discount-type');
            if (discountType) {
                discountType.addEventListener('change', updateDiscountDisplay);
            }
        });
        
        async function loadPropertiesForOfferDropdown() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const propList = document.getElementById('offer-properties-list');
                propList.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px; background: #f0fdf4;" class="offer-prop-option">
                        <input type="checkbox" name="offer-properties" value="" checked onchange="handleAllPropertiesChange(this)">
                        <span style="font-size: 0.9rem; font-weight: 500;"> All Properties</span>
                    </label>
                `;
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        propList.innerHTML += `
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px;" class="offer-prop-option" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" name="offer-properties" value="${p.id}" onchange="handlePropertyCheckChange(this)">
                                <span style="font-size: 0.9rem;">${p.name}</span>
                            </label>
                        `;
                    });
                }
                
                // Load all rooms initially
                await loadRoomsForOfferCheckboxes('');
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        function handleAllPropertiesChange(checkbox) {
            const allCheckboxes = document.querySelectorAll('input[name="offer-properties"]');
            if (checkbox.checked) {
                // Uncheck all individual properties
                allCheckboxes.forEach(cb => {
                    if (cb.value !== '') cb.checked = false;
                });
            }
            filterRoomsBySelectedProperties();
        }
        
        function handlePropertyCheckChange(checkbox) {
            const allCheckbox = document.querySelector('input[name="offer-properties"][value=""]');
            if (checkbox.checked) {
                // Uncheck "All Properties"
                allCheckbox.checked = false;
            } else {
                // If no properties selected, check "All"
                const anySelected = document.querySelectorAll('input[name="offer-properties"]:checked');
                if (anySelected.length === 0) {
                    allCheckbox.checked = true;
                }
            }
            filterRoomsBySelectedProperties();
        }
        
        function filterRoomsBySelectedProperties() {
            const selectedProps = [];
            document.querySelectorAll('input[name="offer-properties"]:checked').forEach(cb => {
                if (cb.value !== '') selectedProps.push(cb.value);
            });
            loadRoomsForOfferCheckboxes(selectedProps);
        }
        
        async function loadRoomsForOfferCheckboxes(propertyIds) {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/bookable-units${queryString}`);
                const data = await response.json();
                
                const roomList = document.getElementById('offer-rooms-list');
                roomList.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px; background: #f0fdf4;" class="offer-room-option">
                        <input type="checkbox" name="offer-rooms" value="" checked onchange="handleAllRoomsChange(this)">
                        <span style="font-size: 0.9rem; font-weight: 500;"> All Rooms</span>
                    </label>
                `;
                
                if (data.success && data.data) {
                    let rooms = data.data;
                    // Filter by selected properties if any
                    if (Array.isArray(propertyIds) && propertyIds.length > 0) {
                        rooms = rooms.filter(r => propertyIds.includes(String(r.property_id)));
                    }
                    
                    rooms.forEach(r => {
                        roomList.innerHTML += `
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px;" class="offer-room-option" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" name="offer-rooms" value="${r.id}" onchange="handleRoomCheckChange(this)">
                                <span style="font-size: 0.9rem;">${r.name}</span>
                            </label>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        function handleAllRoomsChange(checkbox) {
            const allCheckboxes = document.querySelectorAll('input[name="offer-rooms"]');
            if (checkbox.checked) {
                allCheckboxes.forEach(cb => {
                    if (cb.value !== '') cb.checked = false;
                });
            }
        }
        
        function handleRoomCheckChange(checkbox) {
            const allCheckbox = document.querySelector('input[name="offer-rooms"][value=""]');
            if (checkbox.checked) {
                allCheckbox.checked = false;
            } else {
                const anySelected = document.querySelectorAll('input[name="offer-rooms"]:checked');
                if (anySelected.length === 0) {
                    allCheckbox.checked = true;
                }
            }
        }
        
        function updateOfferToggleVisual(checkbox) {
            const slider = document.getElementById('offer-active-slider');
            const dot = document.getElementById('offer-active-dot');
            if (checkbox.checked) {
                slider.style.backgroundColor = '#22c55e';
                dot.style.left = '25px';
            } else {
                slider.style.backgroundColor = '#ccc';
                dot.style.left = '3px';
            }
        }
        
        function getSelectedOfferProperties() {
            const selected = [];
            document.querySelectorAll('input[name="offer-properties"]:checked').forEach(cb => {
                if (cb.value !== '') selected.push(parseInt(cb.value));
            });
            return selected.length > 0 ? selected : null;
        }
        
        function getSelectedOfferRooms() {
            const selected = [];
            document.querySelectorAll('input[name="offer-rooms"]:checked').forEach(cb => {
                if (cb.value !== '') selected.push(parseInt(cb.value));
            });
            return selected.length > 0 ? selected : null;
        }
        
        async function editOffer(id) {
            try {
                const response = await fetch(`/api/admin/offers/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const offer = data.data;
                    document.getElementById('offer-id').value = offer.id;
                    document.getElementById('offer-name').value = offer.name || '';
                    document.getElementById('offer-description').value = offer.description || '';
                    document.getElementById('offer-discount-type').value = offer.discount_type || 'percentage';
                    document.getElementById('offer-discount-value').value = offer.discount_value || '';
                    document.getElementById('offer-min-nights').value = offer.min_nights || '';
                    document.getElementById('offer-max-nights').value = offer.max_nights || '';
                    document.getElementById('offer-min-advance').value = offer.min_advance_days || '';
                    document.getElementById('offer-max-advance').value = offer.max_advance_days || '';
                    document.getElementById('offer-valid-from').value = offer.valid_from || '';
                    document.getElementById('offer-valid-until').value = offer.valid_until || '';
                    document.getElementById('offer-priority').value = offer.priority || 0;
                    document.getElementById('offer-active').checked = offer.active;
                    document.getElementById('offer-pricing-tier').value = offer.pricing_tier || 'standard';
                    document.getElementById('offer-price-per-night').value = offer.price_per_night || '';
                    togglePricePerNightField();
                    updateOfferToggleVisual(document.getElementById('offer-active'));
                    
                    // Set check-in day checkboxes
                    const checkinDays = (offer.allowed_checkin_days || '0,1,2,3,4,5,6').split(',').map(d => d.trim());
                    ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach((day, idx) => {
                        const cb = document.getElementById('checkin-' + day);
                        if (cb) cb.checked = checkinDays.includes(String(idx));
                    });
                    
                    // Set check-out day checkboxes
                    const checkoutDays = (offer.allowed_checkout_days || '0,1,2,3,4,5,6').split(',').map(d => d.trim());
                    ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach((day, idx) => {
                        const cb = document.getElementById('checkout-' + day);
                        if (cb) cb.checked = checkoutDays.includes(String(idx));
                    });
                    
                    document.getElementById('offer-modal-title').innerHTML = ' Edit Offer';
                    updateDiscountDisplay();
                    await loadPropertiesForOfferDropdown();
                    
                    // Set property checkboxes based on offer data
                    const propertyIds = offer.property_ids || (offer.property_id ? [offer.property_id] : []);
                    if (propertyIds.length === 0) {
                        // All properties
                        document.querySelector('input[name="offer-properties"][value=""]').checked = true;
                    } else {
                        document.querySelector('input[name="offer-properties"][value=""]').checked = false;
                        propertyIds.forEach(pid => {
                            const cb = document.querySelector(`input[name="offer-properties"][value="${pid}"]`);
                            if (cb) cb.checked = true;
                        });
                    }
                    
                    // Load and set room checkboxes
                    await loadRoomsForOfferCheckboxes(propertyIds);
                    const roomIds = offer.room_ids || (offer.room_id ? [offer.room_id] : []);
                    if (roomIds.length === 0) {
                        document.querySelector('input[name="offer-rooms"][value=""]').checked = true;
                    } else {
                        document.querySelector('input[name="offer-rooms"][value=""]').checked = false;
                        roomIds.forEach(rid => {
                            const cb = document.querySelector(`input[name="offer-rooms"][value="${rid}"]`);
                            if (cb) cb.checked = true;
                        });
                    }
                    
                    openModal('addOfferModal');
                }
            } catch (error) {
                alert('Error loading offer: ' + error.message);
            }
        }
        
        function getCheckedDays(prefix) {
            const days = [];
            ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach((day, idx) => {
                const cb = document.getElementById(prefix + '-' + day);
                if (cb && cb.checked) days.push(idx);
            });
            return days.join(',');
        }
        
        async function saveOffer() {
            const id = document.getElementById('offer-id').value;
            
            // Get selected properties and rooms from checkboxes
            const selectedPropertyIds = getSelectedOfferProperties();
            const selectedRoomIds = getSelectedOfferRooms();
            
            // Get account_id - use selectedAccountId if set, otherwise try to get from first selected property
            let offerAccountId = selectedAccountId;
            if (!offerAccountId && selectedPropertyIds && selectedPropertyIds.length > 0) {
                // Fetch account_id from the first selected property
                try {
                    const propResponse = await fetch(`/api/db/properties?id=${selectedPropertyIds[0]}`);
                    const propData = await propResponse.json();
                    if (propData.success && propData.data && propData.data.length > 0) {
                        offerAccountId = propData.data[0].account_id;
                    }
                } catch (e) {
                    console.log('Could not fetch property account_id:', e);
                }
            }
            
            const offerData = {
                name: document.getElementById('offer-name').value,
                description: document.getElementById('offer-description').value,
                discount_type: document.getElementById('offer-discount-type').value,
                discount_value: parseFloat(document.getElementById('offer-discount-value').value),
                price_per_night: parseFloat(document.getElementById('offer-price-per-night').value) || null,
                property_ids: selectedPropertyIds,
                room_ids: selectedRoomIds,
                // Keep legacy single property_id/room_id for backward compatibility
                property_id: selectedPropertyIds && selectedPropertyIds.length === 1 ? selectedPropertyIds[0] : null,
                room_id: selectedRoomIds && selectedRoomIds.length === 1 ? selectedRoomIds[0] : null,
                account_id: offerAccountId,
                min_nights: parseInt(document.getElementById('offer-min-nights').value) || 1,
                max_nights: parseInt(document.getElementById('offer-max-nights').value) || null,
                min_advance_days: parseInt(document.getElementById('offer-min-advance').value) || null,
                max_advance_days: parseInt(document.getElementById('offer-max-advance').value) || null,
                valid_from: document.getElementById('offer-valid-from').value || null,
                valid_until: document.getElementById('offer-valid-until').value || null,
                allowed_checkin_days: getCheckedDays('checkin') || '0,1,2,3,4,5,6',
                allowed_checkout_days: getCheckedDays('checkout') || '0,1,2,3,4,5,6',
                priority: parseInt(document.getElementById('offer-priority').value) || 0,
                pricing_tier: document.getElementById('offer-pricing-tier').value || 'standard',
                active: document.getElementById('offer-active').checked,
                available_website: true,  // Default to available on website
                available_agents: false   // Default to not available for agents
            };
            
            try {
                const url = id ? `/api/admin/offers/${id}` : '/api/admin/offers';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(offerData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addOfferModal');
                    loadOffers();
                    loadOffersPricingGrid();
                    alert(' Offer saved successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving offer: ' + error.message);
            }
        }
        
        async function deleteOffer(id) {
            if (!confirm('Delete this offer?')) return;
            
            try {
                const response = await fetch(`/api/admin/offers/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadOffers();
                    loadOffersPricingGrid();  // Also refresh the Offer Distribution section
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting offer: ' + error.message);
            }
        }

        // =====================================================
        // BOOKINGS FUNCTIONS
        // =====================================================
        
        async function loadBookingsPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('bookings-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for bookings:', error);
            }
        }
        
        async function loadBookingsRooms() {
            const propertyId = document.getElementById('bookings-property-select')?.value;
            const roomSelect = document.getElementById('bookings-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">All Rooms</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadBookingsForProperty() {
            const propertyId = document.getElementById('bookings-property-select')?.value;
            const roomId = document.getElementById('bookings-room-select')?.value;
            const status = document.getElementById('bookings-status-select')?.value;
            
            // Also load rooms when property changes
            if (!roomId) {
                await loadBookingsRooms();
            }
            
            try {
                let url = `/api/admin/bookings?`;
                if (propertyId) url += `property_id=${propertyId}&`;
                if (roomId) url += `room_id=${roomId}&`;
                if (status) url += `status=${status}&`;
                
                // Add account filter if viewing specific account
                if (selectedAccountId) {
                    url += `account_id=${selectedAccountId}&`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    renderBookings(data.data || []);
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
            }
        }
        
        async function loadBookings() {
            // Load property selector first
            await loadBookingsPropertySelect();
            
            // Load all bookings by default
            loadBookingsForProperty();
        }
        
        function renderBookings(bookings) {
            const container = document.getElementById('bookings-list');
            
            if (!bookings || bookings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>No Bookings Found</h3>
                        <p>No bookings match your filters</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Guest</th>
                            <th style="text-align: left; padding: 0.75rem;">Property</th>
                            <th style="text-align: left; padding: 0.75rem;">Room</th>
                            <th style="text-align: left; padding: 0.75rem;">Check-in</th>
                            <th style="text-align: left; padding: 0.75rem;">Check-out</th>
                            <th style="text-align: left; padding: 0.75rem;">Total</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const statusColors = {
                'confirmed': { bg: '#dcfce7', color: '#166534' },
                'pending': { bg: '#fef3c7', color: '#92400e' },
                'cancelled': { bg: '#fee2e2', color: '#991b1b' },
                'completed': { bg: '#e0f2fe', color: '#0369a1' }
            };
            
            const paymentIcons = {
                'pending': '',
                'deposit_paid': '',
                'fully_paid': '',
                'overdue': '',
                'refunded': ''
            };
            
            for (const booking of bookings) {
                const statusStyle = statusColors[booking.status] || statusColors['pending'];
                const checkIn = booking.arrival_date ? new Date(booking.arrival_date).toLocaleDateString() : '-';
                const checkOut = booking.departure_date ? new Date(booking.departure_date).toLocaleDateString() : '-';
                const guestName = [booking.guest_first_name, booking.guest_last_name].filter(Boolean).join(' ') || 'Guest';
                const total = booking.grand_total || booking.total_price || 0;
                const paymentIcon = paymentIcons[booking.payment_status] || '';
                
                // Check if payment is overdue
                let rowStyle = '';
                if (booking.payment_status === 'overdue') {
                    rowStyle = 'background: #fef2f2;';
                } else if (booking.payment_status === 'deposit_paid' && booking.balance_due_date) {
                    const dueDate = new Date(booking.balance_due_date);
                    const today = new Date();
                    const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 3 && daysUntil > 0) {
                        rowStyle = 'background: #fffbeb;';
                    }
                }
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border); ${rowStyle}">
                        <td style="padding: 0.75rem;">
                            <strong>${guestName}</strong>
                            ${booking.guest_email ? `<br><small style="color: #64748b;">${booking.guest_email}</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem;"><small>${booking.property_name || '-'}</small></td>
                        <td style="padding: 0.75rem;">${booking.room_name || booking.unit_name || '-'}</td>
                        <td style="padding: 0.75rem;">${checkIn}</td>
                        <td style="padding: 0.75rem;">${checkOut}</td>
                        <td style="padding: 0.75rem; font-weight: 600;">
                            <span title="Payment: ${booking.payment_status || 'pending'}">${paymentIcon}</span>
                            ${parseFloat(total).toFixed(2)}
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span style="background: ${statusStyle.bg}; color: ${statusStyle.color}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; text-transform: capitalize;">
                                ${booking.status || 'pending'}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="viewBooking(${booking.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;" title="View Details"></button>
                            <button onclick="editBooking(${booking.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;" title="Edit"></button>
                            <button onclick="deleteBooking(${booking.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;" title="Delete"></button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function openAddBookingModal() {
            // Reset form
            document.getElementById('add-booking-form').reset();
            document.getElementById('booking-room').innerHTML = '<option value="">Select Room...</option>';
            
            // Populate property dropdown
            loadBookingProperties();
            
            // Set default check-in to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('booking-checkin').value = today;
            
            // Set default checkout to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('booking-checkout').value = tomorrow.toISOString().split('T')[0];
            
            openModal('addBookingModal');
        }
        
        async function loadBookingProperties() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('booking-property');
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadBookingRooms() {
            const propertyId = document.getElementById('booking-property').value;
            const select = document.getElementById('booking-room');
            select.innerHTML = '<option value="">Select Room...</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        select.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function saveNewBooking() {
            const propertyId = document.getElementById('booking-property').value;
            const roomId = document.getElementById('booking-room').value;
            const checkin = document.getElementById('booking-checkin').value;
            const checkout = document.getElementById('booking-checkout').value;
            const guests = document.getElementById('booking-guests').value;
            const firstName = document.getElementById('booking-first-name').value;
            const lastName = document.getElementById('booking-last-name').value;
            const email = document.getElementById('booking-email').value;
            const phone = document.getElementById('booking-phone').value;
            const total = document.getElementById('booking-total').value;
            const paymentStatus = document.getElementById('booking-payment-status').value;
            const status = document.getElementById('booking-status').value;
            const notes = document.getElementById('booking-notes').value;
            const syncCM = document.getElementById('booking-sync-cm').checked;
            
            if (!propertyId || !roomId || !checkin || !checkout || !firstName || !lastName || !email) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        property_id: propertyId,
                        room_id: roomId,
                        check_in: checkin,
                        check_out: checkout,
                        num_adults: guests,
                        guest_first_name: firstName,
                        guest_last_name: lastName,
                        guest_email: email,
                        guest_phone: phone,
                        total_price: total || 0,
                        payment_status: paymentStatus,
                        status: status,
                        notes: notes,
                        sync_to_cm: syncCM
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addBookingModal');
                    loadBookingsForProperty();
                    alert('Booking created successfully!' + (syncCM ? ' Syncing to channel manager...' : ''));
                } else {
                    alert('Error: ' + (data.error || 'Failed to create booking'));
                }
            } catch (error) {
                console.error('Error creating booking:', error);
                alert('Error creating booking');
            }
        }
        
        let currentViewingBookingId = null;
        
        async function viewBooking(id) {
            currentViewingBookingId = id;
            
            try {
                const response = await fetch(`/api/bookings/${id}`);
                const data = await response.json();
                
                if (!data.success || !data.booking) {
                    alert('Failed to load booking details');
                    return;
                }
                
                const b = data.booking;
                
                // Reference
                document.getElementById('view-booking-ref').textContent = `Reference #${b.id}`;
                
                // Status badges
                const statusColors = {
                    'confirmed': { bg: '#dcfce7', color: '#166534', icon: 'âœ…' },
                    'pending': { bg: '#fef3c7', color: '#92400e', icon: 'â³' },
                    'cancelled': { bg: '#fee2e2', color: '#991b1b', icon: 'âŒ' },
                    'completed': { bg: '#e0f2fe', color: '#0369a1', icon: 'ðŸ' }
                };
                const paymentColors = {
                    'pending': { bg: '#fef3c7', color: '#92400e', label: 'Payment Pending', icon: 'â³' },
                    'deposit_paid': { bg: '#dbeafe', color: '#1e40af', label: 'Deposit Paid', icon: 'ðŸ’µ' },
                    'fully_paid': { bg: '#dcfce7', color: '#166534', label: 'Fully Paid', icon: 'ðŸ’°' },
                    'overdue': { bg: '#fee2e2', color: '#991b1b', label: 'Overdue', icon: 'âš ï¸' },
                    'refunded': { bg: '#f3f4f6', color: '#374151', label: 'Refunded', icon: 'â†©ï¸' }
                };
                
                const bStatus = statusColors[b.status] || statusColors['pending'];
                const pStatus = paymentColors[b.payment_status] || paymentColors['pending'];
                
                document.getElementById('view-booking-status').innerHTML = `
                    <span style="background: ${bStatus.bg}; color: ${bStatus.color}; padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500; text-transform: capitalize;">
                        ${bStatus.icon} ${b.status || 'pending'}
                    </span>
                `;
                document.getElementById('view-payment-status').innerHTML = `
                    <span style="background: ${pStatus.bg}; color: ${pStatus.color}; padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">
                        ${pStatus.icon} ${pStatus.label}
                    </span>
                `;
                
                // Alert banner for overdue
                const alertBanner = document.getElementById('view-booking-alert');
                const alertText = document.getElementById('view-booking-alert-text');
                if (b.payment_status === 'overdue') {
                    alertBanner.style.display = 'block';
                    alertText.textContent = 'Payment is overdue! Balance was due on ' + formatDate(b.balance_due_date);
                } else if (b.payment_status === 'deposit_paid' && b.balance_due_date) {
                    const dueDate = new Date(b.balance_due_date);
                    const today = new Date();
                    const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 7 && daysUntil > 0) {
                        alertBanner.style.display = 'block';
                        alertBanner.style.background = '#fef3c7';
                        alertBanner.style.borderColor = '#fde68a';
                        alertText.textContent = `Balance due in ${daysUntil} day${daysUntil === 1 ? '' : 's'}`;
                    } else {
                        alertBanner.style.display = 'none';
                    }
                } else {
                    alertBanner.style.display = 'none';
                }
                
                // Guest info
                const guestName = [b.guest_first_name, b.guest_last_name].filter(Boolean).join(' ') || 'Guest';
                document.getElementById('view-guest-name').textContent = guestName;
                document.getElementById('view-guest-email').textContent = b.guest_email || '-';
                document.getElementById('view-guest-phone').textContent = b.guest_phone || '-';
                document.getElementById('view-guest-country').textContent = b.guest_country || '-';
                
                // Stay details
                document.getElementById('view-property-name').textContent = b.property_name || '-';
                document.getElementById('view-room-name').textContent = b.unit_name || b.room_name || '-';
                document.getElementById('view-checkin').textContent = formatDate(b.arrival_date);
                document.getElementById('view-checkout').textContent = formatDate(b.departure_date);
                
                // Calculate nights
                if (b.arrival_date && b.departure_date) {
                    const nights = Math.ceil((new Date(b.departure_date) - new Date(b.arrival_date)) / (1000 * 60 * 60 * 24));
                    document.getElementById('view-nights').textContent = nights;
                } else {
                    document.getElementById('view-nights').textContent = '-';
                }
                
                document.getElementById('view-guests').textContent = (b.num_adults || 0) + (b.num_children || 0) || '-';
                
                // Notes
                document.getElementById('view-notes').textContent = b.notes || 'No notes';
                
                // Financials
                const currency = b.currency === 'USD' ? '$' : b.currency === 'EUR' ? '' : '';
                document.getElementById('view-accommodation').textContent = currency + parseFloat(b.accommodation_price || 0).toFixed(2);
                
                // Upsells
                if (b.upsells_total && parseFloat(b.upsells_total) > 0) {
                    document.getElementById('view-upsells-row').style.display = 'flex';
                    document.getElementById('view-upsells').textContent = currency + parseFloat(b.upsells_total).toFixed(2);
                } else {
                    document.getElementById('view-upsells-row').style.display = 'none';
                }
                
                // Discount
                if (b.discount_amount && parseFloat(b.discount_amount) > 0) {
                    document.getElementById('view-discount-row').style.display = 'flex';
                    document.getElementById('view-discount').textContent = '-' + currency + parseFloat(b.discount_amount).toFixed(2);
                } else {
                    document.getElementById('view-discount-row').style.display = 'none';
                }
                
                // Tax
                if (b.tax_amount && parseFloat(b.tax_amount) > 0) {
                    document.getElementById('view-tax-row').style.display = 'flex';
                    document.getElementById('view-tax').textContent = currency + parseFloat(b.tax_amount).toFixed(2);
                } else {
                    document.getElementById('view-tax-row').style.display = 'none';
                }
                
                // Total
                document.getElementById('view-total').textContent = currency + parseFloat(b.grand_total || b.total_price || 0).toFixed(2);
                
                // Payment summary
                document.getElementById('view-deposit-paid').textContent = currency + parseFloat(b.deposit_amount || 0).toFixed(2);
                const balance = parseFloat(b.grand_total || 0) - parseFloat(b.deposit_amount || 0);
                document.getElementById('view-balance-due').textContent = currency + balance.toFixed(2);
                document.getElementById('view-balance-due').style.color = balance > 0 ? '#dc2626' : '#16a34a';
                
                // Due date
                if (b.balance_due_date) {
                    document.getElementById('view-due-date').textContent = formatDate(b.balance_due_date);
                } else {
                    document.getElementById('view-due-date').textContent = 'At check-in';
                }
                
                // Channel Manager
                document.getElementById('view-booking-source').textContent = b.booking_source || 'Direct';
                
                if (b.beds24_booking_id) {
                    document.getElementById('view-beds24-row').style.display = 'flex';
                    document.getElementById('view-beds24-id').textContent = b.beds24_booking_id;
                } else {
                    document.getElementById('view-beds24-row').style.display = 'none';
                }
                
                if (b.hostaway_reservation_id) {
                    document.getElementById('view-hostaway-row').style.display = 'flex';
                    document.getElementById('view-hostaway-id').textContent = b.hostaway_reservation_id;
                } else {
                    document.getElementById('view-hostaway-row').style.display = 'none';
                }
                
                openModal('viewBookingModal');
                
            } catch (error) {
                console.error('Error loading booking:', error);
                alert('Error loading booking details');
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        
        async function generateInvoice(bookingId) {
            if (!bookingId) return;
            
            // Open invoice in new window - server returns HTML directly
            window.open(`/api/bookings/${bookingId}/invoice`, '_blank');
        }
        
        async function sendPaymentReceipt(bookingId) {
            if (!bookingId) return;
            
            if (!confirm('Send payment receipt email to the guest?')) return;
            
            try {
                const response = await fetch(`/api/bookings/${bookingId}/send-receipt`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Receipt sent successfully!');
                } else {
                    alert('Error sending receipt: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending receipt:', error);
                alert('Error sending receipt');
            }
        }
        
        async function processRefund(bookingId) {
            if (!bookingId) return;
            
            const amount = prompt('Enter refund amount (leave empty for full refund):');
            if (amount === null) return;
            
            if (!confirm('Are you sure you want to process this refund?')) return;
            
            try {
                const response = await fetch(`/api/bookings/${bookingId}/refund`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ amount: amount || null })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Refund processed successfully!');
                    viewBooking(bookingId); // Refresh
                } else {
                    alert('Error processing refund: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error processing refund:', error);
                alert('Error processing refund');
            }
        }
        
        async function cancelBooking(bookingId) {
            if (!bookingId) return;
            
            if (!confirm('Are you sure you want to cancel this booking? This will also update the channel manager.')) return;
            
            try {
                const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Booking cancelled successfully!');
                    closeModal('viewBookingModal');
                    loadBookingsForProperty(); // Refresh list
                } else {
                    alert('Error cancelling booking: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error cancelling booking:', error);
                alert('Error cancelling booking');
            }
        }
        
        // Alias for clicking on booked dates in the calendar grid
        function openBookingDetail(id) {
            viewBooking(id);
        }
        
        async function editBooking(id) {
            console.log('editBooking called with id:', id);
            try {
                // Fetch booking details
                const response = await fetch(`/api/bookings/${id}`);
                const data = await response.json();
                console.log('Booking data:', data);
                
                if (!data.success || !data.booking) {
                    alert('Error loading booking details: ' + (data.error || 'Unknown error'));
                    return;
                }
                
                const booking = data.booking;
                
                // Populate modal fields
                document.getElementById('edit-booking-id').value = booking.id;
                document.getElementById('edit-booking-beds24-id').value = booking.beds24_booking_id || '';
                document.getElementById('edit-booking-ref').textContent = `#${booking.id}`;
                
                // Guest details
                document.getElementById('edit-booking-first-name').value = booking.guest_first_name || '';
                document.getElementById('edit-booking-last-name').value = booking.guest_last_name || '';
                document.getElementById('edit-booking-email').value = booking.guest_email || '';
                document.getElementById('edit-booking-phone').value = booking.guest_phone || '';
                
                // Stay details
                document.getElementById('edit-booking-checkin').value = booking.arrival_date?.split('T')[0] || '';
                document.getElementById('edit-booking-checkout').value = booking.departure_date?.split('T')[0] || '';
                document.getElementById('edit-booking-adults').value = booking.num_adults || 1;
                document.getElementById('edit-booking-children').value = booking.num_children || 0;
                
                // Pricing
                document.getElementById('edit-booking-total').value = booking.grand_total || booking.accommodation_price || 0;
                document.getElementById('edit-booking-deposit').value = booking.deposit_amount || 0;
                document.getElementById('edit-booking-balance').value = booking.balance_amount || 0;
                
                // Status
                document.getElementById('edit-booking-status').value = booking.status || 'pending';
                document.getElementById('edit-booking-payment-status').value = booking.payment_status || 'pending';
                
                // Notes
                document.getElementById('edit-booking-notes').value = booking.notes || '';
                
                // Show sync warning if linked to channel manager
                const syncInfo = document.getElementById('edit-booking-sync-info');
                const syncSource = document.getElementById('edit-booking-sync-source');
                if (booking.beds24_booking_id) {
                    syncInfo.style.display = 'block';
                    syncSource.textContent = 'Beds24';
                } else if (booking.hostaway_reservation_id) {
                    syncInfo.style.display = 'block';
                    syncSource.textContent = 'Hostaway';
                } else if (booking.smoobu_booking_id) {
                    syncInfo.style.display = 'block';
                    syncSource.textContent = 'Smoobu';
                } else {
                    syncInfo.style.display = 'none';
                }
                
                // Open modal
                document.getElementById('edit-booking-modal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading booking:', error);
                alert('Error loading booking details');
            }
        }
        
        function closeEditBookingModal() {
            document.getElementById('edit-booking-modal').style.display = 'none';
        }
        
        async function saveBookingEdit() {
            const btn = document.getElementById('save-booking-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const bookingId = document.getElementById('edit-booking-id').value;
                
                const updates = {
                    guest_first_name: document.getElementById('edit-booking-first-name').value,
                    guest_last_name: document.getElementById('edit-booking-last-name').value,
                    guest_email: document.getElementById('edit-booking-email').value,
                    guest_phone: document.getElementById('edit-booking-phone').value,
                    arrival_date: document.getElementById('edit-booking-checkin').value,
                    departure_date: document.getElementById('edit-booking-checkout').value,
                    num_adults: parseInt(document.getElementById('edit-booking-adults').value) || 1,
                    num_children: parseInt(document.getElementById('edit-booking-children').value) || 0,
                    grand_total: parseFloat(document.getElementById('edit-booking-total').value) || 0,
                    deposit_amount: parseFloat(document.getElementById('edit-booking-deposit').value) || 0,
                    balance_amount: parseFloat(document.getElementById('edit-booking-balance').value) || 0,
                    status: document.getElementById('edit-booking-status').value,
                    payment_status: document.getElementById('edit-booking-payment-status').value,
                    notes: document.getElementById('edit-booking-notes').value
                };
                
                const response = await fetch(`/api/bookings/${bookingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(updates)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeEditBookingModal();
                    loadBookingsForProperty();
                    
                    // Show sync status
                    if (data.beds24_synced) {
                        alert(' Booking updated and synced to Beds24');
                    } else {
                        alert(' Booking updated');
                    }
                } else {
                    alert('Error saving booking: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving booking:', error);
                alert('Error saving booking');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        }
        
        async function deleteBooking(id) {
            if (!confirm('Are you sure you want to delete this booking? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/bookings/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    loadBookingsForProperty();
                } else {
                    alert('Error deleting booking: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                alert('Error deleting booking');
            }
        }

        // =====================================================
        // VOUCHERS FUNCTIONS
        // =====================================================
        
        async function loadVouchersPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('vouchers-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for vouchers:', error);
            }
        }
        
        async function loadVouchersRooms() {
            const propertyId = document.getElementById('vouchers-property-select')?.value;
            const roomSelect = document.getElementById('vouchers-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">All Rooms</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadVouchersForProperty() {
            const propertyId = document.getElementById('vouchers-property-select')?.value;
            const roomId = document.getElementById('vouchers-room-select')?.value;
            
            // Also load rooms when property changes
            if (!roomId) {
                await loadVouchersRooms();
            }
            
            if (!propertyId) {
                document.getElementById('vouchers-list').innerHTML = `
                    <p style="color: #64748b; text-align: center; padding: 2rem;">
                        Select a property to view and manage vouchers
                    </p>
                `;
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/vouchers?property_id=${propertyId}${roomId ? '&room_id=' + roomId : ''}`);
                const data = await response.json();
                
                if (data.success) {
                    renderVouchers(data.data || []);
                }
            } catch (error) {
                console.error('Error loading vouchers:', error);
            }
        }
        
        async function loadVouchers() {
            // Load property selector first
            await loadVouchersPropertySelect();
            
            // Show message to select property
            document.getElementById('vouchers-list').innerHTML = `
                <p style="color: #64748b; text-align: center; padding: 2rem;">
                    Select a property to view and manage vouchers
                </p>
            `;
        }
        
        function renderVouchers(vouchers) {
            const container = document.getElementById('vouchers-list');
            const propertyId = document.getElementById('vouchers-property-select')?.value;
            
            if (!propertyId) {
                container.innerHTML = `
                    <p style="color: #64748b; text-align: center; padding: 2rem;">
                        Select a property to view and manage vouchers
                    </p>
                `;
                return;
            }
            
            if (!vouchers || vouchers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>No Vouchers for This Property</h3>
                        <p>Click any template above or create a custom voucher</p>
                        <button class="btn" onclick="openAddVoucherModal()">Create Custom Voucher</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Code</th>
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Value</th>
                            <th style="text-align: left; padding: 0.75rem;">Usage</th>
                            <th style="text-align: left; padding: 0.75rem;">Valid</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const voucher of vouchers) {
                // Format discount based on type
                let discountText = '';
                let discountColor = '#92400e';
                let discountBg = '#fef3c7';
                
                switch (voucher.discount_type) {
                    case 'percentage':
                        discountText = `${voucher.discount_value}% Off`;
                        discountColor = '#166534';
                        discountBg = '#dcfce7';
                        break;
                    case 'fixed':
                        discountText = `${voucher.discount_value} Off`;
                        discountColor = '#166534';
                        discountBg = '#dcfce7';
                        break;
                    case 'monetary':
                        discountText = `${voucher.discount_value} Credit`;
                        discountColor = '#7c3aed';
                        discountBg = '#ede9fe';
                        break;
                    case 'free_nights':
                        discountText = `${voucher.discount_value} Free Night${voucher.discount_value > 1 ? 's' : ''}`;
                        discountColor = '#0369a1';
                        discountBg = '#e0f2fe';
                        break;
                    case 'addon':
                        discountText = 'Free Add-on';
                        discountColor = '#c2410c';
                        discountBg = '#ffedd5';
                        break;
                    default:
                        discountText = voucher.discount_type === 'fixed_amount' 
                            ? `${voucher.discount_value}` 
                            : `${voucher.discount_value}%`;
                }
                
                const usageText = voucher.max_uses 
                    ? `${voucher.uses_count || 0} / ${voucher.max_uses}`
                    : `${voucher.uses_count || 0} uses`;
                
                const validText = voucher.valid_from || voucher.valid_until 
                    ? `${voucher.valid_from || 'Start'} - ${voucher.valid_until || 'End'}`
                    : 'Always';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <code style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: bold;">
                                ${voucher.code}
                            </code>
                        </td>
                        <td style="padding: 0.75rem;">${voucher.name}</td>
                        <td style="padding: 0.75rem;">
                            <span style="background: ${discountBg}; color: ${discountColor}; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 500;">
                                ${discountText}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${usageText}</td>
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${validText}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span style="background: ${voucher.active ? '#dcfce7' : '#fee2e2'}; color: ${voucher.active ? '#166534' : '#991b1b'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                ${voucher.active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editVoucher(${voucher.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;"></button>
                            <button onclick="deleteVoucher(${voucher.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;"></button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Toggle voucher presets visibility
        function toggleVoucherPresets() {
            const presets = document.getElementById('all-voucher-presets');
            const btn = document.getElementById('toggle-voucher-presets-btn');
            
            if (presets.style.display === 'none') {
                presets.style.display = 'block';
                btn.textContent = 'Hide Categories ';
            } else {
                presets.style.display = 'none';
                btn.textContent = 'Show All Categories ';
            }
        }
        
        // Quick add voucher from preset - opens modal pre-filled
        async function quickAddVoucher(name, voucherType, value) {
            document.getElementById('voucher-form').reset();
            document.getElementById('voucher-id').value = '';
            
            // Pre-fill with preset values
            document.getElementById('voucher-name').value = name;
            
            // Set discount type based on voucher type
            if (voucherType === 'percentage') {
                document.getElementById('voucher-discount-type').value = 'percentage';
                document.getElementById('voucher-discount-value').value = value;
            } else if (voucherType === 'fixed' || voucherType === 'monetary') {
                document.getElementById('voucher-discount-type').value = voucherType;
                document.getElementById('voucher-discount-value').value = value;
            } else if (voucherType === 'stay') {
                document.getElementById('voucher-discount-type').value = 'free_nights';
                document.getElementById('voucher-discount-value').value = value;
            } else if (voucherType === 'addon') {
                document.getElementById('voucher-discount-type').value = 'addon';
                document.getElementById('voucher-discount-value').value = value;
            }
            
            // Generate a random code
            const code = name.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().substring(0, 8) + Math.floor(Math.random() * 1000);
            document.getElementById('voucher-code').value = code;
            
            document.getElementById('voucher-active').checked = true;
            
            // Load properties
            await loadVoucherPropertiesForModal();
            
            document.querySelector('#addVoucherModal .modal-title').textContent = ' Create: ' + name;
            openModal('addVoucherModal');
        }
        
        function openAddVoucherModal() {
            document.getElementById('voucher-form').reset();
            document.getElementById('voucher-id').value = '';
            document.getElementById('voucher-active').checked = true;
            document.querySelector('#addVoucherModal .modal-title').textContent = ' Create New Voucher';
            
            // Reset vendor section
            document.querySelector('input[name="voucher-provider-type"][value="internal"]').checked = true;
            document.getElementById('voucher-vendor-section').style.display = 'none';
            loadVendorsForVoucher();
            
            // Pre-select property from page filter
            const selectedProperty = document.getElementById('vouchers-property-select')?.value;
            loadVoucherPropertiesForModal().then(() => {
                if (selectedProperty) {
                    document.getElementById('voucher-property').value = selectedProperty;
                    loadVoucherUnits();
                }
            });
            openModal('addVoucherModal');
        }
        
        function toggleVoucherVendor() {
            const isExternal = document.querySelector('input[name="voucher-provider-type"]:checked').value === 'external';
            document.getElementById('voucher-vendor-section').style.display = isExternal ? 'block' : 'none';
        }
        
        async function loadVendorsForVoucher() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/vendors${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('voucher-vendor');
                select.innerHTML = '<option value="">-- Select a vendor --</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(v => {
                        if (v.is_active !== false) {
                            select.innerHTML += `<option value="${v.id}">${v.name}</option>`;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading vendors:', error);
            }
        }
        
        async function loadVoucherPropertiesForModal() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('voucher-property');
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                // Reset unit select
                document.getElementById('voucher-unit').innerHTML = '<option value="">All Units</option>';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadVoucherUnits() {
            const propertyId = document.getElementById('voucher-property').value;
            const unitSelect = document.getElementById('voucher-unit');
            
            unitSelect.innerHTML = '<option value="">All Units</option>';
            
            if (!propertyId) return;
            
            try {
                // Use bookable-units endpoint - same as Offers page
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    
                    units.forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        async function editVoucher(id) {
            try {
                const response = await fetch(`/api/admin/vouchers/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const voucher = data.data;
                    document.getElementById('voucher-id').value = voucher.id;
                    document.getElementById('voucher-code').value = voucher.code || '';
                    document.getElementById('voucher-name').value = voucher.name || '';
                    document.getElementById('voucher-description').value = voucher.description || '';
                    document.getElementById('voucher-discount-type').value = voucher.discount_type || 'percentage';
                    document.getElementById('voucher-discount-value').value = voucher.discount_value || '';
                    document.getElementById('voucher-valid-from').value = voucher.valid_from || '';
                    document.getElementById('voucher-valid-until').value = voucher.valid_until || '';
                    document.getElementById('voucher-max-uses').value = voucher.max_uses || '';
                    document.getElementById('voucher-min-nights').value = voucher.min_nights || '';
                    document.getElementById('voucher-min-total').value = voucher.min_total || '';
                    document.getElementById('voucher-single-use').checked = voucher.single_use_per_guest || false;
                    document.getElementById('voucher-active').checked = voucher.active;
                    
                    // Set vendor fields
                    await loadVendorsForVoucher();
                    if (voucher.is_external && voucher.vendor_id) {
                        document.querySelector('input[name="voucher-provider-type"][value="external"]').checked = true;
                        document.getElementById('voucher-vendor-section').style.display = 'block';
                        document.getElementById('voucher-vendor').value = voucher.vendor_id;
                    } else {
                        document.querySelector('input[name="voucher-provider-type"][value="internal"]').checked = true;
                        document.getElementById('voucher-vendor-section').style.display = 'none';
                    }
                    
                    document.querySelector('#addVoucherModal .modal-title').textContent = 'Edit Voucher';
                    openModal('addVoucherModal');
                }
            } catch (error) {
                alert('Error loading voucher: ' + error.message);
            }
        }
        
        async function saveVoucher() {
            const id = document.getElementById('voucher-id').value;
            
            // Get vendor info
            const isExternal = document.querySelector('input[name="voucher-provider-type"]:checked').value === 'external';
            const vendorId = isExternal ? document.getElementById('voucher-vendor').value || null : null;
            
            const voucherData = {
                code: document.getElementById('voucher-code').value,
                name: document.getElementById('voucher-name').value,
                description: document.getElementById('voucher-description').value,
                discount_type: document.getElementById('voucher-discount-type').value,
                discount_value: parseFloat(document.getElementById('voucher-discount-value').value),
                valid_from: document.getElementById('voucher-valid-from').value || null,
                valid_until: document.getElementById('voucher-valid-until').value || null,
                max_uses: parseInt(document.getElementById('voucher-max-uses').value) || null,
                min_nights: parseInt(document.getElementById('voucher-min-nights').value) || 1,
                min_total: parseFloat(document.getElementById('voucher-min-total').value) || null,
                single_use_per_guest: document.getElementById('voucher-single-use').checked,
                active: document.getElementById('voucher-active').checked,
                is_external: isExternal,
                vendor_id: vendorId
            };
            
            try {
                const url = id ? `/api/admin/vouchers/${id}` : '/api/admin/vouchers';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(voucherData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addVoucherModal');
                    loadVouchersForProperty();
                    alert(' Voucher saved successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving voucher: ' + error.message);
            }
        }
        
        async function deleteVoucher(id) {
            if (!confirm('Delete this voucher?')) return;
            
            try {
                const response = await fetch(`/api/admin/vouchers/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadVouchersForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting voucher: ' + error.message);
            }
        }

        // =====================================================
        // UPSELLS FUNCTIONS
        // =====================================================
        
        let upsellsData = [];
        
        async function loadUpsellsPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('upsells-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for upsells:', error);
            }
        }
        
        async function loadUpsellsRooms() {
            const propertyId = document.getElementById('upsells-property-select')?.value;
            const roomSelect = document.getElementById('upsells-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">All Rooms</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadUpsellsForProperty() {
            const propertyId = document.getElementById('upsells-property-select')?.value;
            const roomId = document.getElementById('upsells-room-select')?.value;
            
            // Also load rooms when property changes
            if (!roomId) {
                await loadUpsellsRooms();
            }
            
            if (!propertyId) {
                document.getElementById('upsells-list').innerHTML = `
                    <p style="color: #64748b; text-align: center; padding: 2rem;">
                        Select a property to view and manage upsells
                    </p>
                `;
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/upsells?property_id=${propertyId}${roomId ? '&room_id=' + roomId : ''}`);
                const data = await response.json();
                
                if (data.success) {
                    upsellsData = data.data || [];
                    renderUpsells(upsellsData);
                }
            } catch (error) {
                console.error('Error loading upsells:', error);
            }
        }
        
        async function loadUpsells() {
            // Load property selector first
            await loadUpsellsPropertySelect();
            
            // Show message to select property
            document.getElementById('upsells-list').innerHTML = `
                <p style="color: #64748b; text-align: center; padding: 2rem;">
                    Select a property to view and manage upsells
                </p>
            `;
        }
        
        function renderUpsells(upsells) {
            const container = document.getElementById('upsells-list');
            const propertyId = document.getElementById('upsells-property-select')?.value;
            
            if (!propertyId) {
                container.innerHTML = `
                    <p style="color: #64748b; text-align: center; padding: 2rem;">
                        Select a property to view and manage upsells
                    </p>
                `;
                return;
            }
            
            if (!upsells || upsells.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>No Upsells for This Property</h3>
                        <p>Click any preset above or create a custom upsell</p>
                        <button class="btn" onclick="openAddUpsellModal()">Create Custom Upsell</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Price</th>
                            <th style="text-align: left; padding: 0.75rem;">Charge Type</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const chargeTypeLabels = {
                'per_booking': 'Per Booking',
                'per_night': 'Per Night',
                'per_day': 'Per Day',
                'per_guest': 'Per Guest',
                'per_guest_per_night': 'Per Guest/Night',
                'per_hour': 'Per Hour'
            };
            
            for (const upsell of upsells) {
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${upsell.name}</strong>
                            ${upsell.description ? `<br><small style="color: #64748b;">${upsell.description}</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #059669;">$${parseFloat(upsell.price).toFixed(2)}</td>
                        <td style="padding: 0.75rem; color: #64748b; font-size: 0.9rem;">${chargeTypeLabels[upsell.charge_type] || upsell.charge_type}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${upsell.active ? 'badge-success' : 'badge-secondary'}">${upsell.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editUpsell(${upsell.id})" style="background: none; border: none; cursor: pointer;"></button>
                            <button onclick="deleteUpsell(${upsell.id})" style="background: none; border: none; cursor: pointer;"></button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function openAddUpsellModal() {
            document.getElementById('upsell-form').reset();
            document.getElementById('upsell-id').value = '';
            document.getElementById('upsell-modal-title').innerHTML = ' Add Upsell';
            document.getElementById('upsell-active').checked = true;
            document.getElementById('upsell-multi-room').checked = false;
            document.getElementById('upsell-rooms-checkboxes').style.display = 'none';
            document.getElementById('upsell-room').style.display = 'block';
            
            // Reset vendor section
            document.querySelector('input[name="upsell-provider-type"][value="internal"]').checked = true;
            document.getElementById('upsell-vendor-section').style.display = 'none';
            loadVendorsForUpsell();
            
            // Pre-select property from page filter
            const selectedProperty = document.getElementById('upsells-property-select')?.value;
            loadUpsellPropertiesForModal().then(() => {
                if (selectedProperty) {
                    document.getElementById('upsell-property').value = selectedProperty;
                    loadUpsellRooms();
                }
            });
            openModal('addUpsellModal');
        }
        
        function toggleUpsellVendor() {
            const isExternal = document.querySelector('input[name="upsell-provider-type"]:checked').value === 'external';
            document.getElementById('upsell-vendor-section').style.display = isExternal ? 'block' : 'none';
        }
        
        async function loadVendorsForUpsell() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/vendors${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('upsell-vendor');
                select.innerHTML = '<option value="">-- Select a vendor --</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(v => {
                        if (v.is_active !== false) {
                            select.innerHTML += `<option value="${v.id}">${v.name}</option>`;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading vendors:', error);
            }
        }
        
        async function loadUpsellPropertiesForModal() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('upsell-property');
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                // Reset unit select
                document.getElementById('upsell-room').innerHTML = '<option value="">All Units</option>';
                document.getElementById('upsell-rooms-checkboxes').innerHTML = '';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadUpsellRooms() {
            const propertyId = document.getElementById('upsell-property').value;
            const roomSelect = document.getElementById('upsell-room');
            const roomCheckboxes = document.getElementById('upsell-rooms-checkboxes');
            
            roomSelect.innerHTML = '<option value="">All Units</option>';
            roomCheckboxes.innerHTML = '';
            
            if (!propertyId) return;
            
            try {
                // Use bookable-units endpoint - same as Offers page
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    
                    if (units.length > 0) {
                        units.forEach(unit => {
                            // Add to dropdown
                            roomSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                            
                            // Add checkbox
                            roomCheckboxes.innerHTML += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; cursor: pointer; border-radius: 4px; transition: background 0.2s;"
                                    onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background=''">
                                    <input type="checkbox" name="upsell-room-check" value="${unit.id}" style="width: 16px; height: 16px;">
                                    <span style="font-size: 0.9rem;">${unit.name}</span>
                                </label>
                            `;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        function toggleUpsellMultiRoom() {
            const multiRoom = document.getElementById('upsell-multi-room').checked;
            const roomSelect = document.getElementById('upsell-room');
            const roomCheckboxes = document.getElementById('upsell-rooms-checkboxes');
            
            if (multiRoom) {
                roomSelect.style.display = 'none';
                roomCheckboxes.style.display = 'block';
            } else {
                roomSelect.style.display = 'block';
                roomCheckboxes.style.display = 'none';
            }
        }
        
        async function editUpsell(id) {
            const upsell = upsellsData.find(u => u.id === id);
            if (!upsell) return;
            
            document.getElementById('upsell-id').value = upsell.id;
            document.getElementById('upsell-name').value = upsell.name || '';
            document.getElementById('upsell-description').value = upsell.description || '';
            document.getElementById('upsell-price').value = upsell.price || '';
            document.getElementById('upsell-charge-type').value = upsell.charge_type || 'per_booking';
            document.getElementById('upsell-max-qty').value = upsell.max_quantity || '';
            document.getElementById('upsell-active').checked = upsell.active;
            document.getElementById('upsell-multi-room').checked = false;
            document.getElementById('upsell-rooms-checkboxes').style.display = 'none';
            document.getElementById('upsell-room').style.display = 'block';
            
            // Set vendor fields
            await loadVendorsForUpsell();
            if (upsell.is_external && upsell.vendor_id) {
                document.querySelector('input[name="upsell-provider-type"][value="external"]').checked = true;
                document.getElementById('upsell-vendor-section').style.display = 'block';
                document.getElementById('upsell-vendor').value = upsell.vendor_id;
            } else {
                document.querySelector('input[name="upsell-provider-type"][value="internal"]').checked = true;
                document.getElementById('upsell-vendor-section').style.display = 'none';
            }
            
            // Load properties first
            await loadUpsellPropertiesForModal();
            
            // Set property and load rooms
            if (upsell.property_id) {
                document.getElementById('upsell-property').value = upsell.property_id;
                await loadUpsellRooms();
                
                // Set room if single room
                if (upsell.room_id) {
                    document.getElementById('upsell-room').value = upsell.room_id;
                }
                // Handle room_ids (multiple rooms)
                if (upsell.room_ids) {
                    const roomIds = upsell.room_ids.split(',');
                    if (roomIds.length > 1) {
                        document.getElementById('upsell-multi-room').checked = true;
                        toggleUpsellMultiRoom();
                        roomIds.forEach(rid => {
                            const checkbox = document.querySelector(`input[name="upsell-room-check"][value="${rid}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            }
            
            document.getElementById('upsell-modal-title').innerHTML = ' Edit Upsell';
            openModal('addUpsellModal');
        }
        
        async function saveUpsell() {
            const id = document.getElementById('upsell-id').value;
            const multiRoom = document.getElementById('upsell-multi-room').checked;
            
            // Get room IDs
            let roomId = null;
            let roomIds = null;
            
            if (multiRoom) {
                const checkedBoxes = document.querySelectorAll('input[name="upsell-room-check"]:checked');
                if (checkedBoxes.length > 0) {
                    roomIds = Array.from(checkedBoxes).map(cb => cb.value).join(',');
                }
            } else {
                roomId = document.getElementById('upsell-room').value || null;
            }
            
            // Get vendor info
            const isExternal = document.querySelector('input[name="upsell-provider-type"]:checked').value === 'external';
            const vendorId = isExternal ? document.getElementById('upsell-vendor').value || null : null;
            
            const upsellData = {
                name: document.getElementById('upsell-name').value,
                description: document.getElementById('upsell-description').value,
                price: parseFloat(document.getElementById('upsell-price').value),
                charge_type: document.getElementById('upsell-charge-type').value,
                max_quantity: parseInt(document.getElementById('upsell-max-qty').value) || null,
                property_id: document.getElementById('upsell-property').value || null,
                room_id: roomId,
                room_ids: roomIds,
                active: document.getElementById('upsell-active').checked,
                is_external: isExternal,
                vendor_id: vendorId
            };
            
            try {
                const url = id ? `/api/admin/upsells/${id}` : '/api/admin/upsells';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(upsellData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addUpsellModal');
                    loadUpsellsForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving upsell: ' + error.message);
            }
        }
        
        async function deleteUpsell(id) {
            if (!confirm('Delete this upsell?')) return;
            
            try {
                const response = await fetch(`/api/admin/upsells/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadUpsellsForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting upsell: ' + error.message);
            }
        }

        // =====================================================
        // VENDORS FUNCTIONS
        // =====================================================
        
        let vendorsData = [];
        
        async function loadVendors() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/vendors${queryString}`);
                const data = await response.json();
                
                if (data.success) {
                    vendorsData = data.data || [];
                    renderVendors(vendorsData);
                }
            } catch (error) {
                console.error('Error loading vendors:', error);
            }
        }
        
        function renderVendors(vendors) {
            const container = document.getElementById('vendors-list');
            
            if (!vendors || vendors.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>No Vendors Yet</h3>
                        <p>Add external service providers like taxi companies, tour operators, restaurants, etc.</p>
                        <button class="btn" onclick="openVendorModal()">Add First Vendor</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Contact</th>
                                <th>Email / Phone</th>
                                <th>Requests</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${vendors.map(v => `
                                <tr>
                                    <td>
                                        <strong>${v.name}</strong>
                                        ${v.website ? `<br><a href="${v.website}" target="_blank" style="font-size: 0.8rem; color: #6b7280;">${v.website}</a>` : ''}
                                    </td>
                                    <td>${v.contact_name || '-'}</td>
                                    <td>
                                        ${v.email ? `<a href="mailto:${v.email}">${v.email}</a>` : ''}
                                        ${v.phone ? `<br><span style="font-size: 0.85rem;">${v.phone}</span>` : ''}
                                    </td>
                                    <td>
                                        <span style="font-size: 0.9rem;">${v.request_count || 0} total</span>
                                        ${v.pending_count > 0 ? `<br><span style="color: #f59e0b; font-size: 0.85rem;">${v.pending_count} pending</span>` : ''}
                                    </td>
                                    <td>
                                        ${v.is_active !== false 
                                            ? '<span class="badge" style="background:#d1fae5;color:#047857;">Active</span>' 
                                            : '<span class="badge" style="background:#fee2e2;color:#dc2626;">Inactive</span>'}
                                    </td>
                                    <td>
                                        <button class="btn btn-secondary btn-small" onclick="editVendor(${v.id})">Edit</button>
                                        <button class="btn btn-secondary btn-small" onclick="resetVendorPassword(${v.id})" title="Reset password"></button>
                                        <button class="btn btn-secondary btn-small" onclick="deleteVendor(${v.id})" title="Delete"></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function openVendorModal() {
            document.getElementById('vendor-form').reset();
            document.getElementById('vendor-id').value = '';
            document.getElementById('vendor-modal-title').textContent = ' Add Vendor';
            document.getElementById('vendor-temp-password').style.display = 'none';
            // Reset permission checkboxes
            document.getElementById('perm-guest-name').checked = true;
            document.getElementById('perm-guest-phone').checked = true;
            document.getElementById('perm-guest-email').checked = false;
            document.getElementById('perm-booking-dates').checked = true;
            document.getElementById('perm-room-details').checked = false;
            document.getElementById('perm-booking-notes').checked = false;
            document.getElementById('perm-price-paid').checked = false;
            openModal('vendorModal');
        }
        
        async function editVendor(id) {
            try {
                const response = await fetch(`/api/admin/vendors/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const v = data.data;
                    document.getElementById('vendor-id').value = v.id;
                    document.getElementById('vendor-name').value = v.name || '';
                    document.getElementById('vendor-contact-name').value = v.contact_name || '';
                    document.getElementById('vendor-email').value = v.email || '';
                    document.getElementById('vendor-phone').value = v.phone || '';
                    document.getElementById('vendor-address').value = v.address || '';
                    document.getElementById('vendor-website').value = v.website || '';
                    document.getElementById('vendor-notes').value = v.notes || '';
                    document.getElementById('vendor-login-email').value = v.login_email || '';
                    
                    // Set permissions
                    document.getElementById('perm-guest-name').checked = v.can_see_guest_name !== false;
                    document.getElementById('perm-guest-phone').checked = v.can_see_guest_phone !== false;
                    document.getElementById('perm-guest-email').checked = v.can_see_guest_email === true;
                    document.getElementById('perm-booking-dates').checked = v.can_see_booking_dates !== false;
                    document.getElementById('perm-room-details').checked = v.can_see_room_details === true;
                    document.getElementById('perm-booking-notes').checked = v.can_see_booking_notes === true;
                    document.getElementById('perm-price-paid').checked = v.can_see_price_paid === true;
                    
                    document.getElementById('vendor-modal-title').textContent = ' Edit Vendor';
                    document.getElementById('vendor-temp-password').style.display = 'none';
                    openModal('vendorModal');
                }
            } catch (error) {
                alert('Error loading vendor: ' + error.message);
            }
        }
        
        document.getElementById('vendor-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('vendor-id').value;
            const vendorData = {
                name: document.getElementById('vendor-name').value,
                contact_name: document.getElementById('vendor-contact-name').value,
                email: document.getElementById('vendor-email').value,
                phone: document.getElementById('vendor-phone').value,
                address: document.getElementById('vendor-address').value,
                website: document.getElementById('vendor-website').value,
                notes: document.getElementById('vendor-notes').value,
                login_email: document.getElementById('vendor-login-email').value || document.getElementById('vendor-email').value,
                permissions: {
                    can_see_guest_name: document.getElementById('perm-guest-name').checked,
                    can_see_guest_phone: document.getElementById('perm-guest-phone').checked,
                    can_see_guest_email: document.getElementById('perm-guest-email').checked,
                    can_see_booking_dates: document.getElementById('perm-booking-dates').checked,
                    can_see_room_details: document.getElementById('perm-room-details').checked,
                    can_see_booking_notes: document.getElementById('perm-booking-notes').checked,
                    can_see_price_paid: document.getElementById('perm-price-paid').checked
                }
            };
            
            // Add account_id for new vendors
            if (!id) {
                const accountId = document.getElementById('account-filter')?.value;
                if (accountId) vendorData.account_id = accountId;
            }
            
            try {
                const url = id ? `/api/admin/vendors/${id}` : '/api/admin/vendors';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(vendorData)
                });
                const data = await response.json();
                
                if (data.success) {
                    if (data.tempPassword) {
                        // Show temp password for new vendor
                        document.getElementById('vendor-temp-password').style.display = 'block';
                        document.getElementById('vendor-temp-password-value').textContent = data.tempPassword;
                        showNotification('Vendor created! Share the temporary password with them.', 'success');
                    } else {
                        closeModal('vendorModal');
                        showNotification('Vendor saved successfully', 'success');
                    }
                    loadVendors();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving vendor: ' + error.message);
            }
        });
        
        async function resetVendorPassword(id) {
            if (!confirm('Reset password for this vendor? They will need to use the new password to log in.')) return;
            
            try {
                const response = await fetch(`/api/admin/vendors/${id}/reset-password`, {
                    method: 'POST',
                    headers: authHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`New temporary password: ${data.tempPassword}\n\nShare this with the vendor.`);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error resetting password: ' + error.message);
            }
        }
        
        async function deleteVendor(id) {
            if (!confirm('Delete this vendor? This will also remove all their service request history.')) return;
            
            try {
                const response = await fetch(`/api/admin/vendors/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Vendor deleted', 'success');
                    loadVendors();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting vendor: ' + error.message);
            }
        }
        
        // =====================================================
        // VENDOR SERVICE REQUESTS FUNCTIONS
        // =====================================================
        
        async function loadVendorRequests() {
            // Load vendors for filter
            try {
                const queryString = buildQueryString();
                const vendorsResponse = await fetch(`/api/admin/vendors${queryString}`);
                const vendorsData = await vendorsResponse.json();
                
                if (vendorsData.success) {
                    const vendorSelect = document.getElementById('vendor-requests-vendor-filter');
                    vendorSelect.innerHTML = '<option value="">All Vendors</option>' +
                        vendorsData.data.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading vendors for filter:', error);
            }
            
            // Load requests
            try {
                const status = document.getElementById('vendor-requests-status-filter')?.value || '';
                const vendorId = document.getElementById('vendor-requests-vendor-filter')?.value || '';
                const queryString = buildQueryString();
                
                let url = `/api/admin/vendor-requests${queryString}`;
                if (status) url += `${queryString ? '&' : '?'}status=${status}`;
                if (vendorId) url += `${url.includes('?') ? '&' : '?'}vendor_id=${vendorId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    renderVendorRequests(data.data || []);
                    renderVendorRequestsSummary(data.data || []);
                }
            } catch (error) {
                console.error('Error loading vendor requests:', error);
            }
        }
        
        function renderVendorRequestsSummary(requests) {
            const pending = requests.filter(r => r.status === 'pending').length;
            const confirmed = requests.filter(r => r.status === 'confirmed').length;
            const completed = requests.filter(r => r.status === 'completed').length;
            const cancelled = requests.filter(r => r.status === 'cancelled').length;
            
            document.getElementById('vendor-requests-summary').innerHTML = `
                <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #d97706;">${pending}</div>
                    <div style="font-size: 0.85rem; color: #92400e;">Pending</div>
                </div>
                <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #2563eb;">${confirmed}</div>
                    <div style="font-size: 0.85rem; color: #1d4ed8;">Confirmed</div>
                </div>
                <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #059669;">${completed}</div>
                    <div style="font-size: 0.85rem; color: #047857;">Completed</div>
                </div>
                <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #6b7280;">${cancelled}</div>
                    <div style="font-size: 0.85rem; color: #4b5563;">Cancelled</div>
                </div>
            `;
        }
        
        function renderVendorRequests(requests) {
            const container = document.getElementById('vendor-requests-list');
            
            if (!requests || requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>No Service Requests</h3>
                        <p>When guests book with external services, requests will appear here.</p>
                    </div>
                `;
                return;
            }
            
            const statusColors = {
                pending: 'background: #fef3c7; color: #92400e;',
                confirmed: 'background: #dbeafe; color: #1d4ed8;',
                completed: 'background: #d1fae5; color: #047857;',
                cancelled: 'background: #fee2e2; color: #dc2626;'
            };
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Vendor</th>
                                <th>Guest</th>
                                <th>Service Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requests.map(r => `
                                <tr>
                                    <td>
                                        <strong>${r.service_name || r.upsell_name || 'Service'}</strong>
                                        ${r.quantity > 1 ? `<span style="color: #6b7280;"> ${r.quantity}</span>` : ''}
                                        ${r.property_name ? `<br><span style="font-size: 0.8rem; color: #6b7280;">${r.property_name}</span>` : ''}
                                    </td>
                                    <td>
                                        <strong>${r.vendor_name}</strong>
                                        ${r.vendor_email ? `<br><span style="font-size: 0.8rem; color: #6b7280;">${r.vendor_email}</span>` : ''}
                                    </td>
                                    <td>
                                        ${r.guest_name || '-'}
                                        ${r.guest_phone ? `<br><span style="font-size: 0.8rem;">${r.guest_phone}</span>` : ''}
                                    </td>
                                    <td>
                                        ${r.service_date ? new Date(r.service_date).toLocaleDateString() : '-'}
                                        ${r.service_time ? `<br><span style="font-size: 0.85rem;">${r.service_time}</span>` : ''}
                                    </td>
                                    <td>
                                        <span class="badge" style="${statusColors[r.status] || ''}">${r.status}</span>
                                        ${r.confirmed_at ? `<br><span style="font-size: 0.75rem; color: #6b7280;">Confirmed: ${new Date(r.confirmed_at).toLocaleDateString()}</span>` : ''}
                                    </td>
                                    <td>
                                        ${r.status === 'pending' ? `
                                            <button class="btn btn-small" style="background:#2563eb;border-color:#2563eb;" onclick="updateRequestStatus(${r.id}, 'confirmed')"> Confirm</button>
                                        ` : ''}
                                        ${r.status === 'confirmed' ? `
                                            <button class="btn btn-small" style="background:#059669;border-color:#059669;" onclick="updateRequestStatus(${r.id}, 'completed')"> Complete</button>
                                        ` : ''}
                                        ${['pending', 'confirmed'].includes(r.status) ? `
                                            <button class="btn btn-secondary btn-small" onclick="updateRequestStatus(${r.id}, 'cancelled')">Cancel</button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        async function updateRequestStatus(requestId, status) {
            if (status === 'cancelled' && !confirm('Cancel this service request?')) return;
            
            try {
                const response = await fetch(`/api/admin/vendor-requests/${requestId}/status`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Request ${status}`, 'success');
                    loadVendorRequests();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error updating request: ' + error.message);
            }
        }

        // =====================================================
        // FEES FUNCTIONS
        // =====================================================
        
        let feesData = [];
        
        async function loadFees() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/fees${queryString}`);
                const data = await response.json();
                
                if (data.success) {
                    feesData = data.data || [];
                    renderFees(feesData);
                }
            } catch (error) {
                console.error('Error loading fees:', error);
            }
        }
        
        function renderFees(fees) {
            const container = document.getElementById('fees-list');
            
            if (!fees || fees.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>No Fees Configured</h3>
                        <p>Add cleaning fees, taxes, or other charges</p>
                        <button class="btn" onclick="openAddFeeModal()">Add Your First Fee</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Amount</th>
                            <th style="text-align: left; padding: 0.75rem;">Apply Per</th>
                            <th style="text-align: center; padding: 0.75rem;">Type</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const applyPerLabels = {
                'per_booking': 'Per Booking',
                'per_night': 'Per Night',
                'per_guest': 'Per Guest',
                'per_guest_per_night': 'Per Guest/Night'
            };
            
            for (const fee of fees) {
                const amountDisplay = fee.amount_type === 'percentage' 
                    ? `${fee.amount}%` 
                    : `$${parseFloat(fee.amount).toFixed(2)}`;
                    
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${fee.name}</strong>
                            ${fee.description ? `<br><small style="color: #64748b;">${fee.description}</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #d97706;">${amountDisplay}</td>
                        <td style="padding: 0.75rem; color: #64748b;">${applyPerLabels[fee.apply_per] || fee.apply_per}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${fee.is_tax ? 'badge-warning' : 'badge-secondary'}">${fee.is_tax ? 'Tax' : 'Fee'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${fee.active ? 'badge-success' : 'badge-secondary'}">${fee.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editFee(${fee.id})" style="background: none; border: none; cursor: pointer;"></button>
                            <button onclick="deleteFee(${fee.id})" style="background: none; border: none; cursor: pointer;"></button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function openAddFeeModal() {
            document.getElementById('fee-form').reset();
            document.getElementById('fee-id').value = '';
            document.getElementById('fee-modal-title').innerHTML = ' Add Fee';
            document.getElementById('fee-active').checked = true;
            document.getElementById('fee-amount-prefix').textContent = '$';
            await loadFeeProperties();
            openModal('addFeeModal');
        }
        
        async function loadFeeProperties() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('fee-property');
                select.innerHTML = '<option value="">All Properties</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                document.getElementById('fee-unit').innerHTML = '<option value="">All Units</option>';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadFeeUnits() {
            const propertyId = document.getElementById('fee-property').value;
            const unitSelect = document.getElementById('fee-unit');
            
            unitSelect.innerHTML = '<option value="">All Units</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    units.forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        function toggleFeeAmountInput() {
            const type = document.getElementById('fee-amount-type').value;
            document.getElementById('fee-amount-prefix').textContent = type === 'percentage' ? '' : '$';
        }
        
        async function editFee(id) {
            const fee = feesData.find(f => f.id === id);
            if (!fee) return;
            
            document.getElementById('fee-id').value = fee.id;
            document.getElementById('fee-name').value = fee.name || '';
            document.getElementById('fee-description').value = fee.description || '';
            document.getElementById('fee-amount-type').value = fee.amount_type || 'fixed';
            document.getElementById('fee-amount').value = fee.amount || '';
            document.getElementById('fee-apply-per').value = fee.apply_per || 'per_booking';
            document.getElementById('fee-is-tax').checked = fee.is_tax;
            document.getElementById('fee-active').checked = fee.active;
            
            toggleFeeAmountInput();
            document.getElementById('fee-modal-title').innerHTML = ' Edit Fee';
            openModal('addFeeModal');
        }
        
        async function saveFee() {
            const id = document.getElementById('fee-id').value;
            const feeData = {
                name: document.getElementById('fee-name').value,
                description: document.getElementById('fee-description').value,
                amount_type: document.getElementById('fee-amount-type').value,
                amount: parseFloat(document.getElementById('fee-amount').value),
                apply_per: document.getElementById('fee-apply-per').value,
                is_tax: document.getElementById('fee-is-tax').checked,
                active: document.getElementById('fee-active').checked
            };
            
            try {
                const url = id ? `/api/admin/fees/${id}` : '/api/admin/fees';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(feeData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addFeeModal');
                    loadFees();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving fee: ' + error.message);
            }
        }
        
        async function deleteFee(id) {
            if (!confirm('Delete this fee?')) return;
            
            try {
                const response = await fetch(`/api/admin/fees/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadFees();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting fee: ' + error.message);
            }
        }

        // =====================================================
        // TAXES FUNCTIONS
        // =====================================================
        
        let taxesData = [];
        
        async function loadTaxesPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('taxes-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for taxes:', error);
            }
        }
        
        async function loadTaxesRooms() {
            const propertyId = document.getElementById('taxes-property-select')?.value;
            const roomSelect = document.getElementById('taxes-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">All Rooms</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        // =====================================================
        // PAYMENTS FUNCTIONS
        // =====================================================
        
        async function populatePropertySelect(selectId) {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                // Restore previous selection if it exists
                if (currentValue) select.value = currentValue;
            } catch (error) {
                console.error('Error loading properties for select:', error);
            }
        }
        
        async function checkStripeConnectionStatus(propertyId = null) {
            try {
                let accountId;
                
                // If property selected, get its account's Stripe status
                if (propertyId) {
                    const propResponse = await fetch(`/api/db/properties/${propertyId}`);
                    const propData = await propResponse.json();
                    if (propData.success && propData.data) {
                        accountId = propData.data.account_id;
                    }
                }
                
                // Fall back to selected account or global filter
                if (!accountId) {
                    accountId = selectedAccountId || window.currentAccountId;
                }
                
                const statusText = document.getElementById('stripe-status-text');
                const btnArea = document.getElementById('stripe-connect-btn-area');
                
                if (!accountId) {
                    statusText.innerHTML = `<span style="color: #6b7280;">Select a property to view Stripe connection status</span>`;
                    btnArea.innerHTML = '';
                    return;
                }
                
                const response = await fetch(`/api/accounts/${accountId}/stripe-status`);
                const data = await response.json();
                
                if (data.success && data.connected) {
                    statusText.innerHTML = `<span style="color: #059669;"> Connected</span> - Stripe Account: ${data.stripe_account_id}`;
                    btnArea.innerHTML = `
                        <button class="btn btn-secondary" onclick="disconnectStripeForAccount(${accountId})">
                            Disconnect Stripe
                        </button>
                    `;
                } else {
                    statusText.innerHTML = `<span style="color: #dc2626;"> Not Connected</span> - Connect Stripe to accept payments for this property`;
                    btnArea.innerHTML = `
                        <a href="/api/stripe/connect/${accountId}" class="btn" style="background: #635bff; text-decoration: none;">
                             Connect Stripe
                        </a>
                    `;
                }
            } catch (error) {
                console.error('Error checking Stripe status:', error);
            }
        }
        
        async function disconnectStripeForAccount(accountId) {
            if (!confirm('Are you sure you want to disconnect Stripe? You will not be able to accept payments until you reconnect.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${accountId}/stripe-disconnect`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Stripe disconnected successfully');
                    const propertyId = document.getElementById('payments-property-select')?.value;
                    checkStripeConnectionStatus(propertyId || null);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error disconnecting Stripe:', error);
                alert('Error disconnecting Stripe');
            }
        }
        
        async function loadPaymentsForProperty() {
            const propertyId = document.getElementById('payments-property-select').value;
            const status = document.getElementById('payments-status-select').value;
            const dateRange = document.getElementById('payments-date-range').value;
            
            // Update Stripe status based on selected property
            checkStripeConnectionStatus(propertyId || null);
            
            try {
                // Build query params
                let url = '/api/bookings?include_payments=true';
                if (propertyId) url += `&property_id=${propertyId}`;
                if (status) url += `&payment_status=${status}`;
                if (dateRange !== 'all') {
                    const daysAgo = new Date();
                    daysAgo.setDate(daysAgo.getDate() - parseInt(dateRange));
                    url += `&from_date=${daysAgo.toISOString().split('T')[0]}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                const listEl = document.getElementById('payments-bookings-list');
                
                if (data.success && data.bookings && data.bookings.length > 0) {
                    // Calculate stats
                    let pendingCount = 0;
                    let depositsReceived = 0;
                    let balanceDue = 0;
                    let totalCollected = 0;
                    
                    data.bookings.forEach(b => {
                        const total = parseFloat(b.total_amount) || 0;
                        const deposit = parseFloat(b.deposit_amount) || 0;
                        const balance = parseFloat(b.balance_amount) || 0;
                        
                        if (b.payment_status === 'pending' || !b.payment_status) pendingCount++;
                        if (b.deposit_paid_at) depositsReceived += deposit;
                        if (!b.balance_paid_at && b.deposit_paid_at) balanceDue += (total - deposit);
                        if (b.balance_paid_at) totalCollected += total;
                        else if (b.deposit_paid_at) totalCollected += deposit;
                    });
                    
                    document.getElementById('pending-payments-count').textContent = pendingCount;
                    document.getElementById('deposits-received-amount').textContent = '' + depositsReceived.toFixed(2);
                    document.getElementById('balance-due-amount').textContent = '' + balanceDue.toFixed(2);
                    document.getElementById('total-collected-amount').textContent = '' + totalCollected.toFixed(2);
                    
                    // Render bookings
                    listEl.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border);">
                                    <th style="text-align: left; padding: 0.75rem;">Guest</th>
                                    <th style="text-align: left; padding: 0.75rem;">Property / Room</th>
                                    <th style="text-align: left; padding: 0.75rem;">Dates</th>
                                    <th style="text-align: right; padding: 0.75rem;">Total</th>
                                    <th style="text-align: right; padding: 0.75rem;">Deposit</th>
                                    <th style="text-align: center; padding: 0.75rem;">Status</th>
                                    <th style="text-align: center; padding: 0.75rem;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.bookings.map(b => {
                                    const statusBadge = getPaymentStatusBadge(b.payment_status);
                                    const total = parseFloat(b.total_amount) || 0;
                                    const deposit = parseFloat(b.deposit_amount) || 0;
                                    return `
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <td style="padding: 0.75rem;">
                                                <strong>${b.guest_first_name || ''} ${b.guest_last_name || ''}</strong><br>
                                                <small style="color: #64748b;">${b.guest_email || ''}</small>
                                            </td>
                                            <td style="padding: 0.75rem;">
                                                ${b.property_name || 'N/A'}<br>
                                                <small style="color: #64748b;">${b.room_name || ''}</small>
                                            </td>
                                            <td style="padding: 0.75rem;">
                                                ${formatDate(b.check_in)} - ${formatDate(b.check_out)}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: right;">
                                                ${total.toFixed(2)}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: right;">
                                                ${deposit.toFixed(2)}
                                                ${b.deposit_paid_at ? '<br><small style="color: #059669;"> Paid</small>' : ''}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center;">
                                                ${statusBadge}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center;">
                                                <button class="btn btn-small" onclick="viewPaymentDetails(${b.id})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                    View
                                                </button>
                                                ${!b.deposit_paid_at ? `
                                                    <button class="btn btn-small" onclick="sendPaymentLink(${b.id})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: #059669;">
                                                        Send Link
                                                    </button>
                                                ` : ''}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    listEl.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No bookings found</p>';
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                document.getElementById('payments-bookings-list').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 2rem;">Error loading bookings</p>';
            }
        }
        
        function getPaymentStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge badge-warning"> Pending</span>',
                'deposit_paid': '<span class="badge badge-info"> Deposit Paid</span>',
                'fully_paid': '<span class="badge badge-success"> Fully Paid</span>',
                'refunded': '<span class="badge badge-secondary"> Refunded</span>',
                'failed': '<span class="badge badge-error"> Failed</span>'
            };
            return badges[status] || '<span class="badge"> Pending</span>';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        async function viewPaymentDetails(bookingId) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}/payments`);
                const data = await response.json();
                
                let html = `<h3>Payment History for Booking #${bookingId}</h3>`;
                
                if (data.success && data.payments && data.payments.length > 0) {
                    html += `
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border);">
                                    <th style="text-align: left; padding: 0.5rem;">Date</th>
                                    <th style="text-align: left; padding: 0.5rem;">Type</th>
                                    <th style="text-align: right; padding: 0.5rem;">Amount</th>
                                    <th style="text-align: center; padding: 0.5rem;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.payments.map(p => `
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 0.5rem;">${formatDate(p.created_at)}</td>
                                        <td style="padding: 0.5rem;">${p.transaction_type}</td>
                                        <td style="padding: 0.5rem; text-align: right;">${parseFloat(p.amount).toFixed(2)}</td>
                                        <td style="padding: 0.5rem; text-align: center;">${p.status}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    html += '<p style="color: #64748b; margin-top: 1rem;">No payments recorded yet.</p>';
                }
                
                // Show in a simple alert for now (could be a modal)
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div class="modal" id="payment-details-modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                                <h3 style="margin: 0;"> Payment Details</h3>
                                <button class="close-btn" onclick="this.closest('.modal').remove()" style="color: white; background: none; border: none; font-size: 1.5rem; cursor: pointer;"></button>
                            </div>
                            <div class="modal-body">
                                ${html}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading payment details:', error);
                alert('Error loading payment details');
            }
        }
        
        async function sendPaymentLink(bookingId) {
            alert('Payment link feature coming soon! This will email the guest a link to pay their deposit.');
        }
        
        // =====================================================
        // DEPOSIT RULES FUNCTIONS
        // =====================================================
        
        async function loadDepositRulesForProperty() {
            const selectValue = document.getElementById('deposit-rules-property-select').value;
            const listEl = document.getElementById('deposit-rules-list');
            
            if (!selectValue) {
                listEl.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">Select a property or "All Properties" to view deposit rules</p>';
                return;
            }
            
            try {
                let response;
                let isAccountLevel = selectValue === 'all';
                
                if (isAccountLevel) {
                    // Get account ID from current filter
                    const accountId = selectedAccountId || 1;
                    response = await fetch(`/api/accounts/${accountId}/deposit-rules`);
                } else {
                    response = await fetch(`/api/properties/${selectValue}/deposit-rules`);
                }
                
                const data = await response.json();
                
                const scopeLabel = isAccountLevel ? ' Account Default' : ' Property Specific';
                
                if (data.success && data.rules && data.rules.length > 0) {
                    listEl.innerHTML = data.rules.map(rule => `
                        <div class="card" style="margin-bottom: 1rem; border: 1px solid ${rule.is_active ? '#10b981' : '#d1d5db'}; ${rule.is_active ? 'background: #f0fdf4;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: 0.5rem;">
                                        ${rule.rule_name || 'Unnamed Rule'}
                                        ${rule.is_active ? '<span class="badge badge-success" style="margin-left: 0.5rem;">Active</span>' : '<span class="badge badge-secondary" style="margin-left: 0.5rem;">Inactive</span>'}
                                        <span class="badge" style="margin-left: 0.5rem; background: #e0e7ff; color: #3730a3;">${scopeLabel}</span>
                                    </h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                        <div>
                                            <strong style="color: #64748b; font-size: 0.85rem;">Deposit</strong><br>
                                            ${getDepositTypeDisplay(rule)}
                                        </div>
                                        <div>
                                            <strong style="color: #64748b; font-size: 0.85rem;">Balance Due</strong><br>
                                            ${rule.balance_due_days} days before check-in
                                        </div>
                                        <div>
                                            <strong style="color: #64748b; font-size: 0.85rem;">Refund Policy</strong><br>
                                            ${capitalizeFirst(rule.refund_policy || 'flexible')}
                                        </div>
                                        <div>
                                            <strong style="color: #64748b; font-size: 0.85rem;">Auto-charge Balance</strong><br>
                                            ${rule.auto_charge_balance ? ' Yes' : ' No'}
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-small" onclick="editDepositRule(${rule.id})" style="font-size: 0.8rem;">Edit</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteDepositRule(${rule.id})" style="font-size: 0.8rem; background: #ef4444;">Delete</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    const createLabel = isAccountLevel ? 'Create Account Default Rule' : 'Create First Rule';
                    listEl.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <p style="color: #64748b; margin-bottom: 1rem;">No deposit rules configured${isAccountLevel ? ' for this account' : ' for this property'}.</p>
                            <button class="btn" onclick="openAddDepositRuleModal()">
                                + ${createLabel}
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading deposit rules:', error);
                listEl.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 2rem;">Error loading deposit rules</p>';
            }
        }
        
        function getDepositTypeDisplay(rule) {
            switch(rule.deposit_type) {
                case 'percentage':
                    return `${rule.deposit_percentage}% of total`;
                case 'fixed':
                    return `${parseFloat(rule.deposit_fixed_amount || 0).toFixed(2)} fixed`;
                case 'first_night':
                    return 'First night';
                case 'full':
                    return 'Full payment';
                default:
                    return `${rule.deposit_percentage || 30}%`;
            }
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        function openAddDepositRuleModal() {
            const selectValue = document.getElementById('deposit-rules-property-select').value;
            if (!selectValue) {
                alert('Please select a property or "All Properties" first');
                return;
            }
            
            const isAccountLevel = selectValue === 'all';
            const defaultName = isAccountLevel ? 'Account Default Deposit' : 'Standard Deposit';
            
            document.getElementById('deposit-rule-id').value = '';
            document.getElementById('deposit-rule-property-id').value = selectValue;
            document.getElementById('deposit-rule-name').value = defaultName;
            document.getElementById('deposit-type').value = 'percentage';
            document.getElementById('deposit-percentage').value = '30';
            document.getElementById('deposit-fixed-amount').value = '';
            document.getElementById('balance-due-days').value = '14';
            document.getElementById('auto-charge-balance').checked = false;
            document.getElementById('refund-policy').value = 'flexible';
            document.getElementById('deposit-rule-active').checked = true;
            
            toggleDepositTypeFields();
            openModal('depositRuleModal');
        }
        
        function toggleDepositTypeFields() {
            const type = document.getElementById('deposit-type').value;
            document.getElementById('percentage-field').style.display = (type === 'percentage') ? 'block' : 'none';
            document.getElementById('fixed-amount-field').style.display = (type === 'fixed') ? 'block' : 'none';
        }
        
        function toggleBulkDepositTypeFields() {
            const type = document.getElementById('bulk-deposit-type').value;
            document.getElementById('bulk-percentage-field').style.display = (type === 'percentage') ? 'block' : 'none';
            document.getElementById('bulk-fixed-amount-field').style.display = (type === 'fixed') ? 'block' : 'none';
        }
        
        async function openBulkDepositRuleModal() {
            const listEl = document.getElementById('bulk-property-list');
            
            // Fetch properties for current account (use selectedAccountId from filter)
            const accountId = selectedAccountId || '';
            let url = '/api/db/properties';
            if (accountId) {
                url += `?account_id=${accountId}`;
            }
            
            console.log('Fetching properties from:', url, 'selectedAccountId:', selectedAccountId);
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Properties response:', data);
                
                if (data.success && data.data && data.data.length > 0) {
                    listEl.innerHTML = data.data.map(prop => `
                        <label style="display: flex; align-items: center; padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #f3f4f6;">
                            <input type="checkbox" class="bulk-property-checkbox" value="${prop.id}" style="margin-right: 0.75rem;">
                            <span>${prop.name}</span>
                        </label>
                    `).join('');
                } else {
                    listEl.innerHTML = '<p style="color: #64748b; padding: 1rem; text-align: center;">No properties found. Try selecting an account filter first.</p>';
                }
            } catch (error) {
                console.error('Error loading properties:', error);
                listEl.innerHTML = '<p style="color: #ef4444; padding: 1rem;">Error loading properties</p>';
            }
            
            // Reset form
            document.getElementById('bulk-deposit-rule-name').value = 'Standard Deposit';
            document.getElementById('bulk-deposit-type').value = 'percentage';
            document.getElementById('bulk-deposit-percentage').value = '30';
            document.getElementById('bulk-deposit-fixed-amount').value = '';
            document.getElementById('bulk-balance-due-days').value = '14';
            document.getElementById('bulk-refund-policy').value = 'flexible';
            toggleBulkDepositTypeFields();
            
            openModal('bulkDepositRuleModal');
        }
        
        function selectAllBulkProperties() {
            document.querySelectorAll('.bulk-property-checkbox').forEach(cb => cb.checked = true);
        }
        
        function deselectAllBulkProperties() {
            document.querySelectorAll('.bulk-property-checkbox').forEach(cb => cb.checked = false);
        }
        
        async function saveBulkDepositRule() {
            const selectedProperties = Array.from(document.querySelectorAll('.bulk-property-checkbox:checked')).map(cb => cb.value);
            
            if (selectedProperties.length === 0) {
                alert('Please select at least one property');
                return;
            }
            
            const data = {
                rule_name: document.getElementById('bulk-deposit-rule-name').value,
                deposit_type: document.getElementById('bulk-deposit-type').value,
                deposit_percentage: parseFloat(document.getElementById('bulk-deposit-percentage').value) || 30,
                deposit_fixed_amount: parseFloat(document.getElementById('bulk-deposit-fixed-amount').value) || null,
                balance_due_days: parseInt(document.getElementById('bulk-balance-due-days').value) || 14,
                refund_policy: document.getElementById('bulk-refund-policy').value,
                is_active: true
            };
            
            let successCount = 0;
            let failCount = 0;
            
            for (const propertyId of selectedProperties) {
                try {
                    const response = await fetch(`/api/properties/${propertyId}/deposit-rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
            }
            
            closeModal('bulkDepositRuleModal');
            
            if (failCount === 0) {
                alert(` Deposit rule applied to ${successCount} properties!`);
            } else {
                alert(`Applied to ${successCount} properties, ${failCount} failed.`);
            }
            
            loadDepositRulesForProperty();
        }
        
        async function editDepositRule(ruleId) {
            try {
                const response = await fetch(`/api/deposit-rules/${ruleId}`);
                const data = await response.json();
                
                if (data.success && data.rule) {
                    const rule = data.rule;
                    document.getElementById('deposit-rule-id').value = rule.id;
                    document.getElementById('deposit-rule-property-id').value = rule.property_id;
                    document.getElementById('deposit-rule-name').value = rule.rule_name || '';
                    document.getElementById('deposit-type').value = rule.deposit_type || 'percentage';
                    document.getElementById('deposit-percentage').value = rule.deposit_percentage || 30;
                    document.getElementById('deposit-fixed-amount').value = rule.deposit_fixed_amount || '';
                    document.getElementById('balance-due-days').value = rule.balance_due_days || 14;
                    document.getElementById('auto-charge-balance').checked = rule.auto_charge_balance || false;
                    document.getElementById('refund-policy').value = rule.refund_policy || 'flexible';
                    document.getElementById('deposit-rule-active').checked = rule.is_active !== false;
                    
                    toggleDepositTypeFields();
                    openModal('depositRuleModal');
                }
            } catch (error) {
                console.error('Error loading deposit rule:', error);
                alert('Error loading deposit rule');
            }
        }
        
        async function saveDepositRule() {
            const ruleId = document.getElementById('deposit-rule-id').value;
            const selectValue = document.getElementById('deposit-rule-property-id').value;
            const isAccountLevel = selectValue === 'all';
            
            const data = {
                rule_name: document.getElementById('deposit-rule-name').value,
                deposit_type: document.getElementById('deposit-type').value,
                deposit_percentage: parseFloat(document.getElementById('deposit-percentage').value) || 30,
                deposit_fixed_amount: parseFloat(document.getElementById('deposit-fixed-amount').value) || null,
                balance_due_days: parseInt(document.getElementById('balance-due-days').value) || 14,
                auto_charge_balance: document.getElementById('auto-charge-balance').checked,
                refund_policy: document.getElementById('refund-policy').value,
                is_active: document.getElementById('deposit-rule-active').checked
            };
            
            try {
                let response;
                if (ruleId) {
                    response = await fetch(`/api/deposit-rules/${ruleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                } else if (isAccountLevel) {
                    const accountId = selectedAccountId || 1;
                    response = await fetch(`/api/accounts/${accountId}/deposit-rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`/api/properties/${selectValue}/deposit-rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                }
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('depositRuleModal');
                    loadDepositRulesForProperty();
                    alert('Deposit rule saved successfully!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving deposit rule:', error);
                alert('Error saving deposit rule');
            }
        }
        
        async function deleteDepositRule(ruleId) {
            if (!confirm('Are you sure you want to delete this deposit rule?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/deposit-rules/${ruleId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    loadDepositRulesForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting deposit rule:', error);
                alert('Error deleting deposit rule');
            }
        }
        
        // Initialize payments view
        function initPaymentsView() {
            populatePropertySelect('payments-property-select');
            loadPaymentsForProperty();
        }
        
        // Initialize deposit rules view
        function initDepositRulesView() {
            populatePropertySelect('deposit-rules-property-select');
        }

        async function loadTaxesForProperty() {
            const propertyId = document.getElementById('taxes-property-select')?.value;
            const roomId = document.getElementById('taxes-room-select')?.value;
            
            // Also load rooms when property changes
            if (!roomId) {
                await loadTaxesRooms();
            }
            
            if (!propertyId) {
                document.getElementById('taxes-list').innerHTML = `
                    <p style="color: #64748b; text-align: center; padding: 2rem;">
                        Select a property to view and manage taxes
                    </p>
                `;
                return;
            }
            
            try {
                // Just pass property_id - server handles the rest
                const response = await fetch(`/api/admin/taxes?property_id=${propertyId}${roomId ? '&room_id=' + roomId : ''}`);
                const data = await response.json();
                
                if (data.success) {
                    taxesData = data.data || [];
                    renderTaxes(taxesData);
                }
            } catch (error) {
                console.error('Error loading taxes:', error);
            }
        }
        
        async function loadTaxes() {
            // Load property selector first
            await loadTaxesPropertySelect();
            
            // Show message to select property
            document.getElementById('taxes-list').innerHTML = `
                <p style="color: #64748b; text-align: center; padding: 2rem;">
                    Select a property to view and manage taxes
                </p>
            `;
        }
        
        function renderTaxes(taxes) {
            const container = document.getElementById('taxes-list');
            const propertyId = document.getElementById('taxes-property-select')?.value;
            
            if (!propertyId) {
                container.innerHTML = `
                    <p style="color: #64748b; text-align: center; padding: 2rem;">
                        Select a property to view and manage taxes
                    </p>
                `;
                return;
            }
            
            if (!taxes || taxes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>No Taxes Configured</h3>
                        <p>Add tourist taxes for this property</p>
                        <button class="btn" onclick="openAddTaxModal()">Add Your First Tax</button>
                    </div>
                `;
                return;
            }
            
            const chargePerLabels = {
                'per_person_per_night': 'Per Person/Night',
                'per_room_per_night': 'Per Room/Night',
                'per_booking': 'Per Booking',
                'percentage': '% of Booking'
            };
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Country</th>
                            <th style="text-align: left; padding: 0.75rem;">Amount</th>
                            <th style="text-align: left; padding: 0.75rem;">Charged</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const tax of taxes) {
                const currencySymbols = { EUR: '', USD: '$', GBP: '', CHF: 'CHF', AED: 'AED', JPY: '' };
                const symbol = currencySymbols[tax.currency] || tax.currency || '';
                const amountDisplay = tax.amount_type === 'percentage' 
                    ? `${tax.amount}%` 
                    : `${symbol}${parseFloat(tax.amount).toFixed(2)}`;
                    
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${tax.name}</strong>
                            ${tax.max_nights ? `<br><small style="color: #64748b;">Max ${tax.max_nights} nights</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem;">${tax.country || '-'}</td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #4f46e5;">${amountDisplay}</td>
                        <td style="padding: 0.75rem; color: #64748b;">${chargePerLabels[tax.charge_per] || tax.charge_per}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${tax.active ? 'badge-success' : 'badge-secondary'}">${tax.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editTax(${tax.id})" style="background: none; border: none; cursor: pointer;"></button>
                            <button onclick="deleteTax(${tax.id})" style="background: none; border: none; cursor: pointer;"></button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function openAddTaxModal() {
            document.getElementById('tax-form').reset();
            document.getElementById('tax-id').value = '';
            document.getElementById('tax-modal-title').innerHTML = ' Add Tourist Tax';
            document.getElementById('tax-active').checked = true;
            
            // Pre-select the property from the page filter
            const selectedProperty = document.getElementById('taxes-property-select')?.value;
            
            // Hide the master-only account field - we use property selector instead
            document.querySelectorAll('.master-only-field').forEach(el => el.style.display = 'none');
            
            await loadTaxPropertiesForModal();
            
            // Pre-select the property if one was selected on page
            if (selectedProperty) {
                document.getElementById('tax-property').value = selectedProperty;
                await loadTaxUnits();
            }
            
            openModal('addTaxModal');
        }
        
        async function loadTaxPropertiesForModal() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('tax-property');
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                document.getElementById('tax-unit').innerHTML = '<option value="">All Units</option>';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadTaxUnits() {
            const propertyId = document.getElementById('tax-property').value;
            const unitSelect = document.getElementById('tax-unit');
            
            unitSelect.innerHTML = '<option value="">All Units</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    units.forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        function toggleTaxAmountInput() {
            const type = document.getElementById('tax-amount-type').value;
            const currencySelect = document.getElementById('tax-currency');
            if (type === 'percentage') {
                currencySelect.style.display = 'none';
            } else {
                currencySelect.style.display = 'block';
            }
        }
        
        function updateTaxPresets() {
            const country = document.getElementById('tax-country').value;
            const presets = {
                'FR': { name: 'Taxe de Sjour', currency: 'EUR', chargePer: 'per_person_per_night' },
                'IT': { name: 'Imposta di Soggiorno', currency: 'EUR', chargePer: 'per_person_per_night' },
                'ES': { name: 'Tasa Turstica', currency: 'EUR', chargePer: 'per_person_per_night' },
                'NL': { name: 'Toeristenbelasting', currency: 'EUR', chargePer: 'percentage' },
                'DE': { name: 'City Tax', currency: 'EUR', chargePer: 'per_person_per_night' },
                'AT': { name: 'Ortstaxe', currency: 'EUR', chargePer: 'per_person_per_night' },
                'PT': { name: 'Taxa Turstica', currency: 'EUR', chargePer: 'per_person_per_night' },
                'CH': { name: 'Kurtaxe', currency: 'CHF', chargePer: 'per_person_per_night' },
                'US': { name: 'Occupancy Tax', currency: 'USD', chargePer: 'percentage' },
                'AE': { name: 'Tourism Dirham', currency: 'AED', chargePer: 'per_room_per_night' },
                'JP': { name: 'Accommodation Tax', currency: 'JPY', chargePer: 'per_person_per_night' }
            };
            
            if (presets[country]) {
                document.getElementById('tax-name').value = presets[country].name;
                document.getElementById('tax-currency').value = presets[country].currency;
                document.getElementById('tax-charge-per').value = presets[country].chargePer;
            }
        }
        
        async function editTax(id) {
            const tax = taxesData.find(t => t.id === id);
            if (!tax) return;
            
            // Hide master-only fields - we use page property selector
            document.querySelectorAll('.master-only-field').forEach(el => el.style.display = 'none');
            
            // Load properties for modal
            await loadTaxPropertiesForModal();
            
            document.getElementById('tax-id').value = tax.id;
            document.getElementById('tax-name').value = tax.name || '';
            document.getElementById('tax-country').value = normalizeCountryCode(tax.country) || '';
            document.getElementById('tax-amount-type').value = tax.amount_type || 'fixed';
            document.getElementById('tax-currency').value = tax.currency || 'EUR';
            document.getElementById('tax-amount').value = tax.amount || '';
            document.getElementById('tax-charge-per').value = tax.charge_per || 'per_person_per_night';
            document.getElementById('tax-max-nights').value = tax.max_nights || '';
            document.getElementById('tax-min-age').value = tax.min_age || '';
            document.getElementById('tax-star-tier').value = tax.star_tier || '';
            document.getElementById('tax-season-start').value = tax.season_start || '';
            document.getElementById('tax-season-end').value = tax.season_end || '';
            document.getElementById('tax-active').checked = tax.active;
            
            // Set property and load units
            if (tax.property_id) {
                document.getElementById('tax-property').value = tax.property_id;
                await loadTaxUnits();
                if (tax.room_id) {
                    document.getElementById('tax-unit').value = tax.room_id;
                }
            }
            
            toggleTaxAmountInput();
            document.getElementById('tax-modal-title').innerHTML = ' Edit Tax';
            openModal('addTaxModal');
        }
        
        async function saveTax() {
            const id = document.getElementById('tax-id').value;
            
            // Get account_id from current account
            const accountId = currentAccount?.id;
            
            const taxData = {
                name: document.getElementById('tax-name').value,
                country: document.getElementById('tax-country').value || null,
                amount_type: document.getElementById('tax-amount-type').value,
                currency: document.getElementById('tax-currency').value,
                amount: parseFloat(document.getElementById('tax-amount').value),
                charge_per: document.getElementById('tax-charge-per').value,
                max_nights: parseInt(document.getElementById('tax-max-nights').value) || null,
                min_age: parseInt(document.getElementById('tax-min-age').value) || null,
                star_tier: document.getElementById('tax-star-tier').value || null,
                season_start: document.getElementById('tax-season-start').value || null,
                season_end: document.getElementById('tax-season-end').value || null,
                property_id: document.getElementById('tax-property').value || null,
                room_id: document.getElementById('tax-unit').value || null,
                active: document.getElementById('tax-active').checked,
                account_id: accountId
            };
            
            try {
                const url = id ? `/api/admin/taxes/${id}` : '/api/admin/taxes';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(taxData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addTaxModal');
                    loadTaxesForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving tax: ' + error.message);
            }
        }
        
        async function deleteTax(id) {
            if (!confirm('Delete this tax?')) return;
            
            try {
                const response = await fetch(`/api/admin/taxes/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadTaxesForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting tax: ' + error.message);
            }
        }

        // Property map instance
        let propertyMap = null;
        let propertyMarker = null;

        // Country to currency mapping
        const countryCurrencyMap = {
            'GB': 'GBP', 'US': 'USD', 'CH': 'CHF', 'DE': 'EUR', 'FR': 'EUR', 
            'IT': 'EUR', 'ES': 'EUR', 'NL': 'EUR', 'AT': 'EUR', 'PT': 'EUR', 
            'BE': 'EUR', 'IE': 'EUR', 'AU': 'AUD', 'NZ': 'NZD', 'CA': 'CAD', 
            'AE': 'AED', 'JP': 'JPY', 'TH': 'THB', 'GR': 'EUR', 'HR': 'EUR', 
            'CZ': 'CZK', 'PL': 'PLN', 'HU': 'HUF', 'SE': 'SEK', 'NO': 'NOK', 
            'DK': 'DKK', 'FI': 'EUR', 'ID': 'IDR', 'MY': 'MYR', 'SG': 'SGD', 
            'PH': 'PHP', 'VN': 'VND', 'IN': 'INR', 'ZA': 'ZAR', 'MX': 'MXN', 
            'BR': 'BRL', 'AR': 'ARS', 'CO': 'COP', 'TR': 'TRY', 'EG': 'EGP', 
            'MA': 'MAD', 'KE': 'KES', 'MU': 'MUR', 'MV': 'MVR', 'LK': 'LKR', 
            'CN': 'CNY', 'KR': 'KRW', 'TW': 'TWD'
        };

        function autoSetCurrencyFromCountry() {
            const countryCode = document.getElementById('edit-property-country').value;
            const propertyId = document.getElementById('edit-property-id').value;
            
            if (countryCode && propertyId && countryCurrencyMap[countryCode]) {
                const currency = countryCurrencyMap[countryCode];
                // Auto-update the currency in database
                updatePropertyCurrency(propertyId, currency);
            }
        }

        async function updatePropertyCurrency(propertyId, currency) {
            try {
                const response = await fetch(`/api/db/properties/${propertyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ currency })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Currency updated to ' + currency, 'success');
                } else {
                    showNotification('Failed to update currency: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error updating currency: ' + error.message, 'error');
            }
        }

        async function editProperty(id) {
            try {
                const response = await fetch(`/api/db/properties/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const prop = data.data;
                    document.getElementById('edit-property-id').value = prop.id;
                    document.getElementById('edit-property-name').value = prop.name || '';
                    document.getElementById('edit-property-type').value = prop.property_type || 'hotel';
                    document.getElementById('edit-property-address').value = prop.address || '';
                    document.getElementById('edit-property-city').value = prop.city || '';
                    document.getElementById('edit-property-district').value = prop.district || '';
                    document.getElementById('edit-property-state').value = prop.state || '';
                    document.getElementById('edit-property-zipcode').value = prop.zip_code || '';
                    document.getElementById('edit-property-country').value = normalizeCountryCode(prop.country) || '';
                    document.getElementById('edit-property-latitude').value = prop.latitude || '';
                    document.getElementById('edit-property-longitude').value = prop.longitude || '';
                    document.getElementById('edit-property-status').value = prop.status || 'active';
                    
                    // Stripe fields
                    document.getElementById('edit-property-stripe-name').value = prop.stripe_name || '';
                    document.getElementById('edit-property-stripe-secret').value = ''; // Don't show secret, just placeholder
                    
                    // Update Stripe status display
                    const stripeStatus = document.getElementById('property-stripe-status');
                    if (prop.stripe_secret_key) {
                        const stripeName = prop.stripe_name ? ` (${prop.stripe_name})` : '';
                        stripeStatus.innerHTML = `<span style="color: #10b981;">âœ“ Stripe is connected${stripeName}</span>`;
                        stripeStatus.style.background = '#d1fae5';
                        document.getElementById('edit-property-stripe-secret').placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ (saved)';
                    } else {
                        stripeStatus.innerHTML = '<span style="color: #f59e0b;">âš  Stripe not connected - payments disabled for this property</span>';
                        stripeStatus.style.background = '#fef3c7';
                    }
                    
                    // Master admin: show account dropdown
                    const accountSection = document.getElementById('property-account-section');
                    if (currentAccount && currentAccount.role === 'master_admin') {
                        accountSection.style.display = 'block';
                        // Load accounts into dropdown
                        const accountsRes = await fetch('/api/admin/accounts', { headers: authHeaders() });
                        const accountsData = await accountsRes.json();
                        const accountSelect = document.getElementById('edit-property-account-id');
                        if (accountsData.success && accountsData.accounts) {
                            accountSelect.innerHTML = accountsData.accounts.map(a => 
                                `<option value="${a.id}" ${a.id === prop.account_id ? 'selected' : ''}>${a.name} (${a.email || 'no email'})</option>`
                            ).join('');
                        }
                    } else {
                        accountSection.style.display = 'none';
                    }
                    
                    // Reset map state
                    document.getElementById('property-map-preview').style.display = 'none';
                    document.getElementById('toggle-map-btn').textContent = ' Show Map';
                    propertyMap = null;
                    propertyMarker = null;
                    
                    openModal('editPropertyModal');
                }
            } catch (error) {
                console.error('Error loading property:', error);
                alert('Error loading property details');
            }
        }

        async function saveProperty(e) {
            e.preventDefault();
            const id = document.getElementById('edit-property-id').value;
            const data = {
                name: document.getElementById('edit-property-name').value,
                property_type: document.getElementById('edit-property-type').value,
                address: document.getElementById('edit-property-address').value,
                city: document.getElementById('edit-property-city').value,
                district: document.getElementById('edit-property-district').value,
                state: document.getElementById('edit-property-state').value,
                zip_code: document.getElementById('edit-property-zipcode').value,
                country: document.getElementById('edit-property-country').value,
                latitude: document.getElementById('edit-property-latitude').value ? parseFloat(document.getElementById('edit-property-latitude').value) : null,
                longitude: document.getElementById('edit-property-longitude').value ? parseFloat(document.getElementById('edit-property-longitude').value) : null,
                status: document.getElementById('edit-property-status').value,
                // Stripe fields
                stripe_name: document.getElementById('edit-property-stripe-name').value || null
            };
            
            // Only include secret key if it was changed (not the placeholder)
            const secretKey = document.getElementById('edit-property-stripe-secret').value;
            if (secretKey && !secretKey.includes('â€¢')) {
                data.stripe_secret_key = secretKey;
            }
            
            // Master admin can change account_id
            const accountIdSelect = document.getElementById('edit-property-account-id');
            if (accountIdSelect && accountIdSelect.value && currentAccount && currentAccount.role === 'master_admin') {
                data.account_id = parseInt(accountIdSelect.value);
            }
            
            try {
                const response = await fetch(`/api/db/properties/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(' Property updated successfully!');
                    closeModal('editPropertyModal');
                    loadProperties();
                } else {
                    alert('Error updating property: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving property:', error);
                alert('Error saving property');
            }
            
            return false;
        }

        async function geocodePropertyAddress() {
            const address = document.getElementById('edit-property-address').value;
            const city = document.getElementById('edit-property-city').value;
            const state = document.getElementById('edit-property-state').value;
            const zipcode = document.getElementById('edit-property-zipcode').value;
            const country = document.getElementById('edit-property-country').value;
            
            const fullAddress = [address, city, state, zipcode, country].filter(Boolean).join(', ');
            
            if (!fullAddress) {
                alert('Please enter an address first');
                return;
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`, {
                    headers: { 'User-Agent': 'GAS-Admin/1.0' }
                });
                
                const results = await response.json();
                
                if (results && results.length > 0) {
                    const lat = parseFloat(results[0].lat).toFixed(7);
                    const lon = parseFloat(results[0].lon).toFixed(7);
                    
                    document.getElementById('edit-property-latitude').value = lat;
                    document.getElementById('edit-property-longitude').value = lon;
                    
                    if (propertyMap) {
                        updatePropertyMapMarker(lat, lon);
                    }
                    
                    alert(` Coordinates found!\n\nLatitude: ${lat}\nLongitude: ${lon}`);
                } else {
                    alert('Could not find coordinates for this address. Try being more specific or enter coordinates manually.');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error looking up address. Please enter coordinates manually.');
            }
        }

        function togglePropertyMap() {
            const mapPreview = document.getElementById('property-map-preview');
            const btn = document.getElementById('toggle-map-btn');
            
            if (mapPreview.style.display === 'none') {
                mapPreview.style.display = 'block';
                btn.textContent = ' Hide Map';
                if (!propertyMap) {
                    initPropertyMap();
                }
            } else {
                mapPreview.style.display = 'none';
                btn.textContent = ' Show Map';
            }
        }

        function initPropertyMap() {
            if (!document.getElementById('leaflet-css')) {
                const link = document.createElement('link');
                link.id = 'leaflet-css';
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(link);
            }
            
            if (typeof L === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.onload = () => createPropertyMap();
                document.head.appendChild(script);
            } else {
                createPropertyMap();
            }
        }

        function createPropertyMap() {
            const lat = parseFloat(document.getElementById('edit-property-latitude').value) || 51.5074;
            const lon = parseFloat(document.getElementById('edit-property-longitude').value) || -0.1278;
            
            propertyMap = L.map('property-map-container').setView([lat, lon], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap'
            }).addTo(propertyMap);
            
            if (document.getElementById('edit-property-latitude').value) {
                propertyMarker = L.marker([lat, lon], { draggable: true }).addTo(propertyMap);
                propertyMarker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    document.getElementById('edit-property-latitude').value = pos.lat.toFixed(7);
                    document.getElementById('edit-property-longitude').value = pos.lng.toFixed(7);
                });
            }
            
            propertyMap.on('click', function(e) {
                document.getElementById('edit-property-latitude').value = e.latlng.lat.toFixed(7);
                document.getElementById('edit-property-longitude').value = e.latlng.lng.toFixed(7);
                
                if (propertyMarker) {
                    propertyMarker.setLatLng(e.latlng);
                } else {
                    propertyMarker = L.marker(e.latlng, { draggable: true }).addTo(propertyMap);
                    propertyMarker.on('dragend', function(ev) {
                        const pos = ev.target.getLatLng();
                        document.getElementById('edit-property-latitude').value = pos.lat.toFixed(7);
                        document.getElementById('edit-property-longitude').value = pos.lng.toFixed(7);
                    });
                }
            });
            
            setTimeout(() => propertyMap.invalidateSize(), 100);
        }

        function updatePropertyMapMarker(lat, lon) {
            if (propertyMap) {
                propertyMap.setView([lat, lon], 15);
                if (propertyMarker) {
                    propertyMarker.setLatLng([lat, lon]);
                } else {
                    propertyMarker = L.marker([lat, lon], { draggable: true }).addTo(propertyMap);
                    propertyMarker.on('dragend', function(e) {
                        const pos = e.target.getLatLng();
                        document.getElementById('edit-property-latitude').value = pos.lat.toFixed(7);
                        document.getElementById('edit-property-longitude').value = pos.lng.toFixed(7);
                    });
                }
            }
        }

        async function deleteProperty() {
            const id = document.getElementById('edit-property-id').value;
            const name = document.getElementById('edit-property-name').value;
            
            if (!confirm(`Are you sure you want to delete "${name}"?\n\nThis will also delete all rooms, images, and related data.\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/db/properties/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Property deleted successfully!');
                    closeModal('editPropertyModal');
                    loadProperties();
                    loadDashboard(); // Refresh stats
                } else {
                    alert('Error deleting property: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting property:', error);
                alert('Error deleting property');
            }
        }

        async function editRoom(id) {
            try {
                const response = await fetch(`/api/admin/units/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const room = data.data;
                    document.getElementById('edit-room-id').value = room.id;
                    
                    // CM Data (read-only display)
                    document.getElementById('edit-room-name').value = room.name || '';
                    
                    // Display name - handle JSON format {en: "name"}
                    let displayName = room.display_name || '';
                    if (typeof displayName === 'object' && displayName !== null) {
                        displayName = displayName.en || '';
                    } else if (typeof displayName === 'string' && displayName.startsWith('{')) {
                        try { displayName = JSON.parse(displayName).en || displayName; } catch(e) {}
                    }
                    document.getElementById('edit-room-display-name').value = displayName;
                    
                    // Short description - handle JSON format
                    let shortDesc = room.short_description || '';
                    if (typeof shortDesc === 'object' && shortDesc !== null) {
                        shortDesc = shortDesc.en || '';
                    } else if (typeof shortDesc === 'string' && shortDesc.startsWith('{')) {
                        try { shortDesc = JSON.parse(shortDesc).en || shortDesc; } catch(e) {}
                    }
                    document.getElementById('edit-room-short-description').value = shortDesc;
                    
                    // Full description - handle JSON format
                    let fullDesc = room.full_description || '';
                    if (typeof fullDesc === 'object' && fullDesc !== null) {
                        fullDesc = fullDesc.en || '';
                    } else if (typeof fullDesc === 'string' && fullDesc.startsWith('{')) {
                        try { fullDesc = JSON.parse(fullDesc).en || fullDesc; } catch(e) {}
                    }
                    document.getElementById('edit-room-full-description').value = fullDesc;
                    
                    // Editable fields
                    document.getElementById('edit-room-type').value = room.unit_type || 'double';
                    document.getElementById('edit-room-maxguests').value = room.max_guests || 2;
                    document.getElementById('edit-room-maxadults').value = room.max_adults || 2;
                    document.getElementById('edit-room-maxchildren').value = room.max_children || 0;
                    
                    // GAS Controls
                    document.getElementById('edit-room-quantity').value = room.quantity || 1;
                    document.getElementById('edit-room-status').value = room.status || 'available';
                    
                    openModal('editRoomModal');
                }
            } catch (error) {
                console.error('Error loading room:', error);
                alert('Error loading room details');
            }
        }
        
        function getAmenityName(a) {
            if (typeof a.amenity_name === 'string') {
                if (a.amenity_name.startsWith('{')) {
                    try { return JSON.parse(a.amenity_name).en || a.amenity_code; } catch(e) { return a.amenity_code; }
                }
                return a.amenity_name;
            }
            return a.amenity_name?.en || a.amenity_code;
        }

        async function saveRoom(e) {
            e.preventDefault();
            const id = document.getElementById('edit-room-id').value;
            
            // Get all editable fields including descriptions
            const data = {
                display_name: document.getElementById('edit-room-display-name').value || null,
                short_description: document.getElementById('edit-room-short-description').value || null,
                full_description: document.getElementById('edit-room-full-description').value || null,
                room_type: document.getElementById('edit-room-type').value,
                max_guests: parseInt(document.getElementById('edit-room-maxguests').value) || 2,
                max_adults: parseInt(document.getElementById('edit-room-maxadults').value) || 2,
                max_children: parseInt(document.getElementById('edit-room-maxchildren').value) || 0,
                quantity: document.getElementById('edit-room-quantity').value || 1,
                status: document.getElementById('edit-room-status').value
            };
            
            try {
                // Update room fields
                const response = await fetch(`/api/admin/units/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('Room updated successfully!', 'success');
                    closeModal('editRoomModal');
                    loadRoomsForProperty();
                } else {
                    alert('Error updating room: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving room:', error);
                alert('Error saving room');
            }
            
            return false;
        }
        
        async function generateRoomDescription(type) {
            const roomId = document.getElementById('edit-room-id').value;
            const roomName = document.getElementById('edit-room-name').value;
            const prompt = document.getElementById('edit-room-ai-prompt').value;
            
            if (!roomId) return alert('No room selected');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: type === 'short' ? 'room_short' : 'room_full',
                        room_id: roomId,
                        room_name: roomName,
                        prompt 
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    if (type === 'short') {
                        document.getElementById('edit-room-short-description').value = result.content;
                    } else {
                        document.getElementById('edit-room-full-description').value = result.content;
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating content');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generateRoomDisplayName() {
            const roomId = document.getElementById('edit-room-id').value;
            const originalName = document.getElementById('edit-room-name').value;
            const roomType = document.getElementById('edit-room-type').value;
            const maxGuests = document.getElementById('edit-room-maxguests').value;
            
            if (!originalName) return alert('No room name to work with');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: 'room_display_name',
                        room_id: roomId,
                        original_name: originalName,
                        room_type: roomType,
                        max_guests: maxGuests
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('edit-room-display-name').value = result.content;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating display name');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generateRoomShortDescription() {
            const roomId = document.getElementById('edit-room-id').value;
            const roomName = document.getElementById('edit-room-name').value;
            const displayName = document.getElementById('edit-room-display-name').value;
            const roomType = document.getElementById('edit-room-type').value;
            const maxGuests = document.getElementById('edit-room-maxguests').value;
            
            if (!roomName) return alert('No room name to work with');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: 'room_short_description',
                        room_id: roomId,
                        room_name: displayName || roomName,
                        room_type: roomType,
                        max_guests: maxGuests
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('edit-room-short-description').value = result.content;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating short description');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generateRoomFullDescription() {
            const roomId = document.getElementById('edit-room-id').value;
            const roomName = document.getElementById('edit-room-name').value;
            const displayName = document.getElementById('edit-room-display-name').value;
            const shortDesc = document.getElementById('edit-room-short-description').value;
            const roomType = document.getElementById('edit-room-type').value;
            const maxGuests = document.getElementById('edit-room-maxguests').value;
            
            if (!roomName) return alert('No room name to work with');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: 'room_full_description',
                        room_id: roomId,
                        room_name: displayName || roomName,
                        short_description: shortDesc,
                        room_type: roomType,
                        max_guests: maxGuests
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('edit-room-full-description').value = result.content;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating full description');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generatePropertyDescription(type) {
            const propertyId = document.getElementById('edit-property-id').value;
            const propertyName = document.getElementById('edit-property-name').value;
            const prompt = document.getElementById('edit-property-ai-prompt').value;
            
            if (!propertyId) return alert('No property selected');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: type === 'short' ? 'property_short' : 'property_description',
                        property_id: propertyId,
                        property_name: propertyName,
                        prompt 
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    if (type === 'short') {
                        document.getElementById('edit-property-short-desc').value = result.content;
                    } else {
                        document.getElementById('edit-property-full-desc').value = result.content;
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating content');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.select();
                document.execCommand('copy');
                
                // Show brief feedback
                const btn = event.target;
                const original = btn.innerHTML;
                btn.innerHTML = '';
                setTimeout(() => btn.innerHTML = original, 1000);
            }
        }

        async function deleteRoom() {
            const id = document.getElementById('edit-room-id').value;
            const name = document.getElementById('edit-room-name').value;
            
            if (!confirm(`Are you sure you want to delete "${name}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/units/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Room deleted successfully!');
                    closeModal('editRoomModal');
                    loadRoomsForProperty();
                    loadDashboard(); // Refresh stats
                } else {
                    alert('Error deleting room: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('Error deleting room');
            }
        }

        // Placeholder functions for other modals
        function openAddRoomModal() {
            alert('Add Room feature coming soon!');
        }

        function openUploadModal() {
            openImageUploadModal();
        }

        // Toggle upsell presets visibility
        function toggleUpsellPresets() {
            const presets = document.getElementById('all-upsell-presets');
            const btn = document.getElementById('toggle-presets-btn');
            
            if (presets.style.display === 'none') {
                presets.style.display = 'block';
                btn.textContent = 'Hide Categories ';
            } else {
                presets.style.display = 'none';
                btn.textContent = 'Show All Categories ';
            }
        }
        
        // Quick add upsell from preset - opens modal pre-filled
        async function quickAddUpsell(name, price, chargeType) {
            // Reset form first
            document.getElementById('upsell-form').reset();
            document.getElementById('upsell-id').value = '';
            document.getElementById('upsell-multi-room').checked = false;
            document.getElementById('upsell-rooms-checkboxes').style.display = 'none';
            document.getElementById('upsell-room').style.display = 'block';
            
            // Pre-fill with preset values
            document.getElementById('upsell-name').value = name;
            document.getElementById('upsell-price').value = price;
            document.getElementById('upsell-charge-type').value = chargeType;
            document.getElementById('upsell-active').checked = true;
            
            // Load properties
            await loadUpsellPropertiesForModal();
            
            // Update modal title to show it's from preset
            document.getElementById('upsell-modal-title').innerHTML = ' Add: ' + name;
            
            openModal('addUpsellModal');
        }

        // Cleanup duplicates
        async function cleanupDuplicates() {
            if (!confirm('This will remove duplicate properties and rooms, keeping only the most recent imports. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/cleanup-duplicates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(' Duplicates removed!\n\nProperties: ' + result.counts.properties + '\nRooms: ' + result.counts.units);
                    loadDashboard();
                    if (document.getElementById('properties').classList.contains('active')) {
                        loadProperties();
                    }
                    if (document.getElementById('rooms').classList.contains('active')) {
                        loadRooms();
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error cleaning up: ' + error.message);
            }
        }

        // =====================================================
        // WEBSITE PAGES FUNCTIONS
        // =====================================================
        
        let currentPageType = 'about';
        
        const pageTemplates = {
            about: {
                title: 'About Us',
                prompts: ['history', 'team', 'values', 'mission']
            },
            contact: {
                title: 'Contact Us',
                prompts: ['location', 'hours', 'directions']
            },
            terms: {
                title: 'Terms & Conditions',
                prompts: ['booking', 'cancellation', 'liability', 'payment']
            },
            privacy: {
                title: 'Privacy Policy',
                prompts: ['data collection', 'cookies', 'GDPR', 'rights']
            }
        };

        async function loadWebsitePage(pageType) {
            currentPageType = pageType;
            document.getElementById('page-type').value = pageType;
            
            // Update tab buttons
            ['about', 'contact', 'terms', 'privacy'].forEach(type => {
                const btn = document.getElementById('page-tab-' + type);
                if (btn) {
                    btn.style.background = type === pageType ? 'var(--accent)' : '#64748b';
                }
            });
            
            // Update AI panel badge
            const badge = document.getElementById('page-ai-badge');
            if (badge) {
                const titles = { about: 'About Us', contact: 'Contact', terms: 'Terms & Conditions', privacy: 'Privacy Policy' };
                badge.textContent = titles[pageType] || pageType;
            }
            
            // Update AI context placeholder based on page type
            const contextInput = document.getElementById('page-ai-context');
            if (contextInput) {
                const placeholders = {
                    about: "Tell us about your property... e.g. 'Victorian B&B in St Louis, family-run since 1995, known for gourmet breakfasts'",
                    contact: "Your business details... e.g. 'Open 7 days, check-in from 3pm, located downtown near metro'",
                    terms: "Your booking policies... e.g. '48-hour cancellation, no smoking, pets welcome with fee, 18+ only'",
                    privacy: "Your data practices... e.g. 'We collect booking info, use Stripe for payments, based in USA'"
                };
                contextInput.placeholder = placeholders[pageType] || placeholders.about;
            }
            
            try {
                const response = await fetch(`/api/admin/pages/${pageType}?client_id=${getClientId()}`);
                const data = await response.json();
                
                if (data.success && data.page) {
                    document.getElementById('page-title').value = data.page.title || '';
                    document.getElementById('page-subtitle').value = data.page.subtitle || '';
                    document.getElementById('page-content').value = data.page.content || '';
                    document.getElementById('page-meta-title').value = data.page.meta_title || '';
                    document.getElementById('page-meta-description').value = data.page.meta_description || '';
                    document.getElementById('page-published').checked = data.page.is_published;
                    document.getElementById('page-faq-schema').value = data.page.faq_schema || '';
                    updateMetaCount();
                    updateFAQPreview();
                } else {
                    // Clear form for new page
                    const defaultTitles = { about: 'About Us', contact: 'Contact Us', terms: 'Terms & Conditions', privacy: 'Privacy Policy' };
                    document.getElementById('page-title').value = defaultTitles[pageType] || '';
                    document.getElementById('page-subtitle').value = '';
                    document.getElementById('page-content').value = '';
                    document.getElementById('page-meta-title').value = '';
                    document.getElementById('page-meta-description').value = '';
                    document.getElementById('page-published').checked = false;
                    document.getElementById('page-faq-schema').value = '';
                    updateMetaCount();
                    document.getElementById('faq-schema-preview').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading page:', error);
            }
        }
        
        function updateMetaCount() {
            const title = document.getElementById('page-meta-title').value;
            const desc = document.getElementById('page-meta-description').value;
            
            const titleCount = document.getElementById('meta-title-count');
            const descCount = document.getElementById('meta-desc-count');
            
            if (titleCount) {
                titleCount.textContent = `(${title.length}/60)`;
                titleCount.style.color = title.length > 60 ? '#ef4444' : title.length > 50 ? '#f59e0b' : 'var(--text-muted)';
            }
            if (descCount) {
                descCount.textContent = `(${desc.length}/160)`;
                descCount.style.color = desc.length > 160 ? '#ef4444' : desc.length > 150 ? '#f59e0b' : 'var(--text-muted)';
            }
        }
        
        function updateFAQPreview() {
            const schemaText = document.getElementById('page-faq-schema').value;
            const preview = document.getElementById('faq-schema-preview');
            const list = document.getElementById('faq-items-list');
            
            if (!schemaText || schemaText.trim() === '') {
                preview.style.display = 'none';
                return;
            }
            
            try {
                const faqs = JSON.parse(schemaText);
                if (Array.isArray(faqs) && faqs.length > 0) {
                    list.innerHTML = faqs.map((faq, i) => `
                        <div style="padding: 0.5rem 0; ${i > 0 ? 'border-top: 1px solid #e2e8f0;' : ''}">
                            <div style="font-weight: 600; font-size: 0.85rem; color: #1e293b;">Q: ${faq.question}</div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">A: ${faq.answer?.substring(0, 100)}${faq.answer?.length > 100 ? '...' : ''}</div>
                        </div>
                    `).join('');
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            } catch (e) {
                preview.style.display = 'none';
            }
        }
        
        async function generatePageContent() {
            const context = document.getElementById('page-ai-context').value;
            const businessName = document.getElementById('contact-business-name')?.value || 'Our Property';
            const statusEl = document.getElementById('page-ai-status');
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = ' Generating content...';
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        type: 'page_content',
                        page_type: currentPageType,
                        context: context,
                        business_name: businessName
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.content) {
                    document.getElementById('page-content').value = data.content;
                    if (data.title) document.getElementById('page-title').value = data.title;
                    if (data.subtitle) document.getElementById('page-subtitle').value = data.subtitle;
                    statusEl.innerHTML = ' Content generated! Review and edit as needed.';
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
            } catch (error) {
                console.error('Error generating content:', error);
                statusEl.innerHTML = ' Error generating content. Using template instead...';
                
                // Fallback to local templates
                setTimeout(() => {
                    const template = getPageTemplate(currentPageType, context, businessName);
                    document.getElementById('page-content').value = template;
                    statusEl.innerHTML = ' Template applied! Customize it for your property.';
                }, 500);
            }
            
            setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
        }
        
        function getPageTemplate(pageType, context, businessName) {
            const templates = {
                about: `<h2>Welcome to ${businessName}</h2>
<p>${context || 'We are delighted to welcome you to our property. Our commitment to exceptional hospitality ensures every guest enjoys a memorable stay.'}</p>

<h2>Our Story</h2>
<p>Founded with a passion for hospitality, ${businessName} has been providing comfortable accommodations and warm service to travelers from around the world.</p>

<h2>What Makes Us Special</h2>
<ul>
    <li><strong>Prime Location</strong> - Perfectly situated for exploring the local area</li>
    <li><strong>Comfortable Rooms</strong> - Thoughtfully designed for your relaxation</li>
    <li><strong>Personal Service</strong> - Our team is dedicated to making your stay exceptional</li>
    <li><strong>Local Experience</strong> - We love sharing our knowledge of the area</li>
</ul>

<h2>Our Commitment</h2>
<p>We believe that great hospitality is about the details. From the moment you arrive until you check out, our goal is to exceed your expectations and create lasting memories.</p>`,

                contact: `<h2>Get in Touch</h2>
<p>We'd love to hear from you! Whether you have questions about your booking, need recommendations for local attractions, or want to arrange a special request, our team is here to help.</p>

<h2>Contact Information</h2>
<p>Feel free to reach out through any of the following channels:</p>

<h2>Before Your Arrival</h2>
<p>If you have any special requests or need to communicate arrival details, please don't hesitate to contact us. We're happy to help with:</p>
<ul>
    <li>Early check-in or late check-out requests</li>
    <li>Special occasion arrangements</li>
    <li>Dietary requirements</li>
    <li>Transportation assistance</li>
    <li>Local recommendations</li>
</ul>

<h2>During Your Stay</h2>
<p>Our team is available to assist you with anything you need during your stay. Just ask!</p>`,

                terms: `<h2>Booking Terms & Conditions</h2>
<p>Please read these terms carefully before making a reservation at ${businessName}. By completing a booking, you agree to these terms and conditions.</p>

<h2>Reservations & Payment</h2>
<p>A valid credit card is required to secure your reservation. Payment terms vary by rate type:</p>
<ul>
    <li><strong>Standard Rate:</strong> Full payment due at check-in</li>
    <li><strong>Non-Refundable Rate:</strong> Full payment charged at time of booking</li>
    <li><strong>Deposit Required:</strong> Partial payment at booking, balance due at check-in</li>
</ul>

<h2>Cancellation Policy</h2>
<p>Our standard cancellation policy is as follows:</p>
<ul>
    <li>Free cancellation up to 48 hours before check-in</li>
    <li>Cancellations within 48 hours: First night charged</li>
    <li>No-shows: Full stay charged</li>
    <li>Non-refundable bookings: No refunds for any cancellation</li>
</ul>

<h2>Check-in & Check-out</h2>
<ul>
    <li><strong>Check-in:</strong> From 3:00 PM</li>
    <li><strong>Check-out:</strong> By 11:00 AM</li>
    <li>Early check-in and late check-out available upon request (subject to availability)</li>
</ul>

<h2>House Rules</h2>
<ul>
    <li>No smoking on the premises</li>
    <li>Quiet hours: 10:00 PM - 8:00 AM</li>
    <li>Pets policy: Please contact us for pet-friendly options</li>
    <li>Additional guests must be registered at check-in</li>
</ul>

<h2>Liability</h2>
<p>${businessName} is not responsible for loss or damage to guests' personal belongings. Valuables should be secured in provided safes where available.</p>

<h2>Damages</h2>
<p>Guests are responsible for any damage caused to the property during their stay. Costs for repairs or replacement will be charged to the card on file.</p>`,

                privacy: `<h2>Privacy Policy</h2>
<p>At ${businessName}, we are committed to protecting your privacy and personal data. This policy explains how we collect, use, and safeguard your information.</p>

<h2>Information We Collect</h2>
<p>We collect information necessary to provide our services:</p>
<ul>
    <li><strong>Booking Information:</strong> Name, email, phone, address</li>
    <li><strong>Payment Details:</strong> Processed securely through our payment provider</li>
    <li><strong>Stay Preferences:</strong> Special requests, dietary requirements</li>
    <li><strong>Communication Records:</strong> Emails and messages exchanged with us</li>
</ul>

<h2>How We Use Your Information</h2>
<ul>
    <li>Process and manage your booking</li>
    <li>Communicate about your reservation</li>
    <li>Improve our services</li>
    <li>Send marketing communications (with your consent)</li>
    <li>Comply with legal obligations</li>
</ul>

<h2>Data Protection (GDPR)</h2>
<p>If you are in the European Economic Area, you have rights under GDPR including:</p>
<ul>
    <li><strong>Right to Access:</strong> Request a copy of your personal data</li>
    <li><strong>Right to Rectification:</strong> Correct inaccurate data</li>
    <li><strong>Right to Erasure:</strong> Request deletion of your data</li>
    <li><strong>Right to Portability:</strong> Receive your data in a portable format</li>
    <li><strong>Right to Object:</strong> Object to processing of your data</li>
</ul>

<h2>Cookies</h2>
<p>Our website uses cookies to improve your experience:</p>
<ul>
    <li><strong>Essential Cookies:</strong> Required for the website to function</li>
    <li><strong>Analytics Cookies:</strong> Help us understand how visitors use our site</li>
    <li><strong>Marketing Cookies:</strong> Used to deliver relevant advertisements</li>
</ul>

<h2>Data Security</h2>
<p>We implement appropriate security measures to protect your personal information against unauthorized access, alteration, or destruction.</p>

<h2>Third-Party Services</h2>
<p>We may share data with trusted partners who assist in operating our business:</p>
<ul>
    <li>Payment processors</li>
    <li>Booking platforms</li>
    <li>Email service providers</li>
</ul>

<h2>Contact Us</h2>
<p>For any privacy-related questions or to exercise your rights, please contact us.</p>

<h2>Updates to This Policy</h2>
<p>We may update this policy periodically. The latest version will always be available on our website.</p>

<p><em>Last updated: ${new Date().toLocaleDateString()}</em></p>`
            };
            
            return templates[pageType] || templates.about;
        }
        
        async function generatePageSEO() {
            const content = document.getElementById('page-content').value;
            const title = document.getElementById('page-title').value;
            const businessName = document.getElementById('contact-business-name')?.value || '';
            const statusEl = document.getElementById('page-ai-status');
            
            if (!content) {
                alert('Please add some content first, then generate SEO.');
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = ' Generating SEO suggestions...';
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        type: 'seo',
                        page_type: currentPageType,
                        content: content.substring(0, 2000),
                        title: title,
                        business_name: businessName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.meta_title) document.getElementById('page-meta-title').value = data.meta_title;
                    if (data.meta_description) document.getElementById('page-meta-description').value = data.meta_description;
                    updateMetaCount();
                    statusEl.innerHTML = ' SEO generated!';
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
            } catch (error) {
                console.error('Error generating SEO:', error);
                // Fallback to basic SEO generation
                const seo = generateBasicSEO(currentPageType, title, businessName);
                document.getElementById('page-meta-title').value = seo.title;
                document.getElementById('page-meta-description').value = seo.description;
                updateMetaCount();
                statusEl.innerHTML = ' SEO suggestions applied!';
            }
            
            setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
        }
        
        function generateBasicSEO(pageType, title, businessName) {
            const seoTemplates = {
                about: {
                    title: `About ${businessName || 'Us'} | Our Story & Values`,
                    description: `Learn about ${businessName || 'our property'}, our history, and what makes us special. Discover why guests choose us for their stay.`
                },
                contact: {
                    title: `Contact ${businessName || 'Us'} | Get in Touch`,
                    description: `Contact ${businessName || 'us'} for bookings, inquiries, or assistance. Find our address, phone number, email, and hours of operation.`
                },
                terms: {
                    title: `Terms & Conditions | ${businessName || 'Booking Policies'}`,
                    description: `Read our terms and conditions including booking policies, cancellation rules, check-in/out times, and house rules at ${businessName || 'our property'}.`
                },
                privacy: {
                    title: `Privacy Policy | ${businessName || 'Data Protection'}`,
                    description: `Our privacy policy explains how ${businessName || 'we'} collect, use, and protect your personal data. GDPR compliant.`
                }
            };
            
            return seoTemplates[pageType] || seoTemplates.about;
        }
        
        function generatePageFAQSchema() {
            const content = document.getElementById('page-content').value;
            const statusEl = document.getElementById('page-ai-status');
            
            if (!content) {
                alert('Please add content with headers (h2, h3) first.');
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = ' Extracting FAQ schema from headers...';
            
            // Parse headers and their following content
            const faqs = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            const headers = tempDiv.querySelectorAll('h2, h3');
            headers.forEach(header => {
                const question = header.textContent.trim();
                if (!question) return;
                
                // Get content until next header
                let answer = '';
                let sibling = header.nextElementSibling;
                while (sibling && !['H1', 'H2', 'H3', 'H4'].includes(sibling.tagName)) {
                    answer += sibling.textContent.trim() + ' ';
                    sibling = sibling.nextElementSibling;
                }
                
                answer = answer.trim();
                if (answer && answer.length > 20) {
                    // Convert header to question format if not already
                    let q = question;
                    if (!q.endsWith('?')) {
                        q = 'What is ' + q.toLowerCase().replace(/^(our |the |about )/i, '') + '?';
                    }
                    
                    faqs.push({
                        question: q.charAt(0).toUpperCase() + q.slice(1),
                        answer: answer.substring(0, 500) + (answer.length > 500 ? '...' : '')
                    });
                }
            });
            
            if (faqs.length > 0) {
                document.getElementById('page-faq-schema').value = JSON.stringify(faqs, null, 2);
                updateFAQPreview();
                statusEl.innerHTML = ` Generated ${faqs.length} FAQ items from headers!`;
            } else {
                statusEl.innerHTML = ' No headers found. Add &lt;h2&gt; or &lt;h3&gt; tags to your content.';
            }
            
            setTimeout(() => { statusEl.style.display = 'none'; }, 4000);
        }
        
        function previewPageContent() {
            const content = document.getElementById('page-content').value;
            const title = document.getElementById('page-title').value;
            
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title} - Preview</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; color: #1e293b; }
                        h1 { color: #6366f1; border-bottom: 2px solid #6366f1; padding-bottom: 10px; }
                        h2 { color: #1e293b; margin-top: 30px; }
                        ul { padding-left: 20px; }
                        li { margin-bottom: 8px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    ${content}
                </body>
                </html>
            `);
            previewWindow.document.close();
        }

        async function saveWebsitePage() {
            const pageData = {
                client_id: getClientId(),
                page_type: currentPageType,
                slug: currentPageType,
                title: document.getElementById('page-title').value,
                subtitle: document.getElementById('page-subtitle').value,
                content: document.getElementById('page-content').value,
                meta_title: document.getElementById('page-meta-title').value,
                meta_description: document.getElementById('page-meta-description').value,
                faq_schema: document.getElementById('page-faq-schema').value,
                is_published: document.getElementById('page-published').checked
            };
            
            try {
                const response = await fetch('/api/admin/pages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(pageData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Page saved successfully!');
                } else {
                    alert('Error saving page: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving page:', error);
                alert('Error saving page');
            }
        }

        async function loadContactInfo() {
            try {
                const response = await fetch(`/api/admin/contact-info?client_id=${getClientId()}`);
                const data = await response.json();
                
                if (data.success && data.contact) {
                    const c = data.contact;
                    // Basic info
                    document.getElementById('contact-business-name').value = c.business_name || '';
                    document.getElementById('contact-tagline').value = c.tagline || '';
                    document.getElementById('contact-email').value = c.email || '';
                    document.getElementById('contact-phone').value = c.phone || '';
                    
                    // Optional fields with null checks
                    const phoneSecondary = document.getElementById('contact-phone-secondary');
                    if (phoneSecondary) phoneSecondary.value = c.phone_secondary || '';
                    
                    const whatsapp = document.getElementById('contact-whatsapp');
                    if (whatsapp) whatsapp.value = c.whatsapp || '';
                    
                    // Address fields
                    const addr1 = document.getElementById('contact-address1');
                    if (addr1) addr1.value = c.address_line1 || '';
                    
                    const addr2 = document.getElementById('contact-address2');
                    if (addr2) addr2.value = c.address_line2 || '';
                    
                    const city = document.getElementById('contact-city');
                    if (city) city.value = c.city || '';
                    
                    const state = document.getElementById('contact-state');
                    if (state) state.value = c.state_province || '';
                    
                    const postal = document.getElementById('contact-postal');
                    if (postal) postal.value = c.postal_code || '';
                    
                    const country = document.getElementById('contact-country');
                    if (country) country.value = normalizeCountryCode(c.country) || '';
                    
                    // Social media
                    document.getElementById('contact-facebook').value = c.facebook_url || '';
                    document.getElementById('contact-instagram').value = c.instagram_url || '';
                    document.getElementById('contact-twitter').value = c.twitter_url || '';
                    
                    const linkedin = document.getElementById('contact-linkedin');
                    if (linkedin) linkedin.value = c.linkedin_url || '';
                    
                    const youtube = document.getElementById('contact-youtube');
                    if (youtube) youtube.value = c.youtube_url || '';
                    
                    const tripadvisor = document.getElementById('contact-tripadvisor');
                    if (tripadvisor) tripadvisor.value = c.tripadvisor_url || '';
                    
                    // Map fields
                    const mapsUrl = document.getElementById('contact-maps-url');
                    if (mapsUrl) mapsUrl.value = c.google_maps_url || '';
                    
                    const placeId = document.getElementById('contact-place-id');
                    if (placeId) placeId.value = c.google_place_id || '';
                    
                    const lat = document.getElementById('contact-latitude');
                    if (lat) lat.value = c.latitude || '';
                    
                    const lng = document.getElementById('contact-longitude');
                    if (lng) lng.value = c.longitude || '';
                }
            } catch (error) {
                console.error('Error loading contact info:', error);
            }
        }

        async function saveContactInfo() {
            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };
            
            const contactData = {
                client_id: getClientId(),
                business_name: getVal('contact-business-name'),
                tagline: getVal('contact-tagline'),
                email: getVal('contact-email'),
                phone: getVal('contact-phone'),
                phone_secondary: getVal('contact-phone-secondary'),
                whatsapp: getVal('contact-whatsapp'),
                address_line1: getVal('contact-address1'),
                address_line2: getVal('contact-address2'),
                city: getVal('contact-city'),
                state_province: getVal('contact-state'),
                postal_code: getVal('contact-postal'),
                country: getVal('contact-country'),
                facebook_url: getVal('contact-facebook'),
                instagram_url: getVal('contact-instagram'),
                twitter_url: getVal('contact-twitter'),
                linkedin_url: getVal('contact-linkedin'),
                youtube_url: getVal('contact-youtube'),
                tripadvisor_url: getVal('contact-tripadvisor'),
                google_maps_url: getVal('contact-maps-url'),
                google_place_id: getVal('contact-place-id'),
                latitude: getVal('contact-latitude') || null,
                longitude: getVal('contact-longitude') || null
            };
            
            try {
                const response = await fetch('/api/admin/contact-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(contactData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Contact info saved successfully!');
                } else {
                    alert('Error saving contact info: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving contact info:', error);
                alert('Error saving contact info');
            }
        }

        // =====================================================
        // BLOG FUNCTIONS
        // =====================================================

        async function loadBlogPosts() {
            try {
                const response = await fetch(`/api/admin/blog?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('blog-posts-list');
                
                if (data.success && data.posts && data.posts.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.posts.map(post => `
                                    <tr>
                                        <td><strong>${post.title}</strong></td>
                                        <td>${post.category || '-'}</td>
                                        <td><span class="badge ${post.is_published ? 'badge-success' : 'badge-secondary'}">${post.is_published ? 'Published' : 'Draft'}</span></td>
                                        <td>${post.published_at ? new Date(post.published_at).toLocaleDateString() : '-'}</td>
                                        <td>
                                            <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editBlogPost(${post.id})">Edit</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <p>No blog posts yet</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openBlogModal()">Create Your First Post</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading blog posts:', error);
            }
        }

        async function openBlogModal(post = null) {
            document.getElementById('blog-form').reset();
            document.getElementById('blog-id').value = '';
            document.getElementById('blog-delete-btn').style.display = 'none';
            document.getElementById('blog-image-preview').innerHTML = '';
            
            // Populate property dropdown in modal
            await populatePropertySelect('blog-property-id');
            
            // Load categories for the dropdown
            await loadBlogCategoriesForModal();
            
            // Pre-select property from filter if set
            const filterProperty = document.getElementById('blog-property-select')?.value;
            if (filterProperty && !post) {
                document.getElementById('blog-property-id').value = filterProperty;
            }
            
            if (post) {
                document.getElementById('blog-modal-title').textContent = ' Edit Blog Post';
                document.getElementById('blog-id').value = post.id;
                document.getElementById('blog-property-id').value = post.property_id || '';
                document.getElementById('blog-title').value = post.title || '';
                document.getElementById('blog-slug').value = post.slug || '';
                document.getElementById('blog-excerpt').value = post.excerpt || '';
                document.getElementById('blog-content').value = post.content || '';
                document.getElementById('blog-featured-image').value = post.featured_image_url || '';
                document.getElementById('blog-category').value = post.category || '';
                document.getElementById('blog-author').value = post.author_name || '';
                document.getElementById('blog-read-time').value = post.read_time_minutes || '';
                document.getElementById('blog-published').checked = post.is_published;
                document.getElementById('blog-meta-title').value = post.meta_title || '';
                document.getElementById('blog-meta-description').value = post.meta_description || '';
                document.getElementById('blog-delete-btn').style.display = 'block';
                
                if (post.featured_image_url) {
                    document.getElementById('blog-image-preview').innerHTML = `<img src="${post.featured_image_url}" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px;">`;
                }
            } else {
                document.getElementById('blog-modal-title').textContent = ' New Blog Post';
            }
            
            openModal('blogModal');
        }
        
        // Load blog categories for the Edit Blog Post modal
        async function loadBlogCategoriesForModal(selectedCategory = null) {
            try {
                const select = document.getElementById('blog-category');
                if (!select) return;
                
                const response = await fetch('/api/admin/blog-categories?client_id=' + currentClientId);
                const data = await response.json();
                
                select.innerHTML = '<option value="">Select category...</option>';
                
                if (data.success && data.categories && data.categories.length > 0) {
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.name;
                        option.textContent = cat.name;
                        if (selectedCategory && cat.name === selectedCategory) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load blog categories:', error);
            }
        }
        
        // Show modal to add a new blog category
        function showAddCategoryModal() {
            const modalHtml = `
                <div id="add-category-modal" class="modal" style="display: flex;" onclick="if(event.target === this) this.remove()">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <h2 style="color: white; margin: 0;"> Add New Category</h2>
                            <button class="modal-close" onclick="document.getElementById('add-category-modal').remove()" style="color: white;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">Category Name *</label>
                                <input type="text" class="form-input" id="new-category-name" placeholder="e.g., Local Events">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description (optional)</label>
                                <input type="text" class="form-input" id="new-category-description" placeholder="Brief description...">
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 0.5rem; padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb;">
                            <button class="btn btn-secondary" onclick="document.getElementById('add-category-modal').remove()">Cancel</button>
                            <button class="btn" onclick="saveNewCategory()" style="background: #10b981;">Save Category</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('new-category-name').focus();
        }
        
        // Save new blog category
        async function saveNewCategory() {
            const name = document.getElementById('new-category-name').value.trim();
            const description = document.getElementById('new-category-description').value.trim();
            
            if (!name) {
                showNotification('Please enter a category name', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/blog-categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: currentClientId,
                        name: name,
                        description: description
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Category created successfully', 'success');
                    document.getElementById('add-category-modal').remove();
                    
                    // Reload categories and select the new one
                    await loadBlogCategoriesForModal(name);
                    await loadBlogCategories(); // Also update AI blog generator if open
                    
                    // Select the new category in the dropdown
                    document.getElementById('blog-category').value = name;
                } else {
                    showNotification(data.error || 'Failed to create category', 'error');
                }
            } catch (error) {
                showNotification('Error creating category: ' + error.message, 'error');
            }
        }

        async function editBlogPost(id) {
            try {
                const response = await fetch(`/api/admin/blog/${id}`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success && data.post) {
                    openBlogModal(data.post);
                } else {
                    showNotification('Could not load blog post', 'error');
                }
            } catch (error) {
                console.error('Error loading blog post:', error);
                showNotification('Error loading blog post', 'error');
            }
        }

        async function saveBlogPost() {
            const id = document.getElementById('blog-id').value;
            const propertyId = document.getElementById('blog-property-id').value;
            const title = document.getElementById('blog-title').value.trim();
            const content = document.getElementById('blog-content').value.trim();
            
            if (!propertyId) {
                showNotification('Please select a property', 'error');
                return;
            }
            
            if (!title || !content) {
                showNotification('Title and content are required', 'error');
                return;
            }
            
            const postData = {
                property_id: parseInt(propertyId),
                title: title,
                slug: document.getElementById('blog-slug').value.trim() || null,
                excerpt: document.getElementById('blog-excerpt').value.trim(),
                content: content,
                featured_image_url: document.getElementById('blog-featured-image').value.trim(),
                category: document.getElementById('blog-category').value,
                author_name: document.getElementById('blog-author').value.trim(),
                read_time_minutes: parseInt(document.getElementById('blog-read-time').value) || null,
                is_published: document.getElementById('blog-published').checked,
                meta_title: document.getElementById('blog-meta-title').value.trim(),
                meta_description: document.getElementById('blog-meta-description').value.trim(),
                client_id: getClientId()
            };
            
            try {
                const url = id ? `/api/admin/blog/${id}` : '/api/admin/blog';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(postData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(id ? 'Blog post updated!' : 'Blog post created!', 'success');
                    closeModal('blogModal');
                    loadBlogByTab();
                } else {
                    showNotification('Error: ' + (data.error || 'Could not save'), 'error');
                }
            } catch (error) {
                console.error('Error saving blog post:', error);
                showNotification('Error saving blog post', 'error');
            }
        }

        async function deleteBlogPost() {
            const id = document.getElementById('blog-id').value;
            if (!id) return;
            
            if (!confirm('Are you sure you want to delete this blog post?')) return;
            
            try {
                const response = await fetch(`/api/admin/blog/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Blog post deleted', 'success');
                    closeModal('blogModal');
                    loadBlogByTab();
                } else {
                    showNotification('Error: ' + (data.error || 'Could not delete'), 'error');
                }
            } catch (error) {
                console.error('Error deleting blog post:', error);
                showNotification('Error deleting blog post', 'error');
            }
        }

        function formatBlogText(format) {
            const textarea = document.getElementById('blog-content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selected = text.substring(start, end);
            
            let replacement = '';
            switch (format) {
                case 'bold':
                    replacement = `<strong>${selected || 'bold text'}</strong>`;
                    break;
                case 'italic':
                    replacement = `<em>${selected || 'italic text'}</em>`;
                    break;
                case 'h2':
                    replacement = `\n<h2>${selected || 'Heading'}</h2>\n`;
                    break;
                case 'h3':
                    replacement = `\n<h3>${selected || 'Subheading'}</h3>\n`;
                    break;
                case 'ul':
                    replacement = `\n<ul>\n  <li>${selected || 'List item'}</li>\n</ul>\n`;
                    break;
                case 'link':
                    const url = prompt('Enter URL:', 'https://');
                    if (url) {
                        replacement = `<a href="${url}">${selected || 'Link text'}</a>`;
                    } else {
                        return;
                    }
                    break;
            }
            
            textarea.value = text.substring(0, start) + replacement + text.substring(end);
            textarea.focus();
        }

        // =====================================================
        // ATTRACTIONS FUNCTIONS
        // =====================================================

        async function loadAttractions() {
            try {
                const response = await fetch(`/api/admin/attractions?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('attractions-list');
                
                if (data.success && data.attractions && data.attractions.length > 0) {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                            ${data.attractions.map(attr => `
                                <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="editAttraction(${attr.id})">
                                    ${attr.featured_image_url ? 
                                        `<img src="${attr.featured_image_url}" style="width: 100%; height: 150px; object-fit: cover;">` :
                                        `<div style="width: 100%; height: 150px; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; font-size: 3rem;"></div>`
                                    }
                                    <div style="padding: 1rem;">
                                        <h4 style="margin: 0 0 0.5rem;">${attr.name}</h4>
                                        <p style="color: #64748b; font-size: 0.85rem; margin: 0;">
                                            ${attr.category ? ` ${attr.category}` : ''}
                                            ${attr.distance_text ? `  ${attr.distance_text}` : ''}
                                        </p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                            <p>No attractions added yet</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openAttractionModal()">Add Your First Attraction</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading attractions:', error);
            }
        }

        async function openAttractionModal(attraction = null) {
            document.getElementById('attraction-form').reset();
            document.getElementById('attraction-id').value = '';
            document.getElementById('attraction-delete-btn').style.display = 'none';
            document.getElementById('attraction-published').checked = false; // Default to draft for new attractions
            
            // Populate property dropdown in modal
            await populatePropertySelect('attraction-property-id');
            
            // Pre-select property from filter if set
            const filterProperty = document.getElementById('attractions-property-select')?.value;
            if (filterProperty && !attraction) {
                document.getElementById('attraction-property-id').value = filterProperty;
            }
            
            if (attraction) {
                document.getElementById('attraction-modal-title').textContent = ' Edit Attraction';
                document.getElementById('attraction-id').value = attraction.id;
                document.getElementById('attraction-property-id').value = attraction.property_id || '';
                document.getElementById('attraction-name').value = attraction.name || '';
                document.getElementById('attraction-slug').value = attraction.slug || '';
                document.getElementById('attraction-category').value = attraction.category || '';
                document.getElementById('attraction-distance').value = attraction.distance_text || '';
                document.getElementById('attraction-short-desc').value = attraction.short_description || '';
                document.getElementById('attraction-description').value = attraction.description || '';
                document.getElementById('attraction-image').value = attraction.featured_image_url || '';
                document.getElementById('attraction-website').value = attraction.website_url || '';
                document.getElementById('attraction-address').value = attraction.address || '';
                document.getElementById('attraction-maps-url').value = attraction.google_maps_url || '';
                document.getElementById('attraction-price').value = attraction.price_range || '';
                document.getElementById('attraction-duration').value = attraction.duration || '';
                document.getElementById('attraction-order').value = attraction.display_order || 0;
                document.getElementById('attraction-published').value = attraction.is_published ? 'true' : 'false';
                document.getElementById('attraction-meta-title').value = attraction.meta_title || '';
                document.getElementById('attraction-meta-description').value = attraction.meta_description || '';
                
                // Handle schedule
                if (attraction.scheduled_at) {
                    const schedDate = new Date(attraction.scheduled_at);
                    document.getElementById('attraction-schedule').checked = true;
                    document.getElementById('attraction-schedule-date').value = schedDate.toISOString().split('T')[0];
                    document.getElementById('attraction-schedule-time').value = schedDate.toTimeString().slice(0, 5);
                    document.getElementById('attraction-schedule-options').style.display = 'block';
                } else {
                    document.getElementById('attraction-schedule').checked = false;
                    document.getElementById('attraction-schedule-options').style.display = 'none';
                }
                
                document.getElementById('attraction-delete-btn').style.display = 'block';
            } else {
                document.getElementById('attraction-modal-title').textContent = ' Add Attraction';
                document.getElementById('attraction-schedule').checked = false;
                document.getElementById('attraction-schedule-options').style.display = 'none';
            }
            
            openModal('attractionModal');
        }

        async function editAttraction(id) {
            try {
                const response = await fetch(`/api/admin/attractions/${id}`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success && data.attraction) {
                    openAttractionModal(data.attraction);
                } else {
                    showNotification('Could not load attraction', 'error');
                }
            } catch (error) {
                console.error('Error loading attraction:', error);
                showNotification('Error loading attraction', 'error');
            }
        }

        async function saveAttraction(shouldPublish = false) {
            const id = document.getElementById('attraction-id').value;
            const propertyId = document.getElementById('attraction-property-id').value;
            const name = document.getElementById('attraction-name').value.trim();
            const category = document.getElementById('attraction-category').value;
            const shortDesc = document.getElementById('attraction-short-desc').value.trim();
            const distance = document.getElementById('attraction-distance').value.trim();
            
            if (!propertyId) {
                showNotification('Please select a property', 'error');
                return;
            }
            
            if (!name || !category || !shortDesc || !distance) {
                showNotification('Name, category, short description and distance are required', 'error');
                return;
            }
            
            // Parse FAQ schema if present
            let faqSchema = null;
            const faqSchemaText = document.getElementById('attraction-faq-schema')?.value || '';
            if (faqSchemaText && !faqSchemaText.includes('Generated by AI')) {
                try {
                    // Extract JSON from script tags
                    const jsonMatch = faqSchemaText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        faqSchema = JSON.parse(jsonMatch[0]);
                    }
                } catch (e) {
                    console.log('Could not parse FAQ schema');
                }
            }
            
            // Handle scheduling
            let scheduledAt = null;
            const isScheduled = document.getElementById('attraction-schedule')?.checked;
            if (isScheduled && !shouldPublish) {
                const schedDate = document.getElementById('attraction-schedule-date').value;
                const schedTime = document.getElementById('attraction-schedule-time').value || '09:00';
                if (schedDate) {
                    scheduledAt = new Date(`${schedDate}T${schedTime}`).toISOString();
                }
            }
            
            const attractionData = {
                property_id: parseInt(propertyId),
                name: name,
                slug: document.getElementById('attraction-slug').value.trim() || null,
                category: category,
                distance_text: distance,
                short_description: shortDesc,
                description: document.getElementById('attraction-description').value.trim(),
                featured_image_url: document.getElementById('attraction-image').value.trim(),
                website_url: document.getElementById('attraction-website').value.trim(),
                address: document.getElementById('attraction-address').value.trim(),
                google_maps_url: document.getElementById('attraction-maps-url').value.trim(),
                price_range: document.getElementById('attraction-price').value,
                duration: document.getElementById('attraction-duration').value.trim(),
                display_order: parseInt(document.getElementById('attraction-order').value) || 0,
                is_published: shouldPublish,
                scheduled_at: scheduledAt,
                meta_title: document.getElementById('attraction-meta-title').value.trim(),
                meta_description: document.getElementById('attraction-meta-description').value.trim(),
                faq_schema: faqSchema,
                client_id: getClientId()
            };
            
            try {
                const url = id ? `/api/admin/attractions/${id}` : '/api/admin/attractions';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(attractionData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Mark content idea as used if this came from Ideas
                    const contentIdeaId = document.getElementById('attraction-content-idea-id')?.value;
                    if (contentIdeaId) {
                        try {
                            await fetch(`/api/admin/content-ideas/${contentIdeaId}/status`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                                body: JSON.stringify({ status: 'used' })
                            });
                        } catch (e) {
                            console.log('Could not mark idea as used');
                        }
                    }
                    
                    let message = id ? 'Attraction updated!' : 'Attraction created!';
                    if (shouldPublish) {
                        message = 'Attraction published!';
                    } else if (scheduledAt) {
                        message = 'Attraction scheduled!';
                    } else {
                        message = id ? 'Draft updated!' : 'Saved as draft!';
                    }
                    showNotification(message, 'success');
                    closeModal('attractionModal');
                    loadAttractionsByTab();
                } else {
                    showNotification('Error: ' + (data.error || 'Could not save'), 'error');
                }
            } catch (error) {
                console.error('Error saving attraction:', error);
                showNotification('Error saving attraction', 'error');
            }
        }

        async function deleteAttraction() {
            const id = document.getElementById('attraction-id').value;
            if (!id) return;
            
            if (!confirm('Are you sure you want to delete this attraction?')) return;
            
            try {
                const response = await fetch(`/api/admin/attractions/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Attraction deleted', 'success');
                    closeModal('attractionModal');
                    loadAttractionsByTab();
                } else {
                    showNotification('Error: ' + (data.error || 'Could not delete'), 'error');
                }
            } catch (error) {
                console.error('Error deleting attraction:', error);
                showNotification('Error deleting attraction', 'error');
            }
        }
        
        // Save as Draft wrapper
        async function saveAttractionAsDraft() {
            await saveAttraction(false);
        }
        
        // Publish wrapper
        async function saveAttractionAndPublish() {
            await saveAttraction(true);
        }
        
        // Toggle schedule options visibility
        function toggleAttractionSchedule() {
            const isChecked = document.getElementById('attraction-schedule').checked;
            const optionsDiv = document.getElementById('attraction-schedule-options');
            optionsDiv.style.display = isChecked ? 'block' : 'none';
            
            // Set default date to tomorrow if not set
            if (isChecked && !document.getElementById('attraction-schedule-date').value) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('attraction-schedule-date').value = tomorrow.toISOString().split('T')[0];
            }
        }
        
        // Upload attraction image
        async function uploadAttractionImage(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const formData = new FormData();
            formData.append('image', file);
            
            showNotification('Uploading image...', 'info');
            
            try {
                const response = await fetch('/api/admin/upload-image', {
                    method: 'POST',
                    headers: authHeaders(),
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && data.url) {
                    document.getElementById('attraction-image').value = data.url;
                    showNotification('Image uploaded!', 'success');
                } else {
                    showNotification('Upload failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Error uploading image', 'error');
            }
        }

        // =====================================================
        // REVIEWS FUNCTIONS
        // =====================================================

        function openReviewModal() {
            alert('Reviews modal coming soon! The API endpoints will be at /api/admin/reviews');
        }

        // =====================================================
        // BLOG APP FUNCTIONS (with Ideas, Drafts, Scheduled, Published tabs)
        // =====================================================
        
        let blogIdeas = [];
        let blogPosts = { drafts: [], scheduled: [], published: [] };
        let currentBlogTab = 'ideas';
        let selectedBlogCategory = '';
        let selectedBlogSubcategory = '';
        
        function switchBlogTab(tab) {
            currentBlogTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.blog-tab').forEach(t => {
                if (t.dataset.tab === tab) {
                    t.style.color = '#8b5cf6';
                    t.style.borderBottom = '2px solid #8b5cf6';
                    t.style.fontWeight = '600';
                } else {
                    t.style.color = '#6b7280';
                    t.style.borderBottom = 'none';
                    t.style.fontWeight = '500';
                }
            });
            
            // Show/hide panels
            document.querySelectorAll('.blog-tab-panel').forEach(p => p.style.display = 'none');
            const panel = document.getElementById(`blog-tab-${tab}`);
            if (panel) panel.style.display = 'block';
            
            // Load settings when switching to settings tab
            if (tab === 'settings') {
                loadAppSettings('blog');
                setupColorSync('blog');
            } else {
                loadBlogByTab();
            }
        }
        
        // =========================================================
        // APP SETTINGS FUNCTIONS (Blog, Attractions, Reviews)
        // =========================================================
        
        const appColorPresets = {
            light: {
                accent: '#667eea', bg: '#ffffff', card: '#ffffff', text: '#1a1a1a',
                secondary: '#666666', catBg: '#e0e7ff', catText: '#4338ca', star: '#fbbf24'
            },
            dark: {
                accent: '#c9a227', bg: '#0f172a', card: '#1e293b', text: '#ffffff',
                secondary: '#94a3b8', catBg: '#334155', catText: '#fbbf24', star: '#fbbf24'
            },
            ocean: {
                accent: '#0ea5e9', bg: '#f0f9ff', card: '#ffffff', text: '#0c4a6e',
                secondary: '#0369a1', catBg: '#e0f2fe', catText: '#0284c7', star: '#fbbf24'
            },
            forest: {
                accent: '#22c55e', bg: '#f0fdf4', card: '#ffffff', text: '#14532d',
                secondary: '#166534', catBg: '#dcfce7', catText: '#15803d', star: '#fbbf24'
            }
        };
        
        function setupColorSync(app) {
            const fields = ['accent', 'bg', 'card', 'text', 'secondary', 'cat-bg', 'cat-text', 'star'];
            fields.forEach(field => {
                const picker = document.getElementById(`${app}-color-${field}`);
                const hex = document.getElementById(`${app}-color-${field}-hex`);
                if (picker && hex) {
                    picker.oninput = () => { hex.value = picker.value; updateAppPreview(app); };
                    hex.onchange = () => { if (/^#[0-9A-Fa-f]{6}$/.test(hex.value)) { picker.value = hex.value; updateAppPreview(app); } };
                }
            });
        }
        
        function updateAppPreview(app) {
            if (app === 'blog') {
                const preview = document.getElementById('blog-category-preview');
                if (preview) {
                    preview.style.background = document.getElementById('blog-color-cat-bg')?.value || '#e0e7ff';
                    preview.style.color = document.getElementById('blog-color-cat-text')?.value || '#4338ca';
                }
            } else if (app === 'attractions') {
                const preview = document.getElementById('attractions-category-preview');
                if (preview) {
                    preview.style.background = document.getElementById('attractions-color-cat-bg')?.value || '#fef3c7';
                    preview.style.color = document.getElementById('attractions-color-cat-text')?.value || '#92400e';
                }
            } else if (app === 'reviews') {
                const card = document.getElementById('reviews-preview-card');
                const stars = document.getElementById('reviews-preview-stars');
                const name = document.getElementById('reviews-preview-name');
                const meta = document.getElementById('reviews-preview-meta');
                const text = document.getElementById('reviews-preview-text');
                const avatar = document.getElementById('reviews-preview-avatar');
                
                if (card) card.style.background = document.getElementById('reviews-color-card')?.value || '#ffffff';
                if (stars) stars.style.color = document.getElementById('reviews-color-star')?.value || '#fbbf24';
                if (name) name.style.color = document.getElementById('reviews-color-text')?.value || '#1e293b';
                if (meta) meta.style.color = document.getElementById('reviews-color-secondary')?.value || '#64748b';
                if (text) text.style.color = document.getElementById('reviews-color-secondary')?.value || '#64748b';
                if (avatar) avatar.style.background = `linear-gradient(135deg, ${document.getElementById('reviews-color-accent')?.value || '#667eea'}, #8b5cf6)`;
            }
        }
        
        function applyAppColorPreset(app, preset) {
            const colors = appColorPresets[preset];
            if (!colors) return;
            
            const setColor = (field, value) => {
                const picker = document.getElementById(`${app}-color-${field}`);
                const hex = document.getElementById(`${app}-color-${field}-hex`);
                if (picker) picker.value = value;
                if (hex) hex.value = value;
            };
            
            setColor('accent', colors.accent);
            setColor('bg', colors.bg);
            setColor('card', colors.card);
            setColor('text', colors.text);
            setColor('secondary', colors.secondary);
            setColor('cat-bg', colors.catBg);
            setColor('cat-text', colors.catText);
            if (app === 'reviews') setColor('star', colors.star);
            
            updateAppPreview(app);
            showNotification(`${preset.charAt(0).toUpperCase() + preset.slice(1)} theme applied`, 'success');
        }
        
        async function loadAppSettings(app) {
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                const response = await fetch(`/api/app-settings/${app}?account_id=${accountId}`, { headers: authHeaders() });
                if (!response.ok) return;
                
                const data = await response.json();
                const colors = data.colors || {};
                
                const defaults = app === 'attractions' 
                    ? { accent: '#f59e0b', catBg: '#fef3c7', catText: '#92400e' }
                    : { accent: '#667eea', catBg: '#e0e7ff', catText: '#4338ca' };
                
                const setColor = (field, value, def) => {
                    const picker = document.getElementById(`${app}-color-${field}`);
                    const hex = document.getElementById(`${app}-color-${field}-hex`);
                    const val = value || def;
                    if (picker) picker.value = val;
                    if (hex) hex.value = val;
                };
                
                setColor('accent', colors.accent, defaults.accent);
                setColor('bg', colors.bg, '#ffffff');
                setColor('card', colors.card_bg, '#ffffff');
                setColor('text', colors.text, '#1a1a1a');
                setColor('secondary', colors.text_secondary, '#666666');
                setColor('cat-bg', colors.category_bg, defaults.catBg);
                setColor('cat-text', colors.category_text, defaults.catText);
                if (app === 'reviews') setColor('star', colors.star, '#fbbf24');
                
                updateAppPreview(app);
            } catch (error) {
                console.error('Error loading app settings:', error);
            }
        }
        
        async function saveAppSettings(app) {
            const settings = {
                accent: document.getElementById(`${app}-color-accent`)?.value,
                bg: document.getElementById(`${app}-color-bg`)?.value,
                card_bg: document.getElementById(`${app}-color-card`)?.value,
                text: document.getElementById(`${app}-color-text`)?.value,
                text_secondary: document.getElementById(`${app}-color-secondary`)?.value,
                category_bg: document.getElementById(`${app}-color-cat-bg`)?.value,
                category_text: document.getElementById(`${app}-color-cat-text`)?.value
            };
            
            if (app === 'reviews') {
                settings.star = document.getElementById('reviews-color-star')?.value;
            }
            
            try {
                const accountId = selectedAccountId || currentAccount?.id;
                const response = await fetch(`/api/app-settings/${app}?account_id=${accountId}`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ colors: settings, account_id: accountId })
                });
                
                if (response.ok) {
                    showNotification(`${app.charAt(0).toUpperCase() + app.slice(1)} settings saved!`, 'success');
                } else {
                    throw new Error('Failed to save');
                }
            } catch (error) {
                console.error('Error saving app settings:', error);
                showNotification('Failed to save settings', 'error');
            }
        }
        
        function switchReviewsTab(tab) {
            document.querySelectorAll('.reviews-tab').forEach(t => {
                if (t.dataset.tab === tab) {
                    t.style.color = '#eab308';
                    t.style.borderBottom = '2px solid #eab308';
                    t.style.fontWeight = '600';
                } else {
                    t.style.color = '#6b7280';
                    t.style.borderBottom = 'none';
                    t.style.fontWeight = '500';
                }
            });
            
            document.querySelectorAll('.reviews-tab-panel').forEach(p => p.style.display = 'none');
            const panel = document.getElementById(`reviews-tab-${tab}`);
            if (panel) panel.style.display = 'block';
            
            if (tab === 'settings') {
                loadAppSettings('reviews');
                setupColorSync('reviews');
            } else {
                loadAppReviews();
            }
        }
        
        // =========================================================
        // APP REVIEWS FUNCTIONS
        // =========================================================
        
        async function loadAppReviews() {
            const container = document.getElementById('app-reviews-list');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><p>Loading reviews...</p></div>';
            
            try {
                // Get filter values
                const propertyFilter = document.getElementById('reviews-property-filter')?.value || '';
                const ratingFilter = document.getElementById('reviews-rating-filter')?.value || '';
                const channelFilter = document.getElementById('reviews-channel-filter')?.value || '';
                
                // Build URL - always filter by account for non-master users
                const isMaster = currentAccount && currentAccount.role === 'master_admin';
                let url = '/api/reviews?limit=500';
                
                // Account filtering
                if (selectedAccountId) {
                    url += `&account_id=${selectedAccountId}`;
                } else if (!isMaster && currentAccount?.id) {
                    url += `&account_id=${currentAccount.id}`;
                }
                
                // Property and rating filters
                if (propertyFilter) url += `&property_id=${propertyFilter}`;
                if (ratingFilter) url += `&min_rating=${ratingFilter}`;
                
                const response = await fetch(url, { headers: authHeaders() });
                const data = await response.json();
                
                // Populate property dropdown for current account
                populateReviewsPropertyFilter();
                
                // Get reviews and filter by channel if needed
                let reviews = data.reviews || [];
                if (channelFilter) {
                    reviews = reviews.filter(r => 
                        (r.channel_name || '').toLowerCase().includes(channelFilter.toLowerCase())
                    );
                }
                
                // Sort by rating (highest first)
                reviews.sort((a, b) => (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0));
                
                if (reviews.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">â­</div>
                            <h3 style="margin-bottom: 0.5rem;">No reviews found</h3>
                            <p>Sync reviews from your channel manager connections</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="showView('gas-sync-connections')">Go to Sync Connections</button>
                        </div>
                    `;
                    return;
                }
                
                // Calculate stats
                const totalReviews = reviews.length;
                const avgRating = (reviews.reduce((sum, r) => sum + (parseFloat(r.rating) || 0), 0) / totalReviews).toFixed(1);
                
                // Build HTML
                let html = `
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                        <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; padding: 1rem 1.5rem; border-radius: 12px; text-align: center; min-width: 120px;">
                            <div style="font-size: 2rem; font-weight: bold;">${avgRating}</div>
                            <div style="font-size: 0.85rem; opacity: 0.9;">Average Rating</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 1rem 1.5rem; border-radius: 12px; text-align: center; min-width: 120px;">
                            <div style="font-size: 2rem; font-weight: bold;">${totalReviews}</div>
                            <div style="font-size: 0.85rem; opacity: 0.9;">Total Reviews</div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                `;
                
                for (const review of reviews) {
                    const rawRating = parseFloat(review.rating) || 0;
                    const stars5 = rawRating > 5 ? rawRating / 2 : rawRating;
                    const starCount = Math.min(5, Math.max(0, Math.round(stars5)));
                    const stars = 'â˜…'.repeat(starCount) + 'â˜†'.repeat(5 - starCount);
                    const channelColor = getChannelColor(review.channel_name);
                    const reviewDate = review.review_date ? new Date(review.review_date).toLocaleDateString() : '';
                    
                    html += `
                        <div style="border: 1px solid var(--border); border-radius: 12px; padding: 1rem; background: var(--bg-primary);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #6366f1, #8b5cf6); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        ${(review.guest_name || 'G').charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">${review.guest_name || 'Guest'}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">${reviewDate}${review.guest_country ? ' â€¢ ' + review.guest_country : ''}</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="background: ${channelColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">${review.channel_name || 'Unknown'}</span>
                                    <span style="color: #fbbf24; font-size: 1.1rem;">${stars}</span>
                                    <span style="font-weight: bold; color: #64748b;">${rawRating}</span>
                                </div>
                            </div>
                            ${review.title ? `<div style="font-weight: 600; margin-bottom: 0.5rem;">${review.title}</div>` : ''}
                            <div style="color: #64748b; line-height: 1.5;">${review.comment || '<em>No comment</em>'}</div>
                            ${review.host_reply ? `
                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid #3b82f6;">
                                    <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.25rem;">Host Reply:</div>
                                    <div style="font-size: 0.9rem;">${review.host_reply}</div>
                                </div>
                            ` : ''}
                            <div style="margin-top: 0.75rem; font-size: 0.8rem; color: #64748b;">
                                ${review.property_name || ''} ${review.room_name ? 'â€¢ ' + review.room_name : ''}
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading reviews:', error);
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #ef4444;"><p>Error loading reviews: ${error.message}</p></div>`;
            }
        }
        
        function getChannelColor(channel) {
            if (!channel) return '#6b7280';
            const c = channel.toLowerCase();
            if (c.includes('airbnb')) return '#ff5a5f';
            if (c.includes('booking')) return '#003580';
            if (c.includes('vrbo')) return '#3d74c7';
            if (c.includes('expedia')) return '#00355f';
            if (c.includes('google')) return '#4285f4';
            if (c.includes('tripadvisor')) return '#00af87';
            return '#6b7280';
        }
        
        async function populateReviewsPropertyFilter() {
            const select = document.getElementById('reviews-property-filter');
            if (!select) return;
            
            // Get effective account ID
            const isMaster = currentAccount && currentAccount.role === 'master_admin';
            const accountId = selectedAccountId || (!isMaster && currentAccount?.id) || null;
            
            // Check if already populated for this account
            if (select.dataset.accountId === String(accountId) && select.options.length > 1) return;
            
            select.innerHTML = '<option value="">All Properties</option>';
            select.dataset.accountId = accountId || '';
            
            try {
                let url = '/api/db/properties';
                if (accountId) url += `?account_id=${accountId}`;
                
                const response = await fetch(url, { headers: authHeaders() });
                const data = await response.json();
                
                (data.data || []).forEach(prop => {
                    const opt = document.createElement('option');
                    opt.value = prop.id;
                    opt.textContent = prop.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Error loading properties:', e);
            }
        }
        
        async function loadBlogByTab() {
            await loadBlogPropertySelect();
            
            const propertyId = document.getElementById('blog-property-select')?.value || '';
            const clientId = getClientId();
            
            if (currentBlogTab === 'ideas') {
                await loadBlogIdeas(propertyId, clientId);
            } else {
                await loadBlogPosts(propertyId, clientId);
            }
            
            updateBlogCounts(propertyId, clientId);
        }
        
        async function loadBlogPropertySelect() {
            const select = document.getElementById('blog-property-select');
            if (!select) return;
            
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`, { headers: authHeaders() });
                const data = await response.json();
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">All Properties</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
                    });
                }
                
                if (currentValue) select.value = currentValue;
            } catch (error) {
                console.error('Error loading blog properties:', error);
            }
        }
        
        async function loadBlogIdeas(propertyId, clientId) {
            try {
                const params = [];
                if (clientId) params.push(`client_id=${clientId}`);
                if (propertyId) params.push(`property_id=${propertyId}`);
                params.push('content_type=blog');
                // Include both 'active' and 'idea' status
                params.push('status=active,idea');
                
                const url = '/api/admin/content-ideas?' + params.join('&');
                const response = await fetch(url, { headers: authHeaders() });
                const data = await response.json();
                
                blogIdeas = data.ideas || [];
                renderBlogIdeas();
            } catch (error) {
                console.error('Error loading blog ideas:', error);
            }
        }
        
        function renderBlogIdeas() {
            const container = document.getElementById('blog-ideas-list');
            if (!container) return;
            
            const searchQuery = document.getElementById('blog-search')?.value?.toLowerCase() || '';
            let filtered = blogIdeas;
            if (searchQuery) {
                filtered = blogIdeas.filter(idea => 
                    idea.title?.toLowerCase().includes(searchQuery) ||
                    idea.description?.toLowerCase().includes(searchQuery)
                );
            }
            
            // Sort by event_date (upcoming first), then by created_at
            filtered.sort((a, b) => {
                if (a.event_date && b.event_date) {
                    return new Date(a.event_date) - new Date(b.event_date);
                }
                if (a.event_date) return -1; // Events with dates first
                if (b.event_date) return 1;
                return new Date(b.created_at) - new Date(a.created_at);
            });
            
            if (!filtered.length) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                        <h3 style="margin-bottom: 0.5rem;">No blog ideas yet</h3>
                        <p style="margin-bottom: 1rem;">Get AI-powered blog topic suggestions for your property</p>
                        <button class="btn" onclick="openBlogIdeasWizard()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"> Get Ideas</button>
                    </div>
                `;
                return;
            }
            
            // Category display mapping
            const catLabels = {
                'attractions_museums': ' Museums & History',
                'attractions_parks': ' Parks & Gardens',
                'attractions_beaches': ' Beaches',
                'attractions_landmarks': ' Landmarks',
                'attractions_nature': ' Nature',
                'events_festivals': ' Festivals',
                'events_seasonal': ' Seasonal',
                'events_sports': ' Sports Events',
                'events_holidays': ' Events & Holidays',
                'Events & Concerts': 'ðŸŽµ Events & Concerts',
                'News & Updates': 'ðŸ“° News & Updates'
            };
            
            // Format event date nicely
            function formatEventDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }
            
            // Filter out past events by default
            const now = new Date();
            const futureFiltered = filtered.filter(idea => {
                if (!idea.event_date) return true; // Keep non-event ideas
                return new Date(idea.event_date) >= now;
            });
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                    ${futureFiltered.map(idea => {
                        const catLabel = catLabels[idea.category] || (idea.category ? idea.category.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' & ') : 'Blog');
                        const eventDateStr = formatEventDate(idea.event_date);
                        return `
                        <div class="card" style="padding: 1.25rem; border-left: 4px solid ${idea.event_date ? '#3b82f6' : '#8b5cf6'};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <select onchange="updateIdeaCategory(${idea.id}, this.value)" style="background: #ede9fe; color: #7c3aed; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; border: none; cursor: pointer;">
                                    <option value="${idea.category || ''}" selected>${catLabel}</option>
                                    <option value="General">General</option>
                                    <option value="Events & Festivals">Events & Festivals</option>
                                    <option value="Events & Concerts">Events & Concerts</option>
                                    <option value="Local Guide">Local Guide</option>
                                    <option value="Travel Tips">Travel Tips</option>
                                    <option value="Food & Drink">Food & Drink</option>
                                    <option value="Activities">Activities</option>
                                    <option value="Attractions">Attractions</option>
                                </select>
                                ${eventDateStr ? `<span style="background: #dbeafe; color: #1d4ed8; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">
                                    ${eventDateStr}
                                </span>` : ''}
                            </div>
                            <h4 style="margin: 0.5rem 0; font-size: 1rem; line-height: 1.4;">${escapeHtml(idea.title)}</h4>
                            ${idea.event_location ? `<p style="color: #6b7280; font-size: 0.8rem; margin: 0 0 0.5rem;">${escapeHtml(idea.event_location)}</p>` : ''}
                            ${idea.description ? `<p style="color: #64748b; font-size: 0.875rem; margin: 0 0 0.75rem; line-height: 1.4;">${escapeHtml(idea.description.substring(0, 100))}${idea.description.length > 100 ? '...' : ''}</p>` : ''}
                            ${idea.property_name ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.75rem;">${escapeHtml(idea.property_name)}</p>` : ''}
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small" onclick="createBlogFromIdea(${idea.id})" style="flex: 1; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                    Create Post
                                </button>
                                <button class="btn btn-small" onclick="dismissBlogIdea(${idea.id})" style="background: #fee2e2; color: #dc2626; border: none;">
                                    X
                                </button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }
        
        async function loadBlogPosts(propertyId, clientId) {
            try {
                let url = '/api/admin/blog';
                const params = [];
                if (clientId) params.push(`client_id=${clientId}`);
                if (propertyId) params.push(`property_id=${propertyId}`);
                if (params.length > 0) url += '?' + params.join('&');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.posts) {
                    blogPosts.drafts = data.posts.filter(p => !p.is_published && !p.scheduled_at);
                    blogPosts.scheduled = data.posts.filter(p => !p.is_published && p.scheduled_at);
                    blogPosts.published = data.posts.filter(p => p.is_published);
                }
                
                renderBlogPosts();
            } catch (error) {
                console.error('Error loading blog posts:', error);
            }
        }
        
        function renderBlogPosts() {
            const posts = blogPosts[currentBlogTab] || [];
            const container = document.getElementById(`blog-${currentBlogTab}-list`);
            if (!container) return;
            
            const searchQuery = document.getElementById('blog-search')?.value?.toLowerCase() || '';
            let filtered = posts;
            if (searchQuery) {
                filtered = posts.filter(p => 
                    p.title?.toLowerCase().includes(searchQuery) ||
                    p.content?.toLowerCase().includes(searchQuery)
                );
            }
            
            if (!filtered.length) {
                const messages = {
                    drafts: { icon: 'ðŸ“', title: 'No drafts', desc: 'Posts you\'re working on will appear here' },
                    scheduled: { icon: 'ðŸ“…', title: 'Nothing scheduled', desc: 'Schedule posts to publish automatically' },
                    published: { icon: 'âœ…', title: 'No published posts', desc: 'Your live posts will appear here' }
                };
                const msg = messages[currentBlogTab] || messages.drafts;
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">${msg.icon}</div>
                        <h3 style="margin-bottom: 0.5rem;">${msg.title}</h3>
                        <p>${msg.desc}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Property</th>
                                <th>Category</th>
                                <th>${currentBlogTab === 'scheduled' ? 'Scheduled For' : 'Date'}</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(post => `
                                <tr>
                                    <td><strong>${escapeHtml(post.title)}</strong></td>
                                    <td>${escapeHtml(post.property_name || '-')}</td>
                                    <td>${escapeHtml(post.category || '-')}</td>
                                    <td>${post.scheduled_at ? new Date(post.scheduled_at).toLocaleDateString() : new Date(post.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="editBlogPost(${post.id})">Edit</button>
                                        ${currentBlogTab === 'drafts' ? `<button class="btn btn-small" onclick="publishBlogPost(${post.id})" style="background: #10b981;">Publish</button>` : ''}
                                        ${currentBlogTab === 'scheduled' ? `<button class="btn btn-small" onclick="publishBlogPost(${post.id})" style="background: #10b981;">Publish Now</button>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function filterBlogPosts() {
            if (currentBlogTab === 'ideas') {
                renderBlogIdeas();
            } else {
                renderBlogPosts();
            }
        }
        
        async function updateBlogCounts(propertyId, clientId) {
            // Ideas count
            try {
                const params = [];
                if (clientId) params.push(`client_id=${clientId}`);
                if (propertyId) params.push(`property_id=${propertyId}`);
                params.push('content_type=blog');
                params.push('status=active,idea');
                
                const ideasRes = await fetch('/api/admin/content-ideas?' + params.join('&'), { headers: authHeaders() });
                const ideasData = await ideasRes.json();
                document.getElementById('blog-count-ideas').textContent = ideasData.ideas?.length || 0;
            } catch (e) {}
            
            // Posts counts - always fetch fresh
            try {
                let url = '/api/admin/blog';
                const params = [];
                if (clientId) params.push(`client_id=${clientId}`);
                if (propertyId) params.push(`property_id=${propertyId}`);
                if (params.length > 0) url += '?' + params.join('&');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.posts) {
                    blogPosts.drafts = data.posts.filter(p => !p.is_published && !p.scheduled_at);
                    blogPosts.scheduled = data.posts.filter(p => !p.is_published && p.scheduled_at);
                    blogPosts.published = data.posts.filter(p => p.is_published);
                }
                
                document.getElementById('blog-count-drafts').textContent = blogPosts.drafts?.length || 0;
                document.getElementById('blog-count-scheduled').textContent = blogPosts.scheduled?.length || 0;
                document.getElementById('blog-count-published').textContent = blogPosts.published?.length || 0;
            } catch (e) {
                console.error('Error updating blog counts:', e);
            }
        }
        
        // ===== iCal & RSS Feed Functions =====
        
        async function openIcalFeedsModal() {
            await populateFeedPropertySelect('ical-property-select');
            loadIcalFeeds();
            openModal('ical-feeds-modal');
        }
        
        async function openRssFeedsModal() {
            await populateFeedPropertySelect('rss-property-select');
            loadRssFeeds();
            openModal('rss-feeds-modal');
        }
        
        async function populateFeedPropertySelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">All Properties</option>';
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
                    });
                }
            } catch (e) {}
        }
        
        async function loadIcalFeeds() {
            const container = document.getElementById('ical-feeds-list');
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/blog/feeds?type=ical${queryString.replace('?', '&')}`, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.feeds && data.feeds.length > 0) {
                    container.innerHTML = data.feeds.map(feed => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${escapeHtml(feed.name)}</div>
                                <div style="font-size: 0.8rem; color: #6b7280; word-break: break-all;">${escapeHtml(feed.url.substring(0, 50))}...</div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">
                                    ${feed.property_name ? `<span style="color: #3b82f6;">ðŸ“ ${escapeHtml(feed.property_name)}</span> â€¢ ` : ''}
                                    ${feed.last_fetched ? 'Last fetched: ' + formatTimeAgo(feed.last_fetched) : 'Never fetched'}
                                </div>
                            </div>
                            <button onclick="deleteIcalFeed(${feed.id})" class="btn btn-sm" style="background: #fee2e2; color: #dc2626;">âœ•</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 2rem;">No iCal feeds configured. Add one above!</p>';
                }
            } catch (e) {
                container.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 2rem;">Error loading feeds</p>';
            }
        }
        
        async function loadRssFeeds() {
            const container = document.getElementById('rss-feeds-list');
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/blog/feeds?type=rss${queryString.replace('?', '&')}`, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.feeds && data.feeds.length > 0) {
                    container.innerHTML = data.feeds.map(feed => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${escapeHtml(feed.name)}</div>
                                <div style="font-size: 0.8rem; color: #6b7280; word-break: break-all;">${escapeHtml(feed.url.substring(0, 50))}...</div>
                                <div style="font-size: 0.75rem; color: #9ca3af;">
                                    ${feed.property_name ? `<span style="color: #f97316;">ðŸ“ ${escapeHtml(feed.property_name)}</span> â€¢ ` : ''}
                                    ${feed.last_fetched ? 'Last fetched: ' + formatTimeAgo(feed.last_fetched) : 'Never fetched'}
                                </div>
                            </div>
                            <button onclick="deleteRssFeed(${feed.id})" class="btn btn-sm" style="background: #fee2e2; color: #dc2626;">âœ•</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 2rem;">No RSS feeds configured. Add one above!</p>';
                }
            } catch (e) {
                container.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 2rem;">Error loading feeds</p>';
            }
        }
        
        async function addIcalFeed() {
            const url = document.getElementById('new-ical-url').value.trim();
            const name = document.getElementById('new-ical-name').value.trim() || 'iCal Feed';
            const propertyId = document.getElementById('ical-property-select').value;
            
            if (!url) {
                showNotification('Please enter an iCal URL', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/blog/feeds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: 'ical', 
                        url, 
                        name, 
                        account_id: selectedAccountId,
                        property_id: propertyId || null
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('iCal feed added', 'success');
                    document.getElementById('new-ical-url').value = '';
                    document.getElementById('new-ical-name').value = '';
                    loadIcalFeeds();
                } else {
                    showNotification(data.error || 'Failed to add feed', 'error');
                }
            } catch (e) {
                showNotification('Error adding feed', 'error');
            }
        }
        
        async function addRssFeed() {
            const url = document.getElementById('new-rss-url').value.trim();
            const name = document.getElementById('new-rss-name').value.trim() || 'RSS Feed';
            const propertyId = document.getElementById('rss-property-select').value;
            
            if (!url) {
                showNotification('Please enter an RSS URL', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/blog/feeds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: 'rss', 
                        url, 
                        name, 
                        account_id: selectedAccountId,
                        property_id: propertyId || null
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('RSS feed added', 'success');
                    document.getElementById('new-rss-url').value = '';
                    document.getElementById('new-rss-name').value = '';
                    loadRssFeeds();
                } else {
                    showNotification(data.error || 'Failed to add feed', 'error');
                }
            } catch (e) {
                showNotification('Error adding feed', 'error');
            }
        }
        
        async function deleteIcalFeed(feedId) {
            if (!confirm('Delete this feed?')) return;
            try {
                const response = await fetch(`/api/blog/feeds/${feedId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Feed deleted', 'success');
                    loadIcalFeeds();
                }
            } catch (e) {
                showNotification('Error deleting feed', 'error');
            }
        }
        
        async function deleteRssFeed(feedId) {
            if (!confirm('Delete this feed?')) return;
            try {
                const response = await fetch(`/api/blog/feeds/${feedId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Feed deleted', 'success');
                    loadRssFeeds();
                }
            } catch (e) {
                showNotification('Error deleting feed', 'error');
            }
        }
        
        async function fetchIcalEvents() {
            showNotification('Fetching events from iCal feeds...', 'info');
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/blog/feeds/fetch-ical${queryString}`, {
                    method: 'POST',
                    headers: authHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    let msg = `Found ${data.events_count || 0} events, created ${data.ideas_created || 0} new ideas`;
                    if (data.ideas_skipped > 0) {
                        msg += ` (${data.ideas_skipped} skipped - already exist)`;
                    }
                    showNotification(msg, 'success');
                    loadIcalFeeds();
                    // Refresh the blog ideas list if visible
                    if (typeof loadBlogByTab === 'function') loadBlogByTab();
                } else {
                    showNotification(data.error || 'Failed to fetch events', 'error');
                }
            } catch (e) {
                showNotification('Error fetching events', 'error');
            }
        }
        
        async function fetchRssArticles() {
            showNotification('Fetching articles from RSS feeds...', 'info');
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/blog/feeds/fetch-rss${queryString}`, {
                    method: 'POST',
                    headers: authHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    let msg = `Found ${data.articles_count || 0} articles, created ${data.ideas_created || 0} new ideas`;
                    if (data.ideas_skipped > 0) {
                        msg += ` (${data.ideas_skipped} skipped - already exist)`;
                    }
                    showNotification(msg, 'success');
                    loadRssFeeds();
                    // Refresh the blog ideas list if visible
                    if (typeof loadBlogByTab === 'function') loadBlogByTab();
                } else {
                    showNotification(data.error || 'Failed to fetch articles', 'error');
                }
            } catch (e) {
                showNotification('Error fetching articles', 'error');
            }
        }
        
        // Blog Ideas Wizard Functions
        async function openBlogIdeasWizard() {
            // Reset wizard
            selectedBlogCategory = '';
            selectedBlogSubcategory = '';
            document.querySelectorAll('#blog-ideas-wizard .wizard-option').forEach(o => o.classList.remove('selected'));
            document.querySelectorAll('#blog-ideas-wizard input[type="radio"]').forEach(r => r.checked = false);
            document.getElementById('blog-wizard-subcategory-section').style.display = 'none';
            document.getElementById('blog-wizard-preview').style.display = 'none';
            document.getElementById('blog-wizard-loading').style.display = 'none';
            document.getElementById('blog-wizard-results').style.display = 'none';
            document.getElementById('blog-wizard-footer').style.display = 'flex';
            document.getElementById('blog-wizard-generate-btn').disabled = true;
            
            // Populate properties
            const select = document.getElementById('blog-wizard-property');
            select.innerHTML = '<option value="">Choose a property...</option>';
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
                    });
                }
            } catch (e) {}
            
            // Pre-select property if filtered
            const filterProp = document.getElementById('blog-property-select')?.value;
            if (filterProp) select.value = filterProp;
            
            document.getElementById('blog-ideas-wizard').style.display = 'flex';
        }
        
        function closeBlogIdeasWizard() {
            document.getElementById('blog-ideas-wizard').style.display = 'none';
        }
        
        function selectBlogCategory(category) {
            selectedBlogCategory = category;
            selectedBlogSubcategory = '';
            
            // Update UI
            document.querySelectorAll('#blog-ideas-wizard .wizard-option').forEach(o => {
                const radio = o.querySelector('input[type="radio"]');
                if (radio && radio.value === category) {
                    o.classList.add('selected');
                    radio.checked = true;
                } else {
                    o.classList.remove('selected');
                }
            });
            
            // Show subcategory
            const subSection = document.getElementById('blog-wizard-subcategory-section');
            const subSelect = document.getElementById('blog-wizard-subcategory');
            
            if (category === 'attractions') {
                subSelect.innerHTML = `
                    <option value="">Choose a topic...</option>
                    <option value="museums"> Museums & Galleries</option>
                    <option value="landmarks"> Landmarks & Monuments</option>
                    <option value="parks"> Parks & Gardens</option>
                    <option value="beaches"> Beaches & Coastline</option>
                    <option value="restaurants"> Restaurants & Dining</option>
                    <option value="cafes"> Cafes & Coffee Shops</option>
                    <option value="nightlife"> Nightlife & Bars</option>
                    <option value="shopping"> Shopping & Markets</option>
                    <option value="nature"> Nature & Outdoor</option>
                    <option value="daytrips"> Day Trips</option>
                `;
            } else if (category === 'events') {
                subSelect.innerHTML = `
                    <option value="">Choose a topic...</option>
                    <option value="festivals"> Festivals & Celebrations</option>
                    <option value="concerts"> Concerts & Live Music</option>
                    <option value="theater"> Theater & Performances</option>
                    <option value="sports"> Sports Events</option>
                    <option value="markets"> Markets & Fairs</option>
                    <option value="cultural"> Cultural Events</option>
                    <option value="seasonal"> Seasonal Activities</option>
                    <option value="holidays"> Holiday Events</option>
                    <option value="family"> Family Events</option>
                `;
            }
            
            subSection.style.display = 'block';
            document.getElementById('blog-wizard-preview').style.display = 'none';
            document.getElementById('blog-wizard-generate-btn').disabled = true;
        }
        
        function updateBlogWizardSubcategories() {
            // Called when property changes - check if can enable button
            checkBlogWizardReady();
        }
        
        function checkBlogWizardReady() {
            const property = document.getElementById('blog-wizard-property').value;
            const subcategory = document.getElementById('blog-wizard-subcategory').value;
            
            if (property && selectedBlogCategory && subcategory) {
                selectedBlogSubcategory = subcategory;
                document.getElementById('blog-wizard-preview').style.display = 'block';
                document.getElementById('blog-wizard-generate-btn').disabled = false;
            } else {
                document.getElementById('blog-wizard-generate-btn').disabled = true;
            }
        }
        
        // Add onchange to subcategory select
        document.addEventListener('DOMContentLoaded', () => {
            const subSelect = document.getElementById('blog-wizard-subcategory');
            if (subSelect) subSelect.addEventListener('change', checkBlogWizardReady);
        });
        
        async function generateBlogIdeas() {
            const propertyId = document.getElementById('blog-wizard-property').value;
            
            if (!propertyId || !selectedBlogCategory || !selectedBlogSubcategory) {
                showNotification('Please complete all steps', 'error');
                return;
            }
            
            // Show loading state in wizard
            const wizardFooter = document.getElementById('blog-wizard-footer');
            const wizardLoading = document.getElementById('blog-wizard-loading');
            const wizardPreview = document.getElementById('blog-wizard-preview');
            document.querySelectorAll('#blog-ideas-wizard .form-group').forEach(g => g.style.display = 'none');
            if (wizardFooter) wizardFooter.style.display = 'none';
            if (wizardPreview) wizardPreview.style.display = 'none';
            if (wizardLoading) wizardLoading.style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/content-ideas/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        property_id: propertyId,
                        content_type: 'blog',
                        category: `${selectedBlogCategory}_${selectedBlogSubcategory}`,
                        count: 5,
                        client_id: getClientId()
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.ideas?.length > 0) {
                    // Just close wizard and refresh Ideas tab - ideas are saved to DB by the API
                    closeBlogIdeasWizard();
                    showNotification(` Generated ${data.ideas.length} blog ideas!`, 'success');
                    
                    // Switch to Ideas tab to show the new ideas
                    switchBlogTab('ideas');
                    loadBlogByTab();
                } else {
                    closeBlogIdeasWizard();
                    showNotification(data.error || 'Failed to generate ideas', 'error');
                }
            } catch (error) {
                console.error('Generate blog ideas error:', error);
                closeBlogIdeasWizard();
                showNotification('Error generating ideas', 'error');
            }
        }
        
        // Silent version that doesn't open modal
        async function generateBlogFromIdeaSilent(ideaId, title, propertyId) {
            const clientId = getClientId();
            
            // First, get the category from the content idea
            let ideaCategory = 'General';
            try {
                const ideaResponse = await fetch(`/api/admin/content-ideas/${ideaId}`, { headers: authHeaders() });
                const ideaData = await ideaResponse.json();
                if (ideaData.success && ideaData.idea?.category) {
                    // Category is stored like "events_holidays" - convert to display format
                    ideaCategory = ideaData.idea.category
                        .split('_')
                        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                        .join(' & ');
                }
            } catch (e) {
                console.error('Could not fetch idea category:', e);
            }
            
            // Generate blog content
            const response = await fetch('/api/admin/blog/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                body: JSON.stringify({
                    keyword: title,
                    property_id: propertyId,
                    client_id: clientId,
                    content_idea_id: ideaId
                })
            });
            
            const data = await response.json();
            
            if (!data.success || !data.blog) {
                throw new Error(data.error || 'Generation failed');
            }
            
            // Save the blog post with the correct category
            const blog = data.blog;
            const saveResponse = await fetch('/api/admin/blog', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                body: JSON.stringify({
                    property_id: propertyId,
                    title: blog.title,
                    excerpt: blog.excerpt,
                    content: blog.content,
                    category: ideaCategory,
                    meta_title: blog.meta_title,
                    meta_description: blog.meta_description,
                    tags: blog.suggested_tags || [],
                    faq_schema: blog.faq_schema,
                    ai_generated: true,
                    source_keyword: title,
                    is_published: false
                })
            });
            
            const saveData = await saveResponse.json();
            
            if (!saveData.success) {
                throw new Error(saveData.error || 'Failed to save blog');
            }
            
            // Mark the idea as used
            try {
                await fetch(`/api/admin/content-ideas/${ideaId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status: 'used' })
                });
            } catch (e) {}
            
            return saveData;
        }
        
        function resetBlogWizard() {
            document.querySelectorAll('#blog-ideas-wizard .form-group').forEach(g => g.style.display = 'block');
            document.getElementById('blog-wizard-results').style.display = 'none';
            document.getElementById('blog-wizard-footer').style.display = 'flex';
            if (selectedBlogCategory) {
                document.getElementById('blog-wizard-subcategory-section').style.display = 'block';
            }
        }
        
        async function selectBlogIdeaFromWizard(ideaId, title, propertyId) {
            closeBlogIdeasWizard();
            
            // Generate blog immediately - no extra form
            await generateBlogFromIdea(ideaId, title, propertyId);
        }
        
        async function createBlogFromIdea(ideaId) {
            const idea = blogIdeas.find(i => i.id === ideaId);
            if (!idea) return;
            
            // Generate blog with the category and event info from the idea
            await generateBlogFromIdea(ideaId, idea.title, idea.property_id, idea.category, idea.event_date, idea.event_location, idea.description);
        }
        
        async function generateBlogFromIdea(ideaId, title, propertyId, category, eventDate, eventLocation, description) {
            // Open AI blog modal but skip to loading/generation immediately
            await openAiBlogModal(title, propertyId);
            
            // Store idea ID and event info for marking as used later
            const propertyIdEl = document.getElementById('ai-blog-property-id');
            if (propertyIdEl) {
                propertyIdEl.dataset.contentIdeaId = ideaId;
                // Store category from idea
                propertyIdEl.dataset.ideaCategory = category || '';
                // Store event info
                propertyIdEl.dataset.eventDate = eventDate || '';
                propertyIdEl.dataset.eventLocation = eventLocation || '';
                propertyIdEl.dataset.eventDescription = description || '';
            }
            
            // Set the keyword - include date if it's an event
            let keyword = title;
            if (eventDate) {
                const date = new Date(eventDate);
                const dateStr = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                keyword = `${title} (${dateStr})`;
            }
            document.getElementById('ai-blog-keyword').value = keyword;
            
            // Set the category from the idea (convert from slug format to display format)
            if (category) {
                const categoryField = document.getElementById('ai-blog-category');
                if (categoryField) {
                    // Use category directly if it's already display format, otherwise convert
                    if (category.includes('_')) {
                        const displayCategory = category.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' & ');
                        categoryField.value = displayCategory;
                    } else {
                        categoryField.value = category;
                    }
                }
            }
            
            // Trigger generation immediately
            generateAiBlog();
        }
        
        // Update blog idea category
        async function updateIdeaCategory(ideaId, newCategory) {
            try {
                await fetch(`/api/admin/content-ideas/${ideaId}`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category: newCategory })
                });
                // Update in local array too
                const idea = blogIdeas.find(i => i.id === ideaId);
                if (idea) idea.category = newCategory;
                showNotification('Category updated', 'success');
            } catch (e) {
                console.error('Error updating category:', e);
                showNotification('Failed to update category', 'error');
            }
        }
        
        async function dismissBlogIdea(ideaId) {
            if (!confirm('Remove this idea?')) return;
            
            try {
                await fetch(`/api/admin/content-ideas/${ideaId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                loadBlogByTab();
            } catch (e) {
                console.error('Error dismissing idea:', e);
            }
        }
        
        // =====================================================
        // =====================================================
        // ATTRACTIONS APP FUNCTIONS (with Ideas, Drafts, Scheduled, Published tabs)
        // =====================================================
        
        let attractionIdeas = [];
        let attractions = { drafts: [], scheduled: [], published: [] };
        let currentAttractionTab = 'ideas';
        let selectedAttractionCategory = '';
        
        function switchAttractionTab(tab) {
            currentAttractionTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.attraction-tab').forEach(t => {
                if (t.dataset.tab === tab) {
                    t.style.color = '#f59e0b';
                    t.style.borderBottom = '2px solid #f59e0b';
                    t.style.fontWeight = '600';
                } else {
                    t.style.color = '#6b7280';
                    t.style.borderBottom = 'none';
                    t.style.fontWeight = '500';
                }
            });
            
            // Show/hide panels
            document.querySelectorAll('.attraction-tab-panel').forEach(p => p.style.display = 'none');
            const panel = document.getElementById(`attraction-tab-${tab}`);
            if (panel) panel.style.display = 'block';
            
            // Load settings when switching to settings tab
            if (tab === 'settings') {
                loadAppSettings('attractions');
                setupColorSync('attractions');
            } else {
                loadAttractionsByTab();
            }
        }
        
        async function loadAttractionsByTab() {
            await loadAttractionsPropertySelect();
            
            const propertyId = document.getElementById('attractions-property-select')?.value || '';
            const clientId = getClientId();
            
            if (currentAttractionTab === 'ideas') {
                await loadAttractionIdeas(propertyId, clientId);
            } else {
                await loadAttractions(propertyId, clientId);
            }
            
            updateAttractionCounts(propertyId, clientId);
        }
        
        async function loadAttractionsPropertySelect() {
            const select = document.getElementById('attractions-property-select');
            if (!select) return;
            
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`, { headers: authHeaders() });
                const data = await response.json();
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">All Properties</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
                    });
                }
                
                if (currentValue) select.value = currentValue;
            } catch (error) {
                console.error('Error loading attractions properties:', error);
            }
        }
        
        async function loadAttractionIdeas(propertyId, clientId) {
            try {
                const params = [];
                if (clientId) params.push(`client_id=${clientId}`);
                if (propertyId) params.push(`property_id=${propertyId}`);
                params.push('content_type=attraction');
                params.push('status=active');
                
                const url = '/api/admin/content-ideas?' + params.join('&');
                const response = await fetch(url, { headers: authHeaders() });
                const data = await response.json();
                
                attractionIdeas = data.ideas || [];
                renderAttractionIdeas();
            } catch (error) {
                console.error('Error loading attraction ideas:', error);
            }
        }
        
        function renderAttractionIdeas() {
            const container = document.getElementById('attraction-ideas-list');
            if (!container) return;
            
            const searchQuery = document.getElementById('attractions-search')?.value?.toLowerCase() || '';
            let filtered = attractionIdeas;
            if (searchQuery) {
                filtered = attractionIdeas.filter(s => 
                    s.title?.toLowerCase().includes(searchQuery) ||
                    s.description?.toLowerCase().includes(searchQuery)
                );
            }
            
            if (!filtered.length) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                        <h3 style="margin-bottom: 0.5rem;">No attraction ideas yet</h3>
                        <p style="margin-bottom: 1rem;">Get AI suggestions for local places near your property</p>
                        <button class="btn" onclick="openAttractionIdeasWizard()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"> Suggest Places</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                    ${filtered.map(s => {
                        // Category display mapping
                        const catLabels = {
                            'museums': ' Museums',
                            'landmarks': ' Landmarks',
                            'parks': ' Parks',
                            'beaches': ' Beaches',
                            'entertainment': ' Entertainment',
                            'shopping': ' Shopping',
                            'restaurants': ' Restaurants',
                            'cafes': ' Cafes',
                            'nightlife': ' Nightlife',
                            'sports': ' Sports',
                            'nature': ' Nature',
                            'family': ' Family'
                        };
                        const catLabel = catLabels[s.category] || (s.category ? ' ' + s.category : ' Idea');
                        return `
                        <div class="card" style="padding: 1.25rem; border-left: 4px solid #f59e0b;">
                            <span style="background: #fef3c7; color: #b45309; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">
                                ${catLabel}
                            </span>
                            <h4 style="margin: 0.75rem 0 0.5rem; font-size: 1rem; line-height: 1.4;">${escapeHtml(s.title)}</h4>
                            ${s.description ? `<p style="color: #64748b; font-size: 0.875rem; margin: 0 0 0.75rem; line-height: 1.4;">${escapeHtml(s.description.substring(0, 100))}${s.description.length > 100 ? '...' : ''}</p>` : ''}
                            ${s.property_name ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.75rem;"> ${escapeHtml(s.property_name)}</p>` : ''}
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small" onclick="createAttractionFromIdea(${s.id})" style="flex: 1; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                     Add This Place
                                </button>
                                <button class="btn btn-small" onclick="dismissAttractionIdea(${s.id})" style="background: #fee2e2; color: #dc2626; border: none;">
                                    
                                </button>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        }
        
        async function loadAttractions(propertyId, clientId) {
            try {
                let url = '/api/admin/attractions';
                const params = [];
                if (clientId) params.push(`client_id=${clientId}`);
                if (propertyId) params.push(`property_id=${propertyId}`);
                if (params.length > 0) url += '?' + params.join('&');
                
                const response = await fetch(url, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.attractions) {
                    attractions.drafts = data.attractions.filter(a => !a.is_published && !a.scheduled_at);
                    attractions.scheduled = data.attractions.filter(a => !a.is_published && a.scheduled_at);
                    attractions.published = data.attractions.filter(a => a.is_published);
                }
                
                renderAttractions();
            } catch (error) {
                console.error('Error loading attractions:', error);
            }
        }
        
        function renderAttractions() {
            const items = attractions[currentAttractionTab] || [];
            const container = document.getElementById(`attraction-${currentAttractionTab}-list`);
            if (!container) return;
            
            const searchQuery = document.getElementById('attractions-search')?.value?.toLowerCase() || '';
            let filtered = items;
            if (searchQuery) {
                filtered = items.filter(a => 
                    a.name?.toLowerCase().includes(searchQuery) ||
                    a.description?.toLowerCase().includes(searchQuery)
                );
            }
            
            if (!filtered.length) {
                const messages = {
                    drafts: { icon: 'ðŸ“', title: 'No drafts', desc: 'Attractions you\'re working on will appear here' },
                    scheduled: { icon: 'ðŸ“…', title: 'Nothing scheduled', desc: 'Schedule attractions to publish automatically' },
                    published: { icon: 'âœ…', title: 'No published attractions', desc: 'Your live attractions will appear here' }
                };
                const msg = messages[currentAttractionTab] || messages.drafts;
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">${msg.icon}</div>
                        <h3 style="margin-bottom: 0.5rem;">${msg.title}</h3>
                        <p>${msg.desc}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Distance</th>
                                <th>Property</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map(a => `
                                <tr>
                                    <td><strong>${escapeHtml(a.name)}</strong></td>
                                    <td>${escapeHtml(a.category || '-')}</td>
                                    <td>${escapeHtml(a.distance_text || '-')}</td>
                                    <td>${escapeHtml(a.property_name || '-')}</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="editAttraction(${a.id})">Edit</button>
                                        ${currentAttractionTab === 'drafts' ? `<button class="btn btn-small" onclick="publishAttraction(${a.id})" style="background: #10b981;">Publish</button>` : ''}
                                        ${currentAttractionTab === 'scheduled' ? `<button class="btn btn-small" onclick="publishAttraction(${a.id})" style="background: #10b981;">Publish Now</button>` : ''}
                                        <button class="btn btn-small" onclick="deleteAttractionById(${a.id})" style="background: #ef4444;">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        async function updateAttractionCounts(propertyId, clientId) {
            // Ideas count
            try {
                const params = [];
                if (clientId) params.push(`client_id=${clientId}`);
                if (propertyId) params.push(`property_id=${propertyId}`);
                params.push('content_type=attraction');
                params.push('status=active');
                
                const ideasRes = await fetch('/api/admin/content-ideas?' + params.join('&'), { headers: authHeaders() });
                const ideasData = await ideasRes.json();
                document.getElementById('attraction-count-ideas').textContent = ideasData.ideas?.length || 0;
            } catch (e) {}
            
            // Attractions counts - always fetch fresh
            try {
                let url = '/api/admin/attractions';
                const params = [];
                if (clientId) params.push(`client_id=${clientId}`);
                if (propertyId) params.push(`property_id=${propertyId}`);
                if (params.length > 0) url += '?' + params.join('&');
                
                const response = await fetch(url, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.attractions) {
                    attractions.drafts = data.attractions.filter(a => !a.is_published && !a.scheduled_at);
                    attractions.scheduled = data.attractions.filter(a => !a.is_published && a.scheduled_at);
                    attractions.published = data.attractions.filter(a => a.is_published);
                }
                
                document.getElementById('attraction-count-drafts').textContent = attractions.drafts?.length || 0;
                document.getElementById('attraction-count-scheduled').textContent = attractions.scheduled?.length || 0;
                document.getElementById('attraction-count-published').textContent = attractions.published?.length || 0;
            } catch (e) {
                console.error('Error updating attraction counts:', e);
            }
        }
        
        function filterAttractions() {
            if (currentAttractionTab === 'ideas') {
                renderAttractionIdeas();
            } else {
                renderAttractions();
            }
        }
        
        // Alias functions for compatibility
        async function createAttractionFromIdea(ideaId) {
            await createAttractionFromSuggestion(ideaId);
        }
        
        async function dismissAttractionIdea(ideaId) {
            await dismissAttractionSuggestion(ideaId);
        }
        
        // Attraction Ideas Wizard
        async function openAttractionIdeasWizard() {
            selectedAttractionCategory = '';
            document.querySelectorAll('#attraction-ideas-wizard .wizard-option-small').forEach(o => o.classList.remove('selected'));
            document.getElementById('attraction-wizard-loading').style.display = 'none';
            document.getElementById('attraction-wizard-results').style.display = 'none';
            document.getElementById('attraction-wizard-footer').style.display = 'flex';
            document.getElementById('attraction-wizard-generate-btn').disabled = true;
            document.querySelectorAll('#attraction-ideas-wizard .form-group').forEach(g => g.style.display = 'block');
            
            // Populate properties
            const select = document.getElementById('attraction-wizard-property');
            select.innerHTML = '<option value="">Choose a property...</option>';
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
                    });
                }
            } catch (e) {}
            
            const filterProp = document.getElementById('attractions-property-select')?.value;
            if (filterProp) select.value = filterProp;
            
            document.getElementById('attraction-ideas-wizard').style.display = 'flex';
        }
        
        function closeAttractionIdeasWizard() {
            document.getElementById('attraction-ideas-wizard').style.display = 'none';
            // Switch to Ideas tab to show the newly generated ideas
            switchAttractionTab('ideas');
        }
        
        function selectAttractionCategory(category) {
            selectedAttractionCategory = category;
            
            document.querySelectorAll('#attraction-ideas-wizard .wizard-option-small').forEach(o => {
                const radio = o.querySelector('input[type="radio"]');
                if (radio && radio.value === category) {
                    o.classList.add('selected');
                    radio.checked = true;
                } else {
                    o.classList.remove('selected');
                }
            });
            
            // Enable button if property selected
            const property = document.getElementById('attraction-wizard-property').value;
            document.getElementById('attraction-wizard-generate-btn').disabled = !property;
        }
        
        async function generateAttractionIdeas() {
            const propertyId = document.getElementById('attraction-wizard-property').value;
            
            if (!propertyId || !selectedAttractionCategory) {
                showNotification('Please select property and category', 'error');
                return;
            }
            
            // Show loading state in wizard
            const wizardFooter = document.getElementById('attraction-wizard-footer');
            const wizardLoading = document.getElementById('attraction-wizard-loading');
            document.querySelectorAll('#attraction-ideas-wizard .form-group').forEach(g => g.style.display = 'none');
            if (wizardFooter) wizardFooter.style.display = 'none';
            if (wizardLoading) wizardLoading.style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/content-ideas/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        property_id: propertyId,
                        content_type: 'attraction',
                        category: selectedAttractionCategory,
                        count: 5,
                        client_id: getClientId()
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.ideas?.length > 0) {
                    // Just close wizard and refresh Ideas tab - ideas are saved to DB by the API
                    closeAttractionIdeasWizard();
                    showNotification(` Found ${data.ideas.length} places!`, 'success');
                    
                    // Switch to Ideas tab to show the new ideas
                    switchAttractionTab('ideas');
                    loadAttractionsByTab();
                } else {
                    closeAttractionIdeasWizard();
                    showNotification(data.error || 'Failed to find places', 'error');
                }
            } catch (error) {
                console.error('Generate attraction ideas error:', error);
                closeAttractionIdeasWizard();
                showNotification('Error generating suggestions', 'error');
            }
        }
        
        // Silent version that creates attraction without opening modal
        async function createAttractionFromIdeaSilent(idea, propertyId) {
            const clientId = getClientId();
            
            // First generate AI details
            const aiResponse = await fetch('/api/admin/attractions/ai-generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                body: JSON.stringify({
                    name: idea.title,
                    short_description: idea.description || '',
                    property_id: propertyId,
                    category: selectedAttractionCategory
                })
            });
            
            const aiData = await aiResponse.json();
            
            // Create the attraction
            const attractionData = {
                name: idea.title,
                slug: idea.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, ''),
                property_id: propertyId,
                client_id: clientId,
                category: selectedAttractionCategory,
                short_description: idea.description || '',
                description: aiData.success ? aiData.description : (idea.description || ''),
                address: aiData.success ? aiData.address : '',
                website_url: aiData.success ? aiData.website_url : '',
                google_maps_url: aiData.success ? aiData.google_maps_url : '',
                price_range: aiData.success ? aiData.price_range : '',
                distance_text: aiData.success ? aiData.distance_text : '',
                duration: aiData.success ? aiData.duration : '',
                is_published: false,
                content_idea_id: idea.id
            };
            
            const response = await fetch('/api/admin/attractions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                body: JSON.stringify(attractionData)
            });
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Creation failed');
            }
            
            // Mark idea as used
            try {
                await fetch(`/api/admin/content-ideas/${idea.id}/use`, {
                    method: 'PUT',
                    headers: authHeaders()
                });
            } catch (e) {}
            
            return data;
        }
        
        function resetAttractionWizard() {
            document.querySelectorAll('#attraction-ideas-wizard .form-group').forEach(g => g.style.display = 'block');
            document.getElementById('attraction-wizard-results').style.display = 'none';
            document.getElementById('attraction-wizard-footer').style.display = 'flex';
        }
        
        async function selectAttractionFromWizard(ideaId) {
            closeAttractionIdeasWizard();
            await createAttractionFromSuggestion(ideaId);
        }
        
        async function createAttractionFromSuggestion(ideaId) {
            // Find in suggestions or fetch
            let suggestion = attractionIdeas.find(s => s.id === ideaId);
            
            if (!suggestion) {
                // May have just been generated, fetch it
                try {
                    const response = await fetch(`/api/admin/content-ideas/${ideaId}`, { headers: authHeaders() });
                    const data = await response.json();
                    if (data.success) suggestion = data.idea;
                } catch (e) {}
            }
            
            if (!suggestion) {
                showNotification('Could not find suggestion', 'error');
                return;
            }
            
            // Open attraction modal with pre-filled data
            await openAttractionModal();
            
            document.getElementById('attraction-name').value = suggestion.title || '';
            document.getElementById('attraction-short-desc').value = suggestion.description || '';
            if (suggestion.property_id) {
                document.getElementById('attraction-property-id').value = suggestion.property_id;
            }
            // Set category from the suggestion (stored when idea was generated)
            if (suggestion.category) {
                document.getElementById('attraction-category').value = suggestion.category;
            }
            document.getElementById('attraction-content-idea-id').value = suggestion.id;
            
            // Auto-trigger AI fill
            showNotification('Loading AI details...', 'info');
            setTimeout(() => aiGenerateAttractionDetails(), 300);
        }
        
        async function dismissAttractionSuggestion(ideaId) {
            if (!confirm('Remove this suggestion?')) return;
            
            try {
                await fetch(`/api/admin/content-ideas/${ideaId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                loadAttractionsByTab();
            } catch (e) {
                console.error('Error dismissing suggestion:', e);
            }
        }
        
        async function deleteAttractionById(id) {
            if (!confirm('Delete this attraction?')) return;
            
            try {
                const response = await fetch(`/api/admin/attractions/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Attraction deleted', 'success');
                    loadAttractionsByTab();
                }
            } catch (e) {
                console.error('Error deleting attraction:', e);
            }
        }
        
        async function publishAttraction(id) {
            try {
                const response = await fetch(`/api/admin/attractions/${id}/publish`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Attraction published!', 'success');
                    loadAttractionsByTab();
                } else {
                    showNotification('Error publishing: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error publishing:', error);
                showNotification('Error publishing attraction', 'error');
            }
        }
        
        // Keep AI generate attraction details function
        async function aiGenerateAttractionDetails() {
            const name = document.getElementById('attraction-name').value.trim();
            const propertyId = document.getElementById('attraction-property-id').value;
            
            if (!name) {
                showNotification('Enter an attraction name first', 'error');
                return;
            }
            
            let propertyName = '';
            let propertyCity = '';
            if (propertyId) {
                try {
                    const propResponse = await fetch(`/api/db/properties/${propertyId}`);
                    const propData = await propResponse.json();
                    if (propData.success && propData.data) {
                        propertyName = propData.data.name || '';
                        propertyCity = propData.data.city || '';
                    }
                } catch (e) {}
            }
            
            const btn = document.querySelector('[onclick="aiGenerateAttractionDetails()"]');
            if (!btn) return;
            const originalText = btn.innerHTML;
            btn.innerHTML = ' Generating, please wait...';
            btn.disabled = true;
            
            // Disable form inputs while generating
            const form = document.getElementById('attraction-form');
            const inputs = form.querySelectorAll('input, textarea, select, button');
            inputs.forEach(i => i.disabled = true);
            btn.disabled = true; // Re-disable the button
            
            try {
                const response = await fetch('/api/admin/attractions/ai-generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        attraction_name: name,
                        property_name: propertyName,
                        property_city: propertyCity
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.attraction) {
                    const a = data.attraction;
                    
                    if (!document.getElementById('attraction-short-desc').value && a.short_description) {
                        document.getElementById('attraction-short-desc').value = a.short_description;
                    }
                    if (!document.getElementById('attraction-description').value && a.description) {
                        document.getElementById('attraction-description').value = a.description;
                    }
                    if (!document.getElementById('attraction-category').value && a.category) {
                        document.getElementById('attraction-category').value = a.category;
                    }
                    if (!document.getElementById('attraction-distance').value && a.distance) {
                        document.getElementById('attraction-distance').value = a.distance;
                    }
                    if (!document.getElementById('attraction-address').value && a.address) {
                        document.getElementById('attraction-address').value = a.address;
                    }
                    if (!document.getElementById('attraction-website').value && a.website) {
                        document.getElementById('attraction-website').value = a.website;
                    }
                    if (!document.getElementById('attraction-price').value && a.price_range) {
                        document.getElementById('attraction-price').value = a.price_range;
                    }
                    if (!document.getElementById('attraction-duration').value && a.duration) {
                        document.getElementById('attraction-duration').value = a.duration;
                    }
                    if (a.meta_title) {
                        document.getElementById('attraction-meta-title').value = a.meta_title;
                    }
                    if (a.meta_description) {
                        document.getElementById('attraction-meta-description').value = a.meta_description;
                    }
                    if (a.faq_schema) {
                        const schemaScript = '<scr' + 'ipt type="application/ld+json">\n' + JSON.stringify(a.faq_schema, null, 2) + '\n<\/scr' + 'ipt>';
                        document.getElementById('attraction-faq-schema').value = schemaScript;
                    }
                    
                    showNotification('AI details loaded!', 'success');
                } else {
                    showNotification(data.error || 'AI generation failed', 'error');
                }
            } catch (error) {
                console.error('AI generate error:', error);
                showNotification('Error generating details', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                // Re-enable form inputs
                const form = document.getElementById('attraction-form');
                const inputs = form.querySelectorAll('input, textarea, select, button');
                inputs.forEach(i => i.disabled = false);
            }
        }
        
        // =====================================================
        // BLOG EDITOR FUNCTIONS
        // =====================================================
        
        async function openBlogEditor(keyword = '', propertyId = null, ideaId = null) {
            // Open the AI blog modal with pre-filled values
            await openAiBlogModal(keyword, propertyId);
            
            // Store the idea ID to mark as used when saved
            if (ideaId) {
                const propertyIdEl = document.getElementById('ai-blog-property-id');
                if (propertyIdEl) {
                    propertyIdEl.dataset.contentIdeaId = ideaId;
                }
            }
        }
        
        async function editBlogPost(postId) {
            try {
                const response = await fetch(`/api/admin/blog/${postId}`, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.post) {
                    openBlogModal(data.post);
                } else {
                    showNotification('Could not load post', 'error');
                }
            } catch (e) {
                console.error('Error loading blog post:', e);
                showNotification('Error loading post', 'error');
            }
        }
        
        async function publishBlogPost(postId) {
            try {
                const response = await fetch(`/api/admin/blog/${postId}/publish`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Blog post published!', 'success');
                    loadBlogByTab();
                } else {
                    showNotification(data.error || 'Failed to publish', 'error');
                }
            } catch (e) {
                console.error('Error publishing:', e);
                showNotification('Error publishing post', 'error');
            }
        }

        async function loadAppAttractions() {
            // Populate property dropdown first using standard pattern
            await loadAttractionsPropertySelect();
            
            try {
                const propertyId = document.getElementById('attractions-property-select')?.value || '';
                let url = `/api/admin/attractions?client_id=${getClientId()}`;
                if (propertyId) {
                    url += `&property_id=${propertyId}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                const container = document.getElementById('app-attractions-list');
                if (!container) return;
                
                if (data.success && data.attractions && data.attractions.length > 0) {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                            ${data.attractions.map(attr => `
                                <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer; background: white;" onclick="editAttraction(${attr.id})">
                                    ${attr.featured_image_url ? 
                                        `<img src="${attr.featured_image_url}" style="width: 100%; height: 150px; object-fit: cover;">` :
                                        `<div style="width: 100%; height: 150px; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; font-size: 3rem;"></div>`
                                    }
                                    <div style="padding: 1rem;">
                                        <h4 style="margin: 0 0 0.5rem;">${attr.name}</h4>
                                        <p style="color: #64748b; font-size: 0.85rem; margin: 0;">
                                            ${attr.category ? ` ${attr.category}` : ''}
                                            ${attr.distance_text ? `  ${attr.distance_text}` : ''}
                                        </p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                            <h3 style="margin-bottom: 0.5rem;">No attractions yet</h3>
                            <p>Add local attractions to help guests explore the area</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openAttractionModal()">Add Your First Attraction</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading attractions:', error);
            }
        }
        
        async function loadAttractionsPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('attractions-property-select');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">All Properties</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                if (currentValue) select.value = currentValue;
            } catch (error) {
                console.error('Error loading properties for attractions:', error);
            }
        }

        // =====================================================
        // SEO ANALYTICS FUNCTIONS
        // =====================================================

        async function loadSeoSites() {
            try {
                // Pass account_id to filter sites
                let url = '/api/admin/seo/sites';
                const isMaster = currentAccount && currentAccount.role === 'master_admin';
                
                // If viewing as a specific client (selectedAccountId), filter to that account
                // Or if non-master user, filter to their own account
                if (selectedAccountId) {
                    url += `?account_id=${selectedAccountId}`;
                } else if (!isMaster && currentAccount && currentAccount.id) {
                    url += `?account_id=${currentAccount.id}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                const select = document.getElementById('seo-site-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select a verified site...</option>';
                
                if (data.success && data.sites) {
                    data.sites.forEach(site => {
                        select.innerHTML += `<option value="${site.url}">${site.url}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading SEO sites:', error);
            }
        }

        async function deleteSeoSite() {
            const siteUrl = document.getElementById('seo-site-select')?.value;
            if (!siteUrl) {
                showNotification('Please select a site first', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to remove "${siteUrl}" from Search Console and GA4?\n\nThis will:\n Remove from Google Search Console\n Optionally delete GA4 property\n\nThe website itself will NOT be deleted.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/seo/remove-site', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ site_url: siteUrl })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Site removed from Search Console', 'success');
                    loadSeoSites(); // Refresh dropdown
                } else {
                    showNotification('Error: ' + (data.error || 'Failed to remove site'), 'error');
                }
            } catch (error) {
                console.error('Delete SEO site error:', error);
                showNotification('Error removing site', 'error');
            }
        }

        async function loadSeoData() {
            const siteUrl = document.getElementById('seo-site-select')?.value;
            if (!siteUrl) return;
            
            const days = document.getElementById('seo-period-select')?.value || 28;
            const endDate = new Date().toISOString().split('T')[0];
            const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            // Load all data in parallel
            await Promise.all([
                loadSeoSummary(siteUrl, startDate, endDate),
                loadSeoKeywords(siteUrl, startDate, endDate),
                loadSeoPages(siteUrl, startDate, endDate),
                loadSeoOpportunities(siteUrl)
            ]);
        }

        async function loadSeoSummary(siteUrl, startDate, endDate) {
            try {
                const response = await fetch(`/api/admin/seo/summary?site_url=${encodeURIComponent(siteUrl)}&start_date=${startDate}&end_date=${endDate}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('seo-total-clicks').textContent = data.current.clicks.toLocaleString();
                    document.getElementById('seo-total-impressions').textContent = data.current.impressions.toLocaleString();
                    document.getElementById('seo-avg-ctr').textContent = data.current.ctr + '%';
                    document.getElementById('seo-avg-position').textContent = data.current.position;
                    
                    // Show change indicators
                    updateChangeIndicator('seo-clicks-change', data.change.clicks, '');
                    updateChangeIndicator('seo-impressions-change', data.change.impressions, '');
                    updateChangeIndicator('seo-ctr-change', data.change.ctr, '%');
                    updateChangeIndicator('seo-position-change', data.change.position, '', true); // Inverted for position
                }
            } catch (error) {
                console.error('Error loading SEO summary:', error);
            }
        }

        function updateChangeIndicator(elementId, value, suffix, inverted = false) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            const numValue = parseFloat(value);
            const isPositive = inverted ? numValue > 0 : numValue > 0;
            const color = isPositive ? '#34a853' : numValue < 0 ? '#ea4335' : '#666';
            const arrow = numValue > 0 ? '' : numValue < 0 ? '' : '';
            
            el.innerHTML = `<span style="color: ${color}">${arrow} ${Math.abs(numValue).toLocaleString()}${suffix}</span>`;
        }

        async function loadSeoKeywords(siteUrl, startDate, endDate) {
            try {
                const response = await fetch(`/api/admin/seo/keywords?site_url=${encodeURIComponent(siteUrl)}&start_date=${startDate}&end_date=${endDate}&limit=50`);
                const data = await response.json();
                
                const container = document.getElementById('seo-keywords-list');
                if (!container) return;
                
                if (data.success && data.keywords && data.keywords.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Keyword</th>
                                    <th style="text-align: right;">Clicks</th>
                                    <th style="text-align: right;">Impressions</th>
                                    <th style="text-align: right;">CTR</th>
                                    <th style="text-align: right;">Position</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.keywords.map(kw => `
                                    <tr>
                                        <td><strong>${escapeHtml(kw.keyword)}</strong></td>
                                        <td style="text-align: right;">${kw.clicks.toLocaleString()}</td>
                                        <td style="text-align: right;">${kw.impressions.toLocaleString()}</td>
                                        <td style="text-align: right;">${kw.ctr}%</td>
                                        <td style="text-align: right;"><span class="badge ${parseFloat(kw.position) <= 10 ? 'badge-success' : 'badge-secondary'}">${kw.position}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <p>No keyword data available yet. Data usually appears 2-3 days after verification.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading keywords:', error);
            }
        }

        async function loadSeoPages(siteUrl, startDate, endDate) {
            try {
                const response = await fetch(`/api/admin/seo/pages?site_url=${encodeURIComponent(siteUrl)}&start_date=${startDate}&end_date=${endDate}&limit=30`);
                const data = await response.json();
                
                const container = document.getElementById('seo-pages-list');
                if (!container) return;
                
                if (data.success && data.pages && data.pages.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Page</th>
                                    <th style="text-align: right;">Clicks</th>
                                    <th style="text-align: right;">Impressions</th>
                                    <th style="text-align: right;">CTR</th>
                                    <th style="text-align: right;">Position</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.pages.map(page => {
                                    const shortUrl = page.page.replace(/^https?:\/\/[^\/]+/, '');
                                    return `
                                        <tr>
                                            <td><a href="${page.page}" target="_blank" style="color: #4285f4;">${shortUrl || '/'}</a></td>
                                            <td style="text-align: right;">${page.clicks.toLocaleString()}</td>
                                            <td style="text-align: right;">${page.impressions.toLocaleString()}</td>
                                            <td style="text-align: right;">${page.ctr}%</td>
                                            <td style="text-align: right;">${page.position}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <p>No page data available yet.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading pages:', error);
            }
        }

        async function loadSeoOpportunities(siteUrl) {
            try {
                const response = await fetch(`/api/admin/seo/opportunities?site_url=${encodeURIComponent(siteUrl)}`);
                const data = await response.json();
                
                const container = document.getElementById('seo-opportunities-list');
                if (!container) return;
                
                if (data.success && data.opportunities && data.opportunities.length > 0) {
                    container.innerHTML = `
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong> ${data.suggestion}</strong>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Keyword</th>
                                    <th style="text-align: right;">Position</th>
                                    <th style="text-align: right;">Impressions</th>
                                    <th style="text-align: right;">Current Clicks</th>
                                    <th style="text-align: right;">Potential</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.opportunities.map(opp => `
                                    <tr>
                                        <td><strong>${escapeHtml(opp.keyword)}</strong></td>
                                        <td style="text-align: right;"><span class="badge badge-warning">#${opp.position}</span></td>
                                        <td style="text-align: right;">${opp.impressions.toLocaleString()}</td>
                                        <td style="text-align: right;">${opp.clicks}</td>
                                        <td style="text-align: right; color: #34a853; font-weight: 600;">+${opp.potential}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #64748b;">
                            <p>No opportunities found yet. Keep building content!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading opportunities:', error);
            }
        }

        function switchSeoTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.seo-tab').forEach(btn => {
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = 'var(--text-secondary)';
                btn.style.fontWeight = 'normal';
            });
            const activeBtn = document.querySelector(`.seo-tab[data-tab="${tab}"]`);
            if (activeBtn) {
                activeBtn.style.borderBottomColor = '#4285f4';
                activeBtn.style.color = '#4285f4';
                activeBtn.style.fontWeight = '600';
            }
            
            // Update explanation text
            const explanations = {
                'keywords': '<strong>Top Keywords:</strong> Search terms people use to find your site. Shows clicks, impressions, and your Google ranking position.',
                'opportunities': '<strong>Opportunities:</strong> Keywords where you rank #5-20 with high search volume. These are your best chances to improve - write a blog post targeting these terms to boost rankings.',
                'pages': '<strong>Top Pages:</strong> Which pages on your site get the most search traffic. Helps you understand what content is working best.'
            };
            const explanationEl = document.getElementById('seo-tab-explanation');
            if (explanationEl && explanations[tab]) {
                explanationEl.innerHTML = explanations[tab];
            }
            
            // Show/hide tab content
            document.querySelectorAll('.seo-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            const activeContent = document.getElementById(`seo-tab-${tab}`);
            if (activeContent) {
                activeContent.style.display = 'block';
            }
        }
        
        function openAiBlogModalFromBlog() {
            // Get selected property from blog property selector
            const propertyId = document.getElementById('blog-property-select')?.value || null;
            openAiBlogModal('', propertyId);
        }
        
        async function openAiBlogModal(keyword, propertyId) {
            // Create modal HTML
            const modalHtml = `
                <div id="ai-blog-modal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                            <h2 style="margin: 0;"> AI Blog Generator</h2>
                            <button class="modal-close" onclick="closeAiBlogModal()" style="color: white;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 1.5rem;">
                            <div id="ai-blog-form">
                                <!-- Property Selector -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: 600;"> Property</label>
                                    <select id="ai-blog-property-id" class="form-input" onchange="loadBlogSuggestions(this.value)">
                                        <option value="">Select a property...</option>
                                    </select>
                                </div>
                                
                                <!-- Topic Suggestions -->
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;"> Suggested Topics</label>
                                    <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 0.75rem;">Click a suggestion or type your own topic below</p>
                                    <div id="ai-blog-suggestions" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem;">
                                        <div style="text-align: center; padding: 1rem; color: #64748b;">Loading suggestions...</div>
                                    </div>
                                </div>
                                
                                <!-- Custom Topic Input -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: 600;"> Your Topic / Keyword</label>
                                    <input type="text" id="ai-blog-keyword" class="form-input" value="${keyword || ''}" placeholder="e.g. Things to do in Blackpool, Pet-friendly beaches..." />
                                </div>
                                
                                <!-- Language and Property -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="font-weight: 600;">Language</label>
                                        <select id="ai-blog-language" class="form-input">
                                            <option value="en">English</option>
                                            <option value="es">Spanish</option>
                                            <option value="de">German</option>
                                            <option value="fr">French</option>
                                            <option value="it">Italian</option>
                                            <option value="nl">Dutch</option>
                                            <option value="pt">Portuguese</option>
                                            <option value="pl">Polish</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600;">Category</label>
                                        <select id="ai-blog-category" class="form-input">
                                            <option value="General">Loading categories...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button class="btn" onclick="generateAiBlog()" id="ai-generate-btn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem;">
                                     Generate Blog Post
                                </button>
                            </div>
                            
                            <div id="ai-blog-loading" style="display: none; text-align: center; padding: 3rem;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                                <h3>AI is writing your blog post...</h3>
                                <p style="color: #64748b;">This usually takes 15-30 seconds</p>
                            </div>
                            
                            <div id="ai-blog-result" style="display: none;">
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: 600;">Title</label>
                                    <input type="text" id="ai-blog-title" class="form-input" />
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: 600;">Excerpt</label>
                                    <textarea id="ai-blog-excerpt" class="form-input" rows="2"></textarea>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: 600;">Content</label>
                                    <textarea id="ai-blog-content" class="form-input" rows="12" style="font-family: monospace;"></textarea>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div>
                                        <label style="font-weight: 600;">Meta Title (SEO)</label>
                                        <input type="text" id="ai-blog-meta-title" class="form-input" maxlength="60" />
                                    </div>
                                    <div>
                                        <label style="font-weight: 600;">Meta Description (SEO)</label>
                                        <input type="text" id="ai-blog-meta-desc" class="form-input" maxlength="160" />
                                    </div>
                                </div>
                                
                                <!-- FAQ Schema -->
                                <div style="margin-bottom: 1rem; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem;">
                                    <label style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                         FAQ Schema (JSON-LD)
                                        <button type="button" class="btn btn-small" onclick="copyFaqSchema()" style="margin-left: auto; padding: 0.25rem 0.5rem; font-size: 0.75rem;"> Copy</button>
                                    </label>
                                    <textarea id="ai-blog-faq-schema" class="form-input" rows="6" style="font-family: monospace; font-size: 0.8rem; background: #f8fafc;" readonly></textarea>
                                    <p style="font-size: 0.75rem; color: #166534; margin-top: 0.5rem;"> Add this to your page's &lt;head&gt; section for rich FAQ snippets in Google</p>
                                </div>
                                
                                <!-- Featured Image -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="font-weight: 600;">Featured Image</label>
                                    <div id="ai-blog-image-preview" style="margin-bottom: 0.5rem; display: none;">
                                        <img id="ai-blog-image-img" src="" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #e5e7eb;" />
                                        <button type="button" onclick="removeAiBlogImage()" style="margin-top: 0.5rem;" class="btn btn-small btn-secondary">Remove Image</button>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="file" id="ai-blog-image-upload" accept="image/*" onchange="handleBlogImageUpload(this)" style="display: none;" />
                                        <button type="button" onclick="document.getElementById('ai-blog-image-upload').click()" class="btn btn-secondary" style="flex: 1;">
                                             Upload Image
                                        </button>
                                        <span style="color: #6b7280;">or</span>
                                        <input type="text" id="ai-blog-image" class="form-input" placeholder="Paste image URL" style="flex: 2;" onchange="previewBlogImageUrl()" />
                                    </div>
                                    <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;"> Upload your own image or paste a URL</p>
                                </div>
                                
                                <!-- Scheduling Options -->
                                <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                    <label style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="ai-blog-schedule" onchange="toggleScheduleOptions()" />
                                         Schedule for later
                                    </label>
                                    <div id="ai-blog-schedule-options" style="display: none; margin-top: 1rem;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div>
                                                <label>Publish Date</label>
                                                <input type="date" id="ai-blog-schedule-date" class="form-input" />
                                            </div>
                                            <div>
                                                <label>Publish Time</label>
                                                <input type="time" id="ai-blog-schedule-time" class="form-input" value="09:00" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 1rem;">
                                    <button class="btn" onclick="saveAiBlog(false)" style="flex: 1;">ðŸ’¾ Save as Draft</button>
                                    <button class="btn" onclick="saveAiBlog(true)" style="flex: 1; background: #10b981;"> Publish</button>
                                    <button class="btn btn-secondary" onclick="showAiBlogForm()" style="flex: 0.5;"> Back</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('ai-blog-modal');
            if (existingModal) existingModal.remove();
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Populate property dropdown, load suggestions, and load categories
            await loadAiBlogPropertyDropdown(propertyId);
            await loadBlogCategories();
        }
        
        async function loadAiBlogPropertyDropdown(selectedPropertyId) {
            const select = document.getElementById('ai-blog-property-id');
            if (!select) return;
            
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                select.innerHTML = '<option value="">Select a property...</option>';
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        const selected = p.id == selectedPropertyId ? 'selected' : '';
                        select.innerHTML += `<option value="${p.id}" ${selected}>${p.name}</option>`;
                    });
                }
                
                // Load suggestions for selected property
                if (selectedPropertyId) {
                    loadBlogSuggestions(selectedPropertyId);
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadBlogSuggestions(propertyId) {
            const container = document.getElementById('ai-blog-suggestions');
            if (!container) return;
            
            if (!propertyId) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 1rem;">Select a property above to see topic suggestions.</p>';
                return;
            }
            
            container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 1rem;">Loading suggestions...</p>';
            
            try {
                let url = '/api/admin/blog/suggestions';
                if (propertyId) url += `?property_id=${propertyId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.suggestions && Object.keys(data.suggestions).length > 0) {
                    const categoryLabels = {
                        'location': ' Location',
                        'regional': ' Regional',
                        'seasonal': ' Seasonal',
                        'amenity': ' Amenities',
                        'intent': ' Intent',
                        'activities': ' Activities',
                        'events': ' Events',
                        'attractions': ' Attractions'
                    };
                    
                    let html = '';
                    
                    // Group suggestions by category
                    for (const [category, suggestions] of Object.entries(data.suggestions)) {
                        html += `
                            <div style="margin-bottom: 0.75rem;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: #64748b; margin-bottom: 0.25rem;">
                                    ${categoryLabels[category] || category}
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                    ${suggestions.map(s => `
                                        <button onclick="selectBlogTopic('${s.topic.replace(/'/g, "\\'")}')" 
                                            style="background: #e0e7ff; color: #4338ca; border: none; padding: 0.35rem 0.75rem; border-radius: 15px; font-size: 0.85rem; cursor: pointer;"
                                            title="${s.description || ''}">${s.topic}</button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Add attraction suggestions if any
                    if (data.attractionSuggestions && data.attractionSuggestions.length > 0) {
                        html += `
                            <div style="margin-bottom: 0.75rem;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: #64748b; margin-bottom: 0.25rem;">
                                     Your Attractions
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                    ${data.attractionSuggestions.map(s => `
                                        <button onclick="selectBlogTopic('${s.topic.replace(/'/g, "\\'")}')" 
                                            style="background: #fef3c7; color: #92400e; border: none; padding: 0.35rem 0.75rem; border-radius: 15px; font-size: 0.85rem; cursor: pointer;">${s.topic}</button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html || '<p style="text-align: center; color: #64748b;">No suggestions available. Type your own topic below.</p>';
                } else {
                    // No templates - show helpful default suggestions
                    container.innerHTML = `
                        <div style="padding: 0.5rem;">
                            <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.75rem;">Quick ideas - click to use:</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                <button onclick="selectBlogTopic('Things to do nearby')" style="background: #e0e7ff; color: #4338ca; border: none; padding: 0.35rem 0.75rem; border-radius: 15px; font-size: 0.85rem; cursor: pointer;">Things to do nearby</button>
                                <button onclick="selectBlogTopic('Best restaurants in the area')" style="background: #e0e7ff; color: #4338ca; border: none; padding: 0.35rem 0.75rem; border-radius: 15px; font-size: 0.85rem; cursor: pointer;">Best restaurants</button>
                                <button onclick="selectBlogTopic('Local attractions guide')" style="background: #e0e7ff; color: #4338ca; border: none; padding: 0.35rem 0.75rem; border-radius: 15px; font-size: 0.85rem; cursor: pointer;">Local attractions</button>
                                <button onclick="selectBlogTopic('Family activities')" style="background: #e0e7ff; color: #4338ca; border: none; padding: 0.35rem 0.75rem; border-radius: 15px; font-size: 0.85rem; cursor: pointer;">Family activities</button>
                                <button onclick="selectBlogTopic('Weekend getaway tips')" style="background: #e0e7ff; color: #4338ca; border: none; padding: 0.35rem 0.75rem; border-radius: 15px; font-size: 0.85rem; cursor: pointer;">Weekend tips</button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading suggestions:', error);
                container.innerHTML = `
                    <div style="padding: 0.5rem;">
                        <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.75rem;">Quick ideas - click to use:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                            <button onclick="selectBlogTopic('Things to do nearby')" style="background: #e0e7ff; color: #4338ca; border: none; padding: 0.35rem 0.75rem; border-radius: 15px; font-size: 0.85rem; cursor: pointer;">Things to do nearby</button>
                            <button onclick="selectBlogTopic('Best restaurants')" style="background: #e0e7ff; color: #4338ca; border: none; padding: 0.35rem 0.75rem; border-radius: 15px; font-size: 0.85rem; cursor: pointer;">Best restaurants</button>
                            <button onclick="selectBlogTopic('Local attractions')" style="background: #e0e7ff; color: #4338ca; border: none; padding: 0.35rem 0.75rem; border-radius: 15px; font-size: 0.85rem; cursor: pointer;">Local attractions</button>
                        </div>
                    </div>
                `;
            }
        }
        
        function selectBlogTopic(topic) {
            const input = document.getElementById('ai-blog-keyword');
            if (input) {
                input.value = topic;
                input.focus();
            }
        }
        
        function toggleScheduleOptions() {
            const checkbox = document.getElementById('ai-blog-schedule');
            const options = document.getElementById('ai-blog-schedule-options');
            if (options) {
                options.style.display = checkbox.checked ? 'block' : 'none';
                if (checkbox.checked) {
                    // Set default date to tomorrow
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    document.getElementById('ai-blog-schedule-date').value = tomorrow.toISOString().split('T')[0];
                }
            }
        }
        
        function copyFaqSchema() {
            const schemaField = document.getElementById('ai-blog-faq-schema');
            if (schemaField && schemaField.value && !schemaField.value.includes('No FAQ')) {
                navigator.clipboard.writeText(schemaField.value);
                showNotification('FAQ Schema copied to clipboard!', 'success');
            } else {
                showNotification('No FAQ schema to copy', 'warning');
            }
        }
        
        function showAiBlogForm() {
            document.getElementById('ai-blog-form').style.display = 'block';
            document.getElementById('ai-blog-result').style.display = 'none';
            document.getElementById('ai-blog-loading').style.display = 'none';
        }
        
        async function handleBlogImageUpload(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                return;
            }
            
            showNotification('Uploading image...', 'info');
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/upload/image', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && data.url) {
                    document.getElementById('ai-blog-image').value = data.url;
                    previewBlogImageUrl();
                    showNotification('Image uploaded!', 'success');
                } else {
                    showNotification(data.error || 'Upload failed', 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Error uploading image', 'error');
            }
        }
        
        function previewBlogImageUrl() {
            const url = document.getElementById('ai-blog-image').value;
            const preview = document.getElementById('ai-blog-image-preview');
            const img = document.getElementById('ai-blog-image-img');
            
            if (url && url.startsWith('http')) {
                img.src = url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }
        
        function removeAiBlogImage() {
            document.getElementById('ai-blog-image').value = '';
            document.getElementById('ai-blog-image-preview').style.display = 'none';
        }
        
        function closeAiBlogModal() {
            const modal = document.getElementById('ai-blog-modal');
            if (modal) modal.remove();
        }
        
        // Load blog categories from API for the AI blog generator
        async function loadBlogCategories() {
            try {
                const select = document.getElementById('ai-blog-category');
                if (!select) return;
                
                const response = await fetch('/api/admin/blog-categories?client_id=' + currentClientId);
                const data = await response.json();
                
                select.innerHTML = '<option value="General">General</option>';
                
                if (data.success && data.categories && data.categories.length > 0) {
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.name;
                        option.textContent = cat.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load blog categories:', error);
            }
        }
        
        async function generateAiBlog() {
            const keyword = document.getElementById('ai-blog-keyword').value;
            const language = document.getElementById('ai-blog-language').value;
            const propertyIdEl = document.getElementById('ai-blog-property-id');
            const propertyId = propertyIdEl.value;
            
            // Get event info if available (from idea)
            const eventDate = propertyIdEl.dataset.eventDate || '';
            const eventLocation = propertyIdEl.dataset.eventLocation || '';
            const eventDescription = propertyIdEl.dataset.eventDescription || '';
            
            if (!propertyId) {
                showNotification('Please select a property', 'error');
                return;
            }
            
            if (!keyword) {
                showNotification('Please enter a topic or select a suggestion', 'error');
                return;
            }
            
            // Show loading
            document.getElementById('ai-blog-form').style.display = 'none';
            document.getElementById('ai-blog-result').style.display = 'none';
            document.getElementById('ai-blog-loading').style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/blog/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyword,
                        language,
                        property_id: propertyId || null,
                        event_date: eventDate || null,
                        event_location: eventLocation || null,
                        event_description: eventDescription || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Fill in the form
                    document.getElementById('ai-blog-title').value = data.blog.title || '';
                    document.getElementById('ai-blog-excerpt').value = data.blog.excerpt || '';
                    document.getElementById('ai-blog-content').value = data.blog.content || '';
                    document.getElementById('ai-blog-meta-title').value = data.blog.meta_title || '';
                    document.getElementById('ai-blog-meta-desc').value = data.blog.meta_description || '';
                    
                    // Fill FAQ schema
                    if (data.blog.faq_schema) {
                        const schemaScript = '<scr' + 'ipt type="application/ld+json">\n' + JSON.stringify(data.blog.faq_schema, null, 2) + '\n<\/scr' + 'ipt>';
                        document.getElementById('ai-blog-faq-schema').value = schemaScript;
                    } else {
                        document.getElementById('ai-blog-faq-schema').value = '(No FAQ schema generated)';
                    }
                    
                    // Store property info for saving
                    document.getElementById('ai-blog-property-id').value = data.blog.property_id || propertyId || '';
                    document.getElementById('ai-blog-property-id').dataset.language = language;
                    document.getElementById('ai-blog-property-id').dataset.faqSchema = JSON.stringify(data.blog.faq_schema || null);
                    // Keep event_date for saving to blog_posts
                    document.getElementById('ai-blog-property-id').dataset.eventDate = eventDate;
                    
                    // Show result
                    document.getElementById('ai-blog-loading').style.display = 'none';
                    document.getElementById('ai-blog-result').style.display = 'block';
                    
                    showNotification('Blog post generated!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to generate blog');
                }
            } catch (error) {
                console.error('AI generation error:', error);
                document.getElementById('ai-blog-loading').style.display = 'none';
                document.getElementById('ai-blog-form').style.display = 'block';
                showNotification('Error generating blog: ' + error.message, 'error');
            }
        }
        
        async function saveAiBlog(publish) {
            const propertyIdEl = document.getElementById('ai-blog-property-id');
            const propertyId = propertyIdEl.value;
            
            // Get client_id from property (always fetch fresh to ensure correct FK)
            let clientId = null;
            if (propertyId) {
                try {
                    const propResponse = await fetch(`/api/db/properties/${propertyId}`);
                    const propData = await propResponse.json();
                    if (propData.success && propData.data) {
                        clientId = propData.data.client_id;
                    }
                } catch (e) {
                    console.error('Could not get client_id from property');
                }
            }
            
            // Fallback to client 1 if no client_id found
            if (!clientId) {
                clientId = 1;
            }
            
            // Get event_date if this came from an event idea
            const eventDate = propertyIdEl.dataset.eventDate || null;
            
            // Handle scheduling
            let scheduledAt = null;
            const scheduleCheckbox = document.getElementById('ai-blog-schedule');
            if (scheduleCheckbox && scheduleCheckbox.checked) {
                const scheduleDate = document.getElementById('ai-blog-schedule-date').value;
                const scheduleTime = document.getElementById('ai-blog-schedule-time').value || '09:00';
                if (scheduleDate) {
                    scheduledAt = new Date(`${scheduleDate}T${scheduleTime}`).toISOString();
                    publish = false; // Scheduled posts are not immediately published
                }
            }
            
            // Get category - from dropdown or from stored idea category
            let blogCategory = document.getElementById('ai-blog-category')?.value;
            if (!blogCategory || blogCategory === 'General') {
                // Check if we have a stored category from the idea
                const storedCategory = propertyIdEl.dataset.ideaCategory;
                if (storedCategory) {
                    // Convert "events_holidays" to "Events & Holidays" or use directly if already formatted
                    if (storedCategory.includes('_')) {
                        blogCategory = storedCategory.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' & ');
                    } else {
                        blogCategory = storedCategory;
                    }
                } else {
                    blogCategory = 'General';
                }
            }
            
            // If publishing and we have an event date, use it as the published_at date
            // This makes event blogs appear in chronological order by event date
            let publishedAt = null;
            if (publish && eventDate) {
                publishedAt = new Date(eventDate).toISOString();
            } else if (publish) {
                publishedAt = new Date().toISOString();
            }
            
            const blogData = {
                title: document.getElementById('ai-blog-title').value,
                slug: document.getElementById('ai-blog-title').value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, ''),
                excerpt: document.getElementById('ai-blog-excerpt').value,
                content: document.getElementById('ai-blog-content').value,
                meta_title: document.getElementById('ai-blog-meta-title').value,
                meta_description: document.getElementById('ai-blog-meta-desc').value,
                category: blogCategory,
                featured_image_url: document.getElementById('ai-blog-image')?.value || null,
                is_published: publish,
                is_featured: false,
                client_id: clientId,
                property_id: propertyId || null,
                scheduled_at: scheduledAt,
                published_at: publishedAt,
                event_date: eventDate,
                ai_generated: true,
                source_keyword: document.getElementById('ai-blog-keyword')?.value || null,
                language: document.getElementById('ai-blog-language')?.value || 'en',
                faq_schema: propertyIdEl.dataset.faqSchema ? JSON.parse(propertyIdEl.dataset.faqSchema) : null
            };
            
            try {
                const response = await fetch('/api/admin/blog', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(blogData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let message = publish ? 'Blog published!' : 'Blog saved as draft';
                    if (scheduledAt) {
                        message = `Blog scheduled for ${new Date(scheduledAt).toLocaleString()}`;
                    }
                    showNotification(message, 'success');
                    
                    // Auto-mark content idea as used if this came from Ideas Library
                    const contentIdeaId = propertyIdEl.dataset.contentIdeaId;
                    if (contentIdeaId) {
                        try {
                            await fetch(`/api/admin/content-ideas/${contentIdeaId}/status`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                                body: JSON.stringify({ status: 'used' })
                            });
                        } catch (e) {
                            console.log('Could not mark idea as used:', e);
                        }
                    }
                    
                    closeAiBlogModal();
                    // Switch to Blog view and refresh
                    showView('app-blog');
                    loadBlogByTab();
                } else {
                    throw new Error(data.error || 'Failed to save blog');
                }
            } catch (error) {
                console.error('Save blog error:', error);
                showNotification('Error saving blog: ' + error.message, 'error');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadSiteHealth() {
            const siteUrl = document.getElementById('seo-site-select')?.value;
            if (!siteUrl) {
                showNotification('Please select a site first', 'error');
                return;
            }
            
            const container = document.getElementById('site-health-results');
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><p> Running PageSpeed analysis... (this takes 10-20 seconds)</p></div>';
            
            try {
                const response = await fetch(`/api/admin/seo/pagespeed?url=${encodeURIComponent(siteUrl)}`);
                const data = await response.json();
                
                if (data.success) {
                    const m = data.mobile;
                    const d = data.desktop;
                    
                    const getScoreColor = (score) => {
                        if (score >= 90) return '#34a853';
                        if (score >= 50) return '#fbbc04';
                        return '#ea4335';
                    };
                    
                    const getScoreLabel = (score) => {
                        if (score >= 90) return 'Excellent';
                        if (score >= 50) return 'Needs Work';
                        return 'Poor';
                    };
                    
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                            <!-- Mobile Scores -->
                            <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 8px;">
                                <h4 style="margin: 0 0 1rem 0;"> Mobile</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; font-weight: bold; color: ${getScoreColor(m.performance)};">${m.performance}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">Performance</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; font-weight: bold; color: ${getScoreColor(m.accessibility)};">${m.accessibility}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">Accessibility</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; font-weight: bold; color: ${getScoreColor(m.bestPractices)};">${m.bestPractices}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">Best Practices</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; font-weight: bold; color: ${getScoreColor(m.seo)};">${m.seo}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">SEO</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Desktop Scores -->
                            <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 8px;">
                                <h4 style="margin: 0 0 1rem 0;"> Desktop</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; font-weight: bold; color: ${getScoreColor(d.performance)};">${d.performance}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">Performance</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; font-weight: bold; color: ${getScoreColor(d.accessibility)};">${d.accessibility}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">Accessibility</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; font-weight: bold; color: ${getScoreColor(d.bestPractices)};">${d.bestPractices}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">Best Practices</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; font-weight: bold; color: ${getScoreColor(d.seo)};">${d.seo}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">SEO</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Verdict -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: ${m.performance >= 70 ? '#d1fae5' : '#fef3c7'}; border-radius: 8px;">
                            <strong>${m.performance >= 70 ? ' Your site is performing well!' : ' Some improvements recommended.'}</strong>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                ${m.performance >= 70 
                                    ? 'If someone contacts you about "fixing" your website speed, they\'re likely trying to sell you something you don\'t need.' 
                                    : 'Consider optimizing images and reducing unused JavaScript for better performance.'}
                            </p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #ea4335;"><p>Error: ${data.error}</p></div>`;
                }
            } catch (error) {
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #ea4335;"><p>Error loading PageSpeed data</p></div>`;
            }
        }

        async function loadGa4Traffic() {
            const siteUrl = document.getElementById('seo-site-select')?.value;
            if (!siteUrl) {
                showNotification('Please select a site first', 'error');
                return;
            }
            
            const container = document.getElementById('ga4-traffic-results');
            container.innerHTML = '<div style="text-align: center; padding: 2rem;"><p> Loading analytics...</p></div>';
            
            try {
                const response = await fetch(`/api/admin/seo/ga4-stats?site_url=${encodeURIComponent(siteUrl)}`);
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="text-align: center; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #4285f4;">${stats.users?.toLocaleString() || 0}</div>
                                <div style="font-size: 0.85rem; color: #64748b;">Users (28 days)</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #34a853;">${stats.sessions?.toLocaleString() || 0}</div>
                                <div style="font-size: 0.85rem; color: #64748b;">Sessions</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #fbbc04;">${stats.pageViews?.toLocaleString() || 0}</div>
                                <div style="font-size: 0.85rem; color: #64748b;">Page Views</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #ea4335;">${stats.avgSessionDuration || '0:00'}</div>
                                <div style="font-size: 0.85rem; color: #64748b;">Avg Duration</div>
                            </div>
                        </div>
                        
                        ${stats.topPages && stats.topPages.length > 0 ? `
                        <h4 style="margin: 0 0 0.75rem 0;"> Top Pages</h4>
                        <table style="font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>Page</th>
                                    <th style="text-align: right;">Views</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stats.topPages.map(p => `
                                    <tr>
                                        <td>${p.page}</td>
                                        <td style="text-align: right;">${p.views?.toLocaleString() || 0}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : ''}
                        
                        ${stats.trafficSources && stats.trafficSources.length > 0 ? `
                        <h4 style="margin: 1.5rem 0 0.75rem 0;"> Traffic Sources</h4>
                        <table style="font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th style="text-align: right;">Sessions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stats.trafficSources.map(s => `
                                    <tr>
                                        <td>${s.source}</td>
                                        <td style="text-align: right;">${s.sessions?.toLocaleString() || 0}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ` : ''}
                    `;
                } else {
                    container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #64748b;"><p>${data.error || 'No data available yet. Analytics data appears 24-48 hours after setup.'}</p></div>`;
                }
            } catch (error) {
                container.innerHTML = `<div style="text-align: center; padding: 2rem; color: #ea4335;"><p>Error loading traffic data</p></div>`;
            }
        }

        // =====================================================
        // BRANDING FUNCTIONS
        // =====================================================

        async function loadBranding() {
            try {
                const response = await fetch(`/api/admin/branding?client_id=${getClientId()}`);
                const data = await response.json();
                
                if (data.success && data.branding) {
                    const b = data.branding;
                    
                    // Logo & Identity
                    document.getElementById('brand-logo-url').value = b.logo_url || '';
                    document.getElementById('brand-logo-dark-url').value = b.logo_dark_url || '';
                    document.getElementById('brand-favicon-url').value = b.favicon_url || '';
                    document.getElementById('brand-og-image-url').value = b.og_image_url || '';
                    document.getElementById('brand-site-title').value = b.site_title || '';
                    document.getElementById('brand-site-description').value = b.site_description || '';
                    
                    // Primary Colors
                    setColorInput('brand-primary-color', b.primary_color || '#2563eb');
                    setColorInput('brand-secondary-color', b.secondary_color || '#7c3aed');
                    setColorInput('brand-accent-color', b.accent_color || '#f59e0b');
                    
                    // Text & Background
                    setColorInput('brand-text-color', b.text_color || '#1e293b');
                    setColorInput('brand-text-light-color', b.text_light_color || '#64748b');
                    setColorInput('brand-background-color', b.background_color || '#ffffff');
                    setColorInput('brand-surface-color', b.surface_color || '#f8fafc');
                    
                    // Header
                    setColorInput('brand-header-bg', b.header_bg_color || '#ffffff');
                    setColorInput('brand-header-text', b.header_text_color || '#1e293b');
                    document.getElementById('brand-header-sticky').checked = b.header_sticky !== false;
                    document.getElementById('brand-header-transparent').checked = b.header_transparent_home || false;
                    
                    // Footer
                    setColorInput('brand-footer-bg', b.footer_bg_color || '#0f172a');
                    setColorInput('brand-footer-text', b.footer_text_color || '#ffffff');
                    setColorInput('brand-footer-link', b.footer_link_color || '#94a3b8');
                    setColorInput('brand-footer-link-hover', b.footer_link_hover_color || '#ffffff');
                    document.getElementById('brand-copyright').value = b.copyright_text || '';
                    
                    // Buttons
                    setColorInput('brand-btn-primary-bg', b.button_primary_bg || b.primary_color || '#2563eb');
                    setColorInput('brand-btn-primary-text', b.button_primary_text || '#ffffff');
                    setColorInput('brand-btn-primary-hover', b.button_primary_hover || '#1d4ed8');
                    setColorInput('brand-btn-secondary-text', b.button_secondary_text || b.primary_color || '#2563eb');
                    setColorInput('brand-btn-secondary-bg', b.button_secondary_bg || '#ffffff');
                    document.getElementById('brand-btn-radius').value = b.button_border_radius || '8px';
                    
                    // Typography
                    document.getElementById('brand-font-heading').value = b.font_heading || 'Inter';
                    document.getElementById('brand-font-body').value = b.font_body || 'Inter';
                    document.getElementById('brand-font-heading-weight').value = b.font_heading_weight || '700';
                    document.getElementById('brand-font-body-weight').value = b.font_body_weight || '400';
                    
                    // Custom CSS
                    document.getElementById('brand-custom-css').value = b.custom_css || '';
                    
                    // Update previews
                    updateBrandingPreviews();
                }
            } catch (error) {
                console.error('Error loading branding:', error);
            }
        }
        
        function setColorInput(baseId, value) {
            const colorInput = document.getElementById(baseId);
            const textInput = document.getElementById(baseId + '-text');
            if (colorInput) colorInput.value = value;
            if (textInput) textInput.value = value;
        }
        
        function updateBrandingPreviews() {
            // Update button previews - check if elements exist first
            const primaryBtn = document.getElementById('preview-btn-primary');
            const secondaryBtn = document.getElementById('preview-btn-secondary');
            const radiusEl = document.getElementById('brand-btn-radius');
            
            // Exit early if branding elements don't exist on this page
            if (!radiusEl) return;
            
            const radius = radiusEl.value;
            
            if (primaryBtn) {
                const bgEl = document.getElementById('brand-btn-primary-bg');
                const textEl = document.getElementById('brand-btn-primary-text');
                if (bgEl) primaryBtn.style.background = bgEl.value;
                if (textEl) primaryBtn.style.color = textEl.value;
                primaryBtn.style.borderRadius = radius;
            }
            
            if (secondaryBtn) {
                const bgEl = document.getElementById('brand-btn-secondary-bg');
                const textEl = document.getElementById('brand-btn-secondary-text');
                if (textEl) {
                    const textColor = textEl.value;
                    if (bgEl) secondaryBtn.style.background = bgEl.value;
                    secondaryBtn.style.color = textColor;
                    secondaryBtn.style.border = '2px solid ' + textColor;
                }
                secondaryBtn.style.borderRadius = radius;
            }
            
            // Update typography preview
            const headingPreview = document.getElementById('preview-heading');
            const bodyPreview = document.getElementById('preview-body');
            
            if (headingPreview) {
                const fontEl = document.getElementById('brand-font-heading');
                const weightEl = document.getElementById('brand-font-heading-weight');
                if (fontEl) headingPreview.style.fontFamily = fontEl.value;
                if (weightEl) headingPreview.style.fontWeight = weightEl.value;
            }
            
            if (bodyPreview) {
                const fontEl = document.getElementById('brand-font-body');
                const weightEl = document.getElementById('brand-font-body-weight');
                if (fontEl) bodyPreview.style.fontFamily = fontEl.value;
                if (weightEl) bodyPreview.style.fontWeight = weightEl.value;
            }
        }

        async function saveBranding() {
            const brandData = {
                client_id: getClientId(),
                // Logo & Identity
                logo_url: document.getElementById('brand-logo-url').value,
                logo_dark_url: document.getElementById('brand-logo-dark-url').value,
                favicon_url: document.getElementById('brand-favicon-url').value,
                og_image_url: document.getElementById('brand-og-image-url').value,
                site_title: document.getElementById('brand-site-title').value,
                site_description: document.getElementById('brand-site-description').value,
                
                // Primary Colors
                primary_color: document.getElementById('brand-primary-color').value,
                secondary_color: document.getElementById('brand-secondary-color').value,
                accent_color: document.getElementById('brand-accent-color').value,
                
                // Text & Background
                text_color: document.getElementById('brand-text-color').value,
                text_light_color: document.getElementById('brand-text-light-color').value,
                background_color: document.getElementById('brand-background-color').value,
                surface_color: document.getElementById('brand-surface-color').value,
                
                // Header
                header_bg_color: document.getElementById('brand-header-bg').value,
                header_text_color: document.getElementById('brand-header-text').value,
                header_sticky: document.getElementById('brand-header-sticky').checked,
                header_transparent_home: document.getElementById('brand-header-transparent').checked,
                
                // Footer
                footer_bg_color: document.getElementById('brand-footer-bg').value,
                footer_text_color: document.getElementById('brand-footer-text').value,
                footer_link_color: document.getElementById('brand-footer-link').value,
                footer_link_hover_color: document.getElementById('brand-footer-link-hover').value,
                copyright_text: document.getElementById('brand-copyright').value,
                
                // Buttons
                button_primary_bg: document.getElementById('brand-btn-primary-bg').value,
                button_primary_text: document.getElementById('brand-btn-primary-text').value,
                button_primary_hover: document.getElementById('brand-btn-primary-hover').value,
                button_secondary_text: document.getElementById('brand-btn-secondary-text').value,
                button_secondary_bg: document.getElementById('brand-btn-secondary-bg').value,
                button_border_radius: document.getElementById('brand-btn-radius').value,
                
                // Typography
                font_heading: document.getElementById('brand-font-heading').value,
                font_body: document.getElementById('brand-font-body').value,
                font_heading_weight: document.getElementById('brand-font-heading-weight').value,
                font_body_weight: document.getElementById('brand-font-body-weight').value,
                
                // Custom CSS
                custom_css: document.getElementById('brand-custom-css').value
            };
            
            try {
                const response = await fetch('/api/admin/branding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(brandData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Branding saved!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving branding:', error);
            }
        }
        
        function previewBranding() {
            alert('Theme preview coming soon! Your changes are saved and will appear on the website immediately.');
        }
        
        // Add event listeners for live preview updates
        document.addEventListener('DOMContentLoaded', function() {
            // Color input sync
            document.querySelectorAll('input[type="color"]').forEach(colorInput => {
                colorInput.addEventListener('input', function() {
                    const textInput = document.getElementById(this.id + '-text');
                    if (textInput) textInput.value = this.value;
                    updateBrandingPreviews();
                });
            });
            
            // Select change handlers for previews
            ['brand-btn-radius', 'brand-font-heading', 'brand-font-body', 'brand-font-heading-weight', 'brand-font-body-weight'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', updateBrandingPreviews);
            });
        });

        // =====================================================
        // API FUNCTIONS
        // =====================================================

        async function loadApiKeys() {
            try {
                const response = await fetch(`/api/admin/api-keys?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('api-keys-list');
                if (!container) return;
                
                if (data.success && data.api_keys && data.api_keys.length > 0) {
                    container.innerHTML = `
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>API Key</th>
                                        <th>Last Used</th>
                                        <th>Requests</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.api_keys.map(key => `
                                        <tr>
                                            <td><strong>${key.key_name}</strong></td>
                                            <td>
                                                <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                                    ${key.api_key.substring(0, 12)}...
                                                </code>
                                                <button onclick="copyToClipboard('${key.api_key}')" style="background: none; border: none; cursor: pointer; margin-left: 0.25rem;"></button>
                                            </td>
                                            <td style="font-size: 0.85rem; color: #64748b;">
                                                ${key.last_used_at ? new Date(key.last_used_at).toLocaleDateString() : 'Never'}
                                            </td>
                                            <td style="font-size: 0.85rem;">${key.total_requests?.toLocaleString() || 0}</td>
                                            <td>
                                                <span class="badge ${key.is_active ? 'badge-success' : 'badge-secondary'}">
                                                    ${key.is_active ? 'Active' : 'Disabled'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="toggleApiKey(${key.id}, ${!key.is_active})">
                                                    ${key.is_active ? 'Disable' : 'Enable'}
                                                </button>
                                                <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #ef4444;" onclick="deleteApiKey(${key.id})">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                            <p>No API keys yet. Create one to access secure endpoints.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }

        // Channel Manager Modal
        function openChannelManagerModal() {
            document.getElementById('channelManagerModal').style.display = 'flex';
            document.addEventListener('keydown', handleChannelManagerEscape);
        }
        
        function handleChannelManagerEscape(e) {
            if (e.key === 'Escape') closeChannelManagerModal();
        }

        function closeChannelManagerModal() {
            document.getElementById('channelManagerModal').style.display = 'none';
            document.removeEventListener('keydown', handleChannelManagerEscape);
        }

        function openApiKeyModal() {
            document.getElementById('api-key-name').value = '';
            document.getElementById('api-key-rate-limit').value = '60';
            document.getElementById('api-key-origins').value = '';
            document.getElementById('api-key-edit-id').value = '';
            document.getElementById('perm-read-rooms').checked = true;
            document.getElementById('perm-read-availability').checked = true;
            document.getElementById('perm-read-pricing').checked = true;
            document.getElementById('perm-read-offers').checked = true;
            document.getElementById('perm-read-content').checked = true;
            document.getElementById('apiKeyModalTitle').textContent = 'Create API Key';
            document.getElementById('apiKeyModal').style.display = 'flex';
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }

        async function saveApiKey() {
            const name = document.getElementById('api-key-name').value;
            if (!name) {
                alert('Please enter a key name');
                return;
            }
            
            const permissions = [];
            if (document.getElementById('perm-read-rooms').checked) permissions.push('read:rooms');
            if (document.getElementById('perm-read-availability').checked) permissions.push('read:availability');
            if (document.getElementById('perm-read-pricing').checked) permissions.push('read:pricing');
            if (document.getElementById('perm-read-offers').checked) permissions.push('read:offers');
            if (document.getElementById('perm-read-content').checked) permissions.push('read:content');
            
            const originsText = document.getElementById('api-key-origins').value;
            const allowed_origins = originsText ? originsText.split(',').map(s => s.trim()).filter(Boolean) : [];
            
            const keyData = {
                client_id: getClientId(),
                key_name: name,
                permissions: permissions,
                rate_limit_per_minute: parseInt(document.getElementById('api-key-rate-limit').value) || 60,
                allowed_origins: allowed_origins
            };
            
            try {
                const response = await fetch('/api/admin/api-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(keyData)
                });
                
                const result = await response.json();
                if (result.success) {
                    closeApiKeyModal();
                    loadApiKeys();
                    
                    // Show the new key
                    alert('API Key Created!\n\nYour new key:\n' + result.api_key.api_key + '\n\nCopy this key now - you won\'t be able to see the full key again.');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating API key:', error);
                alert('Error creating API key');
            }
        }

        async function toggleApiKey(id, newState) {
            try {
                const response = await fetch(`/api/admin/api-keys/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ is_active: newState })
                });
                
                const result = await response.json();
                if (result.success) {
                    loadApiKeys();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error toggling API key:', error);
            }
        }

        async function deleteApiKey(id) {
            if (!confirm('Are you sure you want to delete this API key? Any applications using it will stop working.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/api-keys/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    loadApiKeys();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting API key:', error);
            }
        }

        function showApiTab(tab) {
            // Update buttons
            ['rooms', 'availability', 'pricing', 'offers', 'content'].forEach(t => {
                const btn = document.getElementById('api-tab-' + t);
                if (btn) btn.style.background = t === tab ? 'var(--accent)' : '#64748b';
            });
            
            // Show/hide sections
            document.querySelectorAll('.api-endpoints-section').forEach(el => el.style.display = 'none');
            const section = document.getElementById('api-endpoints-' + tab);
            if (section) section.style.display = 'block';
        }
        
        // Partner API tab functions
        function showPartnerApiTab(tab) {
            ['properties', 'units', 'availability', 'reservations', 'rates'].forEach(t => {
                const btn = document.getElementById('partner-tab-' + t);
                if (btn) btn.style.background = t === tab ? 'var(--accent)' : '#64748b';
            });
            
            document.querySelectorAll('.partner-api-section').forEach(el => el.style.display = 'none');
            const section = document.getElementById('partner-api-' + tab);
            if (section) section.style.display = 'block';
        }
        
        function showWebsiteApiTab(tab) {
            ['websites', 'sections', 'deploy'].forEach(t => {
                const btn = document.getElementById('website-tab-' + t);
                if (btn) btn.style.background = t === tab ? 'var(--accent)' : '#64748b';
            });
            
            document.querySelectorAll('.website-api-section').forEach(el => el.style.display = 'none');
            const section = document.getElementById('website-api-' + tab);
            if (section) section.style.display = 'block';
        }
        
        async function submitPartnerRequest() {
            const company = document.getElementById('partner-company-name').value.trim();
            const contact = document.getElementById('partner-contact-name').value.trim();
            const email = document.getElementById('partner-contact-email').value.trim();
            const website = document.getElementById('partner-website').value.trim();
            const useCase = document.getElementById('partner-use-case').value.trim();
            
            if (!company || !contact || !email) {
                showNotification('Please fill in company name, contact name, and email', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/partner/request-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_name: company,
                        contact_name: contact,
                        contact_email: email,
                        website: website,
                        use_case: useCase
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('partner-request-form').style.display = 'none';
                    document.getElementById('partner-request-success').style.display = 'block';
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error submitting request: ' + error.message, 'error');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Copied!');
            });
        }

        async function testApiConnection() {
            try {
                const response = await fetch('/api/public/client/1/rooms');
                const data = await response.json();
                
                if (data.success) {
                    alert(' API Connection Successful!\n\nFound ' + (data.rooms?.length || 0) + ' rooms.');
                } else {
                    alert(' API Error: ' + data.error);
                }
            } catch (error) {
                alert(' Connection Failed: ' + error.message);
            }
        }

        function copyApiUrl() {
            copyToClipboard(document.getElementById('api-docs-base-url').value);
        }

        // =====================================================
        // KNOWLEDGE BASE FUNCTIONS
        // =====================================================

        async function setupKnowledgeBase() {
            try {
                const response = await fetch('/api/setup-knowledge-base');
                const data = await response.json();
                if (data.success) {
                    showNotification('Knowledge base tables created!', 'success');
                    loadKBArticles();
                    loadKBCategories();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error setting up knowledge base', 'error');
            }
        }

        async function loadKBCategories() {
            try {
                const response = await fetch('/api/kb/categories');
                const data = await response.json();
                if (data.success) {
                    // Populate filter dropdown
                    const filterSelect = document.getElementById('kb-category-filter');
                    const articleSelect = document.getElementById('kb-article-category');
                    
                    if (filterSelect) {
                        filterSelect.innerHTML = '<option value="">All Categories</option>' +
                            data.data.map(c => `<option value="${c.id}">${c.icon || ''} ${c.name} (${c.article_count || 0})</option>`).join('');
                    }
                    
                    if (articleSelect) {
                        articleSelect.innerHTML = '<option value="">Select category...</option>' +
                            data.data.map(c => `<option value="${c.id}">${c.icon || ''} ${c.name}</option>`).join('');
                    }
                    
                    // Update stats
                    document.getElementById('kb-category-count').textContent = data.data.length;
                }
            } catch (error) {
                console.error('Error loading KB categories:', error);
            }
        }

        async function loadKBArticles() {
            try {
                const categoryId = document.getElementById('kb-category-filter')?.value || '';
                const search = document.getElementById('kb-search')?.value || '';
                
                let url = '/api/kb/articles?status=published';
                if (categoryId) url += '&category_id=' + categoryId;
                if (search) url += '&search=' + encodeURIComponent(search);
                
                const response = await fetch(url);
                const data = await response.json();
                
                const tbody = document.getElementById('kb-articles-table');
                if (!tbody) return;
                
                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(article => `
                        <tr>
                            <td>
                                <strong>${article.title}</strong>
                                ${article.summary ? `<br><small style="color: #64748b;">${article.summary.substring(0, 80)}...</small>` : ''}
                            </td>
                            <td>${article.category_icon || ''} ${article.category_name || 'Uncategorized'}</td>
                            <td>
                                <span class="badge ${article.status === 'published' ? 'badge-success' : 'badge-warning'}">
                                    ${article.status}
                                </span>
                            </td>
                            <td>${article.views || 0}</td>
                            <td>
                                <span style="color: var(--success);"> ${article.helpful_yes || 0}</span>
                                <span style="color: #ef4444; margin-left: 0.5rem;"> ${article.helpful_no || 0}</span>
                            </td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editKBArticle(${article.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: #ef4444;" onclick="deleteKBArticle(${article.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                    
                    document.getElementById('kb-article-count').textContent = data.data.length;
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #64748b;">No articles found. Click "Setup Tables" first, then add articles.</td></tr>';
                    document.getElementById('kb-article-count').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading KB articles:', error);
            }
        }

        function openKBArticleModal(articleId = null) {
            document.getElementById('kb-article-id').value = '';
            document.getElementById('kb-article-title').value = '';
            document.getElementById('kb-article-summary').value = '';
            document.getElementById('kb-article-content').value = '';
            document.getElementById('kb-article-keywords').value = '';
            document.getElementById('kb-article-status').value = 'published';
            document.getElementById('kb-article-category').value = '';
            document.getElementById('kb-article-modal-title').textContent = ' Add Knowledge Article';
            
            loadKBCategories();
            openModal('kbArticleModal');
        }

        async function editKBArticle(id) {
            try {
                const response = await fetch('/api/kb/articles/' + id);
                const data = await response.json();
                
                if (data.success) {
                    const article = data.data;
                    document.getElementById('kb-article-id').value = article.id;
                    document.getElementById('kb-article-title').value = article.title;
                    document.getElementById('kb-article-summary').value = article.summary || '';
                    document.getElementById('kb-article-content').value = article.content;
                    document.getElementById('kb-article-keywords').value = (article.keywords || []).join(', ');
                    document.getElementById('kb-article-status').value = article.status;
                    document.getElementById('kb-article-modal-title').textContent = ' Edit Article';
                    
                    await loadKBCategories();
                    document.getElementById('kb-article-category').value = article.category_id || '';
                    
                    openModal('kbArticleModal');
                }
            } catch (error) {
                showNotification('Error loading article', 'error');
            }
        }

        async function saveKBArticle(event) {
            event.preventDefault();
            
            const id = document.getElementById('kb-article-id').value;
            const keywords = document.getElementById('kb-article-keywords').value
                .split(',')
                .map(k => k.trim().toLowerCase())
                .filter(k => k.length > 0);
            
            const articleData = {
                id: id || undefined,
                title: document.getElementById('kb-article-title').value,
                category_id: document.getElementById('kb-article-category').value || null,
                summary: document.getElementById('kb-article-summary').value,
                content: document.getElementById('kb-article-content').value,
                keywords: keywords,
                status: document.getElementById('kb-article-status').value
            };
            
            try {
                const response = await fetch('/api/kb/articles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(articleData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Article saved!', 'success');
                    closeModal('kbArticleModal');
                    loadKBArticles();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving article', 'error');
            }
        }

        async function deleteKBArticle(id) {
            if (!confirm('Delete this article? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/kb/articles/' + id, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Article deleted', 'success');
                    loadKBArticles();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error deleting article', 'error');
            }
        }

        function openKBImportModal() {
            document.getElementById('kb-import-json').value = '';
            document.getElementById('kb-import-result').style.display = 'none';
            openModal('kbImportModal');
        }

        async function importKBArticles() {
            const jsonText = document.getElementById('kb-import-json').value.trim();
            const resultDiv = document.getElementById('kb-import-result');
            
            if (!jsonText) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fef2f2';
                resultDiv.innerHTML = ' Please paste JSON data';
                return;
            }
            
            try {
                const articles = JSON.parse(jsonText);
                
                if (!Array.isArray(articles)) {
                    throw new Error('JSON must be an array');
                }
                
                const response = await fetch('/api/kb/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ articles })
                });
                
                const data = await response.json();
                
                resultDiv.style.display = 'block';
                if (data.success) {
                    resultDiv.style.background = '#f0fdf4';
                    resultDiv.innerHTML = ` Imported ${data.imported} articles` +
                        (data.errors?.length ? `<br> ${data.errors.length} errors` : '');
                    loadKBArticles();
                    loadKBCategories();
                } else {
                    resultDiv.style.background = '#fef2f2';
                    resultDiv.innerHTML = ' ' + data.error;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fef2f2';
                resultDiv.innerHTML = ' Invalid JSON: ' + error.message;
            }
        }

        async function loadKBUnanswered() {
            try {
                const status = document.getElementById('kb-unanswered-filter')?.value || 'new';
                const response = await fetch('/api/kb/unanswered' + (status ? '?status=' + status : ''));
                const data = await response.json();
                
                const container = document.getElementById('kb-unanswered-list');
                const countEl = document.getElementById('kb-unanswered-count');
                const totalEl = document.getElementById('kb-unanswered-total');
                
                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(q => `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <p style="margin: 0 0 0.5rem 0; font-weight: 500;">"${q.question}"</p>
                                    <small style="color: #64748b;">
                                        Asked ${q.times_asked}x  ${new Date(q.created_at).toLocaleDateString()}
                                    </small>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;" onclick="createArticleFromQuestion(${q.id}, '${q.question.replace(/'/g, "\\'")}')">
                                        + Create Article
                                    </button>
                                    <button class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;" onclick="dismissQuestion(${q.id})">
                                        Dismiss
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    if (countEl) countEl.textContent = data.data.length;
                    if (totalEl) totalEl.textContent = data.data.length + ' questions';
                } else {
                    container.innerHTML = '<div class="card" style="text-align: center; padding: 2rem; color: #64748b;">No unanswered questions! </div>';
                    if (countEl) countEl.textContent = '0';
                    if (totalEl) totalEl.textContent = '0 questions';
                }
            } catch (error) {
                console.error('Error loading unanswered:', error);
            }
        }

        function createArticleFromQuestion(questionId, questionText) {
            openKBArticleModal();
            document.getElementById('kb-article-title').value = questionText;
            // Store question ID to resolve after saving
            document.getElementById('kb-article-form').dataset.resolveQuestionId = questionId;
        }

        async function dismissQuestion(id) {
            if (!confirm('Dismiss this question?')) return;
            
            try {
                const response = await fetch('/api/kb/unanswered/' + id, { method: 'DELETE', headers: authHeaders() });
                if (response.ok) {
                    showNotification('Question dismissed', 'success');
                    loadKBUnanswered();
                }
            } catch (error) {
                showNotification('Error dismissing question', 'error');
            }
        }

        // Load KB data when switching to KB views
        const originalNavClick = navClick;
        navClick = function(element, view) {
            originalNavClick(element, view);
            if (view === 'kb-articles') {
                loadKBCategories();
                loadKBArticles();
            } else if (view === 'kb-unanswered') {
                loadKBUnanswered();
            } else if (view === 'billing-overview') {
                loadBillingOverview();
            } else if (view === 'billing-plans') {
                loadBillingPlans();
            } else if (view === 'billing-products') {
                loadBillingProducts();
            } else if (view === 'billing-addons') {
                loadBillingAddons();
            } else if (view === 'billing-subscribers') {
                loadSubscribers();
            } else if (view === 'billing-credits') {
                loadCreditPackages();
            } else if (view === 'billing-extras') {
                loadBillingExtras();
            } else if (view === 'billing-affiliates') {
                loadAffiliatesAdmin();
            } else if (view === 'my-referrals') {
                loadMyReferrals();
            } else if (view === 'my-billing') {
                loadMyBilling();
            }
        };

        // Show admin billing sections for master_admin only
        function updateBillingNavVisibility() {
            // Check both possible storage keys and currentAccount
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || localStorage.getItem('gas_user') || '{}');
            const isMasterAdmin = user.role === 'master_admin';
            
            document.querySelectorAll('.billing-admin-only').forEach(el => {
                if (isMasterAdmin) {
                    // Use appropriate display based on element type
                    if (el.tagName === 'A') {
                        el.style.display = 'flex';
                    } else if (el.tagName === 'BUTTON') {
                        el.style.display = 'inline-flex';
                    } else {
                        el.style.display = 'block';
                    }
                } else {
                    el.style.display = 'none';
                }
            });
        }
        
        // Call on page load (will be called again after auth)
        updateBillingNavVisibility();

        // =====================================================
        // FEATURE ENTITLEMENTS
        // =====================================================
        
        let accountEntitlements = null;
        
        // Load entitlements for the current/selected account
        async function loadAccountEntitlements() {
            const accountId = selectedAccountId || (currentAccount ? currentAccount.id : null);
            
            if (!accountId) {
                // No subscription - lock all premium features
                accountEntitlements = { features: {} };
                applyFeatureLocks();
                return;
            }
            
            try {
                const response = await fetch(`/api/account/${accountId}/entitlements`);
                const data = await response.json();
                
                if (data.success) {
                    accountEntitlements = data;
                } else {
                    accountEntitlements = { features: {} };
                }
            } catch (error) {
                console.error('Error loading entitlements:', error);
                accountEntitlements = { features: {} };
            }
            
            applyFeatureLocks();
        }
        
        // Apply locked state to nav items based on entitlements
        function applyFeatureLocks() {
            const features = accountEntitlements?.features || {};
            const hasPlan = accountEntitlements?.plan != null;
            
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            
            // If master_admin with NO account selected, show everything unlocked
            if (user.role === 'master_admin' && !selectedAccountId) {
                document.querySelectorAll('[data-requires-feature]').forEach(el => {
                    el.classList.remove('feature-locked');
                    const lock = el.querySelector('.feature-lock');
                    if (lock) lock.style.display = 'none';
                    const lockIcon = el.querySelector('.feature-lock-icon');
                    if (lockIcon) lockIcon.style.display = 'none';
                });
                return;
            }
            
            // Otherwise, show locks based on selected account's entitlements
            document.querySelectorAll('[data-requires-feature]').forEach(el => {
                const requiredFeature = el.getAttribute('data-requires-feature');
                
                // Check access based on feature type
                let hasAccess = false;
                if (requiredFeature === 'has_subscription') {
                    hasAccess = hasPlan;
                } else if (requiredFeature === 'api_access') {
                    hasAccess = features.api_access === true;
                } else {
                    hasAccess = features[requiredFeature] === true;
                }
                
                if (hasAccess) {
                    el.classList.remove('feature-locked');
                    const lock = el.querySelector('.feature-lock');
                    if (lock) lock.style.display = 'none';
                    const lockIcon = el.querySelector('.feature-lock-icon');
                    if (lockIcon) lockIcon.style.display = 'none';
                } else {
                    el.classList.add('feature-locked');
                    const lock = el.querySelector('.feature-lock');
                    if (lock) lock.style.display = 'inline';
                    const lockIcon = el.querySelector('.feature-lock-icon');
                    if (lockIcon) lockIcon.style.display = 'inline';
                }
            });
        }
        
        // Handle click on feature-gated nav items
        function handleFeatureClick(element, viewName, featureName) {
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            
            // Master admin with no account selected - always has access
            if (user.role === 'master_admin' && !selectedAccountId) {
                navClick(element, viewName);
                return false;
            }
            
            const features = accountEntitlements?.features || {};
            const hasPlan = accountEntitlements?.plan != null;
            
            // Check access based on feature type
            let hasAccess = false;
            if (featureName === 'has_subscription') {
                hasAccess = hasPlan;
            } else if (featureName === 'api_access') {
                hasAccess = features.api_access === true;
            } else {
                hasAccess = features[featureName] === true;
            }
            
            if (hasAccess) {
                navClick(element, viewName);
            } else {
                // Show upgrade prompt
                const featureNames = {
                    'blog_module': 'Blog Module',
                    'attractions_module': 'Attractions Module', 
                    'reviews_widget': 'Reviews Widget',
                    'has_subscription': 'WordPress Integration',
                    'api_access': 'API Access'
                };
                const planRequired = {
                    'blog_module': 'Professional',
                    'attractions_module': 'Business',
                    'reviews_widget': 'Enterprise',
                    'has_subscription': 'any',
                    'api_access': 'with API access enabled'
                };
                
                const name = featureNames[featureName] || featureName;
                const plan = planRequired[featureName] || 'a higher';
                
                // Different messages based on feature type
                if (user.role === 'master_admin') {
                    if (featureName === 'has_subscription') {
                        showNotification(` This account needs an active subscription for ${name}.`, 'warning', 5000);
                    } else if (featureName === 'api_access') {
                        showNotification(` API Access is not enabled for this account. Enable it in account settings.`, 'warning', 5000);
                    } else {
                        showNotification(` This account doesn't have ${name}. Assign ${plan} plan or above.`, 'warning', 5000);
                    }
                } else {
                    if (featureName === 'has_subscription') {
                        showNotification(` ${name} requires an active subscription. Go to Billing to subscribe.`, 'warning', 5000);
                    } else if (featureName === 'api_access') {
                        showNotification(` API Access is not enabled for your account. Contact support.`, 'warning', 5000);
                    } else {
                        showNotification(` ${name} requires ${plan} plan or above. Go to Billing > Plans & Extras to upgrade.`, 'warning', 5000);
                    }
                }
            }
            return false;
        }
        
        // Call after auth and when account selection changes
        loadAccountEntitlements();

        // =====================================================
        // INSTAWP INTEGRATION
        // =====================================================
        
        let vpsSettingsVisible = false;
        
        function toggleVPSSettings() {
            vpsSettingsVisible = !vpsSettingsVisible;
            document.getElementById('vps-settings-panel').style.display = vpsSettingsVisible ? 'block' : 'none';
            document.getElementById('vps-toggle-text').textContent = vpsSettingsVisible ? 'Hide Settings' : 'Show Settings';
            
            if (vpsSettingsVisible) {
                loadVPSSettings();
            }
        }
        
        async function loadVPSSettings() {
            try {
                const response = await fetch('/api/admin/vps/settings');
                const data = await response.json();
                
                if (data.success && data.data) {
                    if (document.getElementById('vps-api-url')) {
                        document.getElementById('vps-api-url').value = data.data.api_url || 'https://sites.gas.travel/gas-api.php';
                    }
                    document.getElementById('vps-api-key').value = data.data.api_key || '';
                    document.getElementById('vps-default-template').value = data.data.default_template || '';
                    document.getElementById('vps-enabled').checked = data.data.is_enabled || false;
                }
            } catch (error) {
                console.error('Error loading WordPress settings:', error);
            }
        }
        
        async function saveVPSSettings() {
            try {
                const response = await fetch('/api/admin/vps/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        api_url: document.getElementById('vps-api-url')?.value || 'https://sites.gas.travel/gas-api.php',
                        api_key: document.getElementById('vps-api-key').value,
                        default_template: document.getElementById('vps-default-template').value,
                        templates: {},
                        is_enabled: document.getElementById('vps-enabled').checked
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('WordPress hosting settings saved!', 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        }
        
        // Load account website status when WordPress view is shown
        async function loadAccountWebsite() {
            const section = document.getElementById('wp-website-section');
            const noWebsite = document.getElementById('wp-no-website');
            const hasWebsite = document.getElementById('wp-has-website');
            const creating = document.getElementById('wp-website-creating');
            
            // Only show for selected accounts or non-master-admin users
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            const accountId = selectedAccountId || (user.role !== 'master_admin' ? user.id : null);
            
            if (!accountId) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            noWebsite.style.display = 'none';
            hasWebsite.style.display = 'none';
            creating.style.display = 'none';
            
            try {
                const response = await fetch(`/api/account/${accountId}/website`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const website = data.data;
                    
                    if (website.status === 'creating') {
                        creating.style.display = 'block';
                    } else {
                        hasWebsite.style.display = 'block';
                        
                        document.getElementById('wp-website-url').href = website.site_url || '#';
                        document.getElementById('wp-website-url').textContent = website.site_url || '-';
                        document.getElementById('wp-website-admin').href = website.admin_url || '#';
                        document.getElementById('wp-website-template').textContent = website.template_used || '-';
                        document.getElementById('wp-website-visit-btn').href = website.site_url || '#';
                        document.getElementById('wp-website-admin-btn').href = website.admin_url || '#';
                        
                        const statusBadge = document.getElementById('wp-website-status');
                        statusBadge.textContent = website.status;
                        statusBadge.className = 'badge ' + (website.status === 'active' ? 'badge-success' : 'badge-warning');
                    }
                } else {
                    noWebsite.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading website:', error);
                noWebsite.style.display = 'block';
            }
        }
        
        function openCreateWebsiteModal() {
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            const accountId = selectedAccountId || user.id;
            const accountName = selectedAccountName || user.name;
            
            document.getElementById('create-website-account-name').textContent = accountName;
            document.getElementById('create-website-name').value = accountName.toLowerCase().replace(/[^a-z0-9]/g, '');
            updateWebsitePreview();
            
            openModal('createWebsiteModal');
        }
        
        function updateWebsitePreview() {
            const name = document.getElementById('create-website-name').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
            document.getElementById('create-website-preview').textContent = name || 'yoursite';
        }
        
        // Add event listener for site name input
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('create-website-name');
            if (nameInput) {
                nameInput.addEventListener('input', updateWebsitePreview);
            }
        });
        
        async function createWebsite() {
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            const accountId = selectedAccountId || user.id;
            
            const siteName = document.getElementById('create-website-name').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
            const template = document.getElementById('create-website-template').value;
            
            if (!siteName) {
                showNotification('Please enter a site name', 'error');
                return;
            }
            
            const btn = document.getElementById('create-website-btn');
            btn.disabled = true;
            btn.textContent = ' Creating...';
            
            try {
                const response = await fetch('/api/admin/vps/create-site', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: accountId,
                        site_name: siteName,
                        template_slug: template || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(' Website creation started!', 'success');
                    closeModal('createWebsiteModal');
                    loadAccountWebsite();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error creating website', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = ' Create Website';
            }
        }
        
        async function refreshWebsiteStatus() {
            showNotification('Checking website status...', 'info', 2000);
            await loadAccountWebsite();
        }

        // =====================================================
        // PROPERTY PAYMENT SETTINGS
        // =====================================================
        
        let currentPaymentPropertyId = null;
        
        // Open property edit modal focused on Stripe settings
        async function openPropertyStripeSettings(propertyId, propertyName) {
            await editProperty(propertyId);
            // Scroll to Stripe section after modal opens
            setTimeout(() => {
                const stripeSection = document.getElementById('property-stripe-status');
                if (stripeSection) {
                    stripeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight the section briefly
                    stripeSection.style.transition = 'box-shadow 0.3s';
                    stripeSection.style.boxShadow = '0 0 0 3px #6366f1';
                    setTimeout(() => {
                        stripeSection.style.boxShadow = 'none';
                    }, 2000);
                }
            }, 300);
        }

        // Bulk Stripe Setup
        let bulkStripeProperties = [];
        
        async function openBulkStripeModal() {
            // Load properties
            try {
                const queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                const response = await fetch(`/api/db/properties${queryString}`, { headers: authHeaders() });
                const data = await response.json();
                bulkStripeProperties = data.data || [];
                
                const container = document.getElementById('bulk-stripe-properties');
                
                if (bulkStripeProperties.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; padding: 1rem; text-align: center;">No properties found</p>';
                } else {
                    container.innerHTML = bulkStripeProperties.map(prop => `
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s;" 
                               onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                            <input type="checkbox" class="bulk-stripe-checkbox" value="${prop.id}" style="width: 18px; height: 18px;" onchange="updateBulkStripeCount()">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${prop.name || 'Unnamed Property'}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">${prop.city || ''}${prop.city && prop.country ? ', ' : ''}${prop.country || ''}</div>
                            </div>
                            <div style="text-align: right;">
                                ${prop.stripe_secret_key 
                                    ? '<span style="color: #10b981; font-size: 0.8rem;">âœ“ Connected</span>' 
                                    : '<span style="color: #f59e0b; font-size: 0.8rem;">Not connected</span>'}
                            </div>
                        </label>
                    `).join('');
                }
                
                // Reset form
                document.getElementById('bulk-stripe-name').value = '';
                document.getElementById('bulk-stripe-secret').value = '';
                updateBulkStripeCount();
                
                openModal('bulkStripeModal');
            } catch (error) {
                console.error('Error loading properties for bulk Stripe:', error);
                showNotification('Error loading properties', 'error');
            }
        }
        
        function selectAllBulkStripeProperties(select) {
            document.querySelectorAll('.bulk-stripe-checkbox').forEach(cb => cb.checked = select);
            updateBulkStripeCount();
        }
        
        function updateBulkStripeCount() {
            const selected = document.querySelectorAll('.bulk-stripe-checkbox:checked').length;
            document.getElementById('bulk-stripe-selected-count').textContent = `${selected} properties selected`;
        }
        
        async function applyBulkStripe() {
            const stripeName = document.getElementById('bulk-stripe-name').value.trim();
            const secretKey = document.getElementById('bulk-stripe-secret').value.trim();
            
            if (!secretKey) {
                showNotification('Please enter the Restricted Secret Key', 'error');
                return;
            }
            
            const selectedIds = Array.from(document.querySelectorAll('.bulk-stripe-checkbox:checked')).map(cb => parseInt(cb.value));
            
            if (selectedIds.length === 0) {
                showNotification('Please select at least one property', 'error');
                return;
            }
            
            if (!confirm(`Apply Stripe key${stripeName ? ` (${stripeName})` : ''} to ${selectedIds.length} properties?`)) {
                return;
            }
            
            try {
                showNotification('Applying Stripe key...', 'info');
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const propertyId of selectedIds) {
                    try {
                        const response = await fetch(`/api/db/properties/${propertyId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({
                                stripe_name: stripeName || null,
                                stripe_secret_key: secretKey
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (e) {
                        errorCount++;
                    }
                }
                
                closeModal('bulkStripeModal');
                
                if (errorCount === 0) {
                    showNotification(`âœ“ Stripe keys applied to ${successCount} properties`, 'success');
                } else {
                    showNotification(`Applied to ${successCount} properties, ${errorCount} failed`, 'warning');
                }
                
                loadProperties(); // Refresh the list
            } catch (error) {
                console.error('Error applying bulk Stripe:', error);
                showNotification('Error applying Stripe keys', 'error');
            }
        }

        async function openPaymentSettings(propertyId, propertyName) {
            currentPaymentPropertyId = propertyId;
            document.getElementById('payment-settings-property-id').value = propertyId;
            document.getElementById('payment-settings-property-name').textContent = propertyName;
            
            // Reset form
            document.getElementById('payment-provider-stripe').checked = true;
            document.getElementById('stripe-publishable-key').value = '';
            document.getElementById('stripe-secret-key').value = '';
            document.getElementById('stripe-test-mode').checked = false;
            document.getElementById('stripe-keys-status').style.display = 'none';
            document.getElementById('setup-link-result').style.display = 'none';
            document.getElementById('payment-deposit-type').value = 'percentage';
            document.getElementById('payment-deposit-amount').value = 25;
            document.getElementById('payment-balance-days').value = 14;
            document.getElementById('payment-currency').value = 'GBP';
            document.getElementById('payment-cancellation').value = '';
            
            // Get property's account_id
            try {
                const propRes = await fetch(`/api/db/properties/${propertyId}`);
                const propData = await propRes.json();
                if (propData.success) {
                    document.getElementById('payment-settings-account-id').value = propData.data.account_id;
                }
            } catch (e) {
                console.error('Error getting property:', e);
            }
            
            // Load existing payment configuration
            try {
                const response = await fetch(`/api/properties/${propertyId}/payment-configuration`);
                const data = await response.json();
                
                if (data.success && data.configuration) {
                    const config = data.configuration;
                    
                    // Show configured status
                    const statusEl = document.getElementById('stripe-keys-status');
                    if (config.is_enabled) {
                        statusEl.innerHTML = '<span style="color: var(--success);"> Stripe connected and enabled</span>';
                        statusEl.style.background = '#d1fae5';
                        statusEl.style.display = 'block';
                    }
                    
                    // Fill in publishable key (secret is hidden)
                    if (config.credentials?.publishable_key) {
                        document.getElementById('stripe-publishable-key').value = config.credentials.publishable_key;
                        document.getElementById('stripe-secret-key').placeholder = '';
                    }
                    
                    if (config.test_mode) {
                        document.getElementById('stripe-test-mode').checked = true;
                    }
                }
            } catch (error) {
                console.error('Error loading payment config:', error);
            }
            
            // Also load legacy payment settings
            try {
                const response = await fetch(`/api/property/${propertyId}/payment-settings`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const settings = data.data;
                    document.getElementById('payment-deposit-type').value = settings.deposit_type || 'percentage';
                    document.getElementById('payment-deposit-amount').value = settings.deposit_amount || 25;
                    document.getElementById('payment-balance-days').value = settings.balance_due_days || 14;
                    document.getElementById('payment-currency').value = settings.currency || 'GBP';
                    document.getElementById('payment-cancellation').value = settings.cancellation_policy || '';
                    
                    updateDepositSymbol();
                }
            } catch (error) {
                console.error('Error loading payment settings:', error);
            }
            
            openModal('paymentSettingsModal');
        }
        
        function updateDepositSymbol() {
            const type = document.getElementById('payment-deposit-type').value;
            const symbol = document.getElementById('payment-deposit-symbol');
            const amountInput = document.getElementById('payment-deposit-amount');
            
            if (type === 'percentage') {
                symbol.textContent = '%';
                amountInput.max = 100;
            } else if (type === 'fixed') {
                const currency = document.getElementById('payment-currency').value;
                symbol.textContent = currency === 'GBP' ? '' : currency === 'EUR' ? '' : currency === 'USD' ? '$' : currency;
                amountInput.max = 99999;
            } else if (type === 'full' || type === 'none') {
                symbol.textContent = '';
                amountInput.disabled = true;
            }
            
            if (type !== 'full' && type !== 'none') {
                amountInput.disabled = false;
            }
        }
        
        // Add event listener for deposit type change
        document.addEventListener('DOMContentLoaded', function() {
            const depositType = document.getElementById('payment-deposit-type');
            if (depositType) {
                depositType.addEventListener('change', updateDepositSymbol);
            }
            const currencySelect = document.getElementById('payment-currency');
            if (currencySelect) {
                currencySelect.addEventListener('change', updateDepositSymbol);
            }
        });
        
        async function savePaymentSettings() {
            const propertyId = document.getElementById('payment-settings-property-id').value;
            const accountId = document.getElementById('payment-settings-account-id').value;
            
            const publishableKey = document.getElementById('stripe-publishable-key').value.trim();
            const secretKey = document.getElementById('stripe-secret-key').value.trim();
            const testMode = document.getElementById('stripe-test-mode').checked;
            
            // If Stripe keys provided, save to payment_configurations
            if (publishableKey && secretKey) {
                try {
                    const configResponse = await fetch('/api/payment-configurations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({
                            account_id: parseInt(accountId),
                            property_id: parseInt(propertyId),
                            provider: 'stripe',
                            credentials: {
                                publishable_key: publishableKey,
                                secret_key: secretKey
                            },
                            is_enabled: true,
                            is_default: true,
                            test_mode: testMode
                        })
                    });
                    
                    const configData = await configResponse.json();
                    if (!configData.success) {
                        showNotification('Error saving Stripe keys: ' + configData.error, 'error');
                        return;
                    }
                } catch (error) {
                    showNotification('Error saving Stripe configuration', 'error');
                    return;
                }
            }
            
            // Save deposit/payment settings
            const settings = {
                payment_enabled: true,
                deposit_type: document.getElementById('payment-deposit-type').value,
                deposit_amount: parseFloat(document.getElementById('payment-deposit-amount').value) || 25,
                balance_due_days: parseInt(document.getElementById('payment-balance-days').value) || 14,
                currency: document.getElementById('payment-currency').value,
                accepted_methods: ['card'],
                cancellation_policy: document.getElementById('payment-cancellation').value
            };
            
            try {
                const response = await fetch(`/api/property/${propertyId}/payment-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Payment settings saved!', 'success');
                    closeModal('paymentSettingsModal');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        }
        
        async function testStripeConnection() {
            const secretKey = document.getElementById('stripe-secret-key').value.trim();
            const publishableKey = document.getElementById('stripe-publishable-key').value.trim();
            
            if (!secretKey || !publishableKey) {
                showNotification('Please enter both Publishable Key and Secret Key', 'warning');
                return;
            }
            
            const statusEl = document.getElementById('stripe-keys-status');
            statusEl.innerHTML = '<span style="color: #64748b;"> Testing connection...</span>';
            statusEl.style.background = '#f1f5f9';
            statusEl.style.display = 'block';
            
            try {
                // Save temporarily to test
                const propertyId = document.getElementById('payment-settings-property-id').value;
                const accountId = document.getElementById('payment-settings-account-id').value;
                
                const response = await fetch('/api/payment-configurations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: parseInt(accountId),
                        property_id: parseInt(propertyId),
                        provider: 'stripe',
                        credentials: {
                            publishable_key: publishableKey,
                            secret_key: secretKey
                        },
                        is_enabled: false  // Don't enable until explicitly saved
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Now test the connection
                    const testResponse = await fetch(`/api/payment-configurations/${data.configuration.id}/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() }
                    });
                    
                    const testData = await testResponse.json();
                    
                    if (testData.success && testData.test_result?.success) {
                        statusEl.innerHTML = '<span style="color: var(--success);"> Connection successful! Keys are valid.</span>';
                        statusEl.style.background = '#d1fae5';
                    } else {
                        statusEl.innerHTML = `<span style="color: #ef4444;"> ${testData.test_result?.message || testData.error}</span>`;
                        statusEl.style.background = '#fee2e2';
                    }
                } else {
                    statusEl.innerHTML = `<span style="color: #ef4444;"> ${data.error}</span>`;
                    statusEl.style.background = '#fee2e2';
                }
            } catch (error) {
                statusEl.innerHTML = '<span style="color: #ef4444;"> Connection test failed</span>';
                statusEl.style.background = '#fee2e2';
            }
        }
        
        async function generatePaymentSetupLink() {
            const propertyId = document.getElementById('payment-settings-property-id').value;
            const accountId = document.getElementById('payment-settings-account-id').value;
            
            try {
                const response = await fetch('/api/payment-setup-tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: parseInt(accountId),
                        property_id: parseInt(propertyId),
                        provider: 'stripe',
                        expires_hours: 72
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('setup-link-url').value = data.setup_url;
                    document.getElementById('setup-link-result').style.display = 'block';
                    showNotification('Setup link generated!', 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error generating link', 'error');
            }
        }
        
        function copySetupLink() {
            const input = document.getElementById('setup-link-url');
            input.select();
            document.execCommand('copy');
            showNotification('Link copied to clipboard!', 'success');
        }

        // Load client-facing billing page
        async function loadMyBilling() {
            // Load plans
            try {
                const plansRes = await fetch('/api/billing/plans');
                const plansData = await plansRes.json();
                
                const plansContainer = document.getElementById('my-billing-plans');
                if (plansData.success && plansData.data.length > 0) {
                    plansContainer.innerHTML = plansData.data.map(plan => {
                        let features = plan.features;
                        if (typeof features === 'string') {
                            try { features = JSON.parse(features); } catch(e) { features = {}; }
                        }
                        
                        // Handle both old array format and new object format
                        let featuresList = [];
                        if (Array.isArray(features)) {
                            featuresList = features;
                        } else if (features && features.features_list) {
                            featuresList = features.features_list;
                        }
                        
                        const currencySymbol = plan.currency === 'GBP' ? '' : plan.currency === 'EUR' ? '' : '$';
                        return `
                        <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.2rem;">${plan.name}</h4>
                            <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">${plan.description || ''}</p>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent);">
                                ${currencySymbol}${parseFloat(plan.price_monthly).toFixed(2)}
                                <span style="font-size: 0.9rem; font-weight: 400; color: #64748b;">/mo</span>
                            </div>
                            ${plan.price_yearly ? `<div style="font-size: 0.8rem; color: #64748b; margin-bottom: 1rem;">or ${currencySymbol}${parseFloat(plan.price_yearly).toFixed(2)}/year</div>` : '<div style="margin-bottom: 1rem;"></div>'}
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">
                                ${plan.max_properties ? plan.max_properties + ' properties' : 'Unlimited properties'}
                            </div>
                            <ul style="text-align: left; font-size: 0.8rem; color: #64748b; margin: 0 0 1rem 0; padding-left: 1.2rem;">
                                ${featuresList.slice(0, 5).map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <button class="btn" style="width: 100%;" onclick="contactForPlan('${plan.name}')">Get Started</button>
                        </div>
                    `}).join('');
                } else {
                    plansContainer.innerHTML = '<p style="color: #64748b;">No plans available</p>';
                }
            } catch (e) {
                console.error('Error loading plans:', e);
            }
            
            // Load credit packages
            try {
                const creditsRes = await fetch('/api/billing/credit-packages');
                const creditsData = await creditsRes.json();
                
                const creditsContainer = document.getElementById('my-billing-credits');
                if (creditsData.success && creditsData.data.length > 0) {
                    creditsContainer.innerHTML = creditsData.data.map(pkg => {
                        const currencySymbol = pkg.currency === 'GBP' ? '' : pkg.currency === 'EUR' ? '' : '$';
                        const totalCredits = pkg.credits + (pkg.bonus_credits || 0);
                        return `
                        <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1.25rem; text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.25rem;"></div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${totalCredits}</div>
                            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.5rem;">credits</div>
                            ${pkg.bonus_credits > 0 ? `<div style="font-size: 0.75rem; color: var(--success); margin-bottom: 0.5rem;">+${pkg.bonus_credits} bonus!</div>` : ''}
                            <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">${currencySymbol}${parseFloat(pkg.price).toFixed(2)}</div>
                            <button class="btn btn-secondary" style="width: 100%;" onclick="contactForCredits('${pkg.name}')">Buy</button>
                        </div>
                    `}).join('');
                } else {
                    creditsContainer.innerHTML = '<p style="color: #64748b;">No credit packages available</p>';
                }
            } catch (e) {
                console.error('Error loading credits:', e);
            }
            
            // Load extras
            try {
                const extrasRes = await fetch('/api/billing/extras');
                const extrasData = await extrasRes.json();
                
                const extrasContainer = document.getElementById('my-billing-extras');
                if (extrasData.success && extrasData.data.length > 0) {
                    extrasContainer.innerHTML = extrasData.data.map(extra => `
                        <div style="border: 1px solid var(--border); border-radius: 12px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;">${extra.icon || ''}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${extra.name}</div>
                                <div style="font-size: 0.8rem; color: #64748b;">${extra.description || ''}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: 700; color: var(--warning);">${extra.credit_cost}</div>
                                <div style="font-size: 0.7rem; color: #64748b;">credits</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    extrasContainer.innerHTML = '<p style="color: #64748b;">No extras available</p>';
                }
            } catch (e) {
                console.error('Error loading extras:', e);
            }
        }

        // Placeholder functions for purchase actions
        function contactForPlan(planName) {
            alert('To subscribe to the ' + planName + ' plan, please contact us at support@example.com');
        }

        function contactForCredits(packageName) {
            alert('To purchase ' + packageName + ', please contact us at support@example.com');
        }

        // =====================================================
        // BILLING FUNCTIONS
        // =====================================================

        // Show notification toast
        function showNotification(message, type = 'info', duration = 3000) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 400px;
            `;
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            } else if (type === 'warning') {
                notification.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else {
                notification.style.background = 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after duration
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        async function setupBilling() {
            console.log('setupBilling called');
            try {
                const response = await fetch('/api/setup-billing');
                console.log('Response:', response);
                const data = await response.json();
                console.log('Data:', data);
                if (data.success) {
                    showNotification('Billing tables created!', 'success');
                    loadBillingOverview();
                    loadBillingPlans();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Setup billing error:', error);
                showNotification('Error setting up billing: ' + error.message, 'error');
                alert('Error: ' + error.message);
            }
        }

        async function loadBillingOverview() {
            try {
                const response = await fetch('/api/admin/billing/overview');
                const data = await response.json();
                
                // Hide setup button if we have data
                const setupSection = document.getElementById('billing-setup-section');
                if (setupSection) {
                    if (data.success) {
                        setupSection.style.display = 'none';
                    } else {
                        setupSection.style.display = 'block';
                    }
                }
                
                if (data.success) {
                    // Update MRR
                    document.getElementById('billing-mrr').textContent = '' + data.mrr.toFixed(2);
                    
                    // Update active subs count
                    const totalSubs = data.subscriptions_by_plan.reduce((sum, p) => sum + parseInt(p.count), 0);
                    document.getElementById('billing-active-subs').textContent = totalSubs;
                    
                    // Update credits in circulation
                    document.getElementById('billing-credits-circulation').textContent = data.credits?.total_balance || 0;
                    
                    // Subscriptions by plan
                    const subsByPlan = document.getElementById('billing-subs-by-plan');
                    if (data.subscriptions_by_plan.length > 0) {
                        subsByPlan.innerHTML = data.subscriptions_by_plan.map(p => `
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                                <span>${p.name}</span>
                                <span><strong>${p.count}</strong> subscribers  ${parseFloat(p.price_monthly).toFixed(2)} = <strong>${parseFloat(p.mrr).toFixed(2)}</strong>/mo</span>
                            </div>
                        `).join('');
                    } else {
                        subsByPlan.innerHTML = '<p style="color: #64748b;">No active subscriptions yet</p>';
                    }
                    
                    // Recent payments
                    const paymentsTable = document.getElementById('billing-recent-payments');
                    if (data.recent_payments.length > 0) {
                        paymentsTable.innerHTML = data.recent_payments.map(p => `
                            <tr>
                                <td>${p.account_name}</td>
                                <td>${parseFloat(p.amount).toFixed(2)}</td>
                                <td><span class="badge">${p.type}</span></td>
                                <td>${new Date(p.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('');
                    } else {
                        paymentsTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #64748b;">No payments yet</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading billing overview:', error);
            }
        }

        // Plans
        async function loadBillingPlans() {
            try {
                const response = await fetch('/api/admin/billing/plans');
                const data = await response.json();
                
                const container = document.getElementById('billing-plans-list');
                
                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(plan => {
                        let features = plan.features;
                        if (typeof features === 'string') {
                            try { features = JSON.parse(features); } catch(e) { features = {}; }
                        }
                        
                        // Handle both old array format and new object format
                        let featuresList = [];
                        if (Array.isArray(features)) {
                            featuresList = features;
                        } else if (features.features_list) {
                            featuresList = features.features_list;
                        } else {
                            // Build from object
                            if (features.properties) featuresList.push(features.properties === null ? 'Unlimited properties' : features.properties + ' properties');
                            if (features.websites) featuresList.push(features.websites + ' website' + (features.websites > 1 ? 's' : ''));
                            if (features.booking_plugin) featuresList.push('Booking plugin');
                            if (features.blog_module) featuresList.push('Blog module');
                            if (features.attractions_module) featuresList.push('Attractions module');
                            if (features.reviews_widget) featuresList.push('Reviews widget');
                            if (features.support) featuresList.push(features.support.charAt(0).toUpperCase() + features.support.slice(1) + ' support');
                            if (features.free_trial) featuresList.push('14-day free trial');
                            if (features.white_label) featuresList.push('White-label');
                        }
                        
                        return `
                        <div class="card" style="position: relative; ${!plan.is_active ? 'opacity: 0.6;' : ''}">
                            <div style="position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="editPlan(${plan.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: #ef4444;" onclick="deletePlan(${plan.id})"></button>
                            </div>
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem;">${plan.name}</h3>
                            <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">${plan.description || ''}</p>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem;">
                                ${parseFloat(plan.price_monthly).toFixed(2)}<span style="font-size: 1rem; font-weight: 400; color: #64748b;">/mo</span>
                            </div>
                            ${plan.price_yearly ? `<div style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">or ${parseFloat(plan.price_yearly).toFixed(2)}/year</div>` : ''}
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                <strong>Max properties:</strong> ${plan.max_properties || 'Unlimited'}
                            </div>
                            <ul style="font-size: 0.85rem; color: #64748b; margin: 0; padding-left: 1.25rem;">
                                ${featuresList.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            ${!plan.is_active ? '<div style="margin-top: 1rem;"><span class="badge badge-warning">Inactive</span></div>' : ''}
                        </div>
                    `}).join('');
                } else {
                    container.innerHTML = '<div class="card" style="text-align: center; padding: 2rem; color: #64748b;">No plans configured. Click "Setup Billing" in Overview first.</div>';
                }
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }

        function openPlanModal() {
            document.getElementById('plan-id').value = '';
            document.getElementById('plan-name').value = '';
            document.getElementById('plan-slug').value = '';
            document.getElementById('plan-description').value = '';
            document.getElementById('plan-price-monthly').value = '';
            document.getElementById('plan-price-yearly').value = '';
            document.getElementById('plan-currency').value = 'GBP';
            document.getElementById('plan-max-properties').value = '';
            document.getElementById('plan-features').value = '';
            document.getElementById('plan-sort-order').value = '0';
            document.getElementById('plan-is-active').checked = true;
            document.getElementById('plan-modal-title').textContent = ' Add Subscription Plan';
            openModal('billingPlanModal');
        }

        async function editPlan(id) {
            try {
                const response = await fetch('/api/admin/billing/plans');
                const data = await response.json();
                const plan = data.data.find(p => p.id === id);
                
                if (plan) {
                    document.getElementById('plan-id').value = plan.id;
                    document.getElementById('plan-name').value = plan.name;
                    document.getElementById('plan-slug').value = plan.slug;
                    document.getElementById('plan-description').value = plan.description || '';
                    document.getElementById('plan-price-monthly').value = plan.price_monthly;
                    document.getElementById('plan-price-yearly').value = plan.price_yearly || '';
                    document.getElementById('plan-currency').value = plan.currency || 'GBP';
                    document.getElementById('plan-max-properties').value = plan.max_properties || '';
                    document.getElementById('plan-sort-order').value = plan.sort_order || 0;
                    document.getElementById('plan-is-active').checked = plan.is_active;
                    
                    // Handle features - can be array or object with features_list
                    let features = typeof plan.features === 'string' ? JSON.parse(plan.features) : (plan.features || {});
                    let featuresList = [];
                    if (Array.isArray(features)) {
                        featuresList = features;
                    } else if (features.features_list) {
                        featuresList = features.features_list;
                    }
                    document.getElementById('plan-features').value = featuresList.join('\n');
                    
                    document.getElementById('plan-modal-title').textContent = ' Edit Plan';
                    openModal('billingPlanModal');
                }
            } catch (error) {
                console.error('Error editing plan:', error);
                showNotification('Error loading plan', 'error');
            }
        }

        async function savePlan(event) {
            event.preventDefault();
            
            const featuresText = document.getElementById('plan-features').value;
            const featuresList = featuresText.split('\n').map(f => f.trim()).filter(f => f.length > 0);
            
            // Build features object with features_list
            const maxProps = document.getElementById('plan-max-properties').value ? parseInt(document.getElementById('plan-max-properties').value) : null;
            const features = {
                properties: maxProps,
                websites: 1,
                booking_plugin: true,
                features_list: featuresList
            };
            
            const planData = {
                id: document.getElementById('plan-id').value || undefined,
                name: document.getElementById('plan-name').value,
                slug: document.getElementById('plan-slug').value || undefined,
                description: document.getElementById('plan-description').value,
                price_monthly: parseFloat(document.getElementById('plan-price-monthly').value),
                price_yearly: document.getElementById('plan-price-yearly').value ? parseFloat(document.getElementById('plan-price-yearly').value) : null,
                currency: document.getElementById('plan-currency').value,
                max_properties: maxProps,
                features: features,
                sort_order: parseInt(document.getElementById('plan-sort-order').value) || 0,
                is_active: document.getElementById('plan-is-active').checked
            };
            
            try {
                const response = await fetch('/api/admin/billing/plans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(planData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Plan saved!', 'success');
                    closeModal('billingPlanModal');
                    loadBillingPlans();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving plan', 'error');
            }
        }

        async function deletePlan(id) {
            if (!confirm('Delete this plan?')) return;
            
            try {
                const response = await fetch('/api/admin/billing/plans/' + id, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    showNotification('Plan deleted', 'success');
                    loadBillingPlans();
                }
            } catch (error) {
                showNotification('Error deleting plan', 'error');
            }
        }

        // =====================================================
        // PRODUCTS
        // =====================================================
        async function loadBillingProducts() {
            try {
                const response = await fetch('/api/admin/billing/products');
                const data = await response.json();
                
                const tbody = document.getElementById('billing-products-table');
                
                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(p => `
                        <tr style="${!p.is_active ? 'opacity: 0.6;' : ''}">
                            <td>
                                <strong>${p.name}</strong>
                                <div style="font-size: 0.8rem; color: #64748b;">${p.code}</div>
                            </td>
                            <td><span class="badge">${p.category || 'general'}</span></td>
                            <td>${p.price_monthly > 0 ? '' + parseFloat(p.price_monthly).toFixed(2) + '/mo' : '-'}</td>
                            <td>${p.price_yearly > 0 ? '' + parseFloat(p.price_yearly).toFixed(2) + '/yr' : '-'}</td>
                            <td><span class="badge ${p.is_active ? 'badge-success' : 'badge-warning'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editProduct(${p.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: #ef4444;" onclick="deleteProduct(${p.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #64748b;">No products yet. Click "+ Add Product" to create one.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('billing-products-table').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #ef4444;">Error loading products</td></tr>';
            }
        }

        function openProductModal(product = null) {
            document.getElementById('product-modal-title').textContent = product ? ' Edit Product' : ' Add Product';
            document.getElementById('product-id').value = product?.id || '';
            document.getElementById('product-code').value = product?.code || '';
            document.getElementById('product-name').value = product?.name || '';
            document.getElementById('product-description').value = product?.description || '';
            document.getElementById('product-category').value = product?.category || 'general';
            document.getElementById('product-price-monthly').value = product?.price_monthly || '';
            document.getElementById('product-price-yearly').value = product?.price_yearly || '';
            document.getElementById('product-is-active').checked = product?.is_active !== false;
            openModal('productModal');
        }

        async function editProduct(id) {
            try {
                const response = await fetch('/api/admin/billing/products');
                const data = await response.json();
                const product = data.data.find(p => p.id === id);
                if (product) openProductModal(product);
            } catch (error) {
                showNotification('Error loading product', 'error');
            }
        }

        async function saveProduct(event) {
            event.preventDefault();
            
            const id = document.getElementById('product-id').value;
            const productData = {
                code: document.getElementById('product-code').value,
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                category: document.getElementById('product-category').value,
                price_monthly: parseFloat(document.getElementById('product-price-monthly').value) || 0,
                price_yearly: parseFloat(document.getElementById('product-price-yearly').value) || 0,
                is_active: document.getElementById('product-is-active').checked
            };
            
            try {
                const url = id ? `/api/admin/billing/products/${id}` : '/api/admin/billing/products';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                if (data.success) {
                    closeModal('productModal');
                    showNotification(id ? 'Product updated' : 'Product created', 'success');
                    loadBillingProducts();
                } else {
                    showNotification(data.error || 'Error saving product', 'error');
                }
            } catch (error) {
                showNotification('Error saving product', 'error');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Delete this product?')) return;
            try {
                const response = await fetch(`/api/admin/billing/products/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    showNotification('Product deleted', 'success');
                    loadBillingProducts();
                }
            } catch (error) {
                showNotification('Error deleting product', 'error');
            }
        }

        // =====================================================
        // ADD-ONS
        // =====================================================
        async function loadBillingAddons() {
            try {
                const response = await fetch('/api/admin/billing/addons');
                const data = await response.json();
                
                const tbody = document.getElementById('billing-addons-table');
                
                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(a => `
                        <tr style="${!a.is_active ? 'opacity: 0.6;' : ''}">
                            <td>
                                <strong>${a.name}</strong>
                                <div style="font-size: 0.8rem; color: #64748b;">${a.description || ''}</div>
                            </td>
                            <td>${parseFloat(a.price_monthly).toFixed(2)}/mo</td>
                            <td>${a.extra_properties > 0 ? '+' + a.extra_properties : '-'}</td>
                            <td><span class="badge ${a.is_active ? 'badge-success' : 'badge-warning'}">${a.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editAddon(${a.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: #ef4444;" onclick="deleteAddon(${a.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b;">No add-ons yet. Click "+ Add Add-on" to create one.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading addons:', error);
            }
        }

        function openAddonModal(addon = null) {
            document.getElementById('addon-modal-title').textContent = addon ? ' Edit Add-on' : ' Add Add-on';
            document.getElementById('addon-id').value = addon?.id || '';
            document.getElementById('addon-code').value = addon?.code || '';
            document.getElementById('addon-name').value = addon?.name || '';
            document.getElementById('addon-description').value = addon?.description || '';
            document.getElementById('addon-price-monthly').value = addon?.price_monthly || '';
            document.getElementById('addon-extra-properties').value = addon?.extra_properties || '0';
            document.getElementById('addon-is-active').checked = addon?.is_active !== false;
            openModal('addonModal');
        }

        async function editAddon(id) {
            try {
                const response = await fetch('/api/admin/billing/addons');
                const data = await response.json();
                const addon = data.data.find(a => a.id === id);
                if (addon) openAddonModal(addon);
            } catch (error) {
                showNotification('Error loading add-on', 'error');
            }
        }

        async function saveAddon(event) {
            event.preventDefault();
            
            const id = document.getElementById('addon-id').value;
            const addonData = {
                code: document.getElementById('addon-code').value,
                name: document.getElementById('addon-name').value,
                description: document.getElementById('addon-description').value,
                price_monthly: parseFloat(document.getElementById('addon-price-monthly').value) || 0,
                extra_properties: parseInt(document.getElementById('addon-extra-properties').value) || 0,
                is_active: document.getElementById('addon-is-active').checked
            };
            
            try {
                const url = id ? `/api/admin/billing/addons/${id}` : '/api/admin/billing/addons';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(addonData)
                });
                
                const data = await response.json();
                if (data.success) {
                    closeModal('addonModal');
                    showNotification(id ? 'Add-on updated' : 'Add-on created', 'success');
                    loadBillingAddons();
                } else {
                    showNotification(data.error || 'Error saving add-on', 'error');
                }
            } catch (error) {
                showNotification('Error saving add-on', 'error');
            }
        }

        async function deleteAddon(id) {
            if (!confirm('Delete this add-on?')) return;
            try {
                const response = await fetch(`/api/admin/billing/addons/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    showNotification('Add-on deleted', 'success');
                    loadBillingAddons();
                }
            } catch (error) {
                showNotification('Error deleting add-on', 'error');
            }
        }

        // =====================================================
        // SUBSCRIBERS
        // =====================================================
        async function loadSubscribers() {
            const planFilter = document.getElementById('subscribers-filter-plan')?.value || '';
            const statusFilter = document.getElementById('subscribers-filter-status')?.value || '';
            
            try {
                let url = '/api/admin/billing/subscriptions?';
                if (planFilter) url += `plan=${planFilter}&`;
                if (statusFilter) url += `status=${statusFilter}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                const tbody = document.getElementById('billing-subscribers-table');
                
                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(s => {
                        const statusColors = {
                            'active': 'badge-success',
                            'trialing': 'badge-info',
                            'past_due': 'badge-warning',
                            'cancelled': 'badge-error'
                        };
                        return `
                        <tr>
                            <td><strong>${s.account_name || 'Account #' + s.account_id}</strong></td>
                            <td>${s.plan_code || 'None'}</td>
                            <td>${s.addon_count || 0} add-ons</td>
                            <td>${parseFloat(s.mrr || 0).toFixed(2)}</td>
                            <td><span class="badge ${statusColors[s.status] || ''}">${s.status}</span></td>
                            <td>${s.created_at ? new Date(s.created_at).toLocaleDateString() : '-'}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="viewSubscription(${s.id})">View</button>
                            </td>
                        </tr>
                    `}).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No subscribers yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading subscribers:', error);
            }
        }

        function viewSubscription(id) {
            alert('Subscription details coming soon! ID: ' + id);
        }

        // =====================================================
        // AFFILIATE FUNCTIONS
        // =====================================================
        
        async function loadAffiliatesAdmin() {
            try {
                const response = await fetch('/api/admin/affiliates');
                const data = await response.json();
                
                const tbody = document.getElementById('billing-affiliates-table');
                
                if (data.success && data.data && data.data.length > 0) {
                    // Update stats
                    document.getElementById('affiliate-total-count').textContent = data.data.length;
                    document.getElementById('affiliate-active-referrals').textContent = 
                        data.data.reduce((sum, a) => sum + (a.active_referrals || 0), 0);
                    
                    tbody.innerHTML = data.data.map(a => {
                        const tierColors = { bronze: '#CD7F32', silver: '#C0C0C0', gold: '#FFD700' };
                        const tierIcons = { bronze: '', silver: '', gold: '' };
                        return `
                        <tr>
                            <td><strong>${a.account_name || 'Account #' + a.account_id}</strong></td>
                            <td>
                                <span style="color: ${tierColors[a.tier_code] || '#666'};">
                                    ${tierIcons[a.tier_code] || ''} ${a.tier_code || 'bronze'}
                                </span>
                            </td>
                            <td><code>${a.referral_code}</code></td>
                            <td>${a.active_referrals || 0}</td>
                            <td>${parseFloat(a.lifetime_earnings || 0).toFixed(2)}</td>
                            <td>${parseFloat(a.pending_amount || 0).toFixed(2)}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="viewAffiliateDetails(${a.id})">View</button>
                            </td>
                        </tr>
                    `}).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No affiliates yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading affiliates:', error);
            }
        }
        
        function viewAffiliateDetails(id) {
            alert('Affiliate details coming soon! ID: ' + id);
        }
        
        async function loadMyReferrals() {
            try {
                const response = await fetch('/api/affiliate/me');
                const data = await response.json();
                
                if (data.success && data.affiliate) {
                    // User is an affiliate - show dashboard
                    document.getElementById('affiliate-signup-card').style.display = 'none';
                    document.getElementById('affiliate-dashboard').style.display = 'block';
                    
                    const a = data.affiliate;
                    const tierIcons = { bronze: '', silver: '', gold: '' };
                    const tierNames = { bronze: 'Bronze', silver: 'Silver', gold: 'Gold' };
                    const commissionRates = { bronze: '5%', silver: '10%', gold: '15%' };
                    
                    document.getElementById('my-tier-icon').textContent = tierIcons[a.tier_code] || '';
                    document.getElementById('my-tier-name').textContent = tierNames[a.tier_code] || 'Bronze';
                    document.getElementById('my-commission-rate').textContent = commissionRates[a.tier_code] || '5%';
                    document.getElementById('my-referral-link').value = a.referral_link || `https://gas.travel/ref/${a.referral_code}`;
                    
                    document.getElementById('my-earnings-month').textContent = '' + parseFloat(a.month_earnings || 0).toFixed(2);
                    document.getElementById('my-earnings-pending').textContent = '' + parseFloat(a.pending_amount || 0).toFixed(2);
                    document.getElementById('my-earnings-lifetime').textContent = '' + parseFloat(a.lifetime_earnings || 0).toFixed(2);
                    document.getElementById('my-referral-count').textContent = a.active_referrals || 0;
                    
                    // Enable payout button if enough balance
                    const payoutBtn = document.getElementById('request-payout-btn');
                    if ((a.pending_amount || 0) >= 50) {
                        payoutBtn.disabled = false;
                    } else {
                        payoutBtn.disabled = true;
                    }
                    
                    // Tier progress
                    const referralsToSilver = Math.max(0, 5 - (a.active_referrals || 0));
                    const referralsToGold = Math.max(0, 10 - (a.active_referrals || 0));
                    const tierProgress = document.getElementById('tier-progress');
                    
                    if (a.tier_code === 'gold') {
                        tierProgress.innerHTML = '<p style="margin: 0; font-size: 0.9rem; color: #92400e;"> You\'ve reached the top tier!</p>';
                    } else if (a.tier_code === 'silver') {
                        tierProgress.innerHTML = `<p style="margin: 0; font-size: 0.9rem; color: #92400e;">${referralsToGold} more referrals to reach Gold!</p>`;
                    } else {
                        tierProgress.innerHTML = `<p style="margin: 0; font-size: 0.9rem; color: #92400e;">${referralsToSilver} more referrals to reach Silver!</p>`;
                    }
                    
                    // Load referrals list
                    loadMyReferralsList();
                    
                } else {
                    // Not an affiliate - show signup
                    document.getElementById('affiliate-signup-card').style.display = 'block';
                    document.getElementById('affiliate-dashboard').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading affiliate data:', error);
                // Show signup card on error
                document.getElementById('affiliate-signup-card').style.display = 'block';
                document.getElementById('affiliate-dashboard').style.display = 'none';
            }
        }
        
        async function loadMyReferralsList() {
            try {
                const response = await fetch('/api/affiliate/referrals');
                const data = await response.json();
                
                const tbody = document.getElementById('my-referrals-table');
                
                if (data.success && data.referrals && data.referrals.length > 0) {
                    tbody.innerHTML = data.referrals.map(r => {
                        const statusColors = {
                            'pending': 'badge-warning',
                            'active': 'badge-success',
                            'churned': 'badge-error',
                            'cancelled': 'badge-secondary'
                        };
                        return `
                        <tr>
                            <td>${r.account_name || 'Property #' + r.referred_account_id}</td>
                            <td>${r.signed_up_at ? new Date(r.signed_up_at).toLocaleDateString() : '-'}</td>
                            <td>${r.plan_code || 'Free'}</td>
                            <td><span class="badge ${statusColors[r.status] || ''}">${r.status}</span></td>
                            <td>${parseFloat(r.total_commission || 0).toFixed(2)}</td>
                        </tr>
                    `}).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b;">No referrals yet. Share your link to get started!</td></tr>';
                }
            } catch (error) {
                console.error('Error loading referrals:', error);
            }
        }
        
        async function joinAffiliateProgram() {
            try {
                const response = await fetch('/api/affiliate/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(' Welcome to the affiliate program!', 'success');
                    loadMyReferrals();
                } else {
                    showNotification(data.error || 'Error joining program', 'error');
                }
            } catch (error) {
                showNotification('Error joining affiliate program', 'error');
            }
        }
        
        function copyReferralLink() {
            const input = document.getElementById('my-referral-link');
            input.select();
            document.execCommand('copy');
            showNotification(' Referral link copied!', 'success');
        }
        
        async function requestPayout() {
            if (!confirm('Request payout of your pending balance?')) return;
            
            try {
                const response = await fetch('/api/affiliate/payout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(' Payout requested! Processing within 7 days.', 'success');
                    loadMyReferrals();
                } else {
                    showNotification(data.error || 'Error requesting payout', 'error');
                }
            } catch (error) {
                showNotification('Error requesting payout', 'error');
            }
        }

        // Handle URL hash and query params (for Stripe redirect)
        function handleUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const hash = window.location.hash.replace('#', '').split('?')[0];
            
            // Check for Stripe connection status
            if (urlParams.get('stripe_connected') === 'true') {
                setTimeout(() => {
                    showNotification('Stripe connected successfully!', 'success');
                }, 500);
            }
            if (urlParams.get('stripe_error')) {
                setTimeout(() => {
                    showNotification('Stripe error: ' + urlParams.get('stripe_error'), 'error');
                }, 500);
            }
            
            // Navigate to hash view if specified
            if (hash && document.getElementById(hash)) {
                setTimeout(() => {
                    const navItem = document.querySelector(`.nav-item[data-view="${hash}"]`);
                    if (navItem) {
                        navClick(navItem, hash);
                    } else {
                        showView(hash);
                    }
                }, 100);
            }
            
            // Clean up URL
            if (urlParams.get('stripe_connected') || urlParams.get('stripe_error')) {
                window.history.replaceState({}, document.title, window.location.pathname + (hash ? '#' + hash : ''));
            }
        }

        // Initial load
        loadClientSelector();
        loadDashboard();
        handleUrlParams();

        // =====================================================
        // SERVICE CREDENTIALS VAULT FUNCTIONS
        // =====================================================
        
        let serviceCredentials = [];
        
        async function loadCredentials() {
            try {
                const response = await fetch('/api/admin/credentials', { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    serviceCredentials = data.credentials || [];
                    renderCredentials();
                }
            } catch (error) {
                console.error('Error loading credentials:', error);
            }
        }
        
        function renderCredentials() {
            const container = document.getElementById('credentials-list');
            const emptyState = document.getElementById('credentials-empty');
            
            if (!serviceCredentials || serviceCredentials.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Group by category
            const grouped = {};
            serviceCredentials.forEach(cred => {
                const cat = cred.category || 'other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(cred);
            });
            
            const categoryLabels = {
                hosting: ' Hosting & Infrastructure',
                payments: ' Payments',
                analytics: ' Analytics',
                email: ' Email',
                api: ' API & Integrations',
                domains: ' Domains & DNS',
                other: ' Other'
            };
            
            let html = '';
            for (const [category, creds] of Object.entries(grouped)) {
                html += `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="card-header">
                            <h3>${categoryLabels[category] || category}</h3>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <table style="width: 100%;">
                                <tbody>
                                    ${creds.map(cred => `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 1rem; width: 40%;">
                                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(cred.name)}</div>
                                                ${cred.username ? `<div style="font-size: 0.85rem; color: #64748b;">${escapeHtml(cred.username)}</div>` : ''}
                                            </td>
                                            <td style="padding: 1rem; width: 30%;">
                                                ${cred.url ? `<a href="${escapeHtml(cred.url)}" target="_blank" style="color: var(--primary); font-size: 0.85rem;"> Open Dashboard</a>` : '<span style="color: var(--text-muted); font-size: 0.85rem;">No URL</span>'}
                                            </td>
                                            <td style="padding: 1rem; text-align: right;">
                                                <button class="btn btn-small" onclick="viewCredential(${cred.id})" style="margin-right: 0.5rem;"> View</button>
                                                <button class="btn btn-small btn-secondary" onclick="editCredential(${cred.id})"></button>
                                                <button class="btn btn-small" onclick="deleteCredential(${cred.id})" style="background: #ef4444; margin-left: 0.5rem;"></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function openAddCredentialModal() {
            document.getElementById('credential-modal-title').textContent = 'Add Credential';
            document.getElementById('credential-id').value = '';
            document.getElementById('credential-name').value = '';
            document.getElementById('credential-category').value = 'hosting';
            document.getElementById('credential-url').value = '';
            document.getElementById('credential-username').value = '';
            document.getElementById('credential-password').value = '';
            document.getElementById('credential-api-key').value = '';
            document.getElementById('credential-notes').value = '';
            document.getElementById('credential-modal').style.display = 'flex';
        }
        
        function closeCredentialModal() {
            document.getElementById('credential-modal').style.display = 'none';
        }
        
        async function editCredential(id) {
            const cred = serviceCredentials.find(c => c.id === id);
            if (!cred) return;
            
            document.getElementById('credential-modal-title').textContent = 'Edit Credential';
            document.getElementById('credential-id').value = cred.id;
            document.getElementById('credential-name').value = cred.name || '';
            document.getElementById('credential-category').value = cred.category || 'other';
            document.getElementById('credential-url').value = cred.url || '';
            document.getElementById('credential-username').value = cred.username || '';
            document.getElementById('credential-password').value = cred.password || '';
            document.getElementById('credential-api-key').value = cred.api_key || '';
            document.getElementById('credential-notes').value = cred.notes || '';
            document.getElementById('credential-modal').style.display = 'flex';
        }
        
        async function viewCredential(id) {
            const cred = serviceCredentials.find(c => c.id === id);
            if (!cred) return;
            
            let content = `<div style="text-align: left;">`;
            content += `<p><strong>Service:</strong> ${escapeHtml(cred.name)}</p>`;
            if (cred.url) content += `<p><strong>URL:</strong> <a href="${escapeHtml(cred.url)}" target="_blank">${escapeHtml(cred.url)}</a></p>`;
            if (cred.username) content += `<p><strong>Username:</strong> ${escapeHtml(cred.username)} <button class="btn btn-small" onclick="copyToClipboard('${escapeHtml(cred.username)}')"></button></p>`;
            if (cred.password) content += `<p><strong>Password:</strong> <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">${escapeHtml(cred.password)}</code> <button class="btn btn-small" onclick="copyToClipboard('${escapeHtml(cred.password)}')"></button></p>`;
            if (cred.api_key) content += `<p><strong>API Key:</strong> <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; word-break: break-all;">${escapeHtml(cred.api_key)}</code> <button class="btn btn-small" onclick="copyToClipboard('${escapeHtml(cred.api_key)}')"></button></p>`;
            if (cred.notes) content += `<p><strong>Notes:</strong><br>${escapeHtml(cred.notes).replace(/\n/g, '<br>')}</p>`;
            content += `</div>`;
            
            showModal(' ' + cred.name, content);
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy', 'error');
            });
        }
        
        async function saveCredential() {
            const id = document.getElementById('credential-id').value;
            const data = {
                name: document.getElementById('credential-name').value.trim(),
                category: document.getElementById('credential-category').value,
                url: document.getElementById('credential-url').value.trim(),
                username: document.getElementById('credential-username').value.trim(),
                password: document.getElementById('credential-password').value,
                api_key: document.getElementById('credential-api-key').value.trim(),
                notes: document.getElementById('credential-notes').value.trim()
            };
            
            if (!data.name) {
                showNotification('Service name is required', 'error');
                return;
            }
            
            try {
                const url = id ? `/api/admin/credentials/${id}` : '/api/admin/credentials';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(id ? 'Credential updated!' : 'Credential added!', 'success');
                    closeCredentialModal();
                    loadCredentials();
                } else {
                    showNotification(result.error || 'Failed to save', 'error');
                }
            } catch (error) {
                console.error('Save credential error:', error);
                showNotification('Error saving credential', 'error');
            }
        }
        
        async function deleteCredential(id) {
            if (!confirm('Are you sure you want to delete this credential?')) return;
            
            try {
                const response = await fetch(`/api/admin/credentials/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Credential deleted', 'success');
                    loadCredentials();
                } else {
                    showNotification(result.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                console.error('Delete credential error:', error);
                showNotification('Error deleting credential', 'error');
            }
        }
        
        function toggleCredentialPassword() {
            const input = document.getElementById('credential-password');
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        
        function toggleCredentialApiKey() {
            const input = document.getElementById('credential-api-key');
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        
        // =====================================================
        // CALRY ADMIN FUNCTIONS
        // =====================================================
        
        function toggleCalryTokenVisibility() {
            const input = document.getElementById('calry-api-token');
            input.type = input.type === 'password' ? 'text' : 'password';
        }
        
        async function loadCalryAdmin() {
            await loadCalryCredentials();
            await loadCalryPMSIntegrations();
            await loadCalryProperties();
            await loadGASAccountsForCalry();
        }
        
        async function loadCalryCredentials() {
            try {
                const response = await fetch('/api/admin/calry/credentials', { headers: authHeaders() });
                const result = await response.json();
                
                if (result.success && result.credentials) {
                    document.getElementById('calry-api-token').value = result.credentials.api_token || '';
                    document.getElementById('calry-workspace-id').value = result.credentials.workspace_id || '';
                }
            } catch (error) {
                console.log('No Calry credentials found yet');
            }
        }
        
        async function saveCalryCredentials() {
            const apiToken = document.getElementById('calry-api-token').value.trim();
            const workspaceId = document.getElementById('calry-workspace-id').value.trim();
            
            if (!apiToken || !workspaceId) {
                showNotification('Please enter both API token and Workspace ID', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/calry/credentials', {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_token: apiToken, workspace_id: workspaceId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Calry credentials saved!', 'success');
                } else {
                    showNotification(result.error || 'Failed to save', 'error');
                }
            } catch (error) {
                console.error('Save Calry credentials error:', error);
                showNotification('Error saving credentials', 'error');
            }
        }
        
        async function testCalryConnection() {
            try {
                showNotification('Testing connection...', 'info');
                const response = await fetch('/api/admin/calry/test-connection', { headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`âœ… Connected! Found ${result.pms_count || 0} PMS integrations`, 'success');
                } else {
                    showNotification(result.error || 'Connection failed', 'error');
                }
            } catch (error) {
                console.error('Test connection error:', error);
                showNotification('Error testing connection', 'error');
            }
        }
        
        async function loadCalryPMSIntegrations() {
            try {
                const response = await fetch('/api/admin/calry/pms-integrations', { headers: authHeaders() });
                const result = await response.json();
                
                const tbody = document.getElementById('calry-pms-list');
                
                if (!result.success || !result.integrations || result.integrations.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem; color: #64748b;">No PMS integrations yet. Click "Add PMS" to connect one.</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = result.integrations.map(pms => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">${getPMSIcon(pms.pms_type)}</span>
                                <strong>${pms.pms_type || 'Unknown'}</strong>
                            </div>
                        </td>
                        <td><code style="font-size: 0.8rem; background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px;">${pms.integration_account_id}</code></td>
                        <td>${pms.property_count || 0}</td>
                        <td><span class="badge ${pms.status === 'active' ? 'badge-success' : 'badge-warning'}">${pms.status || 'unknown'}</span></td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="syncCalryPMS('${pms.id}')">ðŸ”„ Sync</button>
                            <button class="btn btn-small btn-secondary" onclick="editCalryPMS('${pms.id}')" style="margin-left: 0.25rem;">âœï¸</button>
                            <button class="btn btn-small" onclick="deleteCalryPMS('${pms.id}')" style="margin-left: 0.25rem; background: #ef4444;">ðŸ—‘ï¸</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load PMS integrations error:', error);
            }
        }
        
        function getPMSIcon(pmsType) {
            const icons = {
                'lodgify': 'ðŸ ',
                'smoobu': 'ðŸ”µ',
                'guesty': 'ðŸŸ£',
                'hostaway': 'ðŸŸ ',
                'beds24': 'ðŸ›ï¸',
                'hostify': 'ðŸ¡',
                'uplisting': 'ðŸ“‹'
            };
            return icons[pmsType?.toLowerCase()] || 'ðŸ“¡';
        }
        
        async function loadCalryProperties() {
            try {
                const response = await fetch('/api/admin/calry/properties', { headers: authHeaders() });
                const result = await response.json();
                
                const tbody = document.getElementById('calry-properties-list');
                
                if (!result.success || !result.properties || result.properties.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #64748b;">No properties found. Add a PMS integration and sync to see properties.</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = result.properties.map(prop => `
                    <tr>
                        <td><strong>${prop.name}</strong></td>
                        <td><span class="badge">${prop.pms_type || '-'}</span></td>
                        <td><code style="font-size: 0.8rem;">${prop.calry_property_id || '-'}</code></td>
                        <td>${prop.gas_property_id ? `<a href="#" onclick="showView('properties'); return false;">ID: ${prop.gas_property_id}</a>` : '<span style="color: #f59e0b;">Not linked</span>'}</td>
                        <td>${prop.last_sync ? new Date(prop.last_sync).toLocaleDateString() : 'Never'}</td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="syncCalryProperty('${prop.id}')">ðŸ”„ Sync</button>
                            ${!prop.gas_property_id ? `<button class="btn btn-small" onclick="linkCalryProperty('${prop.id}')" style="margin-left: 0.25rem;">ðŸ”— Link</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load Calry properties error:', error);
            }
        }
        
        async function loadGASAccountsForCalry() {
            try {
                const response = await fetch('/api/admin/accounts', { headers: authHeaders() });
                const result = await response.json();
                
                const select = document.getElementById('calry-pms-gas-account');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select GAS Account to link...</option>';
                
                if (result.success && result.accounts) {
                    result.accounts.forEach(acc => {
                        select.innerHTML += `<option value="${acc.id}">${acc.name || acc.email || 'Account ' + acc.id}</option>`;
                    });
                }
            } catch (error) {
                console.error('Load accounts error:', error);
            }
        }
        
        function openAddCalryPMSModal() {
            document.getElementById('calry-pms-modal-title').textContent = 'Add PMS Integration';
            document.getElementById('calry-pms-id').value = '';
            document.getElementById('calry-pms-type').value = '';
            document.getElementById('calry-pms-account-id').value = '';
            document.getElementById('calry-pms-account-name').value = '';
            document.getElementById('calry-pms-gas-account').value = '';
            document.getElementById('calry-pms-modal').style.display = 'flex';
        }
        
        function closeCalryPMSModal() {
            document.getElementById('calry-pms-modal').style.display = 'none';
        }
        
        async function saveCalryPMS() {
            const pmsType = document.getElementById('calry-pms-type').value;
            const integrationAccountId = document.getElementById('calry-pms-account-id').value.trim();
            const accountName = document.getElementById('calry-pms-account-name').value.trim();
            const gasAccountId = document.getElementById('calry-pms-gas-account').value;
            
            if (!pmsType || !integrationAccountId) {
                showNotification('Please select PMS type and enter Integration Account ID', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/calry/pms-integrations', {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pms_type: pmsType,
                        integration_account_id: integrationAccountId,
                        account_name: accountName,
                        gas_account_id: gasAccountId || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('PMS integration added!', 'success');
                    closeCalryPMSModal();
                    loadCalryPMSIntegrations();
                } else {
                    showNotification(result.error || 'Failed to save', 'error');
                }
            } catch (error) {
                console.error('Save PMS error:', error);
                showNotification('Error saving PMS integration', 'error');
            }
        }
        
        async function syncCalryPMS(pmsId) {
            try {
                showNotification('Syncing PMS...', 'info');
                const response = await fetch(`/api/admin/calry/pms-integrations/${pmsId}/sync`, {
                    method: 'POST',
                    headers: authHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`âœ… Synced! ${result.properties_found || 0} properties found`, 'success');
                    loadCalryPMSIntegrations();
                    loadCalryProperties();
                } else {
                    showNotification(result.error || 'Sync failed', 'error');
                }
            } catch (error) {
                console.error('Sync PMS error:', error);
                showNotification('Error syncing PMS', 'error');
            }
        }
        
        async function deleteCalryPMS(pmsId) {
            if (!confirm('Are you sure you want to delete this PMS integration?')) return;
            
            try {
                const response = await fetch(`/api/admin/calry/pms-integrations/${pmsId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('PMS integration deleted', 'success');
                    loadCalryPMSIntegrations();
                } else {
                    showNotification(result.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                console.error('Delete PMS error:', error);
                showNotification('Error deleting PMS', 'error');
            }
        }
        
        async function refreshCalryProperties() {
            showNotification('Refreshing properties...', 'info');
            await loadCalryProperties();
            showNotification('Properties refreshed', 'success');
        }
        
        async function syncCalryProperty(propertyId) {
            try {
                showNotification('Syncing property...', 'info');
                const response = await fetch(`/api/admin/calry/properties/${propertyId}/sync`, {
                    method: 'POST',
                    headers: authHeaders()
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`âœ… Synced! ${result.days_updated || 0} days updated`, 'success');
                    loadCalryProperties();
                } else {
                    showNotification(result.error || 'Sync failed', 'error');
                }
            } catch (error) {
                console.error('Sync property error:', error);
                showNotification('Error syncing property', 'error');
            }
        }
        
        // Load Calry Admin when view is shown
        const originalShowView = showView;
        showView = function(viewId) {
            originalShowView(viewId);
            if (viewId === 'calry-admin') {
                loadCalryAdmin();
            }
        };
        
        function showModal(title, content) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('quick-view-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'quick-view-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; border-radius: 12px; overflow: hidden;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); color: white; padding: 1.25rem 1.5rem;">
                            <h3 id="quick-view-title" style="margin: 0; color: white;"></h3>
                        </div>
                        <div class="modal-body" id="quick-view-content" style="padding: 1.5rem;"></div>
                        <div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="document.getElementById('quick-view-modal').style.display='none'">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('quick-view-title').textContent = title;
            document.getElementById('quick-view-content').innerHTML = content;
            modal.style.display = 'flex';
        }

        // =====================================================
        // GASSYNC JAVASCRIPT FUNCTIONS
        // =====================================================

        let gasSyncConnections = [];
        let gasSyncAdapters = [];
        let selectedConnectionId = null;

        // Dashboard
        async function loadGasSyncDashboard() {
            try {
                const response = await fetch('/api/gas-sync/status', { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('syncStatConnections').textContent = data.stats.active_connections || 0;
                    document.getElementById('syncStatProperties').textContent = data.stats.total_properties || 0;
                    document.getElementById('syncStatRoomTypes').textContent = data.stats.total_room_types || 0;
                    document.getElementById('syncStatReservations').textContent = data.stats.active_reservations || 0;
                    document.getElementById('syncStatImages').textContent = data.stats.total_images || 0;
                    document.getElementById('syncStatErrors').textContent = data.stats.error_connections || 0;
                    
                    const tbody = document.getElementById('recentActivityTable');
                    if (data.recent_activity && data.recent_activity.length > 0) {
                        tbody.innerHTML = data.recent_activity.map(activity => `
                            <tr>
                                <td>${formatDateTime(activity.started_at)}</td>
                                <td><span class="badge">${activity.adapter_code}</span></td>
                                <td>${activity.sync_type}</td>
                                <td><span class="status-badge status-${activity.status}">${activity.status}</span></td>
                                <td>${activity.records_processed || 0}</td>
                                <td>${activity.duration_ms ? (activity.duration_ms / 1000).toFixed(1) + 's' : '-'}</td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: #64748b;">No recent activity</td></tr>';
                    }
                }
                
                await loadConnectionStatus();
            } catch (error) {
                console.error('Error loading GasSync dashboard:', error);
            }
        }

        async function loadConnectionStatus() {
            try {
                const response = await fetch('/api/gas-sync/connections', { headers: authHeaders() });
                const data = await response.json();
                
                const container = document.getElementById('connectionStatusList');
                
                if (data.success && data.connections.length > 0) {
                    container.innerHTML = data.connections.map(conn => `
                        <div class="connection-status-item">
                            <div class="status-dot ${conn.status}"></div>
                            <div style="flex: 1;">
                                <strong>${conn.connection_name || conn.external_account_name || conn.adapter_name}</strong>
                                <div style="font-size: 12px; color: #6b7280;">
                                    ${conn.adapter_name}  ${conn.property_count} properties
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 12px; color: #6b7280;">
                                ${conn.last_sync_at ? 'Synced ' + formatTimeAgo(conn.last_sync_at) : 'Never synced'}
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="triggerSync(${conn.id})"></button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 15px;"></div>
                            <h4>No Connections Yet</h4>
                            <p style="color: #64748b;">Connect your first channel manager</p>
                            <button class="btn btn-primary" onclick="showView('gas-sync-connections'); setTimeout(showAddConnectionModal, 100);">
                                 Add Connection
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading connection status:', error);
            }
        }

        // Connections
        async function loadGasSyncConnections() {
            try {
                // Filter by account for non-master users
                let url = '/api/gas-sync/connections';
                if (selectedAccountId) {
                    url += `?account_id=${selectedAccountId}`;
                }
                const response = await fetch(url, { headers: authHeaders() });
                const data = await response.json();
                
                gasSyncConnections = data.connections || [];
                
                const grid = document.getElementById('connectionsGrid');
                
                if (gasSyncConnections.length > 0) {
                    grid.innerHTML = gasSyncConnections.map(conn => `
                        <div class="connection-card status-${conn.status}">
                            <div class="connection-card-header">
                                <div class="connection-logo">${getAdapterEmoji(conn.adapter_code)}</div>
                                <div class="connection-info">
                                    <h4>${conn.connection_name || conn.external_account_name || 'Unnamed'}</h4>
                                    <div class="adapter-name">${conn.adapter_name}</div>
                                </div>
                                <span class="connection-status-badge ${conn.status}">${conn.status}</span>
                            </div>
                            
                            <div class="connection-stats">
                                <div class="connection-stat">
                                    <div class="connection-stat-value">${conn.property_count || 0}</div>
                                    <div class="connection-stat-label">Properties</div>
                                </div>
                                <div class="connection-stat">
                                    <div class="connection-stat-value">${conn.room_type_count || 0}</div>
                                    <div class="connection-stat-label">Room Types</div>
                                </div>
                                <div class="connection-stat">
                                    <div class="connection-stat-value">${conn.reservation_count || 0}</div>
                                    <div class="connection-stat-label">Reservations</div>
                                </div>
                            </div>
                            
                            <div class="connection-meta">
                                ${conn.last_sync_at ? 'Last sync: ' + formatTimeAgo(conn.last_sync_at) : 'Never synced'}
                                ${conn.last_error ? `<br><span style="color: #ef4444;">Error: ${conn.last_error.substring(0, 50)}...</span> <button onclick="clearConnectionError(${conn.id})" style="font-size: 10px; padding: 2px 6px; background: #fee2e2; border: none; border-radius: 3px; color: #dc2626; cursor: pointer;">âœ• Clear</button>` : ''}
                            </div>
                            
                            <div class="connection-actions">
                                <button class="btn btn-secondary btn-sm" onclick="showConnectionOverview(${conn.id})"> Sync</button>
                                <button class="btn btn-secondary btn-sm" onclick="showConnectionDetails(${conn.id})"> Details</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteConnection(${conn.id})" style="color: white;"> Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px;">
                            <div style="font-size: 64px; margin-bottom: 20px;"></div>
                            <h3>No Channel Managers Connected</h3>
                            <p style="color: #64748b; margin-bottom: 20px;">
                                Connect your channel managers to sync properties, availability, and reservations
                            </p>
                            <button class="btn btn-primary btn-lg" onclick="showAddConnectionModal()">
                                 Add Your First Connection
                            </button>
                        </div>
                    `;
                }
                
                populateConnectionFilters();
            } catch (error) {
                console.error('Error loading connections:', error);
            }
        }

        function populateConnectionFilters() {
            const filters = ['syncPropertiesConnectionFilter', 'syncLogsConnectionFilter'];
            filters.forEach(filterId => {
                const select = document.getElementById(filterId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">All Connections</option>' +
                        gasSyncConnections.map(c => `<option value="${c.id}">${c.connection_name || c.external_account_name || c.adapter_name}</option>`).join('');
                    select.value = currentValue;
                }
            });
        }

        function getAdapterEmoji(code) {
            const emojis = { beds24: '', hostaway: '', smoobu: '', calry: '', guesty: '', hostfully: '', hospitable: '' };
            return emojis[code] || '';
        }

        async function triggerSync(connectionId, type = 'incremental') {
            try {
                showNotification('Starting sync...', 'info');
                const response = await fetch(`/api/gas-sync/connections/${connectionId}/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ type })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Sync started in background', 'success');
                    setTimeout(() => loadGasSyncConnections(), 3000);
                } else {
                    showNotification(data.error || 'Sync failed', 'error');
                }
            } catch (error) {
                showNotification('Failed to start sync', 'error');
            }
        }

        async function deleteConnection(connectionId) {
            if (!confirm('Delete this connection? All synced data will be removed.')) return;
            try {
                const response = await fetch(`/api/gas-sync/connections/${connectionId}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    showNotification('Connection deleted', 'success');
                    loadGasSyncConnections();
                } else {
                    showNotification(data.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                showNotification('Failed to delete connection', 'error');
            }
        }

        async function clearConnectionError(connectionId) {
            try {
                const response = await fetch(`/api/gas-sync/connections/${connectionId}/clear-error`, { 
                    method: 'POST', 
                    headers: authHeaders() 
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Error cleared', 'success');
                    loadGasSyncConnections();
                } else {
                    showNotification(data.error || 'Failed to clear error', 'error');
                }
            } catch (error) {
                showNotification('Failed to clear error', 'error');
            }
        }

        // Add Connection Modal
        async function showAddConnectionModal() {
            try {
                const response = await fetch('/api/gas-sync/adapters', { headers: authHeaders() });
                const data = await response.json();
                gasSyncAdapters = data.adapters || [];
                
                const grid = document.getElementById('adapterGrid');
                grid.innerHTML = gasSyncAdapters.map(adapter => `
                    <div class="adapter-card" onclick="selectAdapter('${adapter.code}', '${adapter.name}')">
                        <div class="adapter-card-logo">${getAdapterEmoji(adapter.code)}</div>
                        <div class="adapter-card-name">${adapter.name}</div>
                    </div>
                `).join('');
                
                const accountsResponse = await fetch('/api/admin/accounts', { headers: authHeaders() });
                const accountsData = await accountsResponse.json();
                const accountSelect = document.getElementById('connectionAccountId');
                accountSelect.innerHTML = (accountsData.accounts || []).map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading adapters:', error);
            }
            
            showConnectionStep(1);
            document.getElementById('addConnectionModal').style.display = 'flex';
        }

        function showConnectionStep(step) {
            document.getElementById('connectionStep1').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('connectionStep2').style.display = step === 2 ? 'block' : 'none';
        }

        function selectAdapter(code, name) {
            document.getElementById('selectedAdapterCode').value = code;
            document.getElementById('selectedAdapterName').textContent = `Configure ${name}`;
            
            const fieldsContainer = document.getElementById('credentialFields');
            let fieldsHtml = '';
            
            if (code === 'beds24') {
                fieldsHtml = `
                    <div class="form-group"><label>API Token (V2)</label>
                        <input type="password" id="credToken" placeholder="Enter your Beds24 API token" required>
                        <div class="help-text">Get this from Beds24  Settings  API</div></div>
                    <div class="form-group"><label>API Key (V1 - for images)</label>
                        <input type="password" id="credApiKey" placeholder="Optional: V1 API key for image sync">
                        <div class="help-text">Optional: Enables image download</div></div>
                    <div class="form-group"><label>Property Key (V1)</label>
                        <input type="text" id="credPropKey" placeholder="Optional: V1 property key"></div>
                `;
            } else if (code === 'calry') {
                fieldsHtml = `
                    <div class="form-group"><label>Calry API Token</label>
                        <input type="password" id="credToken" placeholder="Enter your Calry API token" required></div>
                    <div class="form-group"><label>Workspace ID</label>
                        <input type="text" id="credWorkspaceId" placeholder="Your Calry workspace ID" required></div>
                    <div class="form-group"><label>Integration Account ID</label>
                        <input type="text" id="credIntegrationAccountId" placeholder="The connected PMS account ID" required></div>
                `;
            } else {
                fieldsHtml = `<div class="form-group"><label>API Token</label>
                    <input type="password" id="credToken" placeholder="Enter API token" required></div>`;
            }
            
            fieldsContainer.innerHTML = fieldsHtml;
            showConnectionStep(2);
        }

        async function testAndSaveConnection() {
            const adapterCode = document.getElementById('selectedAdapterCode').value;
            const accountId = document.getElementById('connectionAccountId').value;
            const syncEnabled = document.getElementById('connectionSyncEnabled').checked;
            const syncInterval = document.getElementById('connectionSyncInterval').value;
            
            const credentials = {};
            const tokenEl = document.getElementById('credToken');
            const apiKeyEl = document.getElementById('credApiKey');
            const propKeyEl = document.getElementById('credPropKey');
            const workspaceIdEl = document.getElementById('credWorkspaceId');
            const integrationAccountIdEl = document.getElementById('credIntegrationAccountId');
            
            if (tokenEl?.value) credentials.token = tokenEl.value;
            if (apiKeyEl?.value) credentials.apiKey = apiKeyEl.value;
            if (propKeyEl?.value) credentials.propKey = propKeyEl.value;
            if (workspaceIdEl?.value) credentials.workspaceId = workspaceIdEl.value;
            if (integrationAccountIdEl?.value) credentials.integrationAccountId = integrationAccountIdEl.value;
            
            try {
                showNotification('Testing connection...', 'info');
                const response = await fetch('/api/gas-sync/connections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: accountId,
                        adapter_code: adapterCode,
                        credentials,
                        sync_enabled: syncEnabled,
                        sync_interval_minutes: parseInt(syncInterval)
                    })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Connection created! Initial sync starting...', 'success');
                    closeModal('addConnectionModal');
                    loadGasSyncConnections();
                } else {
                    showNotification(data.error || 'Connection failed', 'error');
                }
            } catch (error) {
                showNotification('Failed to create connection', 'error');
            }
        }

        // Connection Details Modal
        async function showConnectionOverview(connectionId) {
            selectedConnectionId = connectionId;
            document.getElementById('connectionDetailsModal').style.display = 'flex';
            showConnectionTab('overview');
        }

        async function showConnectionDetails(connectionId) {
            selectedConnectionId = connectionId;
            document.getElementById('connectionDetailsModal').style.display = 'flex';
            showConnectionTab('properties');
        }

        async function showConnectionTab(tab) {
            document.querySelectorAll('.gas-sync-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.gas-sync-tab[onclick*="${tab}"]`)?.classList.add('active');
            document.querySelectorAll('.gas-sync-tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(`connectionTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
            
            if (tab === 'overview') await loadConnectionOverview();
            else if (tab === 'properties') await loadConnectionPropertiesTab();
            else if (tab === 'propertyCheck') await loadPropertyCheckTab();
            else if (tab === 'reservations') await loadConnectionReservationsTab();
            else if (tab === 'reviews') await loadConnectionReviewsTab();
            else if (tab === 'settings') loadConnectionSettingsTab();
        }

        async function loadConnectionOverview() {
            const container = document.getElementById('connectionTabOverview');
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    const conn = data.connection;
                    const isBeds24 = conn.adapter_code === 'beds24';
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4>Connection Info</h4>
                                <table style="width: 100%;"><tbody>
                                    <tr><td style="padding: 8px 0; color: #6b7280;">Adapter:</td><td>${conn.adapter_name}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #6b7280;">Status:</td><td><span class="status-badge status-${conn.status}">${conn.status}</span></td></tr>
                                    <tr><td style="padding: 8px 0; color: #6b7280;">External Account:</td><td>${conn.external_account_name || '-'}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #6b7280;">Last Sync:</td><td>${conn.last_sync_at ? formatTimeAgo(conn.last_sync_at) : 'Never'}</td></tr>
                                    ${isBeds24 ? `<tr><td style="padding: 8px 0; color: #6b7280;">V1 API Key:</td><td>${conn.v1_key_masked ? `<span style="color: #16a34a;"></span> ${conn.v1_key_masked}` : '<span style="color: #dc2626;"> Not set</span>'}</td></tr>` : ''}
                                </tbody></table>
                            </div>
                            <div>
                                <p style="color: #6b7280; font-size: 0.9rem;">Use the <strong>Properties</strong> tab to sync individual properties.</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = '<p style="color: #ef4444;">Error loading details</p>';
            }
        }

        async function loadPropertyCheckTab() {
            const container = document.getElementById('connectionTabPropertyCheck');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                    <h4 style="margin: 0 0 10px 0;">Property Check</h4>
                    <p style="color: #6b7280; margin-bottom: 20px;">Compare properties in Beds24 with GAS to find new or removed properties.</p>
                    <button class="btn btn-primary btn-lg" onclick="runPropertyCheck()"> Check Now</button>
                </div>
            `;
        }

        async function runPropertyCheck() {
            const container = document.getElementById('connectionTabPropertyCheck');
            container.innerHTML = '<p style="text-align: center; padding: 20px;"> Checking for property changes...</p>';
            
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}/check-properties`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const data = await response.json();
                
                if (data.success) {
                    const hasChanges = data.newProperties.length > 0 || data.removedProperties.length > 0;
                    
                    container.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0;"> Property Check Results</h4>
                            <p style="color: #6b7280; margin: 0;">Comparing properties in Beds24 with GAS</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #f0fdf4; border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #16a34a;">${data.matchedCount}</div>
                                <div style="color: #15803d; font-size: 0.9rem;">Matched</div>
                            </div>
                            <div style="background: ${data.newProperties.length > 0 ? '#dbeafe' : '#f3f4f6'}; border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: ${data.newProperties.length > 0 ? '#2563eb' : '#6b7280'};">${data.newProperties.length}</div>
                                <div style="color: ${data.newProperties.length > 0 ? '#1d4ed8' : '#6b7280'}; font-size: 0.9rem;">New in Beds24</div>
                            </div>
                            <div style="background: ${data.removedProperties.length > 0 ? '#fee2e2' : '#f3f4f6'}; border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: ${data.removedProperties.length > 0 ? '#dc2626' : '#6b7280'};">${data.removedProperties.length}</div>
                                <div style="color: ${data.removedProperties.length > 0 ? '#b91c1c' : '#6b7280'}; font-size: 0.9rem;">Removed from Beds24</div>
                            </div>
                        </div>
                        
                        ${data.newProperties.length > 0 ? `
                        <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #1d4ed8;"> New Properties in Beds24</h5>
                            <p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 10px;">These properties exist in Beds24 but haven't been synced to GAS yet.</p>
                            <table class="data-table" style="margin: 0;">
                                <thead><tr><th>Property</th><th>Location</th><th>Action</th></tr></thead>
                                <tbody>
                                    ${data.newProperties.map(p => `
                                        <tr>
                                            <td><strong>${p.name}</strong><br><small style="color: #6b7280;">ID: ${p.externalId}</small></td>
                                            <td>${p.city || ''}, ${p.country || ''}</td>
                                            <td><button class="btn btn-sm btn-primary" onclick="syncNewProperty(${selectedConnectionId}, '${p.externalId}')"> Sync</button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : ''}
                        
                        ${data.removedProperties.length > 0 ? `
                        <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #b91c1c;"> Removed from Beds24</h5>
                            <p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 10px;">These properties were synced but no longer exist in Beds24.</p>
                            <table class="data-table" style="margin: 0;">
                                <thead><tr><th>Property</th><th>Location</th><th>Action</th></tr></thead>
                                <tbody>
                                    ${data.removedProperties.map(p => `
                                        <tr>
                                            <td><strong>${p.name}</strong><br><small style="color: #6b7280;">ID: ${p.external_id}</small></td>
                                            <td>${p.city || ''}, ${p.country || ''}</td>
                                            <td><button class="btn btn-sm btn-danger" onclick="archiveSyncedProperty(${p.id})" style="color: white;"> Archive</button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : ''}
                        
                        ${!hasChanges ? `
                        <div style="text-align: center; padding: 30px; background: #f0fdf4; border-radius: 8px;">
                            <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                            <p style="color: #16a34a; margin: 0;">All properties are in sync!</p>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 15px; text-align: right;">
                            <button class="btn btn-secondary" onclick="runPropertyCheck()"> Check Again</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<p style="color: #ef4444;">Error: ${data.error || 'Failed to check properties'}</p>`;
                }
            } catch (error) {
                console.error('Error checking properties:', error);
                container.innerHTML = '<p style="color: #ef4444;">Error checking properties</p>';
            }
        }

        async function syncNewProperty(connectionId, externalId) {
            try {
                showNotification('Syncing property...', 'info');
                const response = await fetch(`/api/gas-sync/connections/${connectionId}/sync-property`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ externalId })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Property synced successfully!', 'success');
                    loadPropertyCheckTab();
                } else {
                    showNotification(data.error || 'Failed to sync property', 'error');
                }
            } catch (error) {
                showNotification('Error syncing property', 'error');
            }
        }

        async function archiveSyncedProperty(syncPropertyId) {
            if (!confirm('Archive this property? It will be removed from the synced list.')) return;
            try {
                const response = await fetch(`/api/gas-sync/properties/${syncPropertyId}/archive`, {
                    method: 'POST',
                    headers: authHeaders()
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Property archived', 'success');
                    loadPropertyCheckTab();
                } else {
                    showNotification(data.error || 'Failed to archive', 'error');
                }
            } catch (error) {
                showNotification('Error archiving property', 'error');
            }
        }

        async function loadConnectionPropertiesTab() {
            const container = document.getElementById('connectionTabProperties');
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}/properties`, { headers: authHeaders() });
                const data = await response.json();
                const conn = gasSyncConnections.find(c => c.id === selectedConnectionId);
                const isBeds24 = conn && conn.adapter_code === 'beds24';
                const isHostaway = conn && conn.adapter_code === 'hostaway';
                
                if (data.success && data.properties.length > 0) {
                    container.innerHTML = `
                        ${isBeds24 ? `
                        <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 16px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 12px 0; color: #166534;"> Beds24 Setup Instructions</h4>
                            <p style="margin: 0 0 12px 0; font-size: 0.9rem; color: #15803d;">For each property in Beds24, go to <strong>Settings  Channel Manager  API</strong> and configure:</p>
                            
                            <div style="background: white; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                                <strong style="color: #1e293b;">1. Booking Webhook</strong>
                                <table style="width: 100%; margin-top: 8px; font-size: 0.85rem;">
                                    <tr><td style="color: #64748b; width: 120px;">Webhook Version:</td><td><code>2 - no personal data</code></td></tr>
                                    <tr><td style="color: #64748b;">URL:</td><td><code>https://admin.gas.travel/api/webhooks/beds24?propertyId=<span style="color: #dc2626;">{PROPERTY_ID}</span></code> <button onclick="copyWebhookUrl()" class="btn btn-sm" style="padding: 2px 8px; font-size: 0.75rem; margin-left: 5px;"></button></td></tr>
                                    <tr><td style="color: #64748b;">Additional Data:</td><td><code>CVC and Token</code></td></tr>
                                </table>
                            </div>
                            
                            <div style="background: white; border-radius: 6px; padding: 12px;">
                                <strong style="color: #1e293b;">2. API Access (V1 Only)</strong>
                                <table style="width: 100%; margin-top: 8px; font-size: 0.85rem;">
                                    <tr><td style="color: #64748b; width: 120px;">propKey:</td><td>Create a random key in Beds24 for each property  Enter in Prop Key field  Test Webhook  Import</td></tr>
                                </table>
                            </div>
                        </div>
                        ` : ''}
                        ${isHostaway ? `
                        <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 15px;">
                            <h4 style="margin: 0 0 12px 0; color: #1e40af;">ðŸ“¡ Hostaway Webhook Setup (Recommended)</h4>
                            <p style="margin: 0 0 12px 0; font-size: 0.9rem; color: #1e40af;">For real-time booking updates from Airbnb, VRBO, Booking.com, etc., add this webhook in Hostaway:</p>
                            
                            <div style="background: white; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                                <strong style="color: #1e293b;">Webhook URL:</strong>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                    <code style="flex: 1; background: #1e293b; color: #22c55e; padding: 8px 12px; border-radius: 4px; font-size: 0.85rem;">https://admin.gas.travel/api/webhooks/hostaway</code>
                                    <button onclick="copyHostawayWebhookUrl()" class="btn btn-sm" style="padding: 6px 10px;">ðŸ“‹ Copy</button>
                                    <button onclick="testHostawayWebhook()" class="btn btn-sm" style="background: #22c55e; color: white; padding: 6px 10px;">ðŸ§ª Test</button>
                                </div>
                            </div>
                            
                            <div style="background: white; border-radius: 6px; padding: 12px;">
                                <strong style="color: #1e293b;">Setup Steps:</strong>
                                <ol style="margin: 8px 0 0 0; padding-left: 20px; font-size: 0.85rem; color: #374151; line-height: 1.7;">
                                    <li>Go to <strong>Hostaway Dashboard â†’ Settings â†’ Integrations</strong></li>
                                    <li>Find <strong>"Unified Webhooks"</strong> section</li>
                                    <li>Click <strong>"Add Webhook"</strong></li>
                                    <li>Paste the URL above</li>
                                    <li>Enable reservation events (created, updated, cancelled)</li>
                                    <li>Save</li>
                                </ol>
                            </div>
                            
                            <div style="background: #fef3c7; border-radius: 6px; padding: 10px; margin-top: 10px;">
                                <p style="margin: 0; font-size: 0.8rem; color: #92400e;">
                                    <strong>â° Without webhook:</strong> Bookings sync automatically every 15 minutes via polling.
                                </p>
                            </div>
                        </div>
                        ` : ''}
                        <table class="data-table" style="table-layout: auto; width: 100%;"><thead><tr>
                            <th style="width: 50px;">Status</th>
                            <th style="width: 140px;">Property</th>
                            <th style="width: 100px;">Location</th>
                            ${isBeds24 ? '<th style="width: 280px;">Webhook URL</th>' : ''}
                            ${isBeds24 ? '<th style="width: 160px;">Prop Key</th>' : ''}
                            <th style="width: 60px;">Rooms</th>
                            <th style="width: 100px;">Import</th>
                            <th style="width: 80px;">Actions</th>
                        </tr></thead><tbody>
                        ${data.properties.map(p => {
                            let statusLight = 'ðŸŸ¢';
                            let statusTitle = 'Fully configured';
                            const webhookTested = p.webhook_tested || false;
                            const propKeyTested = p.prop_key_tested || false;
                            if (isBeds24) {
                                if (p.gas_property_id) {
                                    statusLight = 'ðŸŸ¢';
                                    statusTitle = 'Imported to GAS';
                                } else if (!p.prop_key) {
                                    statusLight = 'ðŸ”´';
                                    statusTitle = 'Enter prop key';
                                } else if (!webhookTested || !propKeyTested) {
                                    statusLight = 'ðŸŸ ';
                                    statusTitle = 'Test webhook and prop key';
                                } else {
                                    statusLight = 'ðŸŸ¡';
                                    statusTitle = 'Ready to import';
                                }
                            } else {
                                if (p.gas_property_id) {
                                    statusLight = 'ðŸŸ¢';
                                    statusTitle = 'Imported to GAS';
                                } else {
                                    statusLight = 'ðŸŸ¡';
                                    statusTitle = 'Not imported to GAS yet';
                                }
                            }
                            const canImport = isBeds24 ? (p.prop_key && webhookTested && propKeyTested && !p.gas_property_id) : !p.gas_property_id;
                            return `<tr id="prop-row-${p.id}">
                                <td title="${statusTitle}" style="font-size: 1.25rem; text-align: center;">${statusLight}</td>
                                <td><strong>${p.name}</strong><br><small style="color: #6b7280;">ID: ${p.external_id}</small></td>
                                <td>${p.city || ''}, ${p.country || ''}</td>
                                ${isBeds24 ? `<td>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="text" readonly value="https://admin.gas.travel/api/webhooks/beds24?propertyId=${p.external_id}" 
                                            style="width: 180px; padding: 4px 6px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.7rem; background: #f8fafc; text-overflow: ellipsis;">
                                        <button onclick="copyWebhookUrlForProperty('${p.external_id}')" class="btn btn-sm" style="padding: 4px 6px;" title="Copy URL">ðŸ“‹</button>
                                        <span id="webhook-test-${p.id}">
                                            ${webhookTested ? 
                                                `<button onclick="testWebhookForProperty(${p.id}, '${p.external_id}')" class="btn btn-sm" style="background: #22c55e; color: white; padding: 4px 8px;" title="Re-test">âœ…</button>` : 
                                                `<button onclick="testWebhookForProperty(${p.id}, '${p.external_id}')" class="btn btn-sm" style="background: #f59e0b; color: white; padding: 4px 8px;">ðŸ§ª</button>`
                                            }
                                        </span>
                                    </div>
                                </td>` : ''}
                                ${isBeds24 ? `<td>
                                    <div style="display: flex; align-items: center; gap: 4px;">
                                        <input type="text" id="propKey-${p.id}" value="${p.prop_key || ''}" placeholder="Enter key" 
                                            style="width: 80px; padding: 4px 6px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.8rem;"
                                            ${p.gas_property_id ? 'disabled' : ''}>
                                        <button onclick="savePropKey(${p.id})" class="btn btn-sm" style="padding: 4px 6px;" ${p.gas_property_id ? 'disabled' : ''} title="Save">ðŸ’¾</button>
                                        ${p.prop_key && !p.gas_property_id ? `<button onclick="clearPropKey(${p.id})" class="btn btn-sm" style="padding: 4px 6px; background: #fee2e2; color: #dc2626;" title="Clear">ðŸ—‘ï¸</button>` : ''}
                                        <span id="propkey-test-${p.id}">
                                            ${p.prop_key ? 
                                                (propKeyTested ? 
                                                    `<button onclick="testPropKeyForProperty(${p.id}, '${p.external_id}')" class="btn btn-sm" style="background: #22c55e; color: white; padding: 6px 10px;" title="Re-test">âœ…</button>` :
                                                    `<button onclick="testPropKeyForProperty(${p.id}, '${p.external_id}')" class="btn btn-sm" style="background: #f59e0b; color: white; padding: 6px 10px;">ðŸ§ª</button>`
                                                ) :
                                                '<span style="color: #9ca3af;">-</span>'
                                            }
                                        </span>
                                    </div>
                                </td>` : ''}
                                <td style="text-align: center;">${p.room_type_count}</td>
                                <td>
                                    <div style="display: flex; gap: 6px; align-items: center;">
                                        ${isBeds24 && p.prop_key ? `<button onclick="downloadPropertyImages(${p.id})" class="btn btn-sm btn-secondary" title="${p.gas_property_id ? 'Re-download Images' : 'Download Images First'}">ðŸ“·</button>` : ''}
                                        ${p.gas_property_id ? 
                                            '<span style="color: #22c55e;">âœ… Imported</span>' : 
                                            `<button id="import-btn-${p.id}" class="btn btn-sm btn-primary" onclick="importSyncedProperty(${p.id})" ${canImport ? '' : 'disabled'} style="${canImport ? '' : 'opacity: 0.5; cursor: not-allowed;'}">${canImport ? 'Import' : (!p.prop_key ? 'Enter Key' : (!webhookTested && !propKeyTested ? 'Run Tests' : (!webhookTested ? 'Test Webhook' : 'Test Key')))}</button>`
                                        }
                                    </div>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 4px;">
                                        ${p.gas_property_id ? `<button onclick="syncPropertyContent(${p.id}, '${conn?.adapter_code || ''}', '${p.external_id}')" class="btn btn-sm btn-primary" title="Re-sync from channel manager">ðŸ”„ Sync</button>` : ''}
                                        ${p.gas_property_id ? `<button onclick="viewPropertyInGAS(${p.gas_property_id})" class="btn btn-sm btn-secondary" title="View in GAS">ðŸ‘</button>` : ''}
                                        ${p.gas_property_id ? `<button onclick="unlinkSyncedProperty(${p.id}, '${p.name.replace(/'/g, "\\'")}')" class="btn btn-sm" style="background: #fee2e2; color: #dc2626;" title="Unlink from GAS">ðŸ”—</button>` : ''}
                                    </div>
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody></table>`;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #64748b;">No properties synced yet</p>';
                }
            } catch (error) {
                container.innerHTML = '<p style="color: #ef4444;">Error loading properties</p>';
            }
        }
        
        function copyWebhookUrl() {
            navigator.clipboard.writeText('https://admin.gas.travel/api/webhooks/beds24?propertyId=');
            showNotification('Webhook URL copied - add the property ID at the end', 'success');
        }
        
        function copyWebhookUrlForProperty(propertyId) {
            const url = `https://admin.gas.travel/api/webhooks/beds24?propertyId=${propertyId}`;
            navigator.clipboard.writeText(url);
            showNotification('Webhook URL copied! Paste this into Beds24 webhook settings.', 'success');
        }
        
        // Test that the webhook URL is correctly configured in Beds24
        async function testWebhookForProperty(syncPropertyId, externalPropertyId) {
            const testSpan = document.getElementById(`webhook-test-${syncPropertyId}`);
            testSpan.innerHTML = '<span style="color: #f59e0b;"></span>';
            
            try {
                const response = await fetch('/api/gas-sync/test-webhook-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        syncPropertyId: syncPropertyId,
                        externalPropertyId: externalPropertyId
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    testSpan.innerHTML = '<span style="color: #22c55e; font-weight: bold;">âœ…</span>';
                    showNotification('Webhook URL test passed!', 'success');
                    loadConnectionPropertiesTab();
                } else {
                    testSpan.innerHTML = `<button onclick="testWebhookForProperty(${syncPropertyId}, '${externalPropertyId}')" class="btn btn-sm" style="background: #ef4444; color: white; padding: 6px 10px;">âŒ Retry</button>`;
                    showNotification('Webhook test failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                testSpan.innerHTML = `<button onclick="testWebhookForProperty(${syncPropertyId}, '${externalPropertyId}')" class="btn btn-sm" style="background: #ef4444; color: white; padding: 6px 10px;">âŒ Retry</button>`;
                showNotification('Webhook test failed: ' + error.message, 'error');
            }
        }
        
        // Test that the prop key can fetch data from Beds24 V1 API
        async function testPropKeyForProperty(syncPropertyId, externalPropertyId) {
            const testSpan = document.getElementById(`propkey-test-${syncPropertyId}`);
            const propKey = document.getElementById(`propKey-${syncPropertyId}`)?.value?.trim();
            
            if (!propKey) {
                showNotification('Please enter and save the prop key first', 'error');
                return;
            }
            
            testSpan.innerHTML = '<span style="color: #f59e0b;"></span>';
            
            try {
                const response = await fetch('/api/gas-sync/test-prop-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        syncPropertyId: syncPropertyId,
                        externalPropertyId: externalPropertyId,
                        propKey: propKey
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    testSpan.innerHTML = '<span style="color: #22c55e; font-weight: bold;">âœ…</span>';
                    showNotification('Prop Key test passed! GAS can fetch data from Beds24.', 'success');
                    loadConnectionPropertiesTab();
                } else {
                    testSpan.innerHTML = `<button onclick="testPropKeyForProperty(${syncPropertyId}, '${externalPropertyId}')" class="btn btn-sm" style="background: #ef4444; color: white; padding: 6px 10px;">âŒ Retry</button>`;
                    showNotification('Prop Key test failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                testSpan.innerHTML = `<button onclick="testPropKeyForProperty(${syncPropertyId}, '${externalPropertyId}')" class="btn btn-sm" style="background: #ef4444; color: white; padding: 6px 10px;">âŒ Retry</button>`;
                showNotification('Prop Key test failed: ' + error.message, 'error');
            }
        }
        
        // Check if both tests passed and enable import button
        async function updateImportButton(syncPropertyId) {
            // Refresh the row data to check both test statuses
            try {
                const response = await fetch(`/api/gas-sync/property/${syncPropertyId}/status`, { headers: authHeaders() });
                const data = await response.json();
                console.log('updateImportButton status:', data);
                
                // Check both database state AND visual state (checkmarks)
                const webhookSpan = document.getElementById(`webhook-test-${syncPropertyId}`);
                const propkeySpan = document.getElementById(`propkey-test-${syncPropertyId}`);
                const webhookPassed = data.webhook_tested || (webhookSpan && webhookSpan.innerHTML.includes('âœ…'));
                const propkeyPassed = data.prop_key_tested || (propkeySpan && propkeySpan.innerHTML.includes('âœ…'));
                
                console.log('Test states - webhook:', webhookPassed, 'propkey:', propkeyPassed);
                
                if (webhookPassed && propkeyPassed && !data.imported) {
                    const importBtn = document.getElementById(`import-btn-${syncPropertyId}`);
                    if (importBtn) {
                        importBtn.disabled = false;
                        importBtn.style.opacity = '1';
                        importBtn.style.cursor = 'pointer';
                        importBtn.textContent = 'Import';
                    }
                    // Update status light to yellow (ready to import)
                    const row = document.getElementById(`prop-row-${syncPropertyId}`);
                    if (row) {
                        const statusCell = row.querySelector('td:first-child');
                        if (statusCell) {
                            statusCell.innerHTML = 'ðŸŸ¡';
                            statusCell.title = 'Ready to import';
                        }
                    }
                }
            } catch (e) {
                console.log('Could not update import button:', e);
            }
        }
        
        async function testPropertyWebhook(syncPropertyId, externalPropertyId) {
            // Legacy - redirect to new function
            testPropKeyForProperty(syncPropertyId, externalPropertyId);
        }
        
        async function testWebhook() {
            // Legacy function - kept for backward compatibility
            showNotification('Please use the per-property Test buttons in the table', 'info');
        }
        
        async function clearPropKey(syncPropertyId) {
            if (!confirm('Clear this prop key?')) return;
            try {
                const response = await fetch(`/api/gas-sync/properties/${syncPropertyId}/prop-key`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Prop key cleared', 'success');
                    loadConnectionPropertiesTab();
                } else {
                    showNotification(data.error || 'Failed to clear', 'error');
                }
            } catch (error) {
                showNotification('Failed to clear prop key', 'error');
            }
        }

        async function syncPropertyContent(syncPropertyId, adapterCode, externalId) {
            try {
                // For Hostaway, fetch fresh data from Hostaway API
                if (adapterCode === 'hostaway') {
                    showNotification('Fetching fresh data from Hostaway...', 'info');
                    
                    const response = await fetch('/api/hostaway/resync-single-property', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ 
                            connectionId: selectedConnectionId, 
                            listingId: externalId
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showNotification(`âœ… ${data.message}`, 'success');
                        loadConnectionPropertiesTab();
                    } else {
                        showNotification(data.error || 'Sync failed', 'error');
                    }
                    return;
                }
                
                // For Beds24 and other adapters:
                // Step 1: Fetch fresh content from Beds24 V1 API (descriptions, amenities)
                showNotification('Step 1/2: Fetching content from Beds24...', 'info');
                try {
                    const contentResponse = await fetch(`/api/gas-sync/properties/${syncPropertyId}/sync-content`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ force: true })
                    });
                    const contentData = await contentResponse.json();
                    if (contentData.success) {
                        console.log('Content sync:', contentData);
                    } else {
                        console.log('Content sync skipped:', contentData.error);
                    }
                } catch (contentError) {
                    console.log('Content sync error (continuing):', contentError.message);
                }
                
                // Step 2: Link content to GAS (update bookable_units with descriptions, images)
                showNotification('Step 2/2: Syncing to GAS...', 'info');
                const response = await fetch(`/api/gas-sync/properties/${syncPropertyId}/link-to-gas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                if (data.success) {
                    const stats = data.stats || {};
                    showNotification(`Synced: ${stats.roomsUpdated || 0} rooms updated, ${stats.imagesCreated || 0} new images`, 'success');
                    loadConnectionPropertiesTab();
                } else {
                    showNotification(data.error || 'Sync failed', 'error');
                }
            } catch (error) {
                showNotification('Failed to sync content', 'error');
            }
        }

        async function savePropKey(syncPropertyId) {
            const propKeyInput = document.getElementById(`propKey-${syncPropertyId}`);
            const propKey = propKeyInput.value.trim();
            
            if (!propKey) {
                showNotification('Please enter a property key', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/gas-sync/properties/${syncPropertyId}/set-prop-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ propKey: propKey })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Property key saved!', 'success');
                    // Reload the table to show camera button and updated state
                    loadConnectionPropertiesTab();
                } else {
                    showNotification(data.error || 'Failed to save', 'error');
                }
            } catch (error) {
                showNotification('Failed to save property key', 'error');
            }
        }

        async function loadConnectionReservationsTab() {
            const container = document.getElementById('connectionTabReservations');
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}/reservations?limit=20`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success && data.reservations.length > 0) {
                    container.innerHTML = `<table class="data-table"><thead><tr><th>Guest</th><th>Property</th><th>Dates</th><th>Channel</th><th>Total</th><th>Status</th></tr></thead><tbody>
                        ${data.reservations.map(r => `<tr>
                            <td>${r.guest_first_name} ${r.guest_last_name}</td>
                            <td>${r.property_name || r.room_type_name || '-'}</td>
                            <td>${formatDate(r.check_in)}  ${formatDate(r.check_out)}</td>
                            <td><span class="badge">${r.channel || 'Direct'}</span></td>
                            <td>${r.currency} ${r.total || 0}</td>
                            <td><span class="status-badge status-${r.status}">${r.status}</span></td>
                        </tr>`).join('')}
                    </tbody></table>`;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #64748b;">No reservations synced yet</p>';
                }
            } catch (error) {
                container.innerHTML = '<p style="color: #ef4444;">Error loading reservations</p>';
            }
        }

        async function loadConnectionLogsTab() {
            const container = document.getElementById('connectionTabLogs');
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}/logs?limit=20`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success && data.logs.length > 0) {
                    container.innerHTML = `<table class="data-table"><thead><tr><th>Time</th><th>Type</th><th>Status</th><th>Records</th><th>Duration</th><th>Error</th></tr></thead><tbody>
                        ${data.logs.map(log => `<tr>
                            <td>${formatDateTime(log.started_at)}</td>
                            <td>${log.sync_type}</td>
                            <td><span class="status-badge status-${log.status}">${log.status}</span></td>
                            <td>${log.records_created || 0} / ${log.records_updated || 0} / ${log.records_failed || 0}</td>
                            <td>${log.duration_ms ? (log.duration_ms / 1000).toFixed(1) + 's' : '-'}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${log.error_message || '-'}</td>
                        </tr>`).join('')}
                    </tbody></table>`;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #64748b;">No sync logs yet</p>';
                }
            } catch (error) {
                container.innerHTML = '<p style="color: #ef4444;">Error loading logs</p>';
            }
        }

        async function loadConnectionReviewsTab() {
            const conn = gasSyncConnections.find(c => c.id === selectedConnectionId);
            if (!conn) return;
            const container = document.getElementById('connectionTabReviews');
            
            // Only show for Hostaway and Beds24 connections
            if (conn.adapter_code !== 'hostaway' && conn.adapter_code !== 'beds24') {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">â­</div>
                        <h4 style="margin: 0 0 10px 0;">Reviews Sync</h4>
                        <p style="color: #6b7280;">Reviews sync is currently only available for Hostaway and Beds24 connections.</p>
                    </div>
                `;
                return;
            }
            
            const channelName = conn.adapter_code === 'beds24' ? 'Beds24' : 'Hostaway';
            const channelDesc = conn.adapter_code === 'beds24' 
                ? 'Pull guest reviews from Airbnb and Booking.com channels connected via Beds24.'
                : 'Pull guest reviews from Airbnb, Booking.com, VRBO and other channels connected via Hostaway.';
            
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">â­</div>
                    <h4 style="margin: 0 0 10px 0;">Sync Reviews from ${channelName}</h4>
                    <p style="color: #6b7280; margin-bottom: 20px;">${channelDesc}</p>
                    <button class="btn btn-primary btn-lg" onclick="syncConnectionReviews()" id="sync-reviews-btn">â­ Sync Reviews Now</button>
                    <div id="reviews-sync-status" style="margin-top: 20px;"></div>
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                        <button class="btn btn-secondary" onclick="showView('app-reviews'); closeModal('connectionDetailsModal');">ðŸ“‹ View Reviews App</button>
                    </div>
                </div>
            `;
        }

        async function syncConnectionReviews() {
            const btn = document.getElementById('sync-reviews-btn');
            const statusDiv = document.getElementById('reviews-sync-status');
            
            // Get adapter code from the connection data
            const conn = gasSyncConnections.find(c => c.id === selectedConnectionId);
            const adapterCode = conn?.adapter_code;
            
            btn.disabled = true;
            btn.textContent = 'â³ Syncing...';
            
            // Determine endpoint based on adapter type
            let endpoint, channelName;
            if (adapterCode === 'beds24') {
                endpoint = '/api/beds24/sync-reviews';
                channelName = 'Beds24 (Airbnb & Booking.com)';
            } else if (adapterCode === 'hostaway') {
                endpoint = '/api/hostaway/sync-reviews';
                channelName = 'Hostaway';
            } else {
                statusDiv.innerHTML = '<p style="color: #ef4444;">Reviews sync not supported for this channel manager</p>';
                btn.disabled = false;
                btn.textContent = 'â­ Sync Reviews Now';
                return;
            }
            
            statusDiv.innerHTML = `<p style="color: #6b7280;">Fetching reviews from ${channelName}...</p>`;
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ connectionId: selectedConnectionId })
                });
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.innerHTML = `
                        <div style="background: #f0fdf4; border: 1px solid #16a34a; border-radius: 8px; padding: 15px; text-align: left;">
                            <h5 style="margin: 0 0 10px 0; color: #16a34a;">âœ… Sync Complete</h5>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #16a34a;">${result.stats?.created || 0}</div>
                                    <div style="font-size: 0.85rem; color: #6b7280;">New</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${result.stats?.updated || 0}</div>
                                    <div style="font-size: 0.85rem; color: #6b7280;">Updated</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #6b7280;">${result.stats?.skipped || 0}</div>
                                    <div style="font-size: 0.85rem; color: #6b7280;">Skipped</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 15px;">
                            <p style="color: #dc2626; margin: 0;">âŒ ${result.error || 'Sync failed'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 15px;">
                        <p style="color: #dc2626; margin: 0;">âŒ Error: ${error.message}</p>
                    </div>
                `;
            }
            
            btn.disabled = false;
            btn.textContent = 'â­ Sync Reviews Now';
        }

        function loadConnectionSettingsTab() {
            const conn = gasSyncConnections.find(c => c.id === selectedConnectionId);
            if (!conn) return;
            const container = document.getElementById('connectionTabSettings');
            
            // Check if Beds24 for V1 API key field
            const isBeds24 = conn.adapter_code === 'beds24';
            const hasV1Key = conn.v1_key_masked ? true : false;
            
            // Format sync interval for display
            const intervalText = conn.sync_interval_minutes == 5 ? 'Every 5 minutes' :
                                 conn.sync_interval_minutes == 15 ? 'Every 15 minutes' :
                                 conn.sync_interval_minutes == 30 ? 'Every 30 minutes' :
                                 conn.sync_interval_minutes == 60 ? 'Every hour' : 
                                 `Every ${conn.sync_interval_minutes} minutes`;
            
            container.innerHTML = `
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="settingSyncEnabled" ${conn.sync_enabled ? 'checked' : ''}>
                        Enable automatic sync
                    </label>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #64748b;">Sync Interval</label>
                    <div style="padding: 8px 12px; background: #f1f5f9; border-radius: 6px; color: #334155;">${intervalText}</div>
                </div>
                ${isBeds24 ? `
                <hr style="margin: 20px 0;">
                <h4 style="margin-bottom: 15px;"> Beds24 V1 API Key</h4>
                ${hasV1Key ? `
                <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 12px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <span style="color: #166534; font-weight: 500;"> V1 API Key configured</span>
                        <code style="margin-left: 10px; background: #dcfce7; padding: 2px 8px; border-radius: 4px;">${conn.v1_key_masked}</code>
                    </div>
                </div>
                ` : `
                <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                    <span style="color: #92400e;"> V1 API Key not set</span>
                </div>
                `}
                <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 12px;">${hasV1Key ? 'Update the V1 API key:' : 'Enter your V1 API key to enable image download and fixed pricing:'}</p>
                <div class="form-group" style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="settingV1ApiKey" class="form-control" placeholder="Paste V1 API key here" style="flex: 1;">
                        <button class="btn btn-primary" onclick="saveV1ApiKey()">ðŸ’¾ Save Key</button>
                    </div>
                    <small style="color: #6b7280; display: block; margin-top: 8px;"> Find this in Beds24: Settings  Account  Account Access</small>
                </div>
                ` : ''}
                <hr style="margin: 20px 0;">
                <button class="btn btn-primary" onclick="saveConnectionSettings()">ðŸ’¾ Save Settings</button>
                <hr style="margin: 30px 0;">
                <h4 style="color: #ef4444;">Danger Zone</h4>
                <button class="btn btn-danger" onclick="deleteConnection(${conn.id}); closeModal('connectionDetailsModal');"> Delete Connection</button>
            `;
        }
        
        async function saveV1ApiKey() {
            const v1Key = document.getElementById('settingV1ApiKey').value.trim();
            if (!v1Key) {
                showNotification('Please enter a V1 API key', 'error');
                return;
            }
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}/set-v1-api-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ v1ApiKey: v1Key })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('V1 API key saved!', 'success');
                    document.getElementById('settingV1ApiKey').value = '';
                    // Reload connections to get updated masked key
                    await loadGasSyncConnections();
                    // Refresh the settings tab to show new masked key
                    showConnectionTab('settings');
                } else {
                    showNotification(data.error || 'Failed to save', 'error');
                }
            } catch (error) {
                showNotification('Failed to save V1 API key', 'error');
            }
        }

        async function saveConnectionSettings() {
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        sync_enabled: document.getElementById('settingSyncEnabled').checked
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Settings saved', 'success');
                    loadGasSyncConnections();
                } else {
                    showNotification(data.error || 'Failed to save', 'error');
                }
            } catch (error) {
                showNotification('Failed to save settings', 'error');
            }
        }

        async function unlinkSyncedProperty(syncPropertyId, propertyName) {
            if (!confirm(`Unlink "${propertyName}" from GAS?\n\nThis will remove the link between the synced property and GAS, but won't delete the GAS property itself.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/gas-sync/properties/${syncPropertyId}/unlink`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Property unlinked', 'success');
                    loadConnectionPropertiesTab();
                } else {
                    showNotification(data.error || 'Failed to unlink', 'error');
                }
            } catch (error) {
                showNotification('Failed to unlink property', 'error');
            }
        }

        async function importSyncedProperty(syncPropertyId) {
            try {
                showNotification('Importing property...', 'info');
                const response = await fetch(`/api/gas-sync/properties/${syncPropertyId}/link-to-gas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({})  // Let server use connection's account_id
                });
                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadConnectionPropertiesTab();
                } else {
                    showNotification(data.error || 'Import failed', 'error');
                }
            } catch (error) {
                showNotification('Failed to import property', 'error');
            }
        }

        async function downloadPropertyImages(syncPropertyId) {
            try {
                showNotification('Downloading images...', 'info');
                const response = await fetch(`/api/gas-sync/properties/${syncPropertyId}/download-images`, { method: 'POST', headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadConnectionPropertiesTab();
                } else {
                    showNotification(data.error || 'Download failed', 'error');
                }
            } catch (error) {
                showNotification('Failed to download images', 'error');
            }
        }

        function viewPropertyInGAS(propertyId) {
            // Switch to Properties tab and show this property
            showSection('properties');
            setTimeout(() => {
                const propertySelect = document.getElementById('propertySelect');
                if (propertySelect) {
                    propertySelect.value = propertyId;
                    propertySelect.dispatchEvent(new Event('change'));
                }
            }, 100);
        }

        // Synced Properties View
        let allSyncedProperties = []; // Store for filtering
        
        async function loadSyncedProperties() {
            const connectionId = document.getElementById('syncPropertiesConnectionFilter')?.value;
            try {
                let properties = [];
                if (connectionId) {
                    const response = await fetch(`/api/gas-sync/connections/${connectionId}/properties`, { headers: authHeaders() });
                    const data = await response.json();
                    properties = data.properties || [];
                    properties = properties.map(p => ({...p, connectionId: connectionId}));
                } else {
                    for (const conn of gasSyncConnections) {
                        const response = await fetch(`/api/gas-sync/connections/${conn.id}/properties`, { headers: authHeaders() });
                        const data = await response.json();
                        if (data.properties) {
                            properties = properties.concat(data.properties.map(p => ({...p, connection: conn, connectionId: conn.id})));
                        }
                    }
                }
                
                allSyncedProperties = properties;
                renderSyncedProperties(properties);
                
            } catch (error) {
                console.error('Error loading synced properties:', error);
            }
        }
        
        function filterSyncedProperties() {
            const search = document.getElementById('syncPropertiesSearch')?.value?.toLowerCase() || '';
            const filtered = allSyncedProperties.filter(p => {
                const name = (p.name || '').toLowerCase();
                const city = (p.city || '').toLowerCase();
                const country = (p.country || '').toLowerCase();
                return name.includes(search) || city.includes(search) || country.includes(search);
            });
            renderSyncedProperties(filtered);
        }
        
        function getSyncStatus(property) {
            // Green: Linked and synced within 24hrs
            // Yellow: Partially linked OR sync older than 24hrs  
            // Red: Not linked OR sync older than 7 days OR no sync
            
            const now = new Date();
            const syncedAt = property.synced_at ? new Date(property.synced_at) : null;
            const hoursSinceSync = syncedAt ? (now - syncedAt) / (1000 * 60 * 60) : Infinity;
            
            const isLinked = !!property.gas_property_id;
            const roomCount = property.room_type_count || 0;
            
            if (!isLinked) {
                return { color: '#ef4444', label: 'Not Linked', icon: 'ðŸ”´' };
            }
            
            if (hoursSinceSync > 168) { // 7 days
                return { color: '#ef4444', label: 'Sync Stale', icon: 'ðŸ”´' };
            }
            
            if (hoursSinceSync > 24) {
                return { color: '#f59e0b', label: 'Sync Aging', icon: 'ðŸŸ¡' };
            }
            
            if (roomCount === 0) {
                return { color: '#f59e0b', label: 'No Rooms', icon: 'ðŸŸ¡' };
            }
            
            return { color: '#10b981', label: 'Healthy', icon: 'ðŸŸ¢' };
        }
        
        function renderSyncedProperties(properties) {
            const tbody = document.getElementById('syncedPropertiesTable');
            
            if (properties.length > 0) {
                tbody.innerHTML = properties.map(p => {
                    const status = getSyncStatus(p);
                    const location = [p.city, p.country].filter(Boolean).join(', ') || '-';
                    
                    return `<tr style="cursor: pointer;" onclick="navigateToConnectionProperty(${p.connectionId}, ${p.id})" title="Click to view details">
                        <td style="text-align: center;">
                            <span style="font-size: 0.8rem;" title="${status.label}">${status.icon}</span>
                        </td>
                        <td>
                            <strong>${p.name}</strong>
                            <br><small style="color: #6b7280;">${p.connection?.adapter_name || 'Beds24'}</small>
                        </td>
                        <td>${location}</td>
                        <td>${p.room_type_count || 0}</td>
                        <td>${formatTimeAgo(p.synced_at)}</td>
                    </tr>`;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #64748b;">No synced properties found</td></tr>';
            }
        }
        
        function navigateToConnectionProperty(connectionId, propertyId) {
            // Navigate to the connection's Properties tab
            if (connectionId) {
                showView('gas-sync-connections');
                setTimeout(() => {
                    viewConnectionDetails(connectionId, 'properties');
                }, 100);
            }
        }

        // Room Changes Check
        let currentRoomChangesPropertyId = null;
        let currentRoomChangesData = null;
        
        async function checkRoomChanges(propertyId, propertyName) {
            currentRoomChangesPropertyId = propertyId;
            document.getElementById('room-changes-title').textContent = ` Room Changes - ${propertyName}`;
            document.getElementById('room-changes-loading').style.display = 'block';
            document.getElementById('room-changes-content').style.display = 'none';
            document.getElementById('website-reminder').style.display = 'none';
            openModal('roomChangesModal');
            
            try {
                const response = await fetch(`/api/gas-sync/properties/${propertyId}/check-room-changes`, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to check room changes');
                }
                
                currentRoomChangesData = data;
                renderRoomChanges(data);
                
            } catch (error) {
                console.error('Error checking room changes:', error);
                document.getElementById('room-changes-loading').innerHTML = `
                    <div style="color: #dc2626;">
                        <div style="font-size: 2rem;"></div>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderRoomChanges(data) {
            document.getElementById('room-changes-loading').style.display = 'none';
            document.getElementById('room-changes-content').style.display = 'block';
            
            // Summary cards
            const summary = document.getElementById('room-changes-summary');
            summary.innerHTML = `
                <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #047857;">${data.summary.matched}</div>
                    <div style="font-size: 0.85rem; color: #065f46;">Matched</div>
                </div>
                <div style="background: ${data.summary.new > 0 ? '#dcfce7' : '#f3f4f6'}; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${data.summary.new > 0 ? '#059669' : '#9ca3af'};">${data.summary.new}</div>
                    <div style="font-size: 0.85rem; color: ${data.summary.new > 0 ? '#047857' : '#6b7280'};">New</div>
                </div>
                <div style="background: ${data.summary.removed > 0 ? '#fee2e2' : '#f3f4f6'}; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${data.summary.removed > 0 ? '#dc2626' : '#9ca3af'};">${data.summary.removed}</div>
                    <div style="font-size: 0.85rem; color: ${data.summary.removed > 0 ? '#b91c1c' : '#6b7280'};">Removed</div>
                </div>
                <div style="background: ${data.summary.nameChanges > 0 ? '#fef3c7' : '#f3f4f6'}; padding: 1rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: ${data.summary.nameChanges > 0 ? '#d97706' : '#9ca3af'};">${data.summary.nameChanges}</div>
                    <div style="font-size: 0.85rem; color: ${data.summary.nameChanges > 0 ? '#92400e' : '#6b7280'};">Name Changes</div>
                </div>
            `;
            
            // New rooms
            const newSection = document.getElementById('new-rooms-section');
            const newList = document.getElementById('new-rooms-list');
            if (data.newRooms && data.newRooms.length > 0) {
                newSection.style.display = 'block';
                newList.innerHTML = data.newRooms.map(room => `
                    <label style="display: flex; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #d1fae5; cursor: pointer; gap: 0.75rem;">
                        <input type="checkbox" class="new-room-checkbox" data-room='${JSON.stringify(room)}' checked>
                        <span><strong>${room.name}</strong> <span style="color: #6b7280; font-size: 0.85rem;">(ID: ${room.external_id}, Max: ${room.max_guests} guests)</span></span>
                    </label>
                `).join('');
            } else {
                newSection.style.display = 'none';
            }
            
            // Removed rooms
            const removedSection = document.getElementById('removed-rooms-section');
            const removedList = document.getElementById('removed-rooms-list');
            if (data.removedRooms && data.removedRooms.length > 0) {
                removedSection.style.display = 'block';
                removedList.innerHTML = data.removedRooms.map(room => `
                    <label style="display: flex; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #fee2e2; cursor: pointer; gap: 0.75rem;">
                        <input type="checkbox" class="removed-room-checkbox" data-room='${JSON.stringify(room)}' checked>
                        <span><strong>${room.gas_name || room.name}</strong> <span style="color: #6b7280; font-size: 0.85rem;">(ID: ${room.external_id}${room.is_hidden ? ', already hidden' : ''})</span></span>
                    </label>
                `).join('');
            } else {
                removedSection.style.display = 'none';
            }
            
            // Name changes
            const nameSection = document.getElementById('name-changes-section');
            const nameList = document.getElementById('name-changes-list');
            if (data.nameChanges && data.nameChanges.length > 0) {
                nameSection.style.display = 'block';
                nameList.innerHTML = data.nameChanges.map(room => `
                    <label style="display: flex; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #fef3c7; cursor: pointer; gap: 0.75rem;">
                        <input type="checkbox" class="name-change-checkbox" data-room='${JSON.stringify(room)}' checked>
                        <span>
                            <strong>${room.gas_name}</strong>  <strong style="color: #059669;">${room.beds24_name}</strong>
                        </span>
                    </label>
                `).join('');
            } else {
                nameSection.style.display = 'none';
            }
            
            // Matched rooms (collapsed by default)
            const matchedList = document.getElementById('matched-rooms-list');
            if (data.matched && data.matched.length > 0) {
                matchedList.innerHTML = data.matched.map(room => 
                    `<span style="display: inline-block; padding: 0.25rem 0.5rem; background: #f3f4f6; border-radius: 4px; margin: 0.25rem;">${room.name}${room.is_hidden ? ' (hidden)' : ''}</span>`
                ).join('');
            } else {
                matchedList.innerHTML = '<em>No matched rooms</em>';
            }
        }
        
        async function importSelectedRooms() {
            const checkboxes = document.querySelectorAll('.new-room-checkbox:checked');
            if (checkboxes.length === 0) {
                showNotification('No rooms selected', 'warning');
                return;
            }
            
            const rooms = Array.from(checkboxes).map(cb => JSON.parse(cb.dataset.room));
            
            try {
                const response = await fetch(`/api/gas-sync/properties/${currentRoomChangesPropertyId}/import-new-rooms`, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rooms })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Imported ${data.imported.length} rooms`, 'success');
                    document.getElementById('website-reminder').style.display = 'block';
                    // Refresh the check
                    checkRoomChanges(currentRoomChangesPropertyId, document.getElementById('room-changes-title').textContent.replace(' Room Changes - ', ''));
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showNotification('Error importing rooms: ' + error.message, 'error');
            }
        }
        
        async function archiveSelectedRooms() {
            const checkboxes = document.querySelectorAll('.removed-room-checkbox:checked');
            if (checkboxes.length === 0) {
                showNotification('No rooms selected', 'warning');
                return;
            }
            
            const rooms = Array.from(checkboxes).map(cb => JSON.parse(cb.dataset.room));
            
            if (!confirm(`Archive ${rooms.length} room(s)? They will be hidden from the calendar but data will be preserved.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/gas-sync/properties/${currentRoomChangesPropertyId}/archive-rooms`, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rooms })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Archived ${data.archived.length} rooms`, 'success');
                    document.getElementById('website-reminder').style.display = 'block';
                    // Refresh the check
                    checkRoomChanges(currentRoomChangesPropertyId, document.getElementById('room-changes-title').textContent.replace(' Room Changes - ', ''));
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showNotification('Error archiving rooms: ' + error.message, 'error');
            }
        }
        
        async function updateSelectedNames() {
            const checkboxes = document.querySelectorAll('.name-change-checkbox:checked');
            if (checkboxes.length === 0) {
                showNotification('No rooms selected', 'warning');
                return;
            }
            
            const rooms = Array.from(checkboxes).map(cb => {
                const room = JSON.parse(cb.dataset.room);
                return {
                    gas_room_id: room.gas_room_id,
                    sync_room_id: room.sync_room_id,
                    new_name: room.beds24_name
                };
            });
            
            try {
                const response = await fetch(`/api/gas-sync/properties/${currentRoomChangesPropertyId}/update-room-names`, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rooms })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Updated ${data.updated.length} room names`, 'success');
                    document.getElementById('website-reminder').style.display = 'block';
                    // Refresh the check
                    checkRoomChanges(currentRoomChangesPropertyId, document.getElementById('room-changes-title').textContent.replace(' Room Changes - ', ''));
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showNotification('Error updating room names: ' + error.message, 'error');
            }
        }

        // Sync Logs View
        async function loadSyncLogs() {
            const connectionId = document.getElementById('syncLogsConnectionFilter')?.value;
            const status = document.getElementById('syncLogsStatusFilter')?.value;
            try {
                let allLogs = [];
                if (connectionId) {
                    const response = await fetch(`/api/gas-sync/connections/${connectionId}/logs?limit=50`, { headers: authHeaders() });
                    const data = await response.json();
                    allLogs = (data.logs || []).map(l => ({...l, connection: gasSyncConnections.find(c => c.id == connectionId)}));
                } else {
                    for (const conn of gasSyncConnections) {
                        const response = await fetch(`/api/gas-sync/connections/${conn.id}/logs?limit=20`, { headers: authHeaders() });
                        const data = await response.json();
                        if (data.logs) {
                            allLogs = allLogs.concat(data.logs.map(l => ({...l, connection: conn})));
                        }
                    }
                    allLogs.sort((a, b) => new Date(b.started_at) - new Date(a.started_at));
                }
                
                if (status) allLogs = allLogs.filter(l => l.status === status);
                
                const tbody = document.getElementById('syncLogsTable');
                if (allLogs.length > 0) {
                    tbody.innerHTML = allLogs.slice(0, 100).map(log => `<tr>
                        <td>${formatDateTime(log.started_at)}</td>
                        <td>${log.connection?.adapter_name || '-'}</td>
                        <td>${log.sync_type}</td>
                        <td><span class="status-badge status-${log.status}">${log.status}</span></td>
                        <td>${log.records_created || 0}</td>
                        <td>${log.records_updated || 0}</td>
                        <td>${log.records_failed || 0}</td>
                        <td>${log.duration_ms ? (log.duration_ms / 1000).toFixed(1) + 's' : '-'}</td>
                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${log.error_message || ''}">${log.error_message || '-'}</td>
                    </tr>`).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color: #64748b;">No logs found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading sync logs:', error);
            }
        }

        // Helper functions
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return formatDate(dateString);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString();
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString();
        }

        // =====================================================
        // AI SUPPORT CHAT WIDGET
        // =====================================================
        // Variables declared at top of script for early access

        function toggleAIChat() {
            aiChatOpen = !aiChatOpen;
            const chatWidget = document.getElementById('ai-chat-widget');
            const chatButton = document.getElementById('ai-chat-button');
            
            if (aiChatOpen) {
                chatWidget.style.display = 'flex';
                chatButton.innerHTML = '';
                chatButton.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                
                // Get clean view name
                const activeNav = document.querySelector('.nav-item.active');
                if (activeNav) {
                    const textSpan = activeNav.querySelector('span:not(.nav-icon)');
                    aiChatCurrentView = textSpan ? textSpan.textContent.trim() : 'Dashboard';
                } else {
                    aiChatCurrentView = 'Dashboard';
                }
                
                // Update header to show current section
                const headerInfo = document.querySelector('.ai-chat-header-info span');
                if (headerInfo) {
                    headerInfo.textContent = `Helping with: ${aiChatCurrentView}`;
                }
                
                // Welcome message if first time
                if (aiChatMessages.length === 0) {
                    addAIChatMessage('assistant', `Hi!  I'm Gus, your GAS travel assistant. I can see you're in the ${aiChatCurrentView} section. How can I help you today?`);
                }
                
                // Update quick buttons based on section
                updateAIChatQuickButtons();
                
                // Focus input
                setTimeout(() => document.getElementById('ai-chat-input')?.focus(), 100);
            } else {
                chatWidget.style.display = 'none';
                chatButton.innerHTML = '';
                chatButton.style.background = 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)';
            }
        }
        
        // Called when user navigates to update chat context
        function updateAIChatContext() {
            if (typeof aiChatOpen === 'undefined') return;
            
            // Get clean view name
            const activeNav = document.querySelector('.nav-item.active');
            let newView = 'Dashboard';
            if (activeNav) {
                const textSpan = activeNav.querySelector('span:not(.nav-icon)');
                newView = textSpan ? textSpan.textContent.trim() : 'Dashboard';
            }
            
            // Only update if view actually changed AND chat is open
            if (newView !== aiChatCurrentView && aiChatOpen) {
                const oldView = aiChatCurrentView;
                aiChatCurrentView = newView;
                
                // Add a message acknowledging the navigation
                addAIChatMessage('assistant', `I see you've moved to ${aiChatCurrentView}. How can I help you here?`);
                
                // Update quick buttons
                updateAIChatQuickButtons();
                
                // Update header
                const headerInfo = document.querySelector('.ai-chat-header-info span');
                if (headerInfo) {
                    headerInfo.textContent = `Helping with: ${aiChatCurrentView}`;
                }
            } else if (newView !== aiChatCurrentView) {
                // Chat not open, just update the tracked view
                aiChatCurrentView = newView;
            }
        }
        
        // Update quick buttons based on current section
        function updateAIChatQuickButtons() {
            const buttonsContainer = document.getElementById('ai-chat-quick-buttons');
            if (!buttonsContainer) return;
            
            const sectionButtons = {
                'Blog': [
                    { text: 'Create blog post', question: 'How do I create a blog post?' },
                    { text: 'Blog categories', question: 'What blog categories are there?' },
                    { text: 'Publish post', question: 'How do I publish a blog post?' }
                ],
                'Attractions': [
                    { text: 'Add attraction', question: 'How do I add an attraction?' },
                    { text: 'Categories', question: 'What attraction categories are available?' },
                    { text: 'Publish', question: 'How do I publish an attraction?' }
                ],
                'Offers': [
                    { text: 'Create offer', question: 'How do I create a discount offer?' },
                    { text: 'Pricing tiers', question: 'How do pricing tiers work?' },
                    { text: 'Corporate rates', question: 'How do corporate rates work?' }
                ],
                'Properties': [
                    { text: 'Edit property', question: 'How do I edit property details?' },
                    { text: 'Change currency', question: 'How do I change the currency?' },
                    { text: 'Sync issues', question: 'My property data seems outdated' }
                ],
                'Deployed Sites': [
                    { text: 'Edit website', question: 'How do I edit my website?' },
                    { text: 'Custom domain', question: 'How do I use my own domain?' },
                    { text: 'Not updating', question: 'My website changes are not showing' }
                ],
                'Connections': [
                    { text: 'Resync data', question: 'How do I resync my data?' },
                    { text: 'Connection issues', question: 'My connection is showing an error' },
                    { text: 'How sync works', question: 'How does channel manager sync work?' }
                ]
            };
            
            // Find matching section
            let buttons = null;
            for (const [section, btns] of Object.entries(sectionButtons)) {
                if (aiChatCurrentView.includes(section)) {
                    buttons = btns;
                    break;
                }
            }
            
            // Default buttons
            if (!buttons) {
                buttons = [
                    { text: 'Create blog', question: 'How do I create a blog post?' },
                    { text: 'Add attractions', question: 'How do I add attractions?' },
                    { text: 'Pricing help', question: 'How do pricing tiers work?' }
                ];
            }
            
            buttonsContainer.innerHTML = buttons.map(btn => 
                `<button onclick="askQuickQuestion('${btn.question}')">${btn.text}</button>`
            ).join('');
        }

        function addAIChatMessage(role, content) {
            aiChatMessages.push({ role, content });
            renderAIChatMessages();
        }

        // Gus mini avatar SVG for chat messages
        const gusAvatarSvg = `<svg width="24" height="24" viewBox="0 0 120 120">
            <rect x="20" y="35" width="80" height="65" rx="8" fill="#818cf8"/>
            <rect x="25" y="40" width="70" height="55" rx="5" fill="#a5b4fc"/>
            <rect x="45" y="20" width="30" height="20" rx="4" fill="#6366f1"/>
            <circle cx="45" cy="62" r="7" fill="white"/>
            <circle cx="75" cy="62" r="7" fill="white"/>
            <circle cx="46" cy="62" r="3" fill="#1e293b"/>
            <circle cx="76" cy="62" r="3" fill="#1e293b"/>
            <path d="M 50 77 Q 60 86, 70 77" stroke="#1e293b" stroke-width="2.5" fill="none" stroke-linecap="round"/>
        </svg>`;

        function renderAIChatMessages() {
            const container = document.getElementById('ai-chat-messages');
            if (!container) return;
            
            container.innerHTML = aiChatMessages.map(msg => `
                <div class="ai-chat-msg ${msg.role}">
                    <div class="ai-chat-msg-avatar">${msg.role === 'assistant' ? gusAvatarSvg : ''}</div>
                    <div class="ai-chat-msg-content">${msg.content.replace(/\n/g, '<br>')}</div>
                </div>
            `).join('');
            
            // Add loading indicator if waiting
            if (aiChatLoading) {
                container.innerHTML += `
                    <div class="ai-chat-msg assistant">
                        <div class="ai-chat-msg-avatar">${gusAvatarSvg}</div>
                        <div class="ai-chat-msg-content">
                            <span class="ai-typing"><span>.</span><span>.</span><span>.</span></span>
                        </div>
                    </div>
                `;
            }
            
            container.scrollTop = container.scrollHeight;
        }

        async function sendAIChatMessage() {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            if (!message || aiChatLoading) return;
            
            input.value = '';
            addAIChatMessage('user', message);
            
            aiChatLoading = true;
            renderAIChatMessages();
            
            try {
                // Use tracked current view (updates on navigation)
                const currentView = aiChatCurrentView || document.querySelector('.nav-item.active')?.textContent?.trim() || 'Dashboard';
                
                // Build conversation history (exclude the message we just added)
                const historyForAPI = aiChatMessages.slice(0, -1).map(msg => ({
                    role: msg.role,
                    content: msg.content
                }));
                
                // Get user details if logged in
                const userDetails = currentAccount ? {
                    account_id: currentAccount.id,
                    email: currentAccount.email,
                    name: currentAccount.name || currentAccount.company_name,
                    role: currentAccount.role
                } : null;
                
                // Use server proxy
                const response = await fetch('/api/ai-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        context: currentView,
                        history: historyForAPI.slice(-10), // Last 10 messages
                        user: userDetails
                    })
                });
                
                const data = await response.json();
                aiChatLoading = false;
                
                if (data.success) {
                    addAIChatMessage('assistant', data.response);
                } else {
                    throw new Error(data.error || 'Failed to get response');
                }
            } catch (error) {
                console.error('AI Chat error:', error);
                aiChatLoading = false;
                addAIChatMessage('assistant', "I'm having trouble connecting right now. You can reach our team at hello@gas.travel for help!");
            }
        }

        function handleAIChatKeypress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAIChatMessage();
            }
        }

        // Quick question buttons
        function askQuickQuestion(question) {
            document.getElementById('ai-chat-input').value = question;
            sendAIChatMessage();
        }
        
        // Draggable chat widget
        (function() {
            let isDragging = false;
            let dragOffsetX = 0;
            let dragOffsetY = 0;
            
            document.addEventListener('DOMContentLoaded', function() {
                const widget = document.getElementById('ai-chat-widget');
                const header = document.querySelector('.ai-chat-header');
                
                if (!header || !widget) return;
                
                header.addEventListener('mousedown', function(e) {
                    // Don't drag if clicking on close button area
                    if (e.target.closest('button')) return;
                    
                    isDragging = true;
                    widget.classList.add('dragging');
                    
                    const rect = widget.getBoundingClientRect();
                    dragOffsetX = e.clientX - rect.left;
                    dragOffsetY = e.clientY - rect.top;
                    
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    
                    let newX = e.clientX - dragOffsetX;
                    let newY = e.clientY - dragOffsetY;
                    
                    // Keep within viewport
                    const maxX = window.innerWidth - widget.offsetWidth;
                    const maxY = window.innerHeight - widget.offsetHeight;
                    
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    
                    widget.style.left = newX + 'px';
                    widget.style.top = newY + 'px';
                    widget.style.right = 'auto';
                    widget.style.bottom = 'auto';
                });
                
                document.addEventListener('mouseup', function() {
                    if (isDragging) {
                        isDragging = false;
                        widget.classList.remove('dragging');
                    }
                });
            });
        })();
    </script>

    <!-- GAS Lite Preview Panel - Shows Card -->
    <div id="lite-preview-panel" class="lite-preview-panel" style="display: none;">
        <div class="lite-preview-header">
            <span class="lite-preview-title">â­ GAS Lite</span>
            <div class="lite-preview-actions">
                <span id="lite-preview-slug" style="color: white; font-size: 14px; font-weight: 700; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px;">#...</span>
                <button class="lite-preview-btn" onclick="refreshLitePreview()" title="Refresh">ðŸ”„</button>
                <button class="lite-preview-btn" onclick="closeLitePreview()" title="Close">âœ•</button>
            </div>
        </div>
        <iframe id="lite-preview-iframe" src="about:blank"></iframe>
        <div class="lite-preview-footer">
            <a id="lite-preview-link" href="#" target="_blank" class="lite-fullpage-btn">â†—ï¸ Open Full Page</a>
        </div>
    </div>

    <style>
        .lite-preview-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 420px;
            height: auto;
            max-height: 90vh;
            background: #0f172a;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .lite-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .lite-preview-title {
            font-weight: 600;
            font-size: 14px;
        }
        .lite-preview-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .lite-preview-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lite-preview-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        #lite-preview-iframe {
            flex: 1;
            border: none;
            width: 100%;
            min-height: 500px;
            background: #0f172a;
        }
        .lite-preview-footer {
            display: flex;
            justify-content: center;
            padding: 12px;
            background: #0f172a;
        }
        .lite-fullpage-btn {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .lite-fullpage-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* Eye button for room selectors */
        .room-preview-eye {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 38px;
            height: 38px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: none;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            flex-shrink: 0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .room-preview-eye:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .room-preview-eye.visible {
            display: flex;
        }
    </style>

    <script>
    // GAS Lite Preview Panel Functions
    let currentPreviewRoomId = null;
    
    let currentLiteId = null;
    let currentLiteSlug = null;
    
    async function showLitePreview(roomId) {
        if (!roomId) return;
        currentPreviewRoomId = roomId;
        
        const panel = document.getElementById('lite-preview-panel');
        const iframe = document.getElementById('lite-preview-iframe');
        const linkEl = document.getElementById('lite-preview-link');
        const slugEl = document.getElementById('lite-preview-slug');
        
        panel.style.display = 'flex';
        iframe.src = 'about:blank';
        slugEl.textContent = '#...';
        
        try {
            // Get or create lite for this room
            const response = await fetch(`https://lite.gas.travel/api/room/${roomId}/lite`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            
            if (data.success && data.lite) {
                currentLiteId = data.lite.id;
                currentLiteSlug = data.lite.slug;
                // Load the CARD view in iframe
                const cardUrl = `https://lite.gas.travel/${data.lite.slug}/card`;
                const fullUrl = `https://lite.gas.travel/#${data.lite.slug}`;
                iframe.src = cardUrl;
                linkEl.href = fullUrl;
                // Show slug with # prefix
                slugEl.textContent = '#' + data.lite.slug;
            } else {
                slugEl.textContent = '#error';
                iframe.srcdoc = '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:system-ui;color:#64748b;background:#0f172a;">Could not load preview</div>';
            }
        } catch (error) {
            console.error('Preview error:', error);
            slugEl.textContent = '#error';
            iframe.srcdoc = '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:system-ui;color:#ef4444;background:#0f172a;">Error loading preview</div>';
        }
    }
    
    function closeLitePreview() {
        document.getElementById('lite-preview-panel').style.display = 'none';
        document.getElementById('lite-preview-iframe').src = 'about:blank';
        currentLiteId = null;
        currentLiteSlug = null;
    }
    
    function refreshLitePreview() {
        if (currentPreviewRoomId) {
            showLitePreview(currentPreviewRoomId);
        }
    }
    
    function openLiteInNewWindow() {
        const iframe = document.getElementById('lite-preview-iframe');
        if (iframe.src && iframe.src !== 'about:blank') {
            window.open(iframe.src, '_blank');
        }
    }
    
    function openLiteCard() {
        if (currentLiteSlug) {
            window.open(`https://lite.gas.travel/${currentLiteSlug}/card`, '_blank');
        }
    }
    
    // Add eye buttons to room selectors
    function updateRoomPreviewButtons() {
        const roomSelectors = [
            'amenities-room-select',
            'images-room-select', 
            'availability-room-select',
            'terms-room-select',
            'offers-room-select',
            'vouchers-room-select',
            'upsells-room-select',
            'taxes-room-select',
            'bookings-room-select'
        ];
        
        roomSelectors.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Check if eye button already exists next to this select
            let eyeBtn = select.nextElementSibling;
            if (eyeBtn && eyeBtn.classList.contains('room-preview-eye')) {
                // Already exists, just update visibility
                if (select.value) {
                    eyeBtn.classList.add('visible');
                } else {
                    eyeBtn.classList.remove('visible');
                }
                return;
            }
            
            // Create eye button
            eyeBtn = document.createElement('button');
            eyeBtn.className = 'room-preview-eye';
            eyeBtn.innerHTML = 'ðŸ‘ï¸';
            eyeBtn.title = 'Preview room page';
            eyeBtn.type = 'button';
            eyeBtn.onclick = (e) => {
                e.preventDefault();
                const roomId = select.value;
                if (roomId) showLitePreview(roomId);
            };
            
            // Insert after the select, wrapping both in a flex container
            const parent = select.parentElement;
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'display: flex; align-items: center; gap: 8px;';
            
            // Move select into wrapper
            select.parentNode.insertBefore(wrapper, select);
            wrapper.appendChild(select);
            wrapper.appendChild(eyeBtn);
            
            // Show/hide based on selection
            if (select.value) {
                eyeBtn.classList.add('visible');
            } else {
                eyeBtn.classList.remove('visible');
            }
        });
    }
    
    // Hook into room selector changes - auto-open preview
    document.addEventListener('change', (e) => {
        if (e.target.id && e.target.id.includes('-room-select')) {
            setTimeout(updateRoomPreviewButtons, 100);
            const roomId = e.target.value;
            if (roomId) {
                showLitePreview(roomId);
            }
        }
    });
    
    // Initial setup after page load
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(updateRoomPreviewButtons, 1000);
    });
    
    // Also run on navigation
    setTimeout(updateRoomPreviewButtons, 1500);
    </script>

    <!-- AI Chat Widget Styles -->
    <style>
        #ai-chat-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            z-index: 9999;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #ai-chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }
        
        #ai-chat-widget {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 380px;
            height: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 9998;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        #ai-chat-widget.dragging {
            user-select: none;
            opacity: 0.9;
        }
        
        .ai-chat-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: move;
        }
        
        .ai-chat-header-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .ai-chat-header-info h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .ai-chat-header-info span {
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        #ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: #f9fafb;
        }
        
        .ai-chat-msg {
            display: flex;
            gap: 0.5rem;
            max-width: 90%;
        }
        
        .ai-chat-msg.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .ai-chat-msg-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
        
        .ai-chat-msg.assistant .ai-chat-msg-avatar {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        
        .ai-chat-msg-content {
            background: white;
            padding: 0.625rem 0.875rem;
            border-radius: 12px;
            font-size: 0.875rem;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .ai-chat-msg.user .ai-chat-msg-content {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }
        
        .ai-chat-quick {
            padding: 0.75rem 1rem;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .ai-chat-quick button {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 0.375rem 0.75rem;
            border-radius: 100px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
        }
        
        .ai-chat-quick button:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }
        
        .ai-chat-input-area {
            padding: 0.75rem 1rem;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.5rem;
        }
        
        #ai-chat-input {
            flex: 1;
            border: 1px solid #e5e7eb;
            border-radius: 100px;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
        }
        
        #ai-chat-input:focus {
            border-color: #6366f1;
        }
        
        .ai-chat-send {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .ai-chat-send:hover {
            transform: scale(1.1);
        }
        
        .ai-typing span {
            animation: blink 1.4s infinite both;
            font-size: 1.25rem;
            line-height: 1;
        }
        
        .ai-typing span:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes blink {
            0%, 80%, 100% { opacity: 0.2; }
            40% { opacity: 1; }
        }
        
        @media (max-width: 480px) {
            #ai-chat-widget {
                width: calc(100% - 32px);
                right: 16px;
                bottom: 90px;
                height: 60vh;
            }
        }
    </style>

    <!-- AI Chat Widget HTML -->
    <button id="ai-chat-button" onclick="toggleAIChat()" title="Need help?">
        <svg width="32" height="32" viewBox="0 0 120 120">
            <rect x="20" y="35" width="80" height="65" rx="8" fill="white"/>
            <rect x="25" y="40" width="70" height="55" rx="5" fill="#e0e7ff"/>
            <rect x="45" y="20" width="30" height="20" rx="4" fill="white"/>
            <circle cx="45" cy="62" r="6" fill="white"/>
            <circle cx="75" cy="62" r="6" fill="white"/>
            <circle cx="46" cy="62" r="3" fill="#1e293b"/>
            <circle cx="76" cy="62" r="3" fill="#1e293b"/>
            <path d="M 50 75 Q 60 83, 70 75" stroke="#1e293b" stroke-width="2.5" fill="none" stroke-linecap="round"/>
        </svg>
    </button>
    
    <div id="ai-chat-widget">
        <div class="ai-chat-header">
            <div class="ai-chat-header-avatar">
                <svg width="36" height="36" viewBox="0 0 120 120">
                    <rect x="20" y="35" width="80" height="65" rx="8" fill="#818cf8"/>
                    <rect x="25" y="40" width="70" height="55" rx="5" fill="#a5b4fc"/>
                    <rect x="45" y="20" width="30" height="20" rx="4" fill="#6366f1"/>
                    <rect x="50" y="15" width="20" height="12" rx="3" fill="#818cf8"/>
                    <circle cx="45" cy="62" r="7" fill="white"/>
                    <circle cx="75" cy="62" r="7" fill="white"/>
                    <circle cx="46" cy="62" r="3.5" fill="#1e293b"/>
                    <circle cx="76" cy="62" r="3.5" fill="#1e293b"/>
                    <circle cx="47" cy="61" r="1.2" fill="white"/>
                    <circle cx="77" cy="61" r="1.2" fill="white"/>
                    <path d="M 50 77 Q 60 86, 70 77" stroke="#1e293b" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                    <circle cx="85" cy="45" r="8" fill="#10b981"/>
                    <text x="85" y="48" text-anchor="middle" fill="white" font-size="8" font-weight="bold">GAS</text>
                </svg>
            </div>
            <div class="ai-chat-header-info">
                <h4>Gus</h4>
                <span>Here to help!</span>
            </div>
        </div>
        
        <div id="ai-chat-messages"></div>
        
        <div class="ai-chat-quick" id="ai-chat-quick-buttons">
            <button onclick="askQuickQuestion('How do I create a blog post?')">Create blog</button>
            <button onclick="askQuickQuestion('How do I add attractions?')">Add attractions</button>
            <button onclick="askQuickQuestion('How do pricing tier