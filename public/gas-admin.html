<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAS Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --accent-light: #e0e7ff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --error: #ef4444;
            --error-light: #fee2e2;
            --border-color: #e2e8f0;
            --border: #e2e8f0;
            --sidebar-bg: #ffffff;
            --sidebar-text: #64748b;
            --sidebar-hover: #f1f5f9;
            --sidebar-active: #6366f1;
        }

        /* Website Editor Tabs */
        .editor-tab.active {
            color: #7c3aed !important;
            border-bottom-color: #7c3aed !important;
        }
        .editor-tab:hover {
            color: #7c3aed;
            background: #f8fafc;
        }
        .sub-tab {
            transition: all 0.2s ease;
        }
        .sub-tab:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 240px 1fr;
            min-height: 100vh;
        }

        /* Sidebar - Light theme */
        .sidebar {
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 1.5rem 0 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .logo {
            padding: 0 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo p {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .nav {
            padding: 0 0.75rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.25rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px;
            transition: background 0.15s;
        }
        
        .nav-label:hover {
            background: var(--sidebar-hover);
        }
        
        .nav-label::after {
            content: '‚ñº';
            font-size: 0.5rem;
            transition: transform 0.2s;
        }
        
        .nav-section.collapsed .nav-label::after {
            transform: rotate(-90deg);
        }
        
        .nav-subsection {
            margin: 0.25rem 0;
        }
        
        .nav-subsection-toggle {
            font-weight: 500;
        }
        
        .nav-subsection-arrow {
            font-size: 0.7rem;
            opacity: 0.6;
            transition: transform 0.2s;
        }
        
        .nav-subsection.expanded .nav-subsection-arrow {
            transform: rotate(90deg);
        }
        
        .nav-subsection-items {
            border-left: 2px solid var(--border);
            margin-left: 0.75rem;
        }
        
        .nav-subsection-items .nav-item {
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
        }
        
        .nav-section-items {
            overflow: hidden;
            transition: max-height 0.3s ease;
            max-height: 500px;
        }
        
        .nav-section.collapsed .nav-section-items {
            max-height: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.15s;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #ffffff;
            font-weight: 600;
        }

        .nav-item.feature-locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-item.feature-locked:hover {
            background: transparent;
            color: var(--text-secondary);
        }

        .nav-icon {
            font-size: 1.1rem;
        }

        /* User Profile Section */
        .user-profile-section {
            margin-top: auto;
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            background: var(--bg-primary);
        }

        .user-profile-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: capitalize;
        }

        .logout-btn {
            width: 100%;
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        /* Main Content */
        .main {
            padding: 1.5rem 2rem;
            overflow-y: auto;
            height: 100vh;
            background: var(--bg-primary);
        }

        .header {
            margin-bottom: 1.5rem;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--accent);
        }

        .stat-card::before {
            display: none;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .stat-icon {
            font-size: 1.25rem;
            color: var(--accent);
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        th {
            text-align: left;
            padding: 0.625rem 0.75rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--bg-primary);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-secondary {
            background: #f3f4f6;
            color: var(--text-secondary);
        }

        .badge-warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .badge-info {
            background: var(--accent-light);
            color: var(--accent);
        }

        /* Preset Buttons */
        .preset-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #475569;
        }
        .preset-btn:hover {
            background: #e0f2fe;
            border-color: #3b82f6;
            color: #1d4ed8;
            transform: translateY(-1px);
        }
        .preset-btn:active {
            transform: translateY(0);
        }
        .preset-btn.added {
            background: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        /* Feature Grid for Marketing */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.75rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .feature-item:hover {
            background: #f0f9ff;
            border-color: #3b82f6;
        }
        .feature-item:has(input:checked) {
            background: #dcfce7;
            border-color: #22c55e;
        }
        .feature-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .custom-feature-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #e0f2fe;
            border: 1px solid #7dd3fc;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 0.25rem;
        }
        .custom-feature-tag button {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
            padding: 0;
        }

        /* Button */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            box-shadow: 0 1px 2px rgba(99, 102, 241, 0.2);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: #ffffff;
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--accent);
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #ffffff;
        }
        
        .btn-danger:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.35rem;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.15s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        textarea.form-input {
            min-height: 80px;
            resize: vertical;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .channel-option:hover {
            border-color: var(--accent) !important;
            background: #f8fafc;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Template Selection */
        .template-option {
            transition: all 0.2s ease;
        }
        
        .template-option:hover {
            border-color: var(--primary) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .template-option:has(input:checked) {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .template-option:has(input:checked)::after {
            content: '‚úì';
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .template-option {
            position: relative;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
        }

        .empty-icon {
            font-size: 2.5rem;
            opacity: 0.3;
            margin-bottom: 0.75rem;
        }

        .empty-state h3 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        /* View Sections */
        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Image Gallery */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .image-item {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 6px;
            overflow: hidden;
            background: var(--bg-primary);
            border: 1px solid var(--border);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.35rem;
        }

        /* Amenity Item */
        .amenity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                height: auto;
            }
        }

        /* Filter Tabs */
        .filter-tab {
            padding: 0.4rem 0.75rem;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.8rem;
        }

        .filter-tab:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .filter-tab.active {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
            font-weight: 500;
        }

        /* Image Gallery Grid */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
            padding: 0.75rem;
        }

        .image-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            transition: all 0.15s;
        }

        .image-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .image-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
        }

        .image-card-info {
            padding: 0.75rem;
        }

        .image-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-bottom: 0.5rem;
        }

        .image-tag {
            background: var(--bg-primary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .image-tag.property { border-left: 2px solid var(--accent); }
        .image-tag.room { border-left: 2px solid var(--success); }
        .image-tag.location { border-left: 2px solid var(--warning); }

        .image-actions {
            display: flex;
            gap: 0.35rem;
            margin-top: 0.5rem;
        }

        .image-actions button {
            flex: 1;
            padding: 0.35rem;
            font-size: 0.75rem;
        }

        /* Upload Modal Specific */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 1rem;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .upload-zone.dragover {
            border-color: var(--accent);
            background: var(--accent-light);
        }

        .upload-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
            max-height: 250px;
            overflow-y: auto;
        }

        .upload-preview-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .upload-preview-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .upload-preview-item .remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }

        .upload-preview-item .error {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(220, 38, 38, 0.9);
            color: white;
            padding: 0.2rem;
            font-size: 0.65rem;
            text-align: center;
        }

        .assignment-section {
            background: var(--bg-primary);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .assignment-section h4 {
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.5rem;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.8rem;
        }

        .checkbox-label:hover {
            border-color: var(--accent);
        }

        .checkbox-label input[type="checkbox"]:checked ~ span {
            color: var(--accent);
            font-weight: 500;
        }

        /* Availability Grid Styles */
        #availability-grid {
            font-size: 0.75rem;
            background: #ffffff;
        }
        
        #availability-grid th,
        #availability-grid td {
            border: 1px solid var(--border);
        }
        
        #availability-grid th {
            background: var(--bg-primary);
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        #availability-grid td:hover {
            filter: brightness(0.95);
        }
        
        /* Scrollbar for light theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        /* Client Selector Styles */
        .client-selector {
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0 1rem 1rem;
        }
        
        .client-selector label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .client-selector select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #334155;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
        }
        
        .client-selector select:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        .client-selector select option {
            background: white;
            color: #334155;
            padding: 0.5rem;
        }
        
        .client-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            padding: 0.4rem 0.6rem;
            background: #f1f5f9;
            border-radius: 6px;
            color: #64748b;
        }
        
        .client-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            flex-shrink: 0;
        }
        
        .client-indicator.all-clients .dot {
            background: #f59e0b;
        }
        
        #clientIndicatorText {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Dashboard Category Cards */
        .dashboard-categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 1200px) {
            .dashboard-categories {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-categories {
                grid-template-columns: 1fr;
            }
        }

        .category-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
            transition: background 0.3s ease;
        }

        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }

        .category-card:hover::before {
            background: var(--accent);
        }

        .category-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .category-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }

        .category-card p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0 0 1rem 0;
            line-height: 1.4;
        }

        .category-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .category-links span {
            font-size: 0.75rem;
            padding: 0.35rem 0.75rem;
            background: var(--bg-primary);
            border-radius: 20px;
            color: var(--text-secondary);
            transition: all 0.2s;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .category-links span:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        /* Website status badges */
        .website-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .website-status.status-active, .website-status.status-deployed {
            background: #dcfce7;
            color: #166534;
        }
        .website-status.status-draft {
            background: #fef3c7;
            color: #92400e;
        }
        .website-status.status-paused {
            background: #fee2e2;
            color: #991b1b;
        }
        .website-selector-banner {
            transition: all 0.3s ease;
        }
        
        /* GasSync Styles */
        .connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .connection-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .connection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .connection-card.status-error { border-left-color: #ef4444; }
        .connection-card.status-syncing { border-left-color: #f59e0b; }
        .connection-card.status-disabled { border-left-color: #9ca3af; opacity: 0.7; }
        .connection-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .connection-logo {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .connection-info h4 { margin: 0; font-size: 16px; }
        .connection-info .adapter-name { color: #6b7280; font-size: 13px; }
        .connection-status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: auto;
        }
        .connection-status-badge.connected { background: #d1fae5; color: #047857; }
        .connection-status-badge.error { background: #fee2e2; color: #dc2626; }
        .connection-status-badge.syncing { background: #fef3c7; color: #d97706; }
        .connection-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
            padding: 15px 0;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }
        .connection-stat { text-align: center; }
        .connection-stat-value { font-size: 20px; font-weight: 600; color: #111827; }
        .connection-stat-label { font-size: 11px; color: #6b7280; text-transform: uppercase; }
        .connection-meta { font-size: 12px; color: #6b7280; margin-bottom: 15px; }
        .connection-actions { display: flex; gap: 8px; }
        .connection-actions .btn { flex: 1; padding: 8px; font-size: 13px; }
        .adapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }
        .adapter-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .adapter-card:hover { border-color: #3b82f6; background: #eff6ff; }
        .adapter-card.selected { border-color: #3b82f6; background: #dbeafe; }
        .adapter-card-logo { font-size: 32px; margin-bottom: 8px; }
        .adapter-card-name { font-weight: 500; font-size: 13px; }
        .adapter-card-via { font-size: 10px; color: #6b7280; margin-top: 4px; }
        .connection-status-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .connection-status-item .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .connection-status-item .status-dot.connected { background: #10b981; }
        .connection-status-item .status-dot.error { background: #ef4444; }
        .connection-status-item .status-dot.syncing { background: #f59e0b; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .gas-sync-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        .gas-sync-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
        }
        .gas-sync-tab:hover { color: #111827; }
        .gas-sync-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; background: white; }
        .gas-sync-tab-content { min-height: 250px; }
        #credentialFields .form-group { margin-bottom: 15px; }
        #credentialFields label { display: block; margin-bottom: 5px; font-weight: 500; }
        #credentialFields input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; }
        #credentialFields .help-text { font-size: 12px; color: #6b7280; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1>GAS_ADMIN</h1>
                <p>Property Management System</p>
            </div>
            
            <!-- Client Selector - Hidden for now -->
            <div class="client-selector" style="display: none;">
                <label>üëÅÔ∏è Viewing Client</label>
                <select id="globalClientSelector" onchange="switchClient(this.value)">
                    <option value="">üåê All Clients (Admin View)</option>
                </select>
                <div class="client-indicator" id="clientIndicator">
                    <span class="dot"></span>
                    <span id="clientIndicatorText">All clients</span>
                </div>
            </div>
            
            <!-- Agency Filter Banner - Clean Design -->
            <div id="agencyFilterBanner" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.75rem 1rem; border-radius: 12px; margin: 0 0.75rem 1rem 0.75rem; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0;">üè®</div>
                        <div>
                            <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9;">Viewing</div>
                            <div id="agencyFilterName" style="font-weight: 600; font-size: 1rem; line-height: 1.2;"></div>
                            <code id="agencyFilterCode" style="display: none;"></code>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-shrink: 0;">
                        <button id="managePlanBtn" class="billing-admin-only" onclick="openAssignPlanModal(selectedAccountId, document.getElementById('agencyFilterName').textContent)" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500; white-space: nowrap; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            ‚öôÔ∏è Manage
                        </button>
                        <button id="clearFilterBtn" onclick="clearAccountFilter()" style="background: rgba(0,0,0,0.1); border: none; color: white; padding: 0.4rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.2)'" onmouseout="this.style.background='rgba(0,0,0,0.1)'">
                            ‚úï Clear
                        </button>
                    </div>
                </div>
            </div>

            <nav class="nav">
                <div class="nav-section">
                    <div class="nav-label" onclick="toggleNavSection(this)">Overview</div>
                    <div class="nav-section-items">
                    <a class="nav-item active" data-view="dashboard" href="#" onclick="navClick(this, 'dashboard'); return false;">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label" onclick="toggleNavSection(this)">Accounts</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="accounts" href="#" onclick="navClick(this, 'accounts'); return false;">
                        <span class="nav-icon">üë•</span>
                        <span>All Accounts</span>
                    </a>
                    <a class="nav-item agency-only" data-view="management-requests" href="#" onclick="navClick(this, 'management-requests'); return false;" style="display: none;">
                        <span class="nav-icon">üìã</span>
                        <span>Management Requests</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label" onclick="toggleNavSection(this)">Property Management</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="properties" href="#" onclick="navClick(this, 'properties'); return false;">
                        <span class="nav-icon">üè®</span>
                        <span>Properties</span>
                    </a>
                    <a class="nav-item" data-view="rooms" href="#" onclick="navClick(this, 'rooms'); return false;">
                        <span class="nav-icon">üõèÔ∏è</span>
                        <span>Rooms & Units</span>
                    </a>
                    <a class="nav-item" data-view="images" href="#" onclick="navClick(this, 'images'); return false;">
                        <span class="nav-icon">üñºÔ∏è</span>
                        <span>Images</span>
                    </a>
                    <a class="nav-item" data-view="amenities" href="#" onclick="navClick(this, 'amenities'); return false;">
                        <span class="nav-icon">‚≠ê</span>
                        <span>Amenities</span>
                    </a>
                    <a class="nav-item" data-view="availability" href="#" onclick="navClick(this, 'availability'); return false;">
                        <span class="nav-icon">üìÖ</span>
                        <span>Availability</span>
                    </a>
                    <a class="nav-item client-connection" data-view="client-connection-view" href="#" onclick="navClick(this, 'client-connection-view'); return false;" style="display: none;">
                        <span class="nav-icon">üîó</span>
                        <span>Connection</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label" onclick="toggleNavSection(this)">Bookings & Revenue</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="bookings" href="#" onclick="navClick(this, 'bookings'); return false;">
                        <span class="nav-icon">üìÖ</span>
                        <span>Bookings</span>
                    </a>
                    <a class="nav-item" data-view="offers" href="#" onclick="navClick(this, 'offers'); return false;">
                        <span class="nav-icon">üè∑Ô∏è</span>
                        <span>Offers</span>
                    </a>
                    <a class="nav-item" data-view="vouchers" href="#" onclick="navClick(this, 'vouchers'); return false;">
                        <span class="nav-icon">üéüÔ∏è</span>
                        <span>Vouchers</span>
                    </a>
                    <a class="nav-item" data-view="upsells" href="#" onclick="navClick(this, 'upsells'); return false;">
                        <span class="nav-icon">üéÅ</span>
                        <span>Upsells</span>
                    </a>
                    <a class="nav-item" data-view="vendors" href="#" onclick="navClick(this, 'vendors'); return false;">
                        <span class="nav-icon">ü§ù</span>
                        <span>Vendors</span>
                    </a>
                    <a class="nav-item" data-view="taxes" href="#" onclick="navClick(this, 'taxes'); return false;">
                        <span class="nav-icon">üèõÔ∏è</span>
                        <span>Taxes</span>
                    </a>
                    <a class="nav-item" data-view="payments" href="#" onclick="navClick(this, 'payments'); return false;">
                        <span class="nav-icon">üí≥</span>
                        <span>Payments</span>
                    </a>
                    <a class="nav-item" data-view="deposit-rules" href="#" onclick="navClick(this, 'deposit-rules'); return false;">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>Deposit Rules</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label" onclick="toggleNavSection(this)">Marketing</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="marketing" href="#" onclick="navClick(this, 'marketing'); return false;">
                        <span class="nav-icon">üì£</span>
                        <span>Features & Tags</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Website Builder</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="deploy-sites" href="#" onclick="navClick(this, 'deploy-sites'); return false;" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; border-radius: 8px; margin-bottom: 0.5rem;">
                        <span class="nav-icon">üöÄ</span>
                        <span>Create Sites</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed master-only" style="display: none;">
                    <div class="nav-label" onclick="toggleNavSection(this)">Knowledge Base</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="kb-articles" href="#" onclick="navClick(this, 'kb-articles'); return false;">
                        <span class="nav-icon">üìö</span>
                        <span>Articles</span>
                    </a>
                    <a class="nav-item" data-view="kb-unanswered" href="#" onclick="navClick(this, 'kb-unanswered'); return false;">
                        <span class="nav-icon">‚ùì</span>
                        <span>Unanswered</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed" id="nav-billing-section">
                    <div class="nav-label" onclick="toggleNavSection(this)">Billing</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="my-billing" href="#" onclick="navClick(this, 'my-billing'); return false;">
                        <span class="nav-icon">üí≥</span>
                        <span>My Subscription</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-overview" href="#" onclick="navClick(this, 'billing-overview'); return false;">
                        <span class="nav-icon">üìä</span>
                        <span>Revenue Dashboard</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-products" href="#" onclick="navClick(this, 'billing-products'); return false;">
                        <span class="nav-icon">üì¶</span>
                        <span>Products</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-plans" href="#" onclick="navClick(this, 'billing-plans'); return false;">
                        <span class="nav-icon">üìã</span>
                        <span>Plans</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-addons" href="#" onclick="navClick(this, 'billing-addons'); return false;">
                        <span class="nav-icon">üß©</span>
                        <span>Add-ons</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-subscribers" href="#" onclick="navClick(this, 'billing-subscribers'); return false;">
                        <span class="nav-icon">üë•</span>
                        <span>Subscribers</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="billing-affiliates" href="#" onclick="navClick(this, 'billing-affiliates'); return false;">
                        <span class="nav-icon">ü§ù</span>
                        <span>Affiliates</span>
                    </a>
                    <a class="nav-item billing-admin-only" style="display:none;" data-view="my-referrals" href="#" onclick="navClick(this, 'my-referrals'); return false;">
                        <span class="nav-icon">üí∞</span>
                        <span>My Referrals</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section master-only" style="display: none;">
                    <div class="nav-label" onclick="toggleNavSection(this)">Channel Managers</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="gas-sync-dashboard" href="#" onclick="navClick(this, 'gas-sync-dashboard'); return false;">
                        <span class="nav-icon">üìä</span>
                        <span>Sync Dashboard</span>
                    </a>
                    <a class="nav-item" data-view="gas-sync-connections" href="#" onclick="navClick(this, 'gas-sync-connections'); return false;">
                        <span class="nav-icon">üîó</span>
                        <span>Connections</span>
                    </a>
                    <a class="nav-item" data-view="gas-sync-properties" href="#" onclick="navClick(this, 'gas-sync-properties'); return false;">
                        <span class="nav-icon">üè†</span>
                        <span>Synced Properties</span>
                    </a>
                    <a class="nav-item" data-view="gas-sync-logs" href="#" onclick="navClick(this, 'gas-sync-logs'); return false;">
                        <span class="nav-icon">üìã</span>
                        <span>Sync Logs</span>
                    </a>
                    <a class="nav-item" href="/sync-review" target="_blank">
                        <span class="nav-icon">üîÑ</span>
                        <span>Sync Review</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section master-only" style="display: none;">
                    <div class="nav-label" onclick="toggleNavSection(this)">System</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="tasks" href="#" onclick="navClick(this, 'tasks'); return false;">
                        <span class="nav-icon">‚úÖ</span>
                        <span>Tasks</span>
                    </a>
                    <a class="nav-item" data-view="integrations" href="#" onclick="navClick(this, 'integrations'); return false;">
                        <span class="nav-icon">üîó</span>
                        <span>Integrations</span>
                    </a>
                    <a class="nav-item" data-view="settings" href="#" onclick="navClick(this, 'settings'); return false;">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>Settings</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Apps</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="app-blog" data-requires-feature="blog_module" href="#" onclick="return handleFeatureClick(this, 'app-blog', 'blog_module');">
                        <span class="nav-icon">üìù</span>
                        <span>Blog</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;">üîí</span>
                    </a>
                    <a class="nav-item" data-view="app-attractions" data-requires-feature="attractions_module" href="#" onclick="return handleFeatureClick(this, 'app-attractions', 'attractions_module');">
                        <span class="nav-icon">üéØ</span>
                        <span>Attractions</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;">üîí</span>
                    </a>
                    <a class="nav-item" data-view="app-reviews" data-requires-feature="reviews_widget" href="#" onclick="return handleFeatureClick(this, 'app-reviews', 'reviews_widget');">
                        <span class="nav-icon">‚≠ê</span>
                        <span>Reviews</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;">üîí</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed master-only" style="display: none;">
                    <div class="nav-label" onclick="toggleNavSection(this)">Developers</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="api-docs" data-requires-feature="api_access" href="#" onclick="return handleFeatureClick(this, 'api-docs', 'api_access');">
                        <span class="nav-icon">üîå</span>
                        <span>API</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;">üîí</span>
                    </a>
                    </div>
                </div>

                <div class="nav-section collapsed">
                    <div class="nav-label" onclick="toggleNavSection(this)">Website</div>
                    <div class="nav-section-items">
                    <a class="nav-item" data-view="wordpress" data-requires-feature="has_subscription" href="#" onclick="return handleFeatureClick(this, 'wordpress', 'has_subscription');">
                        <span class="nav-icon"><svg width="18" height="18" viewBox="0 0 122.5 122.5" fill="currentColor"><path d="M8.7 61.3c0 20.8 12.1 38.8 29.6 47.3L13 40.3c-2.8 6.5-4.3 13.7-4.3 21zm88.6-2.7c0-6.5-2.3-11-4.3-14.5-2.7-4.3-5.2-8-5.2-12.3 0-4.8 3.7-9.3 8.9-9.3h.7c-9.4-8.6-21.9-13.9-35.7-13.9-18.5 0-34.7 9.5-44.2 23.8h3.4c5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.8.3-6 .5l19.1 57 11.5-34.5-8.2-22.5c-2.8-.2-5.5-.5-5.5-.5-2.8-.2-2.5-4.5.3-4.3 0 0 8.7.7 13.9.7 5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.9.3-6 .5l19 56.5 5.2-17.5c2.3-7.3 4-12.5 4-17zm-36.3 7.6l-15.8 45.8c4.7 1.4 9.7 2.2 14.8 2.2 6.1 0 12-1.1 17.4-3-.1-.2-.3-.5-.4-.7l-16-43.3zm45.1-29.8c.5 3.4.7 7 .7 10.9 0 10.8-2 22.9-8 38l-21.8 63.1c21.2-12.4 35.5-35.5 35.5-62.1 0-17.9-6.2-34.3-16.4-47.9zM61.3 0C27.5 0 0 27.5 0 61.3c0 33.8 27.5 61.3 61.3 61.3 33.8 0 61.3-27.5 61.3-61.3C122.5 27.5 95 0 61.3 0zm0 119.7c-32.2 0-58.5-26.2-58.5-58.5 0-32.2 26.2-58.5 58.5-58.5 32.2 0 58.5 26.2 58.5 58.5-.1 32.3-26.3 58.5 58.5z"/></svg></span>
                        <span>WordPress</span>
                        <span class="feature-lock" style="display:none; margin-left: auto; font-size: 0.75rem;">üîí</span>
                    </a>
                    </div>
                </div>
                
                <!-- User Profile Section -->
                <div class="user-profile-section" id="userProfileSection">
                    <div class="user-profile-info" onclick="showView('my-account')" style="cursor: pointer;" title="Edit Profile">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-details">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRole">-</div>
                        </div>
                        <span style="margin-left: auto; color: var(--text-muted); font-size: 0.8rem;">‚úèÔ∏è</span>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">
                        <span>üö™</span> Sign Out
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Dashboard Overview</h2>
                            <p>Welcome back! Here's what's happening with your properties.</p>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">üè®</span>
                        </div>
                        <div class="stat-value" id="stat-properties">-</div>
                        <div class="stat-label">Properties</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">üõèÔ∏è</span>
                        </div>
                        <div class="stat-value" id="stat-rooms">-</div>
                        <div class="stat-label">Rooms & Units</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">üìÖ</span>
                        </div>
                        <div class="stat-value" id="stat-bookings">-</div>
                        <div class="stat-label">Total Bookings</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-icon">üîó</span>
                        </div>
                        <div class="stat-value" id="stat-integrations">-</div>
                        <div class="stat-label">Active Integrations</div>
                    </div>
                </div>

                <!-- Category Navigation Cards -->
                <div class="dashboard-categories">
                    <div class="category-card" onclick="showView('properties')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                        </div>
                        <h3>Property Management</h3>
                        <p>Manage your properties, rooms, images and amenities</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); showView('properties')">Properties</span>
                            <span onclick="event.stopPropagation(); showView('rooms')">Rooms</span>
                            <span onclick="event.stopPropagation(); showView('images')">Images</span>
                            <span onclick="event.stopPropagation(); showView('amenities')">Amenities</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="showView('bookings')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <h3>Bookings & Revenue</h3>
                        <p>View bookings, manage offers, vouchers and taxes</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); showView('bookings')">Bookings</span>
                            <span onclick="event.stopPropagation(); showView('offers')">Offers</span>
                            <span onclick="event.stopPropagation(); showView('vouchers')">Vouchers</span>
                            <span onclick="event.stopPropagation(); showView('taxes')">Taxes</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="showView('availability')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M18 20V10"></path>
                                <path d="M12 20V4"></path>
                                <path d="M6 20v-6"></path>
                            </svg>
                        </div>
                        <h3>Availability & Pricing</h3>
                        <p>Manage calendars, rates and channel connections</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); showView('availability')">Calendar</span>
                            <span onclick="event.stopPropagation(); showView('rateplans')">Rate Plans</span>
                            <span onclick="event.stopPropagation(); showView('integrations')">Channels</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="showView('marketing')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                        </div>
                        <h3>Marketing & Website</h3>
                        <p>Features, upsells, website builder and content</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); showView('marketing')">Features</span>
                            <span onclick="event.stopPropagation(); showView('upsells')">Upsells</span>
                            <span onclick="event.stopPropagation(); showView('wordpress')">Website</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="showView('integrations')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                        </div>
                        <h3>Connectivity</h3>
                        <p>Connect channel managers and sync properties</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); openWizard('beds24')">Beds24</span>
                            <span onclick="event.stopPropagation(); openWizard('hostaway')">Hostaway</span>
                            <span onclick="event.stopPropagation(); openWizard('smoobu')">Smoobu</span>
                            <span onclick="event.stopPropagation(); showView('integrations')">All Channels</span>
                        </div>
                    </div>

                    <div class="category-card" onclick="showView('app-blog')">
                        <div class="category-icon" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                        </div>
                        <h3>Apps</h3>
                        <p>Blog, attractions, reviews and API documentation</p>
                        <div class="category-links">
                            <span onclick="event.stopPropagation(); showView('app-blog')">Blog</span>
                            <span onclick="event.stopPropagation(); showView('app-attractions')">Attractions</span>
                            <span onclick="event.stopPropagation(); showView('app-reviews')">Reviews</span>
                            <span onclick="event.stopPropagation(); showView('api-docs')">API Docs</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agencies View -->
            <div id="accounts" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üë• Accounts</h2>
                            <p>Manage all accounts - Master Admin, Agency Admins, Sub Masters, and Admins</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="generateMissingCodes()" id="generateCodesBtn" style="display: none;">
                                üîÑ Generate Missing Codes
                            </button>
                            <button class="btn" onclick="openAddAccountModal()">
                                <span>+</span>
                                <span>Add Account</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total-accounts">-</div>
                        <div class="stat-label">Total Accounts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-agency-admins">-</div>
                        <div class="stat-label">Agency Admins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-submaster-admins">-</div>
                        <div class="stat-label">Sub Masters</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-admins">-</div>
                        <div class="stat-label">Admins</div>
                    </div>
                </div>

                <!-- Role Filter -->
                <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary account-filter active" data-role="all" onclick="filterAccounts('all')">All</button>
                        <button class="btn btn-secondary account-filter" data-role="agency_admin" onclick="filterAccounts('agency_admin')">üè¢ Agency Admins</button>
                        <button class="btn btn-secondary account-filter" data-role="submaster_admin" onclick="filterAccounts('submaster_admin')">üìÅ Sub Masters</button>
                        <button class="btn btn-secondary account-filter" data-role="admin" onclick="filterAccounts('admin')">üë§ Admins</button>
                    </div>
                </div>

                <div class="card">
                    <div id="accounts-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem;">Loading accounts...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keep old views hidden for backward compatibility -->
            <div id="agencies" class="view" style="display:none;"></div>
            <div id="clients" class="view" style="display:none;"></div>

            <!-- Management Requests View (Agency Admin) -->
            <div id="management-requests" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìã Management Requests</h2>
                            <p>Review and manage requests from property owners</p>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-pending-requests">-</div>
                        <div class="stat-label">Pending Requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-managed-accounts">-</div>
                        <div class="stat-label">Managed Accounts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-managed-properties">-</div>
                        <div class="stat-label">Properties Under Management</div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <button class="btn request-filter active" data-status="pending" onclick="filterManagementRequests('pending')" style="background: var(--accent);">
                        ‚è≥ Pending
                    </button>
                    <button class="btn btn-secondary request-filter" data-status="approved" onclick="filterManagementRequests('approved')">
                        ‚úÖ Approved
                    </button>
                    <button class="btn btn-secondary request-filter" data-status="rejected" onclick="filterManagementRequests('rejected')">
                        ‚ùå Rejected
                    </button>
                    <button class="btn btn-secondary request-filter" data-status="all" onclick="filterManagementRequests('all')">
                        All
                    </button>
                </div>

                <!-- Requests List -->
                <div class="card">
                    <div id="managementRequestsList">
                        <p style="text-align: center; padding: 2rem; color: var(--text-secondary);">Loading requests...</p>
                    </div>
                </div>
            </div>

            <!-- Properties View -->
            <div id="properties" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Properties</h2>
                            <p>Manage your property listings</p>
                        </div>
                        <a href="#" onclick="openWizard('beds24')" class="btn">
                            <span>+</span>
                            <span>Import Property</span>
                        </a>
                    </div>
                </div>

                <div class="card">
                    <div id="properties-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem;">Loading properties...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rooms View -->
            <div id="rooms" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Rooms & Units</h2>
                            <p>Manage bookable rooms and units</p>
                        </div>
                        <button class="btn" onclick="openAddRoomModal()">
                            <span>+</span>
                            <span>Add Room</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="rooms-property-select" class="form-input" onchange="loadRoomsForProperty()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="rooms-list">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            Select a property to view rooms
                        </p>
                    </div>
                </div>
            </div>

            <!-- Bookings View -->
            <div id="bookings" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Bookings</h2>
                            <p>View all reservations</p>
                        </div>
                        <button class="btn" onclick="openAddBookingModal()">
                            <span>+</span>
                            <span>Add Booking</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="bookings-property-select" class="form-input" onchange="loadBookingsForProperty()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="bookings-room-select" class="form-input" onchange="loadBookingsForProperty()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Status</label>
                            <select id="bookings-status-select" class="form-input" onchange="loadBookingsForProperty()">
                                <option value="">All Statuses</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="pending">Pending</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="bookings-list">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            Select a property to view bookings
                        </p>
                    </div>
                </div>
            </div>

            <!-- Images View -->
            <div id="images" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Images</h2>
                            <p>Manage property, room, and location images</p>
                        </div>
                        <button class="btn" onclick="openImageUploadModal()">
                            <span>+</span>
                            <span>Upload Images</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="images-property-select" class="form-input" onchange="loadImagesForProperty()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="images-room-select" class="form-input" onchange="loadImagesForProperty()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Image Stats Summary -->
                <div id="images-stats" style="display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Property Images</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="property-image-count">0</div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Room Images</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="room-image-count">0</div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Location Images</div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="location-image-count">0</div>
                    </div>
                    <div class="card" style="padding: 1.5rem;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Images</div>
                        <div style="font-size: 2rem; font-weight: 700;" id="total-image-count">0</div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div id="images-filter-tabs" style="display: none; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button class="filter-tab active" data-filter="all" onclick="filterImages('all')">
                        All Images
                    </button>
                    <button class="filter-tab" data-filter="property" onclick="filterImages('property')">
                        üè® Property
                    </button>
                    <button class="filter-tab" data-filter="rooms" onclick="filterImages('rooms')">
                        üõèÔ∏è Rooms
                    </button>
                    <button class="filter-tab" data-filter="location" onclick="filterImages('location')">
                        üìç Location
                    </button>
                </div>

                <div class="card">
                    <div id="images-gallery">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            Select a property to view and manage images
                        </p>
                    </div>
                </div>
            </div>

            <!-- Amenities View - RESTRUCTURED -->
            <div id="amenities" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>‚≠ê Amenities</h2>
                            <p>Manage room features, facilities, and policies</p>
                        </div>
                        <button class="btn" onclick="saveAllAmenities()">
                            <span>üíæ</span>
                            <span>Save All Changes</span>
                        </button>
                    </div>
                </div>

                <!-- Property/Room Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="amenities-property-select" class="form-input" onchange="loadAmenitiesRooms()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="amenities-room-select" class="form-input" onchange="loadAmenitiesForRoom()">
                                <option value="">Select Room...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Amenities Tabs -->
                <div class="filter-tabs" style="margin-bottom: 1rem; flex-wrap: wrap;" id="amenities-tabs">
                    <button class="filter-tab active" data-amenity-tab="rooms" onclick="switchAmenityTab('rooms')">üõèÔ∏è Rooms</button>
                    <button class="filter-tab" data-amenity-tab="bathrooms" onclick="switchAmenityTab('bathrooms')">üöø Bathrooms</button>
                    <button class="filter-tab" data-amenity-tab="features" onclick="switchAmenityTab('features')">üì∫ In-Room Features</button>
                    <button class="filter-tab" data-amenity-tab="terms" onclick="switchAmenityTab('terms')">üìã Terms & Policies</button>
                </div>

                <!-- Tab Content Container -->
                <div id="amenities-tab-content">
                    <!-- Rooms Tab -->
                    <div id="amenities-tab-rooms" class="amenity-tab-panel">
                        <div class="card">
                            <div class="card-header">
                                <h3>üõèÔ∏è Bed Configuration</h3>
                            </div>
                            <div class="card-body">
                                <p style="color: var(--text-secondary); margin-bottom: 1rem;">Configure the beds in this room</p>
                                <div id="bed-configuration">
                                    <div class="bed-row" style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 1rem; align-items: center; margin-bottom: 0.75rem;">
                                        <select class="form-input bed-type-select">
                                            <option value="">Select bed type...</option>
                                            <option value="king">King Bed</option>
                                            <option value="queen">Queen Bed</option>
                                            <option value="double">Double Bed</option>
                                            <option value="twin">Twin/Single Bed</option>
                                            <option value="sofa">Sofa Bed</option>
                                            <option value="bunk">Bunk Bed</option>
                                            <option value="cot">Cot/Crib</option>
                                        </select>
                                        <input type="number" class="form-input bed-qty" min="1" max="10" value="1" style="width: 80px;">
                                        <button class="btn btn-secondary btn-small" onclick="removeBedRow(this)" style="color: var(--error);">‚úï</button>
                                    </div>
                                </div>
                                <button class="btn btn-secondary btn-small" onclick="addBedRow()" style="margin-top: 0.5rem;">+ Add Bed</button>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>üõèÔ∏è Room Amenities</h3>
                            </div>
                            <div class="card-body" id="room-amenities-list">
                                <p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Select a room to load amenities</p>
                            </div>
                        </div>
                    </div>

                    <!-- Bathrooms Tab -->
                    <div id="amenities-tab-bathrooms" class="amenity-tab-panel" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h3>üöø Bathroom Type</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="bathroom-type" value="ensuite" style="width: 18px; height: 18px;">
                                            <span><strong>Ensuite (Private)</strong> - Bathroom inside the room</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="bathroom-type" value="adjacent" style="width: 18px; height: 18px;">
                                            <span><strong>Adjacent (Private)</strong> - Private bathroom outside room</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="bathroom-type" value="shared" style="width: 18px; height: 18px;">
                                            <span><strong>Shared</strong> - Shared with other guests</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>üöø Bathroom Amenities</h3>
                            </div>
                            <div class="card-body" id="bathroom-amenities-list">
                                <p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Select a room to load amenities</p>
                            </div>
                        </div>
                    </div>

                    <!-- In-Room Features Tab -->
                    <div id="amenities-tab-features" class="amenity-tab-panel" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h3>üì∫ In-Room Features</h3>
                            </div>
                            <div class="card-body" id="features-amenities-list">
                                <p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Select a room to load amenities</p>
                            </div>
                        </div>
                    </div>

                    <!-- Terms & Policies Tab -->
                    <div id="amenities-tab-terms" class="amenity-tab-panel" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h3>‚è∞ Check-in / Check-out</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Check-in From</label>
                                        <select class="form-input" id="terms-checkin-from">
                                            <option value="12:00">12:00 PM (Noon)</option>
                                            <option value="13:00">1:00 PM</option>
                                            <option value="14:00">2:00 PM</option>
                                            <option value="15:00" selected>3:00 PM</option>
                                            <option value="16:00">4:00 PM</option>
                                            <option value="17:00">5:00 PM</option>
                                            <option value="18:00">6:00 PM</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Check-in Until</label>
                                        <select class="form-input" id="terms-checkin-until">
                                            <option value="18:00">6:00 PM</option>
                                            <option value="19:00">7:00 PM</option>
                                            <option value="20:00">8:00 PM</option>
                                            <option value="21:00">9:00 PM</option>
                                            <option value="22:00" selected>10:00 PM</option>
                                            <option value="23:00">11:00 PM</option>
                                            <option value="00:00">Midnight</option>
                                            <option value="flexible">Flexible / 24hr</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Check-out By</label>
                                        <select class="form-input" id="terms-checkout">
                                            <option value="09:00">9:00 AM</option>
                                            <option value="10:00">10:00 AM</option>
                                            <option value="11:00" selected>11:00 AM</option>
                                            <option value="12:00">12:00 PM (Noon)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Late Check-out Fee</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <span>¬£</span>
                                            <input type="number" class="form-input" id="terms-late-checkout-fee" min="0" placeholder="0" style="width: 100px;">
                                            <span style="color: var(--text-secondary); font-size: 0.85rem;">(leave blank if not offered)</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-self-checkin" style="width: 18px; height: 18px;">
                                        <span>Self Check-in Available</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-24hr-checkin" style="width: 18px; height: 18px;">
                                        <span>24-Hour Check-in</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>üö≠ Smoking Policy</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="smoking-policy" value="no" checked style="width: 18px; height: 18px;">
                                            <span><strong>üö≠ No Smoking</strong> - Entire property is non-smoking</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="smoking-policy" value="designated" style="width: 18px; height: 18px;">
                                            <span><strong>Designated Areas Only</strong> - Smoking in specified areas</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="smoking-policy" value="allowed" style="width: 18px; height: 18px;">
                                            <span><strong>Smoking Allowed</strong></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="form-label">Smoking Violation Fine (optional)</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <span>¬£</span>
                                        <input type="number" class="form-input" id="terms-smoking-fine" min="0" placeholder="e.g., 250" style="width: 120px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>üêï Pet Policy</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="pet-policy" value="no" checked style="width: 18px; height: 18px;">
                                            <span><strong>No Pets Allowed</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="pet-policy" value="yes" style="width: 18px; height: 18px;">
                                            <span><strong>üêï Pets Allowed</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="pet-policy" value="request" style="width: 18px; height: 18px;">
                                            <span><strong>Pets on Request</strong> - Contact to confirm</span>
                                        </label>
                                    </div>
                                </div>
                                <div id="pet-details" style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px; display: none;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label class="form-label">Pet Deposit (refundable)</label>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <span>¬£</span>
                                                <input type="number" class="form-input" id="terms-pet-deposit" min="0" placeholder="e.g., 50" style="width: 100px;">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Pet Fee Per Night</label>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <span>¬£</span>
                                                <input type="number" class="form-input" id="terms-pet-fee" min="0" placeholder="e.g., 15" style="width: 100px;">
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" id="terms-dogs-allowed" checked style="width: 18px; height: 18px;">
                                            <span>üêï Dogs</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" id="terms-cats-allowed" style="width: 18px; height: 18px;">
                                            <span>üêà Cats</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" id="terms-small-pets-only" style="width: 18px; height: 18px;">
                                            <span>Small pets only (under 10kg)</span>
                                        </label>
                                    </div>
                                    <div class="form-group" style="margin-top: 1rem;">
                                        <label class="form-label">Maximum Pets Per Room</label>
                                        <select class="form-input" id="terms-max-pets" style="width: 150px;">
                                            <option value="1">1 pet</option>
                                            <option value="2" selected>2 pets</option>
                                            <option value="3">3 pets</option>
                                            <option value="unlimited">No limit</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>üë®‚Äçüë©‚Äçüëß Children & Guests</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Children Policy</label>
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="children-policy" value="all" checked style="width: 18px; height: 18px;">
                                            <span><strong>üë∂ Children Welcome</strong> - All ages</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="children-policy" value="5plus" style="width: 18px; height: 18px;">
                                            <span><strong>Children 5+ Only</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="children-policy" value="12plus" style="width: 18px; height: 18px;">
                                            <span><strong>Children 12+ Only</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="children-policy" value="adults18" style="width: 18px; height: 18px;">
                                            <span><strong>Adults Only (18+)</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="children-policy" value="adults21" style="width: 18px; height: 18px;">
                                            <span><strong>Adults Only (21+)</strong></span>
                                        </label>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-cots-available" style="width: 18px; height: 18px;">
                                        <span>Cots/Cribs Available</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-highchairs" style="width: 18px; height: 18px;">
                                        <span>High Chairs Available</span>
                                    </label>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="form-label">Cot Fee Per Night (if offered)</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <span>¬£</span>
                                        <input type="number" class="form-input" id="terms-cot-fee" min="0" placeholder="0 if free" style="width: 100px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>üéâ Events & Parties</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="events-policy" value="no" checked style="width: 18px; height: 18px;">
                                            <span><strong>No Parties or Events</strong></span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="events-policy" value="small" style="width: 18px; height: 18px;">
                                            <span><strong>Small Gatherings OK</strong> - Up to 10 guests</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                            <input type="radio" name="events-policy" value="contact" style="width: 18px; height: 18px;">
                                            <span><strong>Events by Arrangement</strong> - Contact for approval</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>‚ôø Accessibility</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-wheelchair" style="width: 18px; height: 18px;">
                                        <span>‚ôø Wheelchair Accessible</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-step-free" style="width: 18px; height: 18px;">
                                        <span>Step-Free Access</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-bathroom" style="width: 18px; height: 18px;">
                                        <span>Accessible Bathroom</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-grab-rails" style="width: 18px; height: 18px;">
                                        <span>Grab Rails</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-roll-in-shower" style="width: 18px; height: 18px;">
                                        <span>Roll-in Shower</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-elevator" style="width: 18px; height: 18px;">
                                        <span>Elevator/Lift Access</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; cursor: pointer;">
                                        <input type="checkbox" id="access-ground-floor" style="width: 18px; height: 18px;">
                                        <span>Ground Floor Available</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 1rem;">
                            <div class="card-header">
                                <h3>üè† Additional House Rules</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label class="form-label">Quiet Hours From</label>
                                        <select class="form-input" id="terms-quiet-from">
                                            <option value="">Not specified</option>
                                            <option value="21:00">9:00 PM</option>
                                            <option value="22:00" selected>10:00 PM</option>
                                            <option value="23:00">11:00 PM</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Quiet Hours Until</label>
                                        <select class="form-input" id="terms-quiet-until">
                                            <option value="">Not specified</option>
                                            <option value="07:00">7:00 AM</option>
                                            <option value="08:00" selected>8:00 AM</option>
                                            <option value="09:00">9:00 AM</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-no-outside-guests" style="width: 18px; height: 18px;">
                                        <span>No Outside Guests</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="terms-id-required" style="width: 18px; height: 18px;">
                                        <span>ID Required at Check-in</span>
                                    </label>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label class="form-label">Additional Rules/Notes</label>
                                    <textarea class="form-input" id="terms-additional-rules" rows="3" placeholder="Any other house rules not covered above..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Link to Marketing Features -->
                <div class="card" style="margin-top: 1.5rem; background: linear-gradient(135deg, #ede9fe, #dbeafe); border: 1px solid #a5b4fc;">
                    <div class="card-body" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="margin: 0 0 0.25rem 0; color: #4338ca;">üéØ Complete Your Property Profile</h3>
                            <p style="margin: 0; color: #6366f1;">Tell guests what makes your property special - location, style, and who it's perfect for!</p>
                        </div>
                        <a href="#" onclick="navClick(document.querySelector('[data-view=marketing]'), 'marketing'); return false;" class="btn" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); white-space: nowrap;">
                            ‚Üí Marketing Features & Tags
                        </a>
                    </div>
                </div>

                <!-- Hidden amenities-list for backward compatibility -->
                <div id="amenities-list" style="display: none;"></div>
            </div>

            <!-- Availability View -->
            <div id="availability" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Availability & Pricing</h2>
                            <p>View and manage all rooms in one place</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <button class="btn" onclick="syncBeds24()" id="sync-beds24-btn" style="background: #f59e0b;" title="Quick sync: prices + bookings">üîÑ Beds24</button>
                            <button class="btn btn-secondary" onclick="syncBeds24FullInventory()" style="padding: 0.5rem; font-size: 0.75rem;" title="Full inventory sync (daily)">üìÖ Full</button>
                            <button class="btn" onclick="syncHostaway()" id="sync-hostaway-btn" style="background: #1e3a5f;">üîÑ Hostaway</button>
                            <button class="btn" onclick="syncSmoobu()" id="sync-smoobu-btn" style="background: #00b4b4;">üîÑ Smoobu</button>
                        </div>
                    </div>
                </div>
                
                <!-- Property Filter Bar -->
                <div class="card" style="margin-bottom: 1rem; padding: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 600; white-space: nowrap;">Filter by Property:</label>
                            <select id="grid-property-filter" class="form-input" style="min-width: 250px; padding: 0.5rem;" onchange="filterGridByProperty()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-left: auto;">
                            <button class="btn btn-secondary" onclick="refreshCalendar()" title="Refresh calendar data" style="padding: 0.5rem 0.75rem;">üîÑ</button>
                            <button class="btn btn-secondary" onclick="shiftGridDays(-7)">‚Äπ‚Äπ</button>
                            <button class="btn btn-secondary" onclick="shiftGridDays(-1)">‚Äπ</button>
                            <button class="btn btn-secondary" onclick="goToToday()">Today</button>
                            <button class="btn btn-secondary" onclick="shiftGridDays(1)">‚Ä∫</button>
                            <button class="btn btn-secondary" onclick="shiftGridDays(7)">‚Ä∫‚Ä∫</button>
                            <input type="date" id="grid-date-picker" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;" onchange="jumpToDate(this.value)">
                            <span style="color: #6b7280;" id="grid-date-range"></span>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div style="display: flex; gap: 1.5rem; margin-bottom: 1rem; font-size: 0.85rem;">
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 16px; height: 16px; background: #d1fae5; border: 1px solid #10b981; border-radius: 3px;"></span>
                        Available
                    </span>
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 16px; height: 16px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 3px;"></span>
                        Booked
                    </span>
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 16px; height: 16px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 3px;"></span>
                        Blocked
                    </span>
                </div>

                <!-- Grid Calendar -->
                <div class="card" style="overflow-x: auto; padding: 0;">
                    <table id="availability-grid" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                        <!-- Will be rendered by JS -->
                    </table>
                </div>

                <!-- Quick Edit Panel -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">Quick Edit</h3>
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
                        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
                            <label class="form-label">Room</label>
                            <select class="form-input" id="edit-room-select">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">From</label>
                            <input type="date" class="form-input" id="edit-from-date">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">To</label>
                            <input type="date" class="form-input" id="edit-to-date">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Action</label>
                            <select class="form-input" id="edit-action" onchange="toggleEditInputs()">
                                <option value="block">Block Dates</option>
                                <option value="unblock">Unblock</option>
                                <option value="price">Set Direct Price</option>
                                <option value="discount">Set % Discount</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; display: none;" id="edit-price-group">
                            <label class="form-label">Price ($)</label>
                            <input type="number" class="form-input" id="edit-price" placeholder="150" style="width: 100px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0; display: none;" id="edit-discount-group">
                            <label class="form-label">Discount %</label>
                            <input type="number" class="form-input" id="edit-discount" placeholder="10" style="width: 80px;">
                        </div>
                        <button class="btn" onclick="applyQuickEdit()">Apply</button>
                    </div>
                </div>

                <!-- API Feed Info (collapsed) -->
                <details style="margin-top: 1rem;">
                    <summary style="cursor: pointer; color: var(--text-secondary);">üì° API Feed Info</summary>
                    <div class="card" style="margin-top: 0.5rem;">
                        <p style="margin-bottom: 0.5rem; color: var(--text-secondary);">Public endpoint for booking widget:</p>
                        <code style="display: block; background: var(--bg-primary); padding: 0.75rem; border-radius: 6px; font-size: 0.8rem;">
                            /api/availability/{room_id}?from=YYYY-MM-DD&to=YYYY-MM-DD
                        </code>
                    </div>
                </details>
            </div>

            <!-- Offers View -->
            <div id="offers" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Pricing & Offers</h2>
                            <p>Set your standard prices and create special offers</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="openBulkEditModal()" style="background: #f0fdf4; border-color: #86efac; color: #166534;">
                                <span>‚ö°</span>
                                <span>Bulk Edit</span>
                            </button>
                            <button class="btn" onclick="openAddOfferModal()">
                                <span>+</span>
                                <span>Add New Offer</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Property/Room Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="offers-property-select" class="form-input" onchange="loadOffersRooms()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="offers-room-select" class="form-input" onchange="loadOffersPricingGrid()">
                                <option value="">Select Room...</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                            <button class="btn btn-secondary" onclick="shiftOffersDays(-7)">‚Äπ‚Äπ</button>
                            <button class="btn btn-secondary" onclick="shiftOffersDays(-1)">‚Äπ</button>
                            <button class="btn btn-secondary" onclick="offersGoToToday()">Today</button>
                            <button class="btn btn-secondary" onclick="shiftOffersDays(1)">‚Ä∫</button>
                            <button class="btn btn-secondary" onclick="shiftOffersDays(7)">‚Ä∫‚Ä∫</button>
                        </div>
                    </div>
                </div>

                <!-- Pricing Grid -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div id="offers-pricing-grid">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            Select a property and room to view pricing
                        </p>
                    </div>
                </div>

                <!-- Offer Distribution Settings -->
                <div class="card" id="offer-distribution-card" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">üì¢ Offer Distribution</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                        Choose where each offer is available
                    </p>
                    <div id="offer-distribution-list">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Vouchers View -->
            <div id="vouchers" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Vouchers</h2>
                            <p>Gift cards, promo codes and discount vouchers</p>
                        </div>
                        <button class="btn" onclick="openAddVoucherModal()">
                            <span>+</span>
                            <span>Custom Voucher</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="vouchers-property-select" class="form-input" onchange="loadVouchersForProperty()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="vouchers-room-select" class="form-input" onchange="loadVouchersForProperty()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Add Presets -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">üéüÔ∏è Quick Add Voucher Templates</h3>
                        <button class="btn btn-secondary" onclick="toggleVoucherPresets()" id="toggle-voucher-presets-btn" style="font-size: 0.85rem;">
                            Show All Categories ‚ñº
                        </button>
                    </div>
                    
                    <!-- Popular (always visible) -->
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <button class="preset-btn" onclick="quickAddVoucher('¬£25 Gift Voucher', 'monetary', 25)">üí∑ ¬£25 Gift Voucher</button>
                            <button class="preset-btn" onclick="quickAddVoucher('¬£50 Gift Voucher', 'monetary', 50)">üí∑ ¬£50 Gift Voucher</button>
                            <button class="preset-btn" onclick="quickAddVoucher('¬£100 Gift Voucher', 'monetary', 100)">üí∑ ¬£100 Gift Voucher</button>
                            <button class="preset-btn" onclick="quickAddVoucher('10% Off', 'percentage', 10)">üè∑Ô∏è 10% Off</button>
                            <button class="preset-btn" onclick="quickAddVoucher('15% Off', 'percentage', 15)">üè∑Ô∏è 15% Off</button>
                            <button class="preset-btn" onclick="quickAddVoucher('1-Night Stay', 'stay', 1)">üåô 1-Night Stay</button>
                            <button class="preset-btn" onclick="quickAddVoucher('Weekend Stay', 'stay', 2)">üåô Weekend Stay</button>
                            <button class="preset-btn" onclick="quickAddVoucher('Free Breakfast', 'addon', 0)">üç≥ Free Breakfast</button>
                            <button class="preset-btn" onclick="quickAddVoucher('Referral ¬£20', 'monetary', 20)">üë• Referral ¬£20</button>
                        </div>
                    </div>
                    
                    <!-- All Categories (hidden by default) -->
                    <div id="all-voucher-presets" style="display: none;">
                        
                        <!-- Monetary Value -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #10b981; margin-bottom: 0.5rem; font-size: 0.9rem;">üí∑ Monetary Value Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('¬£25 Hotel Credit', 'monetary', 25)">¬£25 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£50 Hotel Credit', 'monetary', 50)">¬£50 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£75 Hotel Credit', 'monetary', 75)">¬£75 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£100 Hotel Credit', 'monetary', 100)">¬£100 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£150 Hotel Credit', 'monetary', 150)">¬£150 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£200 Hotel Credit', 'monetary', 200)">¬£200 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£250 Hotel Credit', 'monetary', 250)">¬£250 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£500 Hotel Credit', 'monetary', 500)">¬£500 Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Flexible Stay Voucher', 'monetary', 100)">Flexible Stay</button>
                            </div>
                        </div>
                        
                        <!-- Stay Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #6366f1; margin-bottom: 0.5rem; font-size: 0.9rem;">üåô Stay Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('1-Night Stay Voucher', 'stay', 1)">1-Night Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('2-Night Stay Voucher', 'stay', 2)">2-Night Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Weekend Stay Voucher', 'stay', 2)">Weekend Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Midweek Escape', 'stay', 2)">Midweek Escape</button>
                                <button class="preset-btn" onclick="quickAddVoucher('3-Night Break', 'stay', 3)">3-Night Break</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Week Stay Voucher', 'stay', 7)">Week Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Romantic Escape', 'stay', 2)">Romantic Escape</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Anniversary Stay', 'stay', 2)">Anniversary Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Honeymoon Package', 'stay', 3)">Honeymoon Package</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Stay + Breakfast', 'stay', 1)">Stay + Breakfast</button>
                            </div>
                        </div>
                        
                        <!-- Discount Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f59e0b; margin-bottom: 0.5rem; font-size: 0.9rem;">üè∑Ô∏è Discount Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('5% Off Stay', 'percentage', 5)">5% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('10% Off Stay', 'percentage', 10)">10% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('15% Off Stay', 'percentage', 15)">15% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('20% Off Stay', 'percentage', 20)">20% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('25% Off Stay', 'percentage', 25)">25% Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£20 Off Booking', 'fixed', 20)">¬£20 Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£30 Off Booking', 'fixed', 30)">¬£30 Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('¬£50 Off Booking', 'fixed', 50)">¬£50 Off</button>
                                <button class="preset-btn" onclick="quickAddVoucher('New Guest Discount', 'percentage', 10)">New Guest</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Returning Guest', 'percentage', 15)">Returning Guest</button>
                            </div>
                        </div>
                        
                        <!-- Dining Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ef4444; margin-bottom: 0.5rem; font-size: 0.9rem;">üçΩÔ∏è Dining Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Breakfast Voucher', 'addon', 15)">Breakfast</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Dinner Voucher', 'addon', 40)">Dinner</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Afternoon Tea', 'addon', 30)">Afternoon Tea</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Sunday Roast', 'addon', 25)">Sunday Roast</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Wine & Dine', 'addon', 75)">Wine & Dine</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Dining for Two', 'addon', 80)">Dining for Two</button>
                            </div>
                        </div>
                        
                        <!-- Spa & Wellness -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ec4899; margin-bottom: 0.5rem; font-size: 0.9rem;">üßñ Spa & Wellness Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Massage Session', 'addon', 60)">Massage</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Spa Day Pass', 'addon', 80)">Spa Day</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Couples Treatment', 'addon', 120)">Couples Treatment</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Facial Voucher', 'addon', 50)">Facial</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Yoga Retreat', 'addon', 45)">Yoga Retreat</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Sauna & Steam', 'addon', 30)">Sauna & Steam</button>
                            </div>
                        </div>
                        
                        <!-- Experience Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #3b82f6; margin-bottom: 0.5rem; font-size: 0.9rem;">üéØ Experience Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Wine Tasting', 'addon', 40)">Wine Tasting</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Cooking Class', 'addon', 75)">Cooking Class</button>
                                <button class="preset-btn" onclick="quickAddVoucher('City Tour', 'addon', 35)">City Tour</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Boat Trip', 'addon', 50)">Boat Trip</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Golf Experience', 'addon', 100)">Golf Experience</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Ski Package', 'addon', 120)">Ski Package</button>
                            </div>
                        </div>
                        
                        <!-- Celebration Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #8b5cf6; margin-bottom: 0.5rem; font-size: 0.9rem;">üéÅ Celebration Vouchers</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Birthday Voucher', 'monetary', 50)">Birthday</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Anniversary Voucher', 'monetary', 75)">Anniversary</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Valentine\\'s Stay', 'stay', 1)">Valentine's</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Mother\\'s Day', 'monetary', 50)">Mother's Day</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Father\\'s Day', 'monetary', 50)">Father's Day</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Christmas Gift', 'monetary', 100)">Christmas</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Graduation Gift', 'monetary', 75)">Graduation</button>
                            </div>
                        </div>
                        
                        <!-- Loyalty Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #14b8a6; margin-bottom: 0.5rem; font-size: 0.9rem;">‚≠ê Loyalty & Rewards</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Thank You Voucher', 'monetary', 25)">Thank You</button>
                                <button class="preset-btn" onclick="quickAddVoucher('VIP Guest Voucher', 'percentage', 20)">VIP Guest</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Repeat Stay Credit', 'monetary', 30)">Repeat Stay</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Referral Reward', 'monetary', 20)">Referral Reward</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Review Incentive', 'percentage', 10)">Review Incentive</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Welcome Back', 'percentage', 15)">Welcome Back</button>
                            </div>
                        </div>
                        
                        <!-- Corporate Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #64748b; margin-bottom: 0.5rem; font-size: 0.9rem;">üíº Corporate & Group</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Staff Reward', 'monetary', 100)">Staff Reward</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Client Gift', 'monetary', 150)">Client Gift</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Team Retreat', 'percentage', 15)">Team Retreat</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Conference Credit', 'monetary', 200)">Conference Credit</button>
                            </div>
                        </div>
                        
                        <!-- Compensation Vouchers -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #dc2626; margin-bottom: 0.5rem; font-size: 0.9rem;">üîÑ Compensation & Recovery</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Refund Credit', 'monetary', 0)">Refund Credit</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Apology Voucher', 'percentage', 20)">Apology Voucher</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Disruption Compensation', 'monetary', 50)">Disruption Comp</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Future Stay Credit', 'monetary', 0)">Future Stay</button>
                            </div>
                        </div>
                        
                        <!-- Promotional -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f97316; margin-bottom: 0.5rem; font-size: 0.9rem;">üì¢ Promotional</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Book Direct Discount', 'percentage', 10)">Book Direct</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Black Friday', 'percentage', 25)">Black Friday</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Flash Sale', 'percentage', 30)">Flash Sale</button>
                                <button class="preset-btn" onclick="quickAddVoucher('New Launch', 'percentage', 20)">New Launch</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Early Bird', 'percentage', 15)">Early Bird</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Last Minute', 'percentage', 20)">Last Minute</button>
                            </div>
                        </div>
                        
                        <!-- Service-Specific -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #06b6d4; margin-bottom: 0.5rem; font-size: 0.9rem;">üé´ Service Add-ons</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddVoucher('Late Check-out', 'addon', 0)">Late Check-out</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Room Upgrade', 'addon', 0)">Room Upgrade</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Free Breakfast', 'addon', 0)">Free Breakfast</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Free Parking', 'addon', 0)">Free Parking</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Free Spa Access', 'addon', 0)">Free Spa Access</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Airport Transfer', 'addon', 0)">Airport Transfer</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Welcome Wine', 'addon', 0)">Welcome Wine</button>
                                <button class="preset-btn" onclick="quickAddVoucher('Kids Eat Free', 'addon', 0)">Kids Eat Free</button>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- Active Vouchers List -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Your Vouchers</h3>
                    <div id="vouchers-list">
                        <div class="empty-state">
                            <div class="empty-icon">üéüÔ∏è</div>
                            <h3>No Vouchers Created</h3>
                            <p>Click any template above or create a custom voucher</p>
                            <button class="btn" onclick="openAddVoucherModal()">Create Custom Voucher</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upsells View -->
            <div id="upsells" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Upsells</h2>
                            <p>Additional services and add-ons guests can purchase</p>
                        </div>
                        <button class="btn" onclick="openAddUpsellModal()">
                            <span>+</span>
                            <span>Custom Upsell</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="upsells-property-select" class="form-input" onchange="loadUpsellsForProperty()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="upsells-room-select" class="form-input" onchange="loadUpsellsForProperty()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Add Presets -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">‚ö° Quick Add Popular Upsells</h3>
                        <button class="btn btn-secondary" onclick="toggleUpsellPresets()" id="toggle-presets-btn" style="font-size: 0.85rem;">
                            Show All Categories ‚ñº
                        </button>
                    </div>
                    
                    <!-- Popular/Common (always visible) -->
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="popular-upsells">
                            <button class="preset-btn" onclick="quickAddUpsell('Early check-in', 25, 'per_booking')">‚è∞ Early check-in</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Late check-out', 25, 'per_booking')">‚è∞ Late check-out</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Airport transfer', 50, 'per_booking')">üöó Airport transfer</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Breakfast', 15, 'per_guest_per_night')">üç≥ Breakfast</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Parking', 15, 'per_night')">üÖøÔ∏è Parking</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Pet fee', 30, 'per_booking')">üêæ Pet fee</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Champagne on arrival', 45, 'per_booking')">üçæ Champagne on arrival</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Welcome hamper', 35, 'per_booking')">üß∫ Welcome hamper</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Mid-stay cleaning', 50, 'per_booking')">üßπ Mid-stay cleaning</button>
                            <button class="preset-btn" onclick="quickAddUpsell('Extra bed', 25, 'per_night')">üõèÔ∏è Extra bed</button>
                        </div>
                    </div>
                    
                    <!-- All Categories (hidden by default) -->
                    <div id="all-upsell-presets" style="display: none;">
                        
                        <!-- Accommodation Upgrades -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #6366f1; margin-bottom: 0.5rem; font-size: 0.9rem;">üè® Accommodation Upgrades</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Room upgrade', 50, 'per_night')">Room upgrade</button>
                                <button class="preset-btn" onclick="quickAddUpsell('High-floor room', 20, 'per_night')">High-floor room</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Sea view room', 30, 'per_night')">Sea view</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Balcony upgrade', 25, 'per_night')">Balcony upgrade</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Executive floor access', 40, 'per_night')">Executive floor</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Connecting rooms', 30, 'per_night')">Connecting rooms</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Premium Wi-Fi', 10, 'per_night')">Premium Wi-Fi</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pillow menu upgrade', 15, 'per_booking')">Pillow menu</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Gaming console rental', 20, 'per_night')">Gaming console</button>
                            </div>
                        </div>
                        
                        <!-- Guest Comfort -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #10b981; margin-bottom: 0.5rem; font-size: 0.9rem;">üõèÔ∏è Guest Comfort & Convenience</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Extra bed / rollaway', 25, 'per_night')">Extra bed</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Baby cot / crib', 15, 'per_night')">Baby cot</button>
                                <button class="preset-btn" onclick="quickAddUpsell('High chair', 10, 'per_booking')">High chair</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Extra towels', 10, 'per_booking')">Extra towels</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Bathrobe & slippers', 20, 'per_booking')">Bathrobe & slippers</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Luxury toiletries', 25, 'per_booking')">Luxury toiletries</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Laundry service', 30, 'per_booking')">Laundry service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Dry cleaning', 25, 'per_booking')">Dry cleaning</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Turndown service', 15, 'per_night')">Turndown service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Express housekeeping', 20, 'per_booking')">Express housekeeping</button>
                            </div>
                        </div>
                        
                        <!-- Food & Beverage -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f59e0b; margin-bottom: 0.5rem; font-size: 0.9rem;">üç≥ Food & Beverage</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Continental breakfast', 12, 'per_guest_per_night')">Continental breakfast</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Full English breakfast', 18, 'per_guest_per_night')">Full English breakfast</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Breakfast in room', 25, 'per_guest_per_night')">Breakfast in room</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Welcome drinks', 20, 'per_booking')">Welcome drinks</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Welcome hamper', 35, 'per_booking')">Welcome hamper</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Champagne on arrival', 45, 'per_booking')">Champagne on arrival</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Wine on arrival', 30, 'per_booking')">Wine on arrival</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Local produce basket', 40, 'per_booking')">Local produce basket</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Minibar package', 50, 'per_booking')">Minibar package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Fridge pre-stocking', 40, 'per_booking')">Fridge pre-stocking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Private chef', 200, 'per_booking')">Private chef</button>
                                <button class="preset-btn" onclick="quickAddUpsell('BBQ pack', 35, 'per_booking')">BBQ pack</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Romantic dinner setup', 75, 'per_booking')">Romantic dinner</button>
                            </div>
                        </div>
                        
                        <!-- Celebrations -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ec4899; margin-bottom: 0.5rem; font-size: 0.9rem;">üíê Celebrations & Occasions</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Birthday package', 50, 'per_booking')">Birthday package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Anniversary package', 60, 'per_booking')">Anniversary package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Honeymoon package', 80, 'per_booking')">Honeymoon package</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Flowers', 40, 'per_booking')">Flowers</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Chocolates', 25, 'per_booking')">Chocolates</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Balloons & decorations', 35, 'per_booking')">Balloons</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Celebration cake', 45, 'per_booking')">Celebration cake</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Rose petal decorations', 50, 'per_booking')">Rose petals</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Proposal setup', 150, 'per_booking')">Proposal setup</button>
                            </div>
                        </div>
                        
                        <!-- Transport -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #3b82f6; margin-bottom: 0.5rem; font-size: 0.9rem;">üöó Transport & Parking</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Airport transfer', 50, 'per_booking')">Airport transfer</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Private driver', 100, 'per_booking')">Private driver</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Shuttle service', 20, 'per_guest')">Shuttle service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Parking', 15, 'per_night')">Parking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Valet parking', 25, 'per_night')">Valet parking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('EV charging', 15, 'per_night')">EV charging</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Bicycle rental', 15, 'per_day')">Bicycle rental</button>
                                <button class="preset-btn" onclick="quickAddUpsell('E-bike rental', 30, 'per_day')">E-bike rental</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Scooter rental', 40, 'per_day')">Scooter rental</button>
                            </div>
                        </div>
                        
                        <!-- Cleaning (Airbnb style) -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #14b8a6; margin-bottom: 0.5rem; font-size: 0.9rem;">üßπ Cleaning & Property Services</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Mid-stay cleaning', 50, 'per_booking')">Mid-stay cleaning</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Deep clean upgrade', 75, 'per_booking')">Deep clean</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Daily housekeeping', 30, 'per_night')">Daily housekeeping</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Linen swap', 25, 'per_booking')">Linen swap</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pool cleaning', 50, 'per_booking')">Pool cleaning</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Hot tub servicing', 40, 'per_booking')">Hot tub servicing</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Firewood bundle', 20, 'per_booking')">Firewood bundle</button>
                                <button class="preset-btn" onclick="quickAddUpsell('BBQ cleaning', 25, 'per_booking')">BBQ cleaning</button>
                            </div>
                        </div>
                        
                        <!-- Pets -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #8b5cf6; margin-bottom: 0.5rem; font-size: 0.9rem;">üêæ Pet Services</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Pet fee', 30, 'per_booking')">Pet fee</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet welcome pack', 25, 'per_booking')">Pet welcome pack</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Dog bed', 15, 'per_booking')">Dog bed</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet food bowls', 10, 'per_booking')">Food bowls</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet sitting', 40, 'per_day')">Pet sitting</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Dog walking', 25, 'per_day')">Dog walking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pet cleaning fee', 50, 'per_booking')">Pet cleaning fee</button>
                            </div>
                        </div>
                        
                        <!-- Business -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #64748b; margin-bottom: 0.5rem; font-size: 0.9rem;">üíª Business & Work</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Dedicated workspace', 20, 'per_night')">Dedicated workspace</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Printer access', 15, 'per_booking')">Printer access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Meeting room hire', 75, 'per_booking')">Meeting room</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Business lounge', 30, 'per_night')">Business lounge</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Video conference setup', 25, 'per_booking')">Video conference</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Projector hire', 40, 'per_booking')">Projector hire</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Co-working pass', 25, 'per_day')">Co-working pass</button>
                            </div>
                        </div>
                        
                        <!-- Wellness -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #06b6d4; margin-bottom: 0.5rem; font-size: 0.9rem;">üèä Leisure & Wellness</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Gym access', 15, 'per_night')">Gym access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Spa access', 40, 'per_guest')">Spa access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Sauna / steam room', 25, 'per_guest')">Sauna / steam</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Hot tub access', 30, 'per_night')">Hot tub access</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Massage', 80, 'per_guest')">Massage</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Yoga class', 25, 'per_guest')">Yoga class</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Personal trainer', 60, 'per_booking')">Personal trainer</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pool cabana', 50, 'per_day')">Pool cabana</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Tennis court', 30, 'per_booking')">Tennis court</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Golf booking', 100, 'per_guest')">Golf booking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Wine tasting', 50, 'per_guest')">Wine tasting</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Cooking class', 75, 'per_guest')">Cooking class</button>
                            </div>
                        </div>
                        
                        <!-- Family -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #f472b6; margin-bottom: 0.5rem; font-size: 0.9rem;">üßí Family & Children</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Babysitting', 20, 'per_hour')">Babysitting</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Nanny service', 150, 'per_day')">Nanny service</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Kids activity pack', 20, 'per_booking')">Kids activity pack</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Children\'s meals', 12, 'per_guest_per_night')">Children's meals</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Baby proofing', 25, 'per_booking')">Baby proofing</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Toy rental', 15, 'per_booking')">Toy rental</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Pushchair hire', 20, 'per_booking')">Pushchair hire</button>
                            </div>
                        </div>
                        
                        <!-- Protection -->
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: #ef4444; margin-bottom: 0.5rem; font-size: 0.9rem;">üö® Protection & Flexibility</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Flexible cancellation', 25, 'per_booking')">Flexible cancellation</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Date change protection', 20, 'per_booking')">Date change protection</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Damage waiver', 30, 'per_booking')">Damage waiver</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Travel insurance', 40, 'per_booking')">Travel insurance</button>
                            </div>
                        </div>
                        
                        <!-- Concierge -->
                        <div style="margin-bottom: 0;">
                            <h4 style="color: #a855f7; margin-bottom: 0.5rem; font-size: 0.9rem;">üõéÔ∏è Concierge Services</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="preset-btn" onclick="quickAddUpsell('Local guide', 50, 'per_booking')">Local guide</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Tour booking', 30, 'per_booking')">Tour booking</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Event tickets', 25, 'per_booking')">Event tickets</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Restaurant reservations', 15, 'per_booking')">Restaurant reservations</button>
                                <button class="preset-btn" onclick="quickAddUpsell('Personal itinerary', 75, 'per_booking')">Personal itinerary</button>
                                <button class="preset-btn" onclick="quickAddUpsell('VIP entry service', 100, 'per_booking')">VIP entry</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Upsells List -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Your Upsells</h3>
                    <div id="upsells-list">
                        <div class="empty-state">
                            <div class="empty-icon">üéÅ</div>
                            <h3>No Upsells Configured</h3>
                            <p>Click any preset above or create a custom upsell</p>
                            <button class="btn" onclick="openAddUpsellModal()">Create Custom Upsell</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vendors View -->
            <div id="vendors" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>External Vendors</h2>
                            <p>Manage third-party service providers linked to your upsells and vouchers</p>
                        </div>
                        <button class="btn" onclick="openAddVendorModal()">
                            <span>+</span>
                            <span>Add Vendor</span>
                        </button>
                    </div>
                </div>

                <!-- Info Banner -->
                <div class="card" style="background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); border: 1px solid #93c5fd; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                        <div style="font-size: 1.5rem;">üí°</div>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; color: #1e40af;">How External Vendors Work</h4>
                            <p style="margin: 0; color: #1e3a8a; font-size: 0.9rem;">
                                When a guest purchases an upsell or voucher linked to an external vendor (like a taxi company or tour operator), 
                                the vendor receives an email notification. They can then log in to view booking details and confirm the service.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Vendors List -->
                <div class="card">
                    <div id="vendors-list">
                        <div class="empty-state">
                            <div class="empty-icon">ü§ù</div>
                            <h3>No Vendors Configured</h3>
                            <p>Add external vendors like taxi companies, tour operators, or local services</p>
                            <button class="btn" onclick="openAddVendorModal()">Add Your First Vendor</button>
                        </div>
                    </div>
                </div>

                <!-- Service Requests Section -->
                <div class="card" style="margin-top: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">üìã Service Requests</h3>
                        <select id="service-requests-filter" class="form-input" style="width: auto;" onchange="loadServiceRequests()">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="notified">Notified</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div id="service-requests-list">
                        <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            Service requests will appear here when guests purchase external vendor services.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Fees View -->
            <div id="fees" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Fees</h2>
                            <p>Mandatory charges and taxes applied to bookings</p>
                        </div>
                        <button class="btn" onclick="openAddFeeModal()">
                            <span>+</span>
                            <span>Add Fee</span>
                        </button>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 1rem; background: #fef3c7; border: 1px solid #fde68a;">
                    <h3 style="color: #92400e; margin-bottom: 0.5rem;">üí° Common Fee Types</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; color: #78350f;">
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üßπ Cleaning fee</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üèõÔ∏è City/Tourist tax</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üõ°Ô∏è Damage deposit</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üêï Pet fee</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üî• Resort fee</span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">üÖøÔ∏è Parking fee</span>
                    </div>
                </div>

                <div class="card">
                    <div id="fees-list">
                        <div class="empty-state">
                            <div class="empty-icon">üíµ</div>
                            <h3>No Fees Configured</h3>
                            <p>Add cleaning fees, taxes, or other charges</p>
                            <button class="btn" onclick="openAddFeeModal()">Add Your First Fee</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Taxes View -->
            <div id="taxes" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Tourist Taxes</h2>
                            <p>Government-mandated taxes that vary by location</p>
                        </div>
                        <button class="btn" onclick="openAddTaxModal()">
                            <span>+</span>
                            <span>Add Tax</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="taxes-property-select" class="form-input" onchange="loadTaxesForProperty()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Room/Unit</label>
                            <select id="taxes-room-select" class="form-input" onchange="loadTaxesForProperty()">
                                <option value="">All Rooms</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 1rem; background: linear-gradient(135deg, #dbeafe 0%, #ede9fe 100%); border: 1px solid #c7d2fe;">
                    <h3 style="color: #4338ca; margin-bottom: 0.75rem;">üåç Tourist Tax Guide</h3>
                    <p style="color: #5b21b6; margin-bottom: 1rem; font-size: 0.9rem;">
                        Tourist taxes vary significantly by country and city. Configure them based on your property location.
                    </p>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üá´üá∑ France: ‚Ç¨2-‚Ç¨11 PPPN
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üáÆüáπ Italy: ‚Ç¨1-‚Ç¨10 PPPN
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üá≥üá± Amsterdam: 12.5%
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üá∫üá∏ USA: 10-16%
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üá™üá∏ Spain: ‚Ç¨1-‚Ç¨7 PPPN
                        </span>
                        <span style="background: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4338ca;">
                            üá¶üá™ Dubai: 7-20 AED PPPN
                        </span>
                    </div>
                </div>

                <div class="card">
                    <div id="taxes-list">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            Select a property to view and manage taxes
                        </p>
                    </div>
                </div>
            </div>

            <!-- Payments View -->
            <div id="payments" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üí≥ Payments</h2>
                            <p>View payment status and transactions for all bookings</p>
                        </div>
                    </div>
                </div>

                <!-- Stripe Connection Status -->
                <div id="stripe-connection-status" class="card" style="margin-bottom: 1rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%); border: 1px solid #c7d2fe;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="color: #4338ca; margin-bottom: 0.5rem;">üîó Stripe Connection</h3>
                            <p id="stripe-status-text" style="color: #5b21b6; font-size: 0.9rem;">Checking connection status...</p>
                        </div>
                        <div id="stripe-connect-btn-area">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Payment Filters -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Property</label>
                            <select id="payments-property-select" class="form-input" onchange="loadPaymentsForProperty()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Payment Status</label>
                            <select id="payments-status-select" class="form-input" onchange="loadPaymentsForProperty()">
                                <option value="">All Statuses</option>
                                <option value="pending">‚è≥ Pending</option>
                                <option value="deposit_paid">üí∞ Deposit Paid</option>
                                <option value="fully_paid">‚úÖ Fully Paid</option>
                                <option value="refunded">‚Ü©Ô∏è Refunded</option>
                                <option value="failed">‚ùå Failed</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Date Range</label>
                            <select id="payments-date-range" class="form-input" onchange="loadPaymentsForProperty()">
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                                <option value="all">All time</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Payment Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="padding: 1.25rem; text-align: center;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Pending Payments</div>
                        <div id="pending-payments-count" style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;">0</div>
                    </div>
                    <div class="card" style="padding: 1.25rem; text-align: center;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Deposits Received</div>
                        <div id="deposits-received-amount" style="font-size: 1.75rem; font-weight: 700; color: #3b82f6;">¬£0</div>
                    </div>
                    <div class="card" style="padding: 1.25rem; text-align: center;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Balance Due</div>
                        <div id="balance-due-amount" style="font-size: 1.75rem; font-weight: 700; color: #ef4444;">¬£0</div>
                    </div>
                    <div class="card" style="padding: 1.25rem; text-align: center;">
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Collected</div>
                        <div id="total-collected-amount" style="font-size: 1.75rem; font-weight: 700; color: #10b981;">¬£0</div>
                    </div>
                </div>

                <!-- Bookings with Payment Status -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Bookings & Payment Status</h3>
                    <div id="payments-bookings-list">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            Loading bookings...
                        </p>
                    </div>
                </div>
            </div>

            <!-- Deposit Rules View -->
            <div id="deposit-rules" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>‚öôÔ∏è Deposit Rules</h2>
                            <p>Configure payment policies for your properties</p>
                        </div>
                        <button class="btn" onclick="openAddDepositRuleModal()">
                            <span>+</span>
                            <span>Add Rule</span>
                        </button>
                    </div>
                </div>

                <!-- Property Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Apply To</label>
                            <select id="deposit-rules-property-select" class="form-input" onchange="loadDepositRulesForProperty()">
                                <option value="">Select Property...</option>
                                <option value="all">üè¢ All Properties (Account Default)</option>
                            </select>
                        </div>
                        <button class="btn" onclick="openBulkDepositRuleModal()" style="background: #6366f1; white-space: nowrap; height: 42px;">
                            üìã Apply to Multiple
                        </button>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        üí° Select a property above to create a deposit rule for a single property, or click "Apply to Multiple" to create the same rule across several properties at once.
                    </p>
                </div>

                <!-- Deposit Rules Info -->
                <div class="card" style="margin-bottom: 1rem; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 1px solid #a7f3d0;">
                    <h3 style="color: #047857; margin-bottom: 0.75rem;">üí° How Deposit Rules Work</h3>
                    <div style="color: #065f46; font-size: 0.9rem; line-height: 1.6;">
                        <p style="margin-bottom: 0.75rem;">Deposit rules control how guests pay for their bookings:</p>
                        <ul style="margin: 0; padding-left: 1.5rem;">
                            <li><strong>Deposit Type:</strong> Percentage (e.g., 30%), fixed amount, first night, or full payment</li>
                            <li><strong>Balance Due:</strong> When the remaining amount is due (e.g., 14 days before check-in)</li>
                            <li><strong>Refund Policy:</strong> Flexible, moderate, strict, or non-refundable</li>
                            <li><strong>Auto-charge:</strong> Automatically charge the balance when due</li>
                        </ul>
                    </div>
                </div>

                <!-- Deposit Rules List -->
                <div class="card">
                    <div id="deposit-rules-list">
                        <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            Select a property to view deposit rules
                        </p>
                    </div>
                </div>
            </div>

            <!-- Marketing View -->
            <div id="marketing" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Marketing Features & Tags</h2>
                            <p>Define what makes your property special to help travel agents find you</p>
                        </div>
                    </div>
                </div>

                <!-- Property & Room Selector -->
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Select Property</label>
                            <select id="marketing-property-select" class="form-input" onchange="loadMarketingRooms()">
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block;">Select Room/Unit</label>
                            <select id="marketing-room-select" class="form-input" onchange="loadRoomFeatures()">
                                <option value="">All Rooms (Property-wide)</option>
                            </select>
                        </div>
                        <div id="marketing-save-btn" style="display: none;">
                            <button class="btn" onclick="saveMarketingFeatures()" style="background: #16a34a;">
                                üíæ Save Features
                            </button>
                        </div>
                    </div>
                    
                    <!-- Apply to all rooms checkbox -->
                    <div id="apply-all-rooms-container" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                            <input type="checkbox" id="apply-to-all-rooms" style="width: 18px; height: 18px;">
                            <span><strong>Apply changes to ALL rooms</strong> in this property</span>
                        </label>
                        <p style="margin: 0.5rem 0 0 2rem; font-size: 0.85rem; color: #3b82f6;">
                            When checked, saving will update all rooms. When unchecked, only the selected room is updated.
                        </p>
                    </div>
                    
                    <!-- Room feature status indicator -->
                    <div id="marketing-room-status" style="display: none; margin-top: 0.75rem; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.9rem;">
                    </div>
                </div>

                <!-- Features Content -->
                <div id="marketing-content" style="display: none;">
                    
                    <!-- AI Suggestion Panel -->
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; color: white;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.5rem;">ü§ñ</span>
                            <h4 style="margin: 0; font-weight: 600;">AI Feature Suggestions</h4>
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <textarea id="marketing-ai-prompt" rows="2" placeholder="Describe your property... e.g. 'Victorian B&B near the beach, dog-friendly, great for romantic getaways and walking holidays'" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: none; font-size: 0.9rem;"></textarea>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="aiSuggestFeatures()" style="background: white; color: #8b5cf6; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer;">ü™Ñ Suggest Features</button>
                        </div>
                    </div>
                    
                    <!-- AI Suggestions Results (hidden by default) -->
                    <div id="ai-suggestions-results" class="card" style="margin-bottom: 1rem; display: none; border: 2px solid #8b5cf6;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>ü§ñ</span> AI Suggested Features
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Click on suggestions to add them to your property
                        </p>
                        <div id="ai-suggestions-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <!-- AI suggestions will appear here -->
                        </div>
                    </div>
                    
                    <!-- Activities -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üèÉ</span> Activities & Experiences
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            What activities can guests enjoy at or near your property?
                        </p>
                        <div class="feature-grid" data-category="activities">
                            <label class="feature-item"><input type="checkbox" data-feature="walking"> ü•æ Walking / Hiking</label>
                            <label class="feature-item"><input type="checkbox" data-feature="cycling"> üö¥ Cycling</label>
                            <label class="feature-item"><input type="checkbox" data-feature="golf"> ‚õ≥ Golf</label>
                            <label class="feature-item"><input type="checkbox" data-feature="fishing"> üé£ Fishing</label>
                            <label class="feature-item"><input type="checkbox" data-feature="water-sports"> üèÑ Water Sports</label>
                            <label class="feature-item"><input type="checkbox" data-feature="horse-riding"> üê¥ Horse Riding</label>
                            <label class="feature-item"><input type="checkbox" data-feature="skiing"> ‚õ∑Ô∏è Skiing / Winter Sports</label>
                            <label class="feature-item"><input type="checkbox" data-feature="birdwatching"> ü¶Ö Birdwatching / Wildlife</label>
                            <label class="feature-item"><input type="checkbox" data-feature="wine-tasting"> üç∑ Wine Tasting</label>
                            <label class="feature-item"><input type="checkbox" data-feature="cooking-classes"> üë®‚Äçüç≥ Cooking Classes</label>
                        </div>
                    </div>

                    <!-- Guest Types -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üë•</span> Guest Types & Accessibility
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Who is your property best suited for?
                        </p>
                        <div class="feature-grid" data-category="guest-types">
                            <label class="feature-item"><input type="checkbox" data-feature="pet-friendly"> üêï Pet Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="family-friendly"> üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="adults-only"> üç∏ Adults Only</label>
                            <label class="feature-item"><input type="checkbox" data-feature="wheelchair-accessible"> ‚ôø Wheelchair Accessible</label>
                            <label class="feature-item"><input type="checkbox" data-feature="senior-friendly"> üë¥ Senior Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="lgbtq-friendly"> üè≥Ô∏è‚Äçüåà LGBTQ+ Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="business-travelers"> üíº Business Travelers</label>
                            <label class="feature-item"><input type="checkbox" data-feature="digital-nomads"> üíª Digital Nomads</label>
                        </div>
                    </div>

                    <!-- Themes & Experiences -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚ú®</span> Themes & Experiences
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            What type of experience does your property offer?
                        </p>
                        <div class="feature-grid" data-category="themes">
                            <label class="feature-item"><input type="checkbox" data-feature="romantic"> üíï Romantic / Couples</label>
                            <label class="feature-item"><input type="checkbox" data-feature="wellness-spa"> üßò Wellness / Spa</label>
                            <label class="feature-item"><input type="checkbox" data-feature="adventure"> üèîÔ∏è Adventure</label>
                            <label class="feature-item"><input type="checkbox" data-feature="eco-friendly"> üåø Eco-Friendly / Sustainable</label>
                            <label class="feature-item"><input type="checkbox" data-feature="luxury"> üëë Luxury</label>
                            <label class="feature-item"><input type="checkbox" data-feature="budget-friendly"> üí∞ Budget Friendly</label>
                            <label class="feature-item"><input type="checkbox" data-feature="historic"> üè∞ Historic / Heritage</label>
                            <label class="feature-item"><input type="checkbox" data-feature="boutique"> üé® Boutique / Unique</label>
                            <label class="feature-item"><input type="checkbox" data-feature="farm-stay"> üåæ Farm Stay / Agritourism</label>
                            <label class="feature-item"><input type="checkbox" data-feature="glamping"> ‚õ∫ Glamping</label>
                        </div>
                    </div>

                    <!-- Location Features -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìç</span> Location & Setting
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Describe your property's location and surroundings
                        </p>
                        <div class="feature-grid" data-category="location">
                            <label class="feature-item"><input type="checkbox" data-feature="beachfront"> üèñÔ∏è Beachfront</label>
                            <label class="feature-item"><input type="checkbox" data-feature="mountain-view"> üèîÔ∏è Mountain View</label>
                            <label class="feature-item"><input type="checkbox" data-feature="countryside"> üåÑ Countryside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="city-centre"> üèôÔ∏è City Centre</label>
                            <label class="feature-item"><input type="checkbox" data-feature="lakeside"> üåä Lakeside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="riverside"> üèûÔ∏è Riverside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="forest"> üå≤ Forest / Woodland</label>
                            <label class="feature-item"><input type="checkbox" data-feature="village"> üèòÔ∏è Village / Rural</label>
                            <label class="feature-item"><input type="checkbox" data-feature="coastal"> ‚öì Coastal</label>
                            <label class="feature-item"><input type="checkbox" data-feature="island"> üèùÔ∏è Island</label>
                        </div>
                    </div>

                    <!-- Nearby -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üó∫Ô∏è</span> Nearby (within 15 mins)
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            What's conveniently close to your property?
                        </p>
                        <div class="feature-grid" data-category="nearby">
                            <label class="feature-item"><input type="checkbox" data-feature="near-beach"> üèñÔ∏è Beach</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-train"> üöÇ Train Station</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-airport"> ‚úàÔ∏è Airport</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-transport"> üöå Public Transport</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-restaurants"> üçΩÔ∏è Restaurants & Dining</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-shopping"> üõçÔ∏è Shopping</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-golf"> ‚õ≥ Golf Course</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-ski"> ‚õ∑Ô∏è Ski Resort</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-hiking"> ü•æ Hiking Trails</label>
                            <label class="feature-item"><input type="checkbox" data-feature="near-attractions"> üé° Tourist Attractions</label>
                        </div>
                    </div>

                    <!-- Property Amenities -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üè†</span> Notable Amenities
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Highlight standout amenities that set you apart
                        </p>
                        <div class="feature-grid" data-category="amenities">
                            <label class="feature-item"><input type="checkbox" data-feature="ev-charging"> ‚ö° EV Charging</label>
                            <label class="feature-item"><input type="checkbox" data-feature="swimming-pool"> üèä Swimming Pool</label>
                            <label class="feature-item"><input type="checkbox" data-feature="hot-tub"> üõÅ Hot Tub / Jacuzzi</label>
                            <label class="feature-item"><input type="checkbox" data-feature="sauna"> üßñ Sauna</label>
                            <label class="feature-item"><input type="checkbox" data-feature="gym"> üèãÔ∏è Gym / Fitness</label>
                            <label class="feature-item"><input type="checkbox" data-feature="garden"> üå≥ Garden</label>
                            <label class="feature-item"><input type="checkbox" data-feature="bbq"> üçñ BBQ Area</label>
                            <label class="feature-item"><input type="checkbox" data-feature="fireplace"> üî• Fireplace</label>
                            <label class="feature-item"><input type="checkbox" data-feature="private-parking"> üÖøÔ∏è Private Parking</label>
                            <label class="feature-item"><input type="checkbox" data-feature="restaurant"> üçΩÔ∏è On-site Restaurant</label>
                        </div>
                    </div>

                    <!-- Property Type & Style -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üèõÔ∏è</span> Property Type & Style
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            What type of property are you, and what's your style?
                        </p>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label">Property Type</label>
                            <select id="marketing-property-type" class="form-input" style="max-width: 300px;">
                                <option value="">Select type...</option>
                                <option value="hotel">Hotel</option>
                                <option value="bnb">Bed & Breakfast</option>
                                <option value="guesthouse">Guest House</option>
                                <option value="inn">Inn</option>
                                <option value="boutique">Boutique Hotel</option>
                                <option value="apartment">Self-Catering / Apartment</option>
                                <option value="villa">Villa</option>
                                <option value="cottage">Cottage</option>
                                <option value="cabin">Cabin / Lodge</option>
                                <option value="farmhouse">Farmhouse / Agriturismo</option>
                                <option value="hostel">Hostel</option>
                                <option value="resort">Resort</option>
                            </select>
                        </div>
                        <div class="feature-grid" data-category="property-style">
                            <label class="feature-item"><input type="checkbox" data-feature="modern"> üè¢ Modern / Contemporary</label>
                            <label class="feature-item"><input type="checkbox" data-feature="traditional"> üè° Traditional</label>
                            <label class="feature-item"><input type="checkbox" data-feature="rustic"> ü™µ Rustic / Countryside</label>
                            <label class="feature-item"><input type="checkbox" data-feature="minimalist"> ‚¨ú Minimalist</label>
                            <label class="feature-item"><input type="checkbox" data-feature="quirky"> üé™ Quirky / Unique</label>
                            <label class="feature-item"><input type="checkbox" data-feature="cozy"> üî• Cozy / Homely</label>
                        </div>
                    </div>

                    <!-- Awards & Recognition -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üèÜ</span> Awards & Recognition
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Showcase your achievements and certifications
                        </p>
                        <div class="feature-grid" data-category="awards">
                            <label class="feature-item"><input type="checkbox" data-feature="tripadvisor-coe"> üèÖ TripAdvisor Certificate of Excellence</label>
                            <label class="feature-item"><input type="checkbox" data-feature="booking-award"> üèÖ Booking.com Traveller Review Award</label>
                            <label class="feature-item"><input type="checkbox" data-feature="green-tourism"> üåø Green Tourism Certified</label>
                            <label class="feature-item"><input type="checkbox" data-feature="michelin"> ‚≠ê Michelin Guide Listed</label>
                            <label class="feature-item"><input type="checkbox" data-feature="aa-rated"> üî∂ AA Rated</label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Star Rating (Official)</label>
                                <select id="marketing-star-rating" class="form-input">
                                    <option value="">Not rated</option>
                                    <option value="1">‚≠ê 1 Star</option>
                                    <option value="2">‚≠ê‚≠ê 2 Stars</option>
                                    <option value="3">‚≠ê‚≠ê‚≠ê 3 Stars</option>
                                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 Stars</option>
                                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Stars</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Year Established</label>
                                <input type="number" id="marketing-year-established" class="form-input" placeholder="e.g., 1985" min="1800" max="2025">
                            </div>
                        </div>
                    </div>

                    <!-- Custom Features -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚ûï</span> Custom Features
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Add any unique features not listed above
                        </p>
                        <div id="custom-features-list" style="margin-bottom: 1rem;">
                            <!-- Custom features will be added here -->
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="new-custom-feature" class="form-input" placeholder="e.g., Treehouse, Observatory, Private Cinema" style="flex: 1;">
                            <button class="btn btn-secondary" onclick="addCustomFeature()">+ Add</button>
                        </div>
                    </div>

                    <!-- Room Exclusions -->
                    <div class="card" id="room-exclusions-card" style="margin-bottom: 1rem; display: none;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üö´</span> Room Exclusions
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Some features may not apply to all rooms. Select features to see which rooms to exclude.
                        </p>
                        <div id="room-exclusions-content">
                            <p style="color: var(--text-secondary); font-style: italic;">Select a feature above to manage room exclusions</p>
                        </div>
                    </div>

                </div>

                <!-- Empty State -->
                <div id="marketing-empty" class="card">
                    <div class="empty-state">
                        <div class="empty-icon">üì£</div>
                        <h3>Select a Property</h3>
                        <p>Choose a property above to manage its marketing features and tags</p>
                    </div>
                </div>
            </div>

            <!-- Website Editor - Tabbed Interface -->
            <div id="website-editor" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>‚úèÔ∏è <span id="editor-site-name">Website Editor</span></h2>
                            <p class="subtitle" id="editor-site-url-display">Customize your website settings</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="backToSitesList()">
                                <span>‚Üê</span>
                                <span>Back to Sites</span>
                            </button>
                            <a id="editor-preview-btn" href="#" target="_blank" class="btn btn-secondary" style="display: none;">
                                <span>üëÅÔ∏è</span>
                                <span>View Live Site</span>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Editor Tabs -->
                <div class="editor-tabs" style="display: flex; gap: 0; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; overflow-x: auto;">
                    <button class="editor-tab active" data-tab="header" onclick="switchEditorTab('header')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                        üìå Header & Logo
                    </button>
                    <button class="editor-tab" data-tab="homepage" onclick="switchEditorTab('homepage')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                        üè† Home Page
                    </button>
                    <button class="editor-tab" id="subpages-tab" data-tab="subpages" onclick="switchEditorTab('subpages')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                        üìÑ Sub Pages
                    </button>
                    <button class="editor-tab" data-tab="footer" onclick="switchEditorTab('footer')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                        üë£ Footer
                    </button>
                    <button class="editor-tab" data-tab="styles" onclick="switchEditorTab('styles')" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 3px solid transparent; margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;">
                        üé® Styles & Colors
                    </button>
                </div>
                
                <!-- Tab Content Panels -->
                <div id="editor-tab-content">
                    <!-- Header Tab -->
                    <div id="editor-panel-header" class="editor-panel">
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                            <button class="btn" onclick="saveWebsiteSection('header', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Header</button>
                        </div>
                        <div id="editor-header-content"></div>
                    </div>
                    
                    <!-- Home Page Tab -->
                    <div id="editor-panel-homepage" class="editor-panel" style="display: none;">
                        <!-- Sub-tabs for home page sections -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button class="sub-tab active" data-subtab="hero" onclick="switchHomeSubTab('hero')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: #7c3aed; color: white; cursor: pointer; font-size: 0.875rem;">üñºÔ∏è Hero</button>
                            <button class="sub-tab" data-subtab="intro" onclick="switchHomeSubTab('intro')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">üìù Intro</button>
                            <button class="sub-tab" data-subtab="featured" onclick="switchHomeSubTab('featured')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">üè® Featured</button>
                            <button class="sub-tab" data-subtab="about" onclick="switchHomeSubTab('about')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">‚ÑπÔ∏è About</button>
                            <button class="sub-tab" data-subtab="reviews" onclick="switchHomeSubTab('reviews')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">‚≠ê Reviews</button>
                            <button class="sub-tab" data-subtab="cta" onclick="switchHomeSubTab('cta')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">üöÄ CTA</button>
                        </div>
                        <div id="editor-homepage-hero" class="home-subtab-panel">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('hero', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Hero</button>
                            </div>
                            <div id="editor-hero-content"></div>
                        </div>
                        <div id="editor-homepage-intro" class="home-subtab-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('intro', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Intro</button>
                            </div>
                            <div id="editor-intro-content"></div>
                        </div>
                        <div id="editor-homepage-featured" class="home-subtab-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('featured', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Featured</button>
                            </div>
                            <div id="editor-featured-content"></div>
                        </div>
                        <div id="editor-homepage-about" class="home-subtab-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('about', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save About</button>
                            </div>
                            <div id="editor-about-content"></div>
                        </div>
                        <div id="editor-homepage-reviews" class="home-subtab-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('reviews', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Reviews</button>
                            </div>
                            <div id="editor-reviews-content"></div>
                        </div>
                        <div id="editor-homepage-cta" class="home-subtab-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('cta', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save CTA</button>
                            </div>
                            <div id="editor-cta-content"></div>
                        </div>
                    </div>
                    
                    <!-- Sub Pages Tab -->
                    <div id="editor-panel-subpages" class="editor-panel" style="display: none;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button class="sub-tab active" data-subtab="page-rooms" onclick="switchSubPageTab('page-rooms')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: #7c3aed; color: white; cursor: pointer; font-size: 0.875rem;">üè† Rooms</button>
                            <button class="sub-tab" data-subtab="page-about" onclick="switchSubPageTab('page-about')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">‚ÑπÔ∏è About</button>
                            <button class="sub-tab" data-subtab="page-gallery" onclick="switchSubPageTab('page-gallery')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">üñºÔ∏è Gallery</button>
                            <button class="sub-tab" data-subtab="page-blog" onclick="switchSubPageTab('page-blog')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">üì∞ Blog</button>
                            <button class="sub-tab" data-subtab="page-attractions" onclick="switchSubPageTab('page-attractions')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">üéØ Attractions</button>
                            <button class="sub-tab" data-subtab="page-dining" onclick="switchSubPageTab('page-dining')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">üçΩÔ∏è Dining</button>
                            <button class="sub-tab" data-subtab="page-contact" onclick="switchSubPageTab('page-contact')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">üìß Contact</button>
                        </div>
                        <div id="editor-subpage-page-rooms" class="subpage-panel">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-rooms', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Rooms Page</button>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>Page Header</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Page Title</label>
                                        <input type="text" class="form-input" id="wb-page-rooms-title" placeholder="e.g., Our Rooms & Suites" value="Book Your Stay">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Subtitle</label>
                                        <input type="text" class="form-input" id="wb-page-rooms-subtitle" placeholder="e.g., Find your perfect accommodation">
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>Search Widget</h3></div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                            <input type="checkbox" id="wb-page-rooms-show-search" checked style="width: 18px; height: 18px;">
                                            <span>Show Search Widget</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header"><h3>Listing Display</h3></div>
                                <div class="card-body">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label class="form-label">Columns</label>
                                            <select class="form-select" id="wb-page-rooms-columns">
                                                <option value="2">2 Columns</option>
                                                <option value="3" selected>3 Columns</option>
                                                <option value="4">4 Columns</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Card Style</label>
                                            <select class="form-select" id="wb-page-rooms-card-style">
                                                <option value="standard" selected>Standard</option>
                                                <option value="compact">Compact</option>
                                                <option value="featured">Featured</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                                            <input type="checkbox" id="wb-page-rooms-show-map" style="width: 18px; height: 18px;">
                                            <span>Show Map View Toggle</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3>Styling</h3></div>
                                <div class="card-body">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label class="form-label">Background Color</label>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <input type="color" id="wb-page-rooms-bg-color" value="#ffffff" style="width: 50px; height: 36px; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">
                                                <input type="text" class="form-input" id="wb-page-rooms-bg" value="#ffffff" style="flex: 1;" oninput="document.getElementById('wb-page-rooms-bg-color').value = this.value">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Text Color</label>
                                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                <input type="color" id="wb-page-rooms-text-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">
                                                <input type="text" class="form-input" id="wb-page-rooms-text-color" value="#1e293b" style="flex: 1;" oninput="document.getElementById('wb-page-rooms-text-color-picker').value = this.value">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="editor-subpage-page-about" class="subpage-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-about', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save About Page</button>
                            </div>
                            <div id="editor-page-about-content"></div>
                        </div>
                        <div id="editor-subpage-page-gallery" class="subpage-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-gallery', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Gallery Page</button>
                            </div>
                            <div id="editor-page-gallery-content"></div>
                        </div>
                        <div id="editor-subpage-page-blog" class="subpage-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-blog', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Blog Page</button>
                            </div>
                            <div id="editor-page-blog-content"></div>
                        </div>
                        <div id="editor-subpage-page-attractions" class="subpage-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-attractions', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Attractions Page</button>
                            </div>
                            <div id="editor-page-attractions-content"></div>
                        </div>
                        <div id="editor-subpage-page-dining" class="subpage-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-dining', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Dining Page</button>
                            </div>
                            <div id="editor-page-dining-content"></div>
                        </div>
                        <div id="editor-subpage-page-contact" class="subpage-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-contact', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Contact Page</button>
                            </div>
                            <div id="editor-page-contact-content"></div>
                        </div>
                    </div>
                    
                    <!-- Footer Tab -->
                    <div id="editor-panel-footer" class="editor-panel" style="display: none;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button class="sub-tab active" data-subtab="footer-main" onclick="switchFooterTab('footer-main')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: #7c3aed; color: white; cursor: pointer; font-size: 0.875rem;">‚öôÔ∏è Footer Settings</button>
                            <button class="sub-tab" data-subtab="footer-terms" onclick="switchFooterTab('footer-terms')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">üìú Terms & Conditions</button>
                            <button class="sub-tab" data-subtab="footer-privacy" onclick="switchFooterTab('footer-privacy')" style="padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 20px; background: white; color: #64748b; cursor: pointer; font-size: 0.875rem;">üîí Privacy Policy</button>
                        </div>
                        <div id="editor-footer-footer-main" class="footer-panel">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('footer', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Footer</button>
                            </div>
                            <div id="editor-footer-content"></div>
                        </div>
                        <div id="editor-footer-footer-terms" class="footer-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-terms', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Terms</button>
                            </div>
                            <div id="editor-terms-content"></div>
                        </div>
                        <div id="editor-footer-footer-privacy" class="footer-panel" style="display: none;">
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                                <button class="btn" onclick="saveWebsiteSection('page-privacy', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Privacy</button>
                            </div>
                            <div id="editor-privacy-content"></div>
                        </div>
                    </div>
                    
                    <!-- Styles Tab -->
                    <div id="editor-panel-styles" class="editor-panel" style="display: none;">
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                            <button class="btn" onclick="saveWebsiteSection('styles', this)" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">üíæ Save Styles</button>
                        </div>
                        <div id="editor-styles-content"></div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Header & Logo -->
            <div id="wb-header" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìå Header & Logo</h2>
                            <p>Site identity and navigation</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="openSitePreview()" id="wb-preview-btn" style="display: none;">
                                <span>üëÅÔ∏è</span>
                                <span>Preview Site</span>
                            </button>
                            <button class="btn" onclick="saveWebsiteSection('header', this)">üíæ Save & Sync</button>
                        </div>
                    </div>
                    
                    <!-- Website Selector Banner -->
                    <div class="website-selector-banner" style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <label style="font-weight: 600; color: #334155;">Editing Website:</label>
                                <select class="form-select website-selector-dropdown" onchange="onWebsiteSelected(this)" style="min-width: 250px;">
                                    <option value="">-- Select Website --</option>
                                </select>
                            </div>
                            <div class="website-edit-banner" style="display: none;">
                                <span class="website-status" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; background: #dcfce7; color: #166534; margin-right: 0.5rem;"></span>
                                <a class="website-url" href="#" target="_blank" style="color: #6366f1; font-size: 0.875rem;"></a>
                            </div>
                        </div>
                    </div>
                    
                    <div id="wb-site-banner" style="display: none; margin-top: 1rem; padding: 0.75rem 1rem; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 8px; color: white;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>üåê Your Website:</strong> <a id="wb-site-url" href="#" target="_blank" style="color: white; text-decoration: underline;"></a>
                            </div>
                            <span style="font-size: 0.8rem; opacity: 0.9;">Changes sync automatically when you save</span>
                        </div>
                    </div>
                </div>

                <!-- Logo Card -->
                <div class="card">
                    <div class="card-header"><h3>Logo</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Logo Image</label>
                            <div id="wb-header-logo-image-preview" style="width: 200px; height: 80px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border: 2px dashed #e2e8f0; background-size: contain; background-position: center; background-repeat: no-repeat;">
                                <span style="color: #94a3b8;">No logo uploaded</span>
                            </div>
                            <input type="file" id="wb-header-logo-image" accept="image/*" onchange="previewWebsiteImage('header-logo')">
                            <input type="hidden" id="wb-header-logo-image-url">
                            <small class="form-hint">Recommended: PNG with transparent background, max 400x150px</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Site Name (if no logo)</label>
                            <input type="text" class="form-input" id="wb-header-site-name" placeholder="e.g., The Grand Hotel">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tagline</label>
                            <input type="text" class="form-input" id="wb-header-tagline" placeholder="e.g., Luxury Accommodation Since 1985">
                        </div>
                    </div>
                </div>

                <!-- Header Colors Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Header Colors</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-bg-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-bg-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-bg-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-bg-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Menu Link Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-text-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-text-color" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-text-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Logo/Site Title Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-logo-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-logo-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-logo-color" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-logo-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CTA Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-cta-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-cta-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-cta-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-cta-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CTA Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-cta-text-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-cta-text').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-cta-text" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-cta-text-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Border Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-header-border-color-picker" value="#e5e7eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-header-border-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-header-border-color" value="#e5e7eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-header-border-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Menu Typography Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Menu Typography</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Menu Font</label>
                                <select class="form-select" id="wb-header-font">
                                    <option value="Inter">Inter (Modern)</option>
                                    <option value="Playfair Display">Playfair Display (Elegant)</option>
                                    <option value="Montserrat">Montserrat (Clean)</option>
                                    <option value="Lora">Lora (Classic)</option>
                                    <option value="Roboto">Roboto (Neutral)</option>
                                    <option value="Open Sans">Open Sans (Friendly)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Font Size: <span id="wb-header-font-size-value">15</span>px</label>
                                <input type="range" id="wb-header-font-size" min="12" max="24" value="15" style="width: 100%;" oninput="document.getElementById('wb-header-font-size-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Font Weight</label>
                                <select class="form-select" id="wb-header-font-weight">
                                    <option value="400">Normal (400)</option>
                                    <option value="500" selected>Medium (500)</option>
                                    <option value="600">Semi-Bold (600)</option>
                                    <option value="700">Bold (700)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Style</label>
                                <select class="form-select" id="wb-header-text-transform">
                                    <option value="none">Normal</option>
                                    <option value="uppercase">UPPERCASE</option>
                                    <option value="capitalize">Capitalize</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Header Layout Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Layout & Options</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Menu Layout</label>
                            <select class="form-select" id="wb-header-layout">
                                <option value="logo-left">Logo Left, Menu Right</option>
                                <option value="logo-center">Logo Center, Menu Split</option>
                                <option value="logo-right">Logo Right, Menu Left</option>
                                <option value="stacked">Stacked (Logo above Menu)</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-header-transparent" checked> Transparent over Hero
                            </label>
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-header-sticky" checked> Sticky Header
                            </label>
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-header-border"> Show Bottom Border
                            </label>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Website Builder: Hero Section -->
            <div id="wb-hero" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üñºÔ∏è Hero Section</h2>
                            <p>The main banner at the top of your website</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('hero', this)">üíæ Save & Sync</button>
                    </div>
                </div>

                <!-- Hero Content Card -->
                <div class="card">
                    <div class="card-header"><h3>Hero Content</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Headline</label>
                            <input type="text" class="form-input" id="wb-hero-headline" placeholder="e.g., Welcome to Paradise">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subheadline</label>
                            <input type="text" class="form-input" id="wb-hero-subheadline" placeholder="e.g., Experience luxury in the heart of the countryside">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Badge Text</label>
                                <input type="text" class="form-input" id="wb-hero-button-text" placeholder="e.g., Welcome to Paradise">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Badge Link (optional)</label>
                                <input type="text" class="form-input" id="wb-hero-button-link" placeholder="e.g., /about">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hero Image Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Background Image</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <div id="wb-hero-image-preview" style="width: 100%; height: 200px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; background-size: cover; background-position: center;">
                                <span style="color: #94a3b8;">Click below to upload an image</span>
                            </div>
                            <input type="file" id="wb-hero-image" accept="image/*" onchange="previewWebsiteImage('hero')">
                            <input type="hidden" id="wb-hero-image-url">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Overlay Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-overlay-color-picker" value="#0f172a" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-overlay-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-overlay-color" value="#0f172a" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-overlay-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Overlay Opacity: <span id="wb-hero-overlay-value">30</span>%</label>
                                <input type="range" id="wb-hero-overlay" min="0" max="100" value="30" style="width: 100%;" oninput="document.getElementById('wb-hero-overlay-value').textContent = this.value">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hero Height: <span id="wb-hero-height-value">90</span>vh</label>
                            <input type="range" id="wb-hero-height" min="50" max="100" value="90" style="width: 100%;" oninput="document.getElementById('wb-hero-height-value').textContent = this.value">
                        </div>
                    </div>
                </div>

                <!-- Badge Styling Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Badge Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-badge-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer; opacity: 0.3;" onchange="document.getElementById('wb-hero-badge-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-badge-bg" value="rgba(255,255,255,0.15)" style="width: 100%; font-family: monospace; font-size: 12px;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-badge-text-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-badge-text').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-badge-text" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-badge-text-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Border</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-badge-border-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer; opacity: 0.3;" onchange="document.getElementById('wb-hero-badge-border').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-badge-border" value="rgba(255,255,255,0.3)" style="width: 100%; font-family: monospace; font-size: 12px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trust Badges Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Trust Badges</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Badge 1</label>
                                <input type="text" class="form-input" id="wb-hero-trust-1" value="Instant Booking">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Badge 2</label>
                                <input type="text" class="form-input" id="wb-hero-trust-2" value="Best Price Guarantee">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Badge 3</label>
                                <input type="text" class="form-input" id="wb-hero-trust-3" value="24/7 Support">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Widget Card -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>üîç Search Widget</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-search-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-search-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-search-bg" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-search-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Opacity: <span id="wb-hero-search-opacity-value">100</span>%</label>
                                <input type="range" id="wb-hero-search-opacity" min="0" max="100" value="100" style="width: 100%;" oninput="document.getElementById('wb-hero-search-opacity-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Corner Radius: <span id="wb-hero-search-radius-value">16</span>px</label>
                                <input type="range" id="wb-hero-search-radius" min="0" max="32" value="16" style="width: 100%;" oninput="document.getElementById('wb-hero-search-radius-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Padding: <span id="wb-hero-search-padding-value">24</span>px</label>
                                <input type="range" id="wb-hero-search-padding" min="0" max="48" value="24" style="width: 100%;" oninput="document.getElementById('wb-hero-search-padding-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Max Width: <span id="wb-hero-search-max-width-value">900</span>px</label>
                                <input type="range" id="wb-hero-search-max-width" min="600" max="1200" value="900" style="width: 100%;" oninput="document.getElementById('wb-hero-search-max-width-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Scale: <span id="wb-hero-search-scale-value">100</span>%</label>
                                <input type="range" id="wb-hero-search-scale" min="80" max="120" value="100" style="width: 100%;" oninput="document.getElementById('wb-hero-search-scale-value').textContent = this.value">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-search-btn-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-search-btn-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-search-btn-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-search-btn-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-hero-search-btn-text-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-hero-search-btn-text').value = this.value">
                                    <input type="text" class="form-input" id="wb-hero-search-btn-text" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-hero-search-btn-text-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Intro Section -->
            <div id="wb-intro" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìù Intro Section</h2>
                            <p>Welcome text below the hero</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('intro', this)">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Content</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-intro-enabled" checked> Enable Intro Section
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" id="wb-intro-title" placeholder="e.g., Welcome to Our Property">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Text</label>
                            <textarea class="form-textarea" id="wb-intro-text" rows="4" placeholder="Welcome text about your property..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-intro-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-intro-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-intro-bg" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-intro-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-intro-text-color-picker" value="#1e293b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-intro-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-intro-text-color" value="#1e293b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-intro-text-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title Size: <span id="wb-intro-title-size-value">36</span>px</label>
                                <input type="range" id="wb-intro-title-size" min="24" max="72" value="36" style="width: 100%;" oninput="document.getElementById('wb-intro-title-size-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Size: <span id="wb-intro-text-size-value">18</span>px</label>
                                <input type="range" id="wb-intro-text-size" min="14" max="24" value="18" style="width: 100%;" oninput="document.getElementById('wb-intro-text-size-value').textContent = this.value">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Max Width: <span id="wb-intro-max-width-value">800</span>px</label>
                            <input type="range" id="wb-intro-max-width" min="600" max="1200" value="800" style="width: 100%;" oninput="document.getElementById('wb-intro-max-width-value').textContent = this.value">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Button (Optional)</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Button Text</label>
                                <input type="text" class="form-input" id="wb-intro-btn-text" placeholder="e.g., Learn More">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button URL</label>
                                <input type="text" class="form-input" id="wb-intro-btn-url" placeholder="e.g., /about">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-intro-btn-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-intro-btn-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-intro-btn-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-intro-btn-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-intro-btn-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-intro-btn-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-intro-btn-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-intro-btn-text-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Featured Properties -->
            <div id="wb-featured" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üè® Featured Properties</h2>
                            <p>Choose which rooms to highlight</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('featured', this)">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Content</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Section Title</label>
                            <input type="text" class="form-input" id="wb-featured-title" value="Featured Properties" placeholder="e.g., Our Rooms">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Section Subtitle</label>
                            <textarea class="form-textarea" id="wb-featured-subtitle" rows="2" placeholder="e.g., Discover our handpicked selection...">Discover our handpicked selection of stunning vacation rentals.</textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Display Settings</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Display Mode</label>
                                <select class="form-select" id="wb-featured-mode">
                                    <option value="all">Show All Rooms</option>
                                    <option value="count">Show First X Rooms</option>
                                    <option value="random">Show Random Rooms</option>
                                    <option value="selected">Select Specific Rooms</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Count: <span id="wb-featured-count-value">3</span></label>
                                <input type="range" id="wb-featured-count" min="1" max="12" value="3" style="width: 100%;" oninput="document.getElementById('wb-featured-count-value').textContent = this.value">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Room IDs (comma-separated)</label>
                            <input type="text" class="form-input" id="wb-featured-ids" placeholder="e.g., 1,3,5">
                            <small class="form-hint">Only used when "Select Specific Rooms" is chosen</small>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Button</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Button Text</label>
                                <input type="text" class="form-input" id="wb-featured-btn-text" value="View All Properties">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button URL</label>
                                <input type="text" class="form-input" id="wb-featured-btn-url" value="/book-now/">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-featured-btn-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-featured-btn-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-featured-btn-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-featured-btn-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-featured-btn-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-featured-btn-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-featured-btn-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-featured-btn-text-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Reviews -->
            <div id="wb-reviews" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>‚≠ê Reviews Section</h2>
                            <p>Customer testimonials and ratings</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('reviews', this)" id="wb-reviews-save-btn">üíæ Save & Sync</button>
                    </div>
                </div>

                <!-- Upgrade Banner (shown when Reviews app not purchased) -->
                <div id="wb-reviews-upgrade-banner" class="card" style="margin-bottom: 1rem; display: none;">
                    <div class="card-body" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">‚≠ê</div>
                        <h3 style="margin-bottom: 0.5rem;">Unlock the Reviews App</h3>
                        <p style="color: #64748b; margin-bottom: 1.5rem;">Display reviews from TripAdvisor, Booking.com, Google and more on your website with beautiful, auto-updating widgets.</p>
                        <a href="#" onclick="navClick(document.querySelector('[data-view=my-billing]'), 'my-billing'); return false;" class="btn" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                            üöÄ Upgrade Your Plan
                        </a>
                    </div>
                </div>

                <!-- Settings (shown when Reviews app is active) -->
                <div id="wb-reviews-content">
                    <div class="card">
                        <div class="card-header"><h3>Settings</h3></div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="wb-reviews-enabled"> Enable Reviews Section
                                </label>
                                <small class="form-hint">When enabled, shows reviews from TripAdvisor, Booking.com, and Google</small>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Section Title</label>
                                    <input type="text" class="form-input" id="wb-reviews-title" value="What Our Guests Say">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Section Subtitle</label>
                                    <input type="text" class="form-input" id="wb-reviews-subtitle" value="Real reviews from real guests">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 1rem;">
                        <div class="card-header"><h3>Styling</h3></div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Background Color</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="color" id="wb-reviews-bg-picker" value="#0f172a" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-reviews-bg').value = this.value">
                                        <input type="text" class="form-input" id="wb-reviews-bg" value="#0f172a" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-reviews-bg-picker')">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Text Color</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="color" id="wb-reviews-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-reviews-text-color').value = this.value">
                                        <input type="text" class="form-input" id="wb-reviews-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-reviews-text-color-picker')">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 1rem;">
                        <div class="card-header"><h3>Manual Reviews (Optional)</h3></div>
                        <div class="card-body">
                            <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.9rem;">Add up to 3 reviews manually. These display when the Reviews App widget is not connected.</p>
                            
                            <!-- Review 1 -->
                            <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <strong style="color: #475569; font-size: 0.9rem;">Review 1</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Reviewer Name</label>
                                        <input type="text" class="form-input" id="wb-reviews-review1-name" placeholder="John D.">
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Source</label>
                                        <select class="form-select" id="wb-reviews-review1-source">
                                            <option value="">Select source...</option>
                                            <option value="Google">Google</option>
                                            <option value="TripAdvisor">TripAdvisor</option>
                                            <option value="Booking.com">Booking.com</option>
                                            <option value="Airbnb">Airbnb</option>
                                            <option value="Facebook">Facebook</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 0.5rem; margin-bottom: 0;">
                                    <label class="form-label">Review Text</label>
                                    <textarea class="form-textarea" id="wb-reviews-review1-text" rows="2" placeholder="Amazing stay! The property was exactly as described..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Review 2 -->
                            <div style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <strong style="color: #475569; font-size: 0.9rem;">Review 2</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Reviewer Name</label>
                                        <input type="text" class="form-input" id="wb-reviews-review2-name" placeholder="Sarah M.">
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Source</label>
                                        <select class="form-select" id="wb-reviews-review2-source">
                                            <option value="">Select source...</option>
                                            <option value="Google">Google</option>
                                            <option value="TripAdvisor">TripAdvisor</option>
                                            <option value="Booking.com">Booking.com</option>
                                            <option value="Airbnb">Airbnb</option>
                                            <option value="Facebook">Facebook</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 0.5rem; margin-bottom: 0;">
                                    <label class="form-label">Review Text</label>
                                    <textarea class="form-textarea" id="wb-reviews-review2-text" rows="2" placeholder="We had the most wonderful time..."></textarea>
                                </div>
                            </div>
                            
                            <!-- Review 3 -->
                            <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                                <strong style="color: #475569; font-size: 0.9rem;">Review 3</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Reviewer Name</label>
                                        <input type="text" class="form-input" id="wb-reviews-review3-name" placeholder="Mike T.">
                                    </div>
                                    <div class="form-group" style="margin: 0;">
                                        <label class="form-label">Source</label>
                                        <select class="form-select" id="wb-reviews-review3-source">
                                            <option value="">Select source...</option>
                                            <option value="Google">Google</option>
                                            <option value="TripAdvisor">TripAdvisor</option>
                                            <option value="Booking.com">Booking.com</option>
                                            <option value="Airbnb">Airbnb</option>
                                            <option value="Facebook">Facebook</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 0.5rem; margin-bottom: 0;">
                                    <label class="form-label">Review Text</label>
                                    <textarea class="form-textarea" id="wb-reviews-review3-text" rows="2" placeholder="Highly recommend this property..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 1rem; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border: 1px solid #86efac;">
                        <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;">‚úÖ</div>
                            <div>
                                <strong style="color: #166534;">Reviews App Active</strong>
                                <p style="margin: 0; color: #15803d; font-size: 0.9rem;">Your reviews from TripAdvisor, Booking.com, and Google will automatically display on your website.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: About Section -->
            <div id="wb-about" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>‚ÑπÔ∏è About Section</h2>
                            <p>Tell visitors about your property</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('about', this)">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Content</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Image</label>
                            <div id="wb-about-image-preview" style="width: 100%; height: 200px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; background-size: cover; background-position: center;">
                                <span style="color: #94a3b8;">Click below to upload an image</span>
                            </div>
                            <input type="file" id="wb-about-image" accept="image/*" onchange="previewWebsiteImage('about')">
                            <input type="hidden" id="wb-about-image-url">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" id="wb-about-title" value="Experience Luxury & Comfort">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Text</label>
                            <textarea class="form-textarea" id="wb-about-text" rows="4">Our carefully curated collection of vacation rentals offers the perfect blend of luxury, comfort, and convenience.</textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Layout</label>
                            <select class="form-select" id="wb-about-layout">
                                <option value="image-left">Image Left</option>
                                <option value="image-right">Image Right</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Title Size: <span id="wb-about-title-size-value">36</span>px</label>
                                <input type="range" id="wb-about-title-size" min="24" max="72" value="36" style="width: 100%;" oninput="document.getElementById('wb-about-title-size-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Size: <span id="wb-about-text-size-value">16</span>px</label>
                                <input type="range" id="wb-about-text-size" min="14" max="24" value="16" style="width: 100%;" oninput="document.getElementById('wb-about-text-size-value').textContent = this.value">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Features (Checkmarks)</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Feature 1</label>
                                <input type="text" class="form-input" id="wb-about-feature-1" value="Spacious Bedrooms">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Feature 2</label>
                                <input type="text" class="form-input" id="wb-about-feature-2" value="Luxury Bathrooms">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Feature 3</label>
                                <input type="text" class="form-input" id="wb-about-feature-3" value="Prime Locations">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Feature 4</label>
                                <input type="text" class="form-input" id="wb-about-feature-4" value="Full Amenities">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Feature 5</label>
                                <input type="text" class="form-input" id="wb-about-feature-5" value="Entertainment Areas">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Feature 6</label>
                                <input type="text" class="form-input" id="wb-about-feature-6" value="Private Parking">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Button</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Button Text</label>
                                <input type="text" class="form-input" id="wb-about-btn-text" value="Learn More">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button URL</label>
                                <input type="text" class="form-input" id="wb-about-btn-url" value="/about/">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-about-btn-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-about-btn-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-about-btn-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-about-btn-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-about-btn-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-about-btn-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-about-btn-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-about-btn-text-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: CTA Section -->
            <div id="wb-cta" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üì¢ Call to Action</h2>
                            <p>Encourage visitors to book</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('cta', this)">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Content</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-cta-enabled" checked> Enable CTA Section
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-input" id="wb-cta-title" value="Ready to Book Your Stay?">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Text</label>
                            <textarea class="form-textarea" id="wb-cta-text" rows="2">Find your perfect vacation rental today and create memories that last a lifetime.</textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-cta-background-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-cta-background').value = this.value">
                                    <input type="text" class="form-input" id="wb-cta-background" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-cta-background-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-cta-text-color-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-cta-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-cta-text-color" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-cta-text-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Title Size: <span id="wb-cta-title-size-value">36</span>px</label>
                                <input type="range" id="wb-cta-title-size" min="24" max="72" value="36" style="width: 100%;" oninput="document.getElementById('wb-cta-title-size-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Size: <span id="wb-cta-text-size-value">18</span>px</label>
                                <input type="range" id="wb-cta-text-size" min="14" max="24" value="18" style="width: 100%;" oninput="document.getElementById('wb-cta-text-size-value').textContent = this.value">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Button</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Button Text</label>
                                <input type="text" class="form-input" id="wb-cta-btn-text" value="Browse Properties">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button URL</label>
                                <input type="text" class="form-input" id="wb-cta-btn-url" value="/book-now/">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Background</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-cta-btn-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-cta-btn-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-cta-btn-bg" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-cta-btn-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-cta-btn-text-color-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-cta-btn-text-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-cta-btn-text-color" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-cta-btn-text-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Footer -->
            <div id="wb-footer" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ü¶∂ Footer</h2>
                            <p>Bottom section of your website</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('footer', this)">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Footer Styling</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-footer-bg-picker" value="#0f172a" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-footer-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-footer-bg" value="#0f172a" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-footer-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-footer-text-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-footer-text').value = this.value">
                                    <input type="text" class="form-input" id="wb-footer-text" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-footer-text-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Layout</label>
                                <select class="form-select" id="wb-footer-layout">
                                    <option value="default">Default (3 columns)</option>
                                    <option value="centered">Centered</option>
                                    <option value="minimal">Minimal</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Copyright Text</label>
                            <input type="text" class="form-input" id="wb-footer-copyright" value="¬© 2025 All rights reserved.">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Contact Information</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="wb-footer-email" placeholder="info@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-input" id="wb-footer-phone" placeholder="+1 (555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea class="form-textarea" id="wb-footer-address" rows="2" placeholder="123 Main Street, City, State ZIP"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Social Media Links</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Facebook</label>
                                <input type="text" class="form-input" id="wb-footer-social-facebook" placeholder="https://facebook.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Instagram</label>
                                <input type="text" class="form-input" id="wb-footer-social-instagram" placeholder="https://instagram.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Twitter/X</label>
                                <input type="text" class="form-input" id="wb-footer-social-twitter" placeholder="https://twitter.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">LinkedIn</label>
                                <input type="text" class="form-input" id="wb-footer-social-linkedin" placeholder="https://linkedin.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">YouTube</label>
                                <input type="text" class="form-input" id="wb-footer-social-youtube" placeholder="https://youtube.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TikTok</label>
                                <input type="text" class="form-input" id="wb-footer-social-tiktok" placeholder="https://tiktok.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pinterest</label>
                                <input type="text" class="form-input" id="wb-footer-social-pinterest" placeholder="https://pinterest.com/...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TripAdvisor</label>
                                <input type="text" class="form-input" id="wb-footer-social-tripadvisor" placeholder="https://tripadvisor.com/...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Deploy Sites -->
            <div id="deploy-sites" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üöÄ Create Sites</h2>
                            <p class="subtitle">Create and manage WordPress websites from GAS</p>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <span id="vps-status" style="padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; background: #fef3c7; color: #92400e;">‚è≥ Checking VPS...</span>
                            <button class="btn" onclick="openDeployModal()" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">
                                + Create New Site
                            </button>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary);" id="deploy-stat-total">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Sites</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: bold; color: #10b981;" id="deploy-stat-active">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Live Sites</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: bold; color: #f59e0b;" id="deploy-stat-pending">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">In Development</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>üìã Deployed Sites</h3>
                    </div>
                    <div id="deployed-sites-list" style="padding: 1rem;">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üåê</div>
                            <p>Loading deployed sites...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Website Builder: Styles & Colors -->
            <div id="wb-styles" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üé® Styles & Colors</h2>
                            <p>Global styling for your website</p>
                        </div>
                        <button class="btn" onclick="saveWebsiteSection('styles', this)">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Brand Colors</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Primary Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-primary-color-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-primary-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-primary-color" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-primary-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Secondary Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-secondary-color-picker" value="#7c3aed" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-secondary-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-secondary-color" value="#7c3aed" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-secondary-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Accent Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-accent-color-picker" value="#f59e0b" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-accent-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-accent-color" value="#f59e0b" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-accent-color-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Link Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-link-color-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-link-color').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-link-color" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-link-color-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Typography</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Heading Font</label>
                                <select class="form-select" id="wb-styles-heading-font">
                                    <option value="Inter" selected>Inter (Modern)</option>
                                    <option value="Playfair Display">Playfair Display (Elegant)</option>
                                    <option value="Montserrat">Montserrat (Clean)</option>
                                    <option value="Lora">Lora (Classic)</option>
                                    <option value="Roboto">Roboto (Neutral)</option>
                                    <option value="Open Sans">Open Sans (Friendly)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Body Font</label>
                                <select class="form-select" id="wb-styles-body-font">
                                    <option value="Inter" selected>Inter (Modern)</option>
                                    <option value="Roboto">Roboto (Clean)</option>
                                    <option value="Open Sans">Open Sans (Friendly)</option>
                                    <option value="Lato">Lato (Warm)</option>
                                    <option value="Source Sans Pro">Source Sans Pro (Professional)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Page Title Size: <span id="wb-styles-title-size-value">48</span>px</label>
                                <input type="range" id="wb-styles-title-size" min="24" max="72" value="48" style="width: 100%;" oninput="document.getElementById('wb-styles-title-size-value').textContent = this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Body Text Size: <span id="wb-styles-body-size-value">16</span>px</label>
                                <input type="range" id="wb-styles-body-size" min="14" max="20" value="16" style="width: 100%;" oninput="document.getElementById('wb-styles-body-size-value').textContent = this.value">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Button Styles</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Primary Button BG</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-btn-primary-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-btn-primary-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-btn-primary-bg" value="#2563eb" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-btn-primary-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Primary Button Text</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-btn-primary-text-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-btn-primary-text').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-btn-primary-text" value="#ffffff" style="width: 90px; font-family: monospace;" oninput="syncColorToPicker(this.id, 'wb-styles-btn-primary-text-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Button Radius: <span id="wb-styles-btn-radius-value">8</span>px</label>
                                <input type="range" id="wb-styles-btn-radius" min="0" max="24" value="8" style="width: 100%;" oninput="document.getElementById('wb-styles-btn-radius-value').textContent = this.value">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Section Backgrounds</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Featured BG</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-featured-bg-picker" value="#ffffff" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-featured-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-featured-bg" value="#ffffff" style="width: 80px; font-family: monospace; font-size: 12px;" oninput="syncColorToPicker(this.id, 'wb-styles-featured-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">About BG</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-about-bg-picker" value="#f8fafc" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-about-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-about-bg" value="#f8fafc" style="width: 80px; font-family: monospace; font-size: 12px;" oninput="syncColorToPicker(this.id, 'wb-styles-about-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Testimonials BG</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-testimonials-bg-picker" value="#0f172a" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-testimonials-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-testimonials-bg" value="#0f172a" style="width: 80px; font-family: monospace; font-size: 12px;" oninput="syncColorToPicker(this.id, 'wb-styles-testimonials-bg-picker')">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CTA BG</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="wb-styles-cta-bg-picker" value="#2563eb" style="width: 50px; height: 36px; border: none; cursor: pointer;" onchange="document.getElementById('wb-styles-cta-bg').value = this.value">
                                    <input type="text" class="form-input" id="wb-styles-cta-bg" value="#2563eb" style="width: 80px; font-family: monospace; font-size: 12px;" oninput="syncColorToPicker(this.id, 'wb-styles-cta-bg-picker')">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Custom CSS</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Additional CSS</label>
                            <textarea class="form-textarea" id="wb-styles-custom-css" rows="6" placeholder="/* Add custom CSS here */"></textarea>
                            <small class="form-hint">Advanced: Add custom CSS to override theme styles</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks View -->
            <div id="tasks" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìã Tasks & Roadmap</h2>
                            <p>Development priorities and progress</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="openTaskModal()">
                                <span>+</span>
                                <span>Add Task</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Tab Bar: Active vs Completed -->
                <div style="display: flex; border-bottom: 2px solid var(--border); margin-bottom: 1rem;">
                    <button class="tasks-main-tab active" id="tasks-main-active" onclick="switchTaskMainTab('active')">
                        üî• Active Tasks
                    </button>
                    <button class="tasks-main-tab" id="tasks-main-completed" onclick="switchTaskMainTab('completed')">
                        ‚úÖ Completed
                    </button>
                </div>

                <!-- Active Tasks Panel -->
                <div id="tasks-active-panel">
                    <!-- Filter Row -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <!-- View By Toggle -->
                        <div style="display: flex; background: var(--bg-secondary); border-radius: 8px; padding: 4px;">
                            <button class="tasks-view-btn active" id="view-by-category" onclick="setTasksView('category')">
                                üìÅ By Category
                            </button>
                            <button class="tasks-view-btn" id="view-by-priority" onclick="setTasksView('priority')">
                                ‚ö° By Priority
                            </button>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div style="display: flex; gap: 1rem; margin-left: auto; align-items: center;">
                            <span class="tasks-stat" style="color: #ef4444;">
                                <span id="stat-critical">0</span> Critical
                            </span>
                            <span class="tasks-stat" style="color: #f59e0b;">
                                <span id="stat-urgent">0</span> Urgent
                            </span>
                            <span class="tasks-stat" style="color: #3b82f6;">
                                <span id="stat-high">0</span> High
                            </span>
                            <span class="tasks-stat" style="color: #6b7280;">
                                <span id="stat-medium">0</span> Medium
                            </span>
                        </div>
                    </div>

                    <!-- Category Tabs (horizontal menu) -->
                    <div id="tasks-category-tabs" class="tasks-category-tabs">
                        <button class="tasks-cat-tab active" data-cat="all" onclick="filterTasksCat('all')">
                            All
                        </button>
                        <!-- Categories populated by JS -->
                    </div>

                    <!-- Priority Tabs (hidden by default) -->
                    <div id="tasks-priority-tabs" class="tasks-category-tabs" style="display: none;">
                        <button class="tasks-cat-tab active" data-priority="all" onclick="filterTasksPriority('all')">
                            All
                        </button>
                        <button class="tasks-cat-tab" data-priority="critical" onclick="filterTasksPriority('critical')" style="border-left: 3px solid #ef4444;">
                            üî• Critical
                        </button>
                        <button class="tasks-cat-tab" data-priority="urgent" onclick="filterTasksPriority('urgent')" style="border-left: 3px solid #f59e0b;">
                            ‚ö° Urgent
                        </button>
                        <button class="tasks-cat-tab" data-priority="high" onclick="filterTasksPriority('high')" style="border-left: 3px solid #3b82f6;">
                            üî∑ High
                        </button>
                        <button class="tasks-cat-tab" data-priority="medium" onclick="filterTasksPriority('medium')" style="border-left: 3px solid #6b7280;">
                            üìå Medium
                        </button>
                    </div>

                    <!-- Tasks List -->
                    <div id="tasks-list" style="margin-top: 1rem;">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Completed Tasks Panel -->
                <div id="tasks-completed-panel" style="display: none;">
                    <div id="tasks-completed-list">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Styles -->
            <style>
                .tasks-main-tab {
                    padding: 0.75rem 1.5rem;
                    background: none;
                    border: none;
                    font-size: 1rem;
                    font-weight: 500;
                    color: var(--text-secondary);
                    cursor: pointer;
                    border-bottom: 3px solid transparent;
                    margin-bottom: -2px;
                    transition: all 0.2s;
                }
                .tasks-main-tab:hover {
                    color: var(--text);
                }
                .tasks-main-tab.active {
                    color: var(--primary);
                    border-bottom-color: var(--primary);
                }
                .tasks-view-btn {
                    padding: 0.5rem 1rem;
                    background: none;
                    border: none;
                    font-size: 0.85rem;
                    color: var(--text-secondary);
                    cursor: pointer;
                    border-radius: 6px;
                    transition: all 0.2s;
                }
                .tasks-view-btn:hover {
                    background: var(--bg-tertiary);
                }
                .tasks-view-btn.active {
                    background: white;
                    color: var(--text);
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                .tasks-stat {
                    font-size: 0.85rem;
                    font-weight: 600;
                }
                .tasks-category-tabs {
                    display: flex;
                    gap: 0.5rem;
                    flex-wrap: wrap;
                    padding-bottom: 0.5rem;
                    border-bottom: 1px solid var(--border);
                }
                .tasks-cat-tab {
                    padding: 0.5rem 1rem;
                    background: #f8fafc;
                    border: 1px solid #e2e8f0;
                    border-radius: 20px;
                    font-size: 0.85rem;
                    color: #475569;
                    cursor: pointer;
                    transition: all 0.2s;
                    white-space: nowrap;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.25rem;
                }
                .tasks-cat-tab:hover {
                    background: #e2e8f0;
                    color: #1e293b;
                }
                .tasks-cat-tab.active,
                .tasks-cat-tab.active:hover,
                .tasks-cat-tab.active:focus {
                    background: #6366f1 !important;
                    color: #ffffff !important;
                    border-color: #6366f1 !important;
                }
                .tasks-cat-tab:focus {
                    outline: none;
                    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
                }
                .task-card {
                    background: white;
                    border: 1px solid var(--border);
                    border-radius: 10px;
                    padding: 1rem;
                    margin-bottom: 0.75rem;
                    transition: all 0.2s;
                    border-left: 4px solid var(--border);
                }
                .task-card:hover {
                    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                }
                .task-card.priority-critical {
                    border-left-color: #ef4444;
                    background: #fef2f2;
                }
                .task-card.priority-urgent {
                    border-left-color: #f59e0b;
                    background: #fffbeb;
                }
                .task-card.priority-high {
                    border-left-color: #3b82f6;
                }
                .task-card.priority-medium {
                    border-left-color: #6b7280;
                }
                .task-card-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    gap: 1rem;
                }
                .task-title {
                    font-weight: 600;
                    font-size: 0.95rem;
                    margin: 0;
                }
                .task-badges {
                    display: flex;
                    gap: 0.5rem;
                    flex-shrink: 0;
                }
                .task-badge {
                    font-size: 0.7rem;
                    padding: 0.2rem 0.5rem;
                    border-radius: 4px;
                    font-weight: 600;
                    text-transform: uppercase;
                }
                .task-badge-critical { background: #fecaca; color: #991b1b; }
                .task-badge-urgent { background: #fde68a; color: #92400e; }
                .task-badge-high { background: #bfdbfe; color: #1e40af; }
                .task-badge-medium { background: #e5e7eb; color: #374151; }
                .task-description {
                    color: var(--text-secondary);
                    font-size: 0.85rem;
                    margin: 0.5rem 0 0 0;
                }
                .task-subtasks {
                    margin-top: 0.75rem;
                    padding-top: 0.75rem;
                    border-top: 1px dashed var(--border);
                }
                .task-subtask {
                    font-size: 0.8rem;
                    color: var(--text-secondary);
                    padding: 0.25rem 0;
                    padding-left: 1.25rem;
                    position: relative;
                }
                .task-subtask:before {
                    content: "‚óã";
                    position: absolute;
                    left: 0;
                    color: var(--border);
                }
                .completed-task {
                    background: #f0fdf4;
                    border-left-color: #22c55e;
                    opacity: 0.9;
                }
                .completed-task .task-title {
                    text-decoration: line-through;
                    color: var(--text-secondary);
                }
            </style>

            <!-- Integrations View -->
            <div id="integrations" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>Integrations</h2>
                            <p>Connected apps and services</p>
                        </div>
                        <button class="btn" onclick="openChannelManagerModal()">
                            <span>+</span>
                            <span>Add Integration</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Channel Managers</h3>
                    </div>
                    <div id="channel-connections">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîî Real-time Booking Sync (Beds24 Webhook)</h3>
                        <button class="btn btn-secondary btn-small" onclick="testWebhookEndpoint()">üß™ Test Endpoint</button>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        <strong>Important:</strong> For instant updates when bookings arrive from Airbnb/Booking.com, configure the webhook <strong>for each property</strong> in Beds24:
                    </p>
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.85rem; margin: 0 0 0.5rem 0; color: #64748b;"><strong>Webhook URL:</strong></p>
                        <code id="webhook-url" style="display: block; background: #1e293b; color: #22c55e; padding: 0.75rem; border-radius: 4px; font-size: 0.85rem; word-break: break-all;"></code>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button onclick="copyWebhookUrl()" class="btn btn-secondary btn-small">üìã Copy URL</button>
                            <span id="webhook-status" style="font-size: 0.8rem; color: #6b7280; display: flex; align-items: center;"></span>
                        </div>
                    </div>
                    
                    <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <p style="font-size: 0.85rem; margin: 0 0 0.5rem 0; color: #1e40af;"><strong>‚ö†Ô∏è Must be done for EACH property:</strong></p>
                        <ol style="font-size: 0.85rem; color: #1e40af; margin: 0; padding-left: 1.25rem; line-height: 1.8;">
                            <li>Go to <strong>Settings ‚Üí Properties</strong> and select your property</li>
                            <li>Click <strong>Access</strong> tab</li>
                            <li>Find <strong>"Booking Webhooks"</strong> section</li>
                            <li>Set <strong>Webhook Version</strong> to <code style="background: white; padding: 0.15rem 0.3rem; border-radius: 3px;">2 - with personal data</code></li>
                            <li>Paste the webhook URL above</li>
                            <li>Leave Custom Header and Additional Data empty</li>
                            <li>Click <strong>Save</strong></li>
                            <li style="color: #dc2626; font-weight: 600;">Repeat steps 1-7 for each property!</li>
                        </ol>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 0.75rem; margin-top: 1rem;">
                        <p style="font-size: 0.85rem; margin: 0; color: #92400e;">
                            <strong>üí° Sync Strategy:</strong><br>
                            ‚Ä¢ <strong>Webhook</strong> = Real-time (~1 min delay per Beds24)<br>
                            ‚Ä¢ <strong>üîÑ Beds24 button</strong> = Manual quick sync<br>
                            ‚Ä¢ <strong>üìÖ Full button</strong> = Manual inventory/blackout sync<br><br>
                            <strong>‚è∞ Automatic Backup:</strong> Every 15 min (bookings), Every 6 hrs (inventory)
                        </p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Review Apps</h3>
                        <button class="btn btn-secondary btn-small">Configure</button>
                    </div>
                    <p style="color: var(--text-secondary);">Connect to review platforms like TripAdvisor, Google Reviews, etc.</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Other Integrations</h3>
                        <button class="btn btn-secondary btn-small">Explore</button>
                    </div>
                    <p style="color: var(--text-secondary);">Payment gateways, analytics, marketing tools, and more...</p>
                </div>
            </div>

            <!-- Channel Manager Selection Modal -->
            <div id="channelManagerModal" class="modal" style="display: none;" onclick="if(event.target === this) closeChannelManagerModal()">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>Select Your Channel Manager</h3>
                        <button onclick="closeChannelManagerModal()" style="background: #e5e7eb; border: none; color: #374151; font-size: 1.5rem; cursor: pointer; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; line-height: 1;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Which channel manager do you use to manage your property?</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Beds24 - Ready -->
                            <a href="#" onclick="openWizard('beds24')" class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: inherit; transition: all 0.2s; position: relative;">
                                <span style="position: absolute; top: 0.5rem; right: 0.5rem; background: #10b981; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px;">‚úì Ready</span>
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Beds24</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">PMS + Channel Manager</div>
                            </a>
                            
                            <!-- Hostaway - Ready -->
                            <a href="#" onclick="openWizard('hostaway')" class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: inherit; transition: all 0.2s; position: relative;">
                                <span style="position: absolute; top: 0.5rem; right: 0.5rem; background: #10b981; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px;">‚úì Ready</span>
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Hostaway</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Vacation Rental Software</div>
                            </a>
                            
                            <!-- Smoobu - Ready -->
                            <a href="#" onclick="openWizard('smoobu')" class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: inherit; transition: all 0.2s; position: relative;">
                                <span style="position: absolute; top: 0.5rem; right: 0.5rem; background: #10b981; color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px;">‚úì Ready</span>
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Smoobu</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Channel Manager</div>
                            </a>
                            
                            <!-- Guesty - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Guesty</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Property Management</div>
                            </div>
                            
                            <!-- Cloudbeds - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Cloudbeds</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Hotel PMS</div>
                            </div>
                            
                            <!-- Lodgify - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Lodgify</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Vacation Rental</div>
                            </div>
                            
                            <!-- OwnerRez - Coming Soon -->
                            <div class="channel-option" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; opacity: 0.6; cursor: not-allowed;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">OwnerRez</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Vacation Rental</div>
                            </div>
                            
                            <!-- Other -->
                            <div class="channel-option" onclick="alert('Contact us for custom integrations!')" style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s;">
                                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem;">Other</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Not listed here</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Account View -->
            <div id="my-account" class="view">
                <div class="header">
                    <h2>üë§ My Account</h2>
                    <p>Manage your profile and account settings</p>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Profile Information -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Profile Information</h3>
                        </div>
                        <div style="padding: 1rem 0;">
                            <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
                                <div id="myAccountAvatar" style="width: 80px; height: 80px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 600;">?</div>
                                <div>
                                    <div id="myAccountName" style="font-size: 1.25rem; font-weight: 600;"></div>
                                    <div id="myAccountRole" style="color: var(--text-secondary);"></div>
                                </div>
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label class="form-label">Full Name</label>
                                    <input type="text" id="myAccountNameInput" class="form-input" placeholder="Your name">
                                </div>
                                <div>
                                    <label class="form-label">Email Address</label>
                                    <input type="email" id="myAccountEmail" class="form-input" placeholder="your@email.com">
                                </div>
                                <div>
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" id="myAccountPhone" class="form-input" placeholder="+44 7700 000000">
                                </div>
                                <div>
                                    <label class="form-label">Business Name</label>
                                    <input type="text" id="myAccountBusiness" class="form-input" placeholder="Your business name">
                                </div>
                                <button class="btn" onclick="saveMyProfile()" style="margin-top: 0.5rem;">
                                    üíæ Save Profile
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Change Password -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Change Password</h3>
                        </div>
                        <div style="padding: 1rem 0;">
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <div>
                                    <label class="form-label">Current Password</label>
                                    <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password">
                                </div>
                                <div>
                                    <label class="form-label">New Password</label>
                                    <input type="password" id="newPassword" class="form-input" placeholder="Enter new password">
                                </div>
                                <div>
                                    <label class="form-label">Confirm New Password</label>
                                    <input type="password" id="confirmNewPassword" class="form-input" placeholder="Confirm new password">
                                </div>
                                <button class="btn" onclick="changeMyPassword()" style="margin-top: 0.5rem;">
                                    üîê Change Password
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Master Admin Only: Create Master Admin -->
                <div id="createMasterAdminSection" class="card" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">üëë Create Master Admin Account</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0 1rem;">Only visible to Master Admins. Create additional master admin accounts with full system access.</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div>
                            <label class="form-label">Name</label>
                            <input type="text" id="newMasterName" class="form-input" placeholder="Full name">
                        </div>
                        <div>
                            <label class="form-label">Email</label>
                            <input type="email" id="newMasterEmail" class="form-input" placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="form-label">Temporary Password</label>
                            <input type="password" id="newMasterPassword" class="form-input" placeholder="Min 8 characters">
                        </div>
                        <button class="btn" onclick="createMasterAdmin()">
                            üëë Create Master Admin
                        </button>
                    </div>
                    
                    <!-- Existing Master Admins -->
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">Existing Master Admins</h4>
                        <div id="masterAdminsList">
                            <p style="color: var(--text-secondary);">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Agency Management (for Admin/SubMaster) -->
                <div id="agencyManagementSection" class="card" style="display: none; margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">üè¢ Agency Management</h3>
                    </div>
                    
                    <!-- Current Status -->
                    <div id="currentManagementStatus" style="padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div id="managementStatusIcon" style="width: 48px; height: 48px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üë§</div>
                            <div>
                                <div style="font-weight: 600;" id="managementStatusTitle">Self-Managed</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);" id="managementStatusDesc">You are managing your own account</div>
                            </div>
                            <button id="removeManagementBtn" class="btn btn-secondary" style="display: none; margin-left: auto;" onclick="removeAgencyManagement()">
                                ‚úï Remove Agency
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pending Request Banner -->
                    <div id="pendingRequestBanner" style="display: none; padding: 1rem; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.25rem;">‚è≥</span>
                            <div>
                                <div style="font-weight: 600; color: #92400e;">Request Pending</div>
                                <div style="font-size: 0.85rem; color: #a16207;" id="pendingRequestAgency">Awaiting response from agency</div>
                            </div>
                            <button class="btn btn-secondary btn-small" style="margin-left: auto;" onclick="cancelManagementRequest()">Cancel Request</button>
                        </div>
                    </div>
                    
                    <!-- Select Agency Form (only show if self-managed and no pending) -->
                    <div id="selectAgencyForm">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Select an agency to manage your properties and bookings. They will be able to view and manage your account on your behalf.
                        </p>
                        
                        <div style="display: flex; gap: 1rem; align-items: end;">
                            <div style="flex: 1;">
                                <label class="form-label">Select Agency</label>
                                <select id="agencySelect" class="form-input">
                                    <option value="">Choose an agency...</option>
                                </select>
                            </div>
                            <button class="btn" onclick="requestAgencyManagement()">
                                üì§ Send Request
                            </button>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem; color: #0369a1;">
                            ‚ÑπÔ∏è The agency will receive your request and can approve or decline. You'll be notified of their response.
                        </div>
                    </div>
                    
                    <!-- My Requests History -->
                    <div style="margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">Request History</h4>
                        <div id="myManagementRequests">
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">No previous requests</p>
                        </div>
                    </div>
                </div>

                <!-- Account Info Card -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Account Information</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; padding: 1rem 0;">
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Account ID</div>
                            <div id="myAccountId" style="font-family: monospace; font-size: 0.9rem;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Account Code</div>
                            <div id="myAccountCode" style="font-family: monospace; font-size: 0.9rem;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Role</div>
                            <div id="myAccountRoleInfo" style="font-size: 0.9rem;">-</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Status</div>
                            <div id="myAccountStatus" style="font-size: 0.9rem;">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings" class="view">
                <div class="header">
                    <h2>Settings</h2>
                    <p>Configure your system</p>
                </div>

                <div class="card">
                    <h3 class="card-title">System Settings</h3>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">Configure general system preferences, defaults, and behaviors.</p>
                </div>

                <div class="card">
                    <h3 class="card-title">User Management</h3>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">Manage admin users and access permissions.</p>
                </div>

                <div class="card">
                    <h3 class="card-title">API Configuration</h3>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">API keys, webhooks, and developer settings.</p>
                </div>
            </div>

            <!-- Blog App View -->
            <div id="app-blog" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìù Blog</h2>
                            <p>Manage your blog posts and articles</p>
                        </div>
                        <button class="btn" onclick="openBlogModal()">+ New Post</button>
                    </div>
                </div>

                <div class="card">
                    <div id="app-blog-posts-list">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üìù</div>
                            <h3 style="margin-bottom: 0.5rem;">No blog posts yet</h3>
                            <p>Create your first blog post to engage your guests</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openBlogModal()">Create Your First Post</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attractions App View -->
            <div id="app-attractions" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üéØ Attractions</h2>
                            <p>Manage local attractions and things to do</p>
                        </div>
                        <button class="btn" onclick="openAttractionModal()">+ Add Attraction</button>
                    </div>
                </div>

                <div class="card">
                    <div id="app-attractions-list">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üéØ</div>
                            <h3 style="margin-bottom: 0.5rem;">No attractions yet</h3>
                            <p>Add local attractions to help guests explore the area</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openAttractionModal()">Add Your First Attraction</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews App View -->
            <div id="app-reviews" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>‚≠ê Reviews</h2>
                            <p>Manage guest reviews and testimonials</p>
                        </div>
                        <button class="btn" onclick="openReviewModal()">+ Add Review</button>
                    </div>
                </div>

                <div class="card">
                    <div id="app-reviews-list">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">‚≠ê</div>
                            <h3 style="margin-bottom: 0.5rem;">No reviews yet</h3>
                            <p>Add guest reviews to build trust with potential guests</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openReviewModal()">Add Your First Review</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Documentation View -->
            <div id="api-docs" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üîå API Documentation</h2>
                            <p>Integrate GAS with your applications</p>
                        </div>
                        <button class="btn" style="background: #10b981;" onclick="testApiConnection()">Test Connection</button>
                    </div>
                </div>

                <!-- API Keys Management -->
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card-title">üîë API Keys</h3>
                        <button class="btn" onclick="openApiKeyModal()">+ Create API Key</button>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        API keys are required for secure endpoints. Create separate keys for different applications.
                    </p>
                    
                    <div id="api-keys-list">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîê</div>
                            <p>No API keys yet. Create one to access secure endpoints.</p>
                        </div>
                    </div>
                </div>

                <!-- Base URL -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">üåê API Base URL</h3>
                    </div>
                    <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-input" id="api-docs-base-url" value="" readonly style="font-family: monospace;">
                            <button class="btn" style="background: #64748b;" onclick="copyToClipboard(document.getElementById('api-docs-base-url').value)">üìã Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Secure API Endpoints -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">üîí Secure API Endpoints (v1)</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Require <code style="background: #fee2e2; padding: 0.125rem 0.375rem; border-radius: 4px;">X-API-Key</code> header. Full access to pricing, availability, offers.
                    </p>
                    
                    <!-- Tabs for endpoint categories -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn" style="background: var(--accent);" onclick="showApiTab('rooms')" id="api-tab-rooms">Rooms</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('availability')" id="api-tab-availability">Availability</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('pricing')" id="api-tab-pricing">Pricing</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('offers')" id="api-tab-offers">Offers</button>
                        <button class="btn" style="background: #64748b;" onclick="showApiTab('content')" id="api-tab-content">Content</button>
                    </div>
                    
                    <!-- Rooms Endpoints -->
                    <div id="api-endpoints-rooms" class="api-endpoints-section">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/rooms</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get all rooms with images, amenities, and base pricing</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/rooms/{roomId}</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get single room with full details</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Availability Endpoints -->
                    <div id="api-endpoints-availability" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/availability?start_date=X&end_date=Y&room_id=Z</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get availability calendar for date range</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/availability/check</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0 0 0.5rem;">Check if room is available + calculate total price</p>
                                <code style="font-size: 0.8rem; color: #64748b;">Body: { room_id, check_in, check_out, guests }</code>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pricing Endpoints -->
                    <div id="api-endpoints-pricing" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/pricing?room_id=X&start_date=Y&end_date=Z</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get base prices and seasonal pricing</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/taxes</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get all taxes and fees</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Offers Endpoints -->
                    <div id="api-endpoints-offers" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/offers</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get active offers and promotions</p>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/offers/validate</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0 0 0.5rem;">Validate promo code or voucher</p>
                                <code style="font-size: 0.8rem; color: #64748b;">Body: { code, room_id, check_in, check_out, subtotal }</code>
                            </div>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/upsells?room_id=X</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get available upsells/add-ons</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Endpoints -->
                    <div id="api-endpoints-content" class="api-endpoints-section" style="display: none;">
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                    <code style="font-family: monospace; font-size: 0.9rem;">/api/v1/content</code>
                                </div>
                                <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Get all content: pages, contact, branding, blog, attractions</p>
                            </div>
                        </div>
                    </div>
                    
                    <details style="margin-top: 1.5rem;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--accent);">üìñ View Example Code (Secure API)</summary>
                        <pre style="background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; overflow-x: auto; margin-top: 0.75rem; font-size: 0.85rem;">
// All secure endpoints require X-API-Key header
const API_KEY = 'gas_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
const headers = { 'X-API-Key': API_KEY };

// Get all rooms with full details
const rooms = await fetch('/api/v1/rooms', { headers });
const roomsData = await rooms.json();

// Check availability and get price
const availability = await fetch('/api/v1/availability/check', {
  method: 'POST',
  headers: { ...headers, 'Content-Type': 'application/json' },
  body: JSON.stringify({
    room_id: 123,
    check_in: '2025-02-15',
    check_out: '2025-02-18',
    guests: 2
  })
});
const availData = await availability.json();
// Returns: { available: true, pricing: { nights: 3, total: 450, currency: 'USD' } }

// Validate a promo code
const promo = await fetch('/api/v1/offers/validate', {
  method: 'POST',
  headers: { ...headers, 'Content-Type': 'application/json' },
  body: JSON.stringify({
    code: 'SUMMER20',
    subtotal: 450
  })
});
// Returns: { valid: true, type: 'voucher', calculated_discount: 90 }
                        </pre>
                    </details>
                </div>

                <!-- Public Endpoints -->
                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <h3 class="card-title">üåç Public Endpoints (No Auth)</h3>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        No API key required. Limited data, safe for frontend JavaScript.
                    </p>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace; font-size: 0.9rem;">/api/public/client/{clientId}/site-config</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Complete site config (contact, branding, navigation, pages)</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GET</span>
                                <code style="font-family: monospace; font-size: 0.9rem;">/api/public/client/{clientId}/rooms</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Public room listing</p>
                        </div>
                        <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">POST</span>
                                <code style="font-family: monospace; font-size: 0.9rem;">/api/public/check-availability</code>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">Basic availability check</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Key Modal -->
            <div id="apiKeyModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 id="apiKeyModalTitle">Create API Key</h3>
                        <button class="modal-close" onclick="closeApiKeyModal()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Key Name *</label>
                            <input type="text" class="form-input" id="api-key-name" placeholder="e.g., WordPress Site, Mobile App">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Permissions</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-rooms" checked> Read Rooms
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-availability" checked> Read Availability
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-pricing" checked> Read Pricing
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-offers" checked> Read Offers
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="perm-read-content" checked> Read Content
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Rate Limit (requests/minute)</label>
                            <input type="number" class="form-input" id="api-key-rate-limit" value="60">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Allowed Origins (optional, comma-separated)</label>
                            <input type="text" class="form-input" id="api-key-origins" placeholder="https://mysite.com, https://app.mysite.com">
                        </div>
                        
                        <input type="hidden" id="api-key-edit-id" value="">
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeApiKeyModal()">Cancel</button>
                        <button class="btn" onclick="saveApiKey()">Create Key</button>
                    </div>
                </div>
            </div>

            <!-- WordPress View -->
            <div id="wordpress" class="view">
                <div class="header">
                    <h2>WordPress Integration</h2>
                    <p>Add booking functionality to your WordPress website</p>
                </div>

                <!-- Website Status Section (for selected account) -->
                <div id="wp-website-section" class="card" style="margin-bottom: 1.5rem; display: none;">
                    <div id="wp-no-website" style="display: none;">
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">üåê</div>
                            <h3 style="margin: 0 0 0.5rem 0;">No Website Yet</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Create a WordPress website for this account with our booking system pre-installed.</p>
                            <button class="btn" onclick="openCreateWebsiteModal()" style="font-size: 1rem; padding: 0.75rem 2rem;">
                                üöÄ Create Website
                            </button>
                        </div>
                    </div>
                    
                    <div id="wp-has-website" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">üåê</span>
                                Account Website
                            </h3>
                            <span id="wp-website-status" class="badge badge-success">Active</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Site URL</div>
                                <a id="wp-website-url" href="#" target="_blank" style="color: var(--accent); font-weight: 500; word-break: break-all;"></a>
                            </div>
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">WordPress Admin</div>
                                <a id="wp-website-admin" href="#" target="_blank" style="color: var(--accent); font-weight: 500;">Open Dashboard ‚Üí</a>
                            </div>
                            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Template</div>
                                <span id="wp-website-template" style="font-weight: 500;">-</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <a id="wp-website-visit-btn" href="#" target="_blank" class="btn" style="text-decoration: none;">
                                üîó Visit Site
                            </a>
                            <a id="wp-website-admin-btn" href="#" target="_blank" class="btn btn-secondary" style="text-decoration: none;">
                                ‚öôÔ∏è WP Admin
                            </a>
                            <button class="btn btn-secondary" onclick="refreshWebsiteStatus()" style="margin-left: auto;">
                                üîÑ Refresh Status
                            </button>
                        </div>
                    </div>
                    
                    <div id="wp-website-creating" style="display: none; text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                        <h3 style="margin: 0 0 0.5rem 0;">Creating Website...</h3>
                        <p style="color: var(--text-secondary);">This usually takes 10-30 seconds</p>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="refreshWebsiteStatus()">Check Status</button>
                        </div>
                    </div>
                </div>

                <!-- WordPress Hosting Settings (Master Admin Only) -->
                <div id="wp-vps-settings" class="card billing-admin-only" style="margin-bottom: 1.5rem; border: 2px dashed var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            ‚öôÔ∏è WordPress Hosting Configuration
                        </h3>
                        <button class="btn btn-secondary btn-small" onclick="toggleVPSSettings()">
                            <span id="vps-toggle-text">Show Settings</span>
                        </button>
                    </div>
                    
                    <div id="vps-settings-panel" style="display: none;">
                        <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <p style="margin: 0; font-size: 0.9rem;">‚úÖ <strong>Your WordPress hosting is active!</strong></p>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: var(--text-secondary);">API: sites.gas.travel</p>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label>API URL</label>
                            <input type="text" id="vps-api-url" class="form-input" value="https://sites.gas.travel/gas-api.php">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label>API Key</label>
                            <input type="password" id="vps-api-key" class="form-input" placeholder="Enter your WordPress API key">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label>Default Template (Optional)</label>
                            <input type="text" id="vps-default-template" class="form-input" placeholder="e.g., developer-theme">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="vps-enabled" style="width: 18px; height: 18px;">
                                Enable WordPress Site Creation
                            </label>
                        </div>
                        
                        <button class="btn" onclick="saveVPSSettings()">üíæ Save Settings</button>
                    </div>
                </div>

                <!-- Your Settings -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white;">
                    <h3 style="margin: 0 0 1rem 0;">‚öôÔ∏è Your WordPress Plugin Settings</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.25rem;">API URL</div>
                            <code style="font-size: 0.9rem; word-break: break-all;" id="wp-api-url"></code>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.25rem;">Client Account ID</div>
                            <code style="font-size: 1.2rem; font-weight: bold;" id="wp-client-id">-</code>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.25rem;">Property ID</div>
                            <code style="font-size: 1.2rem; font-weight: bold;" id="wp-property-id">-</code>
                        </div>
                    </div>
                </div>

                <!-- Download Section -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); color: white;">
                    <h3 style="margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                        üì¶ Plugin Downloads
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
                        <!-- Core Booking Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;">üîå</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Booking</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v4.0 ‚Ä¢ All Plans</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Search, rooms, calendar & checkout</p>
                            <a href="/downloads/gas-booking-wp-plugin.zip" download class="btn" style="background: white; color: #1e40af; width: 100%; text-align: center; text-decoration: none; display: block; font-size: 0.85rem;">
                                ‚¨áÔ∏è Download
                            </a>
                        </div>
                        
                        <!-- Theme -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;">üé®</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">Developer Theme</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v2.0 ‚Ä¢ All Plans</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Starter theme with auto-setup</p>
                            <a href="/downloads/gas-theme-developer.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                ‚¨áÔ∏è Download
                            </a>
                        </div>
                        
                        <!-- Blog Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;">üìù</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Blog</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v1.0 ‚Ä¢ Pro+</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Blog with SEO & schema markup</p>
                            <a href="/downloads/gas-blog.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                ‚¨áÔ∏è Download
                            </a>
                        </div>
                        
                        <!-- Attractions Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;">üìç</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Attractions</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v1.0 ‚Ä¢ Business+</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">Nearby places & activities</p>
                            <a href="/downloads/gas-attractions.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                ‚¨áÔ∏è Download
                            </a>
                        </div>
                        
                        <!-- Reviews Plugin -->
                        <div style="background: rgba(255,255,255,0.15); border-radius: 10px; padding: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.75rem;">‚≠ê</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">GAS Reviews</h4>
                                    <span style="font-size: 0.75rem; opacity: 0.8;">v1.0 ‚Ä¢ Enterprise</span>
                                </div>
                            </div>
                            <p style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 1rem;">TripAdvisor, Booking.com, Google</p>
                            <a href="/downloads/gas-reviews.zip" download class="btn" style="background: rgba(255,255,255,0.25); color: white; width: 100%; text-align: center; text-decoration: none; display: block; border: 1px solid rgba(255,255,255,0.3); font-size: 0.85rem;">
                                ‚¨áÔ∏è Download
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Setup Guide -->
                <div class="card" style="margin-bottom: 1.5rem; border: 2px solid var(--accent); border-radius: 12px;">
                    <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        üìã Setup Guide
                    </h3>
                    
                    <!-- Step 1 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Install the Plugin</h4>
                            <ol style="margin: 0; padding-left: 1.25rem; color: var(--text-secondary); font-size: 0.9rem; line-height: 1.8;">
                                <li>Download the <strong>GAS Booking Plugin</strong> ZIP file</li>
                                <li>In WordPress, go to <strong>Plugins ‚Üí Add New ‚Üí Upload Plugin</strong></li>
                                <li>Choose the ZIP file and click <strong>Install Now</strong></li>
                                <li>Click <strong>Activate Plugin</strong></li>
                            </ol>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Configure Plugin Settings</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">In WordPress, go to <strong>Settings ‚Üí GAS Booking</strong> and enter:</p>
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-size: 0.85rem;">
                                <div style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem; align-items: center;">
                                    <strong>API URL:</strong>
                                    <div>
                                        <code style="background: #1e293b; color: #e2e8f0; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;" id="wp-api-url-guide"></code>
                                        <button onclick="copyShortcode(document.getElementById('wp-api-url-guide').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-left: 0.5rem;">Copy</button>
                                    </div>
                                    <strong>Client Account ID:</strong>
                                    <div>
                                        <code style="background: #1e293b; color: #e2e8f0; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.8rem;" id="wp-client-id-guide">1</code>
                                        <button onclick="copyShortcode(document.getElementById('wp-client-id-guide').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-left: 0.5rem;">Copy</button>
                                    </div>
                                </div>
                                <p style="margin: 0.75rem 0 0 0; color: var(--text-secondary); font-size: 0.8rem;">Leave other settings as default, then click <strong>Save Changes</strong></p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">3</div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Add Search Bar to Homepage</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">Edit your homepage, add a <strong>Shortcode</strong> block, and paste:</p>
                            <div style="background: #1e293b; border-radius: 6px; padding: 0.6rem 1rem; display: inline-flex; align-items: center; gap: 0.75rem;">
                                <code style="color: #e2e8f0; font-size: 0.9rem;">[gas_search]</code>
                                <button onclick="copyShortcode('[gas_search]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">‚Ü≥ Shows check-in/check-out date picker</p>
                        </div>
                    </div>

                    <!-- Step 4 -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">4</div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Create "Book Now" Page</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;"><strong>Pages ‚Üí Add New</strong> ‚Üí Title: "Book Now" ‚Üí Add Shortcode block:</p>
                            <div style="background: #1e293b; border-radius: 6px; padding: 0.6rem 1rem; display: inline-flex; align-items: center; gap: 0.75rem;">
                                <code style="color: #e2e8f0; font-size: 0.9rem;" id="wp-rooms-shortcode">[gas_rooms]</code>
                                <button onclick="copyShortcode('[gas_rooms]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">‚Ü≥ Shows grid of all rooms with availability</p>
                        </div>
                    </div>

                    <!-- Step 5 -->
                    <div style="display: flex; gap: 1rem;">
                        <div style="background: var(--accent); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">5</div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Create "Room" Page</h4>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;"><strong>Pages ‚Üí Add New</strong> ‚Üí Title: "Room" ‚Üí Add Shortcode block:</p>
                            <div style="background: #1e293b; border-radius: 6px; padding: 0.6rem 1rem; display: inline-flex; align-items: center; gap: 0.75rem;">
                                <code style="color: #e2e8f0; font-size: 0.9rem;">[gas_room]</code>
                                <button onclick="copyShortcode('[gas_room]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">‚Ü≥ Shows full room details, calendar & booking form</p>
                        </div>
                    </div>
                </div>

                <!-- Flow Diagram -->
                <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                    <h3 class="card-title" style="margin-bottom: 1rem;">üîÑ Booking Flow</h3>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex-wrap: wrap; font-size: 0.9rem;">
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üè†</div>
                            <strong>Homepage</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">[gas_search]</div>
                        </div>
                        <div style="font-size: 1.5rem; color: var(--accent);">‚Üí</div>
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üìã</div>
                            <strong>Book Now</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">[gas_rooms]</div>
                        </div>
                        <div style="font-size: 1.5rem; color: var(--accent);">‚Üí</div>
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üõèÔ∏è</div>
                            <strong>Room Details</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">[gas_room]</div>
                        </div>
                        <div style="font-size: 1.5rem; color: var(--accent);">‚Üí</div>
                        <div style="background: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">‚úÖ</div>
                            <strong>Booked!</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Confirmation</div>
                        </div>
                    </div>
                </div>

                <!-- Plugin Download & Settings -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <h3 class="card-title" style="display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="24" height="24" viewBox="0 0 122.5 122.5" fill="#21759b"><path d="M8.7 61.3c0 20.8 12.1 38.8 29.6 47.3L13 40.3c-2.8 6.5-4.3 13.7-4.3 21zm88.6-2.7c0-6.5-2.3-11-4.3-14.5-2.7-4.3-5.2-8-5.2-12.3 0-4.8 3.7-9.3 8.9-9.3h.7c-9.4-8.6-21.9-13.9-35.7-13.9-18.5 0-34.7 9.5-44.2 23.8h3.4c5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.8.3-6 .5l19.1 57 11.5-34.5-8.2-22.5c-2.8-.2-5.5-.5-5.5-.5-2.8-.2-2.5-4.5.3-4.3 0 0 8.7.7 13.9.7 5.5 0 14-.7 14-.7 2.8-.2 3.2 4 .3 4.3 0 0-2.9.3-6 .5l19 56.5 5.2-17.5c2.3-7.3 4-12.5 4-17zm-36.3 7.6l-15.8 45.8c4.7 1.4 9.7 2.2 14.8 2.2 6.1 0 12-1.1 17.4-3-.1-.2-.3-.5-.4-.7l-16-43.3zm45.1-29.8c.5 3.4.7 7 .7 10.9 0 10.8-2 22.9-8 38l-21.8 63.1c21.2-12.4 35.5-35.5 35.5-62.1 0-17.9-6.2-34.3-16.4-47.9zM61.3 0C27.5 0 0 27.5 0 61.3c0 33.8 27.5 61.3 61.3 61.3 33.8 0 61.3-27.5 61.3-61.3C122.5 27.5 95 0 61.3 0zm0 119.7c-32.2 0-58.5-26.2-58.5-58.5 0-32.2 26.2-58.5 58.5-58.5 32.2 0 58.5 26.2 58.5 58.5-.1 32.3-26.3 58.5-58.5 58.5z"/></svg>
                                Your Settings
                            </h3>
                        </div>
                        <a href="/gas-widgets-preview.html" target="_blank" class="btn btn-secondary" style="text-decoration: none;">
                            Preview Widgets ‚Üí
                        </a>
                    </div>
                    
                    <div style="background: var(--accent-light); border-radius: 8px; padding: 1rem;">
                        <div style="display: grid; grid-template-columns: 140px 1fr auto; gap: 0.75rem; align-items: center; font-size: 0.9rem;">
                            <span style="color: var(--text-secondary); font-weight: 500;">API URL:</span>
                            <code style="background: white; padding: 0.4rem 0.75rem; border-radius: 4px; font-size: 0.85rem;" id="wp-api-url"></code>
                            <button onclick="copyShortcode(document.getElementById('wp-api-url').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.3rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Copy</button>
                            
                            <span style="color: var(--text-secondary); font-weight: 500;">Property ID:</span>
                            <code style="background: white; padding: 0.4rem 0.75rem; border-radius: 4px; font-size: 0.85rem;" id="wp-property-id">1</code>
                            <button onclick="copyShortcode(document.getElementById('wp-property-id').textContent)" style="background: var(--accent); border: none; color: white; padding: 0.3rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Shortcodes Reference -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem;">üìù Shortcode Reference</h3>
                    
                    <!-- Search Bar -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="background: #dbeafe; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">üîç</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Search Bar</h4>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Homepage</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_search]</code>
                                <button onclick="copyShortcode('[gas_search]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">style="vertical"</code>
                                <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px; margin-left: 0.25rem;">button_text="Search"</code>
                            </div>
                        </div>
                    </div>

                    <!-- Room Listing -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="background: #dcfce7; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">üè†</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Room Listing</h4>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Book Now page</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_rooms property_id="<span id="shortcode-property-id">1</span>"]</code>
                                <button onclick="copyShortcode('[gas_rooms property_id=&quot;' + (window.currentPropertyId || 1) + '&quot;]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">columns="2"</code>
                            </div>
                        </div>
                    </div>

                    <!-- Room Detail -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="background: #fef3c7; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">üõèÔ∏è</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Room Detail Page</h4>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Room page</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_room]</code>
                                <button onclick="copyShortcode('[gas_room]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">unit_id="190"</code>
                                <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px; margin-left: 0.25rem;">months="3"</code>
                            </div>
                        </div>
                    </div>

                    <!-- Compact Booking -->
                    <div style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                        <div style="background: #fce7f3; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;">üìÖ</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <h4 style="margin: 0; font-size: 0.95rem;">Compact Booking Widget</h4>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Sidebar / Embed</span>
                            </div>
                            <div style="background: #1e293b; border-radius: 4px; padding: 0.5rem 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <code>[gas_booking unit_id="190"]</code>
                                <button onclick="copyShortcode('[gas_booking unit_id=&quot;190&quot;]')" style="background: #334155; border: none; color: white; padding: 0.25rem 0.6rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem;">Copy</button>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                Options: <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px;">months="2"</code>
                                <code style="background: #e2e8f0; padding: 0.1rem 0.3rem; border-radius: 2px; margin-left: 0.25rem;">show_prices="no"</code>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Room IDs Reference -->
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 0.5rem;">Your Room IDs</h3>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">Reference these IDs when using shortcodes for specific rooms:</p>
                    <div id="wp-room-ids" style="background: var(--bg-primary); border-radius: 8px; padding: 1rem;">
                        <p style="color: var(--text-secondary); font-size: 0.85rem;">Loading rooms...</p>
                    </div>
                </div>
            </div>

            <!-- =====================================================
                 SUB PAGES - About, Gallery, Blog, Attractions, Dining, Contact
                 ===================================================== -->
            
            <!-- Sub Page: About Us -->
            <div id="wb-page-about" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>‚ÑπÔ∏è About Us Page</h2>
                            <p>Tell your story and connect with guests</p>
                        </div>
                        <button class="btn" onclick="saveSubPage('about')">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Page Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="wb-page-about-title" value="About Us">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subtitle / Tagline</label>
                            <input type="text" class="form-input" id="wb-page-about-subtitle" placeholder="Our story and commitment to hospitality">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Hero Image</h3></div>
                    <div class="card-body">
                        <div id="wb-page-about-hero-preview" style="width: 100%; height: 200px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border: 2px dashed #e2e8f0; background-size: cover; background-position: center;">
                            <span style="color: #94a3b8;">Click to upload hero image</span>
                        </div>
                        <input type="file" id="wb-page-about-hero" accept="image/*" onchange="previewSubPageImage('about', 'hero')">
                        <input type="hidden" id="wb-page-about-hero-url">
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Our Story</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Headline</label>
                            <input type="text" class="form-input" id="wb-page-about-story-title" placeholder="Our Story">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Content</label>
                            <textarea class="form-textarea" id="wb-page-about-story-content" rows="6" placeholder="Share your property's history, vision, and what makes you unique..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Story Image</label>
                            <div id="wb-page-about-story-image-preview" style="width: 300px; height: 200px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border: 2px dashed #e2e8f0; background-size: cover; background-position: center;">
                                <span style="color: #94a3b8;">Upload image</span>
                            </div>
                            <input type="file" id="wb-page-about-story-image" accept="image/*" onchange="previewSubPageImage('about', 'story-image')">
                            <input type="hidden" id="wb-page-about-story-image-url">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Our Values</h3></div>
                    <div class="card-body">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Add up to 4 values that define your property</p>
                        <div id="wb-page-about-values" style="display: grid; gap: 1rem;">
                            <div style="display: grid; grid-template-columns: 80px 1fr 2fr; gap: 0.5rem; align-items: start;">
                                <input type="text" class="form-input" id="wb-page-about-value1-icon" placeholder="üè°" style="text-align: center; font-size: 1.5rem;">
                                <input type="text" class="form-input" id="wb-page-about-value1-title" placeholder="Value title">
                                <input type="text" class="form-input" id="wb-page-about-value1-desc" placeholder="Brief description">
                            </div>
                            <div style="display: grid; grid-template-columns: 80px 1fr 2fr; gap: 0.5rem; align-items: start;">
                                <input type="text" class="form-input" id="wb-page-about-value2-icon" placeholder="‚ù§Ô∏è" style="text-align: center; font-size: 1.5rem;">
                                <input type="text" class="form-input" id="wb-page-about-value2-title" placeholder="Value title">
                                <input type="text" class="form-input" id="wb-page-about-value2-desc" placeholder="Brief description">
                            </div>
                            <div style="display: grid; grid-template-columns: 80px 1fr 2fr; gap: 0.5rem; align-items: start;">
                                <input type="text" class="form-input" id="wb-page-about-value3-icon" placeholder="‚ú®" style="text-align: center; font-size: 1.5rem;">
                                <input type="text" class="form-input" id="wb-page-about-value3-title" placeholder="Value title">
                                <input type="text" class="form-input" id="wb-page-about-value3-desc" placeholder="Brief description">
                            </div>
                            <div style="display: grid; grid-template-columns: 80px 1fr 2fr; gap: 0.5rem; align-items: start;">
                                <input type="text" class="form-input" id="wb-page-about-value4-icon" placeholder="üåü" style="text-align: center; font-size: 1.5rem;">
                                <input type="text" class="form-input" id="wb-page-about-value4-title" placeholder="Value title">
                                <input type="text" class="form-input" id="wb-page-about-value4-desc" placeholder="Brief description">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Team Section (Optional)</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-page-about-team-enabled"> Show Team Section
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Section Title</label>
                            <input type="text" class="form-input" id="wb-page-about-team-title" value="Meet Our Team">
                        </div>
                        <p style="color: var(--text-secondary); margin: 1rem 0;">Team members can be managed in the full WordPress admin</p>
                    </div>
                </div>
            </div>

            <!-- Sub Page: Gallery -->
            <div id="wb-page-gallery" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üñºÔ∏è Gallery Page</h2>
                            <p>Showcase your property with beautiful images</p>
                        </div>
                        <button class="btn" onclick="saveSubPage('gallery')">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Page Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="wb-page-gallery-title" value="Gallery">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subtitle</label>
                            <input type="text" class="form-input" id="wb-page-gallery-subtitle" placeholder="Explore our beautiful spaces">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Gallery Layout</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Display Style</label>
                            <select class="form-select" id="wb-page-gallery-layout">
                                <option value="grid">Grid (3 columns)</option>
                                <option value="masonry">Masonry</option>
                                <option value="slider">Full-width Slider</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-page-gallery-lightbox" checked> Enable Lightbox
                            </label>
                            <small class="form-hint">Click images to view full size</small>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Gallery Categories</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-page-gallery-show-filters" checked> Show Category Filters
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categories (comma separated)</label>
                            <input type="text" class="form-input" id="wb-page-gallery-categories" value="Rooms, Common Areas, Exterior, Dining">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem; background: linear-gradient(135deg, #dbeafe, #ede9fe); border: 1px solid #93c5fd;">
                    <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem;">üí°</div>
                        <div>
                            <strong style="color: #1e40af;">Tip: Images sync from your GAS library</strong>
                            <p style="margin: 0; color: #3730a3; font-size: 0.9rem;">Upload images in the Images section. They'll automatically appear in your gallery organized by property and room.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub Page: Blog -->
            <div id="wb-page-blog" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üì∞ Blog Page</h2>
                            <p>Share news, tips, and local insights</p>
                        </div>
                        <button class="btn" onclick="saveSubPage('blog')">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Page Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="wb-page-blog-title" value="Blog">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subtitle</label>
                            <input type="text" class="form-input" id="wb-page-blog-subtitle" placeholder="News, tips, and local insights">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Blog Layout</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Layout Style</label>
                                <select class="form-select" id="wb-page-blog-layout">
                                    <option value="grid">Grid (3 columns)</option>
                                    <option value="list">List with Sidebar</option>
                                    <option value="magazine">Magazine Style</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Posts Per Page</label>
                                <select class="form-select" id="wb-page-blog-per-page">
                                    <option value="6">6 posts</option>
                                    <option value="9" selected>9 posts</option>
                                    <option value="12">12 posts</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-page-blog-show-sidebar" checked> Show Sidebar
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem; background: linear-gradient(135deg, #d1fae5, #cffafe); border: 1px solid #6ee7b7;">
                    <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem;">üìù</div>
                        <div>
                            <strong style="color: #065f46;">Manage blog posts in the Blog app</strong>
                            <p style="margin: 0; color: #047857; font-size: 0.9rem;">Go to Apps ‚Üí Blog to create and manage your blog posts. They'll automatically appear on this page.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub Page: Attractions -->
            <div id="wb-page-attractions" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üéØ Attractions Page</h2>
                            <p>Showcase local attractions and activities</p>
                        </div>
                        <button class="btn" onclick="saveSubPage('attractions')">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Page Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="wb-page-attractions-title" value="Things To Do">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subtitle</label>
                            <input type="text" class="form-input" id="wb-page-attractions-subtitle" placeholder="Explore the best of the local area">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Display Options</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Layout Style</label>
                                <select class="form-select" id="wb-page-attractions-layout">
                                    <option value="cards">Cards Grid</option>
                                    <option value="list">List View</option>
                                    <option value="map">Map + List</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Group By</label>
                                <select class="form-select" id="wb-page-attractions-group">
                                    <option value="category">Category</option>
                                    <option value="distance">Distance</option>
                                    <option value="none">No Grouping</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-page-attractions-show-distance" checked> Show Distance from Property
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-page-attractions-show-map"> Show Map
                            </label>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #fbbf24;">
                    <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem;">üéØ</div>
                        <div>
                            <strong style="color: #92400e;">Manage attractions in the Attractions app</strong>
                            <p style="margin: 0; color: #a16207; font-size: 0.9rem;">Go to Apps ‚Üí Attractions to add and manage local points of interest. They'll automatically display on this page.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub Page: Dining -->
            <div id="wb-page-dining" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üçΩÔ∏è Dining Page</h2>
                            <p>Showcase your breakfast, restaurant, or dining options</p>
                        </div>
                        <button class="btn" onclick="saveSubPage('dining')">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Page Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="wb-page-dining-title" value="Dining">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subtitle</label>
                            <input type="text" class="form-input" id="wb-page-dining-subtitle" placeholder="Experience our culinary offerings">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Hero Image</h3></div>
                    <div class="card-body">
                        <div id="wb-page-dining-hero-preview" style="width: 100%; height: 200px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; border: 2px dashed #e2e8f0; background-size: cover; background-position: center;">
                            <span style="color: #94a3b8;">Click to upload hero image</span>
                        </div>
                        <input type="file" id="wb-page-dining-hero" accept="image/*" onchange="previewSubPageImage('dining', 'hero')">
                        <input type="hidden" id="wb-page-dining-hero-url">
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Overview</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Introduction</label>
                            <textarea class="form-textarea" id="wb-page-dining-intro" rows="4" placeholder="Describe your dining experience, breakfast service, or restaurant..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Breakfast Details</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-page-dining-breakfast-enabled" checked> Show Breakfast Section
                            </label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Serving Hours</label>
                                <input type="text" class="form-input" id="wb-page-dining-breakfast-hours" placeholder="7:00 AM - 10:00 AM">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Style</label>
                                <select class="form-select" id="wb-page-dining-breakfast-style">
                                    <option value="full">Full Cooked Breakfast</option>
                                    <option value="continental">Continental</option>
                                    <option value="buffet">Buffet</option>
                                    <option value="menu">√Ä la Carte</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" id="wb-page-dining-breakfast-desc" rows="3" placeholder="Describe your breakfast offerings..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sample Menu Items (one per line)</label>
                            <textarea class="form-textarea" id="wb-page-dining-breakfast-menu" rows="5" placeholder="Fresh fruit and yogurt
Eggs any style
Bacon and sausage
Fresh pastries
Local honey and preserves"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Restaurant/Dinner (Optional)</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-page-dining-restaurant-enabled"> Show Restaurant Section
                            </label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Restaurant Name</label>
                                <input type="text" class="form-input" id="wb-page-dining-restaurant-name" placeholder="The Garden Restaurant">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hours</label>
                                <input type="text" class="form-input" id="wb-page-dining-restaurant-hours" placeholder="6:00 PM - 10:00 PM">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" id="wb-page-dining-restaurant-desc" rows="3" placeholder="Describe your restaurant experience..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub Page: Contact Us -->
            <div id="wb-page-contact" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìß Contact Us Page</h2>
                            <p>Help guests get in touch with you</p>
                        </div>
                        <button class="btn" onclick="saveSubPage('contact')">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Page Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="wb-page-contact-title" value="Contact Us">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subtitle</label>
                            <input type="text" class="form-input" id="wb-page-contact-subtitle" placeholder="We'd love to hear from you">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Contact Information</h3></div>
                    <div class="card-body">
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">This information is pulled from your Footer settings. Update it there to change it everywhere.</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="wb-page-contact-email" placeholder="Synced from Footer settings" disabled style="background: #f1f5f9;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-input" id="wb-page-contact-phone" placeholder="Synced from Footer settings" disabled style="background: #f1f5f9;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea class="form-textarea" id="wb-page-contact-address" rows="2" placeholder="Synced from Footer settings" disabled style="background: #f1f5f9;"></textarea>
                        </div>
                        <a href="#" onclick="navClick(document.querySelector('[data-view=wb-footer]'), 'wb-footer'); return false;" style="color: var(--primary); font-size: 0.9rem;">‚Üí Edit in Footer Settings</a>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Contact Form</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-page-contact-form-enabled" checked> Show Contact Form
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Form Heading</label>
                            <input type="text" class="form-input" id="wb-page-contact-form-title" value="Send us a Message">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Success Message</label>
                            <input type="text" class="form-input" id="wb-page-contact-form-success" value="Thank you! We'll get back to you within 24 hours.">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Map</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="wb-page-contact-map-enabled" checked> Show Map
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Google Maps Embed URL or Coordinates</label>
                            <input type="text" class="form-input" id="wb-page-contact-map-embed" placeholder="Paste Google Maps embed URL or enter coordinates">
                            <small class="form-hint">Get embed code from Google Maps ‚Üí Share ‚Üí Embed a map</small>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Additional Information</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Directions / Getting Here</label>
                            <textarea class="form-textarea" id="wb-page-contact-directions" rows="4" placeholder="Provide directions, parking info, public transport options..."></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Check-in Time</label>
                                <input type="text" class="form-input" id="wb-page-contact-checkin" placeholder="3:00 PM">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Check-out Time</label>
                                <input type="text" class="form-input" id="wb-page-contact-checkout" placeholder="11:00 AM">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub Page: Terms & Conditions -->
            <div id="wb-page-terms" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìú Terms & Conditions</h2>
                            <p>Your booking terms, cancellation policy, and house rules</p>
                        </div>
                        <button class="btn" onclick="saveSubPage('terms')">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Page Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="wb-page-terms-title" value="Terms & Conditions">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Updated Date</label>
                            <input type="date" class="form-input" id="wb-page-terms-updated" style="width: 200px;">
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Booking Terms</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Booking & Reservations</label>
                            <textarea class="form-textarea" id="wb-page-terms-booking" rows="5" placeholder="Describe how bookings are made, confirmation process, deposit requirements..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Cancellation Policy</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Cancellation Terms</label>
                            <textarea class="form-textarea" id="wb-page-terms-cancellation" rows="6" placeholder="e.g., Free cancellation up to 48 hours before check-in. Cancellations within 48 hours will be charged for the first night..."></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Free Cancellation Period</label>
                                <select class="form-select" id="wb-page-terms-cancel-period">
                                    <option value="24">24 hours before check-in</option>
                                    <option value="48" selected>48 hours before check-in</option>
                                    <option value="72">72 hours before check-in</option>
                                    <option value="7days">7 days before check-in</option>
                                    <option value="14days">14 days before check-in</option>
                                    <option value="none">No free cancellation</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Late Cancellation Fee</label>
                                <select class="form-select" id="wb-page-terms-cancel-fee">
                                    <option value="first-night">First night charge</option>
                                    <option value="50">50% of booking</option>
                                    <option value="100">100% of booking</option>
                                    <option value="custom">Custom (specify above)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Check-in / Check-out</h3></div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Check-in Time</label>
                                <input type="text" class="form-input" id="wb-page-terms-checkin-time" placeholder="3:00 PM">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Check-out Time</label>
                                <input type="text" class="form-input" id="wb-page-terms-checkout-time" placeholder="11:00 AM">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Additional Check-in/out Terms</label>
                            <textarea class="form-textarea" id="wb-page-terms-checkin-details" rows="3" placeholder="Early check-in or late check-out subject to availability..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>House Rules</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Property Rules</label>
                            <textarea class="form-textarea" id="wb-page-terms-house-rules" rows="6" placeholder="List your house rules:
‚Ä¢ No smoking
‚Ä¢ No pets (or pet policy)
‚Ä¢ Quiet hours: 10 PM - 8 AM
‚Ä¢ Maximum occupancy
‚Ä¢ No parties or events"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Payment Terms</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Payment Methods & Terms</label>
                            <textarea class="form-textarea" id="wb-page-terms-payment" rows="4" placeholder="Accepted payment methods, deposit requirements, when payment is taken..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Liability & Damages</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Liability Terms</label>
                            <textarea class="form-textarea" id="wb-page-terms-liability" rows="4" placeholder="Guest responsibility for damages, security deposit terms, liability limitations..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Additional Terms</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Other Terms & Conditions</label>
                            <textarea class="form-textarea" id="wb-page-terms-additional" rows="5" placeholder="Any other terms not covered above..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub Page: Privacy Policy -->
            <div id="wb-page-privacy" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üîí Privacy Policy</h2>
                            <p>How you collect, use, and protect guest data</p>
                        </div>
                        <button class="btn" onclick="saveSubPage('privacy')">üíæ Save & Sync</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>Page Settings</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Page Title</label>
                            <input type="text" class="form-input" id="wb-page-privacy-title" value="Privacy Policy">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Last Updated Date</label>
                                <input type="date" class="form-input" id="wb-page-privacy-updated">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Effective Date</label>
                                <input type="date" class="form-input" id="wb-page-privacy-effective">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Introduction</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Privacy Policy Introduction</label>
                            <textarea class="form-textarea" id="wb-page-privacy-intro" rows="4" placeholder="We respect your privacy and are committed to protecting your personal data. This privacy policy explains how we collect, use, and safeguard your information when you visit our website or make a booking."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Data Collection</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">What Data We Collect</label>
                            <textarea class="form-textarea" id="wb-page-privacy-collection" rows="5" placeholder="Types of personal data collected:
‚Ä¢ Name, email, phone number
‚Ä¢ Payment information
‚Ä¢ Booking preferences
‚Ä¢ Communication history
‚Ä¢ Website usage data"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">How We Collect Data</label>
                            <textarea class="form-textarea" id="wb-page-privacy-how-collect" rows="4" placeholder="How data is collected:
‚Ä¢ Directly from you (booking forms, contact forms)
‚Ä¢ Automatically (cookies, analytics)
‚Ä¢ From third parties (booking platforms)"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Data Usage</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">How We Use Your Data</label>
                            <textarea class="form-textarea" id="wb-page-privacy-usage" rows="5" placeholder="We use your data to:
‚Ä¢ Process and manage bookings
‚Ä¢ Send booking confirmations and updates
‚Ä¢ Respond to enquiries
‚Ä¢ Improve our services
‚Ä¢ Send marketing communications (with consent)"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Data Sharing</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Who We Share Data With</label>
                            <textarea class="form-textarea" id="wb-page-privacy-sharing" rows="4" placeholder="We may share your data with:
‚Ä¢ Payment processors
‚Ä¢ Booking platforms (Booking.com, Airbnb, etc.)
‚Ä¢ Email service providers
‚Ä¢ Legal authorities when required"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Cookies</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Cookie Policy</label>
                            <textarea class="form-textarea" id="wb-page-privacy-cookies" rows="4" placeholder="Our website uses cookies to improve your experience. We use:
‚Ä¢ Essential cookies (required for site functionality)
‚Ä¢ Analytics cookies (to understand usage)
‚Ä¢ Marketing cookies (with your consent)"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Your Rights</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Data Subject Rights (GDPR)</label>
                            <textarea class="form-textarea" id="wb-page-privacy-rights" rows="5" placeholder="Under data protection law, you have rights including:
‚Ä¢ Right to access your personal data
‚Ä¢ Right to rectification
‚Ä¢ Right to erasure ('right to be forgotten')
‚Ä¢ Right to restrict processing
‚Ä¢ Right to data portability
‚Ä¢ Right to object"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Data Retention</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">How Long We Keep Data</label>
                            <textarea class="form-textarea" id="wb-page-privacy-retention" rows="3" placeholder="We retain your personal data for as long as necessary to fulfill the purposes we collected it for, including legal, accounting, or reporting requirements."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header"><h3>Contact Information</h3></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Data Controller Contact</label>
                            <textarea class="form-textarea" id="wb-page-privacy-contact" rows="3" placeholder="For privacy-related enquiries, contact:
[Your Business Name]
[Email address]
[Phone number]"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Knowledge Base Articles View -->
            <div id="kb-articles" class="view">
                <div class="header">
                    <h2>üìö Knowledge Base</h2>
                    <p>Manage AI assistant knowledge - articles the chatbot uses to answer questions</p>
                </div>

                <!-- Quick Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="kb-article-count">0</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Articles</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="kb-category-count">0</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Categories</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="kb-unanswered-count">0</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">Unanswered</div>
                    </div>
                </div>

                <!-- Actions Bar -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <button class="btn" onclick="openKBArticleModal()">+ Add Article</button>
                        <button class="btn btn-secondary" onclick="openKBImportModal()">üì• Import Articles</button>
                        <button class="btn btn-secondary" onclick="setupKnowledgeBase()">üîß Setup Tables</button>
                        <div style="flex: 1;"></div>
                        <select id="kb-category-filter" class="form-input" style="width: auto;" onchange="loadKBArticles()">
                            <option value="">All Categories</option>
                        </select>
                        <input type="text" id="kb-search" class="form-input" placeholder="Search articles..." style="width: 200px;" onkeyup="debounce(loadKBArticles, 300)()">
                    </div>
                </div>

                <!-- Articles List -->
                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Views</th>
                                    <th>Helpful</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="kb-articles-table">
                                <tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">Loading articles...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Knowledge Base Unanswered View -->
            <div id="kb-unanswered" class="view">
                <div class="header">
                    <h2>‚ùì Unanswered Questions</h2>
                    <p>Questions the AI couldn't answer - review and add missing knowledge</p>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="kb-unanswered-filter" class="form-input" style="width: auto;" onchange="loadKBUnanswered()">
                            <option value="new">New</option>
                            <option value="resolved">Resolved</option>
                            <option value="">All</option>
                        </select>
                        <div style="flex: 1;"></div>
                        <span id="kb-unanswered-total" style="color: var(--text-secondary); font-size: 0.9rem;">0 questions</span>
                    </div>
                </div>

                <div id="kb-unanswered-list">
                    <div class="card" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        Loading unanswered questions...
                    </div>
                </div>
            </div>

            <!-- Billing Overview View -->
            <div id="billing-overview" class="view">
                <div class="header">
                    <h2>üìä Billing Overview</h2>
                    <p>Revenue and subscription metrics</p>
                </div>

                <!-- MRR Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <div style="font-size: 2.5rem; font-weight: 700;" id="billing-mrr">¬£0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Monthly Recurring Revenue</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent);" id="billing-active-subs">0</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Active Subscriptions</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 1.5rem;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning);" id="billing-credits-circulation">0</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Credits in Circulation</div>
                    </div>
                </div>

                <!-- Setup Button -->
                <div id="billing-setup-section" class="card" style="margin-bottom: 1.5rem; background: #f0fdf4; border: 1px solid #bbf7d0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; color: #166534;">üîß Setup Billing Tables</h3>
                            <p style="margin: 0; color: #166534; font-size: 0.9rem;">Run this once to create billing tables and default plans/packages</p>
                        </div>
                        <button class="btn" onclick="setupBilling()">Setup Billing</button>
                    </div>
                </div>

                <!-- Subscriptions by Plan -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title">Subscriptions by Plan</h3>
                    <div id="billing-subs-by-plan">
                        <p style="color: var(--text-secondary);">Loading...</p>
                    </div>
                </div>

                <!-- Recent Payments -->
                <div class="card">
                    <h3 class="card-title">Recent Payments</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Amount</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="billing-recent-payments">
                                <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No payments yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Billing Plans View -->
            <div id="billing-plans" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìã Subscription Plans</h2>
                            <p>Bundle products into pricing tiers</p>
                        </div>
                        <button class="btn" onclick="openPlanModal()">+ Add Plan</button>
                    </div>
                </div>

                <div id="billing-plans-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="card" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        Loading plans...
                    </div>
                </div>
            </div>

            <!-- Billing Products View -->
            <div id="billing-products" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üì¶ Products</h2>
                            <p>Individual sellable items - templates, plugins, apps</p>
                        </div>
                        <button class="btn" onclick="openProductModal()">+ Add Product</button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Monthly</th>
                                    <th>Yearly</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billing-products-table">
                                <tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Billing Add-ons View -->
            <div id="billing-addons" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üß© Add-ons</h2>
                            <p>Extra items customers can add to their subscription</p>
                        </div>
                        <button class="btn" onclick="openAddonModal()">+ Add Add-on</button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Add-on</th>
                                    <th>Monthly Price</th>
                                    <th>Extra Properties</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billing-addons-table">
                                <tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Billing Subscribers View -->
            <div id="billing-subscribers" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üë• Subscribers</h2>
                            <p>Accounts with active subscriptions</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="subscribers-filter-plan" class="form-input" style="width: auto;" onchange="loadSubscribers()">
                                <option value="">All Plans</option>
                            </select>
                            <select id="subscribers-filter-status" class="form-input" style="width: auto;" onchange="loadSubscribers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="trialing">Trialing</option>
                                <option value="past_due">Past Due</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Plan</th>
                                    <th>Add-ons</th>
                                    <th>MRR</th>
                                    <th>Status</th>
                                    <th>Since</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billing-subscribers-table">
                                <tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Affiliates Admin View -->
            <div id="billing-affiliates" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>ü§ù Affiliate Program</h2>
                            <p>Manage affiliate tiers and referral partners</p>
                        </div>
                    </div>
                </div>

                <!-- Tier Cards -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="card" style="text-align: center; border-top: 4px solid #CD7F32;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ü•â</div>
                        <h3 style="margin: 0;">Bronze</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #CD7F32; margin: 0.5rem 0;">5%</div>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">Default tier</p>
                    </div>
                    <div class="card" style="text-align: center; border-top: 4px solid #C0C0C0;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ü•à</div>
                        <h3 style="margin: 0;">Silver</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #71717a; margin: 0.5rem 0;">10%</div>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">5+ active referrals</p>
                    </div>
                    <div class="card" style="text-align: center; border-top: 4px solid #FFD700;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ü•á</div>
                        <h3 style="margin: 0;">Gold</h3>
                        <div style="font-size: 2rem; font-weight: 700; color: #ca8a04; margin: 0.5rem 0;">15%</div>
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">10+ referrals OR ¬£500+/mo</p>
                    </div>
                </div>

                <!-- Stats Summary -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 700;" id="affiliate-total-count">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Total Affiliates</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="affiliate-active-referrals">0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Active Referrals</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="affiliate-monthly-commission">¬£0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">This Month's Commission</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="affiliate-pending-payouts">¬£0</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Pending Payouts</div>
                        </div>
                    </div>
                </div>

                <!-- Affiliates Table -->
                <div class="card">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Affiliate</th>
                                    <th>Tier</th>
                                    <th>Referral Code</th>
                                    <th>Active Referrals</th>
                                    <th>Lifetime Earnings</th>
                                    <th>Pending</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="billing-affiliates-table">
                                <tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- My Referrals View (User's Affiliate Dashboard) -->
            <div id="my-referrals" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üí∞ My Referrals</h2>
                            <p>Earn commission by referring properties to GAS</p>
                        </div>
                    </div>
                </div>

                <!-- Not an affiliate yet -->
                <div id="affiliate-signup-card" class="card" style="text-align: center; padding: 3rem; display: none;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">ü§ù</div>
                    <h2 style="margin: 0 0 1rem 0;">Join the GAS Affiliate Program</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto;">
                        Earn up to 15% commission on every subscription from properties you refer. 
                        Start at Bronze (5%) and level up as you grow!
                    </p>
                    <button class="btn" onclick="joinAffiliateProgram()" style="font-size: 1.1rem; padding: 0.75rem 2rem;">
                        üöÄ Join Now - It's Free
                    </button>
                </div>

                <!-- Affiliate Dashboard -->
                <div id="affiliate-dashboard" style="display: none;">
                    <!-- My Stats -->
                    <div class="card" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span id="my-tier-icon" style="font-size: 2rem;">ü•â</span>
                                    <span id="my-tier-name" style="font-size: 1.5rem; font-weight: 700;">Bronze</span>
                                </div>
                                <p style="margin: 0; color: #92400e;">
                                    You earn <strong id="my-commission-rate">5%</strong> on all referral subscriptions
                                </p>
                            </div>
                            <div id="tier-progress" style="text-align: right;">
                                <p style="margin: 0; font-size: 0.9rem; color: #92400e;">
                                    <span id="referrals-to-next">5</span> more referrals to reach Silver!
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Referral Link -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0;">üîó Your Referral Link</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="my-referral-link" class="form-input" readonly style="flex: 1; font-family: monospace;">
                            <button class="btn" onclick="copyReferralLink()">üìã Copy</button>
                        </div>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-secondary);">
                            Share this link with properties. When they sign up and subscribe, you earn commission!
                        </p>
                    </div>

                    <!-- My Earnings -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">This Month</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="my-earnings-month">¬£0.00</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Pending Payout</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="my-earnings-pending">¬£0.00</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Lifetime Earnings</div>
                            <div style="font-size: 2rem; font-weight: 700;" id="my-earnings-lifetime">¬£0.00</div>
                        </div>
                        <div class="card" style="text-align: center;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Active Referrals</div>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="my-referral-count">0</div>
                        </div>
                    </div>

                    <!-- Request Payout -->
                    <div class="card" style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h4 style="margin: 0;">Ready to cash out?</h4>
                            <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                Minimum payout: ¬£50 ‚Ä¢ Payouts processed weekly via Airwallex
                            </p>
                        </div>
                        <button class="btn" id="request-payout-btn" onclick="requestPayout()" disabled style="background: var(--success);">
                            üí∏ Request Payout
                        </button>
                    </div>

                    <!-- My Referrals List -->
                    <div class="card">
                        <h3 style="margin: 0 0 1rem 0;">üë• My Referrals</h3>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Signed Up</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Your Earnings</th>
                                    </tr>
                                </thead>
                                <tbody id="my-referrals-table">
                                    <tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No referrals yet. Share your link to get started!</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Billing (Client View) -->
            <div id="my-billing" class="view">
                <div class="header">
                    <h2>üí≥ Plans & Extras</h2>
                    <p>Subscribe to a plan or purchase extras</p>
                </div>

                <!-- Subscription Plans -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem;">üìã Subscription Plans</h3>
                    <div id="my-billing-plans" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <p style="color: var(--text-secondary);">Loading plans...</p>
                    </div>
                </div>

                <!-- Buy Credits -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <h3 class="card-title" style="margin-bottom: 1rem;">ü™ô Credit Packages</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Buy credits to spend on extras and services</p>
                    <div id="my-billing-credits" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                        <p style="color: var(--text-secondary);">Loading credit packages...</p>
                    </div>
                </div>

                <!-- Extras Shop -->
                <div class="card">
                    <h3 class="card-title" style="margin-bottom: 1rem;">üõí Extras & Services</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Services you can purchase with credits</p>
                    <div id="my-billing-extras" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <p style="color: var(--text-secondary);">Loading extras...</p>
                    </div>
                </div>
            </div>

            <!-- GasSync Dashboard View -->
            <div id="gas-sync-dashboard" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üîÑ Channel Manager Sync Dashboard</h2>
                            <p>Overview of all channel manager integrations and sync status</p>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid" id="gasSyncStats">
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon">üîó</span></div>
                        <div class="stat-value" id="syncStatConnections">-</div>
                        <div class="stat-label">Active Connections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon">üè†</span></div>
                        <div class="stat-value" id="syncStatProperties">-</div>
                        <div class="stat-label">Synced Properties</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon">üõèÔ∏è</span></div>
                        <div class="stat-value" id="syncStatRoomTypes">-</div>
                        <div class="stat-label">Room Types</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon">üìÖ</span></div>
                        <div class="stat-value" id="syncStatReservations">-</div>
                        <div class="stat-label">Active Reservations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon">üì∑</span></div>
                        <div class="stat-value" id="syncStatImages">-</div>
                        <div class="stat-label">Images Synced</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header"><span class="stat-icon">‚ö†Ô∏è</span></div>
                        <div class="stat-value" id="syncStatErrors">-</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">üì° Connection Status</h3>
                    <div id="connectionStatusList">
                        <p style="color: var(--text-secondary);">Loading connections...</p>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">üìã Recent Sync Activity</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Adapter</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Records</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                                <tr><td colspan="6" style="text-align:center; color: var(--text-secondary);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- GasSync Connections View -->
            <div id="gas-sync-connections" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üîó Channel Manager Connections</h2>
                            <p>Manage your channel manager integrations</p>
                        </div>
                        <div class="header-actions master-only" style="display: none;">
                            <button class="btn btn-primary" onclick="showAddConnectionModal()">
                                <span>‚ûï</span> Add Connection
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="connectionsGrid" class="connections-grid">
                    <p style="color: var(--text-secondary);">Loading connections...</p>
                </div>
            </div>

            <!-- Simple Client Connection View -->
            <div id="client-connection-view" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üîó Connection Status</h2>
                            <p>Your channel manager connection</p>
                        </div>
                    </div>
                </div>
                
                <div id="clientConnectionInfo" class="card">
                    <p style="color: var(--text-secondary);">Loading...</p>
                </div>
            </div>

            <!-- GasSync Properties View -->
            <div id="gas-sync-properties" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üè† Synced Properties</h2>
                            <p>Properties synchronized from channel managers</p>
                        </div>
                        <div class="header-actions">
                            <select id="syncPropertiesConnectionFilter" class="form-control" style="width: 200px;" onchange="loadSyncedProperties()">
                                <option value="">All Connections</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Property</th>
                                    <th>Location</th>
                                    <th>Room Types</th>
                                    <th>Images</th>
                                    <th>Linked</th>
                                    <th>Last Sync</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="syncedPropertiesTable">
                                <tr><td colspan="7" style="text-align:center; color: var(--text-secondary);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- GasSync Logs View -->
            <div id="gas-sync-logs" class="view">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h2>üìã Sync Logs</h2>
                            <p>History of synchronization operations</p>
                        </div>
                        <div class="header-actions">
                            <select id="syncLogsConnectionFilter" class="form-control" style="width: 200px;" onchange="loadSyncLogs()">
                                <option value="">All Connections</option>
                            </select>
                            <select id="syncLogsStatusFilter" class="form-control" style="width: 150px;" onchange="loadSyncLogs()">
                                <option value="">All Status</option>
                                <option value="success">Success</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Connection</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Updated</th>
                                    <th>Failed</th>
                                    <th>Duration</th>
                                    <th>Error</th>
                                </tr>
                            </thead>
                            <tbody id="syncLogsTable">
                                <tr><td colspan="9" style="text-align:center; color: var(--text-secondary);">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- GasSync Add Connection Modal -->
    <div id="addConnectionModal" class="modal" onclick="if(event.target === this) closeModal('addConnectionModal')">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">‚ûï Add Channel Manager Connection</h3>
                <button onclick="closeModal('addConnectionModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; cursor: pointer; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; line-height: 1;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <!-- Step 1: Select Adapter -->
                <div id="connectionStep1">
                    <h4 style="margin-bottom: 15px;">Select Channel Manager</h4>
                    <div id="adapterGrid" class="adapter-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Step 2: Enter Credentials -->
                <div id="connectionStep2" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-secondary btn-sm" onclick="showConnectionStep(1)">‚Üê Back</button>
                        <h4 id="selectedAdapterName" style="margin: 0;">Configure Connection</h4>
                    </div>
                    
                    <form id="connectionCredentialsForm">
                        <input type="hidden" id="selectedAdapterCode">
                        
                        <div id="credentialFields"></div>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Account</label>
                            <select id="connectionAccountId" class="form-control" required></select>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="connectionSyncEnabled" checked>
                                Enable automatic sync
                            </label>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Sync Interval</label>
                            <select id="connectionSyncInterval" class="form-control">
                                <option value="5">Every 5 minutes</option>
                                <option value="15" selected>Every 15 minutes</option>
                                <option value="30">Every 30 minutes</option>
                                <option value="60">Every hour</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('addConnectionModal')">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="testAndSaveConnection()">
                                üîå Test & Connect
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- GasSync Connection Details Modal -->
    <div id="connectionDetailsModal" class="modal" onclick="if(event.target === this) closeModal('connectionDetailsModal')">
        <div class="modal-content" style="max-width: 800px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <h3 id="connectionDetailsTitle" style="margin: 0;">Connection Details</h3>
                <button onclick="closeModal('connectionDetailsModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 1.5rem; cursor: pointer; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; line-height: 1;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="gas-sync-tabs">
                    <button class="gas-sync-tab active" onclick="showConnectionTab('overview')">Overview</button>
                    <button class="gas-sync-tab" onclick="showConnectionTab('properties')">Properties</button>
                    <button class="gas-sync-tab" onclick="showConnectionTab('reservations')">Reservations</button>
                    <button class="gas-sync-tab" onclick="showConnectionTab('logs')">Logs</button>
                    <button class="gas-sync-tab" onclick="showConnectionTab('settings')">Settings</button>
                </div>
                
                <div style="padding: 1.5rem;">
                    <div id="connectionTabOverview" class="gas-sync-tab-content">Loading...</div>
                    <div id="connectionTabProperties" class="gas-sync-tab-content" style="display:none;">Loading...</div>
                    <div id="connectionTabReservations" class="gas-sync-tab-content" style="display:none;">Loading...</div>
                    <div id="connectionTabLogs" class="gas-sync-tab-content" style="display:none;">Loading...</div>
                    <div id="connectionTabSettings" class="gas-sync-tab-content" style="display:none;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Knowledge Base Article Modal -->
    <div id="kbArticleModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="kb-article-modal-title" style="margin: 0; font-size: 1.25rem;">üìö Add Knowledge Article</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Add content the AI can use to answer questions</p>
                </div>
                <button class="modal-close" onclick="closeModal('kbArticleModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="kb-article-form" onsubmit="saveKBArticle(event)">
                    <input type="hidden" id="kb-article-id">
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Title <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="kb-article-title" class="form-input" required placeholder="e.g., How to connect Beds24">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="kb-article-category" class="form-input">
                                <option value="">Select category...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Summary</label>
                        <textarea id="kb-article-summary" class="form-input" rows="2" placeholder="Brief summary shown in search results..."></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Content <span style="color: #ef4444;">*</span></label>
                        <textarea id="kb-article-content" class="form-input" rows="12" required placeholder="Full article content. The AI will use this to answer questions. Use markdown formatting."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Keywords (comma-separated)</label>
                            <input type="text" id="kb-article-keywords" class="form-input" placeholder="beds24, api, connect, invite code">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="kb-article-status" class="form-input">
                                <option value="published">Published</option>
                                <option value="draft">Draft</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('kbArticleModal')">Cancel</button>
                        <button type="submit" class="btn">Save Article</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Knowledge Base Import Modal -->
    <div id="kbImportModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">üì• Import Articles</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Bulk import articles from JSON</p>
                </div>
                <button class="modal-close" onclick="closeModal('kbImportModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #166534;">JSON Format</h4>
                    <pre style="margin: 0; font-size: 0.8rem; color: #166534; overflow-x: auto;">[
  {
    "title": "Article Title",
    "category": "getting-started",
    "summary": "Brief summary",
    "content": "Full content here...",
    "keywords": ["keyword1", "keyword2"]
  }
]</pre>
                </div>
                
                <div class="form-group">
                    <label>Paste JSON Array</label>
                    <textarea id="kb-import-json" class="form-input" rows="10" placeholder="Paste your JSON array of articles here..."></textarea>
                </div>
                
                <div id="kb-import-result" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 8px;"></div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('kbImportModal')">Cancel</button>
                    <button type="button" class="btn" onclick="importKBArticles()">Import Articles</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Billing Plan Modal -->
    <div id="billingPlanModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="plan-modal-title" style="margin: 0; font-size: 1.25rem;">üí≥ Add Subscription Plan</h3>
                </div>
                <button class="modal-close" onclick="closeModal('billingPlanModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="plan-form" onsubmit="savePlan(event)">
                    <input type="hidden" id="plan-id">
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Plan Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="plan-name" class="form-input" required placeholder="e.g., Professional">
                        </div>
                        <div class="form-group">
                            <label>Slug</label>
                            <input type="text" id="plan-slug" class="form-input" placeholder="professional">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <input type="text" id="plan-description" class="form-input" placeholder="For growing businesses">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Monthly Price <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="plan-price-monthly" class="form-input" required step="0.01" placeholder="59.00">
                        </div>
                        <div class="form-group">
                            <label>Yearly Price</label>
                            <input type="number" id="plan-price-yearly" class="form-input" step="0.01" placeholder="590.00">
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <select id="plan-currency" class="form-input">
                                <option value="GBP">¬£ GBP</option>
                                <option value="EUR">‚Ç¨ EUR</option>
                                <option value="USD">$ USD</option>
                                <option value="CHF">CHF</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Max Properties</label>
                            <input type="number" id="plan-max-properties" class="form-input" placeholder="Leave empty for unlimited">
                        </div>
                        <div class="form-group">
                            <label>Sort Order</label>
                            <input type="number" id="plan-sort-order" class="form-input" value="0">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Features (one per line)</label>
                        <textarea id="plan-features" class="form-input" rows="4" placeholder="Up to 5 properties&#10;All features&#10;Priority support"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="plan-is-active" checked>
                            Active (visible to customers)
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('billingPlanModal')">Cancel</button>
                        <button type="submit" class="btn">Save Plan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assign Plan Modal -->
    <div id="assignPlanModal" class="modal">
        <div class="modal-content" style="max-width: 450px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">üí≥ Assign Subscription Plan</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;">For: <span id="assign-plan-account-name"></span></p>
                </div>
                <button class="modal-close" onclick="closeModal('assignPlanModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="assign-plan-current" style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; display: none;">
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Select Plan</label>
                    <select id="assign-plan-select" class="form-input">
                        <option value="">-- Select Plan --</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Billing Cycle</label>
                    <select id="assign-plan-cycle" class="form-input">
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly (save ~17%)</option>
                    </select>
                </div>
                
                <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div style="font-weight: 600; font-size: 0.9rem; margin-bottom: 0.75rem; color: var(--text-primary);">‚ö° Feature Overrides</div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem;">Enable features not included in the plan</p>
                    
                    <div style="display: grid; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="assign-plan-api-access" style="width: 18px; height: 18px;">
                            <span>üîå API Access</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="assign-plan-blog-module" style="width: 18px; height: 18px;">
                            <span>üìù Blog Module</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="assign-plan-attractions-module" style="width: 18px; height: 18px;">
                            <span>üéØ Attractions Module</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            <input type="checkbox" id="assign-plan-reviews-widget" style="width: 18px; height: 18px;">
                            <span>‚≠ê Reviews Widget</span>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" style="color: var(--error);" onclick="cancelAccountSubscription()">Cancel Subscription</button>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('assignPlanModal')">Close</button>
                        <button type="button" class="btn" onclick="saveAssignedPlan()">Assign Plan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Website Modal -->
    <div id="createWebsiteModal" class="modal">
        <div class="modal-content" style="max-width: 500px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">üöÄ Create WordPress Website</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;">For: <span id="create-website-account-name"></span></p>
                </div>
                <button class="modal-close" onclick="closeModal('createWebsiteModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0; font-size: 0.9rem;">‚ú® A new WordPress site will be created with:</p>
                    <ul style="margin: 0.5rem 0 0 1.25rem; font-size: 0.85rem; color: var(--text-secondary);">
                        <li>GAS Booking Plugin pre-installed</li>
                        <li>Theme configured for your property</li>
                        <li>API connection set up automatically</li>
                    </ul>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Site Name</label>
                    <input type="text" id="create-website-name" class="form-input" placeholder="e.g., lehmannhouse">
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        Will be: <strong><span id="create-website-preview">yoursite</span>.vps.site</strong>
                    </p>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Template (Optional)</label>
                    <select id="create-website-template" class="form-input">
                        <option value="">Use default for plan</option>
                        <option value="gas-starter">GAS Starter</option>
                        <option value="gas-professional">GAS Professional</option>
                        <option value="gas-business">GAS Business</option>
                        <option value="gas-enterprise">GAS Enterprise</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createWebsiteModal')">Cancel</button>
                    <button type="button" class="btn" onclick="createWebsite()" id="create-website-btn">
                        üöÄ Create Website
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Package Modal -->
    <div id="creditPackageModal" class="modal">
        <div class="modal-content" style="max-width: 500px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="credit-package-modal-title" style="margin: 0; font-size: 1.25rem;">ü™ô Add Credit Package</h3>
                </div>
                <button class="modal-close" onclick="closeModal('creditPackageModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="credit-package-form" onsubmit="saveCreditPackage(event)">
                    <input type="hidden" id="credit-package-id">
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Package Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="credit-package-name" class="form-input" required placeholder="e.g., 50 Credits">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Credits <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="credit-package-credits" class="form-input" required placeholder="50">
                        </div>
                        <div class="form-group">
                            <label>Bonus Credits</label>
                            <input type="number" id="credit-package-bonus" class="form-input" value="0" placeholder="0">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Price <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="credit-package-price" class="form-input" required step="0.01" placeholder="40.00">
                        </div>
                        <div class="form-group">
                            <label>Currency</label>
                            <select id="credit-package-currency" class="form-input">
                                <option value="GBP">¬£ GBP</option>
                                <option value="EUR">‚Ç¨ EUR</option>
                                <option value="USD">$ USD</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="credit-package-is-active" checked>
                            Active (available for purchase)
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('creditPackageModal')">Cancel</button>
                        <button type="submit" class="btn">Save Package</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Extras Modal -->
    <div id="extraModal" class="modal">
        <div class="modal-content" style="max-width: 550px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="extra-modal-title" style="margin: 0; font-size: 1.25rem;">üõí Add Extra Service</h3>
                </div>
                <button class="modal-close" onclick="closeModal('extraModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="extra-form" onsubmit="saveExtra(event)">
                    <input type="hidden" id="extra-id">
                    
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="extra-name" class="form-input" required placeholder="e.g., Setup Assistance Call">
                        </div>
                        <div class="form-group">
                            <label>Icon</label>
                            <input type="text" id="extra-icon" class="form-input" placeholder="üìû">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <textarea id="extra-description" class="form-input" rows="2" placeholder="What does the customer get?"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Credit Cost <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="extra-credit-cost" class="form-input" required placeholder="5">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" id="extra-category" class="form-input" placeholder="Support">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="extra-is-active" checked>
                            Active (available in shop)
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('extraModal')">Cancel</button>
                        <button type="submit" class="btn">Save Extra</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="product-modal-title" style="margin: 0; font-size: 1.25rem;">üì¶ Add Product</h3>
                </div>
                <button class="modal-close" onclick="closeModal('productModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="product-form" onsubmit="saveProduct(event)">
                    <input type="hidden" id="product-id">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Product Code <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="product-code" class="form-input" required placeholder="e.g., wp-theme-developer">
                            <small style="color: var(--text-secondary);">Unique identifier (lowercase, hyphens)</small>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="product-category" class="form-input">
                                <option value="template">Template</option>
                                <option value="plugin">Plugin</option>
                                <option value="app">App</option>
                                <option value="service">Service</option>
                                <option value="addon">Add-on</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Product Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="product-name" class="form-input" required placeholder="e.g., Developer Theme">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <textarea id="product-description" class="form-input" rows="2" placeholder="Professional WordPress theme for hotels & B&Bs"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Monthly Price (¬£)</label>
                            <input type="number" id="product-price-monthly" class="form-input" step="0.01" placeholder="15.00">
                        </div>
                        <div class="form-group">
                            <label>Yearly Price (¬£)</label>
                            <input type="number" id="product-price-yearly" class="form-input" step="0.01" placeholder="150.00">
                            <small style="color: var(--text-secondary);">Usually 10 months (2 months free)</small>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="product-is-active" checked style="width: 18px; height: 18px;">
                            <span>Active (visible to customers)</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('productModal')">Cancel</button>
                        <button type="submit" class="btn">Save Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add-on Modal -->
    <div id="addonModal" class="modal">
        <div class="modal-content" style="max-width: 550px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="addon-modal-title" style="margin: 0; font-size: 1.25rem;">üß© Add Add-on</h3>
                </div>
                <button class="modal-close" onclick="closeModal('addonModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="addon-form" onsubmit="saveAddon(event)">
                    <input type="hidden" id="addon-id">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Add-on Code <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="addon-code" class="form-input" required placeholder="e.g., extra-property">
                        </div>
                        <div class="form-group">
                            <label>Monthly Price (¬£) <span style="color: #ef4444;">*</span></label>
                            <input type="number" id="addon-price-monthly" class="form-input" required step="0.01" placeholder="5.00">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Add-on Name <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="addon-name" class="form-input" required placeholder="e.g., Extra Property">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <input type="text" id="addon-description" class="form-input" placeholder="Add one additional property to your account">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Extra Properties Included</label>
                        <input type="number" id="addon-extra-properties" class="form-input" value="0" min="0" placeholder="0">
                        <small style="color: var(--text-secondary);">How many extra properties this add-on provides</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="addon-is-active" checked style="width: 18px; height: 18px;">
                            <span>Active (available for purchase)</span>
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addonModal')">Cancel</button>
                        <button type="submit" class="btn">Save Add-on</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="task-modal-title" style="margin: 0; font-size: 1.25rem;">üìã Add Task</h3>
                </div>
                <button class="modal-close" onclick="closeModal('taskModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="task-form" onsubmit="saveTask(event)">
                    <input type="hidden" id="task-id">
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Task Title <span style="color: #ef4444;">*</span></label>
                        <input type="text" id="task-title" class="form-input" required placeholder="What needs to be done?">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Description</label>
                        <textarea id="task-description" class="form-input" rows="3" placeholder="Details about the task..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label>Priority <span style="color: #ef4444;">*</span></label>
                            <select id="task-priority" class="form-input" required>
                                <option value="critical">üî• Critical</option>
                                <option value="urgent">‚ö° Urgent</option>
                                <option value="high" selected>üî∑ High</option>
                                <option value="medium">üìå Medium</option>
                                <option value="low">üìù Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category <span style="color: #ef4444;">*</span></label>
                            <select id="task-category" class="form-input" required>
                                <option value="critical">üî• Critical - Must Work</option>
                                <option value="billing">üí≥ Billing & Payments</option>
                                <option value="booking-flow">üìÖ Booking Flow</option>
                                <option value="ui">üé® UI/UX</option>
                                <option value="website-builder">üåê Website Builder</option>
                                <option value="apps">üì± Apps</option>
                                <option value="integrations">üîó Integrations</option>
                                <option value="wordpress">üîå WordPress</option>
                                <option value="bugs">üêõ Bug Fixes</option>
                                <option value="ideas">üí° Ideas</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Status</label>
                        <select id="task-status" class="form-input">
                            <option value="todo">üìã To Do</option>
                            <option value="in_progress">üîÑ In Progress</option>
                            <option value="done">‚úÖ Done</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label>Notes (optional)</label>
                        <input type="text" id="task-notes" class="form-input" placeholder="Any additional notes...">
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn" id="task-delete-btn" style="background: #ef4444; display: none;" onclick="deleteTaskFromModal()">üóëÔ∏è Delete</button>
                        <div style="display: flex; gap: 1rem; margin-left: auto;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
                            <button type="submit" class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">Save Task</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deploy Site Modal -->
    <div id="deployModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="deploy-modal-title" style="margin: 0; font-size: 1.25rem;">üöÄ Create New Website</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Select which rooms to display on this site</p>
                </div>
                <button class="modal-close" onclick="closeModal('deployModal')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">&times;</button>
            </div>
            <form id="deployForm" onsubmit="deployNewSite(event)" style="padding: 1.5rem;">
                
                <!-- Site Details -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label>Site Name *</label>
                        <input type="text" id="deploy-site-name" class="form-input" placeholder="e.g. Elevate Stays" required>
                    </div>
                    <div class="form-group">
                        <label>URL Slug *</label>
                        <div style="display: flex; align-items: center; gap: 0;">
                            <span style="background: #f1f5f9; padding: 0.5rem 0.5rem; border: 1px solid var(--border); border-right: none; border-radius: 8px 0 0 8px; color: var(--text-secondary); font-size: 0.8rem; white-space: nowrap;">sites.gas.travel/</span>
                            <input type="text" id="deploy-slug" class="form-input" style="border-radius: 0 8px 8px 0; flex: 1;" placeholder="elevate" required pattern="[a-z0-9-]+">
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label>Admin Email *</label>
                    <input type="email" id="deploy-admin-email" class="form-input" placeholder="admin@example.com" required>
                </div>
                
                <!-- Template Selection -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">üé® Select Template *</label>
                    <div id="deploy-template-container" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <!-- Light Template -->
                        <label class="template-option" style="cursor: pointer; border: 2px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s;">
                            <input type="radio" name="deploy-template" value="developer-light" checked style="display: none;">
                            <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); padding: 2rem; text-align: center; border-bottom: 1px solid var(--border);">
                                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚òÄÔ∏è</div>
                                <div style="width: 60px; height: 40px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 4px; margin: 0 auto;"></div>
                            </div>
                            <div style="padding: 1rem; background: white;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">Developer Light</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Clean, bright white backgrounds</div>
                            </div>
                        </label>
                        
                        <!-- Dark Template -->
                        <label class="template-option" style="cursor: pointer; border: 2px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.2s;">
                            <input type="radio" name="deploy-template" value="developer-dark" style="display: none;">
                            <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 2rem; text-align: center; border-bottom: 1px solid #334155;">
                                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üåô</div>
                                <div style="width: 60px; height: 40px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; margin: 0 auto;"></div>
                            </div>
                            <div style="padding: 1rem; background: white;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">Developer Dark</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Elegant dark grey/black theme</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Room Selection -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <span style="font-weight: 600;">üì¶ Select Rooms to Display *</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-small" onclick="selectAllDeployRooms()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Select All</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="deselectAllDeployRooms()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Deselect All</button>
                        </div>
                    </label>
                    <div id="deploy-rooms-container" style="max-height: 350px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            Loading rooms...
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <small style="color: var(--text-secondary);">Select the rooms/units you want on this website</small>
                        <small id="deploy-room-count" style="color: var(--primary); font-weight: 500;">0 rooms selected</small>
                    </div>
                </div>
                
                <!-- Template Options -->
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">üé® Template Options</label>
                    <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; margin-bottom: 0.75rem;">
                            <input type="checkbox" id="deploy-use-theme" checked style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 500;">Install GAS Theme</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Professional booking-ready theme</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                            <input type="checkbox" id="deploy-use-plugin" checked style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 500;">Install GAS Booking Plugin</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Calendar, availability & booking system</div>
                            </div>
                        </label>
                    </div>
                    <small style="color: var(--text-secondary); margin-top: 0.5rem; display: block;">Uncheck to use your own theme/plugin instead</small>
                </div>
                
                <div id="deploy-summary" style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #166534;">‚ú® What will be created:</h4>
                    <ul style="margin: 0; padding-left: 1.25rem; color: #166534; font-size: 0.9rem;">
                        <li>Clean WordPress site</li>
                        <li>GAS theme & plugin (if selected)</li>
                        <li>Only selected rooms will display</li>
                        <li>Connected to GAS booking system</li>
                    </ul>
                </div>
                
                <div id="deploy-progress" style="display: none; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; text-align: center;">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚è≥</div>
                    <div id="deploy-progress-text">Creating your site...</div>
                </div>
                
                <div id="deploy-result" style="display: none; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #166534;">üéâ Site Created!</h4>
                    <div id="deploy-result-content"></div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('deployModal')">Cancel</button>
                    <button type="submit" class="btn" id="deploy-submit-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üöÄ Deploy Site</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Agency Modal -->
    <div id="agencyModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="agency-modal-title" style="margin: 0; font-size: 1.25rem;">üè¢ Add New Agency</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Create an agency partner account</p>
                </div>
                <button class="modal-close" onclick="closeModal('agencyModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="agency-form" onsubmit="saveAgency(event)">
                    <input type="hidden" id="agency-id">
                    <input type="hidden" id="agency-public-id">
                    
                    <!-- API Key Section (only shown when editing) -->
                    <div id="agency-api-key-section" style="display: none; margin-bottom: 1.5rem; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border-radius: 12px; padding: 1rem; color: white;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">üîë Agency API Key</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="agency-api-key-display" readonly style="flex: 1; padding: 0.6rem; border-radius: 6px; border: none; font-size: 0.8rem; background: rgba(255,255,255,0.95); color: #1e293b; font-family: monospace;">
                            <button type="button" onclick="copyAgencyApiKey()" style="padding: 0.6rem 1rem; background: white; color: #4f46e5; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">üìã Copy</button>
                        </div>
                    </div>
                    
                    <!-- Basic Info -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Basic Information</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Agency Name <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="agency-name" class="form-input" required placeholder="e.g., Elevate Schweiz GmbH">
                            </div>
                            <div class="form-group">
                                <label>Email <span style="color: #ef4444;">*</span></label>
                                <input type="email" id="agency-email" class="form-input" required placeholder="contact@agency.com">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="agency-phone" class="form-input" placeholder="+41 58 590 99 91">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Website</label>
                                <input type="url" id="agency-website" class="form-input" placeholder="https://www.agency.com">
                            </div>
                        </div>
                    </div>

                    <!-- Address -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Address</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Address Line 1</label>
                                <input type="text" id="agency-address1" class="form-input" placeholder="Street address">
                            </div>
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="agency-city" class="form-input" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <select id="agency-country" class="form-input">
                                    <option value="GB">üá¨üáß United Kingdom</option>
                                    <option value="US">üá∫üá∏ United States</option>
                                    <option value="CH" selected>üá®üá≠ Switzerland</option>
                                    <option value="DE">üá©üá™ Germany</option>
                                    <option value="FR">üá´üá∑ France</option>
                                    <option value="IT">üáÆüáπ Italy</option>
                                    <option value="ES">üá™üá∏ Spain</option>
                                    <option value="NL">üá≥üá± Netherlands</option>
                                    <option value="AT">üá¶üáπ Austria</option>
                                    <option value="PT">üáµüáπ Portugal</option>
                                    <option value="BE">üáßüá™ Belgium</option>
                                    <option value="IE">üáÆüá™ Ireland</option>
                                    <option value="AU">üá¶üá∫ Australia</option>
                                    <option value="NZ">üá≥üáø New Zealand</option>
                                    <option value="CA">üá®üá¶ Canada</option>
                                    <option value="AE">üá¶üá™ UAE</option>
                                    <option value="JP">üáØüáµ Japan</option>
                                    <option value="TH">üáπüá≠ Thailand</option>
                                    <option value="GR">üá¨üá∑ Greece</option>
                                    <option value="HR">üá≠üá∑ Croatia</option>
                                    <option value="CZ">üá®üáø Czech Republic</option>
                                    <option value="PL">üáµüá± Poland</option>
                                    <option value="HU">üá≠üá∫ Hungary</option>
                                    <option value="SE">üá∏üá™ Sweden</option>
                                    <option value="NO">üá≥üá¥ Norway</option>
                                    <option value="DK">üá©üá∞ Denmark</option>
                                    <option value="FI">üá´üáÆ Finland</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Branding (for future white-label) -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Branding</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Primary Color</label>
                                <input type="color" id="agency-primary-color" class="form-input" value="#6366f1" style="height: 45px;">
                            </div>
                            <div class="form-group">
                                <label>Secondary Color</label>
                                <input type="color" id="agency-secondary-color" class="form-input" value="#8b5cf6" style="height: 45px;">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Logo URL</label>
                                <input type="url" id="agency-logo" class="form-input" placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Settings</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="agency-currency" class="form-input">
                                    <option value="CHF">üá®üá≠ CHF</option>
                                    <option value="EUR">‚Ç¨ EUR</option>
                                    <option value="GBP">¬£ GBP</option>
                                    <option value="USD">$ USD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Plan</label>
                                <select id="agency-plan" class="form-input">
                                    <option value="agency">Agency</option>
                                    <option value="enterprise">Enterprise</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="agency-status" class="form-input">
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group">
                        <label>Internal Notes</label>
                        <textarea id="agency-notes" class="form-input" rows="2" placeholder="Any internal notes about this agency..."></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('agencyModal')">Cancel</button>
                        <button type="submit" class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">Save Agency</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Agency Detail Modal -->
    <div id="agencyDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="agency-detail-title" style="margin: 0; font-size: 1.25rem;">Agency Details</h3>
                    <p id="agency-detail-subtitle" style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;"></p>
                </div>
                <button class="modal-close" onclick="closeModal('agencyDetailModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="agency-detail-content">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="client-modal-title" style="margin: 0; font-size: 1.25rem;">üë• Add New Client</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Create a new client account</p>
                </div>
                <button class="modal-close" onclick="closeModal('clientModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="client-form" onsubmit="saveClient(event)">
                    <input type="hidden" id="client-id">
                    <input type="hidden" id="client-public-id">
                    
                    <!-- Setup Link Section (only shown when editing) -->
                    <div id="client-setup-link-section" style="display: none; margin-bottom: 1.5rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; padding: 1rem; color: white;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">üîó Client Setup Link</h4>
                        <p style="font-size: 0.8rem; margin: 0 0 0.75rem 0; opacity: 0.9;">Send this link to your client so they can connect their channel manager:</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="client-setup-link-display" readonly style="flex: 1; padding: 0.6rem; border-radius: 6px; border: none; font-size: 0.85rem; background: rgba(255,255,255,0.95); color: #1e293b;">
                            <button type="button" onclick="copyClientSetupLink()" style="padding: 0.6rem 1rem; background: white; color: #059669; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">üìã Copy</button>
                        </div>
                        <p style="font-size: 0.75rem; margin: 0.5rem 0 0 0; opacity: 0.8;">UUID: <span id="client-uuid-display"></span></p>
                    </div>
                    
                    <!-- Basic Info -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Basic Information</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Company / Client Name <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="client-name" class="form-input" required placeholder="e.g., Lehmann House Ltd">
                            </div>
                            <div class="form-group">
                                <label>Email <span style="color: #ef4444;">*</span></label>
                                <input type="email" id="client-email" class="form-input" required placeholder="info@example.com">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="client-phone" class="form-input" placeholder="+44 1234 567890">
                            </div>
                        </div>
                    </div>

                    <!-- Address -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Address</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Address Line 1</label>
                                <input type="text" id="client-address1" class="form-input" placeholder="Street address">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Address Line 2</label>
                                <input type="text" id="client-address2" class="form-input" placeholder="Apartment, suite, etc.">
                            </div>
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="client-city" class="form-input" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label>Region / County</label>
                                <input type="text" id="client-region" class="form-input" placeholder="Region">
                            </div>
                            <div class="form-group">
                                <label>Postcode</label>
                                <input type="text" id="client-postcode" class="form-input" placeholder="Postcode">
                            </div>
                            <div class="form-group">
                                <label>Country</label>
                                <select id="client-country" class="form-input">
                                    <option value="GB" selected>üá¨üáß United Kingdom</option>
                                    <option value="US">üá∫üá∏ United States</option>
                                    <option value="CH">üá®üá≠ Switzerland</option>
                                    <option value="DE">üá©üá™ Germany</option>
                                    <option value="FR">üá´üá∑ France</option>
                                    <option value="IT">üáÆüáπ Italy</option>
                                    <option value="ES">üá™üá∏ Spain</option>
                                    <option value="NL">üá≥üá± Netherlands</option>
                                    <option value="AT">üá¶üáπ Austria</option>
                                    <option value="PT">üáµüáπ Portugal</option>
                                    <option value="BE">üáßüá™ Belgium</option>
                                    <option value="IE">üáÆüá™ Ireland</option>
                                    <option value="AU">üá¶üá∫ Australia</option>
                                    <option value="NZ">üá≥üáø New Zealand</option>
                                    <option value="CA">üá®üá¶ Canada</option>
                                    <option value="AE">üá¶üá™ UAE</option>
                                    <option value="JP">üáØüáµ Japan</option>
                                    <option value="TH">üáπüá≠ Thailand</option>
                                    <option value="GR">üá¨üá∑ Greece</option>
                                    <option value="HR">üá≠üá∑ Croatia</option>
                                    <option value="CZ">üá®üáø Czech Republic</option>
                                    <option value="PL">üáµüá± Poland</option>
                                    <option value="HU">üá≠üá∫ Hungary</option>
                                    <option value="SE">üá∏üá™ Sweden</option>
                                    <option value="NO">üá≥üá¥ Norway</option>
                                    <option value="DK">üá©üá∞ Denmark</option>
                                    <option value="FI">üá´üáÆ Finland</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Settings -->
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">Settings</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="client-currency" class="form-input">
                                    <option value="GBP">¬£ GBP</option>
                                    <option value="EUR">‚Ç¨ EUR</option>
                                    <option value="USD">$ USD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Plan</label>
                                <select id="client-plan" class="form-input">
                                    <option value="free">Free</option>
                                    <option value="starter">Starter</option>
                                    <option value="professional">Professional</option>
                                    <option value="agency">Agency</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="client-status" class="form-input">
                                    <option value="active">Active</option>
                                    <option value="trial">Trial</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label>Internal Notes</label>
                        <textarea id="client-notes" class="form-input" rows="2" placeholder="Any internal notes about this client..."></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('clientModal')">Cancel</button>
                        <button type="submit" class="btn">Save Client</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Client Detail Modal -->
    <div id="clientDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="client-detail-title" style="margin: 0; font-size: 1.25rem;">Client Details</h3>
                    <p id="client-detail-subtitle" style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;"></p>
                </div>
                <button class="modal-close" onclick="closeModal('clientDetailModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;" id="client-detail-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;">Loading client details...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Booking Modal -->
    <div id="edit-booking-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Edit Booking <span id="edit-booking-ref" style="color: var(--primary); font-weight: 600;"></span></h3>
                <button class="modal-close" onclick="closeEditBookingModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-booking-id">
                <input type="hidden" id="edit-booking-beds24-id">
                
                <!-- Guest Details -->
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-secondary);">Guest Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-input" id="edit-booking-first-name" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-input" id="edit-booking-last-name" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="edit-booking-email" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="edit-booking-phone">
                        </div>
                    </div>
                </div>
                
                <!-- Stay Details -->
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-secondary);">Stay Details</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Check-in *</label>
                            <input type="date" class="form-input" id="edit-booking-checkin" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Check-out *</label>
                            <input type="date" class="form-input" id="edit-booking-checkout" required>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Adults</label>
                            <input type="number" class="form-input" id="edit-booking-adults" min="1" value="1">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Children</label>
                            <input type="number" class="form-input" id="edit-booking-children" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- Pricing -->
                <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-secondary);">Pricing & Payment</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Total Price</label>
                            <input type="number" class="form-input" id="edit-booking-total" step="0.01" min="0">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Deposit Paid</label>
                            <input type="number" class="form-input" id="edit-booking-deposit" step="0.01" min="0">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label">Balance Due</label>
                            <input type="number" class="form-input" id="edit-booking-balance" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                
                <!-- Status -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Booking Status</label>
                        <select class="form-input" id="edit-booking-status">
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="completed">Completed</option>
                            <option value="no_show">No Show</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Payment Status</label>
                        <select class="form-input" id="edit-booking-payment-status">
                            <option value="pending">Pending</option>
                            <option value="deposit_paid">Deposit Paid</option>
                            <option value="paid">Fully Paid</option>
                            <option value="refunded">Refunded</option>
                        </select>
                    </div>
                </div>
                
                <!-- Notes -->
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="edit-booking-notes" rows="2" placeholder="Internal notes..."></textarea>
                </div>
                
                <!-- Sync info -->
                <div id="edit-booking-sync-info" style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; font-size: 0.85rem; color: #92400e; display: none;">
                    ‚ö†Ô∏è This booking is synced with <span id="edit-booking-sync-source"></span>. Changes will be pushed to the channel manager.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditBookingModal()">Cancel</button>
                <button class="btn" onclick="saveBookingEdit()" id="save-booking-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Offer Modal -->
    <div id="addOfferModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="offer-modal-title" style="margin: 0; font-size: 1.25rem;">üè∑Ô∏è Create New Offer</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Set up a discount or price adjustment</p>
                </div>
                <button class="modal-close" onclick="closeModal('addOfferModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="offer-form">
                    <input type="hidden" id="offer-id">
                    
                    <!-- Offer Name -->
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Offer Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="offer-name" class="form-input" placeholder="e.g., Early Bird Discount" required
                            style="padding: 0.75rem; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <!-- Description -->
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Description <span style="color: #9ca3af; font-weight: normal;">(shown to guests)</span>
                        </label>
                        <textarea id="offer-description" class="form-input" rows="2" placeholder="Book 30 days in advance and save!"
                            style="padding: 0.75rem; border-radius: 8px; font-size: 0.95rem; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- Discount Section -->
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                            üí∞ Discount Settings
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="offer-discount-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="fixed_amount">Fixed Amount ($)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Value <span style="color: #ef4444;">*</span></label>
                                <div style="position: relative;">
                                    <span id="discount-prefix" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;"></span>
                                    <input type="number" id="offer-discount-value" class="form-input" placeholder="10" required min="0" step="0.01"
                                        style="padding: 0.6rem; padding-left: 1.5rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600;">
                                    <span id="discount-suffix" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Property/Room Selection -->
                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #475569; margin-bottom: 0.75rem; display: block;">
                            üè† Apply To
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Properties</label>
                                <div id="offer-properties-list" style="border: 1px solid #d1d5db; border-radius: 8px; max-height: 150px; overflow-y: auto; padding: 0.5rem; background: white;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px;" class="offer-prop-option">
                                        <input type="checkbox" name="offer-properties" value="" checked onchange="filterRoomsBySelectedProperties()">
                                        <span style="font-size: 0.9rem;">All Properties</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Rooms</label>
                                <div id="offer-rooms-list" style="border: 1px solid #d1d5db; border-radius: 8px; max-height: 150px; overflow-y: auto; padding: 0.5rem; background: white;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px;" class="offer-room-option">
                                        <input type="checkbox" name="offer-rooms" value="" checked>
                                        <span style="font-size: 0.9rem;">All Rooms</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">üí° Select multiple properties and/or rooms, or leave "All" checked</p>
                    </div>
                    
                    <!-- Advanced Conditions -->
                    <details style="margin-bottom: 1.25rem; background: #fefce8; border: 1px solid #fde68a; border-radius: 12px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #854d0e; padding: 1rem; list-style: none; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="transition: transform 0.2s;">‚ñ∂</span> ‚öôÔ∏è Advanced Conditions
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Nights</label>
                                    <input type="number" id="offer-min-nights" class="form-input" placeholder="1" min="1" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Max Nights</label>
                                    <input type="number" id="offer-max-nights" class="form-input" placeholder="Any" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Days Advance</label>
                                    <input type="number" id="offer-min-advance" class="form-input" placeholder="e.g., 30" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Max Days Advance</label>
                                    <input type="number" id="offer-max-advance" class="form-input" placeholder="e.g., 7" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Valid From</label>
                                    <input type="date" id="offer-valid-from" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Valid Until</label>
                                    <input type="date" id="offer-valid-until" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            
                            <!-- Check-in Day Restrictions -->
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px;">
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    üìÖ Allowed Check-in Days
                                </label>
                                <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-sun" value="0" checked style="width: 14px; height: 14px;"> Sun
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-mon" value="1" checked style="width: 14px; height: 14px;"> Mon
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-tue" value="2" checked style="width: 14px; height: 14px;"> Tue
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-wed" value="3" checked style="width: 14px; height: 14px;"> Wed
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-thu" value="4" checked style="width: 14px; height: 14px;"> Thu
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-fri" value="5" checked style="width: 14px; height: 14px;"> Fri
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkin-sat" value="6" checked style="width: 14px; height: 14px;"> Sat
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Check-out Day Restrictions -->
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px;">
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    üìÖ Allowed Check-out Days
                                </label>
                                <div style="display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-sun" value="0" checked style="width: 14px; height: 14px;"> Sun
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-mon" value="1" checked style="width: 14px; height: 14px;"> Mon
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-tue" value="2" checked style="width: 14px; height: 14px;"> Tue
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-wed" value="3" checked style="width: 14px; height: 14px;"> Wed
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-thu" value="4" checked style="width: 14px; height: 14px;"> Thu
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-fri" value="5" checked style="width: 14px; height: 14px;"> Fri
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.35rem 0.5rem; background: #f3f4f6; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        <input type="checkbox" id="checkout-sat" value="6" checked style="width: 14px; height: 14px;"> Sat
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Priority (higher = applied first)</label>
                                <input type="number" id="offer-priority" class="form-input" placeholder="0" value="0" style="padding: 0.5rem; border-radius: 6px; width: 100px;">
                            </div>
                        </div>
                    </details>
                    
                    <!-- Active Toggle -->
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <label class="toggle-switch" style="position: relative; display: inline-block; width: 48px; height: 26px; cursor: pointer;">
                            <input type="checkbox" id="offer-active" checked style="opacity: 0; width: 0; height: 0;" onchange="updateOfferToggleVisual(this)">
                            <span class="toggle-slider" id="offer-active-slider" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: #22c55e; transition: .3s; border-radius: 26px;">
                                <span class="toggle-dot" id="offer-active-dot" style="position: absolute; height: 20px; width: 20px; left: 25px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%;"></span>
                            </span>
                        </label>
                        <span style="font-weight: 500; color: #374151;">Active</span>
                        <span style="font-size: 0.85rem; color: #6b7280;">‚Äî Offer is live and can be used</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px; display: flex; justify-content: flex-end; gap: 0.75rem;">
                <button class="btn btn-secondary" onclick="closeModal('addOfferModal')" style="padding: 0.6rem 1.25rem; border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveOffer()" style="padding: 0.6rem 1.5rem; border-radius: 8px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                    üíæ Save Offer
                </button>
            </div>
        </div>
    </div>

    <!-- Add Voucher Modal -->
    <div id="addVoucherModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;">üéüÔ∏è Create New Voucher</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Gift cards, promo codes & discounts</p>
                </div>
                <button class="modal-close" onclick="closeModal('addVoucherModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="voucher-form">
                    <input type="hidden" id="voucher-id">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Voucher Code <span style="color: #ef4444;">*</span>
                            </label>
                            <input type="text" id="voucher-code" class="form-input" placeholder="e.g., WINTER20" required 
                                style="text-transform: uppercase; padding: 0.75rem; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Display Name <span style="color: #ef4444;">*</span>
                            </label>
                            <input type="text" id="voucher-name" class="form-input" placeholder="e.g., Winter Sale 20%" required
                                style="padding: 0.75rem; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">Description</label>
                        <textarea id="voucher-description" class="form-input" placeholder="Get 20% off your winter stay" rows="2"
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                            üè† Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                            <select id="voucher-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadVoucherUnits()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <select id="voucher-unit" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">All Units</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Voucher Type & Value -->
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                            üí∞ Voucher Value
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="voucher-discount-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="percentage">Percentage Off (%)</option>
                                    <option value="fixed">Fixed Amount Off (¬£)</option>
                                    <option value="monetary">Gift Card / Credit (¬£)</option>
                                    <option value="free_nights">Free Night(s)</option>
                                    <option value="addon">Free Add-on</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Value <span style="color: #ef4444;">*</span></label>
                                <input type="number" id="voucher-discount-value" class="form-input" placeholder="e.g., 20" required min="0" step="0.01"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Validity Period -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">Valid From</label>
                            <input type="date" id="voucher-valid-from" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">Valid Until</label>
                            <input type="date" id="voucher-valid-until" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <details style="margin-bottom: 1.25rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #475569; padding: 1rem; list-style: none;">
                            ‚öôÔ∏è Usage Limits & Restrictions
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div class="form-group">
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Max Total Uses</label>
                                    <input type="number" id="voucher-max-uses" class="form-input" placeholder="Unlimited" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div class="form-group">
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Nights Required</label>
                                    <input type="number" id="voucher-min-nights" class="form-input" placeholder="1" min="1" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 0.75rem;">
                                <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Booking Total (¬£)</label>
                                <input type="number" id="voucher-min-total" class="form-input" placeholder="No minimum" step="0.01" style="padding: 0.5rem; border-radius: 6px;">
                            </div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #475569; cursor: pointer;">
                                <input type="checkbox" id="voucher-single-use" style="width: 16px; height: 16px;">
                                Single use per guest email
                            </label>
                        </div>
                    </details>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="voucher-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addVoucherModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveVoucher()" style="border-radius: 8px; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                    üíæ Save Voucher
                </button>
            </div>
        </div>
    </div>

    <!-- Add Upsell Modal -->
    <div id="addUpsellModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="upsell-modal-title" style="margin: 0;">üéÅ Add Upsell</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Extra service guests can add to their booking</p>
                </div>
                <button class="modal-close" onclick="closeModal('addUpsellModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="upsell-form">
                    <input type="hidden" id="upsell-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Upsell Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="upsell-name" class="form-input" placeholder="e.g., Champagne on arrival" required
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Description
                        </label>
                        <textarea id="upsell-description" class="form-input" rows="2" placeholder="Bottle of premium champagne waiting in your room"
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                            üè† Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                            <select id="upsell-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadUpsellRooms()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <div id="upsell-rooms-container">
                                <select id="upsell-room" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="">All Units</option>
                                </select>
                            </div>
                            <div id="upsell-rooms-checkboxes" style="display: none; max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.5rem; margin-top: 0.5rem; background: white;">
                                <!-- Unit checkboxes populated by JS -->
                            </div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.85rem; color: #475569; cursor: pointer;">
                                <input type="checkbox" id="upsell-multi-room" onchange="toggleUpsellMultiRoom()">
                                Select multiple units
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Price <span style="color: #ef4444;">*</span>
                            </label>
                            <div>
                                <input type="number" id="upsell-price" class="form-input" placeholder="50.00" required min="0" step="0.01"
                                    style="padding: 0.75rem; border-radius: 8px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Charge Type
                            </label>
                            <select id="upsell-charge-type" class="form-input" style="padding: 0.75rem; border-radius: 8px;">
                                <option value="per_booking">Per Booking (one-time)</option>
                                <option value="per_night">Per Night</option>
                                <option value="per_day">Per Day</option>
                                <option value="per_guest">Per Guest</option>
                                <option value="per_guest_per_night">Per Guest/Night</option>
                                <option value="per_hour">Per Hour</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Max Quantity <span style="color: #9ca3af; font-weight: normal;">(optional)</span>
                        </label>
                        <input type="number" id="upsell-max-qty" class="form-input" placeholder="Unlimited" min="1"
                            style="padding: 0.75rem; border-radius: 8px; width: 120px;">
                    </div>
                    
                    <!-- Internal/External Toggle -->
                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                            ü§ù Provider Type
                        </label>
                        <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; border: 2px solid #e5e7eb; background: white;" id="upsell-internal-label">
                                <input type="radio" name="upsell-provider-type" value="internal" checked onchange="toggleUpsellProviderType()">
                                <span>üè† Internal</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 8px; border: 2px solid #e5e7eb; background: white;" id="upsell-external-label">
                                <input type="radio" name="upsell-provider-type" value="external" onchange="toggleUpsellProviderType()">
                                <span>üöó External Vendor</span>
                            </label>
                        </div>
                        <div id="upsell-vendor-section" style="display: none;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Select Vendor</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="upsell-vendor" class="form-input" style="flex: 1; padding: 0.6rem; border-radius: 8px;">
                                    <option value="">Select a vendor...</option>
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="openAddVendorModal()" style="white-space: nowrap;">+ New Vendor</button>
                            </div>
                            <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                                External vendors will be notified when this upsell is purchased.
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="upsell-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addUpsellModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveUpsell()" style="border-radius: 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    üíæ Save Upsell
                </button>
            </div>
        </div>
    </div>

    <!-- Add Vendor Modal -->
    <div id="addVendorModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="vendor-modal-title" style="margin: 0;">ü§ù Add Vendor</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">External service provider for upsells and vouchers</p>
                </div>
                <button class="modal-close" onclick="closeModal('addVendorModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="vendor-form">
                    <input type="hidden" id="vendor-id">
                    
                    <!-- Basic Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Company Name <span style="color: #ef4444;">*</span>
                            </label>
                            <input type="text" id="vendor-name" class="form-input" placeholder="e.g., ABC Taxis" required
                                style="padding: 0.75rem; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Contact Person
                            </label>
                            <input type="text" id="vendor-contact" class="form-input" placeholder="e.g., John Smith"
                                style="padding: 0.75rem; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Notification Email <span style="color: #ef4444;">*</span>
                            </label>
                            <input type="email" id="vendor-email" class="form-input" placeholder="bookings@abctaxis.com" required
                                style="padding: 0.75rem; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Phone
                            </label>
                            <input type="tel" id="vendor-phone" class="form-input" placeholder="+44 123 456 7890"
                                style="padding: 0.75rem; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Address
                        </label>
                        <textarea id="vendor-address" class="form-input" rows="2" placeholder="Company address"
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Internal Notes <span style="color: #9ca3af; font-weight: normal;">(only visible to you)</span>
                        </label>
                        <textarea id="vendor-notes" class="form-input" rows="2" placeholder="Any notes about this vendor..."
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <!-- Vendor Portal Login -->
                    <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                            üîê Vendor Portal Login
                        </label>
                        <p style="font-size: 0.85rem; color: #15803d; margin-bottom: 0.75rem;">
                            Create login credentials so the vendor can view booking details and confirm services.
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Login Email</label>
                                <input type="email" id="vendor-login-email" class="form-input" placeholder="login@abctaxis.com"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Password</label>
                                <input type="password" id="vendor-password" class="form-input" placeholder="Create password"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Permissions -->
                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                            üëÅÔ∏è Data Visibility - What can this vendor see?
                        </label>
                        <p style="font-size: 0.85rem; color: #a16207; margin-bottom: 0.75rem;">
                            Choose what booking information this vendor can access when they log in.
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-guest-name" checked> Guest Name
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-guest-phone" checked> Guest Phone
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-guest-email"> Guest Email
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-check-in" checked> Check-in Date
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-check-out" checked> Check-out Date
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-property" checked> Property Name
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-room"> Room Name
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-guest-count" checked> Guest Count
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-requests" checked> Special Requests
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-address"> Guest Address
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" id="perm-total"> Booking Total
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <select id="vendor-status" class="form-input" style="width: auto; padding: 0.5rem;">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <span style="font-weight: 500; color: #374151;">Vendor Status</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addVendorModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveVendor()" style="border-radius: 8px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                    üíæ Save Vendor
                </button>
            </div>
        </div>
    </div>

    <!-- Add Fee Modal -->
    <div id="addFeeModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="fee-modal-title" style="margin: 0;">üíµ Add Fee</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Mandatory charge applied to bookings</p>
                </div>
                <button class="modal-close" onclick="closeModal('addFeeModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="fee-form">
                    <input type="hidden" id="fee-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Fee Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="fee-name" class="form-input" placeholder="e.g., Cleaning Fee" required
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Description
                        </label>
                        <textarea id="fee-description" class="form-input" rows="2" placeholder="One-time cleaning fee"
                            style="padding: 0.75rem; border-radius: 8px;"></textarea>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                            üè† Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property</label>
                            <select id="fee-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadFeeUnits()">
                                <option value="">All Properties</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <select id="fee-unit" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">All Units</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Amount Type
                            </label>
                            <select id="fee-amount-type" class="form-input" style="padding: 0.75rem; border-radius: 8px;" onchange="toggleFeeAmountInput()">
                                <option value="fixed">Fixed Amount ($)</option>
                                <option value="percentage">Percentage (%)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                                Amount <span style="color: #ef4444;">*</span>
                            </label>
                            <div style="position: relative;">
                                <span id="fee-amount-prefix" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;">$</span>
                                <input type="number" id="fee-amount" class="form-input" placeholder="100.00" required min="0" step="0.01"
                                    style="padding: 0.75rem; padding-left: 1.75rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Apply Per
                        </label>
                        <select id="fee-apply-per" class="form-input" style="padding: 0.75rem; border-radius: 8px;">
                            <option value="per_booking">Per Booking</option>
                            <option value="per_night">Per Night</option>
                            <option value="per_guest">Per Guest</option>
                            <option value="per_guest_per_night">Per Guest/Night</option>
                        </select>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem; display: block;">
                            Tax Settings
                        </label>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="checkbox" id="fee-is-tax" style="width: 18px; height: 18px;">
                            <span style="color: #78350f;">This is a tax (shown separately on invoice)</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="fee-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addFeeModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveFee()" style="border-radius: 8px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    üíæ Save Fee
                </button>
            </div>
        </div>
    </div>

    <!-- Add Tax Modal -->
    <div id="addTaxModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" id="tax-modal-title" style="margin: 0;">üèõÔ∏è Add Tourist Tax</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Government-mandated tax for your location</p>
                </div>
                <button class="modal-close" onclick="closeModal('addTaxModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="tax-form">
                    <input type="hidden" id="tax-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Tax Name <span style="color: #ef4444;">*</span>
                        </label>
                        <input type="text" id="tax-name" class="form-input" placeholder="e.g., City Tourist Tax, Taxe de S√©jour" required
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Country/Region
                        </label>
                        <select id="tax-country" class="form-input" style="padding: 0.75rem; border-radius: 8px;" onchange="updateTaxPresets()">
                            <option value="">Select country...</option>
                            <option value="FR">üá´üá∑ France</option>
                            <option value="IT">üáÆüáπ Italy</option>
                            <option value="ES">üá™üá∏ Spain</option>
                            <option value="NL">üá≥üá± Netherlands</option>
                            <option value="DE">üá©üá™ Germany</option>
                            <option value="AT">üá¶üáπ Austria</option>
                            <option value="PT">üáµüáπ Portugal</option>
                            <option value="GR">üá¨üá∑ Greece</option>
                            <option value="CH">üá®üá≠ Switzerland</option>
                            <option value="BE">üáßüá™ Belgium</option>
                            <option value="CZ">üá®üáø Czech Republic</option>
                            <option value="HU">üá≠üá∫ Hungary</option>
                            <option value="US">üá∫üá∏ United States</option>
                            <option value="AE">üá¶üá™ UAE (Dubai)</option>
                            <option value="JP">üáØüáµ Japan</option>
                            <option value="TH">üáπüá≠ Thailand</option>
                            <option value="ID">üáÆüá© Indonesia (Bali)</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    
                    <!-- Apply To Section -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                            üè† Apply To
                        </label>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property <span style="color: #ef4444;">*</span></label>
                            <select id="tax-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadTaxUnits()" required>
                                <option value="">Select Property...</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Unit(s)</label>
                            <select id="tax-unit" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                <option value="">All Units</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                            üí∞ Tax Amount
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="tax-amount-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="toggleTaxAmountInput()">
                                    <option value="fixed">Fixed Amount</option>
                                    <option value="percentage">Percentage of Booking</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Amount <span style="color: #ef4444;">*</span></label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select id="tax-currency" class="form-input" style="padding: 0.6rem; border-radius: 8px; width: 80px;">
                                        <option value="EUR">‚Ç¨</option>
                                        <option value="USD">$</option>
                                        <option value="GBP">¬£</option>
                                        <option value="CHF">CHF</option>
                                        <option value="AED">AED</option>
                                        <option value="JPY">¬•</option>
                                    </select>
                                    <input type="number" id="tax-amount" class="form-input" placeholder="4.00" required min="0" step="0.01"
                                        style="padding: 0.6rem; border-radius: 8px; flex: 1;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                            üìã How is it charged?
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Charge Per</label>
                                <select id="tax-charge-per" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="per_person_per_night">Per Person Per Night (PPPN)</option>
                                    <option value="per_room_per_night">Per Room Per Night (PRPN)</option>
                                    <option value="per_booking">Per Booking (one-time)</option>
                                    <option value="percentage">% of Room Rate</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Max Nights <span style="color: #9ca3af;">(if capped)</span></label>
                                <input type="number" id="tax-max-nights" class="form-input" placeholder="e.g., 7" min="1"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <details style="margin-bottom: 1.25rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #475569; padding: 1rem; list-style: none;">
                            ‚öôÔ∏è Advanced Options
                        </summary>
                        <div style="padding: 0 1rem 1rem 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Min Age (exempt below)</label>
                                    <input type="number" id="tax-min-age" class="form-input" placeholder="e.g., 12" min="0" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Star Rating Tier</label>
                                    <select id="tax-star-tier" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                        <option value="">All ratings</option>
                                        <option value="1-2">1-2 Star</option>
                                        <option value="3">3 Star</option>
                                        <option value="4">4 Star</option>
                                        <option value="5">5 Star / Luxury</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Season Start</label>
                                    <input type="date" id="tax-season-start" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; color: #374151; display: block; margin-bottom: 0.25rem;">Season End</label>
                                    <input type="date" id="tax-season-end" class="form-input" style="padding: 0.5rem; border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                    </details>
                    
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                        <input type="checkbox" id="tax-active" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 500; color: #374151;">Active</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1rem 1.5rem; background: #f9fafb; border-radius: 0 0 16px 16px;">
                <button class="btn btn-secondary" onclick="closeModal('addTaxModal')" style="border-radius: 8px;">Cancel</button>
                <button class="btn" onclick="saveTax()" style="border-radius: 8px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                    üíæ Save Tax
                </button>
            </div>
        </div>
    </div>

    <div id="imageUploadModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Upload Images</h3>
                <button class="modal-close" onclick="closeModal('imageUploadModal')">&times;</button>
            </div>
            <div class="modal-body" style="position: relative;">
                <!-- Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì§</div>
                    <h3>Drag & drop images here</h3>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0;">or click to browse</p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary);">
                        ‚ö†Ô∏è Minimum ratio 1.2:1 (e.g., 1200√ó1000) ‚Ä¢ Max 10MB per image
                    </p>
                    <input type="file" id="imageFileInput" multiple accept="image/*" style="display: none;">
                </div>

                <!-- Preview Area -->
                <div id="uploadPreview" class="upload-preview" style="display: none;"></div>

                <!-- Assignment Section -->
                <div class="assignment-section" id="assignmentSection">
                    <h4>üìç Assign images to:</h4>
                    
                    <!-- Property Assignment -->
                    <div style="margin-bottom: 1rem;">
                        <label class="checkbox-label" style="cursor: pointer;">
                            <input type="checkbox" id="assign-property" value="property" style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                            <span style="flex: 1;">üè® Property Images (general photos)</span>
                        </label>
                    </div>

                    <!-- Location Assignment -->
                    <div style="margin-bottom: 1rem;">
                        <label class="checkbox-label" style="cursor: pointer;">
                            <input type="checkbox" id="assign-location" value="location" style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                            <span style="flex: 1;">üìç Location Images (area/neighborhood)</span>
                        </label>
                    </div>

                    <!-- Room Assignment -->
                    <div>
                        <div style="font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">
                            üõèÔ∏è Rooms (select one or more):
                        </div>
                        <div class="checkbox-group" id="roomCheckboxes">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>

                <!-- Upload Button -->
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('imageUploadModal')" style="flex: 1;">
                        Cancel
                    </button>
                    <button class="btn" id="uploadButton" onclick="uploadImages()" style="flex: 2;" disabled>
                        Upload Images
                    </button>
                </div>

                <!-- Progress (shown during upload) -->
                <div id="uploadProgress" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 10; border-radius: 12px; display: none; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì§</div>
                    <h3 style="margin-bottom: 1rem;">Uploading Images...</h3>
                    <div style="width: 80%; max-width: 300px; background: var(--bg-secondary); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 0.5rem;">
                        <div id="progressBar" style="background: linear-gradient(90deg, #3b82f6, #8b5cf6); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem;" id="progressText">0%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Rule Modal -->
    <div id="depositRuleModal" class="modal">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;">‚öôÔ∏è Deposit Rule</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Configure payment policy for bookings</p>
                </div>
                <button class="modal-close" onclick="closeModal('depositRuleModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <form id="deposit-rule-form" onsubmit="event.preventDefault(); saveDepositRule();">
                    <input type="hidden" id="deposit-rule-id">
                    <input type="hidden" id="deposit-rule-property-id">
                    
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            Rule Name
                        </label>
                        <input type="text" id="deposit-rule-name" class="form-input" placeholder="e.g., Standard Deposit, Peak Season"
                            style="padding: 0.75rem; border-radius: 8px;">
                    </div>
                    
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                            üí∞ Deposit Amount
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Type</label>
                                <select id="deposit-type" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="toggleDepositTypeFields()">
                                    <option value="percentage">Percentage of total</option>
                                    <option value="fixed">Fixed amount</option>
                                    <option value="first_night">First night only</option>
                                    <option value="full">Full payment</option>
                                </select>
                            </div>
                            <div id="percentage-field">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Percentage</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="number" id="deposit-percentage" class="form-input" value="30" min="1" max="100"
                                        style="padding: 0.6rem; border-radius: 8px; flex: 1;">
                                    <span style="font-weight: 600;">%</span>
                                </div>
                            </div>
                            <div id="fixed-amount-field" style="display: none;">
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Fixed Amount (¬£)</label>
                                <input type="number" id="deposit-fixed-amount" class="form-input" placeholder="100.00" min="0" step="0.01"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                            üìÖ Balance Due
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Days Before Check-in</label>
                                <input type="number" id="balance-due-days" class="form-input" value="14" min="0"
                                    style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                            <div style="display: flex; align-items: center; padding-top: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="auto-charge-balance" style="width: 18px; height: 18px;">
                                    <span>Auto-charge balance</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                            ‚Ü©Ô∏è Refund Policy
                        </label>
                        <select id="refund-policy" class="form-input" style="padding: 0.75rem; border-radius: 8px;">
                            <option value="flexible">Flexible - Full refund up to 24h before check-in</option>
                            <option value="moderate">Moderate - Full refund up to 5 days before</option>
                            <option value="strict">Strict - 50% refund up to 7 days before</option>
                            <option value="non_refundable">Non-refundable</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <input type="checkbox" id="deposit-rule-active" checked style="width: 18px; height: 18px;">
                        <label for="deposit-rule-active" style="font-weight: 500;">Active</label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('depositRuleModal')">Cancel</button>
                        <button type="submit" class="btn" style="background: #059669;">Save Rule</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Deposit Rule Modal -->
    <div id="bulkDepositRuleModal" class="modal">
        <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;">üìã Apply Deposit Rule to Multiple Properties</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Select properties and configure the rule</p>
                </div>
                <button class="modal-close" onclick="closeModal('bulkDepositRuleModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
                <form id="bulk-deposit-rule-form" onsubmit="event.preventDefault(); saveBulkDepositRule();">
                    
                    <!-- Property Selection -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-weight: 600; display: block; margin-bottom: 0.75rem;">Select Properties</label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <button type="button" class="btn btn-small" onclick="selectAllBulkProperties()" style="font-size: 0.8rem;">Select All</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="deselectAllBulkProperties()" style="font-size: 0.8rem;">Deselect All</button>
                        </div>
                        <div id="bulk-property-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.5rem;">
                            <!-- Property checkboxes populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Rule Name -->
                    <div class="form-group">
                        <label>Rule Name</label>
                        <input type="text" id="bulk-deposit-rule-name" class="form-input" value="Standard Deposit" required>
                    </div>
                    
                    <!-- Deposit Type -->
                    <div class="form-group">
                        <label>Deposit Type</label>
                        <select id="bulk-deposit-type" class="form-input" onchange="toggleBulkDepositTypeFields()">
                            <option value="percentage">Percentage of Total</option>
                            <option value="fixed">Fixed Amount</option>
                            <option value="first_night">First Night</option>
                            <option value="full">Full Payment</option>
                        </select>
                    </div>
                    
                    <!-- Percentage -->
                    <div class="form-group" id="bulk-percentage-field">
                        <label>Deposit Percentage (%)</label>
                        <input type="number" id="bulk-deposit-percentage" class="form-input" value="30" min="1" max="100">
                    </div>
                    
                    <!-- Fixed Amount -->
                    <div class="form-group" id="bulk-fixed-amount-field" style="display: none;">
                        <label>Fixed Amount ($)</label>
                        <input type="number" id="bulk-deposit-fixed-amount" class="form-input" step="0.01" min="0">
                    </div>
                    
                    <!-- Balance Due -->
                    <div class="form-group">
                        <label>Balance Due (days before check-in)</label>
                        <input type="number" id="bulk-balance-due-days" class="form-input" value="14" min="0">
                    </div>
                    
                    <!-- Refund Policy -->
                    <div class="form-group">
                        <label>Refund Policy</label>
                        <select id="bulk-refund-policy" class="form-input">
                            <option value="flexible">Flexible</option>
                            <option value="moderate">Moderate</option>
                            <option value="strict">Strict</option>
                            <option value="non_refundable">Non-refundable</option>
                        </select>
                    </div>
                    
                    <div class="modal-footer" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('bulkDepositRuleModal')">Cancel</button>
                        <button type="submit" class="btn" style="background: #6366f1;">Apply to Selected Properties</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Booking Modal -->
    <div id="addBookingModal" class="modal">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;">üìÖ Add Booking</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Create a manual booking</p>
                </div>
                <button class="modal-close" onclick="closeModal('addBookingModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
                <form id="add-booking-form" onsubmit="event.preventDefault(); saveNewBooking();">
                    
                    <!-- Property & Room Selection -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #0369a1; margin-bottom: 0.75rem; display: block;">
                            üè† Property & Room
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Property *</label>
                                <select id="booking-property" class="form-input" style="padding: 0.6rem; border-radius: 8px;" onchange="loadBookingRooms()" required>
                                    <option value="">Select Property...</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Room *</label>
                                <select id="booking-room" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                                    <option value="">Select Room...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dates -->
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                            üìÜ Stay Dates
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Check-in *</label>
                                <input type="date" id="booking-checkin" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Check-out *</label>
                                <input type="date" id="booking-checkout" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Guests</label>
                                <input type="number" id="booking-guests" class="form-input" value="1" min="1" style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Guest Details -->
                    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                            üë§ Guest Details
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">First Name *</label>
                                <input type="text" id="booking-first-name" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Last Name *</label>
                                <input type="text" id="booking-last-name" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Email *</label>
                                <input type="email" id="booking-email" class="form-input" style="padding: 0.6rem; border-radius: 8px;" required>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Phone</label>
                                <input type="tel" id="booking-phone" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment & Status -->
                    <div style="background: #f5f3ff; border: 1px solid #ddd6fe; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #5b21b6; margin-bottom: 0.75rem; display: block;">
                            üí∞ Payment & Status
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Total Price</label>
                                <input type="number" id="booking-total" class="form-input" step="0.01" min="0" style="padding: 0.6rem; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Payment Status</label>
                                <select id="booking-payment-status" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="pending">Pending</option>
                                    <option value="deposit_paid">Deposit Paid</option>
                                    <option value="fully_paid">Fully Paid</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">Booking Status</label>
                                <select id="booking-status" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                                    <option value="confirmed">Confirmed</option>
                                    <option value="pending">Pending</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">üìù Notes</label>
                        <textarea id="booking-notes" class="form-input" rows="3" style="padding: 0.75rem; border-radius: 8px;" placeholder="Special requests, notes..."></textarea>
                    </div>
                    
                    <!-- Sync to Channel Manager -->
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                        <input type="checkbox" id="booking-sync-cm" checked style="width: 18px; height: 18px;">
                        <label for="booking-sync-cm" style="font-weight: 500;">Sync to Channel Manager (Beds24/Hostaway)</label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addBookingModal')">Cancel</button>
                        <button type="submit" class="btn" style="background: #4f46e5;">Create Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content" style="max-width: 650px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 id="account-modal-title" class="modal-title" style="margin: 0;">Edit Account</h3>
                    <div id="account-modal-subtitle" style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.25rem;"></div>
                </div>
                <button class="modal-close" onclick="closeModal('accountModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1rem; max-height: 70vh; overflow-y: auto;">
                <form id="account-form" onsubmit="saveAccount(event)">
                    <input type="hidden" id="edit-account-id">
                    <input type="hidden" id="account-code">
                    <input type="hidden" id="account-role">
                    <input type="hidden" id="account-status">
                    
                    <!-- Account Info Banner -->
                    <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #bae6fd;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <!-- Code (Read-Only) -->
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: #0369a1; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Code</div>
                                <div id="account-code-display" style="font-weight: 700; font-family: monospace; color: #0c4a6e; font-size: 1.1rem;">‚Äî</div>
                            </div>
                            <!-- Role (Editable for Master Admin) -->
                            <div>
                                <div style="font-size: 0.7rem; color: #0369a1; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem; text-align: center;">Role</div>
                                <div id="account-role-display-container" style="text-align: center; font-weight: 600; color: #0c4a6e;">‚Äî</div>
                                <select id="account-role-select" class="form-input" style="display: none; padding: 0.4rem; font-size: 0.85rem;">
                                    <option value="admin">üë§ Admin</option>
                                    <option value="submaster_admin">üìÅ Sub Master</option>
                                    <option value="agency_admin">üè¢ Agency Admin</option>
                                    <option value="master_admin">üëë Master Admin</option>
                                </select>
                            </div>
                            <!-- Status (Editable for Master Admin) -->
                            <div>
                                <div style="font-size: 0.7rem; color: #0369a1; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem; text-align: center;">Status</div>
                                <div id="account-status-display-container" style="text-align: center; font-weight: 600; color: #0c4a6e;">‚Äî</div>
                                <select id="account-status-select" class="form-input" style="display: none; padding: 0.4rem; font-size: 0.85rem;">
                                    <option value="active">‚úÖ Active</option>
                                    <option value="inactive">‚õî Inactive</option>
                                    <option value="pending">‚è≥ Pending</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Business Details Section -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #e2e8f0;">
                        <h4 style="margin: 0 0 1rem 0; font-size: 0.85rem; color: #475569; font-weight: 600;">üìã Business Details</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Business Name *</label>
                                <input type="text" id="account-name" class="form-input" required placeholder="e.g., Elevate Stays" style="padding: 0.5rem;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Contact Name</label>
                                <input type="text" id="account-contact-name" class="form-input" placeholder="e.g., John Smith" style="padding: 0.5rem;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Email</label>
                                <input type="email" id="account-email" class="form-input" placeholder="contact@example.com" style="padding: 0.5rem;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Phone</label>
                                <input type="tel" id="account-phone" class="form-input" placeholder="+1 234 567 8900" style="padding: 0.5rem;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Business Address Section -->
                    <div style="background: #fafafa; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #e5e5e5;">
                        <h4 style="margin: 0 0 1rem 0; font-size: 0.85rem; color: #525252; font-weight: 600;">üìç Business Address</h4>
                        
                        <div class="form-group" style="margin: 0 0 0.75rem 0;">
                            <label style="font-size: 0.8rem;">Address Line 1</label>
                            <input type="text" id="account-address1" class="form-input" placeholder="Street address" style="padding: 0.5rem;">
                        </div>
                        
                        <div class="form-group" style="margin: 0 0 0.75rem 0;">
                            <label style="font-size: 0.8rem;">Address Line 2</label>
                            <input type="text" id="account-address2" class="form-input" placeholder="Apartment, suite, etc." style="padding: 0.5rem;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">City</label>
                                <input type="text" id="account-city" class="form-input" placeholder="City" style="padding: 0.5rem;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Region</label>
                                <input type="text" id="account-region" class="form-input" placeholder="Region" style="padding: 0.5rem;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.8rem;">Postcode</label>
                                <input type="text" id="account-postcode" class="form-input" placeholder="Postcode" style="padding: 0.5rem;">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 0.8rem;">Country</label>
                            <input type="text" id="account-country" class="form-input" placeholder="Country" style="padding: 0.5rem;">
                        </div>
                    </div>
                    
                    <!-- Security Section -->
                    <div style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #fde047;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 0.25rem 0; font-size: 0.85rem; color: #854d0e; font-weight: 600;">üîê Security</h4>
                                <div style="font-size: 0.8rem; color: #a16207;">Set a new password for this account</div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="resetPasswordFromModal()" style="white-space: nowrap; font-size: 0.85rem;">
                                üîë Reset Password
                            </button>
                        </div>
                    </div>
                    
                    <!-- Agency Management Section (only for admin/submaster) -->
                    <div id="account-agency-section" style="display: none;">
                        <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #d8b4fe;">
                            <h4 style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: #6b21a8; font-weight: 600;">üè¢ Agency Management</h4>
                            <div id="account-agency-status">
                                <!-- Filled dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Travel Agent Access Section (placeholder for future) -->
                    <!-- Travel Agent Access Section -->
                    <div id="account-travel-agent-section">
                        <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #6ee7b7; opacity: 0.7;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <h4 style="margin: 0; font-size: 0.85rem; color: #047857; font-weight: 600;">üß≥ Travel Agent Access</h4>
                                <span style="background: #d1fae5; color: #047857; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">COMING SOON</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                                <div style="flex: 1;">
                                    <div style="font-size: 0.8rem; color: #065f46; margin-bottom: 0.5rem;">Assign travel agents who can book on behalf of this property</div>
                                    <select class="form-input" style="padding: 0.4rem; font-size: 0.85rem; width: 100%;" disabled>
                                        <option value="">Select travel agent...</option>
                                        <option value="1">Travel Agent 1</option>
                                        <option value="2">Travel Agent 2</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div style="display: flex; gap: 0.75rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('accountModal')">Cancel</button>
                        <button type="submit" class="btn">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Booking Modal -->
    <div id="viewBookingModal" class="modal">
        <div class="modal-content" style="max-width: 900px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0;">üìã Booking Details</h3>
                    <p id="view-booking-ref" style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Reference #</p>
                </div>
                <button class="modal-close" onclick="closeModal('viewBookingModal')" style="color: white;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0; max-height: 75vh; overflow-y: auto;">
                
                <!-- Status Bar -->
                <div id="view-booking-status-bar" style="display: flex; gap: 1rem; padding: 1rem 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                    <div id="view-booking-status"></div>
                    <div id="view-payment-status"></div>
                </div>
                
                <!-- Alert Banner (if any issues) -->
                <div id="view-booking-alert" style="display: none; padding: 1rem 1.5rem; background: #fef3c7; border-bottom: 1px solid #fde68a;">
                    <span style="font-weight: 600; color: #92400e;">‚ö†Ô∏è <span id="view-booking-alert-text"></span></span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                    
                    <!-- Left Column -->
                    <div style="padding: 1.5rem; border-right: 1px solid #e2e8f0;">
                        
                        <!-- Guest Info -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;">üë§</span> Guest Information
                            </h4>
                            <div style="background: #f8fafc; border-radius: 12px; padding: 1rem;">
                                <div style="font-size: 1.1rem; font-weight: 600; color: #1e293b;" id="view-guest-name">-</div>
                                <div style="margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; color: #64748b; font-size: 0.9rem;">
                                        <span>üìß</span> <span id="view-guest-email">-</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; color: #64748b; font-size: 0.9rem;">
                                        <span>üì±</span> <span id="view-guest-phone">-</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; color: #64748b; font-size: 0.9rem;">
                                        <span>üåç</span> <span id="view-guest-country">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stay Details -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;">üè®</span> Stay Details
                            </h4>
                            <div style="background: #f0fdf4; border-radius: 12px; padding: 1rem;">
                                <div style="font-weight: 600; color: #166534; margin-bottom: 0.75rem;" id="view-property-name">-</div>
                                <div style="color: #374151; margin-bottom: 0.75rem;" id="view-room-name">-</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">Check-in</div>
                                        <div style="font-weight: 600; color: #1e293b;" id="view-checkin">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">Check-out</div>
                                        <div style="font-weight: 600; color: #1e293b;" id="view-checkout">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">Nights</div>
                                        <div style="font-weight: 600; color: #1e293b;" id="view-nights">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">Guests</div>
                                        <div style="font-weight: 600; color: #1e293b;" id="view-guests">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div>
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;">üìù</span> Notes
                            </h4>
                            <div style="background: #f8fafc; border-radius: 12px; padding: 1rem; color: #64748b; font-size: 0.9rem;" id="view-notes">
                                No notes
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Right Column -->
                    <div style="padding: 1.5rem;">
                        
                        <!-- Financials -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;">üí∞</span> Financials
                            </h4>
                            <div style="background: #fffbeb; border-radius: 12px; padding: 1rem; border: 1px solid #fde68a;">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Accommodation</span>
                                    <span style="font-weight: 500;" id="view-accommodation">¬£0.00</span>
                                </div>
                                <div id="view-upsells-row" style="display: none; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Extras/Upsells</span>
                                    <span style="font-weight: 500;" id="view-upsells">¬£0.00</span>
                                </div>
                                <div id="view-discount-row" style="display: none; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Discount</span>
                                    <span style="font-weight: 500; color: #16a34a;" id="view-discount">-¬£0.00</span>
                                </div>
                                <div id="view-tax-row" style="display: none; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Tax</span>
                                    <span style="font-weight: 500;" id="view-tax">¬£0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; margin-top: 0.5rem; border-top: 2px solid #d97706;">
                                    <span style="font-weight: 700; color: #1e293b;">Total</span>
                                    <span style="font-weight: 700; font-size: 1.25rem; color: #d97706;" id="view-total">¬£0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Summary -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;">üí≥</span> Payment Summary
                            </h4>
                            <div style="background: #f0f9ff; border-radius: 12px; padding: 1rem; border: 1px solid #bae6fd;">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Deposit Paid</span>
                                    <span style="font-weight: 500; color: #16a34a;" id="view-deposit-paid">¬£0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #e5e7eb;">
                                    <span style="color: #64748b;">Balance Due</span>
                                    <span style="font-weight: 600; color: #dc2626;" id="view-balance-due">¬£0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; font-size: 0.85rem;">
                                    <span style="color: #64748b;">Due Date</span>
                                    <span style="color: #374151;" id="view-due-date">At check-in</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Channel Manager Info -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #374151; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.1rem;">üîó</span> Channel Manager
                            </h4>
                            <div style="background: #f8fafc; border-radius: 12px; padding: 1rem; font-size: 0.9rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                    <span style="color: #64748b;">Source</span>
                                    <span style="font-weight: 500;" id="view-booking-source">Direct</span>
                                </div>
                                <div id="view-beds24-row" style="display: none; justify-content: space-between; padding: 0.25rem 0;">
                                    <span style="color: #64748b;">Beds24 ID</span>
                                    <span style="font-weight: 500;" id="view-beds24-id">-</span>
                                </div>
                                <div id="view-hostaway-row" style="display: none; justify-content: space-between; padding: 0.25rem 0;">
                                    <span style="color: #64748b;">Hostaway ID</span>
                                    <span style="font-weight: 500;" id="view-hostaway-id">-</span>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <!-- Actions Footer -->
                <div style="padding: 1.5rem; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button onclick="generateInvoice(currentViewingBookingId)" class="btn" style="background: #0ea5e9; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üìÑ</span> Generate Invoice
                    </button>
                    <button onclick="sendPaymentReceipt(currentViewingBookingId)" class="btn" style="background: #8b5cf6; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üìß</span> Send Receipt
                    </button>
                    <button onclick="processRefund(currentViewingBookingId)" class="btn" style="background: #f59e0b; display: flex; align-items: center; gap: 0.5rem;">
                        <span>‚Ü©Ô∏è</span> Process Refund
                    </button>
                    <button onclick="cancelBooking(currentViewingBookingId)" class="btn" style="background: #ef4444; display: flex; align-items: center; gap: 0.5rem;">
                        <span>‚úñÔ∏è</span> Cancel Booking
                    </button>
                </div>
                
            </div>
        </div>
    </div>

    <div id="editPropertyModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Property</h3>
                <button class="modal-close" onclick="closeModal('editPropertyModal')">√ó</button>
            </div>
            <form id="editPropertyForm" onsubmit="return saveProperty(event)">
                <input type="hidden" id="edit-property-id">
                
                <!-- Basic Info Section -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">Basic Information</h4>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Property Name *</label>
                        <input type="text" class="form-input" id="edit-property-name" required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Property Type</label>
                            <select class="form-input" id="edit-property-type">
                                <option value="hotel">Hotel</option>
                                <option value="apartment">Apartment</option>
                                <option value="house">House</option>
                                <option value="bedAndBreakfast">Bed & Breakfast</option>
                                <option value="hostel">Hostel</option>
                                <option value="villa">Villa</option>
                                <option value="cottage">Cottage</option>
                                <option value="guesthouse">Guesthouse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-input" id="edit-property-status">
                                <option value="active">Active</option>
                                <option value="draft">Draft</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Address Section -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">üìç Address & Location</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Street Address</label>
                            <input type="text" class="form-input" id="edit-property-address" placeholder="123 High Street">
                        </div>
                        <div class="form-group">
                            <label class="form-label">City / Town</label>
                            <input type="text" class="form-input" id="edit-property-city" placeholder="London">
                        </div>
                        <div class="form-group">
                            <label class="form-label">District / Area</label>
                            <input type="text" class="form-input" id="edit-property-district" placeholder="Westminster">
                        </div>
                        <div class="form-group">
                            <label class="form-label">State / County / Region</label>
                            <input type="text" class="form-input" id="edit-property-state" placeholder="Greater London">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Postcode / ZIP</label>
                            <input type="text" class="form-input" id="edit-property-zipcode" placeholder="SW1A 1AA">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Country</label>
                            <select class="form-input" id="edit-property-country">
                                <option value="">Select country...</option>
                                <option value="GB">üá¨üáß United Kingdom</option>
                                <option value="US">üá∫üá∏ United States</option>
                                <option value="CH">üá®üá≠ Switzerland</option>
                                <option value="DE">üá©üá™ Germany</option>
                                <option value="FR">üá´üá∑ France</option>
                                <option value="IT">üáÆüáπ Italy</option>
                                <option value="ES">üá™üá∏ Spain</option>
                                <option value="NL">üá≥üá± Netherlands</option>
                                <option value="AT">üá¶üáπ Austria</option>
                                <option value="PT">üáµüáπ Portugal</option>
                                <option value="BE">üáßüá™ Belgium</option>
                                <option value="IE">üáÆüá™ Ireland</option>
                                <option value="AU">üá¶üá∫ Australia</option>
                                <option value="NZ">üá≥üáø New Zealand</option>
                                <option value="CA">üá®üá¶ Canada</option>
                                <option value="AE">üá¶üá™ UAE</option>
                                <option value="JP">üáØüáµ Japan</option>
                                <option value="TH">üáπüá≠ Thailand</option>
                                <option value="GR">üá¨üá∑ Greece</option>
                                <option value="HR">üá≠üá∑ Croatia</option>
                                <option value="CZ">üá®üáø Czech Republic</option>
                                <option value="PL">üáµüá± Poland</option>
                                <option value="HU">üá≠üá∫ Hungary</option>
                                <option value="SE">üá∏üá™ Sweden</option>
                                <option value="NO">üá≥üá¥ Norway</option>
                                <option value="DK">üá©üá∞ Denmark</option>
                                <option value="FI">üá´üáÆ Finland</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Coordinates Section -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">üó∫Ô∏è Map Coordinates</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Latitude</label>
                            <input type="text" class="form-input" id="edit-property-latitude" placeholder="51.5074">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Longitude</label>
                            <input type="text" class="form-input" id="edit-property-longitude" placeholder="-0.1278">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="geocodePropertyAddress()" style="height: 42px;">
                            üìç Lookup
                        </button>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        Coordinates are used for map display on your booking site.
                    </p>
                    
                    <!-- Mini Map Preview -->
                    <div id="property-map-preview" style="margin-top: 1rem; height: 200px; background: #e5e7eb; border-radius: 8px; display: none; position: relative; overflow: hidden;">
                        <div id="property-map-container" style="width: 100%; height: 100%;"></div>
                        <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">
                            Click map to set coordinates
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="togglePropertyMap()" style="margin-top: 0.5rem; font-size: 0.85rem;" id="toggle-map-btn">
                        üó∫Ô∏è Show Map
                    </button>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn" style="background: var(--error); border-color: var(--error);" onclick="deleteProperty()">
                        üóëÔ∏è Delete Property
                    </button>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editPropertyModal')">Cancel</button>
                        <button type="submit" class="btn">üíæ Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Settings Modal -->
    <div id="paymentSettingsModal" class="modal">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">üí≥ Payment Settings</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;" id="payment-settings-property-name"></p>
                </div>
                <button class="modal-close" onclick="closeModal('paymentSettingsModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <input type="hidden" id="payment-settings-property-id">
                <input type="hidden" id="payment-settings-account-id">
                
                <!-- Payment Provider Selection -->
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid #c7d2fe;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem; color: #4338ca;">üè¶ Payment Provider</h4>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- Stripe -->
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid transparent; transition: all 0.2s;" id="provider-stripe-label">
                            <input type="radio" name="payment-provider" value="stripe" id="payment-provider-stripe" style="width: 18px; height: 18px;" checked>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/ba/Stripe_Logo%2C_revised_2016.svg" alt="Stripe" style="height: 24px;">
                            <span style="flex: 1; font-weight: 500;">Stripe</span>
                            <span style="font-size: 0.75rem; background: #10b981; color: white; padding: 0.15rem 0.5rem; border-radius: 10px;">Recommended</span>
                        </label>
                        
                        <!-- PayPal -->
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid transparent; opacity: 0.5;" id="provider-paypal-label">
                            <input type="radio" name="payment-provider" value="paypal" id="payment-provider-paypal" style="width: 18px; height: 18px;" disabled>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal" style="height: 24px;">
                            <span style="flex: 1; font-weight: 500;">PayPal</span>
                            <span style="font-size: 0.75rem; background: #94a3b8; color: white; padding: 0.15rem 0.5rem; border-radius: 10px;">Coming Soon</span>
                        </label>
                        
                        <!-- Airwallex -->
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid transparent; opacity: 0.5;" id="provider-airwallex-label">
                            <input type="radio" name="payment-provider" value="airwallex" id="payment-provider-airwallex" style="width: 18px; height: 18px;" disabled>
                            <span style="font-weight: 600; color: #e11d48;">Airwallex</span>
                            <span style="flex: 1;"></span>
                            <span style="font-size: 0.75rem; background: #94a3b8; color: white; padding: 0.15rem 0.5rem; border-radius: 10px;">Coming Soon</span>
                        </label>
                    </div>
                </div>
                
                <!-- Stripe API Keys Section -->
                <div id="stripe-keys-section" style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; font-size: 0.95rem;">üîë Stripe API Keys</h4>
                        <a href="https://dashboard.stripe.com/apikeys" target="_blank" style="font-size: 0.8rem; color: var(--accent);">
                            Get keys from Stripe Dashboard ‚Üí
                        </a>
                    </div>
                    
                    <div id="stripe-keys-status" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 8px; display: none;">
                        <!-- Status will be shown here -->
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Publishable Key</label>
                        <input type="text" class="form-input" id="stripe-publishable-key" placeholder="pk_live_... or pk_test_...">
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Starts with pk_live_ (production) or pk_test_ (testing)
                        </p>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label">Secret Key</label>
                        <input type="password" class="form-input" id="stripe-secret-key" placeholder="sk_live_... or sk_test_...">
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Starts with sk_live_ (production) or sk_test_ (testing)
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="testStripeConnection()" style="font-size: 0.85rem;">
                            üîç Test Connection
                        </button>
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin-left: auto; font-size: 0.85rem;">
                            <input type="checkbox" id="stripe-test-mode" style="width: 16px; height: 16px;">
                            Test Mode
                        </label>
                    </div>
                </div>
                
                <!-- Generate Setup Link (for property owners) -->
                <div style="background: #fef3c7; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #fcd34d;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem;">üìß</span>
                        <div style="flex: 1;">
                            <strong style="font-size: 0.9rem;">Need to send to property owner?</strong>
                            <p style="font-size: 0.8rem; color: #92400e; margin: 0.25rem 0 0 0;">
                                Generate a secure link they can use to enter their own Stripe keys
                            </p>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="generatePaymentSetupLink()" style="font-size: 0.8rem; white-space: nowrap;">
                            üîó Generate Link
                        </button>
                    </div>
                    <div id="setup-link-result" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: white; border-radius: 8px;">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="text" id="setup-link-url" class="form-input" readonly style="flex: 1; font-size: 0.8rem;">
                            <button type="button" class="btn btn-small" onclick="copySetupLink()" style="font-size: 0.75rem;">üìã Copy</button>
                        </div>
                        <p style="font-size: 0.75rem; color: #92400e; margin: 0.5rem 0 0 0;">
                            Link expires in 72 hours
                        </p>
                    </div>
                </div>
                
                <!-- Deposit Settings -->
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem;">üí∞ Deposit Settings</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Deposit Type</label>
                            <select id="payment-deposit-type" class="form-input">
                                <option value="percentage">Percentage of total</option>
                                <option value="fixed">Fixed amount</option>
                                <option value="full">Full payment required</option>
                                <option value="none">No deposit</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Deposit Amount</label>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="number" id="payment-deposit-amount" class="form-input" value="25" min="0" step="0.01">
                                <span id="payment-deposit-symbol" style="font-weight: 500;">%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 1rem; margin-bottom: 0;">
                        <label>Balance Due (days before arrival)</label>
                        <input type="number" id="payment-balance-days" class="form-input" value="14" min="0" style="max-width: 150px;">
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            0 = balance due on arrival
                        </p>
                    </div>
                </div>
                
                <!-- Currency -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Currency</label>
                    <select id="payment-currency" class="form-input" style="max-width: 200px;">
                        <option value="GBP">üá¨üáß GBP (¬£)</option>
                        <option value="USD">üá∫üá∏ USD ($)</option>
                        <option value="EUR">üá™üá∫ EUR (‚Ç¨)</option>
                        <option value="CHF">üá®üá≠ CHF</option>
                    </select>
                </div>
                
                <!-- Cancellation Policy -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label>Cancellation Policy (Optional)</label>
                    <textarea id="payment-cancellation" class="form-input" rows="3" placeholder="e.g., Free cancellation up to 48 hours before check-in. 50% refund for cancellations made 24-48 hours before. No refund for cancellations less than 24 hours before check-in."></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentSettingsModal')">Cancel</button>
                    <button type="button" class="btn" onclick="savePaymentSettings()">üíæ Save Payment Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Room Modal -->
    <div id="editRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Room</h3>
                <button class="modal-close" onclick="closeModal('editRoomModal')">√ó</button>
            </div>
            <form id="editRoomForm" onsubmit="return saveRoom(event)">
                <input type="hidden" id="edit-room-id">
                
                <!-- CM Data (reference) -->
                <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">üì° From Channel Manager</div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Original Room Name</label>
                        <input type="text" class="form-input" id="edit-room-name" readonly style="background: var(--bg-primary);">
                    </div>
                </div>
                
                <!-- Display Name for Website -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">‚ú® Display Name (shown on website)</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="edit-room-display-name" placeholder="Leave blank to use original name" style="flex: 1;">
                        <button type="button" class="btn" onclick="generateRoomDisplayName()" style="white-space: nowrap; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                            ü™Ñ Generate
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        AI-generated marketing-friendly name for your booking website
                    </div>
                </div>
                
                <!-- Short Description -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">üìù Short Description</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" class="form-input" id="edit-room-short-description" placeholder="Brief tagline for listings" style="flex: 1;" maxlength="150">
                        <button type="button" class="btn" onclick="generateRoomShortDescription()" style="white-space: nowrap; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                            ü™Ñ Generate
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        Short tagline shown in search results (max 150 chars)
                    </div>
                </div>
                
                <!-- Full Description -->
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">üìÑ Full Description</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <textarea class="form-input" id="edit-room-full-description" rows="4" placeholder="Detailed room description for the booking page"></textarea>
                        <button type="button" class="btn" onclick="generateRoomFullDescription()" style="align-self: flex-end; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                            ü™Ñ Generate Full Description
                        </button>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        Detailed description shown on the room booking page
                    </div>
                </div>
                
                <!-- GAS Controls -->
                <div style="font-size: 0.75rem; color: var(--accent); margin-bottom: 0.5rem;">üéõÔ∏è GAS Controls</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Room Type</label>
                        <select class="form-input" id="edit-room-type">
                            <option value="single">Single</option>
                            <option value="double">Double</option>
                            <option value="twin">Twin</option>
                            <option value="triple">Triple</option>
                            <option value="quad">Quad</option>
                            <option value="suite">Suite</option>
                            <option value="studio">Studio</option>
                            <option value="apartment">Apartment</option>
                            <option value="villa">Villa</option>
                            <option value="cottage">Cottage</option>
                            <option value="dormitory">Dormitory</option>
                            <option value="family">Family Room</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="edit-room-status">
                            <option value="available">‚úÖ Available</option>
                            <option value="unavailable">‚ùå Unavailable</option>
                            <option value="maintenance">üîß Maintenance</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Max Guests</label>
                        <input type="number" class="form-input" id="edit-room-maxguests" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Adults</label>
                        <input type="number" class="form-input" id="edit-room-maxadults" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Children</label>
                        <input type="number" class="form-input" id="edit-room-maxchildren" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-input" id="edit-room-quantity" min="1">
                    </div>
                </div>
                
                <!-- Note about amenities -->
                <div style="background: #e0f2fe; border: 1px solid #0ea5e9; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <p style="margin: 0; color: #0369a1;">
                        üí° <strong>Amenities:</strong> Manage room amenities from the <a href="#" onclick="closeModal('editRoomModal'); showView('amenities'); return false;" style="color: #0369a1; text-decoration: underline;">Amenities page</a>
                    </p>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 1.5rem;">
                    <button type="button" class="btn" style="background: var(--error); border-color: var(--error);" onclick="deleteRoom()">
                        Delete Room
                    </button>
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editRoomModal')">Cancel</button>
                        <button type="submit" class="btn">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Occupancy Settings Modal -->
    <div id="occupancySettingsModal" class="modal">
        <div class="modal-content" style="max-width: 550px; border-radius: 16px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">üë• Occupancy Pricing Settings</h3>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;" id="occupancy-room-name"></p>
                </div>
                <button class="modal-close" onclick="closeModal('occupancySettingsModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <input type="hidden" id="occupancy-room-id">
                
                <!-- Pricing Mode Toggle -->
                <div style="background: #f5f3ff; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" id="occupancy-enabled" style="width: 22px; height: 22px; accent-color: #7c3aed;">
                        <div>
                            <strong style="font-size: 1rem;">Enable Occupancy Pricing</strong>
                            <p style="font-size: 0.8rem; color: #6b7280; margin: 0.25rem 0 0 0;">
                                Charge different rates based on number of guests
                            </p>
                        </div>
                    </label>
                </div>
                
                <div id="occupancy-settings-fields">
                    <!-- Base Occupancy -->
                    <div class="form-group" style="margin-bottom: 1.25rem;">
                        <label class="form-label">Base Occupancy (included in standard price)</label>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <select id="occupancy-base" class="form-input" style="max-width: 100px;">
                                <!-- Options populated dynamically based on max_guests -->
                            </select>
                            <span style="font-size: 0.85rem; color: #6b7280;">Max guests: <span id="occupancy-max-guests">4</span></span>
                        </div>
                    </div>
                    
                    <!-- Single Occupancy Discount -->
                    <div id="single-discount-section" style="background: #f0fdf4; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                        <label class="form-label" style="color: #166534; margin-bottom: 0.75rem;">üí∞ Single Occupancy Discount</label>
                        <div id="single-discount-fields" style="display: flex; align-items: center; gap: 0.5rem;">
                            <select id="single-discount-type" class="form-input" style="width: 120px;">
                                <option value="fixed">Fixed (¬£)</option>
                                <option value="percent">Percent (%)</option>
                            </select>
                            <input type="number" id="single-discount-value" class="form-input" value="0" min="0" style="width: 80px;">
                            <span style="font-size: 0.85rem; color: #166534;">off per night</span>
                        </div>
                        <p id="single-discount-disabled-msg" style="display: none; margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #6b7280; font-style: italic;">
                            ‚ÑπÔ∏è Not applicable when base occupancy is 1 (can't book 0 guests)
                        </p>
                    </div>
                    
                    <!-- Extra Adult Charge -->
                    <div id="extra-adult-section" style="background: #fef2f2; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                        <label class="form-label" style="color: #991b1b; margin-bottom: 0.75rem;">üíµ Extra Adult Charge</label>
                        <div id="extra-adult-fields" style="display: flex; align-items: center; gap: 0.5rem;">
                            <select id="extra-adult-type" class="form-input" style="width: 120px;">
                                <option value="fixed">Fixed (¬£)</option>
                                <option value="percent">Percent (%)</option>
                            </select>
                            <input type="number" id="extra-adult-charge" class="form-input" value="0" min="0" style="width: 80px;">
                            <span style="font-size: 0.85rem; color: #991b1b;">per extra adult/night</span>
                        </div>
                        <p id="extra-adult-disabled-msg" style="display: none; margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #6b7280; font-style: italic;">
                            ‚ÑπÔ∏è Not applicable when base occupancy equals max guests
                        </p>
                    </div>
                    
                    <!-- Children Allowed Toggle -->
                    <div style="background: #f0f9ff; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; border: 1px solid #bae6fd;">
                        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                            <input type="checkbox" id="children-allowed" checked style="width: 20px; height: 20px; accent-color: #0284c7;">
                            <div>
                                <strong style="color: #0369a1;">Allow Children</strong>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0.15rem 0 0 0;">
                                    Uncheck to hide children selector on booking widget
                                </p>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Child Charge -->
                    <div id="child-charge-section" style="background: #eff6ff; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                        <label class="form-label" style="color: #1e40af; margin-bottom: 0.75rem;">üë∂ Child Charge <span style="font-size: 0.75rem; font-weight: normal;">(under <span id="child-max-age-display">12</span> years)</span></label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <select id="child-charge-type" class="form-input" style="width: 120px;">
                                <option value="free">Free</option>
                                <option value="fixed">Fixed (¬£)</option>
                                <option value="percent">Percent (%)</option>
                            </select>
                            <input type="number" id="child-charge" class="form-input" value="0" min="0" style="width: 80px;" disabled>
                            <span style="font-size: 0.85rem; color: #1e40af;">per child/night</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('occupancySettingsModal')">Cancel</button>
                    <button type="button" class="btn" style="background: #7c3aed; border-color: #7c3aed;" onclick="saveOccupancySettings()">üíæ Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Amenity Modal -->
    <div id="addAmenityModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Manage Amenities</h3>
                <button class="modal-close" onclick="closeModal('addAmenityModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Category Selection -->
                <div class="form-group">
                    <label class="form-label">Select Category</label>
                    <select class="form-input" id="amenity-category-select" onchange="loadCategoryAmenities()">
                        <option value="">Choose a category...</option>
                    </select>
                </div>
                
                <!-- Current Amenities in Category -->
                <div id="category-amenities-list" style="display: none; margin: 1.5rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <h4 style="margin-bottom: 1rem;">Current Amenities</h4>
                    <div id="amenities-in-category" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <!-- Amenities will be loaded here -->
                    </div>
                </div>
                
                <!-- Add New Amenity Section -->
                <div id="add-amenity-section" style="display: none; border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Add New Amenity to this Category</h4>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Amenity Name</label>
                            <input type="text" class="form-input" id="new-amenity-name" placeholder="e.g., Smart TV" oninput="autoSuggestIcon()">
                        </div>
                        <div class="form-group" style="width: 80px; margin-bottom: 0;">
                            <label class="form-label">Icon</label>
                            <input type="text" class="form-input" id="new-amenity-icon" placeholder="üì∫" maxlength="4" style="font-size: 1.5rem; text-align: center;">
                        </div>
                        <button class="btn" onclick="addAmenityToCategory()" style="height: 42px;">Add</button>
                    </div>
                </div>
                
                <!-- Create New Category Section -->
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Or Create New Category</h4>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label">Category Name</label>
                            <input type="text" class="form-input" id="new-category-name" placeholder="e.g., Pet Friendly">
                        </div>
                        <button class="btn btn-secondary" onclick="createNewCategory()" style="height: 42px;">Create Category</button>
                    </div>
                </div>
                
                <!-- Danger Zone -->
                <div style="border-top: 1px solid var(--error); padding-top: 1.5rem; margin-top: 2rem; background: rgba(239, 68, 68, 0.05); padding: 1rem; border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem; color: var(--error);">‚ö†Ô∏è Danger Zone</h4>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">These actions cannot be undone.</p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="deleteAllInCategory()" style="background: var(--error); border-color: var(--error);">
                            üóëÔ∏è Delete All in Selected Category
                        </button>
                        <button class="btn" onclick="deleteAllAmenities()" style="background: #7f1d1d; border-color: #7f1d1d;">
                            ‚ö†Ô∏è Delete ALL Amenities
                        </button>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; text-align: right;">
                    <button class="btn btn-secondary" onclick="closeModal('addAmenityModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div id="bulkEditModal" class="modal">
        <div class="modal-content" style="max-width: 700px; border-radius: 16px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border-radius: 16px 16px 0 0; padding: 1.5rem;">
                <div>
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">‚ö° Bulk Edit</h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Update prices, min stays, and restrictions across multiple rooms and dates</p>
                </div>
                <button class="modal-close" onclick="closeModal('bulkEditModal')" style="color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                
                <!-- What to Edit -->
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #475569; margin-bottom: 0.75rem; display: block;">
                        üéØ What do you want to edit?
                    </label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb; flex: 1; min-width: 150px;">
                            <input type="radio" name="bulk-edit-type" value="price" checked onchange="toggleBulkEditType()"> 
                            <span>üí∞ Prices</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb; flex: 1; min-width: 150px;">
                            <input type="radio" name="bulk-edit-type" value="minstay" onchange="toggleBulkEditType()"> 
                            <span>üìè Min Stay</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: white; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb; flex: 1; min-width: 150px;">
                            <input type="radio" name="bulk-edit-type" value="closed" onchange="toggleBulkEditType()"> 
                            <span>üö´ Closed Days</span>
                        </label>
                    </div>
                </div>
                
                <!-- Value Input (changes based on type) -->
                <div id="bulk-value-section" style="margin-bottom: 1.25rem;">
                    <!-- Price input -->
                    <div id="bulk-price-input" class="form-group">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            üí∞ Price Action
                        </label>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <select id="bulk-price-action" class="form-input" style="width: auto; padding: 0.6rem;">
                                <option value="set">Set price to</option>
                                <option value="increase">Increase by</option>
                                <option value="decrease">Decrease by</option>
                                <option value="increase_pct">Increase by %</option>
                                <option value="decrease_pct">Decrease by %</option>
                            </select>
                            <input type="number" id="bulk-price-value" class="form-input" min="0" value="100"
                                style="width: 100px; padding: 0.6rem; font-size: 1.1rem; font-weight: 600;">
                            <span id="bulk-price-symbol" style="color: #6b7280;">$</span>
                        </div>
                    </div>
                    
                    <!-- Min Stay input (hidden by default) -->
                    <div id="bulk-minstay-input" class="form-group" style="display: none;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            üìè Min Stay Nights
                        </label>
                        <input type="number" id="bulk-minstay-value" class="form-input" min="1" max="30" value="2"
                            style="width: 100px; padding: 0.6rem; font-size: 1.1rem; font-weight: 600;">
                    </div>
                    
                    <!-- Closed days input (hidden by default) -->
                    <div id="bulk-closed-input" class="form-group" style="display: none;">
                        <label style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; display: block;">
                            üö´ Close for
                        </label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: #fee2e2; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="bulk-close-checkin" checked> <span>Check-in</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; background: #fee2e2; border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" id="bulk-close-checkout" checked> <span>Check-out</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Date Range -->
                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #166534; margin-bottom: 0.75rem; display: block;">
                        üìÖ Date Range
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">From</label>
                            <input type="date" id="bulk-date-from" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem; display: block;">To</label>
                            <input type="date" id="bulk-date-to" class="form-input" style="padding: 0.6rem; border-radius: 8px;">
                        </div>
                    </div>
                </div>
                
                <!-- Days of Week -->
                <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #1e40af; margin-bottom: 0.75rem; display: block;">
                        üìÜ Apply to Days
                    </label>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="1" checked> <span>Mon</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="2" checked> <span>Tue</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="3" checked> <span>Wed</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="4" checked> <span>Thu</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: white; border-radius: 6px; cursor: pointer; border: 1px solid #e5e7eb;">
                            <input type="checkbox" class="bulk-day-cb" data-day="5" checked> <span>Fri</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: #fef3c7; border-radius: 6px; cursor: pointer; border: 1px solid #fde68a;">
                            <input type="checkbox" class="bulk-day-cb" data-day="6" checked> <span>Sat</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.4rem 0.75rem; background: #fef3c7; border-radius: 6px; cursor: pointer; border: 1px solid #fde68a;">
                            <input type="checkbox" class="bulk-day-cb" data-day="0" checked> <span>Sun</span>
                        </label>
                    </div>
                </div>
                
                <!-- Offers Selection (shown for min stay and closed) -->
                <div id="bulk-offers-section" style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem; display: none;">
                    <label style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; display: block;">
                        üè∑Ô∏è Apply to Offers
                    </label>
                    <div style="margin-bottom: 0.5rem;">
                        <a href="#" onclick="document.querySelectorAll('.bulk-offer-cb').forEach(c=>c.checked=true); return false;" style="font-size: 0.85rem; color: #2563eb;">select all</a>
                        <span style="color: #9ca3af; margin: 0 0.5rem;">|</span>
                        <a href="#" onclick="document.querySelectorAll('.bulk-offer-cb').forEach(c=>c.checked=false); return false;" style="font-size: 0.85rem; color: #2563eb;">deselect all</a>
                    </div>
                    <div id="bulk-offers-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                        <p style="padding: 0.75rem; color: #6b7280;">Loading offers...</p>
                    </div>
                </div>
                
                <!-- Room Selection -->
                <div style="background: #faf5ff; border: 1px solid #e9d5ff; border-radius: 12px; padding: 1rem; margin-bottom: 1.25rem;">
                    <label style="font-weight: 600; color: #7c3aed; margin-bottom: 0.75rem; display: block;">
                        üè† Apply to Rooms
                    </label>
                    <div style="margin-bottom: 0.5rem;">
                        <a href="#" onclick="document.querySelectorAll('.bulk-room-cb').forEach(c=>c.checked=true); return false;" style="font-size: 0.85rem; color: #2563eb;">select all</a>
                        <span style="color: #9ca3af; margin: 0 0.5rem;">|</span>
                        <a href="#" onclick="document.querySelectorAll('.bulk-room-cb').forEach(c=>c.checked=false); return false;" style="font-size: 0.85rem; color: #2563eb;">deselect all</a>
                    </div>
                    <div id="bulk-rooms-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; background: white;">
                        <p style="padding: 0.75rem; color: #6b7280;">Loading rooms...</p>
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <button class="btn btn-secondary" onclick="closeModal('bulkEditModal')">Cancel</button>
                    <button class="btn" id="bulk-apply-btn" onclick="applyBulkEdit()" style="background: #16a34a; border-color: #16a34a;">
                        ‚úì Apply Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // AUTHENTICATION
        // =====================================================
        let currentAccount = null;
        
        // Country name to ISO code mapping for backward compatibility
        const countryNameToCode = {
            'united kingdom': 'GB', 'uk': 'GB', 'great britain': 'GB', 'england': 'GB',
            'united states': 'US', 'usa': 'US', 'america': 'US',
            'switzerland': 'CH', 'suisse': 'CH', 'schweiz': 'CH',
            'germany': 'DE', 'deutschland': 'DE',
            'france': 'FR',
            'italy': 'IT', 'italia': 'IT',
            'spain': 'ES', 'espa√±a': 'ES',
            'netherlands': 'NL', 'holland': 'NL',
            'austria': 'AT', '√∂sterreich': 'AT',
            'portugal': 'PT',
            'belgium': 'BE', 'belgique': 'BE',
            'ireland': 'IE',
            'australia': 'AU',
            'new zealand': 'NZ',
            'canada': 'CA',
            'uae': 'AE', 'united arab emirates': 'AE', 'dubai': 'AE',
            'japan': 'JP',
            'thailand': 'TH',
            'greece': 'GR',
            'croatia': 'HR',
            'czech republic': 'CZ', 'czechia': 'CZ',
            'poland': 'PL',
            'hungary': 'HU',
            'sweden': 'SE',
            'norway': 'NO',
            'denmark': 'DK',
            'finland': 'FI'
        };
        
        function normalizeCountryCode(country) {
            if (!country) return 'GB';
            // If already a 2-letter code, return uppercase
            if (country.length === 2) return country.toUpperCase();
            // Try to find in mapping
            const code = countryNameToCode[country.toLowerCase()];
            return code || country; // Return original if not found
        }
        
        // Check authentication on page load
        async function checkAuth() {
            const token = localStorage.getItem('gas_token');
            
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            
            try {
                const response = await fetch('/api/accounts/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();
                
                if (data.success) {
                    currentAccount = data.account;
                    updateUserProfile();
                    applyRoleBasedAccess();
                    // Update billing nav visibility after auth
                    if (typeof updateBillingNavVisibility === 'function') {
                        updateBillingNavVisibility();
                    }
                    // Load feature entitlements
                    if (typeof loadAccountEntitlements === 'function') {
                        loadAccountEntitlements();
                    }
                    // Reload dashboard with correct filters
                    if (typeof loadDashboard === 'function') {
                        loadDashboard();
                    }
                    return true;
                } else {
                    // Token invalid, clear and redirect
                    localStorage.removeItem('gas_token');
                    localStorage.removeItem('gas_account');
                    window.location.href = '/login.html';
                    return false;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // On network error, try using cached account
                const cachedAccount = localStorage.getItem('gas_account');
                if (cachedAccount) {
                    currentAccount = JSON.parse(cachedAccount);
                    updateUserProfile();
                    applyRoleBasedAccess();
                    // Update billing nav visibility after auth
                    if (typeof updateBillingNavVisibility === 'function') {
                        updateBillingNavVisibility();
                    }
                    // Load feature entitlements
                    if (typeof loadAccountEntitlements === 'function') {
                        loadAccountEntitlements();
                    }
                    if (typeof loadDashboard === 'function') {
                        loadDashboard();
                    }
                    return true;
                }
                window.location.href = '/login.html';
                return false;
            }
        }
        
        // Apply role-based access control
        function applyRoleBasedAccess() {
            if (!currentAccount) return;
            
            // Master admin sees everything
            if (currentAccount.role === 'master_admin') {
                // Master admin sees everything including agency management requests
                document.querySelectorAll('.agency-only').forEach(el => {
                    el.style.display = 'flex';
                });
                // Show/hide master-only sections based on whether viewing a client
                updateMasterOnlyVisibility();
                // Show Clear button for master admin
                const clearBtn = document.getElementById('clearFilterBtn');
                if (clearBtn) clearBtn.style.display = 'block';
                return;
            }
            
            // Non-master: hide master-only sections (already hidden via style="display:none")
            // They stay hidden by default
            
            // Agency Admin: show management requests, can switch between managed accounts
            if (currentAccount.role === 'agency_admin') {
                document.querySelectorAll('.agency-only').forEach(el => {
                    el.style.display = 'flex';
                });
                // Agency admins can clear to see all their managed accounts
                const clearBtn = document.getElementById('clearFilterBtn');
                if (clearBtn) clearBtn.style.display = 'block';
            }
            
            // Admin/SubMaster: show Management Requests (so they can see their requests)
            if (currentAccount.role === 'admin' || currentAccount.role === 'submaster_admin') {
                // Show Management Requests for admins (they need to see requests they've made)
                const mgmtRequestsNav = document.querySelector('[data-view="management-requests"]');
                if (mgmtRequestsNav) mgmtRequestsNav.style.display = 'flex';
            }
            
            // Non-master admins: auto-filter to their own account
            selectedAccountId = currentAccount.id;
            selectedAccountName = currentAccount.name;
            
            // Show the filter banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            if (banner && nameEl) {
                banner.style.display = 'flex';
                nameEl.textContent = currentAccount.name;
                
                // Hide the clear button for regular admins (not agency_admin)
                if (currentAccount.role !== 'agency_admin') {
                    const clearBtn = document.getElementById('clearFilterBtn');
                    if (clearBtn) clearBtn.style.display = 'none';
                    
                    // Also hide manage button
                    const manageBtn = document.getElementById('managePlanBtn');
                    if (manageBtn) manageBtn.style.display = 'none';
                }
            }
            
            // Hide "All Accounts" nav item for non-master-admins (but keep section visible)
            const accountsNavItem = document.querySelector('[data-view="accounts"]');
            if (accountsNavItem) {
                accountsNavItem.style.display = 'none';
            }
            
            // Hide Agencies and Clients nav items
            const agenciesNavItem = document.querySelector('[data-view="agencies"]');
            const clientsNavItem = document.querySelector('[data-view="clients"]');
            if (agenciesNavItem) agenciesNavItem.style.display = 'none';
            if (clientsNavItem) clientsNavItem.style.display = 'none';
            
            console.log('Role-based access applied for:', currentAccount.role, '- filtering to account:', selectedAccountId);
        }
        
        function updateUserProfile() {
            if (!currentAccount) return;
            
            const avatarEl = document.getElementById('userAvatar');
            const nameEl = document.getElementById('userName');
            const roleEl = document.getElementById('userRole');
            
            if (avatarEl) {
                avatarEl.textContent = currentAccount.name.charAt(0).toUpperCase();
            }
            if (nameEl) {
                nameEl.textContent = currentAccount.name;
            }
            if (roleEl) {
                const roleLabels = {
                    'master_admin': 'Master Admin',
                    'agency_admin': 'Agency Admin',
                    'submaster_admin': 'Sub Admin',
                    'admin': 'Admin'
                };
                roleEl.textContent = roleLabels[currentAccount.role] || currentAccount.role;
            }
        }
        
        async function handleLogout() {
            const token = localStorage.getItem('gas_token');
            
            try {
                await fetch('/api/accounts/logout', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('gas_token');
            localStorage.removeItem('gas_account');
            window.location.href = '/home.html';
        }
        
        // Helper to sync color text to picker (only when valid hex)
        function syncColorToPicker(textId, pickerId) {
            const text = document.getElementById(textId);
            const picker = document.getElementById(pickerId);
            if (text && picker && /^#[0-9A-Fa-f]{6}$/.test(text.value)) {
                picker.value = text.value;
            }
        }
        
        // Helper to add auth header to fetch requests
        function authHeaders() {
            const token = localStorage.getItem('gas_token');
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        }
        
        // =====================================================
        // GLOBAL STATE
        // =====================================================
        // Global client tracking - uses public_id (UUID) for security
        let currentClientPublicId = null; // UUID or null for all clients
        let clientIdMap = {}; // Maps public_id -> internal id
        
        // Agency filter - when set, all views filter by this agency
        let selectedAgencyId = null;
        let selectedAgencyName = null;
        
        // Account filter (new unified system) - when set, all views filter by this account
        let selectedAccountId = null;
        let selectedWebsiteId = null;
        let selectedDeployedSiteId = null; // NEW: For clean per-site settings
        let selectedWebsiteData = null;
        let availableWebsites = [];
        let deployedSitesCache = [];
        
        // Template-specific defaults
        const templateDefaults = {
            'developer-light': {
                header: {
                    'bg-color': '#ffffff',
                    'text-color': '#1e293b',
                    'logo-color': '#0f172a',
                    'cta-bg': '#2563eb',
                    'cta-text': '#ffffff',
                    'border-color': '#e5e7eb'
                },
                hero: {
                    'overlay-color': '#0f172a',
                    'title-color': '#ffffff',
                    'subtitle-color': '#ffffff'
                },
                intro: {
                    'bg': '#ffffff',
                    'text-color': '#1e293b'
                },
                featured: {
                    'bg': '#f8fafc',
                    'text-color': '#1e293b'
                },
                footer: {
                    'bg-color': '#0f172a',
                    'text-color': '#ffffff'
                },
                styles: {
                    'primary-color': '#2563eb',
                    'secondary-color': '#0f172a',
                    'body-bg': '#ffffff',
                    'text-color': '#1e293b'
                }
            },
            'developer-dark': {
                header: {
                    'bg-color': '#0f172a',
                    'text-color': '#e2e8f0',
                    'logo-color': '#f8fafc',
                    'cta-bg': '#6366f1',
                    'cta-text': '#ffffff',
                    'border-color': '#334155'
                },
                hero: {
                    'overlay-color': '#0f172a',
                    'title-color': '#ffffff',
                    'subtitle-color': '#e2e8f0'
                },
                intro: {
                    'bg': '#1e293b',
                    'text-color': '#e2e8f0'
                },
                featured: {
                    'bg': '#0f172a',
                    'text-color': '#e2e8f0'
                },
                footer: {
                    'bg-color': '#020617',
                    'text-color': '#e2e8f0'
                },
                styles: {
                    'primary-color': '#6366f1',
                    'secondary-color': '#f8fafc',
                    'body-bg': '#0f172a',
                    'text-color': '#e2e8f0'
                }
            }
        };
        
        // Get template defaults for current website
        function getTemplateDefaults(section) {
            const template = selectedWebsiteData?.template || 'developer-light';
            return templateDefaults[template]?.[section] || templateDefaults['developer-light'][section] || {};
        }
        
        // Website selection functions
        async function loadAccountWebsites() {
            if (!selectedAccountId) {
                availableWebsites = [];
                return;
            }
            
            try {
                const response = await fetch(`/api/websites?owner_type=account&owner_id=${selectedAccountId}`);
                const data = await response.json();
                availableWebsites = data.success ? (data.websites || []) : [];
            } catch (error) {
                console.error('Error loading websites:', error);
                availableWebsites = [];
            }
        }
        
        function selectWebsite(websiteId, websiteData = null) {
            console.log('selectWebsite called:', websiteId, websiteData);
            
            selectedWebsiteId = websiteId;
            selectedWebsiteData = websiteData;
            
            // DON'T change selectedAccountId here - it breaks navigation back to master view
            // The website builder sections will use selectedWebsiteId directly
            
            // Update all website selector dropdowns
            document.querySelectorAll('.website-selector-dropdown').forEach(select => {
                select.value = websiteId || '';
            });
            
            // Update the website banner
            updateWebsiteBanner();
            
            // Reload current section if in website builder
            const currentView = document.querySelector('.view[style*="display: block"], .view.active');
            if (currentView && currentView.id.startsWith('wb-')) {
                const section = currentView.id.replace('wb-', '');
                loadWebsiteSection(section);
            }
        }
        
        function updateWebsiteBanner() {
            console.log('updateWebsiteBanner called - selectedWebsiteId:', selectedWebsiteId, 'selectedWebsiteData:', selectedWebsiteData);
            
            const banners = document.querySelectorAll('.website-edit-banner');
            console.log('Found banners:', banners.length);
            
            banners.forEach(banner => {
                if (selectedWebsiteId && selectedWebsiteData) {
                    banner.style.display = 'block';
                    const nameEl = banner.querySelector('.website-name');
                    const urlEl = banner.querySelector('.website-url');
                    const statusEl = banner.querySelector('.website-status');
                    
                    if (nameEl) nameEl.textContent = selectedWebsiteData.name || 'Unnamed Website';
                    if (urlEl) {
                        urlEl.href = selectedWebsiteData.site_url || '#';
                        urlEl.textContent = selectedWebsiteData.site_url || 'No URL';
                        urlEl.style.display = selectedWebsiteData.site_url ? 'inline' : 'none';
                    }
                    if (statusEl) {
                        statusEl.textContent = selectedWebsiteData.status || 'draft';
                        statusEl.className = 'website-status status-' + (selectedWebsiteData.status || 'draft');
                        console.log('Set status to:', selectedWebsiteData.status);
                    }
                } else {
                    banner.style.display = 'none';
                }
            });
            
            // Update selectors
            updateWebsiteSelectors();
        }
        
        function updateWebsiteSelectors() {
            document.querySelectorAll('.website-selector-dropdown').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select Website --</option>';
                
                availableWebsites.forEach(website => {
                    const option = document.createElement('option');
                    option.value = website.id;
                    option.textContent = `${website.name} (${website.status})`;
                    if (website.id == selectedWebsiteId) option.selected = true;
                    select.appendChild(option);
                });
                
                // Add "Create New" option
                const newOption = document.createElement('option');
                newOption.value = 'new';
                newOption.textContent = '+ Create New Website';
                select.appendChild(newOption);
            });
        }
        
        async function onWebsiteSelected(selectElement) {
            const value = selectElement.value;
            
            if (value === 'new') {
                // Open deploy modal or create website modal
                selectElement.value = selectedWebsiteId || '';
                openDeployModal();
                return;
            }
            
            if (value) {
                const website = availableWebsites.find(w => w.id == value);
                selectWebsite(value, website);
            } else {
                selectWebsite(null, null);
            }
        }
        
        function editWebsite(websiteId) {
            console.log('editWebsite called with ID:', websiteId);
            console.log('availableWebsites:', availableWebsites);
            
            // Find the website data from availableWebsites (populated from deployed sites)
            let website = availableWebsites.find(w => w.id == websiteId);
            
            // Fallback to deployedSitesCache if not found
            if (!website && deployedSitesCache.length > 0) {
                const cached = deployedSitesCache.find(s => s.id == websiteId);
                if (cached) {
                    website = {
                        id: cached.id,
                        name: cached.site_name || cached.slug,
                        site_url: cached.site_url,
                        admin_url: cached.admin_url,
                        status: cached.status,
                        account_id: cached.account_id,
                        template: cached.template || 'developer-light'
                    };
                }
            }
            
            console.log('Found website:', website);
            console.log('Website template:', website?.template);
            
            if (website) {
                // Set the deployed site ID for the new clean endpoints
                selectedDeployedSiteId = parseInt(websiteId);
                console.log('Set selectedDeployedSiteId:', selectedDeployedSiteId);
                
                selectWebsite(websiteId, website);
                
                // Note: We do NOT set selectedAccountId here anymore
                // The website editor should use selectedDeployedSiteId for API calls
                // Setting selectedAccountId was causing bugs when returning to Accounts view
                
                // Update editor header with site info
                document.getElementById('editor-site-name').textContent = website.name || 'Website Editor';
                document.getElementById('editor-site-url-display').innerHTML = website.site_url ? 
                    `<a href="${website.site_url}" target="_blank" style="color: #6366f1;">${website.site_url}</a>` : 
                    'Customize your website settings';
                
                // Show preview button if we have a URL
                const previewBtn = document.getElementById('editor-preview-btn');
                if (previewBtn && website.site_url) {
                    previewBtn.href = website.site_url;
                    previewBtn.style.display = 'inline-flex';
                }
                
                // Initialize the editor content
                initializeWebsiteEditor();
                
                // Navigate to the tabbed editor view
                navClick(null, 'website-editor');
            } else {
                // If not in list, show error
                showNotification('Website not found. Try refreshing the page.', 'error');
            }
        }
        
        // Initialize Website Editor - copy content from hidden wb-* views
        function initializeWebsiteEditor() {
            // First, apply template defaults to the SOURCE elements BEFORE cloning
            const template = selectedWebsiteData?.template || 'developer-light';
            console.log('Initializing editor with template:', template);
            
            const allDefaults = templateDefaults[template] || templateDefaults['developer-light'];
            
            // Apply all section defaults to source elements
            Object.keys(allDefaults).forEach(section => {
                const sectionDefaults = allDefaults[section];
                Object.keys(sectionDefaults).forEach(key => {
                    const elId = `wb-${section}-${key}`;
                    const pickerId = `wb-${section}-${key}-picker`;
                    const el = document.getElementById(elId);
                    const pickerEl = document.getElementById(pickerId);
                    if (el) {
                        el.value = sectionDefaults[key];
                        if (pickerEl) pickerEl.value = sectionDefaults[key];
                    }
                });
            });
            
            // Clone content from existing views into editor panels
            const mappings = [
                { source: 'wb-header', target: 'editor-header-content', section: 'header' },
                { source: 'wb-hero', target: 'editor-hero-content', section: 'hero' },
                { source: 'wb-intro', target: 'editor-intro-content', section: 'intro' },
                { source: 'wb-featured', target: 'editor-featured-content', section: 'featured' },
                { source: 'wb-about', target: 'editor-about-content', section: 'about' },
                { source: 'wb-reviews', target: 'editor-reviews-content', section: 'reviews' },
                { source: 'wb-cta', target: 'editor-cta-content', section: 'cta' },
                { source: 'wb-footer', target: 'editor-footer-content', section: 'footer' },
                { source: 'wb-styles', target: 'editor-styles-content', section: 'styles' },
                { source: 'wb-page-about', target: 'editor-page-about-content', section: 'page-about' },
                { source: 'wb-page-gallery', target: 'editor-page-gallery-content', section: 'page-gallery' },
                { source: 'wb-page-blog', target: 'editor-page-blog-content', section: 'page-blog' },
                { source: 'wb-page-attractions', target: 'editor-page-attractions-content', section: 'page-attractions' },
                { source: 'wb-page-dining', target: 'editor-page-dining-content', section: 'page-dining' },
                { source: 'wb-page-contact', target: 'editor-page-contact-content', section: 'page-contact' },
                { source: 'wb-page-terms', target: 'editor-terms-content', section: 'page-terms' },
                { source: 'wb-page-privacy', target: 'editor-privacy-content', section: 'page-privacy' }
            ];
            
            mappings.forEach(map => {
                const sourceEl = document.getElementById(map.source);
                const targetEl = document.getElementById(map.target);
                if (sourceEl && targetEl) {
                    // Get the cards from the source (skip the header)
                    const cards = sourceEl.querySelectorAll('.card');
                    targetEl.innerHTML = '';
                    cards.forEach(card => {
                        const clone = card.cloneNode(true);
                        targetEl.appendChild(clone);
                    });
                }
            });
            
            // Load saved data for the header section (will overwrite defaults if data exists)
            loadWebsiteBuilderSection('header');
        }
        
        // Switch main editor tabs
        function switchEditorTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.editor-tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                    tab.style.color = '#7c3aed';
                    tab.style.borderBottomColor = '#7c3aed';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = '#64748b';
                    tab.style.borderBottomColor = 'transparent';
                }
            });
            
            // Show/hide panels
            document.querySelectorAll('.editor-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const activePanel = document.getElementById('editor-panel-' + tabName);
            if (activePanel) {
                activePanel.style.display = 'block';
            }
            
            // Load data for the selected tab
            const sectionMap = {
                'header': 'header',
                'homepage': 'hero',
                'subpages': 'page-rooms',
                'footer': 'footer',
                'styles': 'styles'
            };
            if (sectionMap[tabName]) {
                loadWebsiteBuilderSection(sectionMap[tabName]);
            }
        }
        
        // Switch Home Page sub-tabs
        function switchHomeSubTab(subTabName) {
            // Update sub-tab buttons
            document.querySelectorAll('#editor-panel-homepage .sub-tab').forEach(tab => {
                if (tab.dataset.subtab === subTabName) {
                    tab.classList.add('active');
                    tab.style.background = '#7c3aed';
                    tab.style.color = 'white';
                } else {
                    tab.classList.remove('active');
                    tab.style.background = 'white';
                    tab.style.color = '#64748b';
                }
            });
            
            // Show/hide sub-panels
            document.querySelectorAll('.home-subtab-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const activePanel = document.getElementById('editor-homepage-' + subTabName);
            if (activePanel) {
                activePanel.style.display = 'block';
            }
            
            // Load data for this section
            loadWebsiteBuilderSection(subTabName);
        }
        
        // Switch Sub Pages tabs
        function switchSubPageTab(subTabName) {
            // Check if user is master_admin AND not viewing a different account
            // If viewing another account, show client experience (restricted)
            const allowedForClients = ['page-rooms', 'page-contact'];
            const isMasterAdmin = currentAccount && currentAccount.role === 'master_admin';
            const isViewingOwnAccount = !selectedAccountId || selectedAccountId === currentAccount.id;
            const hasFullAccess = isMasterAdmin && isViewingOwnAccount;
            
            if (!hasFullAccess && !allowedForClients.includes(subTabName)) {
                // Show Coming Soon for clients or when master is viewing client account
                document.querySelectorAll('#editor-panel-subpages .sub-tab').forEach(tab => {
                    if (tab.dataset.subtab === subTabName) {
                        tab.classList.add('active');
                        tab.style.background = '#7c3aed';
                        tab.style.color = 'white';
                    } else {
                        tab.classList.remove('active');
                        tab.style.background = 'white';
                        tab.style.color = '#64748b';
                    }
                });
                
                document.querySelectorAll('.subpage-panel').forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // Show coming soon panel
                let comingSoonPanel = document.getElementById('editor-subpage-coming-soon');
                if (!comingSoonPanel) {
                    comingSoonPanel = document.createElement('div');
                    comingSoonPanel.id = 'editor-subpage-coming-soon';
                    comingSoonPanel.className = 'subpage-panel';
                    comingSoonPanel.innerHTML = `
                        <div style="text-align: center; padding: 80px 40px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 16px; border: 2px dashed #e2e8f0;">
                            <div style="font-size: 64px; margin-bottom: 20px;">üöß</div>
                            <h2 style="color: #1e293b; margin-bottom: 10px;">Coming Soon</h2>
                            <p style="color: #64748b; max-width: 400px; margin: 0 auto;">This page editor is currently under development. Check back soon for updates!</p>
                        </div>
                    `;
                    document.getElementById('editor-panel-subpages').appendChild(comingSoonPanel);
                }
                comingSoonPanel.style.display = 'block';
                return;
            }
            
            // Update sub-tab buttons
            document.querySelectorAll('#editor-panel-subpages .sub-tab').forEach(tab => {
                if (tab.dataset.subtab === subTabName) {
                    tab.classList.add('active');
                    tab.style.background = '#7c3aed';
                    tab.style.color = 'white';
                } else {
                    tab.classList.remove('active');
                    tab.style.background = 'white';
                    tab.style.color = '#64748b';
                }
            });
            
            // Hide coming soon panel if it exists
            const comingSoonPanel = document.getElementById('editor-subpage-coming-soon');
            if (comingSoonPanel) comingSoonPanel.style.display = 'none';
            
            // Show/hide sub-panels
            document.querySelectorAll('.subpage-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const activePanel = document.getElementById('editor-subpage-' + subTabName);
            if (activePanel) {
                activePanel.style.display = 'block';
            }
            
            // Load data for this section
            loadWebsiteBuilderSection(subTabName);
        }
        
        // Switch Footer tabs
        function switchFooterTab(subTabName) {
            // Update sub-tab buttons
            document.querySelectorAll('#editor-panel-footer .sub-tab').forEach(tab => {
                if (tab.dataset.subtab === subTabName) {
                    tab.classList.add('active');
                    tab.style.background = '#7c3aed';
                    tab.style.color = 'white';
                } else {
                    tab.classList.remove('active');
                    tab.style.background = 'white';
                    tab.style.color = '#64748b';
                }
            });
            
            // Show/hide sub-panels
            document.querySelectorAll('.footer-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const activePanel = document.getElementById('editor-footer-' + subTabName);
            if (activePanel) {
                activePanel.style.display = 'block';
            }
            
            // Load data for this section
            const sectionMap = {
                'footer-main': 'footer',
                'footer-terms': 'page-terms',
                'footer-privacy': 'page-privacy'
            };
            if (sectionMap[subTabName]) {
                loadWebsiteBuilderSection(sectionMap[subTabName]);
            }
        }
        
        // Back to Sites List - clears website selection and returns to Create Sites view
        function backToSitesList() {
            // Clear selected website
            selectedWebsiteId = null;
            selectedWebsiteData = null;
            selectedDeployedSiteId = null;
            
            // Note: Do NOT clear selectedAccountId here - that's the user's account filter
            // If they were viewing a specific account's sites, keep that context
            
            // Navigate back to sites list
            navClick(null, 'deploy-sites');
            
            // Reload the sites list to ensure we see all sites for current account context
            setTimeout(() => loadDeployedSites(), 100);
        }
        
        let selectedAccountName = null;
        
        // Run auth check after global state is declared
        checkAuth();
        
        // Restore nav collapsed states
        restoreNavState();
        
        // Helper function to get account query param
        function getAccountParam() {
            if (selectedAccountId) {
                return `account_id=${selectedAccountId}`;
            }
            return '';
        }
        
        // Helper to build query string with account filter
        function buildQueryString(additionalParams = []) {
            let params = [];
            if (selectedAccountId) {
                params.push(`account_id=${selectedAccountId}`);
            }
            params = params.concat(additionalParams.filter(p => p));
            return params.length > 0 ? '?' + params.join('&') : '';
        }
        
        // Set agency filter
        function setAgencyFilter(agencyId, agencyName) {
            selectedAgencyId = agencyId;
            selectedAgencyName = agencyName;
            
            // Show banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            banner.style.display = 'flex';
            nameEl.textContent = agencyName;
            
            // Reload current view with filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                showView(viewName);
            }
        }
        
        // Clear agency filter
        function clearAgencyFilter() {
            selectedAgencyId = null;
            selectedAgencyName = null;
            
            // Hide banner
            document.getElementById('agencyFilterBanner').style.display = 'none';
            
            // Reload current view without filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                showView(viewName);
            }
        }
        
        // Get current client internal ID for API calls
        function getClientId() {
            if (!currentClientPublicId) return null;
            return clientIdMap[currentClientPublicId] || null;
        }
        
        // Get client ID param for API URLs
        function getClientParam() {
            const clientId = getClientId();
            return clientId ? `client_id=${clientId}` : '';
        }
        
        // Load clients into the selector dropdown
        async function loadClientSelector() {
            try {
                const [clientsRes, agenciesRes] = await Promise.all([
                    fetch('/api/admin/clients'),
                    fetch('/api/admin/agencies')
                ]);
                const clientsData = await clientsRes.json();
                const agenciesData = await agenciesRes.json();
                
                const selector = document.getElementById('globalClientSelector');
                if (!selector) return;
                
                selector.innerHTML = '<option value="">üåê All Clients (Admin View)</option>';
                clientIdMap = {}; // Reset map
                
                const agencies = agenciesData.agencies || [];
                const clients = clientsData.clients || [];
                
                // Add agencies first
                if (agencies.length > 0) {
                    const agencyGroup = document.createElement('optgroup');
                    agencyGroup.label = 'üè¢ Agencies';
                    agencies.forEach(agency => {
                        const option = document.createElement('option');
                        option.value = `agency_${agency.id}`;
                        option.textContent = agency.name;
                        agencyGroup.appendChild(option);
                    });
                    selector.appendChild(agencyGroup);
                }
                
                // Add direct clients (API already filters out agencies)
                if (clients.length > 0) {
                    const clientGroup = document.createElement('optgroup');
                    clientGroup.label = 'üë§ Direct Clients';
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        const publicId = client.public_id || client.id;
                        option.value = publicId;
                        option.textContent = client.business_name || client.name || 'Client';
                        clientGroup.appendChild(option);
                        clientIdMap[publicId] = client.id;
                    });
                    selector.appendChild(clientGroup);
                }
                
                // Check URL for client parameter and select it
                const urlParams = new URLSearchParams(window.location.search);
                const urlClientId = urlParams.get('client');
                if (urlClientId && clientIdMap[urlClientId]) {
                    selector.value = urlClientId;
                    switchClient(urlClientId, false);
                }
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }
        
        // Switch to a different client
        function switchClient(publicId, updateUrl = true) {
            currentClientPublicId = publicId || null;
            
            // Update URL so it's bookmarkable/shareable
            if (updateUrl) {
                const url = new URL(window.location);
                if (publicId) {
                    url.searchParams.set('client', publicId);
                } else {
                    url.searchParams.delete('client');
                }
                window.history.pushState({}, '', url);
            }
            
            // Update indicator
            const indicator = document.getElementById('clientIndicator');
            const indicatorText = document.getElementById('clientIndicatorText');
            
            if (!currentClientPublicId) {
                indicator.className = 'client-indicator all-clients';
                indicatorText.textContent = 'Viewing all clients';
            } else {
                indicator.className = 'client-indicator';
                const selector = document.getElementById('globalClientSelector');
                const selectedOption = selector.options[selector.selectedIndex];
                indicatorText.textContent = '‚úì ' + selectedOption.textContent;
            }
            
            // Reload current view with new client context
            const activeNav = document.querySelector('.nav-item.active');
            if (activeNav) {
                const viewName = activeNav.dataset.view;
                showView(viewName);
            }
        }
        
        // Simple navigation click handler
        // Toggle nav section collapse/expand
        function toggleNavSection(labelEl) {
            const section = labelEl.closest('.nav-section');
            section.classList.toggle('collapsed');
            
            // Save collapsed state to localStorage
            saveNavState();
        }
        
        // Toggle sub-section dropdowns (Home Page, Sub Pages)
        function toggleSubSection(toggleEl) {
            const subsection = toggleEl.closest('.nav-subsection');
            const items = subsection.querySelector('.nav-subsection-items');
            const arrow = subsection.querySelector('.nav-subsection-arrow');
            
            if (items.style.display === 'none') {
                items.style.display = 'block';
                arrow.textContent = '‚ñæ';
                subsection.classList.add('expanded');
            } else {
                items.style.display = 'none';
                arrow.textContent = '‚ñ∏';
                subsection.classList.remove('expanded');
            }
        }
        
        // Save nav collapsed states
        function saveNavState() {
            const sections = document.querySelectorAll('.nav-section');
            const states = {};
            sections.forEach((section, index) => {
                const label = section.querySelector('.nav-label');
                if (label) {
                    states[label.textContent.trim()] = section.classList.contains('collapsed');
                }
            });
            localStorage.setItem('gas_nav_states', JSON.stringify(states));
        }
        
        // Restore nav collapsed states
        function restoreNavState() {
            try {
                const states = JSON.parse(localStorage.getItem('gas_nav_states') || '{}');
                document.querySelectorAll('.nav-section').forEach(section => {
                    const label = section.querySelector('.nav-label');
                    if (label && states[label.textContent.trim()] !== undefined) {
                        if (states[label.textContent.trim()]) {
                            section.classList.add('collapsed');
                        } else {
                            section.classList.remove('collapsed');
                        }
                    }
                });
            } catch (e) {
                console.error('Error restoring nav state:', e);
            }
        }
        
        function navClick(el, viewName) {
            // Update active state
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if (el) {
                el.classList.add('active');
                
                // Expand the section if it's collapsed
                const section = el.closest('.nav-section');
                if (section && section.classList.contains('collapsed')) {
                    section.classList.remove('collapsed');
                    saveNavState();
                }
            } else {
                // Find and activate the nav item for this view
                const navItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                    const section = navItem.closest('.nav-section');
                    if (section && section.classList.contains('collapsed')) {
                        section.classList.remove('collapsed');
                        saveNavState();
                    }
                }
            }
            
            // Show the view
            showView(viewName);
        }

        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            // Show requested view
            const viewEl = document.getElementById(viewName);
            if (viewEl) {
                viewEl.classList.add('active');
            } else {
                console.error('View not found:', viewName);
                return;
            }
            
            // Load data for specific views
            if (viewName === 'dashboard') loadDashboard();
            if (viewName === 'my-account') loadMyAccount();
            if (viewName === 'management-requests') loadManagementRequests();
            if (viewName === 'accounts') loadAccounts();
            if (viewName === 'agencies') loadAgencies();
            if (viewName === 'clients') loadClients();
            if (viewName === 'properties') loadProperties();
            if (viewName === 'rooms') loadRooms();
            if (viewName === 'images') loadImages();
            if (viewName === 'amenities') loadAmenities();
            if (viewName === 'availability') loadAvailabilityView();
            if (viewName === 'tasks') loadTasks();
            if (viewName === 'deploy-sites') {
                checkVpsStatus();
                loadDeployedSites();
            }
            if (viewName === 'integrations') loadIntegrations();
            if (viewName === 'offers') loadOffers();
            if (viewName === 'vouchers') loadVouchers();
            if (viewName === 'upsells') loadUpsells();
            if (viewName === 'vendors') { loadVendors(); loadServiceRequests(); }
            if (viewName === 'fees') loadFees();
            if (viewName === 'taxes') loadTaxes();
            if (viewName === 'payments') initPaymentsView();
            if (viewName === 'deposit-rules') initDepositRulesView();
            if (viewName === 'bookings') loadBookings();
            if (viewName === 'marketing') loadMarketingProperties();
            if (viewName === 'wb-header') loadWebsiteSection('header');
            if (viewName === 'wb-hero') loadWebsiteSection('hero');
            if (viewName === 'wb-intro') loadWebsiteSection('intro');
            if (viewName === 'wb-featured') loadWebsiteSection('featured');
            if (viewName === 'wb-about') loadWebsiteSection('about');
            if (viewName === 'wb-reviews') {
                loadWebsiteSection('reviews');
                // Check if user has reviews_widget feature
                const features = accountEntitlements?.features || {};
                const hasReviews = features.reviews_widget === true;
                const upgradeBanner = document.getElementById('wb-reviews-upgrade-banner');
                const content = document.getElementById('wb-reviews-content');
                const saveBtn = document.getElementById('wb-reviews-save-btn');
                if (upgradeBanner && content) {
                    if (hasReviews) {
                        upgradeBanner.style.display = 'none';
                        content.style.display = 'block';
                        if (saveBtn) saveBtn.style.display = 'block';
                    } else {
                        upgradeBanner.style.display = 'block';
                        content.style.display = 'none';
                        if (saveBtn) saveBtn.style.display = 'none';
                    }
                }
            }
            if (viewName === 'wb-cta') loadWebsiteSection('cta');
            if (viewName === 'wb-footer') loadWebsiteSection('footer');
            if (viewName === 'wb-styles') loadWebsiteSection('styles');
            
            // Sub Pages
            if (viewName === 'wb-page-about') loadSubPage('about');
            if (viewName === 'wb-page-gallery') loadSubPage('gallery');
            if (viewName === 'wb-page-blog') loadSubPage('blog');
            if (viewName === 'wb-page-attractions') loadSubPage('attractions');
            if (viewName === 'wb-page-dining') loadSubPage('dining');
            if (viewName === 'wb-page-contact') {
                loadSubPage('contact');
                // Also populate contact info from footer settings
                setTimeout(() => {
                    const footerEmail = document.getElementById('wb-footer-email')?.value;
                    const footerPhone = document.getElementById('wb-footer-phone')?.value;
                    const footerAddress = document.getElementById('wb-footer-address')?.value;
                    if (footerEmail) document.getElementById('wb-page-contact-email').value = footerEmail;
                    if (footerPhone) document.getElementById('wb-page-contact-phone').value = footerPhone;
                    if (footerAddress) document.getElementById('wb-page-contact-address').value = footerAddress;
                }, 100);
            }
            if (viewName === 'wb-page-terms') loadSubPage('terms');
            if (viewName === 'wb-page-privacy') loadSubPage('privacy');
            
            if (viewName === 'wordpress') loadWordPressView();
            
            // GasSync views
            if (viewName === 'gas-sync-dashboard') loadGasSyncDashboard();
            if (viewName === 'gas-sync-connections') loadGasSyncConnections();
            if (viewName === 'client-connection-view') loadClientConnectionView();
            if (viewName === 'gas-sync-properties') { loadGasSyncConnections().then(() => loadSyncedProperties()); }
            if (viewName === 'gas-sync-logs') { loadGasSyncConnections().then(() => loadSyncLogs()); }
            
            // New sidebar views
            if (viewName === 'app-blog') loadAppBlogPosts();
            if (viewName === 'app-attractions') loadAppAttractions();
            if (viewName === 'api-docs') {
                const urlInput = document.getElementById('api-docs-base-url');
                if (urlInput) urlInput.value = window.location.origin;
                loadApiKeys();
            }
            
            // Website Builder views
            if (viewName.startsWith('wb-')) {
                const section = viewName.replace('wb-', '');
                loadWebsiteSection(section);
            }
        }

        // =========================================================
        // WEBSITE BUILDER FUNCTIONS
        // =========================================================
        
        async function loadWebsiteBuilderSection(section) {
            try {
                // Determine which container to update - editor panel (visible) or original view
                const editorPanelMap = {
                    'header': 'editor-header-content',
                    'hero': 'editor-hero-content',
                    'intro': 'editor-intro-content',
                    'featured': 'editor-featured-content',
                    'about': 'editor-about-content',
                    'reviews': 'editor-reviews-content',
                    'cta': 'editor-cta-content',
                    'footer': 'editor-footer-content',
                    'styles': 'editor-styles-content',
                    'page-about': 'editor-page-about-content',
                    'page-gallery': 'editor-page-gallery-content',
                    'page-blog': 'editor-page-blog-content',
                    'page-attractions': 'editor-page-attractions-content',
                    'page-dining': 'editor-page-dining-content',
                    'page-contact': 'editor-page-contact-content',
                    'page-terms': 'editor-terms-content',
                    'page-privacy': 'editor-privacy-content'
                };
                
                // Get container for this section
                const editorContainerId = editorPanelMap[section];
                const editorContainer = editorContainerId ? document.getElementById(editorContainerId) : null;
                
                // Helper to get element - prefer editor container if visible
                const getEl = (id) => {
                    if (editorContainer) {
                        const el = editorContainer.querySelector(`[id="${id}"]`);
                        if (el) return el;
                    }
                    return document.getElementById(id);
                };
                
                // Get template defaults for this section
                const template = selectedWebsiteData?.template || 'developer-light';
                const defaults = getTemplateDefaults(section);
                console.log(`Loading section "${section}" with template "${template}"`, defaults);
                
                // Apply template defaults first (will be overwritten by saved values)
                Object.keys(defaults).forEach(key => {
                    const elId = `wb-${section}-${key}`;
                    const pickerId = `wb-${section}-${key}-picker`;
                    const el = getEl(elId);
                    const pickerEl = getEl(pickerId);
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = defaults[key];
                        } else {
                            el.value = defaults[key];
                        }
                        if (pickerEl) pickerEl.value = defaults[key];
                    }
                });
                
                // Use NEW clean endpoint for deployed sites
                let data = null;
                
                if (selectedDeployedSiteId) {
                    // PRIMARY: Use new per-deployed-site endpoint
                    try {
                        const response = await fetch(`/api/deployed-sites/${selectedDeployedSiteId}/settings/${section}`);
                        data = await response.json();
                        console.log(`Deployed site ${selectedDeployedSiteId} settings response:`, data);
                    } catch (e) {
                        console.error('Failed to load from deployed site endpoint:', e);
                    }
                }
                
                // Apply saved settings if we got any
                if (data && data.success && data.settings) {
                    console.log(`Applying saved ${section} settings from source: ${data.source}`);
                    Object.keys(data.settings).forEach(key => {
                        const el = getEl(`wb-${section}-${key}`);
                        const pickerEl = getEl(`wb-${section}-${key}-picker`);
                        if (el) {
                            if (el.type === 'checkbox') {
                                // Handle boolean values properly
                                el.checked = data.settings[key] === true || data.settings[key] === 'true' || data.settings[key] === '1' || data.settings[key] === 1;
                            } else if (el.type === 'color' || el.classList.contains('color-input')) {
                                el.value = data.settings[key] || el.value;
                                if (pickerEl) pickerEl.value = data.settings[key] || pickerEl.value;
                            } else {
                                el.value = data.settings[key] ?? '';
                            }
                        }
                    });
                    
                    // Handle image preview
                    if (data.settings.image) {
                        const preview = getEl(`wb-${section}-image-preview`);
                        if (preview) {
                            preview.innerHTML = `<img src="${data.settings.image}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
                        }
                    }
                } else {
                    console.log(`No saved ${section} settings, using template defaults`);
                }
            } catch (error) {
                console.error('Error loading website builder section:', error);
            }
        }
        
        async function saveWebsiteSection(section, buttonEl = null) {
            // Find the save button if not passed
            const saveBtn = buttonEl || document.querySelector(`button[onclick*="saveWebsiteSection('${section}', this)"]`);
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            
            try {
                // Show loading state
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '‚è≥ Saving...';
                    saveBtn.style.opacity = '0.7';
                }
                
                // Must have a deployed site selected
                if (!selectedDeployedSiteId) {
                    showNotification('Please select a website to edit first', 'error');
                    return;
                }
                
                // Collect all form values from the VISIBLE editor container
                const settings = {};
                const prefix = `wb-${section}-`;
                
                const editorPanelMap = {
                    'header': 'editor-header-content',
                    'hero': 'editor-hero-content',
                    'intro': 'editor-intro-content',
                    'featured': 'editor-featured-content',
                    'about': 'editor-about-content',
                    'reviews': 'editor-reviews-content',
                    'cta': 'editor-cta-content',
                    'footer': 'editor-footer-content',
                    'styles': 'editor-styles-content',
                    'page-about': 'editor-page-about-content',
                    'page-gallery': 'editor-page-gallery-content',
                    'page-blog': 'editor-page-blog-content',
                    'page-attractions': 'editor-page-attractions-content',
                    'page-dining': 'editor-page-dining-content',
                    'page-contact': 'editor-page-contact-content',
                    'page-terms': 'editor-terms-content',
                    'page-privacy': 'editor-privacy-content'
                };
                
                const editorContainerId = editorPanelMap[section];
                let editorContainer = editorContainerId ? document.getElementById(editorContainerId) : null;
                
                // Collect from editor container (visible elements)
                let elementsToCheck = editorContainer 
                    ? editorContainer.querySelectorAll(`[id^="${prefix}"]`)
                    : document.querySelectorAll(`[id^="${prefix}"]`);
                
                // Fallback: if no elements found in editor container, search in wb-{section}-content or whole document
                if (elementsToCheck.length === 0) {
                    const altContainer = document.getElementById(`wb-${section}-content`);
                    if (altContainer) {
                        elementsToCheck = altContainer.querySelectorAll(`[id^="${prefix}"]`);
                    }
                    if (elementsToCheck.length === 0) {
                        elementsToCheck = document.querySelectorAll(`[id^="${prefix}"]`);
                    }
                }
                
                elementsToCheck.forEach(el => {
                    const key = el.id.replace(prefix, '');
                    if (key.endsWith('-picker') || key.endsWith('-value') || key.endsWith('-preview')) {
                        return;
                    }
                    if (el.type === 'checkbox') {
                        settings[key] = el.checked;
                    } else if (el.type === 'file') {
                        // Skip file inputs
                    } else if (el.value !== undefined) {
                        settings[key] = el.value;
                    }
                });
                
                console.log(`Saving ${section} for deployed site ${selectedDeployedSiteId}:`, settings);
                
                // Use NEW clean endpoint
                if (saveBtn) saveBtn.innerHTML = '‚è≥ Saving to database...';
                
                const response = await fetch(`/api/deployed-sites/${selectedDeployedSiteId}/settings/${section}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ settings })
                });
                
                const data = await response.json();
                console.log('Save response:', data);
                
                if (data.success) {
                    // Check WordPress push result
                    if (data.wordpress_push) {
                        if (data.wordpress_push.success) {
                            showNotification('‚úÖ Saved and synced to WordPress!', 'success');
                        } else {
                            console.warn('WordPress sync failed:', data.wordpress_push.error);
                            showNotification('‚úÖ Saved! WordPress sync: ' + (data.wordpress_push.error || 'pending'), 'warning');
                        }
                    } else {
                        showNotification('‚úÖ Settings saved!', 'success');
                    }
                } else {
                    showNotification('Error: ' + (data.error || 'Failed to save'), 'error');
                }
                
            } catch (error) {
                console.error('Error saving website section:', error);
                showNotification('Error saving. Please try again.', 'error');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.opacity = '1';
                }
            }
        }
        
        async function loadWebsiteSection(section) {
            const websiteId = selectedWebsiteId;
            const accountId = selectedAccountId;
            
            // Update website selectors when loading a section
            updateWebsiteSelectors();
            
            // Try to load from per-website endpoint first, fallback to account-based
            let data = null;
            
            if (websiteId) {
                try {
                    const response = await fetch(`/api/websites/${websiteId}/builder/${section}`);
                    data = await response.json();
                    console.log(`Loaded section ${section} for website ${websiteId}:`, data);
                } catch (error) {
                    console.log(`Per-website load failed for ${section}, trying account-based...`);
                }
            }
            
            // Fallback to account-based if no website data
            if ((!data || !data.settings) && accountId) {
                try {
                    const response = await fetch(`/api/admin/website-builder/${section}?account_id=${accountId}`);
                    data = await response.json();
                    console.log(`Loaded section ${section} for account ${accountId}:`, data);
                } catch (error) {
                    console.error(`Account-based load also failed for ${section}:`, error);
                }
            }
            
            if (!data || !data.success) {
                console.log(`No settings found for section ${section}`);
                return;
            }
            
            if (data.settings) {
                const prefix = `wb-${section}-`;
                Object.entries(data.settings).forEach(([key, value]) => {
                    const el = document.getElementById(`${prefix}${key}`);
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = value;
                        } else if (el.type !== 'file') {
                            el.value = value;
                        }
                    }
                });
                
                // Update image preview if image-url exists
                if (data.settings['image-url']) {
                    const preview = document.getElementById(`wb-${section}-image-preview`);
                    if (preview) {
                        preview.style.backgroundImage = `url(${data.settings['image-url']})`;
                        preview.style.backgroundSize = 'cover';
                        preview.style.backgroundPosition = 'center';
                        preview.innerHTML = '';
                    }
                }
                
                // Sync color pickers with their text inputs
                Object.entries(data.settings).forEach(([key, value]) => {
                    if (value && typeof value === 'string') {
                        // Check if it looks like a hex color (with or without #)
                        const hexMatch = value.match(/^#?([0-9A-Fa-f]{6})$/);
                        if (hexMatch) {
                            const hexColor = '#' + hexMatch[1];
                            const picker = document.getElementById(`${prefix}${key}-picker`);
                            const textInput = document.getElementById(`${prefix}${key}`);
                            if (picker) {
                                picker.value = hexColor;
                            }
                            // Also ensure text input has # prefix
                            if (textInput && !textInput.value.startsWith('#')) {
                                textInput.value = hexColor;
                            }
                        }
                    }
                });
                
                // Update range slider value displays
                const rangeKeys = ['search-opacity', 'search-radius', 'search-padding', 'search-max-width', 'search-scale',
                                   'overlay', 'height', 'font-size', 'title-size', 'text-size', 'max-width', 'btn-radius', 'body-size'];
                rangeKeys.forEach(key => {
                    const valueEl = document.getElementById(`wb-${section}-${key}-value`);
                    if (valueEl && data.settings[key]) {
                        valueEl.textContent = data.settings[key];
                    }
                });
            }
        }
        
        let currentSiteUrl = null;
        
        async function loadSiteBanner() {
            const accountId = selectedAccountId;
            if (!accountId) return;
            
            try {
                const response = await fetch(`/api/account/${accountId}/website`);
                const data = await response.json();
                
                const banner = document.getElementById('wb-site-banner');
                const previewBtn = document.getElementById('wb-preview-btn');
                const urlLink = document.getElementById('wb-site-url');
                
                if (data.success && data.data?.site_url) {
                    currentSiteUrl = data.data.site_url;
                    if (banner) {
                        banner.style.display = 'block';
                        urlLink.href = currentSiteUrl;
                        urlLink.textContent = currentSiteUrl;
                    }
                    if (previewBtn) previewBtn.style.display = 'flex';
                } else {
                    if (banner) banner.style.display = 'none';
                    if (previewBtn) previewBtn.style.display = 'none';
                    currentSiteUrl = null;
                }
            } catch (error) {
                console.error('Error loading site info:', error);
            }
        }
        
        function openSitePreview() {
            if (currentSiteUrl) {
                window.open(currentSiteUrl, '_blank');
            } else {
                alert('No website configured for this account. Create one in the WordPress section.');
            }
        }
        
        async function pushToWordPress(section, settings) {
            const accountId = selectedAccountId;
            const siteUrl = selectedWebsiteData?.site_url;
            
            console.log('pushToWordPress called:', { accountId, section, siteUrl, settings });
            
            if (!siteUrl) {
                console.log('No site_url available, skipping push');
                return;
            }
            
            try {
                // Push settings to WordPress via our API
                console.log('Pushing to WordPress via /api/admin/push-to-wordpress...');
                const response = await fetch('/api/admin/push-to-wordpress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: accountId,
                        section,
                        settings,
                        site_url: siteUrl
                    })
                });
                
                const result = await response.json();
                console.log('Push to WordPress result:', result);
                
                if (!result.success) {
                    console.error('Push to WordPress failed:', result.error);
                }
            } catch (error) {
                console.error('Could not push to WordPress:', error);
            }
        }
        
        // =====================================================
        // SUB PAGES FUNCTIONS
        // =====================================================
        
        async function saveSubPage(pageName) {
            try {
                const accountId = selectedAccountId;
                if (!accountId) {
                    alert('Please select an account first');
                    return;
                }
                
                const settings = {};
                const prefix = `wb-page-${pageName}`;
                
                // Collect all inputs for this page
                document.querySelectorAll(`[id^="${prefix}"]`).forEach(el => {
                    const key = el.id.replace(prefix + '-', '');
                    if (el.type === 'checkbox') {
                        settings[key] = el.checked;
                    } else if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        settings[key] = el.value;
                    }
                });
                
                console.log(`Saving sub page ${pageName}:`, JSON.stringify(settings, null, 2));
                
                const response = await fetch(`/api/admin/website-builder/page/${pageName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: accountId,
                        settings: settings
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(`${pageName.charAt(0).toUpperCase() + pageName.slice(1)} page saved!`, 'success');
                } else {
                    showNotification('Error saving page: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error saving sub page:', error);
                showNotification('Error saving page', 'error');
            }
        }
        
        async function loadSubPage(pageName) {
            try {
                const accountId = selectedAccountId;
                if (!accountId) return;
                
                const response = await fetch(`/api/admin/website-builder/page/${pageName}?account_id=${accountId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const settings = data.data;
                    const prefix = `wb-page-${pageName}`;
                    
                    Object.keys(settings).forEach(key => {
                        const el = document.getElementById(`${prefix}-${key}`);
                        if (el) {
                            if (el.type === 'checkbox') {
                                el.checked = settings[key];
                            } else {
                                el.value = settings[key] || '';
                            }
                            
                            // Handle image previews
                            if (key.endsWith('-url') && settings[key]) {
                                const previewId = el.id.replace('-url', '-preview');
                                const preview = document.getElementById(previewId);
                                if (preview) {
                                    preview.style.backgroundImage = `url(${settings[key]})`;
                                    preview.innerHTML = '';
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading sub page:', error);
            }
        }
        
        function previewSubPageImage(pageName, imageType) {
            const input = document.getElementById(`wb-page-${pageName}-${imageType}`);
            const preview = document.getElementById(`wb-page-${pageName}-${imageType}-preview`);
            const urlField = document.getElementById(`wb-page-${pageName}-${imageType}-url`);
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.innerHTML = '';
                    
                    // Upload the image
                    const formData = new FormData();
                    formData.append('image', file);
                    formData.append('account_id', selectedAccountId);
                    formData.append('type', `page-${pageName}-${imageType}`);
                    
                    try {
                        const response = await fetch('/api/admin/website-builder/upload-image', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        if (data.success && data.url) {
                            urlField.value = data.url;
                            showNotification('Image uploaded!', 'success');
                        }
                    } catch (error) {
                        console.error('Error uploading image:', error);
                    }
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        async function previewWebsiteImage(section) {
            const input = document.getElementById(`wb-${section}-image`);
            const preview = document.getElementById(`wb-${section}-image-preview`);
            const urlField = document.getElementById(`wb-${section}-image-url`);
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Show preview immediately
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.style.backgroundSize = 'cover';
                    preview.style.backgroundPosition = 'center';
                    preview.innerHTML = '<span style="background: rgba(0,0,0,0.5); color: white; padding: 8px 16px; border-radius: 4px;">Uploading...</span>';
                };
                reader.readAsDataURL(file);
                
                // Upload to server
                const accountId = selectedAccountId;
                if (!accountId) {
                    alert('Please select an account first');
                    return;
                }
                
                const formData = new FormData();
                formData.append('image', file);
                formData.append('account_id', accountId);
                formData.append('section', section);
                
                try {
                    const response = await fetch('/api/admin/website-builder/upload-image', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.url) {
                        // Fill the URL field
                        if (urlField) {
                            urlField.value = data.url;
                        }
                        preview.innerHTML = '<span style="background: rgba(16,185,129,0.9); color: white; padding: 8px 16px; border-radius: 4px;">‚úì Uploaded</span>';
                        setTimeout(() => {
                            preview.innerHTML = '';
                        }, 2000);
                    } else {
                        preview.innerHTML = '<span style="background: rgba(239,68,68,0.9); color: white; padding: 8px 16px; border-radius: 4px;">Upload failed</span>';
                        alert('Upload failed: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    preview.innerHTML = '<span style="background: rgba(239,68,68,0.9); color: white; padding: 8px 16px; border-radius: 4px;">Upload error</span>';
                    alert('Upload error: ' + error.message);
                }
            }
        }
        
        function addWebsiteReview() {
            const container = document.getElementById('wb-reviews-list');
            const reviewId = Date.now();
            
            container.innerHTML += `
                <div class="review-item" id="review-${reviewId}" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Guest Name</label>
                        <input type="text" class="form-input review-name" placeholder="e.g., John D.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Review Text</label>
                        <textarea class="form-textarea review-text" rows="2" placeholder="Their testimonial..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rating</label>
                        <select class="form-select review-rating">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (3 stars)</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="document.getElementById('review-${reviewId}').remove()">üóëÔ∏è Remove</button>
                </div>
            `;
        }

        // =========================================================
        // AGENCY MANAGEMENT FUNCTIONS
        // =========================================================

        // =====================================================
        // ACCOUNTS MANAGEMENT (New unified system)
        // =====================================================
        // MY ACCOUNT FUNCTIONS
        // =====================================================
        
        async function loadMyAccount() {
            try {
                const response = await fetch('/api/accounts/me', { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.account) {
                    const account = data.account;
                    
                    // Update avatar and name display
                    const initial = (account.name || 'U').charAt(0).toUpperCase();
                    document.getElementById('myAccountAvatar').textContent = initial;
                    document.getElementById('myAccountName').textContent = account.name || 'Unknown';
                    document.getElementById('myAccountRole').textContent = formatRole(account.role);
                    
                    // Fill form fields
                    document.getElementById('myAccountNameInput').value = account.name || '';
                    document.getElementById('myAccountEmail').value = account.email || '';
                    document.getElementById('myAccountPhone').value = account.phone || '';
                    document.getElementById('myAccountBusiness').value = account.business_name || '';
                    
                    // Account info
                    document.getElementById('myAccountId').textContent = account.id;
                    document.getElementById('myAccountCode').textContent = account.account_code || 'Not set';
                    document.getElementById('myAccountRoleInfo').textContent = formatRole(account.role);
                    document.getElementById('myAccountStatus').textContent = account.status || 'active';
                    
                    // Show master admin section if applicable
                    if (account.role === 'master_admin') {
                        document.getElementById('createMasterAdminSection').style.display = 'block';
                        loadMasterAdmins();
                    } else {
                        document.getElementById('createMasterAdminSection').style.display = 'none';
                    }
                    
                    // Show agency management section for Admin and SubMaster
                    if (account.role === 'admin' || account.role === 'submaster_admin') {
                        document.getElementById('agencyManagementSection').style.display = 'block';
                        loadAgencyManagementStatus(account);
                    } else {
                        document.getElementById('agencyManagementSection').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading my account:', error);
                showNotification('Error loading account details', 'error');
            }
        }
        
        // Load agency management status and available agencies
        async function loadAgencyManagementStatus(account) {
            try {
                // Load available agencies for the dropdown
                const agenciesRes = await fetch('/api/agencies/available', { headers: authHeaders() });
                const agenciesData = await agenciesRes.json();
                
                const agencySelect = document.getElementById('agencySelect');
                agencySelect.innerHTML = '<option value="">Choose an agency...</option>';
                
                if (agenciesData.success && agenciesData.agencies) {
                    agenciesData.agencies.forEach(agency => {
                        const option = document.createElement('option');
                        option.value = agency.id;
                        option.textContent = agency.business_name || agency.name;
                        agencySelect.appendChild(option);
                    });
                }
                
                // Check current management status
                if (account.managed_by_id) {
                    // Currently managed by an agency
                    const managingAgency = agenciesData.agencies?.find(a => a.id === account.managed_by_id);
                    document.getElementById('managementStatusIcon').textContent = 'üè¢';
                    document.getElementById('managementStatusIcon').style.background = '#dbeafe';
                    document.getElementById('managementStatusTitle').textContent = 'Managed by Agency';
                    document.getElementById('managementStatusDesc').textContent = `Your account is managed by ${managingAgency?.business_name || managingAgency?.name || 'an agency'}`;
                    document.getElementById('removeManagementBtn').style.display = 'block';
                    document.getElementById('selectAgencyForm').style.display = 'none';
                    document.getElementById('pendingRequestBanner').style.display = 'none';
                } else {
                    // Self-managed - check for pending requests
                    const requestsRes = await fetch(`/api/management-requests?account_id=${account.id}&role=requester`, { headers: authHeaders() });
                    const requestsData = await requestsRes.json();
                    
                    const pendingRequest = requestsData.requests?.find(r => r.status === 'pending');
                    
                    if (pendingRequest) {
                        document.getElementById('pendingRequestBanner').style.display = 'block';
                        document.getElementById('pendingRequestAgency').textContent = `Awaiting response from ${pendingRequest.agency_business || pendingRequest.agency_name}`;
                        document.getElementById('selectAgencyForm').style.display = 'none';
                        
                        // Store pending request ID for cancellation
                        document.getElementById('pendingRequestBanner').dataset.requestId = pendingRequest.id;
                    } else {
                        document.getElementById('pendingRequestBanner').style.display = 'none';
                        document.getElementById('selectAgencyForm').style.display = 'block';
                    }
                    
                    document.getElementById('managementStatusIcon').textContent = 'üë§';
                    document.getElementById('managementStatusIcon').style.background = '#e5e7eb';
                    document.getElementById('managementStatusTitle').textContent = 'Self-Managed';
                    document.getElementById('managementStatusDesc').textContent = 'You are managing your own account';
                    document.getElementById('removeManagementBtn').style.display = 'none';
                    
                    // Show request history
                    renderMyManagementRequests(requestsData.requests || []);
                }
            } catch (error) {
                console.error('Error loading agency management status:', error);
            }
        }
        
        function renderMyManagementRequests(requests) {
            const container = document.getElementById('myManagementRequests');
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9rem;">No previous requests</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Agency</th>
                                <th>Status</th>
                                <th>Requested</th>
                                <th>Response</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${requests.map(req => `
                                <tr>
                                    <td><strong>${req.agency_business || req.agency_name}</strong></td>
                                    <td>${getRequestStatusBadge(req.status)}</td>
                                    <td>${new Date(req.requested_at).toLocaleDateString()}</td>
                                    <td>${req.response_message || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function getRequestStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge" style="background: #fef3c7; color: #92400e;">‚è≥ Pending</span>',
                'approved': '<span class="badge badge-success">‚úÖ Approved</span>',
                'rejected': '<span class="badge" style="background: #fee2e2; color: #dc2626;">‚ùå Rejected</span>',
                'cancelled': '<span class="badge badge-secondary">Cancelled</span>'
            };
            return badges[status] || status;
        }
        
        async function requestAgencyManagement() {
            const agencyId = document.getElementById('agencySelect').value;
            
            if (!agencyId) {
                showNotification('Please select an agency', 'error');
                return;
            }
            
            try {
                // Get current account ID
                const meRes = await fetch('/api/accounts/me', { headers: authHeaders() });
                const meData = await meRes.json();
                
                if (!meData.success) {
                    showNotification('Could not verify account', 'error');
                    return;
                }
                
                const response = await fetch('/api/management-requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        requesting_account_id: meData.account.id,
                        agency_id: parseInt(agencyId),
                        message: 'Request to manage my account'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Request sent successfully', 'success');
                    loadMyAccount(); // Refresh the view
                } else {
                    showNotification(data.error || 'Error sending request', 'error');
                }
            } catch (error) {
                console.error('Error requesting management:', error);
                showNotification('Error sending request', 'error');
            }
        }
        
        async function cancelManagementRequest() {
            const requestId = document.getElementById('pendingRequestBanner').dataset.requestId;
            
            if (!requestId) {
                showNotification('No pending request found', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/management-requests/${requestId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status: 'cancelled' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Request cancelled', 'success');
                    loadMyAccount();
                } else {
                    showNotification(data.error || 'Error cancelling request', 'error');
                }
            } catch (error) {
                showNotification('Error cancelling request', 'error');
            }
        }
        
        async function removeAgencyManagement() {
            if (!confirm('Are you sure you want to remove agency management? You will manage your own account again.')) {
                return;
            }
            
            try {
                const meRes = await fetch('/api/accounts/me', { headers: authHeaders() });
                const meData = await meRes.json();
                
                const response = await fetch(`/api/accounts/${meData.account.id}/remove-management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Now self-managed', 'success');
                    loadMyAccount();
                } else {
                    showNotification(data.error || 'Error removing management', 'error');
                }
            } catch (error) {
                showNotification('Error removing management', 'error');
            }
        }
        
        function formatRole(role) {
            const roles = {
                'master_admin': 'üëë Master Admin',
                'agency_admin': 'üè¢ Agency Admin',
                'submaster_admin': 'üìÅ Sub Master',
                'admin': 'üë§ Admin',
                'travel_agent': '‚úàÔ∏è Travel Agent'
            };
            return roles[role] || role;
        }
        
        async function saveMyProfile() {
            const name = document.getElementById('myAccountNameInput').value.trim();
            const email = document.getElementById('myAccountEmail').value.trim();
            const phone = document.getElementById('myAccountPhone').value.trim();
            const business_name = document.getElementById('myAccountBusiness').value.trim();
            
            if (!name || !email) {
                showNotification('Name and email are required', 'error');
                return;
            }
            
            try {
                // Get current account ID
                const meResponse = await fetch('/api/accounts/me', { headers: authHeaders() });
                const meData = await meResponse.json();
                
                if (!meData.success) {
                    showNotification('Could not verify account', 'error');
                    return;
                }
                
                const response = await fetch(`/api/accounts/${meData.account.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ name, email, phone, business_name })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Profile updated successfully', 'success');
                    // Update sidebar display
                    document.getElementById('userName').textContent = name;
                    document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
                    document.getElementById('myAccountAvatar').textContent = name.charAt(0).toUpperCase();
                    document.getElementById('myAccountName').textContent = name;
                } else {
                    showNotification(data.error || 'Error updating profile', 'error');
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                showNotification('Error saving profile', 'error');
            }
        }
        
        async function changeMyPassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showNotification('All password fields are required', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showNotification('New password must be at least 8 characters', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/accounts/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Password changed successfully', 'success');
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } else {
                    showNotification(data.error || 'Error changing password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showNotification('Error changing password', 'error');
            }
        }
        
        async function createMasterAdmin() {
            const name = document.getElementById('newMasterName').value.trim();
            const email = document.getElementById('newMasterEmail').value.trim();
            const password = document.getElementById('newMasterPassword').value;
            
            if (!name || !email || !password) {
                showNotification('All fields are required', 'error');
                return;
            }
            
            if (password.length < 8) {
                showNotification('Password must be at least 8 characters', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/create-master-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ name, email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Master Admin created successfully', 'success');
                    // Clear form
                    document.getElementById('newMasterName').value = '';
                    document.getElementById('newMasterEmail').value = '';
                    document.getElementById('newMasterPassword').value = '';
                    // Reload list
                    loadMasterAdmins();
                } else {
                    showNotification(data.error || 'Error creating master admin', 'error');
                }
            } catch (error) {
                console.error('Error creating master admin:', error);
                showNotification('Error creating master admin', 'error');
            }
        }
        
        async function loadMasterAdmins() {
            const container = document.getElementById('masterAdminsList');
            try {
                const response = await fetch('/api/admin/accounts', { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.accounts) {
                    const masterAdmins = data.accounts.filter(a => a.role === 'master_admin');
                    
                    if (masterAdmins.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-secondary);">No master admins found</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Last Login</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${masterAdmins.map(admin => `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">${(admin.name || 'M').charAt(0).toUpperCase()}</div>
                                                    <strong>${admin.name || 'Unnamed'}</strong>
                                                </div>
                                            </td>
                                            <td>${admin.email}</td>
                                            <td><span class="badge badge-success">${admin.status || 'active'}</span></td>
                                            <td>${admin.last_login_at ? new Date(admin.last_login_at).toLocaleDateString() : 'Never'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading master admins:', error);
                container.innerHTML = '<p style="color: var(--error);">Error loading master admins</p>';
            }
        }
        
        // =====================================================
        // MANAGEMENT REQUESTS FUNCTIONS (Agency View)
        // =====================================================
        
        let allManagementRequests = [];
        let currentRequestFilter = 'pending';
        
        async function loadManagementRequests() {
            try {
                // Determine the viewing context
                let accountId = selectedAccountId;
                let accountRole = null;
                let viewMode = 'agency'; // 'agency' = requests TO this account, 'requester' = requests FROM this account
                
                if (selectedAccountId) {
                    // Get the selected account's role
                    const accountRes = await fetch(`/api/admin/accounts?account_id=${selectedAccountId}`, { headers: authHeaders() });
                    const accountData = await accountRes.json();
                    if (accountData.success && accountData.accounts && accountData.accounts.length > 0) {
                        accountRole = accountData.accounts[0].role;
                    }
                } else {
                    // Use logged-in user
                    const meRes = await fetch('/api/accounts/me', { headers: authHeaders() });
                    const meData = await meRes.json();
                    if (meData.success) {
                        accountId = meData.account.id;
                        accountRole = meData.account.role;
                    }
                }
                
                // Determine view mode based on role
                if (accountRole === 'agency_admin') {
                    viewMode = 'agency'; // Agency sees requests TO them
                } else if (accountRole === 'admin' || accountRole === 'submaster_admin') {
                    viewMode = 'requester'; // Admin sees their own requests TO agencies
                } else if (accountRole === 'master_admin' && !selectedAccountId) {
                    viewMode = 'all'; // Master admin with no filter sees ALL requests
                }
                
                // Load requests based on view mode
                let response;
                if (viewMode === 'all') {
                    response = await fetch(`/api/management-requests?all=true`, { headers: authHeaders() });
                } else {
                    response = await fetch(`/api/management-requests?account_id=${accountId}&role=${viewMode}`, { headers: authHeaders() });
                }
                
                const data = await response.json();
                
                if (data.success) {
                    allManagementRequests = data.requests || [];
                    
                    // Update stats
                    const pending = allManagementRequests.filter(r => r.status === 'pending');
                    const approved = allManagementRequests.filter(r => r.status === 'approved');
                    
                    document.getElementById('stat-pending-requests').textContent = pending.length;
                    document.getElementById('stat-managed-accounts').textContent = approved.length;
                    
                    // Calculate properties under management
                    const totalProperties = approved.reduce((sum, r) => sum + (r.property_count || 0), 0);
                    document.getElementById('stat-managed-properties').textContent = totalProperties;
                    
                    // Store view mode for rendering
                    window.managementRequestsViewMode = viewMode;
                    
                    // Render filtered list
                    filterManagementRequests(currentRequestFilter);
                }
            } catch (error) {
                console.error('Error loading management requests:', error);
                document.getElementById('managementRequestsList').innerHTML = 
                    '<p style="text-align: center; padding: 2rem; color: var(--error);">Error loading requests</p>';
            }
        }
        
        function filterManagementRequests(status) {
            currentRequestFilter = status;
            
            // Update button states
            document.querySelectorAll('.request-filter').forEach(btn => {
                if (btn.dataset.status === status) {
                    btn.classList.remove('btn-secondary');
                    btn.style.background = 'var(--accent)';
                } else {
                    btn.classList.add('btn-secondary');
                    btn.style.background = '';
                }
            });
            
            // Filter requests
            const filtered = status === 'all' 
                ? allManagementRequests 
                : allManagementRequests.filter(r => r.status === status);
            
            renderManagementRequests(filtered);
        }
        
        function renderManagementRequests(requests) {
            const container = document.getElementById('managementRequestsList');
            const viewMode = window.managementRequestsViewMode || 'agency';
            
            if (!requests || requests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                        <p>No ${currentRequestFilter === 'all' ? '' : currentRequestFilter} requests</p>
                    </div>
                `;
                return;
            }
            
            // Build table headers based on view mode
            let headers = '';
            if (viewMode === 'all') {
                headers = '<th>Account</th><th>Agency</th><th>Properties</th><th>Status</th><th>Requested</th><th>Actions</th>';
            } else if (viewMode === 'requester') {
                headers = '<th>Agency</th><th>Status</th><th>Requested</th><th>Response</th><th>Actions</th>';
            } else {
                headers = '<th>Account</th><th>Properties</th><th>Status</th><th>Requested</th><th>Actions</th>';
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>${headers}</tr>
                        </thead>
                        <tbody>
                            ${requests.map(req => {
                                if (viewMode === 'all') {
                                    // Master admin sees both account and agency
                                    return `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem;">
                                                        ${(req.requester_name || 'U').charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div style="font-weight: 600;">${req.requester_business || req.requester_name}</div>
                                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${req.requester_email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div style="font-weight: 500; color: #6366f1;">${req.agency_business || req.agency_name}</div>
                                            </td>
                                            <td><span style="font-weight: 600;">${req.property_count || 0}</span></td>
                                            <td>${getRequestStatusBadge(req.status)}</td>
                                            <td>${new Date(req.requested_at).toLocaleDateString()}</td>
                                            <td>
                                                ${req.status === 'pending' ? `
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn btn-small" onclick="respondToRequest(${req.id}, 'approved')" style="background: #10b981;">‚úì</button>
                                                        <button class="btn btn-secondary btn-small" onclick="respondToRequest(${req.id}, 'rejected')">‚úï</button>
                                                        <button class="btn btn-small" onclick="deleteManagementRequest(${req.id})" style="background: #ef4444;">üóë</button>
                                                    </div>
                                                ` : req.status === 'approved' ? `
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn btn-small" onclick="endManagementFromRequest(${req.id}, ${req.requesting_account_id})" style="background: #f59e0b;" title="End Management">
                                                            ‚èπ End
                                                        </button>
                                                        <button class="btn btn-small" onclick="deleteManagementRequest(${req.id})" style="background: #ef4444;" title="Delete Request">
                                                            üóë
                                                        </button>
                                                    </div>
                                                ` : `
                                                    <button class="btn btn-small" onclick="deleteManagementRequest(${req.id})" style="background: #ef4444;">üóë Delete</button>
                                                `}
                                            </td>
                                        </tr>
                                    `;
                                } else if (viewMode === 'requester') {
                                    // Admin sees their requests TO agencies
                                    return `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <div style="width: 36px; height: 36px; border-radius: 50%; background: #6366f1; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.85rem;">
                                                        üè¢
                                                    </div>
                                                    <div>
                                                        <div style="font-weight: 600;">${req.agency_business || req.agency_name}</div>
                                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${req.agency_email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>${getRequestStatusBadge(req.status)}</td>
                                            <td>${new Date(req.requested_at).toLocaleDateString()}</td>
                                            <td style="color: var(--text-secondary); font-size: 0.85rem;">
                                                ${req.response_message || '-'}
                                            </td>
                                            <td>
                                                ${req.status === 'pending' ? `
                                                    <button class="btn btn-secondary btn-small" onclick="cancelOwnRequest(${req.id})">
                                                        Cancel Request
                                                    </button>
                                                ` : req.status === 'approved' ? `
                                                    <button class="btn btn-small" onclick="requestEndManagement(${req.id})" style="background: #f59e0b;">
                                                        End Management
                                                    </button>
                                                ` : '-'}
                                            </td>
                                        </tr>
                                    `;
                                } else {
                                    // Agency sees requests FROM accounts
                                    return `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                                        ${(req.requester_name || 'U').charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div style="font-weight: 600;">${req.requester_business || req.requester_name}</div>
                                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${req.requester_email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span style="font-weight: 600; font-size: 1.1rem;">${req.property_count || 0}</span>
                                                <span style="color: var(--text-secondary); font-size: 0.85rem;"> properties</span>
                                            </td>
                                            <td>${getRequestStatusBadge(req.status)}</td>
                                            <td>${new Date(req.requested_at).toLocaleDateString()}</td>
                                            <td>
                                                ${req.status === 'pending' ? `
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn btn-small" onclick="respondToRequest(${req.id}, 'approved')" style="background: #10b981;">
                                                            ‚úì Approve
                                                        </button>
                                                        <button class="btn btn-secondary btn-small" onclick="respondToRequest(${req.id}, 'rejected')">
                                                            ‚úï Decline
                                                        </button>
                                                    </div>
                                                ` : req.status === 'approved' ? `
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn btn-small" onclick="endManagementFromRequest(${req.id}, ${req.requesting_account_id})" style="background: #f59e0b;">
                                                            End Management
                                                        </button>
                                                        <button class="btn btn-small" onclick="deleteManagementRequest(${req.id})" style="background: #ef4444;">
                                                            üóë
                                                        </button>
                                                    </div>
                                                ` : `
                                                    <button class="btn btn-small" onclick="deleteManagementRequest(${req.id})" style="background: #ef4444;">
                                                        üóë Delete
                                                    </button>
                                                `}
                                            </td>
                                        </tr>
                                    `;
                                }
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        async function respondToRequest(requestId, status) {
            const action = status === 'approved' ? 'approve' : 'decline';
            
            if (!confirm(`Are you sure you want to ${action} this request?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/management-requests/${requestId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Request ${status}`, 'success');
                    loadManagementRequests(); // Refresh
                } else {
                    showNotification(data.error || 'Error responding to request', 'error');
                }
            } catch (error) {
                console.error('Error responding to request:', error);
                showNotification('Error responding to request', 'error');
            }
        }
        
        async function deleteManagementRequest(requestId) {
            if (!confirm('Are you sure you want to delete this management request? This will also remove any agency relationship.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/management-requests/${requestId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Request deleted', 'success');
                    loadManagementRequests(); // Refresh
                } else {
                    showNotification(data.error || 'Error deleting request', 'error');
                }
            } catch (error) {
                console.error('Error deleting request:', error);
                showNotification('Error deleting request', 'error');
            }
        }
        
        async function endManagementFromRequest(requestId, accountId) {
            if (!confirm('Are you sure you want to end management of this account? They will become self-managed.')) {
                return;
            }
            
            try {
                // First remove management
                const removeRes = await fetch(`/api/accounts/${accountId}/remove-management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const removeData = await removeRes.json();
                
                if (removeData.success) {
                    // Then update the request status to cancelled
                    await fetch(`/api/management-requests/${requestId}/respond`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ status: 'cancelled', response_message: 'Management ended by agency' })
                    });
                    
                    showNotification('Management ended', 'success');
                    loadManagementRequests(); // Refresh
                } else {
                    showNotification(removeData.error || 'Error ending management', 'error');
                }
            } catch (error) {
                console.error('Error ending management:', error);
                showNotification('Error ending management', 'error');
            }
        }
        
        async function cancelOwnRequest(requestId) {
            if (!confirm('Are you sure you want to cancel this request?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/management-requests/${requestId}/respond`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status: 'cancelled', response_message: 'Cancelled by requester' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Request cancelled', 'success');
                    loadManagementRequests();
                    loadMyAccount(); // Refresh My Account view too
                } else {
                    showNotification(data.error || 'Error cancelling request', 'error');
                }
            } catch (error) {
                console.error('Error cancelling request:', error);
                showNotification('Error cancelling request', 'error');
            }
        }
        
        async function requestEndManagement(requestId) {
            if (!confirm('Are you sure you want to end this management relationship? You will become self-managed.')) {
                return;
            }
            
            try {
                // Get current account
                const meRes = await fetch('/api/accounts/me', { headers: authHeaders() });
                const meData = await meRes.json();
                
                if (!meData.success) {
                    showNotification('Could not verify account', 'error');
                    return;
                }
                
                // Remove management
                const response = await fetch(`/api/accounts/${meData.account.id}/remove-management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update request status
                    await fetch(`/api/management-requests/${requestId}/respond`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ status: 'cancelled', response_message: 'Ended by account owner' })
                    });
                    
                    showNotification('Management ended - you are now self-managed', 'success');
                    loadManagementRequests();
                    loadMyAccount();
                } else {
                    showNotification(data.error || 'Error ending management', 'error');
                }
            } catch (error) {
                console.error('Error ending management:', error);
                showNotification('Error ending management', 'error');
            }
        }
        
        // =====================================================
        // ACCOUNTS MANAGEMENT FUNCTIONS
        // =====================================================
        
        let allAccounts = [];
        let currentAccountFilter = 'all';
        
        async function loadAccounts() {
            const container = document.getElementById('accounts-list');
            console.log('loadAccounts called - selectedAccountId:', selectedAccountId);
            try {
                // Build query params based on current filter
                let queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                    console.log('Filtering accounts by account_id:', selectedAccountId);
                } else {
                    console.log('No account filter - loading all accounts');
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                const response = await fetch(`/api/admin/accounts${queryString}`, { headers: authHeaders() });
                const data = await response.json();
                
                console.log('loadAccounts response:', data);
                
                if (data.success && data.accounts) {
                    allAccounts = data.accounts;
                    
                    // Update stats
                    const masterAdmins = data.accounts.filter(a => a.role === 'master_admin');
                    const agencyAdmins = data.accounts.filter(a => a.role === 'agency_admin');
                    const subMasters = data.accounts.filter(a => a.role === 'submaster_admin');
                    const admins = data.accounts.filter(a => a.role === 'admin');
                    
                    document.getElementById('stat-total-accounts').textContent = data.accounts.length;
                    document.getElementById('stat-agency-admins').textContent = agencyAdmins.length;
                    document.getElementById('stat-submaster-admins').textContent = subMasters.length;
                    document.getElementById('stat-admins').textContent = admins.length;
                    
                    // Show generate codes button if master admin and accounts missing codes
                    const missingCodes = data.accounts.filter(a => !a.account_code);
                    const generateBtn = document.getElementById('generateCodesBtn');
                    if (generateBtn && currentAccount && currentAccount.role === 'master_admin' && missingCodes.length > 0) {
                        generateBtn.style.display = 'flex';
                        generateBtn.textContent = `üîÑ Generate ${missingCodes.length} Missing Codes`;
                    } else if (generateBtn) {
                        generateBtn.style.display = 'none';
                    }
                    
                    renderAccountsTable(data.accounts);
                } else {
                    console.error('Accounts API error:', data.error);
                    container.innerHTML = `<p style="color: var(--error); padding: 2rem; text-align: center;">Error loading accounts: ${data.error || 'Unknown error'}</p>`;
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
                container.innerHTML = `<p style="color: var(--error); padding: 2rem; text-align: center;">Error loading accounts: ${error.message}</p>`;
            }
        }
        
        function filterAccounts(role) {
            currentAccountFilter = role;
            
            // Update button states
            document.querySelectorAll('.account-filter').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '';
                btn.style.color = '';
                if (btn.dataset.role === role) {
                    btn.classList.add('active');
                    btn.style.background = '#6366f1';
                    btn.style.color = 'white';
                }
            });
            
            // Filter and render
            let filtered = allAccounts;
            if (role !== 'all') {
                filtered = allAccounts.filter(a => a.role === role);
            }
            // Don't show master_admin in filtered views unless specifically viewing "all"
            if (role === 'all') {
                // Show everyone
            } else {
                filtered = allAccounts.filter(a => a.role === role);
            }
            
            renderAccountsTable(filtered);
        }
        
        function getRoleBadge(role) {
            const badges = {
                'master_admin': '<span class="badge" style="background: linear-gradient(135deg, #9333ea, #7c3aed); color: white;">üëë Master Admin</span>',
                'agency_admin': '<span class="badge" style="background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white;">üè¢ Agency Admin</span>',
                'submaster_admin': '<span class="badge" style="background: linear-gradient(135deg, #0891b2, #0e7490); color: white;">üìÅ Sub Master</span>',
                'admin': '<span class="badge" style="background: linear-gradient(135deg, #16a34a, #15803d); color: white;">üë§ Admin</span>'
            };
            return badges[role] || `<span class="badge">${role}</span>`;
        }
        
        function renderAccountsTable(accounts) {
            const container = document.getElementById('accounts-list');
            
            if (accounts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <p style="font-size: 3rem; margin-bottom: 1rem;">üë•</p>
                        <p>No accounts found.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Code</th>
                                <th>Role</th>
                                <th>Managed By</th>
                                <th>Stripe</th>
                                <th>Plan</th>
                                <th>Properties</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${accounts.map(account => `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, ${account.primary_color || '#6366f1'} 0%, ${account.secondary_color || '#8b5cf6'} 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                                                ${account.name.charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <strong>${account.name}</strong>
                                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${account.email || '-'}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        ${account.account_code 
                                            ? `<code style="background: var(--bg-secondary); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">${account.account_code}</code>`
                                            : `<button class="btn btn-secondary btn-small" onclick="generateAccountCode(${account.id}, '${account.name}')" style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">+ Add</button>`
                                        }
                                    </td>
                                    <td>${getRoleBadge(account.role)}</td>
                                    <td>
                                        ${account.role === 'admin' || account.role === 'submaster_admin' 
                                            ? (account.managed_by_name 
                                                ? `<span style="color: #1e40af; font-weight: 500;">üè¢ ${account.managed_by_name}</span>`
                                                : `<span style="color: var(--text-muted); font-size: 0.85rem;">Self-managed</span>`)
                                            : `<span style="color: var(--text-muted);">‚Äî</span>`
                                        }
                                    </td>
                                    <td>
                                        ${(() => {
                                            const propCount = parseInt(account.property_count) || 0;
                                            const stripePropsCount = parseInt(account.stripe_properties_count) || 0;
                                            const hasAccountStripe = !!account.stripe_account_id;
                                            
                                            if (hasAccountStripe) {
                                                return `<span class="badge badge-success">‚úì Connected</span>`;
                                            } else if (stripePropsCount > 0 && stripePropsCount >= propCount && propCount > 0) {
                                                return `<span class="badge badge-success">‚úì ${stripePropsCount}/${propCount} Properties</span>`;
                                            } else if (stripePropsCount > 0) {
                                                return `<span class="badge badge-warning">‚ö° ${stripePropsCount}/${propCount} Properties</span>`;
                                            } else if (propCount === 0) {
                                                return `<span style="color: var(--text-muted); font-size: 0.85rem;">No properties</span>`;
                                            } else {
                                                return `<span style="color: var(--text-muted); font-size: 0.85rem;">Not connected</span>`;
                                            }
                                        })()}
                                    </td>
                                    <td>
                                        <span id="account-plan-${account.id}" class="badge badge-secondary" style="cursor: pointer;" onclick="openAssignPlanModal(${account.id}, \`${account.name.replace(/`/g, "'")}\`)">
                                            Loading...
                                        </span>
                                    </td>
                                    <td><span class="badge">${account.property_count || 0}</span></td>
                                    <td>
                                        <span class="badge ${account.status === 'active' ? 'badge-success' : account.status === 'pending' ? 'badge-warning' : 'badge-secondary'}">
                                            ${account.status || 'active'}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            <button class="btn btn-secondary btn-small" onclick="viewAccount(${account.id})">View</button>
                                            ${currentAccount && currentAccount.role === 'master_admin' ? `
                                                <button class="btn btn-secondary btn-small" onclick="editAccount(${account.id})">Edit</button>
                                                <button class="btn btn-secondary btn-small" onclick="deleteAccount(${account.id}, \`${account.name.replace(/`/g, "'")}\`)" style="color: #dc2626;">Delete</button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Load plan badges for each account
            accounts.forEach(account => loadAccountPlanBadge(account.id));
        }
        
        function connectStripeForAccount(accountId) {
            window.location.href = `/api/stripe/connect/${accountId}`;
        }
        
        async function disconnectStripe(accountId, accountName) {
            if (!confirm(`Are you sure you want to disconnect Stripe from "${accountName}"?\n\nThis will prevent this account from accepting card payments until reconnected.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${accountId}/stripe-disconnect`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Stripe disconnected successfully');
                    loadAccounts();
                } else {
                    alert('Error disconnecting Stripe: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error disconnecting Stripe:', error);
                alert('Error disconnecting Stripe');
            }
        }
        
        // Generate account code from name
        async function generateAccountCode(accountId, accountName) {
            const code = prompt('Enter account code (e.g., ELEVATE, LH001):', 
                accountName.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10));
            
            if (!code) return;
            
            try {
                const response = await fetch(`/api/accounts/${accountId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ account_code: code.toUpperCase() })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Account code saved!', 'success');
                    loadAccounts();
                } else {
                    showNotification(data.error || 'Error saving code', 'error');
                }
            } catch (error) {
                showNotification('Error saving code', 'error');
            }
        }
        
        async function generateMissingCodes() {
            if (!confirm('Generate codes for all accounts that don\'t have one?')) return;
            
            try {
                const response = await fetch('/api/admin/generate-account-codes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(`Generated ${data.count} account codes`, 'success');
                    loadAccounts();
                } else {
                    showNotification(data.error || 'Error generating codes', 'error');
                }
            } catch (error) {
                showNotification('Error generating codes', 'error');
            }
        }
        
        function viewAccount(accountId) {
            const account = allAccounts.find(a => a.id === accountId);
            if (!account) return;
            
            // Set the filter variables
            selectedAccountId = accountId;
            selectedAccountName = account.name;
            
            // Show banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            if (banner && nameEl) {
                banner.style.display = 'flex';
                nameEl.textContent = account.name;
            }
            
            // Hide master-only sections when viewing a client
            updateMasterOnlyVisibility();
            
            // Reload entitlements for selected account
            if (typeof loadAccountEntitlements === 'function') {
                loadAccountEntitlements();
            }
            
            // Navigate to dashboard with new filter
            showView('dashboard');
        }
        
        // Show/hide master-only sections based on whether viewing a client
        function updateMasterOnlyVisibility() {
            const isMaster = currentAccount && currentAccount.role === 'master_admin';
            const isViewingClient = selectedAccountId !== null;
            
            // Master-only sections: show only when master AND not viewing a client
            const showMasterSections = isMaster && !isViewingClient;
            
            document.querySelectorAll('.master-only').forEach(el => {
                el.style.display = showMasterSections ? 'block' : 'none';
            });
            
            // Client connection: show when client OR when master is viewing a client
            const showClientConnection = !isMaster || isViewingClient;
            document.querySelectorAll('.client-connection').forEach(el => {
                el.style.display = showClientConnection ? 'flex' : 'none';
            });
            
            // Billing admin items: same logic
            document.querySelectorAll('.billing-admin-only').forEach(el => {
                if (el.tagName === 'A') {
                    el.style.display = showMasterSections ? 'flex' : 'none';
                } else if (el.tagName === 'BUTTON') {
                    el.style.display = showMasterSections ? 'inline-flex' : 'none';
                } else {
                    el.style.display = showMasterSections ? 'block' : 'none';
                }
            });
            
            console.log('updateMasterOnlyVisibility - isMaster:', isMaster, 'isViewingClient:', isViewingClient, 'showMasterSections:', showMasterSections);
        }
        
        // Load plan badge for an account
        async function loadAccountPlanBadge(accountId) {
            const badge = document.getElementById(`account-plan-${accountId}`);
            if (!badge) return;
            
            try {
                const response = await fetch(`/api/admin/billing/subscription/${accountId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const planColors = {
                        'starter': '#6b7280',
                        'professional': '#2563eb',
                        'business': '#7c3aed',
                        'enterprise': '#dc2626'
                    };
                    const color = planColors[data.data.plan_slug] || '#6b7280';
                    badge.innerHTML = data.data.plan_name;
                    badge.style.background = color;
                    badge.style.color = 'white';
                } else {
                    badge.innerHTML = 'No Plan';
                    badge.style.background = '#e5e7eb';
                    badge.style.color = '#6b7280';
                }
            } catch (error) {
                badge.innerHTML = 'Error';
                badge.style.background = '#fee2e2';
                badge.style.color = '#dc2626';
            }
        }
        
        // Open assign plan modal
        let assignPlanAccountId = null;
        let assignPlanAccountName = null;
        
        async function openAssignPlanModal(accountId, accountName) {
            assignPlanAccountId = accountId;
            assignPlanAccountName = accountName;
            
            // Reset all checkboxes
            document.getElementById('assign-plan-api-access').checked = false;
            document.getElementById('assign-plan-blog-module').checked = false;
            document.getElementById('assign-plan-attractions-module').checked = false;
            document.getElementById('assign-plan-reviews-widget').checked = false;
            
            // Load plans for dropdown
            try {
                const response = await fetch('/api/admin/billing/plans');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const select = document.getElementById('assign-plan-select');
                    select.innerHTML = '<option value="">-- Select Plan --</option>' + 
                        data.data.filter(p => p.is_active).map(plan => 
                            `<option value="${plan.id}">${plan.name} - ¬£${parseFloat(plan.price_monthly).toFixed(2)}/mo</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading plans:', error);
            }
            
            // Get current subscription
            try {
                const response = await fetch(`/api/admin/billing/subscription/${accountId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    document.getElementById('assign-plan-select').value = data.data.plan_id;
                    document.getElementById('assign-plan-current').innerHTML = `Current plan: <strong>${data.data.plan_name}</strong>`;
                    document.getElementById('assign-plan-current').style.display = 'block';
                    
                    // Load feature overrides
                    const overrides = data.data.feature_overrides || {};
                    document.getElementById('assign-plan-api-access').checked = overrides.api_access === true;
                    document.getElementById('assign-plan-blog-module').checked = overrides.blog_module === true;
                    document.getElementById('assign-plan-attractions-module').checked = overrides.attractions_module === true;
                    document.getElementById('assign-plan-reviews-widget').checked = overrides.reviews_widget === true;
                } else {
                    document.getElementById('assign-plan-current').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('assign-plan-current').style.display = 'none';
            }
            
            document.getElementById('assign-plan-account-name').textContent = accountName;
            openModal('assignPlanModal');
        }
        
        async function saveAssignedPlan() {
            const planId = document.getElementById('assign-plan-select').value;
            const billingCycle = document.getElementById('assign-plan-cycle').value;
            const apiAccess = document.getElementById('assign-plan-api-access').checked;
            const blogModule = document.getElementById('assign-plan-blog-module').checked;
            const attractionsModule = document.getElementById('assign-plan-attractions-module').checked;
            const reviewsWidget = document.getElementById('assign-plan-reviews-widget').checked;
            
            if (!planId) {
                showNotification('Please select a plan', 'error');
                return;
            }
            
            // Build feature overrides (only include if checked)
            const featureOverrides = {};
            if (apiAccess) featureOverrides.api_access = true;
            if (blogModule) featureOverrides.blog_module = true;
            if (attractionsModule) featureOverrides.attractions_module = true;
            if (reviewsWidget) featureOverrides.reviews_widget = true;
            
            try {
                const response = await fetch('/api/admin/billing/assign-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: assignPlanAccountId,
                        plan_id: parseInt(planId),
                        billing_cycle: billingCycle,
                        feature_overrides: featureOverrides
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification(`Plan assigned to ${assignPlanAccountName}!`, 'success');
                    closeModal('assignPlanModal');
                    loadAccountPlanBadge(assignPlanAccountId);
                    // Reload entitlements if viewing this account
                    if (selectedAccountId === assignPlanAccountId) {
                        loadAccountEntitlements();
                    }
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error assigning plan', 'error');
            }
        }
        
        async function cancelAccountSubscription() {
            if (!confirm(`Cancel subscription for ${assignPlanAccountName}?`)) return;
            
            try {
                const response = await fetch('/api/admin/billing/cancel-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ account_id: assignPlanAccountId })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Subscription cancelled', 'success');
                    closeModal('assignPlanModal');
                    loadAccountPlanBadge(assignPlanAccountId);
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error cancelling subscription', 'error');
            }
        }
        
        // Account filter (like the old agency filter)
        // selectedAccountId and selectedAccountName are declared at the top with other globals
        
        function setAccountFilter(accountId, accountName) {
            selectedAccountId = accountId;
            selectedAccountName = accountName;
            
            // Show banner
            const banner = document.getElementById('agencyFilterBanner');
            const nameEl = document.getElementById('agencyFilterName');
            if (banner && nameEl) {
                banner.style.display = 'flex';
                nameEl.textContent = accountName;
            }
            
            // Hide master-only sections when viewing a client
            updateMasterOnlyVisibility();
            
            // Reload entitlements for selected account
            if (typeof loadAccountEntitlements === 'function') {
                loadAccountEntitlements();
            }
            
            // Reload current view with filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                showView(viewName);
            }
        }
        
        function clearAccountFilter() {
            // Only master_admin can clear the filter
            if (currentAccount && currentAccount.role !== 'master_admin') {
                console.log('Non-master admin cannot clear account filter');
                return;
            }
            
            console.log('clearAccountFilter called - previous selectedAccountId:', selectedAccountId);
            
            selectedAccountId = null;
            selectedAccountName = null;
            
            // Also clear old agency filter
            selectedAgencyId = null;
            selectedAgencyName = null;
            
            // Clear deployed site selection too
            selectedDeployedSiteId = null;
            
            console.log('Account filter cleared - selectedAccountId is now:', selectedAccountId);
            
            // Hide banner
            const banner = document.getElementById('agencyFilterBanner');
            if (banner) banner.style.display = 'none';
            
            // Show master-only sections again
            updateMasterOnlyVisibility();
            
            // Reload entitlements (will show master admin's defaults)
            if (typeof loadAccountEntitlements === 'function') {
                loadAccountEntitlements();
            }
            
            // Reload current view without filter
            const activeView = document.querySelector('.nav-item.active');
            if (activeView) {
                const viewName = activeView.getAttribute('data-view');
                console.log('Reloading view after clear:', viewName);
                showView(viewName);
            }
        }
        
        function openChangeRoleModal(accountId, currentRole, accountName) {
            const roles = ['admin', 'submaster_admin', 'agency_admin'];
            const roleLabels = {
                'admin': 'üë§ Admin',
                'submaster_admin': 'üìÅ Sub Master Admin',
                'agency_admin': 'üè¢ Agency Admin'
            };
            
            const options = roles.map(r => 
                `<option value="${r}" ${r === currentRole ? 'selected' : ''}>${roleLabels[r]}</option>`
            ).join('');
            
            // Remove existing modal if any
            const existingModal = document.getElementById('changeRoleModal');
            if (existingModal) existingModal.remove();
            
            const modalHtml = `
                <div class="modal active" id="changeRoleModal">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Change Role</h3>
                            <button class="modal-close" onclick="closeModal('changeRoleModal')">&times;</button>
                        </div>
                        <div style="padding: 0.5rem 0;">
                            <p style="margin-bottom: 1rem;">Change role for <strong>${accountName}</strong>:</p>
                            <select id="newRoleSelect" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                                ${options}
                            </select>
                            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                <button class="btn btn-secondary" onclick="closeModal('changeRoleModal')" style="flex: 1;">Cancel</button>
                                <button class="btn" onclick="saveAccountRole(${accountId})" style="flex: 1;">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        async function saveAccountRole(accountId) {
            const newRole = document.getElementById('newRoleSelect').value;
            
            try {
                const response = await fetch(`/api/admin/accounts/${accountId}/update-role`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ role: newRole })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('changeRoleModal');
                    loadAccounts();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // =====================================================
        // AGENCY ASSIGNMENT (Master Admin)
        // =====================================================
        
        async function openAssignAgencyModal(accountId, accountName) {
            console.log('openAssignAgencyModal called:', accountId, accountName);
            try {
                // Load available agencies
                const response = await fetch('/api/agencies/available', { headers: authHeaders() });
                const data = await response.json();
                
                console.log('Available agencies:', data);
                
                if (!data.success) {
                    alert('Error loading agencies: ' + data.error);
                    return;
                }
                
                if (!data.agencies || data.agencies.length === 0) {
                    alert('No agencies available. Create an Agency Admin account first.');
                    return;
                }
                
                const options = data.agencies.map(a => 
                    `<option value="${a.id}">${a.business_name || a.name}</option>`
                ).join('');
                
                // Remove existing modal if any
                const existingModal = document.getElementById('assignAgencyModal');
                if (existingModal) existingModal.remove();
                
                const modalHtml = `
                    <div class="modal active" id="assignAgencyModal">
                        <div class="modal-content" style="max-width: 450px;">
                            <div class="modal-header">
                                <h3 class="modal-title">üè¢ Assign Agency</h3>
                                <button class="modal-close" onclick="closeModal('assignAgencyModal')">&times;</button>
                            </div>
                            <div style="padding: 0.5rem 0;">
                                <p style="margin-bottom: 1rem;">Assign an agency to manage <strong>${accountName}</strong>:</p>
                                <select id="agencySelectModal" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                                    <option value="">Select agency...</option>
                                    ${options}
                                </select>
                                <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem; color: #0369a1;">
                                    ‚ÑπÔ∏è The agency will be able to view and manage this account's properties and bookings.
                                </div>
                                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                    <button class="btn btn-secondary" onclick="closeModal('assignAgencyModal')" style="flex: 1;">Cancel</button>
                                    <button class="btn" onclick="saveAgencyAssignment(${accountId})" style="flex: 1;">Assign</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            } catch (error) {
                console.error('Error in openAssignAgencyModal:', error);
                alert('Error loading agencies: ' + error.message);
            }
        }
        
        async function saveAgencyAssignment(accountId) {
            const agencyId = document.getElementById('agencySelectModal').value;
            
            if (!agencyId) {
                alert('Please select an agency');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/accounts/${accountId}/assign-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ agency_id: parseInt(agencyId) })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('assignAgencyModal');
                    showNotification('Agency assigned successfully', 'success');
                    loadAccounts();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function removeAccountManagement(accountId, accountName) {
            if (!confirm(`Remove agency management from "${accountName}"?\n\nThey will become self-managed.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${accountId}/remove-management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Management removed', 'success');
                    loadAccounts();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function resetAccountPassword(accountId, email) {
            // Remove existing modal if any
            const existingModal = document.getElementById('passwordResetModal');
            if (existingModal) existingModal.remove();
            
            const modalHtml = `
                <div class="modal active" id="passwordResetModal">
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-header">
                            <h3 class="modal-title">üîë Reset Password</h3>
                            <button class="modal-close" onclick="closeModal('passwordResetModal')">&times;</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <p style="margin-bottom: 1rem;">Set new password for <strong>${email}</strong></p>
                            
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label>New Password *</label>
                                <input type="password" id="new-password-input" class="form-input" placeholder="Enter new password (min 8 characters)" minlength="8" required>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label>Confirm Password *</label>
                                <input type="password" id="confirm-password-input" class="form-input" placeholder="Confirm new password" required>
                            </div>
                            
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="closeModal('passwordResetModal')" style="flex: 1;">Cancel</button>
                                <button class="btn" onclick="saveNewPassword(${accountId}, '${email}')" style="flex: 1;">Set Password</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('new-password-input').focus();
        }
        
        async function saveNewPassword(accountId, email) {
            const newPassword = document.getElementById('new-password-input').value;
            const confirmPassword = document.getElementById('confirm-password-input').value;
            
            if (!newPassword || newPassword.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/set-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ account_id: accountId, password: newPassword })
                });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('passwordResetModal');
                    showNotification('Password updated successfully', 'success');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function openAddAccountModal() {
            document.getElementById('account-modal-title').textContent = 'Add Account';
            document.getElementById('account-form').reset();
            document.getElementById('edit-account-id').value = '';
            openModal('accountModal');
        }
        
        async function editAccount(accountId) {
            try {
                const response = await fetch(`/api/accounts/${accountId}`, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.account) {
                    const account = data.account;
                    
                    // Header
                    document.getElementById('account-modal-title').textContent = account.name || 'Edit Account';
                    document.getElementById('account-modal-subtitle').textContent = account.email || '';
                    
                    // Hidden fields
                    document.getElementById('edit-account-id').value = account.id;
                    document.getElementById('account-code').value = account.account_code || '';
                    document.getElementById('account-role').value = account.role || 'admin';
                    document.getElementById('account-status').value = account.status || 'active';
                    
                    // Display fields (read-only)
                    document.getElementById('account-code-display').textContent = account.account_code || '‚Äî';
                    
                    // Role and Status - show dropdowns for Master Admin, text for others
                    const roleDisplayContainer = document.getElementById('account-role-display-container');
                    const roleSelect = document.getElementById('account-role-select');
                    const statusDisplayContainer = document.getElementById('account-status-display-container');
                    const statusSelect = document.getElementById('account-status-select');
                    
                    if (currentAccount && currentAccount.role === 'master_admin') {
                        // Master Admin can edit role and status
                        roleDisplayContainer.style.display = 'none';
                        roleSelect.style.display = 'block';
                        roleSelect.value = account.role || 'admin';
                        
                        statusDisplayContainer.style.display = 'none';
                        statusSelect.style.display = 'block';
                        statusSelect.value = account.status || 'active';
                    } else {
                        // Others see read-only text
                        roleDisplayContainer.style.display = 'block';
                        roleDisplayContainer.textContent = formatRole(account.role);
                        roleSelect.style.display = 'none';
                        
                        statusDisplayContainer.style.display = 'block';
                        statusDisplayContainer.textContent = (account.status || 'active').charAt(0).toUpperCase() + (account.status || 'active').slice(1);
                        statusSelect.style.display = 'none';
                    }
                    
                    // Editable fields
                    document.getElementById('account-name').value = account.name || '';
                    document.getElementById('account-contact-name').value = account.contact_name || '';
                    document.getElementById('account-email').value = account.email || '';
                    document.getElementById('account-phone').value = account.phone || '';
                    document.getElementById('account-address1').value = account.address_line1 || '';
                    document.getElementById('account-address2').value = account.address_line2 || '';
                    document.getElementById('account-city').value = account.city || '';
                    document.getElementById('account-region').value = account.region || '';
                    document.getElementById('account-postcode').value = account.postcode || '';
                    document.getElementById('account-country').value = account.country || '';
                    
                    // Agency Management section (only for admin/submaster)
                    const agencySection = document.getElementById('account-agency-section');
                    const agencyStatus = document.getElementById('account-agency-status');
                    
                    if (account.role === 'admin' || account.role === 'submaster_admin') {
                        agencySection.style.display = 'block';
                        
                        if (account.managed_by_id) {
                            // Currently managed by an agency
                            agencyStatus.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #1e40af;">üè¢ Managed by Agency</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${account.managed_by_name || 'Agency ID: ' + account.managed_by_id}</div>
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="removeAgencyFromModal(${account.id})">
                                        ‚úï Remove Agency
                                    </button>
                                </div>
                            `;
                        } else {
                            // Self-managed
                            agencyStatus.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600;">üë§ Self-Managed</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">No agency assigned</div>
                                    </div>
                                    <button type="button" class="btn" onclick="assignAgencyFromModal(${account.id}, '${(account.name || '').replace(/'/g, '')}')">
                                        + Assign Agency
                                    </button>
                                </div>
                            `;
                        }
                    } else {
                        agencySection.style.display = 'none';
                    }
                    
                    // Store account ID for password reset
                    document.getElementById('accountModal').dataset.accountId = account.id;
                    document.getElementById('accountModal').dataset.accountEmail = account.email;
                    
                    openModal('accountModal');
                } else {
                    alert('Error loading account: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading account:', error);
                alert('Error loading account: ' + error.message);
            }
        }
        
        function resetPasswordFromModal() {
            const modal = document.getElementById('accountModal');
            const accountId = modal.dataset.accountId;
            const email = modal.dataset.accountEmail;
            
            if (confirm(`Reset password for ${email}?\n\nThis will clear their password and they'll need to use "Set Password" to create a new one.`)) {
                resetAccountPassword(accountId, email);
            }
        }
        
        function assignAgencyFromModal(accountId, accountName) {
            closeModal('accountModal');
            openAssignAgencyModal(accountId, accountName);
        }
        
        async function removeAgencyFromModal(accountId) {
            if (!confirm('Remove agency management? The account will become self-managed.')) return;
            
            try {
                const response = await fetch(`/api/accounts/${accountId}/remove-management`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Agency removed', 'success');
                    closeModal('accountModal');
                    loadAccounts();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error removing agency');
            }
        }
        
        async function deleteAccount(accountId, accountName) {
            if (!confirm(`‚ö†Ô∏è DELETE ACCOUNT "${accountName}"?\n\nThis will permanently delete:\n‚Ä¢ The account\n‚Ä¢ All properties\n‚Ä¢ All rooms\n‚Ä¢ All reservations\n‚Ä¢ All related data\n\nThis action cannot be undone!`)) {
                return;
            }
            
            // Double confirm for safety
            if (!confirm(`FINAL CONFIRMATION\n\nType "DELETE" in the next prompt to confirm deletion of "${accountName}".`)) {
                return;
            }
            
            const confirmText = prompt(`Type DELETE to confirm deletion of "${accountName}":`);
            if (confirmText !== 'DELETE') {
                showNotification('Deletion cancelled', 'info');
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${accountId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Account "${accountName}" deleted successfully`, 'success');
                    loadAccounts();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting account: ' + error.message);
            }
        }
        
        async function saveAccount(event) {
            event.preventDefault();
            
            const accountId = document.getElementById('edit-account-id').value;
            const accountData = {
                name: document.getElementById('account-name').value,
                contact_name: document.getElementById('account-contact-name').value,
                email: document.getElementById('account-email').value,
                phone: document.getElementById('account-phone').value,
                address_line1: document.getElementById('account-address1').value,
                address_line2: document.getElementById('account-address2').value,
                city: document.getElementById('account-city').value,
                region: document.getElementById('account-region').value,
                postcode: document.getElementById('account-postcode').value,
                country: document.getElementById('account-country').value
            };
            
            // Master Admin can also update role and status
            if (currentAccount && currentAccount.role === 'master_admin') {
                const roleSelect = document.getElementById('account-role-select');
                const statusSelect = document.getElementById('account-status-select');
                if (roleSelect && roleSelect.style.display !== 'none') {
                    accountData.role = roleSelect.value;
                }
                if (statusSelect && statusSelect.style.display !== 'none') {
                    accountData.status = statusSelect.value;
                }
            }
            
            try {
                const url = `/api/accounts/${accountId}`;
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(accountData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('accountModal');
                    loadAccounts();
                    showNotification('Account saved successfully', 'success');
                } else {
                    alert('Error saving account: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving account:', error);
                alert('Error saving account');
            }
        }

        async function loadAgencies() {
            const container = document.getElementById('agencies-list');
            try {
                const response = await fetch('/api/admin/agencies');
                const data = await response.json();
                
                // Also get direct clients count (clients without agency)
                const clientsRes = await fetch('/api/admin/clients');
                const clientsData = await clientsRes.json();
                const directClients = clientsData.clients?.filter(c => !c.agency_id) || [];
                const agencyClients = clientsData.clients?.filter(c => c.agency_id) || [];
                
                if (data.success && data.agencies) {
                    // Update stats
                    document.getElementById('stat-total-agencies').textContent = data.agencies.length;
                    document.getElementById('stat-agency-clients').textContent = agencyClients.length;
                    document.getElementById('stat-agency-properties').textContent = data.agencies.reduce((sum, a) => sum + parseInt(a.property_count || 0), 0);
                    document.getElementById('stat-direct-clients').textContent = directClients.length;
                    
                    if (data.agencies.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                <p style="font-size: 3rem; margin-bottom: 1rem;">üè¢</p>
                                <p>No agencies yet.</p>
                                <p style="font-size: 0.9rem; margin-top: 0.5rem;">Agencies are partners who manage multiple property owners.</p>
                                <button class="btn" onclick="openAddAgencyModal()" style="margin-top: 1rem;">Add Your First Agency</button>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Agency</th>
                                        <th>Clients</th>
                                        <th>Properties</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.agencies.map(agency => `
                                        <tr>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <div style="width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, ${agency.primary_color || '#10b981'} 0%, ${agency.secondary_color || '#059669'} 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                                                        ${agency.name.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <strong>${agency.name}</strong>
                                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${agency.email}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="badge">${agency.client_count || 0}</span></td>
                                            <td><span class="badge">${agency.property_count || 0}</span></td>
                                            <td>
                                                <span class="badge ${agency.plan === 'enterprise' ? 'badge-warning' : 'badge-success'}">
                                                    ${agency.plan}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${agency.status === 'active' ? 'badge-success' : agency.status === 'pending' ? 'badge-warning' : 'badge-secondary'}">
                                                    ${agency.status}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewAgency(${agency.id})">View</button>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="editAgency(${agency.id})">Edit</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Error loading agencies. Run /api/setup-clients first.</p>';
                }
            } catch (error) {
                console.error('Error loading agencies:', error);
                container.innerHTML = `<p style="color: var(--error); text-align: center; padding: 2rem;">Error loading agencies: ${error.message}</p>`;
            }
        }

        function openAddAgencyModal() {
            document.getElementById('agency-id').value = '';
            document.getElementById('agency-public-id').value = '';
            document.getElementById('agency-form').reset();
            document.getElementById('agency-modal-title').textContent = 'üè¢ Add New Agency';
            document.getElementById('agency-country').value = 'CH';
            document.getElementById('agency-primary-color').value = '#6366f1';
            document.getElementById('agency-secondary-color').value = '#8b5cf6';
            document.getElementById('agency-api-key-section').style.display = 'none';
            openModal('agencyModal');
        }

        async function editAgency(agencyId) {
            try {
                const response = await fetch(`/api/admin/agencies/${agencyId}`);
                const data = await response.json();
                
                if (data.success && data.agency) {
                    const a = data.agency;
                    document.getElementById('agency-id').value = a.id;
                    document.getElementById('agency-public-id').value = a.public_id || '';
                    document.getElementById('agency-name').value = a.name || '';
                    document.getElementById('agency-email').value = a.email || '';
                    document.getElementById('agency-phone').value = a.phone || '';
                    document.getElementById('agency-website').value = a.website_url || '';
                    document.getElementById('agency-address1').value = a.address_line1 || '';
                    document.getElementById('agency-city').value = a.city || '';
                    document.getElementById('agency-country').value = normalizeCountryCode(a.country) || 'CH';
                    document.getElementById('agency-primary-color').value = a.primary_color || '#6366f1';
                    document.getElementById('agency-secondary-color').value = a.secondary_color || '#8b5cf6';
                    document.getElementById('agency-logo').value = a.logo_url || '';
                    document.getElementById('agency-currency').value = a.currency || 'CHF';
                    document.getElementById('agency-plan').value = a.plan || 'agency';
                    document.getElementById('agency-status').value = a.status || 'active';
                    document.getElementById('agency-notes').value = a.notes || '';
                    
                    // Show API key
                    if (a.api_key) {
                        document.getElementById('agency-api-key-display').value = a.api_key;
                        document.getElementById('agency-api-key-section').style.display = 'block';
                    } else {
                        document.getElementById('agency-api-key-section').style.display = 'none';
                    }
                    
                    document.getElementById('agency-modal-title').textContent = '‚úèÔ∏è Edit Agency';
                    openModal('agencyModal');
                }
            } catch (error) {
                alert('Error loading agency: ' + error.message);
            }
        }

        async function saveAgency(event) {
            event.preventDefault();
            
            const agencyId = document.getElementById('agency-id').value;
            const agencyData = {
                name: document.getElementById('agency-name').value,
                email: document.getElementById('agency-email').value,
                phone: document.getElementById('agency-phone').value,
                website_url: document.getElementById('agency-website').value,
                address_line1: document.getElementById('agency-address1').value,
                city: document.getElementById('agency-city').value,
                country: document.getElementById('agency-country').value,
                primary_color: document.getElementById('agency-primary-color').value,
                secondary_color: document.getElementById('agency-secondary-color').value,
                logo_url: document.getElementById('agency-logo').value,
                currency: document.getElementById('agency-currency').value,
                plan: document.getElementById('agency-plan').value,
                status: document.getElementById('agency-status').value,
                notes: document.getElementById('agency-notes').value
            };
            
            try {
                const url = agencyId ? `/api/admin/agencies/${agencyId}` : '/api/admin/agencies';
                const method = agencyId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(agencyData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('agencyModal');
                    loadAgencies();
                    // If new agency, show success with API key
                    if (!agencyId && result.agency?.api_key) {
                        alert(`‚úÖ Agency created!\n\nAPI Key: ${result.agency.api_key}\n\nSave this key - it's needed for API access.`);
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving agency: ' + error.message);
            }
        }

        async function viewAgency(agencyId) {
            try {
                const response = await fetch(`/api/admin/agencies/${agencyId}`);
                const data = await response.json();
                
                if (data.success) {
                    const a = data.agency;
                    // Set the filter and navigate to dashboard
                    setAgencyFilter(a.id, a.name);
                    showView('dashboard');
                }
            } catch (error) {
                alert('Error loading agency: ' + error.message);
            }
        }
        
        // View agency details in modal (for Edit button)
        async function viewAgencyDetails(agencyId) {
            try {
                const response = await fetch(`/api/admin/agencies/${agencyId}`);
                const data = await response.json();
                
                if (data.success) {
                    const a = data.agency;
                    const properties = data.properties || [];
                    const totalRooms = properties.reduce((sum, p) => sum + parseInt(p.room_count || 0), 0);
                    
                    document.getElementById('agency-detail-title').textContent = a.name;
                    document.getElementById('agency-detail-subtitle').textContent = `${properties.length} properties ¬∑ ${a.email}`;
                    
                    document.getElementById('agency-detail-content').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${properties.length}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Properties</div>
                            </div>
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${totalRooms}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Rooms</div>
                            </div>
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700;">${a.plan}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Plan</div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem 0;">Agency Properties</h4>
                        ${properties.length === 0 ? `
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary); background: var(--bg-primary); border-radius: 8px;">
                                <p>No properties assigned to this agency yet.</p>
                                <p style="font-size: 0.85rem; margin-top: 0.5rem;">Go to Properties and use the Agency dropdown to assign properties.</p>
                            </div>
                        ` : `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Property</th>
                                            <th>Location</th>
                                            <th>Rooms</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${properties.map(p => `
                                            <tr>
                                                <td><strong>${p.name}</strong></td>
                                                <td style="font-size: 0.85rem; color: var(--text-secondary);">${p.city || 'N/A'}, ${p.country || ''}</td>
                                                <td><span class="badge">${p.room_count || 0}</span></td>
                                                <td>
                                                    <span class="badge ${p.status === 'active' ? 'badge-success' : 'badge-secondary'}">${p.status || 'active'}</span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-secondary btn-small" onclick="editProperty(${p.id}); closeModal('agencyDetailModal');" style="font-size: 0.75rem;">Edit</button>
                                                    <button class="btn btn-secondary btn-small" onclick="removePropertyFromAgency(${p.id}, ${a.id})" style="font-size: 0.75rem;">Remove</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                        
                        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 1rem;">
                            <button onclick="editAgency(${a.id}); closeModal('agencyDetailModal');" class="btn btn-secondary">Edit Agency</button>
                            <button onclick="closeModal('agencyDetailModal')" class="btn">Close</button>
                        </div>
                    `;
                    
                    openModal('agencyDetailModal');
                }
            } catch (error) {
                alert('Error loading agency: ' + error.message);
            }
        }
        
        async function removePropertyFromAgency(propertyId, agencyId) {
            if (!confirm('Remove this property from the agency?')) return;
            
            try {
                const response = await fetch(`/api/admin/properties/${propertyId}/assign-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ agency_id: null })
                });
                const result = await response.json();
                if (result.success) {
                    viewAgency(agencyId);
                    loadAgencies();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function copyAgencyApiKey() {
            const keyInput = document.getElementById('agency-api-key-display');
            keyInput.select();
            navigator.clipboard.writeText(keyInput.value).then(() => {
                alert('‚úÖ API key copied!');
            }).catch(() => {
                document.execCommand('copy');
                alert('‚úÖ Copied!');
            });
        }

        async function assignClientToAgency(agencyId) {
            // Get unassigned clients
            const response = await fetch('/api/admin/clients');
            const data = await response.json();
            const unassignedClients = data.clients?.filter(c => !c.agency_id) || [];
            
            if (unassignedClients.length === 0) {
                alert('No unassigned clients available. Create a new client first.');
                return;
            }
            
            const clientOptions = unassignedClients.map(c => `${c.id}: ${c.business_name || c.name}`).join('\n');
            const selectedId = prompt(`Enter client ID to assign:\n\n${clientOptions}`);
            
            if (selectedId) {
                try {
                    const res = await fetch(`/api/admin/agencies/${agencyId}/assign-client`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ client_id: parseInt(selectedId) })
                    });
                    const result = await res.json();
                    if (result.success) {
                        alert('‚úÖ Client assigned to agency!');
                        viewAgency(agencyId);
                        loadAgencies();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        async function removeClientFromAgency(agencyId, clientId) {
            if (!confirm('Remove this client from the agency? They will become a direct client.')) return;
            
            try {
                const res = await fetch(`/api/admin/agencies/${agencyId}/remove-client`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ client_id: clientId })
                });
                const result = await res.json();
                if (result.success) {
                    alert('‚úÖ Client removed from agency');
                    viewAgency(agencyId);
                    loadAgencies();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function selectClientAndClose(clientId) {
            closeModal('agencyDetailModal');
            // Select the client in the dropdown and switch to their view
            document.getElementById('client-selector').value = clientId;
            clientId = clientId;
            selectedClientId = clientId;
            localStorage.setItem('selectedClientId', clientId);
            showView('dashboard');
        }

        // =========================================================
        // CLIENT MANAGEMENT FUNCTIONS
        // =========================================================

        async function loadClients() {
            const container = document.getElementById('clients-list');
            try {
                const [clientsRes, unassignedRes] = await Promise.all([
                    fetch('/api/admin/clients'),
                    fetch('/api/admin/properties/unassigned')
                ]);
                const data = await clientsRes.json();
                const unassignedData = await unassignedRes.json();
                
                if (data.success && data.clients) {
                    // Update stats
                    document.getElementById('stat-total-clients').textContent = data.clients.length;
                    document.getElementById('stat-active-clients').textContent = data.clients.filter(c => c.status === 'active').length;
                    document.getElementById('stat-paid-clients').textContent = data.clients.filter(c => c.plan !== 'free').length;
                    document.getElementById('stat-unassigned-props').textContent = unassignedData.properties?.length || 0;
                    
                    if (data.clients.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                <p style="font-size: 3rem; margin-bottom: 1rem;">üë•</p>
                                <p>No direct clients. All accounts are agencies.</p>
                                <button class="btn" onclick="openAddClientModal()" style="margin-top: 1rem;">Add Direct Client</button>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Client</th>
                                        <th>Properties</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Setup Link</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.clients.map(client => `
                                        <tr>
                                            <td>
                                                <strong>${client.business_name || client.name}</strong>
                                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${client.email}</div>
                                            </td>
                                            <td><span class="badge">${client.property_count || 0}</span></td>
                                            <td>
                                                <span class="badge ${client.plan === 'free' ? 'badge-secondary' : 'badge-warning'}">
                                                    ${client.plan}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${client.status === 'active' ? 'badge-success' : client.status === 'pending' ? 'badge-warning' : 'badge-secondary'}">
                                                    ${client.status}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: #10b981;" onclick="copySetupLink('${client.public_id || client.id}')">
                                                    üìã Copy Link
                                                </button>
                                            </td>
                                            <td>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewClient(${client.id})">View</button>
                                                <button class="btn btn-secondary btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="editClient(${client.id})">Edit</button>
                                                ${parseInt(client.property_count) > 1 ? `
                                                    <button class="btn btn-small" style="padding: 0.3rem 0.6rem; font-size: 0.75rem; background: #6366f1;" onclick="convertToAgency(${client.id}, '${client.name}')">
                                                        üè¢ Make Agency
                                                    </button>
                                                ` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No clients table found. Run the migration first.</p>';
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                container.innerHTML = `<p style="color: var(--error); text-align: center; padding: 2rem;">Error loading clients: ${error.message}</p>`;
            }
        }
        
        // Copy setup link for client
        function copySetupLink(publicId) {
            const baseUrl = window.location.origin;
            const setupLink = `${baseUrl}/setup.html?c=${publicId}`;
            
            navigator.clipboard.writeText(setupLink).then(() => {
                alert('‚úÖ Setup link copied!\n\n' + setupLink);
            }).catch(() => {
                prompt('Copy this setup link:', setupLink);
            });
        }

        // Convert client to agency
        async function convertToAgency(clientId, clientName) {
            if (!confirm(`Convert "${clientName}" to an Agency?\n\nThis will:\n‚Ä¢ Create an agency account for them\n‚Ä¢ Remove them from the Clients list\n‚Ä¢ They'll appear under Agencies instead`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/convert-to-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ ${clientName} is now an Agency!\n\nAPI Key: ${result.agency.api_key}`);
                    loadClients();
                    loadAgencies();
                    loadClientSelector();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error converting to agency: ' + error.message);
            }
        }

        function openAddClientModal() {
            document.getElementById('client-id').value = '';
            document.getElementById('client-public-id').value = '';
            document.getElementById('client-form').reset();
            document.getElementById('client-modal-title').textContent = 'üë• Add New Client';
            document.getElementById('client-country').value = 'GB';
            document.getElementById('client-setup-link-section').style.display = 'none';
            openModal('clientModal');
        }

        async function editClient(clientId) {
            try {
                const response = await fetch(`/api/admin/clients/${clientId}`);
                const data = await response.json();
                
                if (data.success && data.client) {
                    const c = data.client;
                    document.getElementById('client-id').value = c.id;
                    document.getElementById('client-public-id').value = c.public_id || '';
                    document.getElementById('client-name').value = c.name || '';
                    document.getElementById('client-email').value = c.email || '';
                    document.getElementById('client-phone').value = c.phone || '';
                    document.getElementById('client-address1').value = c.address_line1 || '';
                    document.getElementById('client-address2').value = c.address_line2 || '';
                    document.getElementById('client-city').value = c.city || '';
                    document.getElementById('client-region').value = c.region || '';
                    document.getElementById('client-postcode').value = c.postcode || '';
                    document.getElementById('client-country').value = normalizeCountryCode(c.country) || 'GB';
                    document.getElementById('client-currency').value = c.currency || 'GBP';
                    document.getElementById('client-plan').value = c.plan || 'free';
                    document.getElementById('client-status').value = c.status || 'active';
                    document.getElementById('client-notes').value = c.notes || '';
                    
                    // Show setup link section with UUID
                    const setupLinkSection = document.getElementById('client-setup-link-section');
                    if (c.public_id) {
                        const setupLink = `${window.location.origin}/smoobu-wizard.html?c=${c.public_id}`;
                        document.getElementById('client-setup-link-display').value = setupLink;
                        document.getElementById('client-uuid-display').textContent = c.public_id;
                        setupLinkSection.style.display = 'block';
                    } else {
                        setupLinkSection.style.display = 'none';
                    }
                    
                    document.getElementById('client-modal-title').textContent = '‚úèÔ∏è Edit Client';
                    openModal('clientModal');
                }
            } catch (error) {
                alert('Error loading client: ' + error.message);
            }
        }
        
        function copyClientSetupLink() {
            const linkInput = document.getElementById('client-setup-link-display');
            linkInput.select();
            navigator.clipboard.writeText(linkInput.value).then(() => {
                alert('‚úÖ Setup link copied!\n\n' + linkInput.value);
            }).catch(() => {
                document.execCommand('copy');
                alert('‚úÖ Copied!');
            });
        }

        async function saveClient(event) {
            event.preventDefault();
            
            const clientId = document.getElementById('client-id').value;
            const clientData = {
                name: document.getElementById('client-name').value,
                email: document.getElementById('client-email').value,
                phone: document.getElementById('client-phone').value,
                address_line1: document.getElementById('client-address1').value,
                address_line2: document.getElementById('client-address2').value,
                city: document.getElementById('client-city').value,
                region: document.getElementById('client-region').value,
                postcode: document.getElementById('client-postcode').value,
                country: document.getElementById('client-country').value,
                currency: document.getElementById('client-currency').value,
                plan: document.getElementById('client-plan').value,
                status: document.getElementById('client-status').value,
                notes: document.getElementById('client-notes').value
            };
            
            try {
                const url = clientId ? `/api/admin/clients/${clientId}` : '/api/admin/clients';
                const method = clientId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(clientData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('clientModal');
                    loadClients();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving client: ' + error.message);
            }
        }

        async function viewClient(clientId) {
            openModal('clientDetailModal');
            document.getElementById('client-detail-content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;">Loading client details...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}`);
                const data = await response.json();
                
                if (data.success) {
                    const c = data.client;
                    document.getElementById('client-detail-title').textContent = c.name;
                    document.getElementById('client-detail-subtitle').textContent = c.email;
                    
                    document.getElementById('client-detail-content').innerHTML = `
                        <!-- API Key Section -->
                        <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <span style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8;">API Key</span>
                                <span class="badge ${c.plan === 'free' ? 'badge-secondary' : 'badge-success'}">${c.plan === 'free' ? 'üîí Requires Paid Plan' : '‚úì Active'}</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <code style="flex: 1; background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; word-break: break-all;">
                                    ${c.api_key || 'No API key generated'}
                                </code>
                                <button onclick="copyShortcode('${c.api_key}')" class="btn" style="padding: 0.5rem 1rem;">Copy</button>
                                <button onclick="regenerateApiKey(${c.id})" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Regenerate</button>
                            </div>
                            ${c.plan === 'free' ? '<p style="margin-top: 0.75rem; font-size: 0.8rem; opacity: 0.8;">‚ö†Ô∏è Upgrade to a paid plan to enable WordPress plugin API access</p>' : ''}
                        </div>

                        <!-- Properties -->
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <h4 style="margin: 0;">Properties (${data.properties?.length || 0})</h4>
                                <button onclick="assignPropertyToClient(${c.id})" class="btn btn-secondary" style="padding: 0.3rem 0.75rem; font-size: 0.8rem;">+ Assign Property</button>
                            </div>
                            ${data.properties && data.properties.length > 0 ? `
                                <div style="background: var(--bg-primary); border-radius: 8px; overflow: hidden;">
                                    ${data.properties.map(p => `
                                        <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>${p.name}</strong>
                                                <span style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 0.5rem;">${p.room_count || 0} rooms</span>
                                            </div>
                                            <code style="font-size: 0.75rem; background: var(--bg-secondary); padding: 0.2rem 0.5rem; border-radius: 3px;">ID: ${p.id}</code>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: var(--text-secondary); font-size: 0.9rem;">No properties assigned</p>'}
                        </div>

                        <!-- Client Info Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div>
                                <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: var(--text-secondary);">Contact</h4>
                                <p style="margin: 0.25rem 0;"><strong>Phone:</strong> ${c.phone || '-'}</p>
                                <p style="margin: 0.25rem 0;"><strong>Address:</strong> ${[c.address_line1, c.city, c.postcode, c.country].filter(Boolean).join(', ') || '-'}</p>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: var(--text-secondary);">Settings</h4>
                                <p style="margin: 0.25rem 0;"><strong>Currency:</strong> ${c.currency || 'GBP'}</p>
                                <p style="margin: 0.25rem 0;"><strong>Created:</strong> ${new Date(c.created_at).toLocaleDateString()}</p>
                            </div>
                        </div>

                        ${c.notes ? `
                            <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                                <strong style="color: #92400e;">Notes:</strong>
                                <p style="margin: 0.5rem 0 0 0; color: #78350f;">${c.notes}</p>
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                            <button onclick="editClient(${c.id}); closeModal('clientDetailModal');" class="btn btn-secondary">Edit Client</button>
                            <button onclick="deleteClient(${c.id})" class="btn" style="background: var(--error); border-color: var(--error);">Delete Client</button>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('client-detail-content').innerHTML = `<p style="color: var(--error);">Error loading client: ${error.message}</p>`;
            }
        }

        async function regenerateApiKey(clientId) {
            if (!confirm('Are you sure you want to regenerate the API key? The old key will stop working immediately.')) return;
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}/regenerate-api-key`, { method: 'POST', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    alert('API key regenerated! New key: ' + result.api_key);
                    viewClient(clientId);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error regenerating API key: ' + error.message);
            }
        }

        async function deleteClient(clientId) {
            if (!confirm('Are you sure you want to delete this client? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/admin/clients/${clientId}`, { method: 'DELETE', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    closeModal('clientDetailModal');
                    loadClients();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error deleting client: ' + error.message);
            }
        }

        async function assignPropertyToClient(clientId) {
            try {
                const response = await fetch('/api/admin/properties/unassigned');
                const data = await response.json();
                
                if (!data.properties || data.properties.length === 0) {
                    alert('No unassigned properties available');
                    return;
                }
                
                const propertyId = prompt(
                    'Enter property ID to assign:\n\nUnassigned properties:\n' + 
                    data.properties.map(p => `ID ${p.id}: ${p.name}`).join('\n')
                );
                
                if (propertyId) {
                    const assignResponse = await fetch(`/api/admin/clients/${clientId}/assign-property`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ property_id: parseInt(propertyId) })
                    });
                    
                    const result = await assignResponse.json();
                    if (result.success) {
                        viewClient(clientId);
                    } else {
                        alert('Error: ' + result.error);
                    }
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Copy shortcode to clipboard
        function copyShortcode(shortcode) {
            navigator.clipboard.writeText(shortcode).then(() => {
                const notification = document.createElement('div');
                notification.textContent = 'Copied!';
                notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; z-index: 9999; animation: fadeIn 0.2s;';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            });
        }
        
        // Copy webhook URL to clipboard
        function copyWebhookUrl() {
            const webhookUrl = 'https://admin.gas.travel/api/webhooks/beds24';
            navigator.clipboard.writeText(webhookUrl).then(() => {
                const notification = document.createElement('div');
                notification.textContent = '‚úÖ Webhook URL copied!';
                notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 500; z-index: 9999; animation: fadeIn 0.2s;';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 2000);
            });
        }
        
        async function testWebhookEndpoint() {
            const statusEl = document.getElementById('webhook-status');
            statusEl.innerHTML = '‚è≥ Testing...';
            
            try {
                // First test GET endpoint
                const getResponse = await fetch('/api/webhooks/beds24');
                const getData = await getResponse.json();
                
                if (getData.status === 'active') {
                    statusEl.innerHTML = '<span style="color: #10b981;">‚úÖ Endpoint active and reachable</span>';
                    
                    // Now test POST with simulated webhook data
                    const testResponse = await fetch('/api/webhooks/beds24', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({
                            type: 'test',
                            message: 'GAS Admin test webhook',
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    if (testResponse.ok) {
                        statusEl.innerHTML = '<span style="color: #10b981;">‚úÖ Endpoint working! Check Railway logs for webhook receipt.</span>';
                    }
                } else {
                    statusEl.innerHTML = '<span style="color: #ef4444;">‚ùå Endpoint not responding correctly</span>';
                }
            } catch (error) {
                console.error('Webhook test error:', error);
                statusEl.innerHTML = '<span style="color: #ef4444;">‚ùå Failed to reach endpoint</span>';
            }
        }
        
        // Initialize webhook URL display
        function initWebhookUrl() {
            const webhookUrlEl = document.getElementById('webhook-url');
            if (webhookUrlEl) {
                webhookUrlEl.textContent = 'https://admin.gas.travel/api/webhooks/beds24';
            }
        }

        // Load WordPress view data
        async function loadWordPressView() {
            // Load account website status first
            if (typeof loadAccountWebsite === 'function') {
                loadAccountWebsite();
            }
            
            // Set API URL in all locations
            const apiUrl = window.location.origin;
            document.getElementById('wp-api-url').textContent = apiUrl;
            document.getElementById('wp-api-url-guide').textContent = apiUrl;
            
            // Get client ID
            const clientId = selectedAccountId || JSON.parse(localStorage.getItem('gas_user') || '{}').account_id || '';
            document.getElementById('wp-client-id').textContent = clientId || '-';
            if (document.getElementById('wp-client-id-guide')) {
                document.getElementById('wp-client-id-guide').textContent = clientId || '1';
            }
            
            // Build query params for filtering by account
            let queryParams = [];
            if (selectedAccountId) {
                queryParams.push(`account_id=${selectedAccountId}`);
            } else {
                const user = JSON.parse(localStorage.getItem('gas_user') || '{}');
                if (user.account_id) {
                    queryParams.push(`account_id=${user.account_id}`);
                }
            }
            const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
            
            // Load rooms for reference (filtered by account)
            try {
                const response = await fetch('/api/admin/units' + queryString);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    // Set first property ID in all locations
                    const firstPropertyId = data.data[0].property_id;
                    window.currentPropertyId = firstPropertyId;
                    document.getElementById('shortcode-property-id').textContent = firstPropertyId;
                    document.getElementById('wp-property-id').textContent = firstPropertyId;
                    if (document.getElementById('wp-property-id-guide')) {
                        document.getElementById('wp-property-id-guide').textContent = firstPropertyId;
                    }
                    document.getElementById('wp-rooms-shortcode').textContent = `[gas_rooms]`;
                    
                    // Build rooms table
                    let html = '<table style="width: 100%; font-size: 0.85rem;">';
                    html += '<thead><tr style="text-align: left; border-bottom: 1px solid var(--border);"><th style="padding: 0.5rem;">Room Name</th><th style="padding: 0.5rem;">ID</th><th style="padding: 0.5rem;">Shortcode</th></tr></thead>';
                    html += '<tbody>';
                    
                    data.data.forEach(room => {
                        html += `<tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 0.5rem;">${room.name}</td>
                            <td style="padding: 0.5rem;"><code style="background: #e2e8f0; padding: 0.15rem 0.4rem; border-radius: 3px;">${room.id}</code></td>
                            <td style="padding: 0.5rem;">
                                <code style="background: #1e293b; color: #e2e8f0; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">[gas_booking unit_id="${room.id}"]</code>
                                <button onclick="copyShortcode('[gas_booking unit_id=&quot;${room.id}&quot;]')" style="background: var(--accent); border: none; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; cursor: pointer; font-size: 0.7rem; margin-left: 0.5rem;">Copy</button>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    document.getElementById('wp-room-ids').innerHTML = html;
                } else {
                    document.getElementById('wp-room-ids').innerHTML = '<p style="color: var(--text-secondary);">No rooms found. Add rooms first or select a client.</p>';
                }
            } catch (error) {
                console.error('Error loading rooms for WordPress view:', error);
                document.getElementById('wp-room-ids').innerHTML = '<p style="color: var(--error);">Error loading rooms</p>';
            }
        }

        // Open channel manager wizard with current account context
        function openWizard(cm) {
            let url = `/${cm}-wizard.html`;
            // Pass current account's public_id if available
            if (currentAccount && currentAccount.public_id) {
                url += `?c=${currentAccount.public_id}`;
            }
            window.location.href = url;
        }

        // Data Loading
        async function loadDashboard() {
            try {
                // Build query params - prioritize account_id (new system)
                let queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                } else {
                    const clientId = getClientId();
                    if (clientId) {
                        queryParams.push(`client_id=${clientId}`);
                    }
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                console.log('loadDashboard - selectedAccountId:', selectedAccountId, 'queryString:', queryString);
                
                const response = await fetch(`/api/admin/stats${queryString}`);
                const stats = await response.json();
                
                console.log('loadDashboard - stats:', stats);
                
                if (stats.success) {
                    document.getElementById('stat-properties').textContent = stats.properties || 0;
                    document.getElementById('stat-rooms').textContent = stats.units || 0;
                    document.getElementById('stat-bookings').textContent = stats.bookings || 0;
                    document.getElementById('stat-integrations').textContent = stats.connections || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadProperties() {
            const container = document.getElementById('properties-list');
            try {
                // Build query params - prioritize account_id (new system)
                let queryParams = [];
                if (selectedAccountId) {
                    queryParams.push(`account_id=${selectedAccountId}`);
                } else if (selectedAgencyId) {
                    queryParams.push(`agency_id=${selectedAgencyId}`);
                }
                const clientId = getClientId();
                if (clientId) {
                    queryParams.push(`client_id=${clientId}`);
                }
                const queryString = queryParams.length > 0 ? '?' + queryParams.join('&') : '';
                
                // Fetch properties and agencies
                const [propsRes, agenciesRes] = await Promise.all([
                    fetch(`/api/db/properties${queryString}`),
                    fetch('/api/admin/agencies')
                ]);
                const data = await propsRes.json();
                const agenciesData = await agenciesRes.json();
                const agencies = agenciesData.agencies || [];
                
                // Also fetch accounts for the dropdown
                const accountsRes = await fetch('/api/admin/accounts', { headers: authHeaders() });
                const accountsData = await accountsRes.json();
                const allAccounts = accountsData.accounts || [];
                
                // Properties are already filtered by server based on account_id
                // No need for client-side filtering - server handles agency logic
                let properties = data.data || [];
                
                if (properties.length > 0) {
                    const html = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Property Name</th>
                                        <th>Type</th>
                                        <th>Location</th>
                                        <th>Account</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${properties.map(prop => {
                                        const currentAccount = allAccounts.find(a => a.id === prop.account_id);
                                        return `
                                        <tr>
                                            <td><strong>${prop.name || 'Unnamed Property'}</strong></td>
                                            <td>${prop.property_type || 'N/A'}</td>
                                            <td>${prop.city || 'N/A'}, ${prop.country || 'N/A'}</td>
                                            <td>
                                                ${currentAccount ? `<span style="color: #10b981; font-weight: 500;">${currentAccount.name}</span>` : '<span style="color: #94a3b8;">-- None --</span>'}
                                            </td>
                                            <td><span class="badge ${prop.status === 'active' ? 'badge-success' : prop.status === 'draft' ? 'badge-warning' : 'badge-secondary'}">${prop.status || 'active'}</span></td>
                                            <td>
                                                <div style="display: flex; gap: 0.25rem;">
                                                    <button class="btn btn-secondary btn-small" onclick="editProperty(${prop.id})">Edit</button>
                                                    <button class="btn btn-secondary btn-small" onclick="openPaymentSettings(${prop.id}, '${(prop.name || '').replace(/'/g, "\\'")}')" title="Payment Settings">üí≥</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üè®</div>
                            <h3>No Properties ${selectedAgencyId ? 'for this Agency' : 'Yet'}</h3>
                            <p>${selectedAgencyId ? 'Assign properties to this agency from the Properties view.' : 'Import your first property from Beds24'}</p>
                            ${!selectedAgencyId ? '<a href="#" onclick="openWizard(\'beds24\')" class="btn">Import Property</a>' : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading properties:', error);
                container.innerHTML = '<p style="color: var(--error); padding: 2rem; text-align: center;">Error loading properties</p>';
            }
        }
        
        async function assignPropertyToAgency(propertyId, agencyId) {
            try {
                const response = await fetch(`/api/admin/properties/${propertyId}/assign-agency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ agency_id: agencyId || null })
                });
                const result = await response.json();
                if (!result.success) {
                    alert('Error: ' + result.error);
                    loadProperties();
                }
            } catch (error) {
                alert('Error assigning agency: ' + error.message);
                loadProperties();
            }
        }

        async function loadRoomsPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('rooms-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for rooms:', error);
            }
        }
        
        async function loadRoomsForProperty() {
            const propertyId = document.getElementById('rooms-property-select')?.value;
            const container = document.getElementById('rooms-list');
            
            if (!propertyId) {
                container.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        Select a property to view rooms
                    </p>
                `;
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const html = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Room Name</th>
                                        <th>Type</th>
                                        <th>Capacity</th>
                                        <th>Qty</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.map(unit => `
                                        <tr>
                                            <td><code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${unit.id}</code></td>
                                            <td><strong>${unit.name}</strong></td>
                                            <td>${unit.unit_type || 'N/A'}</td>
                                            <td>${unit.max_guests || '-'} guests</td>
                                            <td>${unit.quantity || 1}</td>
                                            <td>
                                                <span class="badge ${(unit.status === 'available' || unit.status === 'active') ? 'badge-success' : unit.status === 'maintenance' ? 'badge-warning' : 'badge-secondary'}">
                                                    ${(unit.status === 'available' || unit.status === 'active') ? '‚úÖ' : unit.status === 'maintenance' ? 'üîß' : '‚ùå'} ${unit.status || 'available'}
                                                </span>
                                            </td>
                                            <td><button class="btn btn-secondary btn-small" onclick="editRoom(${unit.id})">Edit</button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üõèÔ∏è</div>
                            <h3>No Rooms for This Property</h3>
                            <p>Add rooms to this property or import from Beds24</p>
                            <button class="btn" onclick="openAddRoomModal()">Add Room</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
                container.innerHTML = '<p style="color: var(--error); padding: 2rem; text-align: center;">Error loading rooms</p>';
            }
        }
        
        async function loadRooms() {
            // Load property selector first
            await loadRoomsPropertySelect();
            
            // Show message to select property
            document.getElementById('rooms-list').innerHTML = `
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                    Select a property to view rooms
                </p>
            `;
        }

        async function loadAmenitiesPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('amenities-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                // Reset room select
                const roomSelect = document.getElementById('amenities-room-select');
                if (roomSelect) {
                    roomSelect.innerHTML = '<option value="">Select Room...</option>';
                }
            } catch (error) {
                console.error('Error loading properties for amenities:', error);
            }
        }
        
        async function loadAmenitiesRooms() {
            const propertyId = document.getElementById('amenities-property-select')?.value;
            const roomSelect = document.getElementById('amenities-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">Select Room...</option>';
            
            // Reset room-specific amenities display
            const roomList = document.getElementById('room-amenities-list');
            const bathroomList = document.getElementById('bathroom-amenities-list');
            const featuresList = document.getElementById('features-amenities-list');
            if (roomList) roomList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Select a room to load amenities</p>';
            if (bathroomList) bathroomList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Select a room to load amenities</p>';
            if (featuresList) featuresList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Select a room to load amenities</p>';
            
            if (!propertyId) return;
            
            // Load property-level terms
            await loadPropertyTerms(propertyId);
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadAmenitiesForRoom() {
            const roomId = document.getElementById('amenities-room-select')?.value;
            
            // Get tab containers
            const roomList = document.getElementById('room-amenities-list');
            const bathroomList = document.getElementById('bathroom-amenities-list');
            const featuresList = document.getElementById('features-amenities-list');
            
            if (!roomId) {
                if (roomList) roomList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Select a room to load amenities</p>';
                if (bathroomList) bathroomList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Select a room to load amenities</p>';
                if (featuresList) featuresList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Select a room to load amenities</p>';
                return;
            }
            
            try {
                // Get all master amenities
                const allAmenitiesResp = await fetch('/api/admin/amenities');
                const allAmenitiesData = await allAmenitiesResp.json();
                
                // Get this room's current amenities
                const roomAmenitiesResp = await fetch(`/api/admin/units/${roomId}/amenities`);
                const roomAmenitiesData = await roomAmenitiesResp.json();
                
                if (allAmenitiesData.success) {
                    const allAmenities = allAmenitiesData.amenities || [];
                    
                    // Get selected amenity IDs
                    const selectedIds = new Set();
                    if (roomAmenitiesData.success && roomAmenitiesData.data) {
                        roomAmenitiesData.data.forEach(a => selectedIds.add(a.amenity_id));
                    }
                    
                    // Define which categories go in which tab
                    const roomCategories = ['beds', 'essentials', 'laundry'];
                    const bathroomCategories = ['bathrooms'];
                    const featureCategories = ['entertainment', 'kitchen', 'wellness', 'work', 'safety', 'outdoor', 'parking', 'family', 'other'];
                    
                    // Group amenities by category
                    const categorizedAmenities = {};
                    allAmenities.forEach(a => {
                        const cat = a.category || 'other';
                        if (!categorizedAmenities[cat]) categorizedAmenities[cat] = [];
                        categorizedAmenities[cat].push(a);
                    });
                    
                    // Render function for amenity checkboxes
                    const renderAmenityGrid = (categories, container) => {
                        let html = '';
                        categories.forEach(cat => {
                            const items = categorizedAmenities[cat] || [];
                            if (items.length === 0) return;
                            
                            // Sort: selected first
                            items.sort((a, b) => {
                                const aSelected = selectedIds.has(a.id);
                                const bSelected = selectedIds.has(b.id);
                                if (aSelected && !bSelected) return -1;
                                if (!aSelected && bSelected) return 1;
                                return (a.display_order || 0) - (b.display_order || 0);
                            });
                            
                            const categoryNames = {
                                'beds': 'üõèÔ∏è Beds & Linens',
                                'bathrooms': 'üöø Facilities',
                                'essentials': '‚≠ê Essentials',
                                'kitchen': 'üç≥ Kitchen & Refreshments',
                                'entertainment': 'üì∫ Entertainment',
                                'wellness': 'üíÜ Wellness',
                                'parking': 'üöó Parking',
                                'outdoor': 'üå≥ Outdoor',
                                'family': 'üë®‚Äçüë©‚Äçüëß Family',
                                'work': 'üíº Work',
                                'safety': 'üö® Safety',
                                'laundry': 'üß∫ Laundry',
                                'other': 'üì¶ Other'
                            };
                            
                            html += `
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0; color: var(--text-secondary);">${categoryNames[cat] || cat}</h4>
                                        <span style="font-size: 0.8rem; color: var(--text-secondary);">${items.filter(a => selectedIds.has(a.id)).length}/${items.length}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                                        ${items.map(a => {
                                            const name = typeof a.amenity_name === 'string' ? 
                                                (a.amenity_name.startsWith('{') ? JSON.parse(a.amenity_name).en : a.amenity_name) :
                                                a.amenity_name?.en || a.amenity_code;
                                            const isSelected = selectedIds.has(a.id);
                                            return `
                                                <label style="display: flex; align-items: center; gap: 0.5rem; background: ${isSelected ? '#dcfce7' : 'var(--bg-secondary)'}; border: 1px solid ${isSelected ? '#10b981' : 'var(--border)'}; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                                                    <input type="checkbox" class="room-amenity-checkbox" value="${a.id}" ${isSelected ? 'checked' : ''} style="width: 16px; height: 16px; cursor: pointer;">
                                                    <span>${a.icon || ''} ${name}</span>
                                                </label>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        });
                        
                        if (html === '') {
                            html = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">No amenities in this category</p>';
                        }
                        
                        if (container) container.innerHTML = html;
                    };
                    
                    // Render each tab
                    renderAmenityGrid(roomCategories, roomList);
                    renderAmenityGrid(bathroomCategories, bathroomList);
                    renderAmenityGrid(featureCategories, featuresList);
                    
                } else {
                    const emptyMsg = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">No amenities available</p>';
                    if (roomList) roomList.innerHTML = emptyMsg;
                    if (bathroomList) bathroomList.innerHTML = emptyMsg;
                    if (featuresList) featuresList.innerHTML = emptyMsg;
                }
            } catch (error) {
                console.error('Error loading amenities:', error);
                const errorMsg = '<p style="color: var(--error); text-align: center; padding: 1rem;">Error loading amenities</p>';
                if (roomList) roomList.innerHTML = errorMsg;
                if (bathroomList) bathroomList.innerHTML = errorMsg;
                if (featuresList) featuresList.innerHTML = errorMsg;
            }
        }
        
        // Amenities Tab Switching
        function switchAmenityTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('#amenities-tabs .filter-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.amenityTab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // Show/hide tab panels
            document.querySelectorAll('.amenity-tab-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const activePanel = document.getElementById(`amenities-tab-${tabName}`);
            if (activePanel) {
                activePanel.style.display = 'block';
            }
        }
        
        // Bed Configuration
        function addBedRow() {
            const container = document.getElementById('bed-configuration');
            const newRow = document.createElement('div');
            newRow.className = 'bed-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 1rem; align-items: center; margin-bottom: 0.75rem;';
            newRow.innerHTML = `
                <select class="form-input bed-type-select">
                    <option value="">Select bed type...</option>
                    <option value="king">King Bed</option>
                    <option value="queen">Queen Bed</option>
                    <option value="double">Double Bed</option>
                    <option value="twin">Twin/Single Bed</option>
                    <option value="sofa">Sofa Bed</option>
                    <option value="bunk">Bunk Bed</option>
                    <option value="cot">Cot/Crib</option>
                </select>
                <input type="number" class="form-input bed-qty" min="1" max="10" value="1" style="width: 80px;">
                <button class="btn btn-secondary btn-small" onclick="removeBedRow(this)" style="color: var(--error);">‚úï</button>
            `;
            container.appendChild(newRow);
        }
        
        function removeBedRow(btn) {
            const row = btn.closest('.bed-row');
            const container = document.getElementById('bed-configuration');
            // Keep at least one row
            if (container.querySelectorAll('.bed-row').length > 1) {
                row.remove();
            } else {
                // Reset the row instead of removing
                row.querySelector('.bed-type-select').value = '';
                row.querySelector('.bed-qty').value = '1';
            }
        }
        
        // Pet policy toggle
        document.addEventListener('change', function(e) {
            if (e.target.name === 'pet-policy') {
                const petDetails = document.getElementById('pet-details');
                if (petDetails) {
                    petDetails.style.display = (e.target.value === 'yes' || e.target.value === 'request') ? 'block' : 'none';
                }
            }
        });
        
        // Save all amenities (Terms & Policies)
        async function saveAllAmenities() {
            const propertyId = document.getElementById('amenities-property-select')?.value;
            const roomId = document.getElementById('amenities-room-select')?.value;
            
            if (!propertyId) {
                alert('Please select a property first');
                return;
            }
            
            // Collect bed configuration
            const beds = [];
            document.querySelectorAll('.bed-row').forEach(row => {
                const type = row.querySelector('.bed-type-select')?.value;
                const qty = row.querySelector('.bed-qty')?.value || 1;
                if (type) {
                    beds.push({ type, quantity: parseInt(qty) });
                }
            });
            
            // Collect terms & policies
            const terms = {
                checkin_from: document.getElementById('terms-checkin-from')?.value,
                checkin_until: document.getElementById('terms-checkin-until')?.value,
                checkout: document.getElementById('terms-checkout')?.value,
                late_checkout_fee: document.getElementById('terms-late-checkout-fee')?.value || null,
                self_checkin: document.getElementById('terms-self-checkin')?.checked,
                checkin_24hr: document.getElementById('terms-24hr-checkin')?.checked,
                
                smoking_policy: document.querySelector('input[name="smoking-policy"]:checked')?.value,
                smoking_fine: document.getElementById('terms-smoking-fine')?.value || null,
                
                pet_policy: document.querySelector('input[name="pet-policy"]:checked')?.value,
                pet_deposit: document.getElementById('terms-pet-deposit')?.value || null,
                pet_fee: document.getElementById('terms-pet-fee')?.value || null,
                dogs_allowed: document.getElementById('terms-dogs-allowed')?.checked,
                cats_allowed: document.getElementById('terms-cats-allowed')?.checked,
                small_pets_only: document.getElementById('terms-small-pets-only')?.checked,
                max_pets: document.getElementById('terms-max-pets')?.value,
                
                children_policy: document.querySelector('input[name="children-policy"]:checked')?.value,
                cots_available: document.getElementById('terms-cots-available')?.checked,
                highchairs_available: document.getElementById('terms-highchairs')?.checked,
                cot_fee: document.getElementById('terms-cot-fee')?.value || null,
                
                events_policy: document.querySelector('input[name="events-policy"]:checked')?.value,
                
                wheelchair_accessible: document.getElementById('access-wheelchair')?.checked,
                step_free: document.getElementById('access-step-free')?.checked,
                accessible_bathroom: document.getElementById('access-bathroom')?.checked,
                grab_rails: document.getElementById('access-grab-rails')?.checked,
                roll_in_shower: document.getElementById('access-roll-in-shower')?.checked,
                elevator_access: document.getElementById('access-elevator')?.checked,
                ground_floor: document.getElementById('access-ground-floor')?.checked,
                
                quiet_hours_from: document.getElementById('terms-quiet-from')?.value,
                quiet_hours_until: document.getElementById('terms-quiet-until')?.value,
                no_outside_guests: document.getElementById('terms-no-outside-guests')?.checked,
                id_required: document.getElementById('terms-id-required')?.checked,
                additional_rules: document.getElementById('terms-additional-rules')?.value,
                
                bathroom_type: document.querySelector('input[name="bathroom-type"]:checked')?.value
            };
            
            // Also save room amenities if a room is selected
            if (roomId) {
                await saveRoomAmenities();
            }
            
            // Save property-level terms
            try {
                const response = await fetch(`/api/admin/properties/${propertyId}/terms`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ terms, beds })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ All changes saved successfully!');
                } else {
                    alert('Error saving: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving amenities:', error);
                alert('Error saving changes');
            }
        }
        
        // Load property terms when property is selected
        async function loadPropertyTerms(propertyId) {
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/admin/properties/${propertyId}/terms`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const terms = result.data.terms || {};
                    const beds = result.data.beds || [];
                    
                    // Populate check-in/out (using database column names)
                    if (terms.checkin_from) document.getElementById('terms-checkin-from').value = terms.checkin_from;
                    if (terms.checkin_until) document.getElementById('terms-checkin-until').value = terms.checkin_until;
                    if (terms.checkout_by) document.getElementById('terms-checkout').value = terms.checkout_by;
                    if (terms.late_checkout_fee) document.getElementById('terms-late-checkout-fee').value = terms.late_checkout_fee;
                    if (terms.self_checkin) document.getElementById('terms-self-checkin').checked = true;
                    if (terms.checkin_24hr) document.getElementById('terms-24hr-checkin').checked = true;
                    
                    // Smoking
                    if (terms.smoking_policy) {
                        const radio = document.querySelector(`input[name="smoking-policy"][value="${terms.smoking_policy}"]`);
                        if (radio) radio.checked = true;
                    }
                    if (terms.smoking_fine) document.getElementById('terms-smoking-fine').value = terms.smoking_fine;
                    
                    // Pets
                    if (terms.pet_policy) {
                        const radio = document.querySelector(`input[name="pet-policy"][value="${terms.pet_policy}"]`);
                        if (radio) radio.checked = true;
                        // Show pet details if pets allowed
                        if (terms.pet_policy === 'yes' || terms.pet_policy === 'request') {
                            document.getElementById('pet-details').style.display = 'block';
                        }
                    }
                    if (terms.pet_deposit) document.getElementById('terms-pet-deposit').value = terms.pet_deposit;
                    if (terms.pet_fee_per_night) document.getElementById('terms-pet-fee').value = terms.pet_fee_per_night;
                    if (terms.dogs_allowed) document.getElementById('terms-dogs-allowed').checked = true;
                    if (terms.cats_allowed) document.getElementById('terms-cats-allowed').checked = true;
                    if (terms.small_pets_only) document.getElementById('terms-small-pets-only').checked = true;
                    if (terms.max_pets) document.getElementById('terms-max-pets').value = terms.max_pets;
                    
                    // Children
                    if (terms.children_policy) {
                        const radio = document.querySelector(`input[name="children-policy"][value="${terms.children_policy}"]`);
                        if (radio) radio.checked = true;
                    }
                    if (terms.cots_available) document.getElementById('terms-cots-available').checked = true;
                    if (terms.highchairs_available) document.getElementById('terms-highchairs').checked = true;
                    if (terms.cot_fee_per_night) document.getElementById('terms-cot-fee').value = terms.cot_fee_per_night;
                    
                    // Events
                    if (terms.events_policy) {
                        const radio = document.querySelector(`input[name="events-policy"][value="${terms.events_policy}"]`);
                        if (radio) radio.checked = true;
                    }
                    
                    // Accessibility
                    if (terms.wheelchair_accessible) document.getElementById('access-wheelchair').checked = true;
                    if (terms.step_free_access) document.getElementById('access-step-free').checked = true;
                    if (terms.accessible_bathroom) document.getElementById('access-bathroom').checked = true;
                    if (terms.grab_rails) document.getElementById('access-grab-rails').checked = true;
                    if (terms.roll_in_shower) document.getElementById('access-roll-in-shower').checked = true;
                    if (terms.elevator_access) document.getElementById('access-elevator').checked = true;
                    if (terms.ground_floor_available) document.getElementById('access-ground-floor').checked = true;
                    
                    // House rules
                    if (terms.quiet_hours_from) document.getElementById('terms-quiet-from').value = terms.quiet_hours_from;
                    if (terms.quiet_hours_until) document.getElementById('terms-quiet-until').value = terms.quiet_hours_until;
                    if (terms.no_outside_guests) document.getElementById('terms-no-outside-guests').checked = true;
                    if (terms.id_required) document.getElementById('terms-id-required').checked = true;
                    if (terms.additional_rules) document.getElementById('terms-additional-rules').value = terms.additional_rules;
                    
                    // Bathroom type (stored separately, not in property_terms)
                    if (terms.bathroom_type) {
                        const radio = document.querySelector(`input[name="bathroom-type"][value="${terms.bathroom_type}"]`);
                        if (radio) radio.checked = true;
                    }
                    
                    // Beds (using bed_type from database)
                    if (beds.length > 0) {
                        const container = document.getElementById('bed-configuration');
                        container.innerHTML = '';
                        beds.forEach((bed, index) => {
                            const bedType = bed.bed_type || bed.type; // Handle both formats
                            const row = document.createElement('div');
                            row.className = 'bed-row';
                            row.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr auto; gap: 1rem; align-items: center; margin-bottom: 0.75rem;';
                            row.innerHTML = `
                                <select class="form-input bed-type-select">
                                    <option value="">Select bed type...</option>
                                    <option value="king" ${bedType === 'king' ? 'selected' : ''}>King Bed</option>
                                    <option value="queen" ${bedType === 'queen' ? 'selected' : ''}>Queen Bed</option>
                                    <option value="double" ${bedType === 'double' ? 'selected' : ''}>Double Bed</option>
                                    <option value="twin" ${bedType === 'twin' ? 'selected' : ''}>Twin/Single Bed</option>
                                    <option value="sofa" ${bedType === 'sofa' ? 'selected' : ''}>Sofa Bed</option>
                                    <option value="bunk" ${bedType === 'bunk' ? 'selected' : ''}>Bunk Bed</option>
                                    <option value="cot" ${bedType === 'cot' ? 'selected' : ''}>Cot/Crib</option>
                                </select>
                                <input type="number" class="form-input bed-qty" min="1" max="10" value="${bed.quantity || 1}" style="width: 80px;">
                                <button class="btn btn-secondary btn-small" onclick="removeBedRow(this)" style="color: var(--error);">‚úï</button>
                            `;
                            container.appendChild(row);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading property terms:', error);
            }
        }
        
        async function saveRoomAmenities() {
            const roomId = document.getElementById('amenities-room-select')?.value;
            if (!roomId) {
                alert('Please select a room first');
                return;
            }
            
            // Get selected amenities
            const selectedAmenities = [];
            document.querySelectorAll('.room-amenity-checkbox:checked').forEach(checkbox => {
                selectedAmenities.push(checkbox.value);
            });
            
            try {
                const response = await fetch(`/api/admin/units/${roomId}/amenities`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ amenities: selectedAmenities })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Amenities saved successfully!');
                    loadAmenitiesForRoom(); // Refresh to update counts
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving amenities:', error);
                alert('Error saving amenities');
            }
        }
        
        async function loadAmenities() {
            // Load property selector first
            await loadAmenitiesPropertySelect();
            
            // Show message to select property/room
            document.getElementById('amenities-list').innerHTML = `
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                    Select a property and room to manage amenities
                </p>
            `;
        }
        
        async function deleteAmenity(id) {
            if (!confirm('Delete this amenity? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/amenities/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Amenity deleted successfully!');
                    loadAmenitiesForRoom();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting amenity:', error);
                alert('Error deleting amenity');
            }
        }

        // Images functions

        // =========================================================
        // IMAGE MANAGEMENT FUNCTIONS
        // =========================================================
        
        let selectedFiles = [];
        let currentFilter = 'all';
        let allImages = [];

        async function loadImagesPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('images-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for images:', error);
            }
        }
        
        async function loadImagesRooms() {
            const propertyId = document.getElementById('images-property-select')?.value;
            const roomSelect = document.getElementById('images-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">All Rooms</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadImagesForProperty() {
            const propertyId = document.getElementById('images-property-select')?.value;
            const roomId = document.getElementById('images-room-select')?.value;
            
            // Also load rooms when property changes
            if (!roomId) {
                await loadImagesRooms();
            }
            
            if (!propertyId) {
                document.getElementById('images-stats').style.display = 'none';
                document.getElementById('images-filter-tabs').style.display = 'none';
                document.getElementById('images-gallery').innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        Select a property to view and manage images
                    </p>
                `;
                return;
            }
            
            // Show stats and filter tabs
            document.getElementById('images-stats').style.display = 'grid';
            document.getElementById('images-filter-tabs').style.display = 'flex';
            
            try {
                allImages = [];
                let propertyCount = 0;
                let roomCount = 0;
                let locationCount = 0;
                
                // Load property images
                try {
                    const imgResp = await fetch(`/api/admin/properties/${propertyId}/images`);
                    if (imgResp.ok) {
                        const imgData = await imgResp.json();
                        if (imgData.success && imgData.images) {
                            const propSelect = document.getElementById('images-property-select');
                            const propName = propSelect.options[propSelect.selectedIndex]?.text || 'Property';
                            imgData.images.forEach(img => {
                                allImages.push({
                                    ...img,
                                    type: 'property',
                                    entityId: propertyId,
                                    entityName: propName
                                });
                            });
                            propertyCount = imgData.images.length;
                        }
                    }
                } catch (e) {
                    console.log('Error loading property images:', e.message);
                }
                
                // Load room images (either specific room or all rooms for property)
                let rooms = [];
                if (roomId) {
                    const roomSelect = document.getElementById('images-room-select');
                    rooms = [{ id: roomId, name: roomSelect.options[roomSelect.selectedIndex]?.text || 'Room' }];
                } else {
                    try {
                        const roomsResp = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                        if (roomsResp.ok) {
                            const roomsData = await roomsResp.json();
                            rooms = roomsData.data || [];
                        }
                    } catch (e) {
                        console.log('No rooms found:', e.message);
                    }
                }
                
                for (const room of rooms) {
                    try {
                        const imgResp = await fetch(`/api/admin/rooms/${room.id}/images`);
                        if (imgResp.ok) {
                            const imgData = await imgResp.json();
                            if (imgData.success && imgData.images) {
                                imgData.images.forEach(img => {
                                    allImages.push({
                                        ...img,
                                        type: 'room',
                                        entityId: room.id,
                                        entityName: room.name
                                    });
                                });
                                roomCount += imgData.images.length;
                            }
                        }
                    } catch (e) {
                        console.log(`Error loading images for room ${room.id}:`, e.message);
                    }
                }

                // Update counters
                document.getElementById('property-image-count').textContent = propertyCount;
                document.getElementById('room-image-count').textContent = roomCount;
                document.getElementById('location-image-count').textContent = locationCount;
                document.getElementById('total-image-count').textContent = propertyCount + roomCount + locationCount;

                // Display gallery
                displayImages();
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }
        
        async function loadImages() {
            // Load property selector first
            await loadImagesPropertySelect();
            
            // Hide stats and filter tabs until property selected
            document.getElementById('images-stats').style.display = 'none';
            document.getElementById('images-filter-tabs').style.display = 'none';
            
            // Show message to select property
            document.getElementById('images-gallery').innerHTML = `
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                    Select a property to view and manage images
                </p>
            `;
        }

        function filterImages(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.filter === filter) {
                    tab.classList.add('active');
                }
            });

            displayImages();
        }

        function displayImages() {
            const gallery = document.getElementById('images-gallery');
            const propertyId = document.getElementById('images-property-select')?.value;
            
            if (!propertyId) {
                gallery.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        Select a property to view and manage images
                    </p>
                `;
                return;
            }
            
            let filteredImages = allImages;
            if (currentFilter !== 'all') {
                if (currentFilter === 'rooms') {
                    filteredImages = allImages.filter(img => img.type === 'room');
                } else {
                    filteredImages = allImages.filter(img => img.type === currentFilter);
                }
            }

            if (filteredImages.length === 0) {
                gallery.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üñºÔ∏è</div>
                        <h3>No Images for This Property</h3>
                        <p>Upload images to showcase this property</p>
                        <button class="btn" onclick="openImageUploadModal()">Upload Images</button>
                    </div>
                `;
                return;
            }

            // Group images by entity (room or property)
            const groupedImages = {};
            filteredImages.forEach(img => {
                const key = `${img.type}-${img.entityId}`;
                if (!groupedImages[key]) {
                    groupedImages[key] = {
                        type: img.type,
                        entityId: img.entityId,
                        entityName: img.entityName,
                        images: []
                    };
                }
                groupedImages[key].images.push(img);
            });

            // Sort images within each group by display_order
            Object.values(groupedImages).forEach(group => {
                group.images.sort((a, b) => a.display_order - b.display_order);
            });

            let html = '';
            
            Object.values(groupedImages).forEach(group => {
                const icon = group.type === 'room' ? 'üõèÔ∏è' : (group.type === 'property' ? 'üè®' : 'üìç');
                
                html += `
                    <div class="room-image-section" style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border);">
                            ${icon} ${group.entityName}
                            <span style="font-size: 0.85rem; color: var(--text-secondary); font-weight: normal; margin-left: 0.5rem;">
                                (${group.images.length} image${group.images.length !== 1 ? 's' : ''})
                            </span>
                        </h3>
                        <div class="image-gallery">
                            ${group.images.map((img, idx) => {
                                const isFirst = idx === 0;
                                const isLast = idx === group.images.length - 1;
                                
                                return `
                                <div class="image-card" data-id="${img.id}" data-image-id="${img.id}" data-type="${img.type}" data-entity="${img.entityId}">
                                    <img src="${img.thumbnail_url || img.image_url}" alt="${img.alt_text || ''}" loading="lazy">
                                    <div class="image-card-info">
                                        <div class="image-tags">
                                            ${img.is_primary ? '<span class="image-tag" style="background: gold; color: #000;">‚≠ê Primary</span>' : ''}
                                        </div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                            ${img.width} √ó ${img.height} px ‚Ä¢ Order: ${idx + 1}
                                        </div>
                                        <div class="image-actions">
                                            <button class="btn btn-small" onclick="moveImage('${img.type}', ${img.entityId}, ${img.id}, -1)" ${isFirst ? 'disabled style="opacity:0.3"' : ''}>‚Üê</button>
                                            <button class="btn btn-small" onclick="moveImage('${img.type}', ${img.entityId}, ${img.id}, 1)" ${isLast ? 'disabled style="opacity:0.3"' : ''}>‚Üí</button>
                                            ${!img.is_primary ? `<button class="btn btn-small" onclick="setPrimaryImage('${img.type}', ${img.entityId}, ${img.id})">‚≠ê</button>` : ''}
                                            <button class="btn btn-secondary btn-small" onclick="deleteImage('${img.type}', ${img.id})" style="color: #ef4444;">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                `;
            });

            gallery.innerHTML = html;
        }

        function openImageUploadModal() {
            selectedFiles = [];
            document.getElementById('uploadPreview').innerHTML = '';
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('assignmentSection').style.display = 'block'; // Show by default
            document.getElementById('uploadButton').disabled = true;
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            
            // Load rooms for checkboxes
            loadRoomCheckboxes();
            
            openModal('imageUploadModal');
            
            // Setup drag and drop
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('imageFileInput');
            
            uploadZone.onclick = () => fileInput.click();
            
            fileInput.onchange = (e) => handleFiles(e.target.files);
            
            uploadZone.ondragover = (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            };
            
            uploadZone.ondragleave = () => {
                uploadZone.classList.remove('dragover');
            };
            
            uploadZone.ondrop = (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            };
        }

        async function loadRoomCheckboxes() {
            try {
                // Get property from page selector
                const propertyId = document.getElementById('images-property-select')?.value;
                
                let url = '/api/db/bookable-units';
                if (propertyId) {
                    url += `?property_id=${propertyId}`;
                } else {
                    // Fall back to account filtering
                    let queryParams = [];
                    if (selectedAccountId) {
                        queryParams.push(`account_id=${selectedAccountId}`);
                    } else {
                        const user = JSON.parse(localStorage.getItem('gas_account') || '{}');
                        if (user.account_id) {
                            queryParams.push(`account_id=${user.account_id}`);
                        }
                    }
                    if (queryParams.length > 0) {
                        url += '?' + queryParams.join('&');
                    }
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to load rooms');
                }
                const data = await response.json();
                const rooms = data.data || [];
                
                const container = document.getElementById('roomCheckboxes');
                if (rooms.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">No rooms available. Select a property first.</p>';
                    return;
                }
                
                container.innerHTML = rooms.map(room => `
                    <label class="checkbox-label" style="cursor: pointer;">
                        <input type="checkbox" class="room-checkbox" value="${room.id}" style="width: 18px; height: 18px; cursor: pointer; margin: 0;">
                        <span style="flex: 1;">${room.name}</span>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Error loading rooms:', error);
                const container = document.getElementById('roomCheckboxes');
                container.innerHTML = '<p style="color: var(--error); padding: 1rem;">Error loading rooms. Make sure server is deployed.</p>';
            }
        }

        async function handleFiles(files) {
            const preview = document.getElementById('uploadPreview');
            preview.innerHTML = '';
            preview.style.display = 'grid';
            // Assignment section already visible from modal open
            
            selectedFiles = [];
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                
                const reader = new FileReader();
                const previewId = 'preview-' + Math.random().toString(36).substr(2, 9);
                
                reader.onload = async (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = () => {
                        const ratio = img.width / img.height;
                        const isLandscape = ratio >= 1.2; // At least 1.2:1 ratio
                        
                        const previewHtml = `
                            <div class="upload-preview-item" id="${previewId}">
                                <img src="${e.target.result}">
                                ${!isLandscape ? '<div class="error">Ratio too narrow - Min 1.2:1</div>' : ''}
                                <button class="remove" onclick="removePreview('${previewId}', '${file.name}')">√ó</button>
                            </div>
                        `;
                        preview.insertAdjacentHTML('beforeend', previewHtml);
                        
                        if (isLandscape) {
                            selectedFiles.push({ file, previewId });
                        }
                        
                        document.getElementById('uploadButton').disabled = selectedFiles.length === 0;
                    };
                };
                
                reader.readAsDataURL(file);
            }
        }

        function removePreview(previewId, filename) {
            document.getElementById(previewId)?.remove();
            selectedFiles = selectedFiles.filter(f => f.previewId !== previewId);
            document.getElementById('uploadButton').disabled = selectedFiles.length === 0;
        }

        async function uploadImages() {
            if (selectedFiles.length === 0) {
                alert('No valid images selected');
                return;
            }

            // Get assignments
            const isProperty = document.getElementById('assign-property').checked;
            const isLocation = document.getElementById('assign-location').checked;
            const selectedRooms = Array.from(document.querySelectorAll('.room-checkbox:checked')).map(cb => cb.value);

            if (!isProperty && !isLocation && selectedRooms.length === 0) {
                alert('Please assign images to at least one category (Property, Location, or Rooms)');
                return;
            }

            document.getElementById('uploadButton').disabled = true;
            // Show centered progress overlay
            const progressDiv = document.getElementById('uploadProgress');
            progressDiv.style.display = 'flex';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            
            let uploadedCount = 0;
            let errorCount = 0;

            // Upload to each selected destination
            const destinations = [];
            
            if (isProperty) {
                // Use the property selected on the page
                const propertyId = document.getElementById('images-property-select')?.value;
                if (propertyId) {
                    destinations.push({ type: 'property', id: propertyId });
                } else {
                    // Fall back to first property if none selected
                    const propsResp = await fetch('/api/db/properties');
                    const propsData = await propsResp.json();
                    if (propsData.data && propsData.data.length > 0) {
                        destinations.push({ type: 'property', id: propsData.data[0].id });
                    }
                }
            }

            selectedRooms.forEach(roomId => {
                destinations.push({ type: 'room', id: roomId });
            });

            const totalUploads = destinations.length * selectedFiles.length;
            let completed = 0;

            for (const dest of destinations) {
                const formData = new FormData();
                selectedFiles.forEach(item => formData.append('images', item.file));

                try {
                    const endpoint = dest.type === 'property' 
                        ? `/api/admin/properties/${dest.id}/images`
                        : `/api/admin/rooms/${dest.id}/images`;
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (result.success) {
                        uploadedCount += result.images.length;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    errorCount++;
                }

                completed += selectedFiles.length;
                const progress = (completed / totalUploads) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = `${Math.round(progress)}%`;
            }

            // Show completion
            document.getElementById('progressText').textContent = `‚úì ${uploadedCount} images uploaded${errorCount > 0 ? ` (${errorCount} errors)` : ''}`;
            
            setTimeout(() => {
                closeModal('imageUploadModal');
                loadImagesForProperty();
            }, 1500);
        }

        async function setPrimaryImage(type, entityId, imageId) {
            // Show loading state on the image
            const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imgCard) {
                imgCard.style.opacity = '0.5';
                imgCard.style.pointerEvents = 'none';
            }
            
            try {
                const endpoint = type === 'property'
                    ? `/api/admin/properties/${entityId}/images/${imageId}/primary`
                    : `/api/admin/rooms/${entityId}/images/${imageId}/primary`;
                
                const response = await fetch(endpoint, { method: 'PUT' });
                const result = await response.json();
                
                if (result.success) {
                    await loadImagesForProperty(); // await the refresh
                } else {
                    alert('Error: ' + result.error);
                    if (imgCard) {
                        imgCard.style.opacity = '1';
                        imgCard.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Error setting primary:', error);
                alert('Error setting primary image');
                if (imgCard) {
                    imgCard.style.opacity = '1';
                    imgCard.style.pointerEvents = 'auto';
                }
            }
        }

        async function deleteImage(type, imageId) {
            if (!confirm('Delete this image? This cannot be undone.')) return;
            
            // Show loading state
            const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imgCard) {
                imgCard.style.opacity = '0.5';
                imgCard.style.pointerEvents = 'none';
            }
            
            try {
                const endpoint = type === 'property'
                    ? `/api/admin/properties/images/${imageId}`
                    : `/api/admin/rooms/images/${imageId}`;
                
                const response = await fetch(endpoint, { method: 'DELETE', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    // Remove the card immediately for instant feedback
                    const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
                    if (imgCard) {
                        imgCard.style.transition = 'opacity 0.3s, transform 0.3s';
                        imgCard.style.opacity = '0';
                        imgCard.style.transform = 'scale(0.8)';
                        setTimeout(() => imgCard.remove(), 300);
                    }
                    // Then refresh to update counts etc
                    await loadImagesForProperty();
                } else {
                    alert('Error: ' + result.error);
                    const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
                    if (imgCard) {
                        imgCard.style.opacity = '1';
                        imgCard.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('Error deleting image');
            }
        }

        async function moveImage(type, entityId, imageId, direction) {
            // Show loading state
            const imgCard = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imgCard) {
                imgCard.style.opacity = '0.5';
                imgCard.style.pointerEvents = 'none';
            }
            
            // Get images for this entity
            const entityImages = allImages.filter(img => 
                img.type === type && img.entityId === entityId
            ).sort((a, b) => a.display_order - b.display_order);
            
            const currentIndex = entityImages.findIndex(img => img.id === imageId);
            const newIndex = currentIndex + direction;
            
            if (newIndex < 0 || newIndex >= entityImages.length) {
                if (imgCard) {
                    imgCard.style.opacity = '1';
                    imgCard.style.pointerEvents = 'auto';
                }
                return;
            }
            
            // Swap positions
            const newOrder = entityImages.map(img => img.id);
            [newOrder[currentIndex], newOrder[newIndex]] = [newOrder[newIndex], newOrder[currentIndex]];
            
            try {
                const endpoint = type === 'property'
                    ? `/api/admin/properties/${entityId}/images/reorder`
                    : `/api/admin/rooms/${entityId}/images/reorder`;
                
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ imageIds: newOrder })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadImagesForProperty();
                } else {
                    alert('Error: ' + result.error);
                    if (imgCard) {
                        imgCard.style.opacity = '1';
                        imgCard.style.pointerEvents = 'auto';
                    }
                }
            } catch (error) {
                console.error('Error reordering:', error);
                alert('Error reordering images');
                if (imgCard) {
                    imgCard.style.opacity = '1';
                    imgCard.style.pointerEvents = 'auto';
                }
            }
        }

        // =====================================================
        // TASKS - Tabbed Menu Navigation
        // =====================================================
        let tasksData = null;
        let currentTasksView = 'category'; // 'category' or 'priority'
        let currentTaskCategory = 'all';
        let currentTaskPriority = 'all';
        
        async function loadTasks() {
            try {
                // Try loading from JSON file first (primary source)
                const jsonResponse = await fetch('/tasks.json?t=' + Date.now());
                if (jsonResponse.ok) {
                    tasksData = await jsonResponse.json();
                    // Ensure tasks and completed arrays exist
                    if (!tasksData.tasks) tasksData.tasks = [];
                    if (!tasksData.completed) tasksData.completed = [];
                } else {
                    throw new Error('JSON file not found');
                }
            } catch (jsonError) {
                console.log('JSON load failed, trying API:', jsonError);
                try {
                    // Fallback to database API
                    const response = await fetch('/api/admin/tasks');
                    const data = await response.json();
                    const tasksArray = data.tasks || data.data || [];
                    
                    tasksData = {
                        tasks: tasksArray.filter(t => t.status !== 'done'),
                        completed: tasksArray.filter(t => t.status === 'done'),
                        categories: [
                            { id: 'critical', name: 'Critical - Must Work', icon: 'üî•' },
                            { id: 'billing', name: 'Billing & Payments', icon: 'üí≥' },
                            { id: 'booking-flow', name: 'Booking Flow', icon: 'üìÖ' },
                            { id: 'ui', name: 'UI/UX', icon: 'üé®' },
                            { id: 'website-builder', name: 'Website Builder', icon: 'üåê' },
                            { id: 'apps', name: 'Apps', icon: 'üì±' },
                            { id: 'integrations', name: 'Integrations', icon: 'üîó' },
                            { id: 'wordpress', name: 'WordPress', icon: 'üîå' },
                            { id: 'bugs', name: 'Bug Fixes', icon: 'üêõ' },
                            { id: 'ideas', name: 'Ideas', icon: 'üí°' }
                        ]
                    };
                } catch (apiError) {
                    console.error('Both JSON and API failed:', apiError);
                    tasksData = {
                        tasks: [],
                        completed: [],
                        categories: [
                            { id: 'critical', name: 'Critical - Must Work', icon: 'üî•' },
                            { id: 'billing', name: 'Billing & Payments', icon: 'üí≥' },
                            { id: 'ideas', name: 'Ideas', icon: 'üí°' }
                        ]
                    };
                }
            }
            
            buildCategoryTabs();
            updateTaskStats();
            renderTasks();
            renderCompletedTasks();
        }
        
        function buildCategoryTabs() {
            if (!tasksData || !tasksData.categories) return;
            
            const container = document.getElementById('tasks-category-tabs');
            if (!container) return;
            
            let html = `<button class="tasks-cat-tab ${currentTaskCategory === 'all' ? 'active' : ''}" data-cat="all" onclick="filterTasksCat('all')">All</button>`;
            
            tasksData.categories.forEach(cat => {
                const count = tasksData.tasks ? tasksData.tasks.filter(t => t.category === cat.id && t.status !== 'done').length : 0;
                const isActive = currentTaskCategory === cat.id ? 'active' : '';
                html += `<button class="tasks-cat-tab ${isActive}" data-cat="${cat.id}" onclick="filterTasksCat('${cat.id}')">${cat.icon} ${cat.name} ${count > 0 ? `<span style="opacity: 0.7;">(${count})</span>` : ''}</button>`;
            });
            
            container.innerHTML = html;
        }
        
        function updateTaskStats() {
            if (!tasksData) return;
            
            const activeTasks = tasksData.tasks.filter(t => t.status !== 'done');
            
            document.getElementById('stat-critical').textContent = activeTasks.filter(t => t.priority === 'critical').length;
            document.getElementById('stat-urgent').textContent = activeTasks.filter(t => t.priority === 'urgent').length;
            document.getElementById('stat-high').textContent = activeTasks.filter(t => t.priority === 'high').length;
            document.getElementById('stat-medium').textContent = activeTasks.filter(t => t.priority === 'medium').length;
        }
        
        function switchTaskMainTab(tab) {
            document.querySelectorAll('.tasks-main-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tasks-main-' + tab).classList.add('active');
            
            if (tab === 'active') {
                document.getElementById('tasks-active-panel').style.display = 'block';
                document.getElementById('tasks-completed-panel').style.display = 'none';
            } else {
                document.getElementById('tasks-active-panel').style.display = 'none';
                document.getElementById('tasks-completed-panel').style.display = 'block';
            }
        }
        
        function setTasksView(view) {
            currentTasksView = view;
            
            document.querySelectorAll('.tasks-view-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-by-' + view).classList.add('active');
            
            if (view === 'category') {
                document.getElementById('tasks-category-tabs').style.display = 'flex';
                document.getElementById('tasks-priority-tabs').style.display = 'none';
            } else {
                document.getElementById('tasks-category-tabs').style.display = 'none';
                document.getElementById('tasks-priority-tabs').style.display = 'flex';
            }
            
            renderTasks();
        }
        
        function filterTasksCat(cat) {
            currentTaskCategory = cat;
            
            document.querySelectorAll('#tasks-category-tabs .tasks-cat-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.cat === cat);
            });
            
            renderTasks();
        }
        
        function filterTasksPriority(priority) {
            currentTaskPriority = priority;
            
            document.querySelectorAll('#tasks-priority-tabs .tasks-cat-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.priority === priority);
            });
            
            renderTasks();
        }
        
        function renderTasks() {
            if (!tasksData) return;
            
            const container = document.getElementById('tasks-list');
            let tasks = tasksData.tasks.filter(t => t.status !== 'done');
            
            // Apply filters
            if (currentTasksView === 'category' && currentTaskCategory !== 'all') {
                tasks = tasks.filter(t => t.category === currentTaskCategory);
            }
            if (currentTasksView === 'priority' && currentTaskPriority !== 'all') {
                tasks = tasks.filter(t => t.priority === currentTaskPriority);
            }
            
            // Sort by priority
            const priorityOrder = { 'critical': 0, 'urgent': 1, 'high': 2, 'medium': 3, 'low': 4 };
            tasks.sort((a, b) => (priorityOrder[a.priority] || 3) - (priorityOrder[b.priority] || 3));
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
                        <h3>No tasks here</h3>
                        <p style="color: var(--text-secondary);">Try a different filter</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            tasks.forEach(task => {
                const priorityClass = `priority-${task.priority || 'medium'}`;
                const badgeClass = `task-badge-${task.priority || 'medium'}`;
                const priorityLabels = { 'critical': 'üî• CRITICAL', 'urgent': '‚ö° URGENT', 'high': 'üî∑ HIGH', 'medium': 'üìå MEDIUM' };
                const taskId = task.id || task.title.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                
                let subtasksHtml = '';
                if (task.subtasks && task.subtasks.length > 0) {
                    subtasksHtml = `
                        <div class="task-subtasks">
                            ${task.subtasks.map(st => `<div class="task-subtask">${st}</div>`).join('')}
                        </div>
                    `;
                }
                
                let notesHtml = '';
                if (task.notes) {
                    notesHtml = `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: #b45309; background: #fef3c7; padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block;">üí° ${task.notes}</div>`;
                }
                
                html += `
                    <div class="task-card ${priorityClass}" data-task-id="${taskId}" style="cursor: pointer;">
                        <div class="task-card-header">
                            <h4 class="task-title">${task.title}</h4>
                            <div class="task-badges">
                                <span class="task-badge ${badgeClass}">${priorityLabels[task.priority] || 'MEDIUM'}</span>
                                <button class="btn btn-small task-edit-btn" data-id="${taskId}" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">‚úèÔ∏è Edit</button>
                                <button class="btn btn-small task-done-btn" data-id="${taskId}" style="padding: 0.2rem 0.5rem; font-size: 0.7rem; background: #22c55e;">‚úì Done</button>
                            </div>
                        </div>
                        ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                        ${notesHtml}
                        ${subtasksHtml}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Attach event listeners
            container.querySelectorAll('.task-edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = btn.dataset.id;
                    editTaskById(taskId);
                });
            });
            
            container.querySelectorAll('.task-done-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const taskId = btn.dataset.id;
                    markTaskDoneById(taskId);
                });
            });
        }
        
        function renderCompletedTasks() {
            if (!tasksData) return;
            
            const container = document.getElementById('tasks-completed-list');
            const completed = tasksData.completed || [];
            const doneTasks = tasksData.tasks.filter(t => t.status === 'done');
            const allCompleted = [...completed, ...doneTasks];
            
            allCompleted.sort((a, b) => (b.completed || '').localeCompare(a.completed || ''));
            
            if (allCompleted.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                        <h3>No completed tasks yet</h3>
                    </div>
                `;
                return;
            }
            
            // Group by date
            const grouped = {};
            allCompleted.forEach(task => {
                const date = task.completed || 'Unknown';
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(task);
            });
            
            let html = `
                <div style="padding: 1rem; background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-radius: 8px; margin-bottom: 1rem;">
                    <span style="color: #065f46;"><strong>${allCompleted.length}</strong> tasks completed üéâ</span>
                </div>
            `;
            
            Object.entries(grouped).forEach(([date, tasks]) => {
                html += `<div style="margin-bottom: 0.5rem; font-weight: 600; color: #065f46;">‚úÖ ${date}</div>`;
                tasks.forEach(task => {
                    html += `
                        <div class="task-card completed-task">
                            <h4 class="task-title">${task.title}</h4>
                            ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                        </div>
                    `;
                });
            });
            
            container.innerHTML = html;
        }
        
        // Task CRUD Functions
        function openTaskModal(task = null) {
            document.getElementById('task-id').value = task?.id || '';
            document.getElementById('task-title').value = task?.title || '';
            document.getElementById('task-description').value = task?.description || '';
            document.getElementById('task-priority').value = task?.priority || 'high';
            document.getElementById('task-category').value = task?.category || 'ideas';
            document.getElementById('task-status').value = task?.status || 'todo';
            document.getElementById('task-notes').value = task?.notes || '';
            
            // Show/hide delete button
            const deleteBtn = document.getElementById('task-delete-btn');
            if (deleteBtn) {
                deleteBtn.style.display = task?.id ? 'block' : 'none';
            }
            
            document.getElementById('task-modal-title').textContent = task ? 'üìã Edit Task' : 'üìã Add Task';
            openModal('taskModal');
        }
        
        function deleteTaskFromModal() {
            const taskId = document.getElementById('task-id').value;
            if (taskId) {
                closeModal('taskModal');
                deleteTask(taskId);
            }
        }
        
        function editTaskById(taskId) {
            if (!tasksData) return;
            
            // Find task in active tasks or completed
            let task = tasksData.tasks?.find(t => String(t.id) === String(taskId));
            if (!task && tasksData.completed) {
                task = tasksData.completed.find(t => String(t.id) === String(taskId));
            }
            
            if (task) {
                openTaskModal(task);
            } else {
                showNotification('Task not found', 'error');
            }
        }
        
        async function saveTask(event) {
            event.preventDefault();
            
            const id = document.getElementById('task-id').value;
            const taskData = {
                id: id || 'task-' + Date.now(),
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                priority: document.getElementById('task-priority').value,
                category: document.getElementById('task-category').value,
                status: document.getElementById('task-status').value,
                notes: document.getElementById('task-notes').value
            };
            
            // Update local state
            if (!tasksData) tasksData = { tasks: [], completed: [], categories: [] };
            if (!tasksData.tasks) tasksData.tasks = [];
            
            if (id) {
                // Update existing task
                const idx = tasksData.tasks.findIndex(t => String(t.id) === String(id));
                if (idx !== -1) {
                    tasksData.tasks[idx] = { ...tasksData.tasks[idx], ...taskData };
                } else {
                    // Check in completed
                    const compIdx = tasksData.completed?.findIndex(t => String(t.id) === String(id));
                    if (compIdx !== -1) {
                        tasksData.completed[compIdx] = { ...tasksData.completed[compIdx], ...taskData };
                    }
                }
            } else {
                // Add new task at the beginning
                tasksData.tasks.unshift(taskData);
            }
            
            // Try to save to database (for persistence)
            try {
                const url = '/api/admin/tasks' + (id && !isNaN(id) ? `/${id}` : '');
                const method = id && !isNaN(id) ? 'PUT' : 'POST';
                
                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(taskData)
                });
            } catch (error) {
                console.log('DB save failed (task saved locally):', error);
            }
            
            closeModal('taskModal');
            
            // Reset to "All" view to show the new/updated task
            currentTaskCategory = 'all';
            
            // Rebuild UI
            buildCategoryTabs();
            updateTaskStats();
            renderTasks();
            renderCompletedTasks();
            
            showNotification(id ? 'Task updated!' : 'Task added to ' + taskData.category + '!', 'success');
        }
        
        async function markTaskDoneById(taskId) {
            if (!tasksData) return;
            
            // Try database first
            if (!isNaN(taskId)) {
                try {
                    const response = await fetch(`/api/admin/tasks/${taskId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ status: 'done', completed: new Date().toISOString().split('T')[0] })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showNotification('Task completed! üéâ', 'success');
                        loadTasks();
                        return;
                    }
                } catch (error) {
                    console.log('DB update failed:', error);
                }
            }
            
            // Fallback: Update local state
            const idx = tasksData.tasks.findIndex(t => String(t.id) === String(taskId));
            if (idx !== -1) {
                const task = tasksData.tasks[idx];
                task.status = 'done';
                task.completed = new Date().toISOString().split('T')[0];
                
                // Move to completed
                tasksData.tasks.splice(idx, 1);
                if (!tasksData.completed) tasksData.completed = [];
                tasksData.completed.unshift(task);
                
                showNotification('Task completed! üéâ', 'success');
                updateTaskStats();
                renderTasks();
                renderCompletedTasks();
            }
        }
        
        async function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;
            
            // Try database first
            if (!isNaN(taskId)) {
                try {
                    const response = await fetch(`/api/admin/tasks/${taskId}`, { method: 'DELETE', headers: authHeaders() });
                    const data = await response.json();
                    
                    if (data.success) {
                        showNotification('Task deleted', 'success');
                        loadTasks();
                        return;
                    }
                } catch (error) {
                    console.log('DB delete failed:', error);
                }
            }
            
            // Fallback: Update local state
            if (tasksData?.tasks) {
                tasksData.tasks = tasksData.tasks.filter(t => String(t.id) !== String(taskId));
                showNotification('Task deleted', 'success');
                updateTaskStats();
                renderTasks();
            }
        }

        // =====================================================
        // WEBSITE DEPLOYMENT FUNCTIONS
        // =====================================================
        
        let deployRoomsData = []; // Store loaded rooms grouped by property
        
        async function checkVpsStatus() {
            const statusEl = document.getElementById('vps-status');
            if (!statusEl) return;
            
            try {
                const response = await fetch('/api/deploy/status');
                const data = await response.json();
                
                if (data.success && data.status === 'ready') {
                    statusEl.style.background = '#dcfce7';
                    statusEl.style.color = '#166534';
                    statusEl.innerHTML = '‚úÖ VPS Connected';
                } else {
                    statusEl.style.background = '#fef2f2';
                    statusEl.style.color = '#991b1b';
                    statusEl.innerHTML = '‚ùå VPS Offline';
                }
            } catch (error) {
                statusEl.style.background = '#fef2f2';
                statusEl.style.color = '#991b1b';
                statusEl.innerHTML = '‚ùå VPS Unreachable';
            }
        }
        
        async function loadDeployedSites() {
            const container = document.getElementById('deployed-sites-list');
            if (!container) return;
            
            try {
                let url = '/api/admin/deployed-sites';
                if (selectedAccountId) {
                    url += '?account_id=' + selectedAccountId;
                }
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success || !data.sites || data.sites.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üåê</div>
                            <h3>No sites deployed yet</h3>
                            <p>Click "Create New Site" to create your first website</p>
                        </div>
                    `;
                    updateDeployStats([]);
                    return;
                }
                
                const sites = data.sites;
                updateDeployStats(sites);
                
                // Cache deployed sites for editWebsite lookups
                deployedSitesCache = sites;
                
                // Also update availableWebsites for the selector (include template!)
                availableWebsites = sites.map(s => ({
                    id: s.id,
                    name: s.site_name || s.slug,
                    site_url: s.site_url,
                    admin_url: s.admin_url,
                    status: s.status,
                    account_id: s.account_id,
                    template: s.template || 'developer-light'
                }));
                updateWebsiteSelectors();
                
                let html = '<div style="display: grid; gap: 1rem;">';
                
                sites.forEach(site => {
                    // Determine effective status
                    // Auto-promote to 'live' if custom_domain is set and status is 'deployed'
                    let effectiveStatus = site.status || 'development';
                    if (site.custom_domain && effectiveStatus === 'deployed') {
                        effectiveStatus = 'live';
                    }
                    
                    // Status configuration
                    const statusConfig = {
                        'development': { color: '#f59e0b', icon: 'üî®', label: 'Development' },
                        'deployed': { color: '#7c3aed', icon: 'üöÄ', label: 'Deployed' },
                        'live': { color: '#10b981', icon: '‚úÖ', label: 'Live' },
                        'on-hold': { color: '#6b7280', icon: '‚è∏Ô∏è', label: 'On Hold' },
                        // Legacy status mappings
                        'active': { color: '#10b981', icon: '‚úÖ', label: 'Live' },
                        'pending': { color: '#f59e0b', icon: 'üî®', label: 'Development' },
                        'creating': { color: '#f59e0b', icon: '‚è≥', label: 'Creating...' }
                    };
                    
                    const status = statusConfig[effectiveStatus] || statusConfig['development'];
                    const statusColor = status.color;
                    const statusLabel = `${status.icon} ${status.label}`;
                    
                    let roomCount = 0;
                    try {
                        const roomIds = typeof site.room_ids === 'string' ? JSON.parse(site.room_ids || '[]') : (site.room_ids || []);
                        roomCount = Array.isArray(roomIds) ? roomIds.length : 0;
                    } catch (e) { roomCount = 0; }
                    
                    // Master override dropdown (only show for master accounts)
                    const isMaster = currentAccount && currentAccount.role === 'master_admin';
                    const statusDropdown = isMaster ? `
                        <select onchange="updateSiteStatus(${site.id}, this.value)" 
                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid #e2e8f0; background: white; cursor: pointer; margin-top: 0.5rem;">
                            <option value="development" ${effectiveStatus === 'development' ? 'selected' : ''}>üî® Development</option>
                            <option value="deployed" ${effectiveStatus === 'deployed' ? 'selected' : ''}>üöÄ Deployed</option>
                            <option value="live" ${effectiveStatus === 'live' ? 'selected' : ''}>‚úÖ Live</option>
                            <option value="on-hold" ${effectiveStatus === 'on-hold' ? 'selected' : ''}>‚è∏Ô∏è On Hold</option>
                        </select>
                    ` : '';
                    
                    // Template badge
                    const templateLabel = site.template === 'developer-dark' ? 'üåô Dark' : '‚òÄÔ∏è Light';
                    
                    html += `
                        <div class="card" style="padding: 1rem; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                                <div style="flex: 1; min-width: 200px;">
                                    <h4 style="margin: 0 0 0.5rem 0;">${site.site_name || site.slug}</h4>
                                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        ${site.account_name || 'Unknown Account'}
                                        ${roomCount > 0 ? `<span style="color: #6366f1;"> ‚Ä¢ ${roomCount} rooms</span>` : ''}
                                        <span style="color: #94a3b8;"> ‚Ä¢ ${templateLabel}</span>
                                    </p>
                                    <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button onclick="editWebsite(${site.id})" class="btn btn-small" style="font-size: 0.75rem; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-color: #6366f1;">‚úèÔ∏è Edit</button>
                                        <a href="${site.site_url}" target="_blank" class="btn btn-small" style="font-size: 0.75rem;">üåê View Site</a>
                                        <a href="${site.admin_url}" target="_blank" class="btn btn-small btn-secondary" style="font-size: 0.75rem;">‚öôÔ∏è WP Admin</a>
                                        <button onclick="deleteDeployedSite(${site.id}, '${site.site_name || site.slug}')" class="btn btn-small" style="font-size: 0.75rem; background: #ef4444; border-color: #ef4444;">üóëÔ∏è Delete</button>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; background: ${statusColor}20; color: ${statusColor}; font-weight: 600;">
                                        ${statusLabel}
                                    </span>
                                    ${site.custom_domain ? `
                                        <div style="margin-top: 0.5rem; font-size: 0.7rem; color: #10b981;">
                                            üåê ${site.custom_domain}
                                        </div>
                                    ` : ''}
                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                                        Created: ${site.deployed_at ? new Date(site.deployed_at).toLocaleDateString() : 'N/A'}
                                    </div>
                                    ${site.wp_username ? `
                                        <div style="margin-top: 0.5rem; font-size: 0.7rem; background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px;">
                                            üë§ ${site.wp_username}
                                        </div>
                                    ` : ''}
                                    ${statusDropdown}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading deployed sites:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #991b1b;">
                        <p>‚ùå Error loading sites</p>
                        <button class="btn btn-secondary" onclick="loadDeployedSites()">Try Again</button>
                    </div>
                `;
            }
        }
        
        function updateDeployStats(sites) {
            const totalEl = document.getElementById('deploy-stat-total');
            const activeEl = document.getElementById('deploy-stat-active');
            const pendingEl = document.getElementById('deploy-stat-pending');
            if (totalEl) totalEl.textContent = sites.length;
            // Count 'live' and 'active' (legacy) as active
            if (activeEl) activeEl.textContent = sites.filter(s => s.status === 'live' || s.status === 'active' || (s.status === 'deployed' && s.custom_domain)).length;
            // Count 'development', 'deployed' (without domain), and 'pending' (legacy) 
            if (pendingEl) pendingEl.textContent = sites.filter(s => s.status === 'development' || s.status === 'pending' || (s.status === 'deployed' && !s.custom_domain)).length;
        }
        
        // Master override - update site status
        async function updateSiteStatus(siteId, newStatus) {
            try {
                const response = await fetch(`/api/deployed-sites/${siteId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status: newStatus })
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Site status updated to ${newStatus}`, 'success');
                    loadDeployedSites(); // Refresh the list
                } else {
                    showNotification(data.error || 'Failed to update status', 'error');
                }
            } catch (error) {
                console.error('Error updating site status:', error);
                showNotification('Failed to update status', 'error');
            }
        }
        
        async function deleteDeployedSite(siteId, siteName) {
            if (!confirm(`Are you sure you want to delete "${siteName}"?\n\nThis will:\n‚Ä¢ Delete the WordPress site from the VPS\n‚Ä¢ Remove the deployment record from the database\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/deploy/${siteId}?force=true`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Site deleted successfully', 'success');
                    loadDeployedSites();
                } else {
                    showNotification('Error: ' + (data.error || 'Failed to delete site'), 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Error deleting site: ' + error.message, 'error');
            }
        }
        
        async function openDeployModal() {
            // Reset form
            document.getElementById('deployForm').reset();
            document.getElementById('deploy-progress').style.display = 'none';
            document.getElementById('deploy-result').style.display = 'none';
            document.getElementById('deploy-submit-btn').disabled = false;
            document.getElementById('deploy-submit-btn').textContent = 'üöÄ Deploy Site';
            
            const container = document.getElementById('deploy-rooms-container');
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Loading rooms...</div>';
            
            try {
                // Load properties and rooms
                let propsUrl = '/api/db/properties';
                let roomsUrl = '/api/db/bookable-units';
                
                if (selectedAccountId) {
                    propsUrl += '?account_id=' + selectedAccountId;
                    roomsUrl += '?account_id=' + selectedAccountId;
                }
                
                const [propsRes, roomsRes] = await Promise.all([
                    fetch(propsUrl),
                    fetch(roomsUrl)
                ]);
                
                const propsData = await propsRes.json();
                const roomsData = await roomsRes.json();
                
                const properties = propsData.data || [];
                const rooms = roomsData.data || [];
                
                // Group rooms by property
                deployRoomsData = properties.map(prop => ({
                    property: prop,
                    rooms: rooms.filter(r => r.property_id === prop.id)
                })).filter(group => group.rooms.length > 0);
                
                if (deployRoomsData.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <p>No rooms found for this account</p>
                            <p style="font-size: 0.85rem;">Add rooms to your properties first</p>
                        </div>
                    `;
                    openModal('deployModal');
                    return;
                }
                
                // Build the room selection UI
                let html = '';
                
                deployRoomsData.forEach((group, groupIdx) => {
                    const propRoomCount = group.rooms.length;
                    
                    html += `
                        <div class="deploy-property-group" style="border-bottom: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: #f8fafc; cursor: pointer;" onclick="toggleDeployPropertyGroup(${groupIdx})">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <input type="checkbox" class="deploy-property-checkbox" data-group="${groupIdx}" onchange="togglePropertyRooms(${groupIdx}, this.checked); event.stopPropagation();" checked style="width: 18px; height: 18px;">
                                    <div>
                                        <div style="font-weight: 600;">${group.property.name}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${propRoomCount} room${propRoomCount !== 1 ? 's' : ''}</div>
                                    </div>
                                </div>
                                <span class="deploy-group-arrow" id="deploy-arrow-${groupIdx}" style="transition: transform 0.2s;">‚ñº</span>
                            </div>
                            <div class="deploy-rooms-list" id="deploy-rooms-${groupIdx}" style="padding: 0.5rem 1rem 0.5rem 2.5rem;">
                    `;
                    
                    group.rooms.forEach(room => {
                        html += `
                            <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; cursor: pointer;">
                                <input type="checkbox" class="deploy-room-checkbox" data-group="${groupIdx}" data-room-id="${room.id}" data-room-name="${room.name}" data-property-id="${group.property.id}" data-property-name="${group.property.name}" checked style="width: 16px; height: 16px;" onchange="updateDeployRoomCount()">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${room.name}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                        ${room.max_guests ? `üë• ${room.max_guests} guests` : ''}
                                        ${room.beds ? ` ‚Ä¢ üõèÔ∏è ${room.beds}` : ''}
                                    </div>
                                </div>
                            </label>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                updateDeployRoomCount();
                
            } catch (error) {
                console.error('Error loading rooms:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #991b1b;">
                        <p>Error loading rooms</p>
                    </div>
                `;
            }
            
            openModal('deployModal');
        }
        
        function toggleDeployPropertyGroup(groupIdx) {
            const roomsList = document.getElementById(`deploy-rooms-${groupIdx}`);
            const arrow = document.getElementById(`deploy-arrow-${groupIdx}`);
            
            if (roomsList.style.display === 'none') {
                roomsList.style.display = 'block';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                roomsList.style.display = 'none';
                arrow.style.transform = 'rotate(-90deg)';
            }
        }
        
        function togglePropertyRooms(groupIdx, checked) {
            const checkboxes = document.querySelectorAll(`.deploy-room-checkbox[data-group="${groupIdx}"]`);
            checkboxes.forEach(cb => cb.checked = checked);
            updateDeployRoomCount();
        }
        
        function selectAllDeployRooms() {
            document.querySelectorAll('.deploy-room-checkbox').forEach(cb => cb.checked = true);
            document.querySelectorAll('.deploy-property-checkbox').forEach(cb => cb.checked = true);
            updateDeployRoomCount();
        }
        
        function deselectAllDeployRooms() {
            document.querySelectorAll('.deploy-room-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.deploy-property-checkbox').forEach(cb => cb.checked = false);
            updateDeployRoomCount();
        }
        
        function updateDeployRoomCount() {
            const checked = document.querySelectorAll('.deploy-room-checkbox:checked');
            const countEl = document.getElementById('deploy-room-count');
            if (countEl) {
                countEl.textContent = `${checked.length} room${checked.length !== 1 ? 's' : ''} selected`;
                countEl.style.color = checked.length > 0 ? '#10b981' : '#ef4444';
            }
            
            // Update property checkboxes based on room selection
            deployRoomsData.forEach((group, idx) => {
                const groupRooms = document.querySelectorAll(`.deploy-room-checkbox[data-group="${idx}"]`);
                const checkedRooms = document.querySelectorAll(`.deploy-room-checkbox[data-group="${idx}"]:checked`);
                const propCheckbox = document.querySelector(`.deploy-property-checkbox[data-group="${idx}"]`);
                
                if (propCheckbox) {
                    propCheckbox.checked = checkedRooms.length > 0;
                    propCheckbox.indeterminate = checkedRooms.length > 0 && checkedRooms.length < groupRooms.length;
                }
            });
        }
        
        function getSelectedRooms() {
            const selected = [];
            document.querySelectorAll('.deploy-room-checkbox:checked').forEach(cb => {
                selected.push({
                    room_id: parseInt(cb.dataset.roomId),
                    room_name: cb.dataset.roomName,
                    property_id: parseInt(cb.dataset.propertyId),
                    property_name: cb.dataset.propertyName
                });
            });
            return selected;
        }
        
        async function deployNewSite(event) {
            event.preventDefault();
            
            const siteName = document.getElementById('deploy-site-name').value;
            const slug = document.getElementById('deploy-slug').value;
            const adminEmail = document.getElementById('deploy-admin-email').value;
            const selectedRooms = getSelectedRooms();
            
            // Validation
            if (selectedRooms.length === 0) {
                showNotification('Please select at least one room', 'error');
                return;
            }
            
            if (!siteName || !slug || !adminEmail) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            // Get unique property IDs
            const propertyIds = [...new Set(selectedRooms.map(r => r.property_id))];
            const roomIds = selectedRooms.map(r => r.room_id);
            
            // Show progress
            document.getElementById('deploy-progress').style.display = 'block';
            document.getElementById('deploy-result').style.display = 'none';
            document.getElementById('deploy-submit-btn').disabled = true;
            document.getElementById('deploy-progress-text').textContent = `Creating site with ${selectedRooms.length} rooms...`;
            
            // Get template options
            const useTheme = document.getElementById('deploy-use-theme').checked;
            const usePlugin = document.getElementById('deploy-use-plugin').checked;
            const selectedTemplate = document.querySelector('input[name="deploy-template"]:checked')?.value || 'developer-light';
            
            try {
                const response = await fetch('/api/deploy/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        site_name: siteName,
                        property_ids: propertyIds,
                        room_ids: roomIds,
                        rooms: selectedRooms,
                        slug: slug,
                        admin_email: adminEmail,
                        account_id: selectedAccountId,
                        use_theme: useTheme,
                        use_plugin: usePlugin,
                        template: selectedTemplate
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('deploy-progress').style.display = 'none';
                
                if (data.success) {
                    document.getElementById('deploy-result').style.display = 'block';
                    
                    let resultHtml = `
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Site URL:</strong> <a href="${data.site.url}" target="_blank">${data.site.url}</a>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Admin URL:</strong> <a href="${data.site.admin_url}" target="_blank">${data.site.admin_url}</a>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Rooms:</strong> ${selectedRooms.length} from ${propertyIds.length} propert${propertyIds.length !== 1 ? 'ies' : 'y'}
                        </div>
                    `;
                    
                    if (data.credentials && data.credentials.password) {
                        resultHtml += `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 4px;">
                                <strong>‚ö†Ô∏è Save these login credentials:</strong>
                                <div style="margin-top: 0.5rem; font-family: monospace;">
                                    Username: ${data.credentials.username}<br>
                                    Password: ${data.credentials.password}
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('deploy-result-content').innerHTML = resultHtml;
                    document.getElementById('deploy-submit-btn').textContent = '‚úÖ Done';
                    document.getElementById('deploy-submit-btn').disabled = false;
                    document.getElementById('deploy-submit-btn').onclick = function() { closeModal('deployModal'); };
                    
                    showNotification('Site deployed successfully!', 'success');
                    loadDeployedSites();
                } else {
                    document.getElementById('deploy-submit-btn').disabled = false;
                    showNotification(data.error || 'Deployment failed', 'error');
                }
            } catch (error) {
                document.getElementById('deploy-progress').style.display = 'none';
                document.getElementById('deploy-submit-btn').disabled = false;
                showNotification('Deployment failed: ' + error.message, 'error');
            }
        }

        async function loadIntegrations() {
            const container = document.getElementById('channel-connections');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                // Fetch actual channel connections for this account
                const response = await fetch('/api/channel-connections' + buildQueryString(), { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.connections && data.connections.length > 0) {
                    let html = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Account</th>
                                        <th>Status</th>
                                        <th>Properties</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    for (const conn of data.connections) {
                        const cmName = conn.cm_code === 'beds24' ? 'üõèÔ∏è Beds24' : 
                                       conn.cm_code === 'hostaway' ? 'üè† Hostaway' : 
                                       conn.cm_code === 'smoobu' ? 'üè® Smoobu' : conn.cm_name;
                        const statusBadge = conn.status === 'active' ? 
                            '<span class="badge badge-success">Active</span>' : 
                            '<span class="badge badge-warning">Inactive</span>';
                        
                        html += `
                            <tr>
                                <td><strong>${cmName}</strong></td>
                                <td>${conn.account_name || 'Unknown'}</td>
                                <td>${statusBadge}</td>
                                <td>${conn.property_count || 0}</td>
                                <td>
                                    <button class="btn btn-secondary btn-small" onclick="refreshCMProperties('${conn.cm_code}', ${conn.id})" title="Check for new/removed properties">
                                        üîÑ Refresh
                                    </button>
                                </td>
                            </tr>
                        `;
                    }
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                            <p style="margin-bottom: 1rem;">No channel managers connected yet.</p>
                            <button class="btn btn-primary" onclick="openChannelManagerModal()">+ Connect Channel Manager</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading integrations:', error);
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <p>Error loading integrations. <a href="#" onclick="loadIntegrations(); return false;">Retry</a></p>
                    </div>
                `;
            }
            
            // Initialize webhook URL display
            initWebhookUrl();
        }
        
        // Refresh properties from Channel Manager
        async function refreshCMProperties(cmCode, connectionId) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Checking...';
            
            try {
                // Get connection details (token) from server
                const connResponse = await fetch(`/api/channel-connection/${connectionId}`, { headers: authHeaders() });
                const connData = await connResponse.json();
                
                if (!connData.success) {
                    throw new Error(connData.error || 'Failed to get connection details');
                }
                
                // Call refresh endpoint
                const response = await fetch(`/api/${cmCode}/refresh-properties`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        token: connData.connection.access_token,
                        apiKey: connData.connection.api_key,
                        accountId: getAccountParam() ? new URLSearchParams(window.location.search).get('account') : connData.connection.account_id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showRefreshResultsModal(data, cmCode, connectionId);
                } else {
                    throw new Error(data.error || 'Failed to refresh properties');
                }
            } catch (error) {
                console.error('Error refreshing:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        // Show modal with refresh results
        function showRefreshResultsModal(data, cmCode, connectionId) {
            const cmName = cmCode === 'beds24' ? 'Beds24' : cmCode === 'hostaway' ? 'Hostaway' : 'Smoobu';
            
            let html = `
                <div id="refresh-results-modal" class="modal active">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>üîÑ ${cmName} Property Comparison</h3>
                            <button class="modal-close" onclick="closeRefreshResultsModal()">√ó</button>
                        </div>
                        <div class="modal-body">
            `;
            
            // Existing properties
            html += `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="color: #10b981; font-size: 1.2rem;">‚úÖ</span>
                        <strong>${data.existing.length} existing properties matched</strong>
                    </div>
                </div>
            `;
            
            // New properties
            if (data.new.length > 0) {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="color: #3b82f6; font-size: 1.2rem;">üÜï</span>
                            <strong>${data.new.length} new properties found:</strong>
                        </div>
                        <div style="background: #eff6ff; border-radius: 8px; padding: 1rem;">
                `;
                
                data.new.forEach((prop, i) => {
                    html += `
                        <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; ${i > 0 ? 'border-top: 1px solid #bfdbfe;' : ''}">
                            <input type="checkbox" class="new-prop-checkbox" data-cm-id="${prop.cm_id}" data-name="${prop.name.replace(/"/g, '&quot;')}" checked>
                            <div>
                                <div style="font-weight: 500;">${prop.name}</div>
                                <div style="font-size: 0.85rem; color: #64748b;">${prop.city || 'No location'} ¬∑ ${prop.rooms || 1} room(s)</div>
                            </div>
                        </label>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Removed properties
            if (data.removed.length > 0) {
                html += `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="color: #f59e0b; font-size: 1.2rem;">‚ö†Ô∏è</span>
                            <strong>${data.removed.length} properties no longer in ${cmName}:</strong>
                        </div>
                        <div style="background: #fef3c7; border-radius: 8px; padding: 1rem;">
                `;
                
                data.removed.forEach((prop, i) => {
                    html += `
                        <div style="padding: 0.5rem 0; ${i > 0 ? 'border-top: 1px solid #fde68a;' : ''}">
                            <div style="font-weight: 500;">${prop.name}</div>
                            <div style="font-size: 0.85rem; color: #92400e;">GAS ID: ${prop.gas_id}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <p style="font-size: 0.85rem; color: #92400e; margin-top: 0.5rem;">
                            ‚ÑπÔ∏è Removed properties remain in GAS. You can archive them manually if needed.
                        </p>
                    </div>
                `;
            }
            
            // No changes message
            if (data.new.length === 0 && data.removed.length === 0) {
                html += `
                    <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 8px; color: #166534;">
                        ‚úÖ All properties are in sync - no changes detected!
                    </div>
                `;
            }
            
            html += `
                        </div>
                        <div class="modal-footer" style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border);">
            `;
            
            if (data.new.length > 0) {
                html += `<button class="btn btn-primary" onclick="importSelectedNewProperties('${cmCode}', ${connectionId})">Import Selected</button>`;
            }
            
            html += `
                            <button class="btn btn-secondary" onclick="closeRefreshResultsModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeRefreshResultsModal() {
            const modal = document.getElementById('refresh-results-modal');
            if (modal) modal.remove();
        }
        
        async function importSelectedNewProperties(cmCode, connectionId) {
            const checkboxes = document.querySelectorAll('.new-prop-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one property to import');
                return;
            }
            
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Importing...';
            
            try {
                // Get connection details
                const connResponse = await fetch(`/api/channel-connection/${connectionId}`, { headers: authHeaders() });
                const connData = await connResponse.json();
                
                let imported = 0;
                let failed = 0;
                
                for (const checkbox of checkboxes) {
                    const cmId = checkbox.dataset.cmId;
                    const name = checkbox.dataset.name;
                    
                    try {
                        const endpoint = cmCode === 'beds24' ? '/api/beds24/import-complete-property' :
                                        cmCode === 'hostaway' ? '/api/hostaway/import-property' :
                                        '/api/smoobu/import-property';
                        
                        const body = cmCode === 'beds24' ? {
                            propertyId: cmId,
                            connectionId: connectionId,
                            token: connData.connection.access_token
                        } : cmCode === 'hostaway' ? {
                            property: { id: cmId, name: name },
                            token: connData.connection.access_token,
                            connectionId: connectionId
                        } : {
                            apiKey: connData.connection.api_key,
                            apartmentId: cmId,
                            clientId: connData.connection.account_id
                        };
                        
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify(body)
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            imported++;
                        } else {
                            failed++;
                        }
                    } catch (e) {
                        failed++;
                    }
                }
                
                closeRefreshResultsModal();
                alert(`Imported ${imported} properties${failed > 0 ? ` (${failed} failed)` : ''}`);
                loadIntegrations();
                
            } catch (error) {
                console.error('Error importing:', error);
                alert('Error importing properties: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Import Selected';
            }
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = '';  // Reset display in case it was set to 'none'
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // List of dynamically created modals that should be removed
                const dynamicModals = ['assignAgencyModal', 'changeRoleModal', 'passwordResetModal'];
                
                if (dynamicModals.includes(modalId)) {
                    modal.remove();
                } else {
                    modal.classList.remove('active');
                    modal.style.display = 'none';
                }
            }
        }

        let allAmenitiesData = [];
        
        async function openAddAmenityModal() {
            // Load all amenities
            await loadAllAmenitiesData();
            
            // Reset form
            document.getElementById('new-amenity-name').value = '';
            document.getElementById('new-amenity-icon').value = '';
            document.getElementById('new-category-name').value = '';
            document.getElementById('category-amenities-list').style.display = 'none';
            document.getElementById('add-amenity-section').style.display = 'none';
            document.getElementById('amenity-category-select').value = '';
            
            openModal('addAmenityModal');
        }
        
        async function loadAllAmenitiesData() {
            try {
                const response = await fetch('/api/admin/amenities');
                const data = await response.json();
                
                if (data.success && data.amenities) {
                    allAmenitiesData = data.amenities;
                    
                    // Get unique categories
                    const categories = [...new Set(data.amenities.map(a => a.category))].sort();
                    
                    const categoryIcons = {
                        'essentials': 'üì∂', 'beds': 'üõèÔ∏è', 'bathrooms': 'üöø', 'kitchen': 'üç≥',
                        'parking': 'üöó', 'entertainment': 'üì∫', 'wellness': 'üíÜ', 'outdoor': 'üå≥',
                        'safety': 'üîí', 'accessibility': '‚ôø', 'services': 'üõéÔ∏è', 'room_features': 'üè†'
                    };
                    
                    const select = document.getElementById('amenity-category-select');
                    select.innerHTML = '<option value="">Choose a category...</option>';
                    
                    categories.forEach(cat => {
                        const icon = categoryIcons[cat] || '‚ú®';
                        const displayName = cat.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        const count = data.amenities.filter(a => a.category === cat).length;
                        select.innerHTML += `<option value="${cat}">${icon} ${displayName} (${count})</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading amenities:', error);
            }
        }
        
        function loadCategoryAmenities() {
            const category = document.getElementById('amenity-category-select').value;
            const listContainer = document.getElementById('category-amenities-list');
            const amenitiesContainer = document.getElementById('amenities-in-category');
            const addSection = document.getElementById('add-amenity-section');
            
            if (!category) {
                listContainer.style.display = 'none';
                addSection.style.display = 'none';
                return;
            }
            
            // Filter amenities by category
            const categoryAmenities = allAmenitiesData.filter(a => a.category === category);
            
            // Display amenities
            amenitiesContainer.innerHTML = categoryAmenities.map(a => {
                const name = typeof a.amenity_name === 'object' ? a.amenity_name.en : a.amenity_name;
                return `
                    <span style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--bg-card); border-radius: 6px; font-size: 0.9rem;">
                        ${a.icon || '‚úì'} ${name}
                        <button onclick="deleteSingleAmenity(${a.id}, '${name.replace(/'/g, "\\'")}')" style="background: none; border: none; color: var(--error); cursor: pointer; padding: 0; margin-left: 0.25rem; font-size: 1.1rem; line-height: 1;">√ó</button>
                    </span>
                `;
            }).join('');
            
            listContainer.style.display = 'block';
            addSection.style.display = 'block';
        }
        
        async function deleteSingleAmenity(id, name) {
            if (!confirm(`Delete "${name}"?`)) return;
            
            try {
                const response = await fetch(`/api/admin/amenities/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    await loadAllAmenitiesData();
                    loadCategoryAmenities();
                    loadAmenities();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting amenity:', error);
                alert('Error deleting amenity');
            }
        }
        
        async function addAmenityToCategory() {
            const category = document.getElementById('amenity-category-select').value;
            const name = document.getElementById('new-amenity-name').value.trim();
            const icon = document.getElementById('new-amenity-icon').value.trim();
            
            if (!category || !name) {
                alert('Please select a category and enter an amenity name');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/amenities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ name, category, icon })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('new-amenity-name').value = '';
                    document.getElementById('new-amenity-icon').value = '';
                    await loadAllAmenitiesData();
                    loadCategoryAmenities();
                    loadAmenities(); // Refresh main amenities view
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding amenity:', error);
                alert('Error adding amenity');
            }
        }
        
        async function createNewCategory() {
            const categoryName = document.getElementById('new-category-name').value.trim();
            
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }
            
            // Convert to code format
            const categoryCode = categoryName.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
            
            // Add a placeholder amenity to create the category
            try {
                const response = await fetch('/api/admin/amenities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        name: categoryName + ' (default)', 
                        category: categoryCode, 
                        icon: '‚ú®' 
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('new-category-name').value = '';
                    await loadAllAmenitiesData();
                    document.getElementById('amenity-category-select').value = categoryCode;
                    loadCategoryAmenities();
                    loadAmenities();
                    alert('Category created! You can now add amenities to it.');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating category:', error);
                alert('Error creating category');
            }
        }
        
        function autoSuggestIcon() {
            const name = document.getElementById('new-amenity-name').value.toLowerCase();
            const iconInput = document.getElementById('new-amenity-icon');
            
            // Only suggest if icon field is empty
            if (iconInput.value) return;
            
            const iconMap = {
                // TV & Entertainment
                'tv': 'üì∫', 'television': 'üì∫', 'smart tv': 'üì∫', 'netflix': 'üì∫', 'streaming': 'üì∫',
                'cable': 'üì∫', 'satellite': 'üì∫', 'dvd': 'üìÄ', 'blu-ray': 'üìÄ', 'gaming': 'üéÆ',
                'playstation': 'üéÆ', 'xbox': 'üéÆ', 'nintendo': 'üéÆ', 'speaker': 'üîä', 'sound': 'üîä',
                'bluetooth': 'üì∂', 'radio': 'üìª', 'music': 'üéµ', 'stereo': 'üéµ',
                
                // Beds
                'bed': 'üõèÔ∏è', 'king': 'üõèÔ∏è', 'queen': 'üõèÔ∏è', 'double': 'üõèÔ∏è', 'single': 'üõèÔ∏è',
                'twin': 'üõèÔ∏è', 'bunk': 'üõèÔ∏è', 'sofa bed': 'üõãÔ∏è', 'futon': 'üõãÔ∏è', 'cot': 'üë∂',
                'crib': 'üë∂', 'mattress': 'üõèÔ∏è', 'pillow': 'üõèÔ∏è', 'duvet': 'üõèÔ∏è', 'blanket': 'üõèÔ∏è',
                
                // Bathroom
                'shower': 'üöø', 'bath': 'üõÅ', 'bathtub': 'üõÅ', 'toilet': 'üöΩ', 'bidet': 'üöø',
                'towel': 'üß¥', 'hairdryer': 'üí®', 'hair dryer': 'üí®', 'shampoo': 'üß¥', 'soap': 'üßº',
                'vanity': 'ü™û', 'mirror': 'ü™û', 'jacuzzi': 'üõÅ', 'hot tub': 'üõÅ', 'sauna': 'üßñ',
                
                // Kitchen
                'kitchen': 'üç≥', 'stove': 'üç≥', 'oven': 'üç≥', 'microwave': 'üìª', 'fridge': 'üßä',
                'refrigerator': 'üßä', 'freezer': 'üßä', 'dishwasher': 'üçΩÔ∏è', 'coffee': '‚òï',
                'espresso': '‚òï', 'kettle': 'ü´ñ', 'tea': 'ü´ñ', 'toaster': 'üçû', 'blender': 'ü•§',
                'utensils': 'üç¥', 'cookware': 'üç≥', 'dishes': 'üçΩÔ∏è', 'wine': 'üç∑', 'glasses': 'ü•É',
                
                // Temperature
                'air conditioning': '‚ùÑÔ∏è', 'ac': '‚ùÑÔ∏è', 'cooling': '‚ùÑÔ∏è', 'heating': 'üî•',
                'heater': 'üî•', 'fireplace': 'üî•', 'fan': 'üí®', 'thermostat': 'üå°Ô∏è',
                
                // Internet & Tech
                'wifi': 'üì∂', 'internet': 'üì∂', 'ethernet': 'üîå', 'computer': 'üíª',
                'laptop': 'üíª', 'desk': 'üñ•Ô∏è', 'workspace': 'üíº', 'printer': 'üñ®Ô∏è', 'charger': 'üîå',
                'usb': 'üîå', 'outlet': 'üîå', 'phone': 'üì±', 'telephone': '‚òéÔ∏è',
                
                // Laundry
                'washer': 'üß∫', 'washing': 'üß∫', 'dryer': 'üß∫', 'laundry': 'üß∫', 'iron': 'üëî',
                'ironing': 'üëî', 'hanger': 'üëî', 'closet': 'üö™', 'wardrobe': 'üö™',
                
                // Outdoor
                'pool': 'üèä', 'swimming': 'üèä', 'garden': 'üå≥', 'patio': 'üå≥', 'balcony': 'üåÖ',
                'terrace': 'üåÖ', 'deck': 'üå≥', 'bbq': 'üçñ', 'grill': 'üçñ', 'barbecue': 'üçñ',
                'beach': 'üèñÔ∏è', 'lake': 'üåä', 'ocean': 'üåä', 'view': 'üåÖ', 'mountain': '‚õ∞Ô∏è',
                
                // Parking
                'parking': 'üöó', 'garage': 'üöó', 'car': 'üöó', 'ev': '‚ö°', 'charging': '‚ö°',
                'electric': '‚ö°', 'bike': 'üö≤', 'bicycle': 'üö≤',
                
                // Safety
                'safe': 'üîí', 'lock': 'üîê', 'security': 'üîí', 'alarm': 'üö®', 'camera': 'üì∑',
                'smoke': 'üö≠', 'fire': 'üßØ', 'extinguisher': 'üßØ', 'first aid': 'üè•',
                'detector': 'üö®', 'carbon': 'üö®',
                
                // Accessibility
                'wheelchair': '‚ôø', 'accessible': '‚ôø', 'elevator': 'üõó', 'lift': 'üõó',
                'ramp': '‚ôø', 'grab bar': '‚ôø', 'step-free': '‚ôø',
                
                // Pets
                'pet': 'üêï', 'dog': 'üêï', 'cat': 'üêà', 'animal': 'üêæ',
                
                // Kids
                'child': 'üë∂', 'kid': 'üë∂', 'baby': 'üë∂', 'high chair': 'üë∂', 'toys': 'üß∏',
                
                // Wellness
                'gym': 'üèãÔ∏è', 'fitness': 'üèãÔ∏è', 'yoga': 'üßò', 'spa': 'üíÜ', 'massage': 'üíÜ',
                
                // Other
                'key': 'üîë', 'keyless': 'üîë', 'luggage': 'üß≥', 'storage': 'üì¶',
                'breakfast': 'üç≥', 'food': 'üçΩÔ∏è', 'dining': 'üçΩÔ∏è', 'room service': 'üõéÔ∏è',
                'concierge': 'üõéÔ∏è', 'reception': 'üõéÔ∏è', 'housekeeping': 'üßπ', 'cleaning': 'üßπ'
            };
            
            // Check for matches
            for (const [keyword, icon] of Object.entries(iconMap)) {
                if (name.includes(keyword)) {
                    iconInput.value = icon;
                    return;
                }
            }
        }
        
        async function deleteAllInCategory() {
            const category = document.getElementById('amenity-category-select').value;
            
            if (!category) {
                alert('Please select a category first');
                return;
            }
            
            const categoryAmenities = allAmenitiesData.filter(a => a.category === category);
            const displayName = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            if (!confirm(`Delete ALL ${categoryAmenities.length} amenities in "${displayName}"?\n\nThis cannot be undone!`)) {
                return;
            }
            
            try {
                let deleted = 0;
                for (const amenity of categoryAmenities) {
                    const response = await fetch(`/api/admin/amenities/${amenity.id}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) deleted++;
                }
                
                alert(`Deleted ${deleted} amenities from ${displayName}`);
                await loadAllAmenitiesData();
                loadCategoryAmenities();
                loadAmenities();
            } catch (error) {
                console.error('Error deleting amenities:', error);
                alert('Error deleting amenities');
            }
        }
        
        async function deleteAllAmenities() {
            const totalCount = allAmenitiesData.length;
            
            if (!confirm(`‚ö†Ô∏è DELETE ALL ${totalCount} AMENITIES?\n\nThis will remove EVERY amenity from your system.\n\nThis action CANNOT be undone!\n\nType "DELETE" to confirm.`)) {
                return;
            }
            
            const confirmation = prompt('Type DELETE to confirm:');
            if (confirmation !== 'DELETE') {
                alert('Deletion cancelled');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/amenities/delete-all', {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert(`Deleted ${result.deleted} amenities`);
                    await loadAllAmenitiesData();
                    document.getElementById('amenity-category-select').value = '';
                    document.getElementById('category-amenities-list').style.display = 'none';
                    document.getElementById('add-amenity-section').style.display = 'none';
                    loadAmenities();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting all amenities:', error);
                alert('Error deleting amenities');
            }
        }

        // AVAILABILITY GRID FUNCTIONS
        // ========================================
        
        let gridStartDate = new Date();
        let gridRooms = [];
        let gridData = {}; // roomId -> { date -> data }
        const GRID_DAYS = 14; // Show 2 weeks at a time
        
        let allRooms = []; // Store all rooms for filtering
        let availabilityViewLoaded = false;
        
        async function loadAvailabilityView() {
            // Reset loaded flag when account filter changes
            availabilityViewLoaded = false;
            
            // Set start date to today
            gridStartDate = new Date();
            gridStartDate.setHours(0, 0, 0, 0);
            
            // Set default edit dates
            const today = new Date();
            document.getElementById('edit-from-date').value = today.toISOString().split('T')[0];
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('edit-to-date').value = nextWeek.toISOString().split('T')[0];
            
            // Load properties for filter (filtered by account)
            try {
                const queryString = buildQueryString();
                const propsResponse = await fetch(`/api/db/properties${queryString}`);
                const propsData = await propsResponse.json();
                
                const propFilter = document.getElementById('grid-property-filter');
                if (propFilter && propsData.success) {
                    propFilter.innerHTML = '<option value="">All Properties</option>' +
                        propsData.data.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
            
            // Load rooms (filtered by account)
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/bookable-units${queryString}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    allRooms = data.data;
                    gridRooms = data.data;
                    
                    // Populate edit room select
                    const select = document.getElementById('edit-room-select');
                    select.innerHTML = '<option value="">All Rooms</option>' +
                        data.data.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
            
            await loadGridData();
        }
        
        function filterGridByProperty() {
            const propFilter = document.getElementById('grid-property-filter');
            const propertyId = propFilter.value;
            
            console.log('=== FILTER DEBUG ===');
            console.log('Selected property ID:', propertyId);
            console.log('allRooms count:', allRooms.length);
            
            if (propertyId) {
                gridRooms = allRooms.filter(r => {
                    const match = String(r.property_id) === String(propertyId);
                    return match;
                });
                console.log('Filtered to', gridRooms.length, 'rooms for property', propertyId);
            } else {
                gridRooms = [...allRooms];
                console.log('Showing all', gridRooms.length, 'rooms');
            }
            
            // Update edit room select with filtered rooms
            const select = document.getElementById('edit-room-select');
            select.innerHTML = '<option value="">All Rooms</option>' +
                gridRooms.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            
            // Make sure we preserve the dropdown selection
            propFilter.value = propertyId;
            
            loadGridData();
        }
        
        function shiftGridDays(days) {
            gridStartDate.setDate(gridStartDate.getDate() + days);
            loadGridData();
        }
        
        function jumpToDate(dateStr) {
            if (dateStr) {
                gridStartDate = new Date(dateStr);
                loadGridData();
            }
        }
        
        function goToToday() {
            gridStartDate = new Date();
            gridStartDate.setHours(0, 0, 0, 0);
            loadGridData();
        }
        
        async function refreshCalendar() {
            // Refresh calendar data without changing the current date position
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥';
            btn.disabled = true;
            
            try {
                await loadGridData();
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function loadGridData() {
            const fromDate = gridStartDate.toISOString().split('T')[0];
            const endDate = new Date(gridStartDate);
            endDate.setDate(endDate.getDate() + GRID_DAYS - 1);
            const toDate = endDate.toISOString().split('T')[0];
            
            // Update date range display and date picker with month name
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const startMonth = monthNames[gridStartDate.getMonth()];
            const endMonth = monthNames[endDate.getMonth()];
            const startYear = gridStartDate.getFullYear();
            const endYear = endDate.getFullYear();
            
            let dateRangeText = '';
            if (startMonth === endMonth && startYear === endYear) {
                dateRangeText = `${startMonth} ${startYear} (${gridStartDate.getDate()} - ${endDate.getDate()})`;
            } else if (startYear === endYear) {
                dateRangeText = `${startMonth} ${gridStartDate.getDate()} - ${endMonth} ${endDate.getDate()}, ${startYear}`;
            } else {
                dateRangeText = `${startMonth} ${gridStartDate.getDate()}, ${startYear} - ${endMonth} ${endDate.getDate()}, ${endYear}`;
            }
            
            document.getElementById('grid-date-range').textContent = dateRangeText;
            document.getElementById('grid-date-picker').value = fromDate;
            
            // Load availability for all rooms
            gridData = {};
            
            for (const room of gridRooms) {
                try {
                    const response = await fetch(`/api/availability/${room.id}?from=${fromDate}&to=${toDate}`);
                    const data = await response.json();
                    
                    if (data.success && data.availability) {
                        gridData[room.id] = {};
                        data.availability.forEach(a => {
                            gridData[room.id][a.date] = a;
                        });
                    }
                } catch (error) {
                    console.error(`Error loading availability for room ${room.id}:`, error);
                }
            }
            
            renderGrid();
        }
        
        function renderGrid() {
            const table = document.getElementById('availability-grid');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate dates array
            const dates = [];
            for (let i = 0; i < GRID_DAYS; i++) {
                const d = new Date(gridStartDate);
                d.setDate(d.getDate() + i);
                dates.push(d);
            }
            
            // Build header row
            let html = '<thead><tr>';
            html += '<th style="position: sticky; left: 0; background: #f9fafb; z-index: 10; padding: 8px; min-width: 180px; text-align: left; font-weight: 600; color: #374151;">Room</th>';
            html += '<th style="padding: 4px; min-width: 45px; text-align: center; background: #f9fafb;">Row</th>';
            
            dates.forEach(d => {
                const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = d.getDate();
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const isToday = d.getTime() === today.getTime();
                
                html += `<th style="padding: 4px 2px; min-width: 52px; text-align: center; font-weight: normal; 
                    background: ${isWeekend ? '#f3f4f6' : '#f9fafb'};
                    ${isToday ? 'background: #dbeafe; font-weight: 600;' : ''}">
                    <div style="font-size: 0.65rem; color: #9ca3af;">${dayName}</div>
                    <div style="color: #374151;">${dayNum}</div>
                </th>`;
            });
            html += '</tr></thead>';
            
            // Build body rows - one row per room per data type
            html += '<tbody>';
            
            gridRooms.forEach(room => {
                const roomData = gridData[room.id] || {};
                
                // Row 1: Status (Available/Blocked/Booked)
                html += '<tr>';
                html += `<td rowspan="2" style="position: sticky; left: 0; background: #ffffff; z-index: 5; padding: 8px; font-weight: 500; border-bottom: 2px solid #e5e7eb; color: #1f2937;">${room.name}</td>`;
                html += `<td style="padding: 4px; font-size: 0.65rem; color: #9ca3af; background: #fafafa;">Status</td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = roomData[dateStr];
                    const isPast = d < today;
                    
                    let bgColor = '#d1fae5'; // green - available
                    let text = '';
                    let textColor = '#065f46';
                    let isBooked = false;
                    let bookingId = null;
                    
                    if (dayData) {
                        if (dayData.is_booked || (!dayData.is_available && !dayData.is_blocked)) {
                            bgColor = '#fee2e2'; // red - booked
                            text = dayData.guest_name ? dayData.guest_name.split(' ')[0] : '√ó';
                            textColor = '#991b1b';
                            isBooked = true;
                            bookingId = dayData.booking_id || null;
                        } else if (dayData.is_blocked) {
                            bgColor = '#fef3c7'; // yellow
                            text = '‚úï';
                            textColor = '#92400e';
                        }
                    }
                    
                    if (isPast) {
                        bgColor = '#f3f4f6';
                        textColor = '#9ca3af';
                    }
                    
                    // If booked, clicking opens booking detail; otherwise select date range
                    const clickHandler = isBooked && bookingId 
                        ? `openBookingDetail(${bookingId})`
                        : `selectDateRange('${room.id}', '${dateStr}')`;
                    const cursorStyle = isPast ? 'default' : 'pointer';
                    const titleAttr = isBooked && dayData.guest_name ? `title="View booking: ${dayData.guest_name}"` : '';
                    
                    html += `<td style="padding: 2px; text-align: center; background: ${bgColor}; color: ${textColor}; font-size: 0.7rem; cursor: ${cursorStyle};"
                        ${titleAttr}
                        onclick="${clickHandler}">${text}</td>`;
                });
                html += '</tr>';
                
                // Row 2: Price
                html += '<tr style="border-bottom: 2px solid #e5e7eb;">';
                html += `<td style="padding: 4px; font-size: 0.65rem; color: #9ca3af; background: #fafafa;">Price</td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = roomData[dateStr];
                    const isPast = d < today;
                    
                    let priceText = '-';
                    let priceStyle = 'color: var(--text-secondary);';
                    
                    if (dayData && !isPast) {
                        if (dayData.direct_price && dayData.cm_price && dayData.direct_price != dayData.cm_price) {
                            // Show direct price in green (discounted)
                            priceText = `${Math.round(dayData.direct_price)}`;
                            priceStyle = 'color: #10b981; font-weight: 500;';
                        } else if (dayData.cm_price) {
                            priceText = `${Math.round(dayData.cm_price)}`;
                        } else if (dayData.direct_price) {
                            priceText = `${Math.round(dayData.direct_price)}`;
                        }
                    }
                    
                    html += `<td style="padding: 2px; text-align: center; font-size: 0.7rem; ${priceStyle} ${isPast ? 'opacity: 0.4;' : ''}">${priceText}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function selectDateRange(roomId, dateStr) {
            document.getElementById('edit-room-select').value = roomId;
            document.getElementById('edit-from-date').value = dateStr;
            document.getElementById('edit-to-date').value = dateStr;
        }
        
        function toggleEditInputs() {
            const action = document.getElementById('edit-action').value;
            document.getElementById('edit-price-group').style.display = action === 'price' ? 'block' : 'none';
            document.getElementById('edit-discount-group').style.display = action === 'discount' ? 'block' : 'none';
        }
        
        async function applyQuickEdit() {
            const roomId = document.getElementById('edit-room-select').value;
            const fromDate = document.getElementById('edit-from-date').value;
            const toDate = document.getElementById('edit-to-date').value;
            const action = document.getElementById('edit-action').value;
            const price = document.getElementById('edit-price').value;
            const discount = document.getElementById('edit-discount').value;
            
            if (!fromDate || !toDate) return alert('Please select dates');
            
            // Determine which rooms to update
            const roomsToUpdate = roomId ? [roomId] : gridRooms.map(r => r.id);
            
            let totalUpdated = 0;
            
            for (const rid of roomsToUpdate) {
                const payload = {
                    room_id: rid,
                    from_date: fromDate,
                    to_date: toDate,
                    status: (action === 'block') ? 'blocked' : 'available'
                };
                
                if (action === 'price' && price) {
                    payload.price = price;
                } else if (action === 'discount' && discount) {
                    payload.discount_percent = discount;
                }
                
                try {
                    const response = await fetch('/api/admin/availability', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.success) {
                        totalUpdated += result.days_updated;
                    }
                } catch (error) {
                    console.error('Error updating:', error);
                }
            }
            
            alert(`Updated ${totalUpdated} day(s) across ${roomsToUpdate.length} room(s)`);
            loadGridData();
        }
        
        async function syncBeds24() {
            if (!confirm('Sync bookings from Beds24? (Fast - just new bookings)')) return;
            
            const btn = document.getElementById('sync-beds24-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';
            
            let message = '';
            
            try {
                // First sync prices/availability
                btn.textContent = '‚è≥ Syncing prices...';
                const priceResponse = await fetch('/api/admin/sync-all-availability-quick', { method: 'POST', headers: authHeaders() });
                const priceResult = await priceResponse.json();
                
                if (priceResult.success) {
                    message += `üìä Prices: ${priceResult.roomsCount || 0} rooms synced\n`;
                } else {
                    message += `‚ö†Ô∏è Price sync: ${priceResult.error || 'Failed'}\n`;
                }
                
                // Sync bookings
                btn.textContent = '‚è≥ Syncing bookings...';
                const bookingResponse = await fetch('/api/admin/sync-beds24-bookings', { method: 'POST', headers: authHeaders() });
                const bookingResult = await bookingResponse.json();
                
                if (bookingResult.success) {
                    message += `üìÖ Bookings: ${bookingResult.bookingsFound || 0} found, ${bookingResult.datesUpdated || 0} blocked, ${bookingResult.datesUnblocked || 0} unblocked`;
                    if (bookingResult.gasBookingsCancelled > 0) {
                        message += `\n‚ö†Ô∏è ${bookingResult.gasBookingsCancelled} GAS bookings marked cancelled`;
                    }
                } else {
                    message += `‚ö†Ô∏è Booking sync: ${bookingResult.error || 'Failed'}`;
                }
                
                alert('‚úÖ Beds24 Sync complete!\n\n' + message);
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Beds24';
            loadGridData();
        }
        
        async function syncBeds24FullInventory() {
            if (!confirm('Run FULL inventory sync? This checks all dates for the next 365 days. Usually runs automatically every 6 hours.')) return;
            
            const btn = document.getElementById('sync-beds24-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Full sync (1-2 min)...';
            
            try {
                const response = await fetch('/api/admin/sync-beds24-inventory', { method: 'POST', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Full Inventory Sync Complete!\n\nüóìÔ∏è ${result.roomsChecked || 0} rooms checked (365 days)\nüö´ ${result.inventoryBlocksFound || 0} blocked dates\n‚úÖ ${result.datesUnblocked || 0} dates unblocked`);
                } else {
                    alert(`‚ùå Sync failed: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Beds24';
            loadGridData();
        }
        
        async function syncHostaway() {
            if (!confirm('Sync availability and pricing from Hostaway?')) return;
            
            const btn = document.getElementById('sync-hostaway-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';
            
            try {
                const response = await fetch('/api/admin/sync-hostaway-availability', { method: 'POST', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Hostaway Sync complete!\n\n${result.roomsSynced} listings\n${result.totalPricesUpdated} prices`);
                } else {
                    alert(`‚ùå Hostaway Sync failed: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Hostaway';
            loadGridData();
        }

        async function syncSmoobu() {
            if (!confirm('Sync availability and pricing from Smoobu?')) return;
            
            const btn = document.getElementById('sync-smoobu-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';
            
            try {
                const response = await fetch('/api/admin/sync-smoobu-availability', { method: 'POST', headers: authHeaders() });
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Smoobu Sync complete!\n\n${result.roomsSynced || result.apartmentsSynced || 0} apartments\n${result.totalPricesUpdated || 0} prices updated`);
                } else {
                    alert(`‚ùå Smoobu Sync failed: ${result.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Smoobu';
            loadGridData();
        }

        // =====================================================
        // OFFERS FUNCTIONS
        // =====================================================
        
        let offersStartDate = new Date();
        offersStartDate.setHours(0, 0, 0, 0);
        
        async function loadOffers() {
            // Load properties dropdown (filtered by account)
            try {
                const queryString = buildQueryString();
                const propsResponse = await fetch(`/api/db/properties${queryString}`);
                const propsData = await propsResponse.json();
                
                const propSelect = document.getElementById('offers-property-select');
                if (propSelect) {
                    propSelect.innerHTML = '<option value="">Select Property...</option>';
                    if (propsData.success && propsData.data) {
                        propsData.data.forEach(p => {
                            propSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadOffersRooms() {
            const propertyId = document.getElementById('offers-property-select').value;
            const roomSelect = document.getElementById('offers-room-select');
            
            roomSelect.innerHTML = '<option value="">Select Room...</option>';
            document.getElementById('offers-pricing-grid').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Select a room to view pricing</p>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const rooms = data.data.filter(r => r.property_id == propertyId);
                    rooms.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadOffersPricingGrid() {
            const roomId = document.getElementById('offers-room-select').value;
            const container = document.getElementById('offers-pricing-grid');
            const distributionCard = document.getElementById('offer-distribution-card');
            
            if (!roomId) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Select a room to view pricing</p>';
                distributionCard.style.display = 'none';
                return;
            }
            
            // Calculate date range (14 days)
            const dates = [];
            for (let i = 0; i < 14; i++) {
                const d = new Date(offersStartDate);
                d.setDate(d.getDate() + i);
                dates.push(d);
            }
            
            const fromDate = dates[0].toISOString().split('T')[0];
            const toDate = dates[dates.length - 1].toISOString().split('T')[0];
            
            try {
                // Get availability data
                const response = await fetch(`/api/availability/${roomId}?from=${fromDate}&to=${toDate}`);
                const data = await response.json();
                
                // Get currency from response (defaults to ¬£ for UK properties)
                const currencySymbol = data.currency_symbol || '¬£';
                
                // Get occupancy settings for this room
                let occupancySettings = {};
                try {
                    const occResponse = await fetch(`/api/rooms/${roomId}/occupancy-settings`);
                    const occData = await occResponse.json();
                    if (occData.success) {
                        occupancySettings = occData.data;
                    }
                } catch (e) {
                    console.log('Could not load occupancy settings:', e);
                }
                
                // Attach occupancy settings to data for grid rendering
                data.occupancy_settings = occupancySettings;
                data.currency_symbol = currencySymbol;
                
                // Get offers for this room
                const offersResponse = await fetch('/api/admin/offers');
                const offersData = await offersResponse.json();
                const roomOffers = (offersData.data || []).filter(o => !o.room_id || o.room_id == roomId);
                
                // Ensure "Standard Price" offer exists (create virtually if not in DB)
                let standardOffer = roomOffers.find(o => o.name === 'Standard Price');
                const otherOffers = roomOffers.filter(o => o.name !== 'Standard Price' && o.active);
                
                // Build the new grid
                let html = `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 900px;">
                            <thead>
                                <tr style="background: var(--bg-secondary);">
                                    <th style="padding: 0.75rem; text-align: left; position: sticky; left: 0; background: var(--bg-secondary); min-width: 180px; z-index: 2;">PRICE TYPE</th>
                `;
                
                // Date headers
                dates.forEach(d => {
                    const dayName = d.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                    const dayNum = d.getDate();
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<th style="padding: 0.5rem; text-align: center; min-width: 75px; ${isWeekend ? 'background: #fef3c7;' : ''}">${dayName}<br><span style="font-size: 1.1rem;">${dayNum}</span></th>`;
                });
                
                html += `</tr></thead><tbody>`;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // ROW 1: Reference (CM) - LOCKED
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                html += `
                    <tr style="background: #f1f5f9; border-bottom: 2px solid #cbd5e1;">
                        <td style="padding: 0.75rem; position: sticky; left: 0; background: #f1f5f9; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üîí</span>
                                <div>
                                    <strong>Reference (CM)</strong>
                                    <div style="font-size: 0.75rem; color: #64748b;">Locked - from Channel Manager</div>
                                </div>
                            </div>
                        </td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                    const refPrice = dayData.cm_price || '-';
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<td style="padding: 0.75rem; text-align: center; background: ${isWeekend ? '#fef9e7' : '#f1f5f9'}; color: #475569; font-weight: 600;">
                        ${refPrice !== '-' ? currencySymbol + parseFloat(refPrice).toFixed(0) : '-'}
                    </td>`;
                });
                html += `</tr>`;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // ROW 1b: Min Stay (CM) - Shows CM min stay, editable override
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                html += `
                    <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                        <td style="padding: 0.5rem 0.75rem; position: sticky; left: 0; background: #f8fafc; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1rem;">üìÖ</span>
                                <div>
                                    <strong style="font-size: 0.85rem;">Min Stay</strong>
                                    <div style="font-size: 0.7rem; color: #64748b;">CM default / Override</div>
                                </div>
                            </div>
                        </td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                    const cmMinStay = dayData.cm_min_stay || dayData.min_stay || 1;
                    const override = dayData.min_stay_override;
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<td style="padding: 0.25rem; text-align: center; background: ${isWeekend ? '#fef9e7' : '#f8fafc'}; font-size: 0.85rem;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                            <span style="color: #94a3b8; font-size: 0.7rem;">${cmMinStay}</span>
                            <input type="number" 
                                value="${override || ''}" 
                                data-room="${roomId}" 
                                data-date="${dateStr}"
                                data-field="min_stay"
                                class="min-stay-input"
                                style="width: 40px; padding: 0.2rem; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.8rem;"
                                onchange="markMinStayChanged(this)"
                                placeholder="-"
                                min="1"
                                max="30">
                        </div>
                    </td>`;
                });
                html += `</tr>`;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // ROW 2: Standard Price - YOUR BASE WEBSITE PRICE, EDITABLE
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                html += `
                    <tr style="background: #f0fdf4; border-bottom: 2px solid #86efac;">
                        <td style="padding: 0.75rem; position: sticky; left: 0; background: #f0fdf4; z-index: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">‚≠ê</span>
                                <div>
                                    <strong style="color: #166534;">Standard Price</strong>
                                    <div style="font-size: 0.75rem; color: #15803d;">Displayed on your website - editable</div>
                                </div>
                            </div>
                        </td>`;
                
                dates.forEach(d => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                    const stdPrice = dayData.standard_price || dayData.cm_price || '';
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    html += `<td style="padding: 0.25rem; text-align: center; background: ${isWeekend ? '#ecfdf5' : '#f0fdf4'};">
                        <input type="number" 
                            value="${stdPrice ? parseFloat(stdPrice).toFixed(0) : ''}" 
                            data-room="${roomId}" 
                            data-date="${dateStr}"
                            data-original="${stdPrice ? parseFloat(stdPrice).toFixed(0) : ''}"
                            class="standard-price-input"
                            style="width: 65px; padding: 0.4rem; text-align: center; border: 1px solid #86efac; border-radius: 4px; font-weight: 500;"
                            onchange="markPriceChanged(this)"
                            placeholder="-">
                    </td>`;
                });
                html += `</tr>`;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // OCCUPANCY PRICING SECTION - Based on room settings
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const occSettings = data.occupancy_settings || {};
                const pricingMode = occSettings.pricing_mode || 'per_room';
                const maxGuests = occSettings.max_guests || 4;
                const baseOccupancy = occSettings.base_occupancy || 2;
                
                html += `
                    <tr>
                        <td colspan="${dates.length + 1}" style="padding: 0.5rem 0.75rem; background: #ede9fe; border-top: 2px solid #c4b5fd;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1rem;">üë•</span>
                                    <strong style="color: #5b21b6;">OCCUPANCY PRICING</strong>
                                    <span style="font-size: 0.75rem; color: #7c3aed; background: white; padding: 0.15rem 0.5rem; border-radius: 10px;">
                                        ${pricingMode === 'per_occupancy' ? 'Active' : 'Per Room (flat)'}
                                    </span>
                                </div>
                                <button onclick="openOccupancySettings(${roomId})" class="btn btn-small" style="font-size: 0.75rem; padding: 0.25rem 0.75rem; background: #7c3aed; border-color: #7c3aed;">
                                    ‚öôÔ∏è Configure
                                </button>
                            </div>
                        </td>
                    </tr>`;
                
                // Only show occupancy rows if pricing_mode is 'per_occupancy'
                if (pricingMode === 'per_occupancy') {
                    // Generate rows for each occupancy level
                    for (let guests = 1; guests <= maxGuests; guests++) {
                        const isBase = guests === baseOccupancy;
                        const label = guests === 1 ? '1 Adult' : `${guests} Guests`;
                        const sublabel = isBase ? '(base rate)' : (guests < baseOccupancy ? 'discount applied' : 'extra charge');
                        
                        html += `
                            <tr style="background: #faf5ff; border-bottom: 1px solid #e9d5ff;">
                                <td style="padding: 0.5rem 0.75rem; position: sticky; left: 0; background: #faf5ff; z-index: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; padding-left: 1rem;">
                                        <span style="font-size: 0.9rem;">${'üë§'.repeat(Math.min(guests, 4))}</span>
                                        <div>
                                            <span style="font-weight: ${isBase ? '600' : '400'}; color: ${isBase ? '#5b21b6' : '#6b7280'};">${label}</span>
                                            <div style="font-size: 0.65rem; color: #9ca3af;">${sublabel}</div>
                                        </div>
                                    </div>
                                </td>`;
                        
                        dates.forEach(d => {
                            const dateStr = d.toISOString().split('T')[0];
                            const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                            const stdPrice = parseFloat(dayData.standard_price || dayData.cm_price) || 0;
                            
                            // Calculate occupancy-adjusted price
                            let adjPrice = stdPrice;
                            // Single discount only applies when base occupancy is more than 1
                            // (i.e., room is for 2+ people but only 1 is staying)
                            if (guests === 1 && baseOccupancy > 1 && parseFloat(occSettings.single_discount_value) > 0) {
                                // Single occupancy discount
                                if (occSettings.single_discount_type === 'percent') {
                                    adjPrice = stdPrice * (1 - parseFloat(occSettings.single_discount_value) / 100);
                                } else {
                                    adjPrice = stdPrice - parseFloat(occSettings.single_discount_value);
                                }
                            } else if (guests > baseOccupancy) {
                                // Extra guests charge
                                const extraGuests = guests - baseOccupancy;
                                if (occSettings.extra_adult_type === 'percent') {
                                    adjPrice = stdPrice * (1 + (parseFloat(occSettings.extra_adult_charge) / 100) * extraGuests);
                                } else {
                                    adjPrice = stdPrice + (parseFloat(occSettings.extra_adult_charge) * extraGuests);
                                }
                            }
                            
                            const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                            const priceColor = isBase ? '#5b21b6' : (adjPrice < stdPrice ? '#16a34a' : (adjPrice > stdPrice ? '#dc2626' : '#6b7280'));
                            
                            html += `<td style="padding: 0.5rem; text-align: center; background: ${isWeekend ? '#f5f3ff' : '#faf5ff'}; color: ${priceColor}; font-size: 0.85rem;">
                                ${stdPrice > 0 ? currencySymbol + Math.round(adjPrice) : '-'}
                            </td>`;
                        });
                        html += `</tr>`;
                    }
                } else {
                    // Just show a helper row when per_room mode
                    html += `
                        <tr style="background: #faf5ff;">
                            <td colspan="${dates.length + 1}" style="padding: 0.75rem; text-align: center; color: #7c3aed; font-size: 0.85rem;">
                                üí° Enable "Per Occupancy" pricing to set different rates for 1, 2, 3+ guests
                            </td>
                        </tr>`;
                }
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // OFFERS SECTION - Calculated from STANDARD PRICE
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                if (otherOffers.length > 0) {
                    html += `
                        <tr>
                            <td colspan="${dates.length + 1}" style="padding: 0.5rem 0.75rem; background: #fef3c7; font-weight: 600; color: #92400e;">
                                üè∑Ô∏è OFFERS (discounts/increases from Standard Price)
                            </td>
                        </tr>`;
                    
                    for (const offer of otherOffers) {
                        const isDiscount = offer.discount_value > 0;
                        const discountLabel = offer.discount_type === 'percentage' 
                            ? `${isDiscount ? '-' : '+'}${Math.abs(offer.discount_value)}%` 
                            : `${isDiscount ? '-' : '+'}$${Math.abs(offer.discount_value)}`;
                        
                        html += `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 0.75rem; position: sticky; left: 0; background: #fffbeb; z-index: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.2rem;">üè∑Ô∏è</span>
                                        <div>
                                            <strong>${offer.name}</strong>
                                            <div style="font-size: 0.75rem; color: ${isDiscount ? '#dc2626' : '#16a34a'};">${discountLabel} from Standard</div>
                                        </div>
                                    </div>
                                </td>`;
                        
                        dates.forEach(d => {
                            const dateStr = d.toISOString().split('T')[0];
                            const dayData = data.availability?.find(dd => dd.date === dateStr) || {};
                            // Calculate from STANDARD PRICE, not Reference
                            const stdPrice = parseFloat(dayData.standard_price || dayData.cm_price) || 0;
                            
                            let offerPrice = stdPrice;
                            if (offer.discount_type === 'percentage') {
                                offerPrice = stdPrice * (1 - offer.discount_value / 100);
                            } else {
                                offerPrice = stdPrice - offer.discount_value;
                            }
                            
                            const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                            html += `<td style="padding: 0.75rem; text-align: center; background: ${isWeekend ? '#fef9c3' : '#fffbeb'}; color: #b45309; font-weight: 500;">
                                ${stdPrice > 0 ? currencySymbol + offerPrice.toFixed(0) : '-'}
                            </td>`;
                        });
                        
                        html += `</tr>`;
                    }
                }
                
                // Add new offer row
                html += `
                    <tr>
                        <td colspan="${dates.length + 1}" style="padding: 1rem; text-align: center; background: #fafafa;">
                            <button class="btn btn-secondary" onclick="openAddOfferModal()" style="border-style: dashed;">
                                + Add Another Offer
                            </button>
                        </td>
                    </tr>`;
                
                html += `</tbody></table></div>`;
                
                // Save button
                html += `
                    <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 1rem; align-items: center;">
                        <span id="unsaved-indicator" style="color: #f59e0b; display: none;">‚ö†Ô∏è Unsaved changes</span>
                        <button class="btn btn-secondary" onclick="saveOfferRestrictions()" id="save-restrictions-btn" style="background: #fef3c7; border-color: #fbbf24; color: #92400e;">
                            üìè Save Offer Restrictions
                        </button>
                        <button class="btn" onclick="saveAllStandardPrices()" id="save-standard-prices-btn">
                            üíæ Save Standard Prices
                        </button>
                    </div>`;
                
                container.innerHTML = html;
                
                // Show distribution settings
                distributionCard.style.display = 'block';
                renderOfferDistribution([{ id: 'standard', name: 'Standard Price', active: true }, ...otherOffers]);
                
            } catch (error) {
                console.error('Error loading pricing grid:', error);
                container.innerHTML = '<p style="color: var(--error); text-align: center; padding: 2rem;">Error loading pricing data</p>';
            }
        }
        
        function markPriceChanged(input) {
            const original = input.dataset.original;
            const current = input.value;
            
            if (original !== current) {
                input.style.background = '#fef3c7';
                input.style.borderColor = '#f59e0b';
                document.getElementById('unsaved-indicator').style.display = 'inline';
                document.getElementById('save-standard-prices-btn').style.background = '#f59e0b';
            } else {
                input.style.background = '';
                input.style.borderColor = '#86efac';
            }
        }
        
        // =====================================================
        // MIN STAY HANDLING
        // =====================================================
        function markMinStayChanged(input) {
            input.style.background = '#fef3c7';
            input.style.borderColor = '#f59e0b';
        }
        
        async function saveMinStayChanges() {
            const inputs = document.querySelectorAll('.min-stay-input');
            let saved = 0;
            
            for (const input of inputs) {
                if (input.style.background === 'rgb(254, 243, 199)') { // Changed inputs
                    const roomId = input.dataset.room;
                    const date = input.dataset.date;
                    const value = input.value ? parseInt(input.value) : null;
                    
                    try {
                        await fetch(`/api/rooms/${roomId}/min-stay`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({
                                start_date: date,
                                end_date: date,
                                min_stay_override: value
                            })
                        });
                        input.style.background = '';
                        input.style.borderColor = '#cbd5e1';
                        saved++;
                    } catch (e) {
                        console.error('Error saving min stay:', e);
                    }
                }
            }
            
            if (saved > 0) {
                showNotification(`Saved ${saved} min stay change(s)`, 'success');
            }
        }
        
        // =====================================================
        // OCCUPANCY SETTINGS MODAL
        // =====================================================
        async function openOccupancySettings(roomId) {
            document.getElementById('occupancy-room-id').value = roomId;
            
            // Load room data
            try {
                const response = await fetch(`/api/rooms/${roomId}/occupancy-settings`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const settings = data.data;
                    const maxGuests = settings.max_guests || 4;
                    
                    document.getElementById('occupancy-room-name').textContent = settings.name || 'Room';
                    document.getElementById('occupancy-max-guests').textContent = maxGuests;
                    
                    // Populate base occupancy dropdown based on max_guests
                    const baseSelect = document.getElementById('occupancy-base');
                    baseSelect.innerHTML = '';
                    for (let i = 1; i <= maxGuests; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i === 1 ? '1 adult' : `${i} adults`;
                        baseSelect.appendChild(option);
                    }
                    
                    document.getElementById('occupancy-enabled').checked = settings.pricing_mode === 'per_occupancy';
                    document.getElementById('occupancy-base').value = settings.base_occupancy || Math.min(2, maxGuests);
                    
                    document.getElementById('single-discount-type').value = settings.single_discount_type || 'fixed';
                    document.getElementById('single-discount-value').value = settings.single_discount_value || 0;
                    
                    document.getElementById('extra-adult-type').value = settings.extra_adult_type || 'fixed';
                    document.getElementById('extra-adult-charge').value = settings.extra_adult_charge || 0;
                    
                    // Children allowed toggle
                    document.getElementById('children-allowed').checked = settings.children_allowed !== false;
                    toggleChildrenAllowed();
                    
                    document.getElementById('child-charge-type').value = settings.child_charge_type || 'free';
                    document.getElementById('child-charge').value = settings.child_charge || 0;
                    document.getElementById('child-max-age-display').textContent = settings.child_max_age || 12;
                    
                    // Enable/disable child charge input based on type
                    toggleChildChargeInput();
                    // Update fields visibility based on enabled state
                    toggleOccupancyFields();
                    // Update which fields are available based on base vs max
                    updateOccupancyFieldsAvailability();
                }
            } catch (error) {
                console.error('Error loading occupancy settings:', error);
            }
            
            openModal('occupancySettingsModal');
        }
        
        function toggleOccupancyFields() {
            const enabled = document.getElementById('occupancy-enabled').checked;
            const fieldsContainer = document.getElementById('occupancy-settings-fields');
            fieldsContainer.style.opacity = enabled ? '1' : '0.5';
            fieldsContainer.style.pointerEvents = enabled ? 'auto' : 'none';
        }
        
        function toggleChildChargeInput() {
            const type = document.getElementById('child-charge-type').value;
            const input = document.getElementById('child-charge');
            input.disabled = type === 'free';
            if (type === 'free') input.value = 0;
        }
        
        function toggleChildrenAllowed() {
            const allowed = document.getElementById('children-allowed').checked;
            const childChargeSection = document.getElementById('child-charge-section');
            if (childChargeSection) {
                childChargeSection.style.opacity = allowed ? '1' : '0.4';
                childChargeSection.style.pointerEvents = allowed ? 'auto' : 'none';
            }
        }
        
        // Update which occupancy fields are available based on base vs max
        function updateOccupancyFieldsAvailability() {
            const baseOccupancy = parseInt(document.getElementById('occupancy-base').value) || 1;
            const maxGuests = parseInt(document.getElementById('occupancy-max-guests').textContent) || 4;
            
            // Single Discount: only available if base > 1 (someone can book fewer than base)
            const singleSection = document.getElementById('single-discount-section');
            const singleFields = document.getElementById('single-discount-fields');
            const singleMsg = document.getElementById('single-discount-disabled-msg');
            
            if (baseOccupancy <= 1) {
                singleSection.style.opacity = '0.5';
                singleFields.style.pointerEvents = 'none';
                singleMsg.style.display = 'block';
                document.getElementById('single-discount-type').disabled = true;
                document.getElementById('single-discount-value').disabled = true;
            } else {
                singleSection.style.opacity = '1';
                singleFields.style.pointerEvents = 'auto';
                singleMsg.style.display = 'none';
                document.getElementById('single-discount-type').disabled = false;
                document.getElementById('single-discount-value').disabled = false;
            }
            
            // Extra Adult: only available if base < max (someone can book more than base)
            const extraSection = document.getElementById('extra-adult-section');
            const extraFields = document.getElementById('extra-adult-fields');
            const extraMsg = document.getElementById('extra-adult-disabled-msg');
            
            if (baseOccupancy >= maxGuests) {
                extraSection.style.opacity = '0.5';
                extraFields.style.pointerEvents = 'none';
                extraMsg.style.display = 'block';
                document.getElementById('extra-adult-type').disabled = true;
                document.getElementById('extra-adult-charge').disabled = true;
            } else {
                extraSection.style.opacity = '1';
                extraFields.style.pointerEvents = 'auto';
                extraMsg.style.display = 'none';
                document.getElementById('extra-adult-type').disabled = false;
                document.getElementById('extra-adult-charge').disabled = false;
            }
        }
        
        // Add event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const occupancyEnabled = document.getElementById('occupancy-enabled');
            if (occupancyEnabled) {
                occupancyEnabled.addEventListener('change', toggleOccupancyFields);
            }
            const childChargeType = document.getElementById('child-charge-type');
            if (childChargeType) {
                childChargeType.addEventListener('change', toggleChildChargeInput);
            }
            const childrenAllowed = document.getElementById('children-allowed');
            if (childrenAllowed) {
                childrenAllowed.addEventListener('change', toggleChildrenAllowed);
            }
            const occupancyBase = document.getElementById('occupancy-base');
            if (occupancyBase) {
                occupancyBase.addEventListener('change', updateOccupancyFieldsAvailability);
            }
        });
        
        async function saveOccupancySettings() {
            const roomId = document.getElementById('occupancy-room-id').value;
            const enabled = document.getElementById('occupancy-enabled').checked;
            
            const settings = {
                pricing_mode: enabled ? 'per_occupancy' : 'per_room',
                base_occupancy: parseInt(document.getElementById('occupancy-base').value) || 2,
                single_discount_type: document.getElementById('single-discount-type').value,
                single_discount_value: parseFloat(document.getElementById('single-discount-value').value) || 0,
                extra_adult_type: document.getElementById('extra-adult-type').value,
                extra_adult_charge: parseFloat(document.getElementById('extra-adult-charge').value) || 0,
                children_allowed: document.getElementById('children-allowed').checked,
                child_charge_type: document.getElementById('child-charge-type').value,
                child_charge: parseFloat(document.getElementById('child-charge').value) || 0
            };
            
            try {
                const response = await fetch(`/api/rooms/${roomId}/occupancy-settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Occupancy settings saved!', 'success');
                    closeModal('occupancySettingsModal');
                    // Reload the pricing grid to show changes
                    loadOffersPricingGrid();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        }
        
        async function saveAllStandardPrices() {
            const inputs = document.querySelectorAll('.standard-price-input');
            const btn = document.getElementById('save-standard-prices-btn');
            
            // Find changed inputs
            const changes = [];
            inputs.forEach(input => {
                if (input.value !== input.dataset.original) {
                    changes.push({
                        roomId: input.dataset.room,
                        date: input.dataset.date,
                        price: input.value
                    });
                }
            });
            
            if (changes.length === 0) {
                alert('No changes to save');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Saving...';
            
            let saved = 0;
            let errors = 0;
            
            for (const change of changes) {
                try {
                    const response = await fetch('/api/admin/availability', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({
                            room_id: change.roomId,
                            from_date: change.date,
                            to_date: change.date,
                            standard_price: parseFloat(change.price) || null
                        })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        saved++;
                    } else {
                        errors++;
                    }
                } catch (error) {
                    errors++;
                }
            }
            
            btn.disabled = false;
            btn.style.background = '';
            btn.textContent = 'üíæ Save Standard Prices';
            document.getElementById('unsaved-indicator').style.display = 'none';
            
            // Update original values and reset styles
            inputs.forEach(input => {
                input.dataset.original = input.value;
                input.style.background = '';
                input.style.borderColor = '#86efac';
            });
            
            if (errors > 0) {
                alert(`Saved ${saved} prices, ${errors} errors`);
            } else {
                alert(`‚úÖ Saved ${saved} price${saved !== 1 ? 's' : ''} successfully!`);
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MARKETING FEATURES FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let currentPropertyFeatures = [];
        let customFeatures = [];
        let propertyRooms = [];
        let featureRoomExclusions = {};
        
        async function loadMarketingProperties() {
            const select = document.getElementById('marketing-property-select');
            if (!select) return;
            
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                select.innerHTML = '<option value="">Select Property...</option>';
                if (data.success && data.data) {
                    data.data.forEach(prop => {
                        select.innerHTML += `<option value="${prop.id}">${prop.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadPropertyFeatures() {
            const propertyId = document.getElementById('marketing-property-select').value;
            const roomId = document.getElementById('marketing-room-select')?.value;
            const content = document.getElementById('marketing-content');
            const empty = document.getElementById('marketing-empty');
            const saveBtn = document.getElementById('marketing-save-btn');
            const applyAllContainer = document.getElementById('apply-all-rooms-container');
            const statusDiv = document.getElementById('marketing-room-status');
            
            if (!propertyId) {
                content.style.display = 'none';
                empty.style.display = 'block';
                saveBtn.style.display = 'none';
                if (applyAllContainer) applyAllContainer.style.display = 'none';
                if (statusDiv) statusDiv.style.display = 'none';
                return;
            }
            
            content.style.display = 'block';
            empty.style.display = 'none';
            saveBtn.style.display = 'block';
            
            // Show apply-all checkbox when a specific room is selected
            if (applyAllContainer) {
                applyAllContainer.style.display = roomId ? 'block' : 'none';
            }
            
            // Show status indicator
            if (statusDiv) {
                if (roomId) {
                    const roomName = document.getElementById('marketing-room-select').selectedOptions[0]?.text || 'this room';
                    statusDiv.innerHTML = `<span style="color: #2563eb;">üìç Editing features for: <strong>${roomName}</strong></span>`;
                    statusDiv.style.background = '#eff6ff';
                    statusDiv.style.display = 'block';
                } else {
                    statusDiv.innerHTML = `<span style="color: #059669;">üè† Editing property-wide features (applies to all rooms by default)</span>`;
                    statusDiv.style.background = '#ecfdf5';
                    statusDiv.style.display = 'block';
                }
            }
            
            // Reset all checkboxes
            document.querySelectorAll('.feature-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            customFeatures = [];
            featureRoomExclusions = {};
            renderCustomFeatures();
            
            // Load rooms for this property
            try {
                const roomsRes = await fetch('/api/db/bookable-units');
                const roomsData = await roomsRes.json();
                propertyRooms = roomsData.success ? (roomsData.data || []).filter(r => r.property_id == propertyId) : [];
            } catch (e) {
                propertyRooms = [];
            }
            
            // Load saved features (either room-specific or property-wide)
            try {
                const endpoint = roomId 
                    ? `/api/rooms/${roomId}/features`
                    : `/api/properties/${propertyId}/features`;
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (data.success && data.features) {
                    data.features.forEach(f => {
                        const cb = document.querySelector(`input[data-feature="${f.feature_name}"]`);
                        if (cb) {
                            cb.checked = true;
                        } else if (f.is_custom) {
                            customFeatures.push(f.feature_name);
                        }
                        if (f.excluded_room_ids && f.excluded_room_ids.length) {
                            featureRoomExclusions[f.feature_name] = f.excluded_room_ids;
                        }
                    });
                    renderCustomFeatures();
                }
            } catch (error) {
                console.log('No saved features yet or API not available');
            }
        }
        
        // Load rooms when property is selected
        async function loadMarketingRooms() {
            const propertyId = document.getElementById('marketing-property-select').value;
            const roomSelect = document.getElementById('marketing-room-select');
            
            // Reset room dropdown
            roomSelect.innerHTML = '<option value="">All Rooms (Property-wide)</option>';
            
            if (!propertyId) {
                loadPropertyFeatures();
                return;
            }
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(room => {
                        roomSelect.innerHTML += `<option value="${room.id}">${room.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
            
            // Load property-wide features
            loadPropertyFeatures();
        }
        
        // Load features for selected room
        function loadRoomFeatures() {
            loadPropertyFeatures();
        }
        
        // Save features (room or property level)
        async function saveMarketingFeatures() {
            const propertyId = document.getElementById('marketing-property-select').value;
            const roomId = document.getElementById('marketing-room-select')?.value;
            const applyToAll = document.getElementById('apply-to-all-rooms')?.checked;
            
            if (!propertyId) return;
            
            // Collect all selected features
            const features = [];
            
            // Standard features
            document.querySelectorAll('.feature-item input[type="checkbox"]:checked').forEach(cb => {
                features.push({
                    feature_name: cb.dataset.feature,
                    category: cb.closest('.feature-grid')?.dataset.category || 'custom',
                    is_custom: false,
                    excluded_room_ids: featureRoomExclusions[cb.dataset.feature] || []
                });
            });
            
            // Custom features
            customFeatures.forEach(f => {
                features.push({
                    feature_name: f,
                    category: 'custom',
                    is_custom: true,
                    excluded_room_ids: featureRoomExclusions[f] || []
                });
            });
            
            // Determine endpoint based on selection
            let endpoint, successMsg;
            
            if (roomId && !applyToAll) {
                // Save for specific room only
                endpoint = `/api/rooms/${roomId}/features`;
                successMsg = '‚úì Room features saved successfully!';
            } else if (roomId && applyToAll) {
                // Save to all rooms in property
                endpoint = `/api/properties/${propertyId}/features?apply_to_rooms=true`;
                successMsg = '‚úì Features saved to ALL rooms in this property!';
            } else {
                // Save property-wide defaults
                endpoint = `/api/properties/${propertyId}/features`;
                successMsg = '‚úì Property-wide features saved successfully!';
            }
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ features, property_id: propertyId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(successMsg);
                } else {
                    alert('Error saving features: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                // API might not exist yet - show success anyway for demo
                alert(successMsg + ' (Note: API endpoint may need to be created)');
                console.log('Features to save:', { endpoint, features, roomId, applyToAll });
            }
        }
        
        // Keep old function name for backward compatibility
        async function savePropertyFeatures() {
            return saveMarketingFeatures();
        }
        
        function renderCustomFeatures() {
            const container = document.getElementById('custom-features-list');
            if (customFeatures.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-style: italic; font-size: 0.9rem;">No custom features added yet</p>';
                return;
            }
            
            container.innerHTML = customFeatures.map(f => `
                <span class="custom-feature-tag">
                    üè∑Ô∏è ${f}
                    <button onclick="removeCustomFeature('${f}')" title="Remove">&times;</button>
                </span>
            `).join('');
        }
        
        function addCustomFeature() {
            const input = document.getElementById('new-custom-feature');
            const value = input.value.trim();
            
            if (!value) return;
            if (customFeatures.includes(value)) {
                alert('This feature already exists');
                return;
            }
            
            customFeatures.push(value);
            renderCustomFeatures();
            input.value = '';
        }
        
        function removeCustomFeature(feature) {
            customFeatures = customFeatures.filter(f => f !== feature);
            delete featureRoomExclusions[feature];
            renderCustomFeatures();
        }
        
        function showRoomExclusions(featureName) {
            const card = document.getElementById('room-exclusions-card');
            const content = document.getElementById('room-exclusions-content');
            
            if (propertyRooms.length === 0) {
                content.innerHTML = '<p style="color: var(--text-secondary);">No rooms found for this property</p>';
                card.style.display = 'block';
                return;
            }
            
            const excluded = featureRoomExclusions[featureName] || [];
            
            let html = `
                <p style="margin-bottom: 0.75rem;"><strong>Feature:</strong> ${featureName}</p>
                <p style="margin-bottom: 0.75rem; font-size: 0.9rem; color: var(--text-secondary);">Uncheck rooms where this feature does NOT apply:</p>
                <div class="feature-grid">
            `;
            
            propertyRooms.forEach(room => {
                const isExcluded = excluded.includes(room.id);
                html += `
                    <label class="feature-item">
                        <input type="checkbox" 
                            ${!isExcluded ? 'checked' : ''} 
                            onchange="toggleRoomExclusion('${featureName}', ${room.id}, this.checked)">
                        üõèÔ∏è ${room.name}
                    </label>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
            card.style.display = 'block';
        }
        
        function toggleRoomExclusion(featureName, roomId, isIncluded) {
            if (!featureRoomExclusions[featureName]) {
                featureRoomExclusions[featureName] = [];
            }
            
            if (isIncluded) {
                // Remove from exclusions
                featureRoomExclusions[featureName] = featureRoomExclusions[featureName].filter(id => id !== roomId);
            } else {
                // Add to exclusions
                if (!featureRoomExclusions[featureName].includes(roomId)) {
                    featureRoomExclusions[featureName].push(roomId);
                }
            }
        }
        
        async function aiSuggestFeatures() {
            const propertyId = document.getElementById('marketing-property-select').value;
            
            if (!propertyId) {
                alert('Please select a property first');
                return;
            }
            
            const prompt = document.getElementById('marketing-ai-prompt').value;
            if (!prompt.trim()) {
                alert('Please describe your property to get AI suggestions');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Analyzing...';
            btn.disabled = true;
            
            try {
                // Call the AI API with a special type for marketing features
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: 'marketing_features', 
                        property_id: propertyId, 
                        prompt: prompt 
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.content) {
                    // Parse the AI response to extract feature suggestions
                    displayAISuggestions(result.content);
                } else {
                    // Fallback to local analysis if API fails
                    const localSuggestions = analyzePromptForFeatures(prompt);
                    if (localSuggestions.length > 0) {
                        displayAISuggestions(localSuggestions.join('\n'));
                    } else {
                        alert('Could not generate suggestions. Try adding more detail to your description.');
                    }
                }
            } catch (error) {
                console.error('AI suggestion error:', error);
                // Fallback to local analysis
                const localSuggestions = analyzePromptForFeatures(prompt);
                if (localSuggestions.length > 0) {
                    displayAISuggestions(localSuggestions.join('\n'));
                } else {
                    alert('Error connecting to AI service. Please try again.');
                }
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function analyzePromptForFeatures(prompt) {
            const suggestions = [];
            const text = prompt.toLowerCase();
            
            // Activities
            if (text.includes('walk') || text.includes('hik') || text.includes('trail')) {
                suggestions.push('walking|ü•æ Walking / Hiking');
            }
            if (text.includes('cycl') || text.includes('bike') || text.includes('bicycle')) {
                suggestions.push('cycling|üö¥ Cycling');
            }
            if (text.includes('golf')) {
                suggestions.push('golf|‚õ≥ Golf');
            }
            if (text.includes('fish')) {
                suggestions.push('fishing|üé£ Fishing');
            }
            if (text.includes('surf') || text.includes('water sport') || text.includes('kayak') || text.includes('sail')) {
                suggestions.push('water-sports|üèÑ Water Sports');
            }
            if (text.includes('horse') || text.includes('riding') || text.includes('equestrian')) {
                suggestions.push('horse-riding|üê¥ Horse Riding');
            }
            if (text.includes('ski') || text.includes('snow') || text.includes('winter sport')) {
                suggestions.push('skiing|‚õ∑Ô∏è Skiing / Winter Sports');
            }
            if (text.includes('bird') || text.includes('wildlife') || text.includes('nature')) {
                suggestions.push('birdwatching|ü¶Ö Birdwatching / Wildlife');
            }
            if (text.includes('wine') || text.includes('vineyard')) {
                suggestions.push('wine-tasting|üç∑ Wine Tasting');
            }
            if (text.includes('cook') || text.includes('culinary') || text.includes('food')) {
                suggestions.push('cooking-classes|üë®‚Äçüç≥ Cooking Classes');
            }
            
            // Guest Types
            if (text.includes('pet') || text.includes('dog') || text.includes('cat')) {
                suggestions.push('pet-friendly|üêï Pet Friendly');
            }
            if (text.includes('family') || text.includes('children') || text.includes('kids')) {
                suggestions.push('family-friendly|üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Friendly');
            }
            if (text.includes('adult only') || text.includes('adults only') || text.includes('no children')) {
                suggestions.push('adults-only|üç∏ Adults Only');
            }
            if (text.includes('wheelchair') || text.includes('accessible') || text.includes('mobility')) {
                suggestions.push('wheelchair-accessible|‚ôø Wheelchair Accessible');
            }
            if (text.includes('business') || text.includes('corporate') || text.includes('conference')) {
                suggestions.push('business-travelers|üíº Business Travelers');
            }
            if (text.includes('remote work') || text.includes('digital nomad') || text.includes('work from')) {
                suggestions.push('digital-nomads|üíª Digital Nomads');
            }
            
            // Themes
            if (text.includes('romantic') || text.includes('couples') || text.includes('honeymoon') || text.includes('anniversary')) {
                suggestions.push('romantic|üíï Romantic / Couples');
            }
            if (text.includes('spa') || text.includes('wellness') || text.includes('yoga') || text.includes('meditation')) {
                suggestions.push('wellness-spa|üßò Wellness / Spa');
            }
            if (text.includes('adventure') || text.includes('outdoor') || text.includes('active')) {
                suggestions.push('adventure|üèîÔ∏è Adventure');
            }
            if (text.includes('eco') || text.includes('sustainable') || text.includes('green') || text.includes('organic')) {
                suggestions.push('eco-friendly|üåø Eco-Friendly / Sustainable');
            }
            if (text.includes('luxury') || text.includes('premium') || text.includes('upscale') || text.includes('5 star')) {
                suggestions.push('luxury|üëë Luxury');
            }
            if (text.includes('budget') || text.includes('affordable') || text.includes('cheap') || text.includes('value')) {
                suggestions.push('budget-friendly|üí∞ Budget Friendly');
            }
            if (text.includes('historic') || text.includes('heritage') || text.includes('victorian') || text.includes('period')) {
                suggestions.push('historic|üè∞ Historic / Heritage');
            }
            if (text.includes('boutique') || text.includes('unique') || text.includes('character')) {
                suggestions.push('boutique|üé® Boutique / Unique');
            }
            if (text.includes('farm') || text.includes('agri') || text.includes('rural retreat')) {
                suggestions.push('farm-stay|üåæ Farm Stay / Agritourism');
            }
            if (text.includes('glamping') || text.includes('tent') || text.includes('yurt') || text.includes('treehouse')) {
                suggestions.push('glamping|‚õ∫ Glamping');
            }
            
            // Location
            if (text.includes('beach') || text.includes('seafront') || text.includes('oceanfront')) {
                suggestions.push('beachfront|üèñÔ∏è Beachfront');
            }
            if (text.includes('mountain') || text.includes('hill') || text.includes('peak')) {
                suggestions.push('mountain-view|üèîÔ∏è Mountain View');
            }
            if (text.includes('countryside') || text.includes('rural') || text.includes('pastoral')) {
                suggestions.push('countryside|üåÑ Countryside');
            }
            if (text.includes('city') || text.includes('urban') || text.includes('downtown') || text.includes('town centre')) {
                suggestions.push('city-centre|üèôÔ∏è City Centre');
            }
            if (text.includes('lake') || text.includes('loch')) {
                suggestions.push('lakeside|üåä Lakeside');
            }
            if (text.includes('river')) {
                suggestions.push('riverside|üèûÔ∏è Riverside');
            }
            if (text.includes('forest') || text.includes('woodland') || text.includes('woods')) {
                suggestions.push('forest|üå≤ Forest / Woodland');
            }
            if (text.includes('village') || text.includes('hamlet')) {
                suggestions.push('village|üèòÔ∏è Village / Rural');
            }
            if (text.includes('coast') || text.includes('seaside') || text.includes('sea view')) {
                suggestions.push('coastal|‚öì Coastal');
            }
            if (text.includes('island')) {
                suggestions.push('island|üèùÔ∏è Island');
            }
            
            // Amenities
            if (text.includes('ev') || text.includes('electric car') || text.includes('charging')) {
                suggestions.push('ev-charging|‚ö° EV Charging');
            }
            if (text.includes('pool') || text.includes('swimming')) {
                suggestions.push('swimming-pool|üèä Swimming Pool');
            }
            if (text.includes('hot tub') || text.includes('jacuzzi') || text.includes('spa bath')) {
                suggestions.push('hot-tub|üõÅ Hot Tub / Jacuzzi');
            }
            if (text.includes('sauna')) {
                suggestions.push('sauna|üßñ Sauna');
            }
            if (text.includes('gym') || text.includes('fitness')) {
                suggestions.push('gym|üèãÔ∏è Gym / Fitness');
            }
            if (text.includes('garden')) {
                suggestions.push('garden|üå≥ Garden');
            }
            if (text.includes('bbq') || text.includes('barbecue') || text.includes('grill')) {
                suggestions.push('bbq|üçñ BBQ Area');
            }
            if (text.includes('fireplace') || text.includes('log fire') || text.includes('wood burner')) {
                suggestions.push('fireplace|üî• Fireplace');
            }
            if (text.includes('parking')) {
                suggestions.push('private-parking|üÖøÔ∏è Private Parking');
            }
            if (text.includes('restaurant') || text.includes('dining') || text.includes('breakfast')) {
                suggestions.push('restaurant|üçΩÔ∏è On-site Restaurant');
            }
            
            return suggestions;
        }
        
        function displayAISuggestions(content) {
            const container = document.getElementById('ai-suggestions-list');
            const resultsDiv = document.getElementById('ai-suggestions-results');
            
            let suggestions = [];
            
            // If content is already in our format (feature|label)
            if (content.includes('|')) {
                suggestions = content.split('\n').filter(s => s.includes('|'));
            } else {
                // Parse AI text response to extract features
                suggestions = analyzePromptForFeatures(content);
            }
            
            if (suggestions.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No specific features detected. Try adding more detail to your description.</p>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            let html = '';
            suggestions.forEach(s => {
                const [featureKey, label] = s.split('|');
                html += `
                    <button type="button" class="ai-suggestion-btn" onclick="applySuggestion('${featureKey}')" 
                        style="padding: 0.5rem 1rem; background: #f0fdf4; border: 1px solid #86efac; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">
                        ${label} <span style="color: #16a34a;">+ Add</span>
                    </button>
                `;
            });
            
            container.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function applySuggestion(featureKey) {
            const checkbox = document.querySelector(`input[data-feature="${featureKey}"]`);
            if (checkbox) {
                checkbox.checked = true;
                // Visual feedback
                const btn = event.target.closest('.ai-suggestion-btn');
                if (btn) {
                    btn.style.background = '#dcfce7';
                    btn.style.borderColor = '#22c55e';
                    btn.innerHTML = btn.innerHTML.replace('+ Add', '‚úì Added');
                    btn.disabled = true;
                }
            } else {
                // It's a custom feature, add it
                if (!customFeatures.includes(featureKey)) {
                    customFeatures.push(featureKey);
                    renderCustomFeatures();
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BULK EDIT FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function openBulkEditModal() {
            // Set default dates
            const today = new Date();
            const threeMonths = new Date();
            threeMonths.setMonth(threeMonths.getMonth() + 3);
            
            document.getElementById('bulk-date-from').value = today.toISOString().split('T')[0];
            document.getElementById('bulk-date-to').value = threeMonths.toISOString().split('T')[0];
            
            // Reset to price type
            document.querySelector('input[name="bulk-edit-type"][value="price"]').checked = true;
            toggleBulkEditType();
            
            // Load rooms and offers
            loadBulkRooms();
            loadBulkOffers();
            
            document.getElementById('bulkEditModal').classList.add('active');
        }
        
        function toggleBulkEditType() {
            const editType = document.querySelector('input[name="bulk-edit-type"]:checked').value;
            
            // Hide all value inputs
            document.getElementById('bulk-price-input').style.display = 'none';
            document.getElementById('bulk-minstay-input').style.display = 'none';
            document.getElementById('bulk-closed-input').style.display = 'none';
            document.getElementById('bulk-offers-section').style.display = 'none';
            
            // Show relevant input
            if (editType === 'price') {
                document.getElementById('bulk-price-input').style.display = 'block';
            } else if (editType === 'minstay') {
                document.getElementById('bulk-minstay-input').style.display = 'block';
                document.getElementById('bulk-offers-section').style.display = 'block';
            } else if (editType === 'closed') {
                document.getElementById('bulk-closed-input').style.display = 'block';
                document.getElementById('bulk-offers-section').style.display = 'block';
            }
            
            // Update price symbol based on action
            const priceAction = document.getElementById('bulk-price-action');
            if (priceAction) {
                priceAction.onchange = function() {
                    const symbol = this.value.includes('pct') ? '%' : '$';
                    document.getElementById('bulk-price-symbol').textContent = symbol;
                };
            }
        }
        
        async function loadBulkRooms() {
            const container = document.getElementById('bulk-rooms-list');
            container.innerHTML = '<p style="padding: 0.75rem; color: #6b7280;">Loading rooms...</p>';
            
            try {
                // Get all properties (filtered by account)
                const queryString = buildQueryString();
                const propsRes = await fetch(`/api/db/properties${queryString}`);
                const propsData = await propsRes.json();
                
                if (!propsData.success || !propsData.data?.length) {
                    container.innerHTML = '<p style="padding: 0.75rem; color: #6b7280;">No properties found</p>';
                    return;
                }
                
                let html = '';
                for (const prop of propsData.data) {
                    // Get rooms for this property
                    const roomsRes = await fetch(`/api/db/bookable-units?property_id=${prop.id}`);
                    const roomsData = await roomsRes.json();
                    
                    if (roomsData.success && roomsData.data?.length) {
                        html += `<div style="padding: 0.5rem 0.75rem; background: #f8fafc; font-weight: 600; font-size: 0.85rem; border-bottom: 1px solid #e5e7eb;">${prop.name}</div>`;
                        
                        for (const room of roomsData.data) {
                            html += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid #f1f5f9;">
                                    <input type="checkbox" class="bulk-room-cb" data-room-id="${room.id}" data-property-id="${prop.id}" checked>
                                    <span style="font-size: 0.9rem;">${room.name}</span>
                                </label>
                            `;
                        }
                    }
                }
                
                container.innerHTML = html || '<p style="padding: 0.75rem; color: #6b7280;">No rooms found</p>';
            } catch (error) {
                console.error('Error loading rooms:', error);
                container.innerHTML = '<p style="padding: 0.75rem; color: #ef4444;">Error loading rooms</p>';
            }
        }
        
        async function loadBulkOffers() {
            const container = document.getElementById('bulk-offers-list');
            container.innerHTML = '<p style="padding: 0.75rem; color: #6b7280;">Loading offers...</p>';
            
            try {
                // Always include Standard Price
                let html = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid #f1f5f9; background: #ecfdf5;">
                        <input type="checkbox" class="bulk-offer-cb" data-offer-id="standard" checked>
                        <span style="font-size: 0.9rem; font-weight: 600;">‚≠ê Standard Price</span>
                    </label>
                `;
                
                // Get other offers
                const response = await fetch('/api/admin/offers');
                const data = await response.json();
                
                if (data.success && data.data?.length) {
                    for (const offer of data.data) {
                        if (offer.name !== 'Standard Price') {
                            html += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; border-bottom: 1px solid #f1f5f9;">
                                    <input type="checkbox" class="bulk-offer-cb" data-offer-id="${offer.id}" checked>
                                    <span style="font-size: 0.9rem;">üè∑Ô∏è ${offer.name}</span>
                                </label>
                            `;
                        }
                    }
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading offers:', error);
                // Still show Standard Price even if API fails
                container.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; cursor: pointer; background: #ecfdf5;">
                        <input type="checkbox" class="bulk-offer-cb" data-offer-id="standard" checked>
                        <span style="font-size: 0.9rem; font-weight: 600;">‚≠ê Standard Price</span>
                    </label>
                `;
            }
        }
        
        async function applyBulkEdit() {
            const editType = document.querySelector('input[name="bulk-edit-type"]:checked').value;
            const fromDate = new Date(document.getElementById('bulk-date-from').value);
            const toDate = new Date(document.getElementById('bulk-date-to').value);
            
            // Get selected days
            const selectedDays = [];
            document.querySelectorAll('.bulk-day-cb:checked').forEach(cb => {
                selectedDays.push(parseInt(cb.dataset.day));
            });
            
            // Get selected rooms
            const selectedRooms = [];
            document.querySelectorAll('.bulk-room-cb:checked').forEach(cb => {
                selectedRooms.push({
                    roomId: cb.dataset.roomId,
                    propertyId: cb.dataset.propertyId
                });
            });
            
            if (selectedRooms.length === 0) {
                alert('Please select at least one room');
                return;
            }
            
            if (selectedDays.length === 0) {
                alert('Please select at least one day of the week');
                return;
            }
            
            // Generate dates to update
            const datesToUpdate = [];
            const current = new Date(fromDate);
            while (current <= toDate) {
                if (selectedDays.includes(current.getDay())) {
                    datesToUpdate.push(current.toISOString().split('T')[0]);
                }
                current.setDate(current.getDate() + 1);
            }
            
            if (datesToUpdate.length === 0) {
                alert('No dates match your criteria');
                return;
            }
            
            // Get value based on type
            let actionDesc = '';
            if (editType === 'price') {
                const action = document.getElementById('bulk-price-action').value;
                const value = parseFloat(document.getElementById('bulk-price-value').value) || 0;
                actionDesc = `Price: ${action} ${value}`;
            } else if (editType === 'minstay') {
                const value = parseInt(document.getElementById('bulk-minstay-value').value) || 1;
                actionDesc = `Min Stay: ${value} nights`;
            } else if (editType === 'closed') {
                const closeCheckin = document.getElementById('bulk-close-checkin').checked;
                const closeCheckout = document.getElementById('bulk-close-checkout').checked;
                actionDesc = `Close: ${closeCheckin ? 'Check-in' : ''} ${closeCheckout ? 'Check-out' : ''}`;
            }
            
            // Confirm
            const confirmMsg = `This will apply:\n${actionDesc}\n\nTo:\n‚Ä¢ ${selectedRooms.length} room(s)\n‚Ä¢ ${datesToUpdate.length} date(s)\n\nContinue?`;
            if (!confirm(confirmMsg)) return;
            
            // Show progress
            const btn = document.getElementById('bulk-apply-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Applying...';
            btn.disabled = true;
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const room of selectedRooms) {
                    for (const date of datesToUpdate) {
                        try {
                            let payload = { date };
                            
                            if (editType === 'price') {
                                const action = document.getElementById('bulk-price-action').value;
                                const value = parseFloat(document.getElementById('bulk-price-value').value) || 0;
                                
                                // For set, just set the price
                                // For increase/decrease, we'd need to get current price first
                                if (action === 'set') {
                                    payload.standard_price = value;
                                } else {
                                    // Get current price first
                                    const currentRes = await fetch(`/api/availability/${room.roomId}?from=${date}&to=${date}`);
                                    const currentData = await currentRes.json();
                                    const currentPrice = parseFloat(currentData.availability?.[0]?.standard_price || currentData.availability?.[0]?.cm_price || 0);
                                    
                                    if (action === 'increase') {
                                        payload.standard_price = currentPrice + value;
                                    } else if (action === 'decrease') {
                                        payload.standard_price = Math.max(0, currentPrice - value);
                                    } else if (action === 'increase_pct') {
                                        payload.standard_price = currentPrice * (1 + value / 100);
                                    } else if (action === 'decrease_pct') {
                                        payload.standard_price = currentPrice * (1 - value / 100);
                                    }
                                }
                            } else if (editType === 'minstay') {
                                payload.min_stay = parseInt(document.getElementById('bulk-minstay-value').value) || 1;
                            }
                            
                            const response = await fetch(`/api/rooms/${room.roomId}/daily-rates`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                                body: JSON.stringify(payload)
                            });
                            
                            if (response.ok) {
                                successCount++;
                            } else {
                                errorCount++;
                            }
                        } catch (e) {
                            errorCount++;
                        }
                    }
                }
                
                alert(`Bulk update complete!\n‚úì ${successCount} successful\n‚úó ${errorCount} failed`);
                
                // Refresh the grid
                if (typeof loadOffersPricingGrid === 'function') {
                    loadOffersPricingGrid();
                }
                
                closeModal('bulkEditModal');
            } catch (error) {
                alert('Error applying bulk update: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Track offer changes for saving
        const offerChanges = {};
        
        // Track standard price restriction changes
        let standardRestrictions = {
            min_nights: 1,
            allowed_checkin_days: '0,1,2,3,4,5,6',
            allowed_checkout_days: '0,1,2,3,4,5,6',
            changed: false
        };
        
        function markStandardRestrictionChanged(input) {
            input.style.background = '#fef3c7';
            input.style.borderColor = '#f59e0b';
            standardRestrictions.min_nights = parseInt(input.value) || 1;
            standardRestrictions.changed = true;
            document.getElementById('unsaved-indicator').style.display = 'inline';
        }
        
        function toggleStandardClosedDay(btn) {
            // Cycle through states: Open -> No CI -> No CO -> Closed -> Open
            let ci = parseInt(btn.dataset.ci);
            let co = parseInt(btn.dataset.co);
            
            if (ci && co) {
                ci = 0; co = 1;
            } else if (!ci && co) {
                ci = 1; co = 0;
            } else if (ci && !co) {
                ci = 0; co = 0;
            } else {
                ci = 1; co = 1;
            }
            
            btn.dataset.ci = ci;
            btn.dataset.co = co;
            
            let display = '';
            if (!ci && !co) {
                display = '‚úó';
            } else if (!ci) {
                display = 'CI';
            } else if (!co) {
                display = 'CO';
            }
            
            btn.innerHTML = display || '‚Äî';
            btn.style.background = display ? '#fee2e2' : 'white';
            btn.style.borderColor = display ? '#fca5a5' : '#d1d5db';
            btn.style.color = display ? '#dc2626' : '#9ca3af';
            
            standardRestrictions.changed = true;
            document.getElementById('unsaved-indicator').style.display = 'inline';
            
            // Recalculate allowed days from all buttons
            updateStandardClosedDays();
        }
        
        function updateStandardClosedDays() {
            const buttons = document.querySelectorAll('.closed-toggle-btn[data-offer="standard"]');
            const checkinDays = new Set();
            const checkoutDays = new Set();
            
            buttons.forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (parseInt(btn.dataset.ci)) checkinDays.add(day);
                if (parseInt(btn.dataset.co)) checkoutDays.add(day);
            });
            
            standardRestrictions.allowed_checkin_days = Array.from(checkinDays).sort().join(',') || '0,1,2,3,4,5,6';
            standardRestrictions.allowed_checkout_days = Array.from(checkoutDays).sort().join(',') || '0,1,2,3,4,5,6';
        }
        
        function markOfferChanged(input, offerId) {
            input.style.background = '#fef3c7';
            input.style.borderColor = '#f59e0b';
            
            if (!offerChanges[offerId]) {
                offerChanges[offerId] = { min_nights: input.value };
            } else {
                offerChanges[offerId].min_nights = input.value;
            }
            
            document.getElementById('unsaved-indicator').style.display = 'inline';
        }
        
        function toggleClosedDay(btn, offerId) {
            // Cycle through states: Open -> No CI -> No CO -> Closed -> Open
            let ci = parseInt(btn.dataset.ci);
            let co = parseInt(btn.dataset.co);
            
            if (ci && co) {
                // Currently open -> close for check-in
                ci = 0;
                co = 1;
            } else if (!ci && co) {
                // No CI -> close for check-out
                ci = 1;
                co = 0;
            } else if (ci && !co) {
                // No CO -> close for both
                ci = 0;
                co = 0;
            } else {
                // Closed -> open
                ci = 1;
                co = 1;
            }
            
            btn.dataset.ci = ci;
            btn.dataset.co = co;
            
            // Update display
            let display = '';
            let title = 'Open for check-in and check-out';
            if (!ci && !co) {
                display = '‚úó';
                title = 'Closed for both check-in and check-out';
            } else if (!ci) {
                display = 'CI';
                title = 'Closed for check-in';
            } else if (!co) {
                display = 'CO';
                title = 'Closed for check-out';
            }
            
            btn.innerHTML = display || '‚Äî';
            btn.style.background = display ? '#fee2e2' : 'white';
            btn.style.borderColor = display ? '#fca5a5' : '#d1d5db';
            btn.style.color = display ? '#dc2626' : '#9ca3af';
            btn.title = title;
            
            // Mark as changed
            document.getElementById('unsaved-indicator').style.display = 'inline';
            
            // Collect all buttons for this offer to recalculate allowed days
            updateOfferClosedDays(offerId);
        }
        
        function updateOfferClosedDays(offerId) {
            const buttons = document.querySelectorAll(`.closed-toggle-btn[data-offer="${offerId}"]`);
            const checkinDays = new Set();
            const checkoutDays = new Set();
            
            buttons.forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (parseInt(btn.dataset.ci)) checkinDays.add(day);
                if (parseInt(btn.dataset.co)) checkoutDays.add(day);
            });
            
            if (!offerChanges[offerId]) offerChanges[offerId] = {};
            offerChanges[offerId].allowed_checkin_days = Array.from(checkinDays).sort().join(',') || '0,1,2,3,4,5,6';
            offerChanges[offerId].allowed_checkout_days = Array.from(checkoutDays).sort().join(',') || '0,1,2,3,4,5,6';
        }
        
        async function saveOfferRestrictions() {
            const offerIds = Object.keys(offerChanges);
            const hasStandardChanges = standardRestrictions.changed;
            
            if (offerIds.length === 0 && !hasStandardChanges) {
                alert('No restriction changes to save');
                return;
            }
            
            let saved = 0;
            let errors = 0;
            
            // Save standard price restrictions (stored in availability or a separate endpoint)
            if (hasStandardChanges) {
                try {
                    // For now, we'll create/update a "Standard Price" offer to store these restrictions
                    // Or you can store in room settings - this is a placeholder
                    const roomId = document.getElementById('offers-room-select').value;
                    
                    // Check if Standard Price offer exists for this room
                    const checkResp = await fetch('/api/admin/offers');
                    const checkData = await checkResp.json();
                    const existingStdOffer = (checkData.data || []).find(o => o.name === 'Standard Price' && o.room_id == roomId);
                    
                    if (existingStdOffer) {
                        // Update existing
                        const response = await fetch(`/api/admin/offers/${existingStdOffer.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({
                                ...existingStdOffer,
                                min_nights: standardRestrictions.min_nights,
                                allowed_checkin_days: standardRestrictions.allowed_checkin_days,
                                allowed_checkout_days: standardRestrictions.allowed_checkout_days
                            })
                        });
                        const result = await response.json();
                        if (result.success) saved++;
                        else errors++;
                    } else {
                        // Create new Standard Price offer for this room
                        const response = await fetch('/api/admin/offers', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify({
                                name: 'Standard Price',
                                description: 'Standard website price with restrictions',
                                room_id: roomId,
                                discount_type: 'percentage',
                                discount_value: 0,
                                min_nights: standardRestrictions.min_nights,
                                allowed_checkin_days: standardRestrictions.allowed_checkin_days,
                                allowed_checkout_days: standardRestrictions.allowed_checkout_days,
                                active: true,
                                available_website: true
                            })
                        });
                        const result = await response.json();
                        if (result.success) saved++;
                        else errors++;
                    }
                    
                    standardRestrictions.changed = false;
                } catch (error) {
                    console.error('Error saving standard restrictions:', error);
                    errors++;
                }
            }
            
            // Save other offer restrictions
            for (const offerId of offerIds) {
                try {
                    // Get current offer data first
                    const getResp = await fetch(`/api/admin/offers/${offerId}`);
                    const getData = await getResp.json();
                    
                    if (getData.success) {
                        const offer = getData.data;
                        const changes = offerChanges[offerId];
                        
                        // Merge changes
                        const updateData = {
                            ...offer,
                            min_nights: changes.min_nights || offer.min_nights,
                            allowed_checkin_days: changes.allowed_checkin_days || offer.allowed_checkin_days,
                            allowed_checkout_days: changes.allowed_checkout_days || offer.allowed_checkout_days
                        };
                        
                        const response = await fetch(`/api/admin/offers/${offerId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            body: JSON.stringify(updateData)
                        });
                        const result = await response.json();
                        
                        if (result.success) saved++;
                        else errors++;
                    }
                } catch (error) {
                    console.error('Error saving offer:', error);
                    errors++;
                }
            }
            
            // Clear changes
            Object.keys(offerChanges).forEach(k => delete offerChanges[k]);
            document.getElementById('unsaved-indicator').style.display = 'none';
            
            if (errors > 0) {
                alert(`Saved ${saved} offers, ${errors} errors`);
            } else {
                alert(`‚úÖ Saved ${saved} offer restriction${saved !== 1 ? 's' : ''} successfully!`);
            }
            
            // Reload the grid
            loadOffersPricingGrid();
        }
        
        function renderOfferDistribution(offers) {
            const container = document.getElementById('offer-distribution-list');
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.5rem;">Offer</th>
                            <th style="text-align: left; padding: 0.5rem;">Applies To</th>
                            <th style="text-align: center; padding: 0.5rem;">Own Website</th>
                            <th style="text-align: center; padding: 0.5rem;">Travel Agents</th>
                            <th style="text-align: center; padding: 0.5rem;">Status</th>
                            <th style="text-align: right; padding: 0.5rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const offer of offers) {
                const isStandard = offer.id === 'standard' || offer.name === 'Standard Price';
                
                // Build "Applies To" text - handle arrays
                let appliesTo = 'All Properties';
                if (offer.room_ids && offer.room_ids.length > 0) {
                    appliesTo = offer.room_ids.length + ' Room' + (offer.room_ids.length > 1 ? 's' : '');
                } else if (offer.property_ids && offer.property_ids.length > 0) {
                    appliesTo = offer.property_ids.length + ' Propert' + (offer.property_ids.length > 1 ? 'ies' : 'y');
                } else if (offer.room_name) {
                    appliesTo = offer.room_name;
                } else if (offer.property_name) {
                    appliesTo = offer.property_name;
                } else if (offer.room_id) {
                    appliesTo = 'Room #' + offer.room_id;
                } else if (offer.property_id) {
                    appliesTo = 'Property #' + offer.property_id;
                }
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${isStandard ? '‚≠ê ' : 'üè∑Ô∏è '}${offer.name}</strong>
                        </td>
                        <td style="padding: 0.75rem; font-size: 0.85rem; color: #6b7280;">
                            ${appliesTo}
                        </td>
                        <td style="text-align: center; padding: 0.75rem;">
                            <input type="checkbox" ${isStandard || offer.available_website !== false ? 'checked' : ''} 
                                onchange="updateOfferDistribution(${offer.id}, 'website', this.checked)"
                                ${isStandard ? 'disabled' : ''}>
                        </td>
                        <td style="text-align: center; padding: 0.75rem;">
                            <input type="checkbox" ${offer.available_agents ? 'checked' : ''} 
                                onchange="updateOfferDistribution(${offer.id}, 'agents', this.checked)"
                                ${isStandard ? 'disabled' : ''}>
                        </td>
                        <td style="text-align: center; padding: 0.75rem;">
                            <span class="badge ${offer.active !== false ? 'badge-success' : 'badge-secondary'}">
                                ${offer.active !== false ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="text-align: right; padding: 0.75rem;">
                            ${!isStandard ? `
                                <button onclick="editOffer(${offer.id})" style="background: none; border: none; cursor: pointer;">‚úèÔ∏è</button>
                                <button onclick="deleteOffer(${offer.id})" style="background: none; border: none; cursor: pointer;">üóëÔ∏è</button>
                            ` : '<span style="color: #9ca3af; font-size: 0.8rem;">Default</span>'}
                        </td>
                    </tr>
                `;
            }
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        
        async function updateOfferDistribution(offerId, channel, enabled) {
            if (offerId === 'standard') return;
            
            try {
                const field = channel === 'website' ? 'available_website' : 'available_agents';
                await fetch(`/api/admin/offers/${offerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ [field]: enabled })
                });
            } catch (error) {
                console.error('Error updating offer distribution:', error);
            }
        }
        
        function shiftOffersDays(days) {
            offersStartDate.setDate(offersStartDate.getDate() + days);
            loadOffersPricingGrid();
        }
        
        function offersGoToToday() {
            offersStartDate = new Date();
            offersStartDate.setHours(0, 0, 0, 0);
            loadOffersPricingGrid();
        }
        
        function openAddOfferModal() {
            document.getElementById('offer-form').reset();
            document.getElementById('offer-id').value = '';
            document.getElementById('offer-modal-title').innerHTML = 'üè∑Ô∏è Create New Offer';
            document.getElementById('offer-active').checked = true;
            updateOfferToggleVisual(document.getElementById('offer-active'));
            
            // Reset all check-in/check-out day checkboxes to checked
            ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach(day => {
                const checkinCb = document.getElementById('checkin-' + day);
                const checkoutCb = document.getElementById('checkout-' + day);
                if (checkinCb) checkinCb.checked = true;
                if (checkoutCb) checkoutCb.checked = true;
            });
            
            updateDiscountDisplay();
            loadPropertiesForOfferDropdown();
            openModal('addOfferModal');
        }
        
        function updateDiscountDisplay() {
            const type = document.getElementById('offer-discount-type').value;
            const suffix = document.getElementById('discount-suffix');
            if (type === 'percentage') {
                suffix.textContent = '%';
            } else {
                suffix.textContent = '$';
            }
        }
        
        // Add event listener for discount type change
        document.addEventListener('DOMContentLoaded', function() {
            const discountType = document.getElementById('offer-discount-type');
            if (discountType) {
                discountType.addEventListener('change', updateDiscountDisplay);
            }
        });
        
        async function loadPropertiesForOfferDropdown() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const propList = document.getElementById('offer-properties-list');
                propList.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px; background: #f0fdf4;" class="offer-prop-option">
                        <input type="checkbox" name="offer-properties" value="" checked onchange="handleAllPropertiesChange(this)">
                        <span style="font-size: 0.9rem; font-weight: 500;">‚úì All Properties</span>
                    </label>
                `;
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        propList.innerHTML += `
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px;" class="offer-prop-option" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" name="offer-properties" value="${p.id}" onchange="handlePropertyCheckChange(this)">
                                <span style="font-size: 0.9rem;">${p.name}</span>
                            </label>
                        `;
                    });
                }
                
                // Load all rooms initially
                await loadRoomsForOfferCheckboxes('');
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        function handleAllPropertiesChange(checkbox) {
            const allCheckboxes = document.querySelectorAll('input[name="offer-properties"]');
            if (checkbox.checked) {
                // Uncheck all individual properties
                allCheckboxes.forEach(cb => {
                    if (cb.value !== '') cb.checked = false;
                });
            }
            filterRoomsBySelectedProperties();
        }
        
        function handlePropertyCheckChange(checkbox) {
            const allCheckbox = document.querySelector('input[name="offer-properties"][value=""]');
            if (checkbox.checked) {
                // Uncheck "All Properties"
                allCheckbox.checked = false;
            } else {
                // If no properties selected, check "All"
                const anySelected = document.querySelectorAll('input[name="offer-properties"]:checked');
                if (anySelected.length === 0) {
                    allCheckbox.checked = true;
                }
            }
            filterRoomsBySelectedProperties();
        }
        
        function filterRoomsBySelectedProperties() {
            const selectedProps = [];
            document.querySelectorAll('input[name="offer-properties"]:checked').forEach(cb => {
                if (cb.value !== '') selectedProps.push(cb.value);
            });
            loadRoomsForOfferCheckboxes(selectedProps);
        }
        
        async function loadRoomsForOfferCheckboxes(propertyIds) {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/bookable-units${queryString}`);
                const data = await response.json();
                
                const roomList = document.getElementById('offer-rooms-list');
                roomList.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px; background: #f0fdf4;" class="offer-room-option">
                        <input type="checkbox" name="offer-rooms" value="" checked onchange="handleAllRoomsChange(this)">
                        <span style="font-size: 0.9rem; font-weight: 500;">‚úì All Rooms</span>
                    </label>
                `;
                
                if (data.success && data.data) {
                    let rooms = data.data;
                    // Filter by selected properties if any
                    if (Array.isArray(propertyIds) && propertyIds.length > 0) {
                        rooms = rooms.filter(r => propertyIds.includes(String(r.property_id)));
                    }
                    
                    rooms.forEach(r => {
                        roomList.innerHTML += `
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.35rem; cursor: pointer; border-radius: 4px;" class="offer-room-option" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" name="offer-rooms" value="${r.id}" onchange="handleRoomCheckChange(this)">
                                <span style="font-size: 0.9rem;">${r.name}</span>
                            </label>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        function handleAllRoomsChange(checkbox) {
            const allCheckboxes = document.querySelectorAll('input[name="offer-rooms"]');
            if (checkbox.checked) {
                allCheckboxes.forEach(cb => {
                    if (cb.value !== '') cb.checked = false;
                });
            }
        }
        
        function handleRoomCheckChange(checkbox) {
            const allCheckbox = document.querySelector('input[name="offer-rooms"][value=""]');
            if (checkbox.checked) {
                allCheckbox.checked = false;
            } else {
                const anySelected = document.querySelectorAll('input[name="offer-rooms"]:checked');
                if (anySelected.length === 0) {
                    allCheckbox.checked = true;
                }
            }
        }
        
        function updateOfferToggleVisual(checkbox) {
            const slider = document.getElementById('offer-active-slider');
            const dot = document.getElementById('offer-active-dot');
            if (checkbox.checked) {
                slider.style.backgroundColor = '#22c55e';
                dot.style.left = '25px';
            } else {
                slider.style.backgroundColor = '#ccc';
                dot.style.left = '3px';
            }
        }
        
        function getSelectedOfferProperties() {
            const selected = [];
            document.querySelectorAll('input[name="offer-properties"]:checked').forEach(cb => {
                if (cb.value !== '') selected.push(parseInt(cb.value));
            });
            return selected.length > 0 ? selected : null;
        }
        
        function getSelectedOfferRooms() {
            const selected = [];
            document.querySelectorAll('input[name="offer-rooms"]:checked').forEach(cb => {
                if (cb.value !== '') selected.push(parseInt(cb.value));
            });
            return selected.length > 0 ? selected : null;
        }
        
        async function editOffer(id) {
            try {
                const response = await fetch(`/api/admin/offers/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const offer = data.data;
                    document.getElementById('offer-id').value = offer.id;
                    document.getElementById('offer-name').value = offer.name || '';
                    document.getElementById('offer-description').value = offer.description || '';
                    document.getElementById('offer-discount-type').value = offer.discount_type || 'percentage';
                    document.getElementById('offer-discount-value').value = offer.discount_value || '';
                    document.getElementById('offer-min-nights').value = offer.min_nights || '';
                    document.getElementById('offer-max-nights').value = offer.max_nights || '';
                    document.getElementById('offer-min-advance').value = offer.min_advance_days || '';
                    document.getElementById('offer-max-advance').value = offer.max_advance_days || '';
                    document.getElementById('offer-valid-from').value = offer.valid_from || '';
                    document.getElementById('offer-valid-until').value = offer.valid_until || '';
                    document.getElementById('offer-priority').value = offer.priority || 0;
                    document.getElementById('offer-active').checked = offer.active;
                    updateOfferToggleVisual(document.getElementById('offer-active'));
                    
                    // Set check-in day checkboxes
                    const checkinDays = (offer.allowed_checkin_days || '0,1,2,3,4,5,6').split(',').map(d => d.trim());
                    ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach((day, idx) => {
                        const cb = document.getElementById('checkin-' + day);
                        if (cb) cb.checked = checkinDays.includes(String(idx));
                    });
                    
                    // Set check-out day checkboxes
                    const checkoutDays = (offer.allowed_checkout_days || '0,1,2,3,4,5,6').split(',').map(d => d.trim());
                    ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach((day, idx) => {
                        const cb = document.getElementById('checkout-' + day);
                        if (cb) cb.checked = checkoutDays.includes(String(idx));
                    });
                    
                    document.getElementById('offer-modal-title').innerHTML = '‚úèÔ∏è Edit Offer';
                    updateDiscountDisplay();
                    await loadPropertiesForOfferDropdown();
                    
                    // Set property checkboxes based on offer data
                    const propertyIds = offer.property_ids || (offer.property_id ? [offer.property_id] : []);
                    if (propertyIds.length === 0) {
                        // All properties
                        document.querySelector('input[name="offer-properties"][value=""]').checked = true;
                    } else {
                        document.querySelector('input[name="offer-properties"][value=""]').checked = false;
                        propertyIds.forEach(pid => {
                            const cb = document.querySelector(`input[name="offer-properties"][value="${pid}"]`);
                            if (cb) cb.checked = true;
                        });
                    }
                    
                    // Load and set room checkboxes
                    await loadRoomsForOfferCheckboxes(propertyIds);
                    const roomIds = offer.room_ids || (offer.room_id ? [offer.room_id] : []);
                    if (roomIds.length === 0) {
                        document.querySelector('input[name="offer-rooms"][value=""]').checked = true;
                    } else {
                        document.querySelector('input[name="offer-rooms"][value=""]').checked = false;
                        roomIds.forEach(rid => {
                            const cb = document.querySelector(`input[name="offer-rooms"][value="${rid}"]`);
                            if (cb) cb.checked = true;
                        });
                    }
                    
                    openModal('addOfferModal');
                }
            } catch (error) {
                alert('Error loading offer: ' + error.message);
            }
        }
        
        function getCheckedDays(prefix) {
            const days = [];
            ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'].forEach((day, idx) => {
                const cb = document.getElementById(prefix + '-' + day);
                if (cb && cb.checked) days.push(idx);
            });
            return days.join(',');
        }
        
        async function saveOffer() {
            const id = document.getElementById('offer-id').value;
            
            // Get selected properties and rooms from checkboxes
            const selectedPropertyIds = getSelectedOfferProperties();
            const selectedRoomIds = getSelectedOfferRooms();
            
            const offerData = {
                name: document.getElementById('offer-name').value,
                description: document.getElementById('offer-description').value,
                discount_type: document.getElementById('offer-discount-type').value,
                discount_value: parseFloat(document.getElementById('offer-discount-value').value),
                property_ids: selectedPropertyIds,
                room_ids: selectedRoomIds,
                // Keep legacy single property_id/room_id for backward compatibility
                property_id: selectedPropertyIds && selectedPropertyIds.length === 1 ? selectedPropertyIds[0] : null,
                room_id: selectedRoomIds && selectedRoomIds.length === 1 ? selectedRoomIds[0] : null,
                min_nights: parseInt(document.getElementById('offer-min-nights').value) || 1,
                max_nights: parseInt(document.getElementById('offer-max-nights').value) || null,
                min_advance_days: parseInt(document.getElementById('offer-min-advance').value) || null,
                max_advance_days: parseInt(document.getElementById('offer-max-advance').value) || null,
                valid_from: document.getElementById('offer-valid-from').value || null,
                valid_until: document.getElementById('offer-valid-until').value || null,
                allowed_checkin_days: getCheckedDays('checkin') || '0,1,2,3,4,5,6',
                allowed_checkout_days: getCheckedDays('checkout') || '0,1,2,3,4,5,6',
                priority: parseInt(document.getElementById('offer-priority').value) || 0,
                active: document.getElementById('offer-active').checked
            };
            
            try {
                const url = id ? `/api/admin/offers/${id}` : '/api/admin/offers';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(offerData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addOfferModal');
                    loadOffers();
                    alert('‚úÖ Offer saved successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving offer: ' + error.message);
            }
        }
        
        async function deleteOffer(id) {
            if (!confirm('Delete this offer?')) return;
            
            try {
                const response = await fetch(`/api/admin/offers/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadOffers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting offer: ' + error.message);
            }
        }

        // =====================================================
        // BOOKINGS FUNCTIONS
        // =====================================================
        
        async function loadBookingsPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('bookings-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for bookings:', error);
            }
        }
        
        async function loadBookingsRooms() {
            const propertyId = document.getElementById('bookings-property-select')?.value;
            const roomSelect = document.getElementById('bookings-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">All Rooms</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadBookingsForProperty() {
            const propertyId = document.getElementById('bookings-property-select')?.value;
            const roomId = document.getElementById('bookings-room-select')?.value;
            const status = document.getElementById('bookings-status-select')?.value;
            
            // Also load rooms when property changes
            if (!roomId) {
                await loadBookingsRooms();
            }
            
            try {
                let url = `/api/admin/bookings?`;
                if (propertyId) url += `property_id=${propertyId}&`;
                if (roomId) url += `room_id=${roomId}&`;
                if (status) url += `status=${status}&`;
                
                // Add account filter if viewing specific account
                if (selectedAccountId) {
                    url += `account_id=${selectedAccountId}&`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    renderBookings(data.data || []);
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
            }
        }
        
        async function loadBookings() {
            // Load property selector first
            await loadBookingsPropertySelect();
            
            // Load all bookings by default
            loadBookingsForProperty();
        }
        
        function renderBookings(bookings) {
            const container = document.getElementById('bookings-list');
            
            if (!bookings || bookings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <h3>No Bookings Found</h3>
                        <p>No bookings match your filters</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Guest</th>
                            <th style="text-align: left; padding: 0.75rem;">Property</th>
                            <th style="text-align: left; padding: 0.75rem;">Room</th>
                            <th style="text-align: left; padding: 0.75rem;">Check-in</th>
                            <th style="text-align: left; padding: 0.75rem;">Check-out</th>
                            <th style="text-align: left; padding: 0.75rem;">Total</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const statusColors = {
                'confirmed': { bg: '#dcfce7', color: '#166534' },
                'pending': { bg: '#fef3c7', color: '#92400e' },
                'cancelled': { bg: '#fee2e2', color: '#991b1b' },
                'completed': { bg: '#e0f2fe', color: '#0369a1' }
            };
            
            const paymentIcons = {
                'pending': 'üü°',
                'deposit_paid': 'üîµ',
                'fully_paid': 'üü¢',
                'overdue': 'üî¥',
                'refunded': '‚ö´'
            };
            
            for (const booking of bookings) {
                const statusStyle = statusColors[booking.status] || statusColors['pending'];
                const checkIn = booking.arrival_date ? new Date(booking.arrival_date).toLocaleDateString() : '-';
                const checkOut = booking.departure_date ? new Date(booking.departure_date).toLocaleDateString() : '-';
                const guestName = [booking.guest_first_name, booking.guest_last_name].filter(Boolean).join(' ') || 'Guest';
                const total = booking.grand_total || booking.total_price || 0;
                const paymentIcon = paymentIcons[booking.payment_status] || 'üü°';
                
                // Check if payment is overdue
                let rowStyle = '';
                if (booking.payment_status === 'overdue') {
                    rowStyle = 'background: #fef2f2;';
                } else if (booking.payment_status === 'deposit_paid' && booking.balance_due_date) {
                    const dueDate = new Date(booking.balance_due_date);
                    const today = new Date();
                    const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 3 && daysUntil > 0) {
                        rowStyle = 'background: #fffbeb;';
                    }
                }
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border); ${rowStyle}">
                        <td style="padding: 0.75rem;">
                            <strong>${guestName}</strong>
                            ${booking.guest_email ? `<br><small style="color: var(--text-secondary);">${booking.guest_email}</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem;"><small>${booking.property_name || '-'}</small></td>
                        <td style="padding: 0.75rem;">${booking.room_name || booking.unit_name || '-'}</td>
                        <td style="padding: 0.75rem;">${checkIn}</td>
                        <td style="padding: 0.75rem;">${checkOut}</td>
                        <td style="padding: 0.75rem; font-weight: 600;">
                            <span title="Payment: ${booking.payment_status || 'pending'}">${paymentIcon}</span>
                            ¬£${parseFloat(total).toFixed(2)}
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span style="background: ${statusStyle.bg}; color: ${statusStyle.color}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; text-transform: capitalize;">
                                ${booking.status || 'pending'}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="viewBooking(${booking.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;" title="View Details">üëÅÔ∏è</button>
                            <button onclick="editBooking(${booking.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;" title="Edit">‚úèÔ∏è</button>
                            <button onclick="deleteBooking(${booking.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;" title="Delete">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function openAddBookingModal() {
            // Reset form
            document.getElementById('add-booking-form').reset();
            document.getElementById('booking-room').innerHTML = '<option value="">Select Room...</option>';
            
            // Populate property dropdown
            loadBookingProperties();
            
            // Set default check-in to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('booking-checkin').value = today;
            
            // Set default checkout to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('booking-checkout').value = tomorrow.toISOString().split('T')[0];
            
            openModal('addBookingModal');
        }
        
        async function loadBookingProperties() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('booking-property');
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadBookingRooms() {
            const propertyId = document.getElementById('booking-property').value;
            const select = document.getElementById('booking-room');
            select.innerHTML = '<option value="">Select Room...</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        select.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function saveNewBooking() {
            const propertyId = document.getElementById('booking-property').value;
            const roomId = document.getElementById('booking-room').value;
            const checkin = document.getElementById('booking-checkin').value;
            const checkout = document.getElementById('booking-checkout').value;
            const guests = document.getElementById('booking-guests').value;
            const firstName = document.getElementById('booking-first-name').value;
            const lastName = document.getElementById('booking-last-name').value;
            const email = document.getElementById('booking-email').value;
            const phone = document.getElementById('booking-phone').value;
            const total = document.getElementById('booking-total').value;
            const paymentStatus = document.getElementById('booking-payment-status').value;
            const status = document.getElementById('booking-status').value;
            const notes = document.getElementById('booking-notes').value;
            const syncCM = document.getElementById('booking-sync-cm').checked;
            
            if (!propertyId || !roomId || !checkin || !checkout || !firstName || !lastName || !email) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        property_id: propertyId,
                        room_id: roomId,
                        check_in: checkin,
                        check_out: checkout,
                        num_adults: guests,
                        guest_first_name: firstName,
                        guest_last_name: lastName,
                        guest_email: email,
                        guest_phone: phone,
                        total_price: total || 0,
                        payment_status: paymentStatus,
                        status: status,
                        notes: notes,
                        sync_to_cm: syncCM
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addBookingModal');
                    loadBookingsForProperty();
                    alert('Booking created successfully!' + (syncCM ? ' Syncing to channel manager...' : ''));
                } else {
                    alert('Error: ' + (data.error || 'Failed to create booking'));
                }
            } catch (error) {
                console.error('Error creating booking:', error);
                alert('Error creating booking');
            }
        }
        
        let currentViewingBookingId = null;
        
        async function viewBooking(id) {
            currentViewingBookingId = id;
            
            try {
                const response = await fetch(`/api/bookings/${id}`);
                const data = await response.json();
                
                if (!data.success || !data.booking) {
                    alert('Failed to load booking details');
                    return;
                }
                
                const b = data.booking;
                
                // Reference
                document.getElementById('view-booking-ref').textContent = `Reference #${b.id}`;
                
                // Status badges
                const statusColors = {
                    'confirmed': { bg: '#dcfce7', color: '#166534', icon: '‚úÖ' },
                    'pending': { bg: '#fef3c7', color: '#92400e', icon: '‚è≥' },
                    'cancelled': { bg: '#fee2e2', color: '#991b1b', icon: '‚ùå' },
                    'completed': { bg: '#e0f2fe', color: '#0369a1', icon: '‚úì' }
                };
                const paymentColors = {
                    'pending': { bg: '#fef3c7', color: '#92400e', label: 'Payment Pending', icon: 'üü°' },
                    'deposit_paid': { bg: '#dbeafe', color: '#1e40af', label: 'Deposit Paid', icon: 'üîµ' },
                    'fully_paid': { bg: '#dcfce7', color: '#166534', label: 'Fully Paid', icon: 'üü¢' },
                    'overdue': { bg: '#fee2e2', color: '#991b1b', label: 'Overdue', icon: 'üî¥' },
                    'refunded': { bg: '#f3f4f6', color: '#374151', label: 'Refunded', icon: '‚ö´' }
                };
                
                const bStatus = statusColors[b.status] || statusColors['pending'];
                const pStatus = paymentColors[b.payment_status] || paymentColors['pending'];
                
                document.getElementById('view-booking-status').innerHTML = `
                    <span style="background: ${bStatus.bg}; color: ${bStatus.color}; padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500; text-transform: capitalize;">
                        ${bStatus.icon} ${b.status || 'pending'}
                    </span>
                `;
                document.getElementById('view-payment-status').innerHTML = `
                    <span style="background: ${pStatus.bg}; color: ${pStatus.color}; padding: 0.4rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">
                        ${pStatus.icon} ${pStatus.label}
                    </span>
                `;
                
                // Alert banner for overdue
                const alertBanner = document.getElementById('view-booking-alert');
                const alertText = document.getElementById('view-booking-alert-text');
                if (b.payment_status === 'overdue') {
                    alertBanner.style.display = 'block';
                    alertText.textContent = 'Payment is overdue! Balance was due on ' + formatDate(b.balance_due_date);
                } else if (b.payment_status === 'deposit_paid' && b.balance_due_date) {
                    const dueDate = new Date(b.balance_due_date);
                    const today = new Date();
                    const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 7 && daysUntil > 0) {
                        alertBanner.style.display = 'block';
                        alertBanner.style.background = '#fef3c7';
                        alertBanner.style.borderColor = '#fde68a';
                        alertText.textContent = `Balance due in ${daysUntil} day${daysUntil === 1 ? '' : 's'}`;
                    } else {
                        alertBanner.style.display = 'none';
                    }
                } else {
                    alertBanner.style.display = 'none';
                }
                
                // Guest info
                const guestName = [b.guest_first_name, b.guest_last_name].filter(Boolean).join(' ') || 'Guest';
                document.getElementById('view-guest-name').textContent = guestName;
                document.getElementById('view-guest-email').textContent = b.guest_email || '-';
                document.getElementById('view-guest-phone').textContent = b.guest_phone || '-';
                document.getElementById('view-guest-country').textContent = b.guest_country || '-';
                
                // Stay details
                document.getElementById('view-property-name').textContent = b.property_name || '-';
                document.getElementById('view-room-name').textContent = b.unit_name || b.room_name || '-';
                document.getElementById('view-checkin').textContent = formatDate(b.arrival_date);
                document.getElementById('view-checkout').textContent = formatDate(b.departure_date);
                
                // Calculate nights
                if (b.arrival_date && b.departure_date) {
                    const nights = Math.ceil((new Date(b.departure_date) - new Date(b.arrival_date)) / (1000 * 60 * 60 * 24));
                    document.getElementById('view-nights').textContent = nights;
                } else {
                    document.getElementById('view-nights').textContent = '-';
                }
                
                document.getElementById('view-guests').textContent = (b.num_adults || 0) + (b.num_children || 0) || '-';
                
                // Notes
                document.getElementById('view-notes').textContent = b.notes || 'No notes';
                
                // Financials
                const currency = b.currency === 'USD' ? '$' : b.currency === 'EUR' ? '‚Ç¨' : '¬£';
                document.getElementById('view-accommodation').textContent = currency + parseFloat(b.accommodation_price || 0).toFixed(2);
                
                // Upsells
                if (b.upsells_total && parseFloat(b.upsells_total) > 0) {
                    document.getElementById('view-upsells-row').style.display = 'flex';
                    document.getElementById('view-upsells').textContent = currency + parseFloat(b.upsells_total).toFixed(2);
                } else {
                    document.getElementById('view-upsells-row').style.display = 'none';
                }
                
                // Discount
                if (b.discount_amount && parseFloat(b.discount_amount) > 0) {
                    document.getElementById('view-discount-row').style.display = 'flex';
                    document.getElementById('view-discount').textContent = '-' + currency + parseFloat(b.discount_amount).toFixed(2);
                } else {
                    document.getElementById('view-discount-row').style.display = 'none';
                }
                
                // Tax
                if (b.tax_amount && parseFloat(b.tax_amount) > 0) {
                    document.getElementById('view-tax-row').style.display = 'flex';
                    document.getElementById('view-tax').textContent = currency + parseFloat(b.tax_amount).toFixed(2);
                } else {
                    document.getElementById('view-tax-row').style.display = 'none';
                }
                
                // Total
                document.getElementById('view-total').textContent = currency + parseFloat(b.grand_total || b.total_price || 0).toFixed(2);
                
                // Payment summary
                document.getElementById('view-deposit-paid').textContent = currency + parseFloat(b.deposit_amount || 0).toFixed(2);
                const balance = parseFloat(b.grand_total || 0) - parseFloat(b.deposit_amount || 0);
                document.getElementById('view-balance-due').textContent = currency + balance.toFixed(2);
                document.getElementById('view-balance-due').style.color = balance > 0 ? '#dc2626' : '#16a34a';
                
                // Due date
                if (b.balance_due_date) {
                    document.getElementById('view-due-date').textContent = formatDate(b.balance_due_date);
                } else {
                    document.getElementById('view-due-date').textContent = 'At check-in';
                }
                
                // Channel Manager
                document.getElementById('view-booking-source').textContent = b.booking_source || 'Direct';
                
                if (b.beds24_booking_id) {
                    document.getElementById('view-beds24-row').style.display = 'flex';
                    document.getElementById('view-beds24-id').textContent = b.beds24_booking_id;
                } else {
                    document.getElementById('view-beds24-row').style.display = 'none';
                }
                
                if (b.hostaway_reservation_id) {
                    document.getElementById('view-hostaway-row').style.display = 'flex';
                    document.getElementById('view-hostaway-id').textContent = b.hostaway_reservation_id;
                } else {
                    document.getElementById('view-hostaway-row').style.display = 'none';
                }
                
                openModal('viewBookingModal');
                
            } catch (error) {
                console.error('Error loading booking:', error);
                alert('Error loading booking details');
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        
        async function generateInvoice(bookingId) {
            if (!bookingId) return;
            
            // Open invoice in new window - server returns HTML directly
            window.open(`/api/bookings/${bookingId}/invoice`, '_blank');
        }
        
        async function sendPaymentReceipt(bookingId) {
            if (!bookingId) return;
            
            if (!confirm('Send payment receipt email to the guest?')) return;
            
            try {
                const response = await fetch(`/api/bookings/${bookingId}/send-receipt`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Receipt sent successfully!');
                } else {
                    alert('Error sending receipt: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending receipt:', error);
                alert('Error sending receipt');
            }
        }
        
        async function processRefund(bookingId) {
            if (!bookingId) return;
            
            const amount = prompt('Enter refund amount (leave empty for full refund):');
            if (amount === null) return;
            
            if (!confirm('Are you sure you want to process this refund?')) return;
            
            try {
                const response = await fetch(`/api/bookings/${bookingId}/refund`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ amount: amount || null })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Refund processed successfully!');
                    viewBooking(bookingId); // Refresh
                } else {
                    alert('Error processing refund: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error processing refund:', error);
                alert('Error processing refund');
            }
        }
        
        async function cancelBooking(bookingId) {
            if (!bookingId) return;
            
            if (!confirm('Are you sure you want to cancel this booking? This will also update the channel manager.')) return;
            
            try {
                const response = await fetch(`/api/bookings/${bookingId}/cancel`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Booking cancelled successfully!');
                    closeModal('viewBookingModal');
                    loadBookingsForProperty(); // Refresh list
                } else {
                    alert('Error cancelling booking: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error cancelling booking:', error);
                alert('Error cancelling booking');
            }
        }
        
        // Alias for clicking on booked dates in the calendar grid
        function openBookingDetail(id) {
            viewBooking(id);
        }
        
        async function editBooking(id) {
            console.log('editBooking called with id:', id);
            try {
                // Fetch booking details
                const response = await fetch(`/api/bookings/${id}`);
                const data = await response.json();
                console.log('Booking data:', data);
                
                if (!data.success || !data.booking) {
                    alert('Error loading booking details: ' + (data.error || 'Unknown error'));
                    return;
                }
                
                const booking = data.booking;
                
                // Populate modal fields
                document.getElementById('edit-booking-id').value = booking.id;
                document.getElementById('edit-booking-beds24-id').value = booking.beds24_booking_id || '';
                document.getElementById('edit-booking-ref').textContent = `#${booking.id}`;
                
                // Guest details
                document.getElementById('edit-booking-first-name').value = booking.guest_first_name || '';
                document.getElementById('edit-booking-last-name').value = booking.guest_last_name || '';
                document.getElementById('edit-booking-email').value = booking.guest_email || '';
                document.getElementById('edit-booking-phone').value = booking.guest_phone || '';
                
                // Stay details
                document.getElementById('edit-booking-checkin').value = booking.arrival_date?.split('T')[0] || '';
                document.getElementById('edit-booking-checkout').value = booking.departure_date?.split('T')[0] || '';
                document.getElementById('edit-booking-adults').value = booking.num_adults || 1;
                document.getElementById('edit-booking-children').value = booking.num_children || 0;
                
                // Pricing
                document.getElementById('edit-booking-total').value = booking.grand_total || booking.accommodation_price || 0;
                document.getElementById('edit-booking-deposit').value = booking.deposit_amount || 0;
                document.getElementById('edit-booking-balance').value = booking.balance_amount || 0;
                
                // Status
                document.getElementById('edit-booking-status').value = booking.status || 'pending';
                document.getElementById('edit-booking-payment-status').value = booking.payment_status || 'pending';
                
                // Notes
                document.getElementById('edit-booking-notes').value = booking.notes || '';
                
                // Show sync warning if linked to channel manager
                const syncInfo = document.getElementById('edit-booking-sync-info');
                const syncSource = document.getElementById('edit-booking-sync-source');
                if (booking.beds24_booking_id) {
                    syncInfo.style.display = 'block';
                    syncSource.textContent = 'Beds24';
                } else if (booking.hostaway_reservation_id) {
                    syncInfo.style.display = 'block';
                    syncSource.textContent = 'Hostaway';
                } else if (booking.smoobu_booking_id) {
                    syncInfo.style.display = 'block';
                    syncSource.textContent = 'Smoobu';
                } else {
                    syncInfo.style.display = 'none';
                }
                
                // Open modal
                document.getElementById('edit-booking-modal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading booking:', error);
                alert('Error loading booking details');
            }
        }
        
        function closeEditBookingModal() {
            document.getElementById('edit-booking-modal').style.display = 'none';
        }
        
        async function saveBookingEdit() {
            const btn = document.getElementById('save-booking-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            try {
                const bookingId = document.getElementById('edit-booking-id').value;
                
                const updates = {
                    guest_first_name: document.getElementById('edit-booking-first-name').value,
                    guest_last_name: document.getElementById('edit-booking-last-name').value,
                    guest_email: document.getElementById('edit-booking-email').value,
                    guest_phone: document.getElementById('edit-booking-phone').value,
                    arrival_date: document.getElementById('edit-booking-checkin').value,
                    departure_date: document.getElementById('edit-booking-checkout').value,
                    num_adults: parseInt(document.getElementById('edit-booking-adults').value) || 1,
                    num_children: parseInt(document.getElementById('edit-booking-children').value) || 0,
                    grand_total: parseFloat(document.getElementById('edit-booking-total').value) || 0,
                    deposit_amount: parseFloat(document.getElementById('edit-booking-deposit').value) || 0,
                    balance_amount: parseFloat(document.getElementById('edit-booking-balance').value) || 0,
                    status: document.getElementById('edit-booking-status').value,
                    payment_status: document.getElementById('edit-booking-payment-status').value,
                    notes: document.getElementById('edit-booking-notes').value
                };
                
                const response = await fetch(`/api/bookings/${bookingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(updates)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeEditBookingModal();
                    loadBookingsForProperty();
                    
                    // Show sync status
                    if (data.beds24_synced) {
                        alert('‚úÖ Booking updated and synced to Beds24');
                    } else {
                        alert('‚úÖ Booking updated');
                    }
                } else {
                    alert('Error saving booking: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving booking:', error);
                alert('Error saving booking');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        }
        
        async function deleteBooking(id) {
            if (!confirm('Are you sure you want to delete this booking? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/bookings/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    loadBookingsForProperty();
                } else {
                    alert('Error deleting booking: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                alert('Error deleting booking');
            }
        }

        // =====================================================
        // VOUCHERS FUNCTIONS
        // =====================================================
        
        async function loadVouchersPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('vouchers-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for vouchers:', error);
            }
        }
        
        async function loadVouchersRooms() {
            const propertyId = document.getElementById('vouchers-property-select')?.value;
            const roomSelect = document.getElementById('vouchers-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">All Rooms</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadVouchersForProperty() {
            const propertyId = document.getElementById('vouchers-property-select')?.value;
            const roomId = document.getElementById('vouchers-room-select')?.value;
            
            // Also load rooms when property changes
            if (!roomId) {
                await loadVouchersRooms();
            }
            
            if (!propertyId) {
                document.getElementById('vouchers-list').innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        Select a property to view and manage vouchers
                    </p>
                `;
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/vouchers?property_id=${propertyId}${roomId ? '&room_id=' + roomId : ''}`);
                const data = await response.json();
                
                if (data.success) {
                    renderVouchers(data.data || []);
                }
            } catch (error) {
                console.error('Error loading vouchers:', error);
            }
        }
        
        async function loadVouchers() {
            // Load property selector first
            await loadVouchersPropertySelect();
            
            // Show message to select property
            document.getElementById('vouchers-list').innerHTML = `
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                    Select a property to view and manage vouchers
                </p>
            `;
        }
        
        function renderVouchers(vouchers) {
            const container = document.getElementById('vouchers-list');
            const propertyId = document.getElementById('vouchers-property-select')?.value;
            
            if (!propertyId) {
                container.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        Select a property to view and manage vouchers
                    </p>
                `;
                return;
            }
            
            if (!vouchers || vouchers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üéüÔ∏è</div>
                        <h3>No Vouchers for This Property</h3>
                        <p>Click any template above or create a custom voucher</p>
                        <button class="btn" onclick="openAddVoucherModal()">Create Custom Voucher</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Code</th>
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Value</th>
                            <th style="text-align: left; padding: 0.75rem;">Usage</th>
                            <th style="text-align: left; padding: 0.75rem;">Valid</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const voucher of vouchers) {
                // Format discount based on type
                let discountText = '';
                let discountColor = '#92400e';
                let discountBg = '#fef3c7';
                
                switch (voucher.discount_type) {
                    case 'percentage':
                        discountText = `${voucher.discount_value}% Off`;
                        discountColor = '#166534';
                        discountBg = '#dcfce7';
                        break;
                    case 'fixed':
                        discountText = `¬£${voucher.discount_value} Off`;
                        discountColor = '#166534';
                        discountBg = '#dcfce7';
                        break;
                    case 'monetary':
                        discountText = `¬£${voucher.discount_value} Credit`;
                        discountColor = '#7c3aed';
                        discountBg = '#ede9fe';
                        break;
                    case 'free_nights':
                        discountText = `${voucher.discount_value} Free Night${voucher.discount_value > 1 ? 's' : ''}`;
                        discountColor = '#0369a1';
                        discountBg = '#e0f2fe';
                        break;
                    case 'addon':
                        discountText = 'Free Add-on';
                        discountColor = '#c2410c';
                        discountBg = '#ffedd5';
                        break;
                    default:
                        discountText = voucher.discount_type === 'fixed_amount' 
                            ? `¬£${voucher.discount_value}` 
                            : `${voucher.discount_value}%`;
                }
                
                const usageText = voucher.max_uses 
                    ? `${voucher.uses_count || 0} / ${voucher.max_uses}`
                    : `${voucher.uses_count || 0} uses`;
                
                const validText = voucher.valid_from || voucher.valid_until 
                    ? `${voucher.valid_from || 'Start'} - ${voucher.valid_until || 'End'}`
                    : 'Always';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <code style="background: var(--bg-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: bold;">
                                ${voucher.code}
                            </code>
                        </td>
                        <td style="padding: 0.75rem;">${voucher.name}</td>
                        <td style="padding: 0.75rem;">
                            <span style="background: ${discountBg}; color: ${discountColor}; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 500;">
                                ${discountText}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${usageText}</td>
                        <td style="padding: 0.75rem; font-size: 0.85rem;">${validText}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span style="background: ${voucher.active ? '#dcfce7' : '#fee2e2'}; color: ${voucher.active ? '#166534' : '#991b1b'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                ${voucher.active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editVoucher(${voucher.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;">‚úèÔ∏è</button>
                            <button onclick="deleteVoucher(${voucher.id})" style="background: none; border: none; cursor: pointer; padding: 0.25rem;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Toggle voucher presets visibility
        function toggleVoucherPresets() {
            const presets = document.getElementById('all-voucher-presets');
            const btn = document.getElementById('toggle-voucher-presets-btn');
            
            if (presets.style.display === 'none') {
                presets.style.display = 'block';
                btn.textContent = 'Hide Categories ‚ñ≤';
            } else {
                presets.style.display = 'none';
                btn.textContent = 'Show All Categories ‚ñº';
            }
        }
        
        // Quick add voucher from preset - opens modal pre-filled
        async function quickAddVoucher(name, voucherType, value) {
            document.getElementById('voucher-form').reset();
            document.getElementById('voucher-id').value = '';
            
            // Pre-fill with preset values
            document.getElementById('voucher-name').value = name;
            
            // Set discount type based on voucher type
            if (voucherType === 'percentage') {
                document.getElementById('voucher-discount-type').value = 'percentage';
                document.getElementById('voucher-discount-value').value = value;
            } else if (voucherType === 'fixed' || voucherType === 'monetary') {
                document.getElementById('voucher-discount-type').value = voucherType;
                document.getElementById('voucher-discount-value').value = value;
            } else if (voucherType === 'stay') {
                document.getElementById('voucher-discount-type').value = 'free_nights';
                document.getElementById('voucher-discount-value').value = value;
            } else if (voucherType === 'addon') {
                document.getElementById('voucher-discount-type').value = 'addon';
                document.getElementById('voucher-discount-value').value = value;
            }
            
            // Generate a random code
            const code = name.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().substring(0, 8) + Math.floor(Math.random() * 1000);
            document.getElementById('voucher-code').value = code;
            
            document.getElementById('voucher-active').checked = true;
            
            // Load properties
            await loadVoucherPropertiesForModal();
            
            document.querySelector('#addVoucherModal .modal-title').textContent = 'üéüÔ∏è Create: ' + name;
            openModal('addVoucherModal');
        }
        
        function openAddVoucherModal() {
            document.getElementById('voucher-form').reset();
            document.getElementById('voucher-id').value = '';
            document.getElementById('voucher-active').checked = true;
            document.querySelector('#addVoucherModal .modal-title').textContent = 'üéüÔ∏è Create New Voucher';
            
            // Pre-select property from page filter
            const selectedProperty = document.getElementById('vouchers-property-select')?.value;
            loadVoucherPropertiesForModal().then(() => {
                if (selectedProperty) {
                    document.getElementById('voucher-property').value = selectedProperty;
                    loadVoucherUnits();
                }
            });
            openModal('addVoucherModal');
        }
        
        async function loadVoucherPropertiesForModal() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('voucher-property');
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                // Reset unit select
                document.getElementById('voucher-unit').innerHTML = '<option value="">All Units</option>';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadVoucherUnits() {
            const propertyId = document.getElementById('voucher-property').value;
            const unitSelect = document.getElementById('voucher-unit');
            
            unitSelect.innerHTML = '<option value="">All Units</option>';
            
            if (!propertyId) return;
            
            try {
                // Use bookable-units endpoint - same as Offers page
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    
                    units.forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        async function editVoucher(id) {
            try {
                const response = await fetch(`/api/admin/vouchers/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const voucher = data.data;
                    document.getElementById('voucher-id').value = voucher.id;
                    document.getElementById('voucher-code').value = voucher.code || '';
                    document.getElementById('voucher-name').value = voucher.name || '';
                    document.getElementById('voucher-description').value = voucher.description || '';
                    document.getElementById('voucher-discount-type').value = voucher.discount_type || 'percentage';
                    document.getElementById('voucher-discount-value').value = voucher.discount_value || '';
                    document.getElementById('voucher-valid-from').value = voucher.valid_from || '';
                    document.getElementById('voucher-valid-until').value = voucher.valid_until || '';
                    document.getElementById('voucher-max-uses').value = voucher.max_uses || '';
                    document.getElementById('voucher-min-nights').value = voucher.min_nights || '';
                    document.getElementById('voucher-min-total').value = voucher.min_total || '';
                    document.getElementById('voucher-single-use').checked = voucher.single_use_per_guest || false;
                    document.getElementById('voucher-active').checked = voucher.active;
                    
                    document.querySelector('#addVoucherModal .modal-title').textContent = 'Edit Voucher';
                    openModal('addVoucherModal');
                }
            } catch (error) {
                alert('Error loading voucher: ' + error.message);
            }
        }
        
        async function saveVoucher() {
            const id = document.getElementById('voucher-id').value;
            const voucherData = {
                code: document.getElementById('voucher-code').value,
                name: document.getElementById('voucher-name').value,
                description: document.getElementById('voucher-description').value,
                discount_type: document.getElementById('voucher-discount-type').value,
                discount_value: parseFloat(document.getElementById('voucher-discount-value').value),
                valid_from: document.getElementById('voucher-valid-from').value || null,
                valid_until: document.getElementById('voucher-valid-until').value || null,
                max_uses: parseInt(document.getElementById('voucher-max-uses').value) || null,
                min_nights: parseInt(document.getElementById('voucher-min-nights').value) || 1,
                min_total: parseFloat(document.getElementById('voucher-min-total').value) || null,
                single_use_per_guest: document.getElementById('voucher-single-use').checked,
                active: document.getElementById('voucher-active').checked
            };
            
            try {
                const url = id ? `/api/admin/vouchers/${id}` : '/api/admin/vouchers';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(voucherData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addVoucherModal');
                    loadVouchersForProperty();
                    alert('‚úÖ Voucher saved successfully!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving voucher: ' + error.message);
            }
        }
        
        async function deleteVoucher(id) {
            if (!confirm('Delete this voucher?')) return;
            
            try {
                const response = await fetch(`/api/admin/vouchers/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadVouchersForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting voucher: ' + error.message);
            }
        }

        // =====================================================
        // UPSELLS FUNCTIONS
        // =====================================================
        
        let upsellsData = [];
        
        async function loadUpsellsPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('upsells-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for upsells:', error);
            }
        }
        
        async function loadUpsellsRooms() {
            const propertyId = document.getElementById('upsells-property-select')?.value;
            const roomSelect = document.getElementById('upsells-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">All Rooms</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        async function loadUpsellsForProperty() {
            const propertyId = document.getElementById('upsells-property-select')?.value;
            const roomId = document.getElementById('upsells-room-select')?.value;
            
            // Also load rooms when property changes
            if (!roomId) {
                await loadUpsellsRooms();
            }
            
            if (!propertyId) {
                document.getElementById('upsells-list').innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        Select a property to view and manage upsells
                    </p>
                `;
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/upsells?property_id=${propertyId}${roomId ? '&room_id=' + roomId : ''}`);
                const data = await response.json();
                
                if (data.success) {
                    upsellsData = data.data || [];
                    renderUpsells(upsellsData);
                }
            } catch (error) {
                console.error('Error loading upsells:', error);
            }
        }
        
        async function loadUpsells() {
            // Load property selector first
            await loadUpsellsPropertySelect();
            
            // Show message to select property
            document.getElementById('upsells-list').innerHTML = `
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                    Select a property to view and manage upsells
                </p>
            `;
        }
        
        function renderUpsells(upsells) {
            const container = document.getElementById('upsells-list');
            const propertyId = document.getElementById('upsells-property-select')?.value;
            
            if (!propertyId) {
                container.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        Select a property to view and manage upsells
                    </p>
                `;
                return;
            }
            
            if (!upsells || upsells.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üéÅ</div>
                        <h3>No Upsells for This Property</h3>
                        <p>Click any preset above or create a custom upsell</p>
                        <button class="btn" onclick="openAddUpsellModal()">Create Custom Upsell</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Price</th>
                            <th style="text-align: left; padding: 0.75rem;">Charge Type</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const chargeTypeLabels = {
                'per_booking': 'Per Booking',
                'per_night': 'Per Night',
                'per_day': 'Per Day',
                'per_guest': 'Per Guest',
                'per_guest_per_night': 'Per Guest/Night',
                'per_hour': 'Per Hour'
            };
            
            for (const upsell of upsells) {
                const vendorBadge = upsell.is_external ? 
                    `<span class="badge badge-info" style="font-size: 0.7rem; margin-left: 0.5rem;">üöó ${upsell.vendor_name || 'External'}</span>` : '';
                    
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${upsell.name}</strong>${vendorBadge}
                            ${upsell.description ? `<br><small style="color: var(--text-secondary);">${upsell.description}</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #059669;">$${parseFloat(upsell.price).toFixed(2)}</td>
                        <td style="padding: 0.75rem; color: var(--text-secondary); font-size: 0.9rem;">${chargeTypeLabels[upsell.charge_type] || upsell.charge_type}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${upsell.active ? 'badge-success' : 'badge-secondary'}">${upsell.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editUpsell(${upsell.id})" style="background: none; border: none; cursor: pointer;">‚úèÔ∏è</button>
                            <button onclick="deleteUpsell(${upsell.id})" style="background: none; border: none; cursor: pointer;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function openAddUpsellModal() {
            document.getElementById('upsell-form').reset();
            document.getElementById('upsell-id').value = '';
            document.getElementById('upsell-modal-title').innerHTML = 'üéÅ Add Upsell';
            document.getElementById('upsell-active').checked = true;
            document.getElementById('upsell-multi-room').checked = false;
            document.getElementById('upsell-rooms-checkboxes').style.display = 'none';
            document.getElementById('upsell-room').style.display = 'block';
            
            // Reset provider type to internal
            document.querySelector('input[name="upsell-provider-type"][value="internal"]').checked = true;
            document.getElementById('upsell-vendor-section').style.display = 'none';
            loadVendorsForUpsellModal();
            
            // Pre-select property from page filter
            const selectedProperty = document.getElementById('upsells-property-select')?.value;
            loadUpsellPropertiesForModal().then(() => {
                if (selectedProperty) {
                    document.getElementById('upsell-property').value = selectedProperty;
                    loadUpsellRooms();
                }
            });
            openModal('addUpsellModal');
        }
        
        function toggleUpsellProviderType() {
            const isExternal = document.querySelector('input[name="upsell-provider-type"]:checked')?.value === 'external';
            document.getElementById('upsell-vendor-section').style.display = isExternal ? 'block' : 'none';
            
            // Update radio button styling
            const internalLabel = document.getElementById('upsell-internal-label');
            const externalLabel = document.getElementById('upsell-external-label');
            
            if (isExternal) {
                internalLabel.style.borderColor = '#e5e7eb';
                internalLabel.style.background = 'white';
                externalLabel.style.borderColor = '#6366f1';
                externalLabel.style.background = '#eef2ff';
            } else {
                externalLabel.style.borderColor = '#e5e7eb';
                externalLabel.style.background = 'white';
                internalLabel.style.borderColor = '#10b981';
                internalLabel.style.background = '#ecfdf5';
            }
        }
        
        async function loadVendorsForUpsellModal() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/vendors${queryString}`, { headers: authHeaders() });
                const data = await response.json();
                
                const select = document.getElementById('upsell-vendor');
                select.innerHTML = '<option value="">Select a vendor...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(v => {
                        select.innerHTML += `<option value="${v.id}">${v.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading vendors:', error);
            }
        }
        
        async function loadUpsellPropertiesForModal() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('upsell-property');
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                // Reset unit select
                document.getElementById('upsell-room').innerHTML = '<option value="">All Units</option>';
                document.getElementById('upsell-rooms-checkboxes').innerHTML = '';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadUpsellRooms() {
            const propertyId = document.getElementById('upsell-property').value;
            const roomSelect = document.getElementById('upsell-room');
            const roomCheckboxes = document.getElementById('upsell-rooms-checkboxes');
            
            roomSelect.innerHTML = '<option value="">All Units</option>';
            roomCheckboxes.innerHTML = '';
            
            if (!propertyId) return;
            
            try {
                // Use bookable-units endpoint - same as Offers page
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    
                    if (units.length > 0) {
                        units.forEach(unit => {
                            // Add to dropdown
                            roomSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                            
                            // Add checkbox
                            roomCheckboxes.innerHTML += `
                                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; cursor: pointer; border-radius: 4px; transition: background 0.2s;"
                                    onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background=''">
                                    <input type="checkbox" name="upsell-room-check" value="${unit.id}" style="width: 16px; height: 16px;">
                                    <span style="font-size: 0.9rem;">${unit.name}</span>
                                </label>
                            `;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        function toggleUpsellMultiRoom() {
            const multiRoom = document.getElementById('upsell-multi-room').checked;
            const roomSelect = document.getElementById('upsell-room');
            const roomCheckboxes = document.getElementById('upsell-rooms-checkboxes');
            
            if (multiRoom) {
                roomSelect.style.display = 'none';
                roomCheckboxes.style.display = 'block';
            } else {
                roomSelect.style.display = 'block';
                roomCheckboxes.style.display = 'none';
            }
        }
        
        async function editUpsell(id) {
            const upsell = upsellsData.find(u => u.id === id);
            if (!upsell) return;
            
            document.getElementById('upsell-id').value = upsell.id;
            document.getElementById('upsell-name').value = upsell.name || '';
            document.getElementById('upsell-description').value = upsell.description || '';
            document.getElementById('upsell-price').value = upsell.price || '';
            document.getElementById('upsell-charge-type').value = upsell.charge_type || 'per_booking';
            document.getElementById('upsell-max-qty').value = upsell.max_quantity || '';
            document.getElementById('upsell-active').checked = upsell.active;
            document.getElementById('upsell-multi-room').checked = false;
            document.getElementById('upsell-rooms-checkboxes').style.display = 'none';
            document.getElementById('upsell-room').style.display = 'block';
            
            // Set provider type and vendor
            if (upsell.is_external) {
                document.querySelector('input[name="upsell-provider-type"][value="external"]').checked = true;
                document.getElementById('upsell-vendor-section').style.display = 'block';
            } else {
                document.querySelector('input[name="upsell-provider-type"][value="internal"]').checked = true;
                document.getElementById('upsell-vendor-section').style.display = 'none';
            }
            toggleUpsellProviderType();
            
            // Load vendors and set selected
            await loadVendorsForUpsellModal();
            if (upsell.vendor_id) {
                document.getElementById('upsell-vendor').value = upsell.vendor_id;
            }
            
            // Load properties first
            await loadUpsellPropertiesForModal();
            
            // Set property and load rooms
            if (upsell.property_id) {
                document.getElementById('upsell-property').value = upsell.property_id;
                await loadUpsellRooms();
                
                // Set room if single room
                if (upsell.room_id) {
                    document.getElementById('upsell-room').value = upsell.room_id;
                }
                // Handle room_ids (multiple rooms)
                if (upsell.room_ids) {
                    const roomIds = upsell.room_ids.split(',');
                    if (roomIds.length > 1) {
                        document.getElementById('upsell-multi-room').checked = true;
                        toggleUpsellMultiRoom();
                        roomIds.forEach(rid => {
                            const checkbox = document.querySelector(`input[name="upsell-room-check"][value="${rid}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            }
            
            document.getElementById('upsell-modal-title').innerHTML = '‚úèÔ∏è Edit Upsell';
            openModal('addUpsellModal');
        }
        
        async function saveUpsell() {
            const id = document.getElementById('upsell-id').value;
            const multiRoom = document.getElementById('upsell-multi-room').checked;
            
            // Get room IDs
            let roomId = null;
            let roomIds = null;
            
            if (multiRoom) {
                const checkedBoxes = document.querySelectorAll('input[name="upsell-room-check"]:checked');
                if (checkedBoxes.length > 0) {
                    roomIds = Array.from(checkedBoxes).map(cb => cb.value).join(',');
                }
            } else {
                roomId = document.getElementById('upsell-room').value || null;
            }
            
            // Get vendor info
            const isExternal = document.querySelector('input[name="upsell-provider-type"]:checked')?.value === 'external';
            const vendorId = isExternal ? (document.getElementById('upsell-vendor').value || null) : null;
            
            const upsellData = {
                name: document.getElementById('upsell-name').value,
                description: document.getElementById('upsell-description').value,
                price: parseFloat(document.getElementById('upsell-price').value),
                charge_type: document.getElementById('upsell-charge-type').value,
                max_quantity: parseInt(document.getElementById('upsell-max-qty').value) || null,
                property_id: document.getElementById('upsell-property').value || null,
                room_id: roomId,
                room_ids: roomIds,
                active: document.getElementById('upsell-active').checked,
                is_external: isExternal,
                vendor_id: vendorId
            };
            
            try {
                const url = id ? `/api/admin/upsells/${id}` : '/api/admin/upsells';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(upsellData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addUpsellModal');
                    loadUpsellsForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving upsell: ' + error.message);
            }
        }
        
        async function deleteUpsell(id) {
            if (!confirm('Delete this upsell?')) return;
            
            try {
                const response = await fetch(`/api/admin/upsells/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadUpsellsForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting upsell: ' + error.message);
            }
        }

        // =====================================================
        // VENDORS FUNCTIONS
        // =====================================================
        
        let vendorsData = [];
        
        async function loadVendors() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/vendors${queryString}`, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    vendorsData = data.data || [];
                    renderVendors(vendorsData);
                }
            } catch (error) {
                console.error('Error loading vendors:', error);
            }
        }
        
        function renderVendors(vendors) {
            const container = document.getElementById('vendors-list');
            if (!container) return;
            
            if (!vendors || vendors.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ü§ù</div>
                        <h3>No Vendors Configured</h3>
                        <p>Add external vendors like taxi companies, tour operators, or local services</p>
                        <button class="btn" onclick="openAddVendorModal()">Add Your First Vendor</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Vendor</th>
                                <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Contact</th>
                                <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Linked Items</th>
                                <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Pending</th>
                                <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Status</th>
                                <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${vendors.map(v => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 12px 8px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #4f46e5); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">${v.name.charAt(0)}</div>
                                            <div>
                                                <strong>${v.name}</strong>
                                                ${v.contact_name ? `<div style="font-size: 0.85rem; color: var(--text-secondary);">${v.contact_name}</div>` : ''}
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding: 12px 8px;">
                                        <div style="font-size: 0.9rem;">${v.email}</div>
                                        ${v.phone ? `<div style="font-size: 0.85rem; color: var(--text-secondary);">${v.phone}</div>` : ''}
                                    </td>
                                    <td style="padding: 12px 8px;">
                                        ${parseInt(v.upsell_count) > 0 ? `<span class="badge badge-success">${v.upsell_count} upsell${v.upsell_count > 1 ? 's' : ''}</span>` : ''}
                                        ${parseInt(v.voucher_count) > 0 ? `<span class="badge badge-info">${v.voucher_count} voucher${v.voucher_count > 1 ? 's' : ''}</span>` : ''}
                                        ${parseInt(v.upsell_count) === 0 && parseInt(v.voucher_count) === 0 ? '<span style="color: var(--text-secondary);">None</span>' : ''}
                                    </td>
                                    <td style="padding: 12px 8px;">
                                        ${parseInt(v.pending_requests) > 0 ? `<span class="badge badge-warning">${v.pending_requests}</span>` : '<span style="color: var(--text-secondary);">0</span>'}
                                    </td>
                                    <td style="padding: 12px 8px;">
                                        <span class="badge ${v.status === 'active' ? 'badge-success' : 'badge-secondary'}">${v.status}</span>
                                    </td>
                                    <td style="padding: 12px 8px;">
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-secondary btn-small" onclick="editVendor(${v.id})">Edit</button>
                                            <button class="btn btn-secondary btn-small" onclick="deleteVendor(${v.id})" style="color: #dc2626;">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function openAddVendorModal() {
            document.getElementById('vendor-form').reset();
            document.getElementById('vendor-id').value = '';
            document.getElementById('vendor-modal-title').innerHTML = 'ü§ù Add Vendor';
            document.getElementById('vendor-status').value = 'active';
            
            // Reset permissions to defaults
            document.getElementById('perm-guest-name').checked = true;
            document.getElementById('perm-guest-phone').checked = true;
            document.getElementById('perm-guest-email').checked = false;
            document.getElementById('perm-check-in').checked = true;
            document.getElementById('perm-check-out').checked = true;
            document.getElementById('perm-property').checked = true;
            document.getElementById('perm-room').checked = false;
            document.getElementById('perm-guest-count').checked = true;
            document.getElementById('perm-requests').checked = true;
            document.getElementById('perm-address').checked = false;
            document.getElementById('perm-total').checked = false;
            
            openModal('addVendorModal');
        }
        
        async function editVendor(id) {
            try {
                const response = await fetch(`/api/admin/vendors/${id}`, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.data) {
                    const v = data.data;
                    document.getElementById('vendor-id').value = v.id;
                    document.getElementById('vendor-modal-title').innerHTML = 'ü§ù Edit Vendor';
                    document.getElementById('vendor-name').value = v.name || '';
                    document.getElementById('vendor-contact').value = v.contact_name || '';
                    document.getElementById('vendor-email').value = v.email || '';
                    document.getElementById('vendor-phone').value = v.phone || '';
                    document.getElementById('vendor-address').value = v.address || '';
                    document.getElementById('vendor-notes').value = v.notes || '';
                    document.getElementById('vendor-login-email').value = v.login_email || '';
                    document.getElementById('vendor-password').value = '';
                    document.getElementById('vendor-status').value = v.status || 'active';
                    
                    // Set permissions
                    if (v.permissions) {
                        document.getElementById('perm-guest-name').checked = v.permissions.can_see_guest_name !== false;
                        document.getElementById('perm-guest-phone').checked = v.permissions.can_see_guest_phone !== false;
                        document.getElementById('perm-guest-email').checked = v.permissions.can_see_guest_email || false;
                        document.getElementById('perm-check-in').checked = v.permissions.can_see_check_in_date !== false;
                        document.getElementById('perm-check-out').checked = v.permissions.can_see_check_out_date !== false;
                        document.getElementById('perm-property').checked = v.permissions.can_see_property_name !== false;
                        document.getElementById('perm-room').checked = v.permissions.can_see_room_name || false;
                        document.getElementById('perm-guest-count').checked = v.permissions.can_see_guest_count !== false;
                        document.getElementById('perm-requests').checked = v.permissions.can_see_special_requests !== false;
                        document.getElementById('perm-address').checked = v.permissions.can_see_guest_address || false;
                        document.getElementById('perm-total').checked = v.permissions.can_see_booking_total || false;
                    }
                    
                    openModal('addVendorModal');
                }
            } catch (error) {
                alert('Error loading vendor: ' + error.message);
            }
        }
        
        async function saveVendor() {
            const id = document.getElementById('vendor-id').value;
            
            const vendorData = {
                account_id: currentAccount?.id || viewingAccountId || 1,
                name: document.getElementById('vendor-name').value,
                contact_name: document.getElementById('vendor-contact').value,
                email: document.getElementById('vendor-email').value,
                phone: document.getElementById('vendor-phone').value,
                address: document.getElementById('vendor-address').value,
                notes: document.getElementById('vendor-notes').value,
                login_email: document.getElementById('vendor-login-email').value || null,
                password: document.getElementById('vendor-password').value || null,
                status: document.getElementById('vendor-status').value,
                permissions: {
                    can_see_guest_name: document.getElementById('perm-guest-name').checked,
                    can_see_guest_phone: document.getElementById('perm-guest-phone').checked,
                    can_see_guest_email: document.getElementById('perm-guest-email').checked,
                    can_see_check_in_date: document.getElementById('perm-check-in').checked,
                    can_see_check_out_date: document.getElementById('perm-check-out').checked,
                    can_see_property_name: document.getElementById('perm-property').checked,
                    can_see_room_name: document.getElementById('perm-room').checked,
                    can_see_guest_count: document.getElementById('perm-guest-count').checked,
                    can_see_special_requests: document.getElementById('perm-requests').checked,
                    can_see_guest_address: document.getElementById('perm-address').checked,
                    can_see_booking_total: document.getElementById('perm-total').checked
                }
            };
            
            try {
                const url = id ? `/api/admin/vendors/${id}` : '/api/admin/vendors';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(vendorData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addVendorModal');
                    loadVendors();
                    // Also refresh vendor dropdown in upsell modal if it's open
                    loadVendorsForUpsellModal();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving vendor: ' + error.message);
            }
        }
        
        async function deleteVendor(id) {
            if (!confirm('Delete this vendor? Any linked upsells/vouchers will be converted to internal.')) return;
            
            try {
                const response = await fetch(`/api/admin/vendors/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadVendors();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting vendor: ' + error.message);
            }
        }
        
        async function loadServiceRequests() {
            const status = document.getElementById('service-requests-filter')?.value;
            const container = document.getElementById('service-requests-list');
            if (!container) return;
            
            try {
                const queryString = buildQueryString();
                let url = `/api/admin/service-requests${queryString}`;
                if (status) {
                    url += (queryString ? '&' : '?') + `status=${status}`;
                }
                
                const response = await fetch(url, { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    container.innerHTML = `
                        <div class="table-container">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Service</th>
                                        <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Vendor</th>
                                        <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Guest</th>
                                        <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Dates</th>
                                        <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Status</th>
                                        <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data.map(r => `
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <td style="padding: 12px 8px;">
                                                <strong>${r.service_name}</strong>
                                                <div style="font-size: 0.85rem; color: var(--text-secondary);">Qty: ${r.quantity} | ¬£${parseFloat(r.total_price || 0).toFixed(2)}</div>
                                            </td>
                                            <td style="padding: 12px 8px;">${r.vendor_name || '-'}</td>
                                            <td style="padding: 12px 8px;">${r.guest_name || '-'}</td>
                                            <td style="padding: 12px 8px;">
                                                ${r.check_in ? new Date(r.check_in).toLocaleDateString() : '-'}
                                                ${r.check_out ? ` - ${new Date(r.check_out).toLocaleDateString()}` : ''}
                                            </td>
                                            <td style="padding: 12px 8px;">
                                                <span class="badge ${getServiceStatusBadgeClass(r.status)}">${r.status}</span>
                                            </td>
                                            <td style="padding: 12px 8px;">
                                                <select onchange="updateServiceRequestStatus(${r.id}, this.value)" class="form-input" style="padding: 0.25rem; font-size: 0.85rem; width: auto;">
                                                    <option value="pending" ${r.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                    <option value="notified" ${r.status === 'notified' ? 'selected' : ''}>Notified</option>
                                                    <option value="confirmed" ${r.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                                    <option value="completed" ${r.status === 'completed' ? 'selected' : ''}>Completed</option>
                                                    <option value="cancelled" ${r.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                                </select>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            No service requests found.
                        </p>
                    `;
                }
            } catch (error) {
                console.error('Error loading service requests:', error);
            }
        }
        
        function getServiceStatusBadgeClass(status) {
            switch(status) {
                case 'pending': return 'badge-warning';
                case 'notified': return 'badge-info';
                case 'confirmed': return 'badge-success';
                case 'completed': return 'badge-success';
                case 'cancelled': return 'badge-secondary';
                default: return 'badge-secondary';
            }
        }
        
        async function updateServiceRequestStatus(id, status) {
            try {
                const response = await fetch(`/api/admin/service-requests/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                if (!data.success) {
                    alert('Error: ' + data.error);
                    loadServiceRequests();
                }
            } catch (error) {
                alert('Error updating status: ' + error.message);
            }
        }

        // =====================================================
        // FEES FUNCTIONS
        // =====================================================
        
        let feesData = [];
        
        async function loadFees() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/admin/fees${queryString}`);
                const data = await response.json();
                
                if (data.success) {
                    feesData = data.data || [];
                    renderFees(feesData);
                }
            } catch (error) {
                console.error('Error loading fees:', error);
            }
        }
        
        function renderFees(fees) {
            const container = document.getElementById('fees-list');
            
            if (!fees || fees.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üíµ</div>
                        <h3>No Fees Configured</h3>
                        <p>Add cleaning fees, taxes, or other charges</p>
                        <button class="btn" onclick="openAddFeeModal()">Add Your First Fee</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Amount</th>
                            <th style="text-align: left; padding: 0.75rem;">Apply Per</th>
                            <th style="text-align: center; padding: 0.75rem;">Type</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const applyPerLabels = {
                'per_booking': 'Per Booking',
                'per_night': 'Per Night',
                'per_guest': 'Per Guest',
                'per_guest_per_night': 'Per Guest/Night'
            };
            
            for (const fee of fees) {
                const amountDisplay = fee.amount_type === 'percentage' 
                    ? `${fee.amount}%` 
                    : `$${parseFloat(fee.amount).toFixed(2)}`;
                    
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${fee.name}</strong>
                            ${fee.description ? `<br><small style="color: var(--text-secondary);">${fee.description}</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #d97706;">${amountDisplay}</td>
                        <td style="padding: 0.75rem; color: var(--text-secondary);">${applyPerLabels[fee.apply_per] || fee.apply_per}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${fee.is_tax ? 'badge-warning' : 'badge-secondary'}">${fee.is_tax ? 'Tax' : 'Fee'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${fee.active ? 'badge-success' : 'badge-secondary'}">${fee.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editFee(${fee.id})" style="background: none; border: none; cursor: pointer;">‚úèÔ∏è</button>
                            <button onclick="deleteFee(${fee.id})" style="background: none; border: none; cursor: pointer;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function openAddFeeModal() {
            document.getElementById('fee-form').reset();
            document.getElementById('fee-id').value = '';
            document.getElementById('fee-modal-title').innerHTML = 'üíµ Add Fee';
            document.getElementById('fee-active').checked = true;
            document.getElementById('fee-amount-prefix').textContent = '$';
            await loadFeeProperties();
            openModal('addFeeModal');
        }
        
        async function loadFeeProperties() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('fee-property');
                select.innerHTML = '<option value="">All Properties</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                document.getElementById('fee-unit').innerHTML = '<option value="">All Units</option>';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadFeeUnits() {
            const propertyId = document.getElementById('fee-property').value;
            const unitSelect = document.getElementById('fee-unit');
            
            unitSelect.innerHTML = '<option value="">All Units</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    units.forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        function toggleFeeAmountInput() {
            const type = document.getElementById('fee-amount-type').value;
            document.getElementById('fee-amount-prefix').textContent = type === 'percentage' ? '' : '$';
        }
        
        async function editFee(id) {
            const fee = feesData.find(f => f.id === id);
            if (!fee) return;
            
            document.getElementById('fee-id').value = fee.id;
            document.getElementById('fee-name').value = fee.name || '';
            document.getElementById('fee-description').value = fee.description || '';
            document.getElementById('fee-amount-type').value = fee.amount_type || 'fixed';
            document.getElementById('fee-amount').value = fee.amount || '';
            document.getElementById('fee-apply-per').value = fee.apply_per || 'per_booking';
            document.getElementById('fee-is-tax').checked = fee.is_tax;
            document.getElementById('fee-active').checked = fee.active;
            
            toggleFeeAmountInput();
            document.getElementById('fee-modal-title').innerHTML = '‚úèÔ∏è Edit Fee';
            openModal('addFeeModal');
        }
        
        async function saveFee() {
            const id = document.getElementById('fee-id').value;
            const feeData = {
                name: document.getElementById('fee-name').value,
                description: document.getElementById('fee-description').value,
                amount_type: document.getElementById('fee-amount-type').value,
                amount: parseFloat(document.getElementById('fee-amount').value),
                apply_per: document.getElementById('fee-apply-per').value,
                is_tax: document.getElementById('fee-is-tax').checked,
                active: document.getElementById('fee-active').checked
            };
            
            try {
                const url = id ? `/api/admin/fees/${id}` : '/api/admin/fees';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(feeData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addFeeModal');
                    loadFees();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving fee: ' + error.message);
            }
        }
        
        async function deleteFee(id) {
            if (!confirm('Delete this fee?')) return;
            
            try {
                const response = await fetch(`/api/admin/fees/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadFees();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting fee: ' + error.message);
            }
        }

        // =====================================================
        // TAXES FUNCTIONS
        // =====================================================
        
        let taxesData = [];
        
        async function loadTaxesPropertySelect() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('taxes-property-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading properties for taxes:', error);
            }
        }
        
        async function loadTaxesRooms() {
            const propertyId = document.getElementById('taxes-property-select')?.value;
            const roomSelect = document.getElementById('taxes-room-select');
            if (!roomSelect) return;
            
            roomSelect.innerHTML = '<option value="">All Rooms</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch(`/api/db/bookable-units?property_id=${propertyId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(r => {
                        roomSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }
        
        // =====================================================
        // PAYMENTS FUNCTIONS
        // =====================================================
        
        async function populatePropertySelect(selectId) {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                // Restore previous selection if it exists
                if (currentValue) select.value = currentValue;
            } catch (error) {
                console.error('Error loading properties for select:', error);
            }
        }
        
        async function checkStripeConnectionStatus(propertyId = null) {
            try {
                let accountId;
                
                // If property selected, get its account's Stripe status
                if (propertyId) {
                    const propResponse = await fetch(`/api/db/properties/${propertyId}`);
                    const propData = await propResponse.json();
                    if (propData.success && propData.data) {
                        accountId = propData.data.account_id;
                    }
                }
                
                // Fall back to selected account or global filter
                if (!accountId) {
                    accountId = selectedAccountId || window.currentAccountId;
                }
                
                const statusText = document.getElementById('stripe-status-text');
                const btnArea = document.getElementById('stripe-connect-btn-area');
                
                if (!accountId) {
                    statusText.innerHTML = `<span style="color: #6b7280;">Select a property to view Stripe connection status</span>`;
                    btnArea.innerHTML = '';
                    return;
                }
                
                const response = await fetch(`/api/accounts/${accountId}/stripe-status`);
                const data = await response.json();
                
                if (data.success && data.connected) {
                    statusText.innerHTML = `<span style="color: #059669;">‚úÖ Connected</span> - Stripe Account: ${data.stripe_account_id}`;
                    btnArea.innerHTML = `
                        <button class="btn btn-secondary" onclick="disconnectStripeForAccount(${accountId})">
                            Disconnect Stripe
                        </button>
                    `;
                } else {
                    statusText.innerHTML = `<span style="color: #dc2626;">‚ùå Not Connected</span> - Connect Stripe to accept payments for this property`;
                    btnArea.innerHTML = `
                        <a href="/api/stripe/connect/${accountId}" class="btn" style="background: #635bff; text-decoration: none;">
                            üîó Connect Stripe
                        </a>
                    `;
                }
            } catch (error) {
                console.error('Error checking Stripe status:', error);
            }
        }
        
        async function disconnectStripeForAccount(accountId) {
            if (!confirm('Are you sure you want to disconnect Stripe? You will not be able to accept payments until you reconnect.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/accounts/${accountId}/stripe-disconnect`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Stripe disconnected successfully');
                    const propertyId = document.getElementById('payments-property-select')?.value;
                    checkStripeConnectionStatus(propertyId || null);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error disconnecting Stripe:', error);
                alert('Error disconnecting Stripe');
            }
        }
        
        async function loadPaymentsForProperty() {
            const propertyId = document.getElementById('payments-property-select').value;
            const status = document.getElementById('payments-status-select').value;
            const dateRange = document.getElementById('payments-date-range').value;
            
            // Update Stripe status based on selected property
            checkStripeConnectionStatus(propertyId || null);
            
            try {
                // Build query params
                let url = '/api/bookings?include_payments=true';
                if (propertyId) url += `&property_id=${propertyId}`;
                if (status) url += `&payment_status=${status}`;
                if (dateRange !== 'all') {
                    const daysAgo = new Date();
                    daysAgo.setDate(daysAgo.getDate() - parseInt(dateRange));
                    url += `&from_date=${daysAgo.toISOString().split('T')[0]}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                const listEl = document.getElementById('payments-bookings-list');
                
                if (data.success && data.bookings && data.bookings.length > 0) {
                    // Calculate stats
                    let pendingCount = 0;
                    let depositsReceived = 0;
                    let balanceDue = 0;
                    let totalCollected = 0;
                    
                    data.bookings.forEach(b => {
                        const total = parseFloat(b.total_amount) || 0;
                        const deposit = parseFloat(b.deposit_amount) || 0;
                        const balance = parseFloat(b.balance_amount) || 0;
                        
                        if (b.payment_status === 'pending' || !b.payment_status) pendingCount++;
                        if (b.deposit_paid_at) depositsReceived += deposit;
                        if (!b.balance_paid_at && b.deposit_paid_at) balanceDue += (total - deposit);
                        if (b.balance_paid_at) totalCollected += total;
                        else if (b.deposit_paid_at) totalCollected += deposit;
                    });
                    
                    document.getElementById('pending-payments-count').textContent = pendingCount;
                    document.getElementById('deposits-received-amount').textContent = '¬£' + depositsReceived.toFixed(2);
                    document.getElementById('balance-due-amount').textContent = '¬£' + balanceDue.toFixed(2);
                    document.getElementById('total-collected-amount').textContent = '¬£' + totalCollected.toFixed(2);
                    
                    // Render bookings
                    listEl.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border);">
                                    <th style="text-align: left; padding: 0.75rem;">Guest</th>
                                    <th style="text-align: left; padding: 0.75rem;">Property / Room</th>
                                    <th style="text-align: left; padding: 0.75rem;">Dates</th>
                                    <th style="text-align: right; padding: 0.75rem;">Total</th>
                                    <th style="text-align: right; padding: 0.75rem;">Deposit</th>
                                    <th style="text-align: center; padding: 0.75rem;">Status</th>
                                    <th style="text-align: center; padding: 0.75rem;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.bookings.map(b => {
                                    const statusBadge = getPaymentStatusBadge(b.payment_status);
                                    const total = parseFloat(b.total_amount) || 0;
                                    const deposit = parseFloat(b.deposit_amount) || 0;
                                    return `
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <td style="padding: 0.75rem;">
                                                <strong>${b.guest_first_name || ''} ${b.guest_last_name || ''}</strong><br>
                                                <small style="color: var(--text-secondary);">${b.guest_email || ''}</small>
                                            </td>
                                            <td style="padding: 0.75rem;">
                                                ${b.property_name || 'N/A'}<br>
                                                <small style="color: var(--text-secondary);">${b.room_name || ''}</small>
                                            </td>
                                            <td style="padding: 0.75rem;">
                                                ${formatDate(b.check_in)} - ${formatDate(b.check_out)}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: right;">
                                                ¬£${total.toFixed(2)}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: right;">
                                                ¬£${deposit.toFixed(2)}
                                                ${b.deposit_paid_at ? '<br><small style="color: #059669;">‚úì Paid</small>' : ''}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center;">
                                                ${statusBadge}
                                            </td>
                                            <td style="padding: 0.75rem; text-align: center;">
                                                <button class="btn btn-small" onclick="viewPaymentDetails(${b.id})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                    View
                                                </button>
                                                ${!b.deposit_paid_at ? `
                                                    <button class="btn btn-small" onclick="sendPaymentLink(${b.id})" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: #059669;">
                                                        Send Link
                                                    </button>
                                                ` : ''}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No bookings found</p>';
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                document.getElementById('payments-bookings-list').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 2rem;">Error loading bookings</p>';
            }
        }
        
        function getPaymentStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge badge-warning">‚è≥ Pending</span>',
                'deposit_paid': '<span class="badge badge-info">üí∞ Deposit Paid</span>',
                'fully_paid': '<span class="badge badge-success">‚úÖ Fully Paid</span>',
                'refunded': '<span class="badge badge-secondary">‚Ü©Ô∏è Refunded</span>',
                'failed': '<span class="badge badge-error">‚ùå Failed</span>'
            };
            return badges[status] || '<span class="badge">‚è≥ Pending</span>';
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        async function viewPaymentDetails(bookingId) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}/payments`);
                const data = await response.json();
                
                let html = `<h3>Payment History for Booking #${bookingId}</h3>`;
                
                if (data.success && data.payments && data.payments.length > 0) {
                    html += `
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <thead>
                                <tr style="border-bottom: 2px solid var(--border);">
                                    <th style="text-align: left; padding: 0.5rem;">Date</th>
                                    <th style="text-align: left; padding: 0.5rem;">Type</th>
                                    <th style="text-align: right; padding: 0.5rem;">Amount</th>
                                    <th style="text-align: center; padding: 0.5rem;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.payments.map(p => `
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 0.5rem;">${formatDate(p.created_at)}</td>
                                        <td style="padding: 0.5rem;">${p.transaction_type}</td>
                                        <td style="padding: 0.5rem; text-align: right;">¬£${parseFloat(p.amount).toFixed(2)}</td>
                                        <td style="padding: 0.5rem; text-align: center;">${p.status}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    html += '<p style="color: var(--text-secondary); margin-top: 1rem;">No payments recorded yet.</p>';
                }
                
                // Show in a simple alert for now (could be a modal)
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div class="modal" id="payment-details-modal" style="display: flex;">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3>Payment Details</h3>
                                <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
                            </div>
                            <div class="modal-body">
                                ${html}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading payment details:', error);
                alert('Error loading payment details');
            }
        }
        
        async function sendPaymentLink(bookingId) {
            alert('Payment link feature coming soon! This will email the guest a link to pay their deposit.');
        }
        
        // =====================================================
        // DEPOSIT RULES FUNCTIONS
        // =====================================================
        
        async function loadDepositRulesForProperty() {
            const selectValue = document.getElementById('deposit-rules-property-select').value;
            const listEl = document.getElementById('deposit-rules-list');
            
            if (!selectValue) {
                listEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Select a property or "All Properties" to view deposit rules</p>';
                return;
            }
            
            try {
                let response;
                let isAccountLevel = selectValue === 'all';
                
                if (isAccountLevel) {
                    // Get account ID from current filter
                    const accountId = selectedAccountId || 1;
                    response = await fetch(`/api/accounts/${accountId}/deposit-rules`);
                } else {
                    response = await fetch(`/api/properties/${selectValue}/deposit-rules`);
                }
                
                const data = await response.json();
                
                const scopeLabel = isAccountLevel ? 'üè¢ Account Default' : 'üè† Property Specific';
                
                if (data.success && data.rules && data.rules.length > 0) {
                    listEl.innerHTML = data.rules.map(rule => `
                        <div class="card" style="margin-bottom: 1rem; border: 1px solid ${rule.is_active ? '#10b981' : '#d1d5db'}; ${rule.is_active ? 'background: #f0fdf4;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: 0.5rem;">
                                        ${rule.rule_name || 'Unnamed Rule'}
                                        ${rule.is_active ? '<span class="badge badge-success" style="margin-left: 0.5rem;">Active</span>' : '<span class="badge badge-secondary" style="margin-left: 0.5rem;">Inactive</span>'}
                                        <span class="badge" style="margin-left: 0.5rem; background: #e0e7ff; color: #3730a3;">${scopeLabel}</span>
                                    </h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                        <div>
                                            <strong style="color: var(--text-secondary); font-size: 0.85rem;">Deposit</strong><br>
                                            ${getDepositTypeDisplay(rule)}
                                        </div>
                                        <div>
                                            <strong style="color: var(--text-secondary); font-size: 0.85rem;">Balance Due</strong><br>
                                            ${rule.balance_due_days} days before check-in
                                        </div>
                                        <div>
                                            <strong style="color: var(--text-secondary); font-size: 0.85rem;">Refund Policy</strong><br>
                                            ${capitalizeFirst(rule.refund_policy || 'flexible')}
                                        </div>
                                        <div>
                                            <strong style="color: var(--text-secondary); font-size: 0.85rem;">Auto-charge Balance</strong><br>
                                            ${rule.auto_charge_balance ? '‚úÖ Yes' : '‚ùå No'}
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-small" onclick="editDepositRule(${rule.id})" style="font-size: 0.8rem;">Edit</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteDepositRule(${rule.id})" style="font-size: 0.8rem; background: #ef4444;">Delete</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    const createLabel = isAccountLevel ? 'Create Account Default Rule' : 'Create First Rule';
                    listEl.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">No deposit rules configured${isAccountLevel ? ' for this account' : ' for this property'}.</p>
                            <button class="btn" onclick="openAddDepositRuleModal()">
                                + ${createLabel}
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading deposit rules:', error);
                listEl.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 2rem;">Error loading deposit rules</p>';
            }
        }
        
        function getDepositTypeDisplay(rule) {
            switch(rule.deposit_type) {
                case 'percentage':
                    return `${rule.deposit_percentage}% of total`;
                case 'fixed':
                    return `¬£${parseFloat(rule.deposit_fixed_amount || 0).toFixed(2)} fixed`;
                case 'first_night':
                    return 'First night';
                case 'full':
                    return 'Full payment';
                default:
                    return `${rule.deposit_percentage || 30}%`;
            }
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        function openAddDepositRuleModal() {
            const selectValue = document.getElementById('deposit-rules-property-select').value;
            if (!selectValue) {
                alert('Please select a property or "All Properties" first');
                return;
            }
            
            const isAccountLevel = selectValue === 'all';
            const defaultName = isAccountLevel ? 'Account Default Deposit' : 'Standard Deposit';
            
            document.getElementById('deposit-rule-id').value = '';
            document.getElementById('deposit-rule-property-id').value = selectValue;
            document.getElementById('deposit-rule-name').value = defaultName;
            document.getElementById('deposit-type').value = 'percentage';
            document.getElementById('deposit-percentage').value = '30';
            document.getElementById('deposit-fixed-amount').value = '';
            document.getElementById('balance-due-days').value = '14';
            document.getElementById('auto-charge-balance').checked = false;
            document.getElementById('refund-policy').value = 'flexible';
            document.getElementById('deposit-rule-active').checked = true;
            
            toggleDepositTypeFields();
            openModal('depositRuleModal');
        }
        
        function toggleDepositTypeFields() {
            const type = document.getElementById('deposit-type').value;
            document.getElementById('percentage-field').style.display = (type === 'percentage') ? 'block' : 'none';
            document.getElementById('fixed-amount-field').style.display = (type === 'fixed') ? 'block' : 'none';
        }
        
        function toggleBulkDepositTypeFields() {
            const type = document.getElementById('bulk-deposit-type').value;
            document.getElementById('bulk-percentage-field').style.display = (type === 'percentage') ? 'block' : 'none';
            document.getElementById('bulk-fixed-amount-field').style.display = (type === 'fixed') ? 'block' : 'none';
        }
        
        async function openBulkDepositRuleModal() {
            const listEl = document.getElementById('bulk-property-list');
            
            // Fetch properties for current account (use selectedAccountId from filter)
            const accountId = selectedAccountId || '';
            let url = '/api/db/properties';
            if (accountId) {
                url += `?account_id=${accountId}`;
            }
            
            console.log('Fetching properties from:', url, 'selectedAccountId:', selectedAccountId);
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Properties response:', data);
                
                if (data.success && data.data && data.data.length > 0) {
                    listEl.innerHTML = data.data.map(prop => `
                        <label style="display: flex; align-items: center; padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #f3f4f6;">
                            <input type="checkbox" class="bulk-property-checkbox" value="${prop.id}" style="margin-right: 0.75rem;">
                            <span>${prop.name}</span>
                        </label>
                    `).join('');
                } else {
                    listEl.innerHTML = '<p style="color: var(--text-secondary); padding: 1rem; text-align: center;">No properties found. Try selecting an account filter first.</p>';
                }
            } catch (error) {
                console.error('Error loading properties:', error);
                listEl.innerHTML = '<p style="color: #ef4444; padding: 1rem;">Error loading properties</p>';
            }
            
            // Reset form
            document.getElementById('bulk-deposit-rule-name').value = 'Standard Deposit';
            document.getElementById('bulk-deposit-type').value = 'percentage';
            document.getElementById('bulk-deposit-percentage').value = '30';
            document.getElementById('bulk-deposit-fixed-amount').value = '';
            document.getElementById('bulk-balance-due-days').value = '14';
            document.getElementById('bulk-refund-policy').value = 'flexible';
            toggleBulkDepositTypeFields();
            
            openModal('bulkDepositRuleModal');
        }
        
        function selectAllBulkProperties() {
            document.querySelectorAll('.bulk-property-checkbox').forEach(cb => cb.checked = true);
        }
        
        function deselectAllBulkProperties() {
            document.querySelectorAll('.bulk-property-checkbox').forEach(cb => cb.checked = false);
        }
        
        async function saveBulkDepositRule() {
            const selectedProperties = Array.from(document.querySelectorAll('.bulk-property-checkbox:checked')).map(cb => cb.value);
            
            if (selectedProperties.length === 0) {
                alert('Please select at least one property');
                return;
            }
            
            const data = {
                rule_name: document.getElementById('bulk-deposit-rule-name').value,
                deposit_type: document.getElementById('bulk-deposit-type').value,
                deposit_percentage: parseFloat(document.getElementById('bulk-deposit-percentage').value) || 30,
                deposit_fixed_amount: parseFloat(document.getElementById('bulk-deposit-fixed-amount').value) || null,
                balance_due_days: parseInt(document.getElementById('bulk-balance-due-days').value) || 14,
                refund_policy: document.getElementById('bulk-refund-policy').value,
                is_active: true
            };
            
            let successCount = 0;
            let failCount = 0;
            
            for (const propertyId of selectedProperties) {
                try {
                    const response = await fetch(`/api/properties/${propertyId}/deposit-rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
            }
            
            closeModal('bulkDepositRuleModal');
            
            if (failCount === 0) {
                alert(`‚úÖ Deposit rule applied to ${successCount} properties!`);
            } else {
                alert(`Applied to ${successCount} properties, ${failCount} failed.`);
            }
            
            loadDepositRulesForProperty();
        }
        
        async function editDepositRule(ruleId) {
            try {
                const response = await fetch(`/api/deposit-rules/${ruleId}`);
                const data = await response.json();
                
                if (data.success && data.rule) {
                    const rule = data.rule;
                    document.getElementById('deposit-rule-id').value = rule.id;
                    document.getElementById('deposit-rule-property-id').value = rule.property_id;
                    document.getElementById('deposit-rule-name').value = rule.rule_name || '';
                    document.getElementById('deposit-type').value = rule.deposit_type || 'percentage';
                    document.getElementById('deposit-percentage').value = rule.deposit_percentage || 30;
                    document.getElementById('deposit-fixed-amount').value = rule.deposit_fixed_amount || '';
                    document.getElementById('balance-due-days').value = rule.balance_due_days || 14;
                    document.getElementById('auto-charge-balance').checked = rule.auto_charge_balance || false;
                    document.getElementById('refund-policy').value = rule.refund_policy || 'flexible';
                    document.getElementById('deposit-rule-active').checked = rule.is_active !== false;
                    
                    toggleDepositTypeFields();
                    openModal('depositRuleModal');
                }
            } catch (error) {
                console.error('Error loading deposit rule:', error);
                alert('Error loading deposit rule');
            }
        }
        
        async function saveDepositRule() {
            const ruleId = document.getElementById('deposit-rule-id').value;
            const selectValue = document.getElementById('deposit-rule-property-id').value;
            const isAccountLevel = selectValue === 'all';
            
            const data = {
                rule_name: document.getElementById('deposit-rule-name').value,
                deposit_type: document.getElementById('deposit-type').value,
                deposit_percentage: parseFloat(document.getElementById('deposit-percentage').value) || 30,
                deposit_fixed_amount: parseFloat(document.getElementById('deposit-fixed-amount').value) || null,
                balance_due_days: parseInt(document.getElementById('balance-due-days').value) || 14,
                auto_charge_balance: document.getElementById('auto-charge-balance').checked,
                refund_policy: document.getElementById('refund-policy').value,
                is_active: document.getElementById('deposit-rule-active').checked
            };
            
            try {
                let response;
                if (ruleId) {
                    response = await fetch(`/api/deposit-rules/${ruleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                } else if (isAccountLevel) {
                    const accountId = selectedAccountId || 1;
                    response = await fetch(`/api/accounts/${accountId}/deposit-rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`/api/properties/${selectValue}/deposit-rules`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(data)
                    });
                }
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('depositRuleModal');
                    loadDepositRulesForProperty();
                    alert('Deposit rule saved successfully!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving deposit rule:', error);
                alert('Error saving deposit rule');
            }
        }
        
        async function deleteDepositRule(ruleId) {
            if (!confirm('Are you sure you want to delete this deposit rule?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/deposit-rules/${ruleId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    loadDepositRulesForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting deposit rule:', error);
                alert('Error deleting deposit rule');
            }
        }
        
        // Initialize payments view
        function initPaymentsView() {
            populatePropertySelect('payments-property-select');
            loadPaymentsForProperty();
        }
        
        // Initialize deposit rules view
        function initDepositRulesView() {
            populatePropertySelect('deposit-rules-property-select');
        }

        async function loadTaxesForProperty() {
            const propertyId = document.getElementById('taxes-property-select')?.value;
            const roomId = document.getElementById('taxes-room-select')?.value;
            
            // Also load rooms when property changes
            if (!roomId) {
                await loadTaxesRooms();
            }
            
            if (!propertyId) {
                document.getElementById('taxes-list').innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        Select a property to view and manage taxes
                    </p>
                `;
                return;
            }
            
            try {
                // Just pass property_id - server handles the rest
                const response = await fetch(`/api/admin/taxes?property_id=${propertyId}${roomId ? '&room_id=' + roomId : ''}`);
                const data = await response.json();
                
                if (data.success) {
                    taxesData = data.data || [];
                    renderTaxes(taxesData);
                }
            } catch (error) {
                console.error('Error loading taxes:', error);
            }
        }
        
        async function loadTaxes() {
            // Load property selector first
            await loadTaxesPropertySelect();
            
            // Show message to select property
            document.getElementById('taxes-list').innerHTML = `
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                    Select a property to view and manage taxes
                </p>
            `;
        }
        
        function renderTaxes(taxes) {
            const container = document.getElementById('taxes-list');
            const propertyId = document.getElementById('taxes-property-select')?.value;
            
            if (!propertyId) {
                container.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        Select a property to view and manage taxes
                    </p>
                `;
                return;
            }
            
            if (!taxes || taxes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üèõÔ∏è</div>
                        <h3>No Taxes Configured</h3>
                        <p>Add tourist taxes for this property</p>
                        <button class="btn" onclick="openAddTaxModal()">Add Your First Tax</button>
                    </div>
                `;
                return;
            }
            
            const chargePerLabels = {
                'per_person_per_night': 'Per Person/Night',
                'per_room_per_night': 'Per Room/Night',
                'per_booking': 'Per Booking',
                'percentage': '% of Booking'
            };
            
            let html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border);">
                            <th style="text-align: left; padding: 0.75rem;">Name</th>
                            <th style="text-align: left; padding: 0.75rem;">Country</th>
                            <th style="text-align: left; padding: 0.75rem;">Amount</th>
                            <th style="text-align: left; padding: 0.75rem;">Charged</th>
                            <th style="text-align: center; padding: 0.75rem;">Status</th>
                            <th style="text-align: right; padding: 0.75rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (const tax of taxes) {
                const currencySymbols = { EUR: '‚Ç¨', USD: '$', GBP: '¬£', CHF: 'CHF', AED: 'AED', JPY: '¬•' };
                const symbol = currencySymbols[tax.currency] || tax.currency || '‚Ç¨';
                const amountDisplay = tax.amount_type === 'percentage' 
                    ? `${tax.amount}%` 
                    : `${symbol}${parseFloat(tax.amount).toFixed(2)}`;
                    
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">
                            <strong>${tax.name}</strong>
                            ${tax.max_nights ? `<br><small style="color: var(--text-secondary);">Max ${tax.max_nights} nights</small>` : ''}
                        </td>
                        <td style="padding: 0.75rem;">${tax.country || '-'}</td>
                        <td style="padding: 0.75rem; font-weight: 600; color: #4f46e5;">${amountDisplay}</td>
                        <td style="padding: 0.75rem; color: var(--text-secondary);">${chargePerLabels[tax.charge_per] || tax.charge_per}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span class="badge ${tax.active ? 'badge-success' : 'badge-secondary'}">${tax.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td style="padding: 0.75rem; text-align: right;">
                            <button onclick="editTax(${tax.id})" style="background: none; border: none; cursor: pointer;">‚úèÔ∏è</button>
                            <button onclick="deleteTax(${tax.id})" style="background: none; border: none; cursor: pointer;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function openAddTaxModal() {
            document.getElementById('tax-form').reset();
            document.getElementById('tax-id').value = '';
            document.getElementById('tax-modal-title').innerHTML = 'üèõÔ∏è Add Tourist Tax';
            document.getElementById('tax-active').checked = true;
            
            // Pre-select the property from the page filter
            const selectedProperty = document.getElementById('taxes-property-select')?.value;
            
            // Hide the master-only account field - we use property selector instead
            document.querySelectorAll('.master-only-field').forEach(el => el.style.display = 'none');
            
            await loadTaxPropertiesForModal();
            
            // Pre-select the property if one was selected on page
            if (selectedProperty) {
                document.getElementById('tax-property').value = selectedProperty;
                await loadTaxUnits();
            }
            
            openModal('addTaxModal');
        }
        
        async function loadTaxPropertiesForModal() {
            try {
                const queryString = buildQueryString();
                const response = await fetch(`/api/db/properties${queryString}`);
                const data = await response.json();
                
                const select = document.getElementById('tax-property');
                select.innerHTML = '<option value="">Select Property...</option>';
                
                if (data.success && data.data) {
                    data.data.forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                    });
                }
                
                document.getElementById('tax-unit').innerHTML = '<option value="">All Units</option>';
            } catch (error) {
                console.error('Error loading properties:', error);
            }
        }
        
        async function loadTaxUnits() {
            const propertyId = document.getElementById('tax-property').value;
            const unitSelect = document.getElementById('tax-unit');
            
            unitSelect.innerHTML = '<option value="">All Units</option>';
            
            if (!propertyId) return;
            
            try {
                const response = await fetch('/api/db/bookable-units');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const units = data.data.filter(r => r.property_id == propertyId);
                    units.forEach(unit => {
                        unitSelect.innerHTML += `<option value="${unit.id}">${unit.name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading units:', error);
            }
        }
        
        function toggleTaxAmountInput() {
            const type = document.getElementById('tax-amount-type').value;
            const currencySelect = document.getElementById('tax-currency');
            if (type === 'percentage') {
                currencySelect.style.display = 'none';
            } else {
                currencySelect.style.display = 'block';
            }
        }
        
        function updateTaxPresets() {
            const country = document.getElementById('tax-country').value;
            const presets = {
                'FR': { name: 'Taxe de S√©jour', currency: 'EUR', chargePer: 'per_person_per_night' },
                'IT': { name: 'Imposta di Soggiorno', currency: 'EUR', chargePer: 'per_person_per_night' },
                'ES': { name: 'Tasa Tur√≠stica', currency: 'EUR', chargePer: 'per_person_per_night' },
                'NL': { name: 'Toeristenbelasting', currency: 'EUR', chargePer: 'percentage' },
                'DE': { name: 'City Tax', currency: 'EUR', chargePer: 'per_person_per_night' },
                'AT': { name: 'Ortstaxe', currency: 'EUR', chargePer: 'per_person_per_night' },
                'PT': { name: 'Taxa Tur√≠stica', currency: 'EUR', chargePer: 'per_person_per_night' },
                'CH': { name: 'Kurtaxe', currency: 'CHF', chargePer: 'per_person_per_night' },
                'US': { name: 'Occupancy Tax', currency: 'USD', chargePer: 'percentage' },
                'AE': { name: 'Tourism Dirham', currency: 'AED', chargePer: 'per_room_per_night' },
                'JP': { name: 'Accommodation Tax', currency: 'JPY', chargePer: 'per_person_per_night' }
            };
            
            if (presets[country]) {
                document.getElementById('tax-name').value = presets[country].name;
                document.getElementById('tax-currency').value = presets[country].currency;
                document.getElementById('tax-charge-per').value = presets[country].chargePer;
            }
        }
        
        async function editTax(id) {
            const tax = taxesData.find(t => t.id === id);
            if (!tax) return;
            
            // Hide master-only fields - we use page property selector
            document.querySelectorAll('.master-only-field').forEach(el => el.style.display = 'none');
            
            // Load properties for modal
            await loadTaxPropertiesForModal();
            
            document.getElementById('tax-id').value = tax.id;
            document.getElementById('tax-name').value = tax.name || '';
            document.getElementById('tax-country').value = normalizeCountryCode(tax.country) || '';
            document.getElementById('tax-amount-type').value = tax.amount_type || 'fixed';
            document.getElementById('tax-currency').value = tax.currency || 'EUR';
            document.getElementById('tax-amount').value = tax.amount || '';
            document.getElementById('tax-charge-per').value = tax.charge_per || 'per_person_per_night';
            document.getElementById('tax-max-nights').value = tax.max_nights || '';
            document.getElementById('tax-min-age').value = tax.min_age || '';
            document.getElementById('tax-star-tier').value = tax.star_tier || '';
            document.getElementById('tax-season-start').value = tax.season_start || '';
            document.getElementById('tax-season-end').value = tax.season_end || '';
            document.getElementById('tax-active').checked = tax.active;
            
            // Set property and load units
            if (tax.property_id) {
                document.getElementById('tax-property').value = tax.property_id;
                await loadTaxUnits();
                if (tax.room_id) {
                    document.getElementById('tax-unit').value = tax.room_id;
                }
            }
            
            toggleTaxAmountInput();
            document.getElementById('tax-modal-title').innerHTML = '‚úèÔ∏è Edit Tax';
            openModal('addTaxModal');
        }
        
        async function saveTax() {
            const id = document.getElementById('tax-id').value;
            
            // Get account_id from current account
            const accountId = currentAccount?.id;
            
            const taxData = {
                name: document.getElementById('tax-name').value,
                country: document.getElementById('tax-country').value || null,
                amount_type: document.getElementById('tax-amount-type').value,
                currency: document.getElementById('tax-currency').value,
                amount: parseFloat(document.getElementById('tax-amount').value),
                charge_per: document.getElementById('tax-charge-per').value,
                max_nights: parseInt(document.getElementById('tax-max-nights').value) || null,
                min_age: parseInt(document.getElementById('tax-min-age').value) || null,
                star_tier: document.getElementById('tax-star-tier').value || null,
                season_start: document.getElementById('tax-season-start').value || null,
                season_end: document.getElementById('tax-season-end').value || null,
                property_id: document.getElementById('tax-property').value || null,
                room_id: document.getElementById('tax-unit').value || null,
                active: document.getElementById('tax-active').checked,
                account_id: accountId
            };
            
            try {
                const url = id ? `/api/admin/taxes/${id}` : '/api/admin/taxes';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(taxData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('addTaxModal');
                    loadTaxesForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error saving tax: ' + error.message);
            }
        }
        
        async function deleteTax(id) {
            if (!confirm('Delete this tax?')) return;
            
            try {
                const response = await fetch(`/api/admin/taxes/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    loadTaxesForProperty();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting tax: ' + error.message);
            }
        }

        // Property map instance
        let propertyMap = null;
        let propertyMarker = null;

        async function editProperty(id) {
            try {
                const response = await fetch(`/api/db/properties/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const prop = data.data;
                    document.getElementById('edit-property-id').value = prop.id;
                    document.getElementById('edit-property-name').value = prop.name || '';
                    document.getElementById('edit-property-type').value = prop.property_type || 'hotel';
                    document.getElementById('edit-property-address').value = prop.address || '';
                    document.getElementById('edit-property-city').value = prop.city || '';
                    document.getElementById('edit-property-district').value = prop.district || '';
                    document.getElementById('edit-property-state').value = prop.state || '';
                    document.getElementById('edit-property-zipcode').value = prop.zip_code || '';
                    document.getElementById('edit-property-country').value = normalizeCountryCode(prop.country) || '';
                    document.getElementById('edit-property-latitude').value = prop.latitude || '';
                    document.getElementById('edit-property-longitude').value = prop.longitude || '';
                    document.getElementById('edit-property-status').value = prop.status || 'active';
                    
                    // Reset map state
                    document.getElementById('property-map-preview').style.display = 'none';
                    document.getElementById('toggle-map-btn').textContent = 'üó∫Ô∏è Show Map';
                    propertyMap = null;
                    propertyMarker = null;
                    
                    openModal('editPropertyModal');
                }
            } catch (error) {
                console.error('Error loading property:', error);
                alert('Error loading property details');
            }
        }

        async function saveProperty(e) {
            e.preventDefault();
            const id = document.getElementById('edit-property-id').value;
            const data = {
                name: document.getElementById('edit-property-name').value,
                property_type: document.getElementById('edit-property-type').value,
                address: document.getElementById('edit-property-address').value,
                city: document.getElementById('edit-property-city').value,
                district: document.getElementById('edit-property-district').value,
                state: document.getElementById('edit-property-state').value,
                zip_code: document.getElementById('edit-property-zipcode').value,
                country: document.getElementById('edit-property-country').value,
                latitude: document.getElementById('edit-property-latitude').value ? parseFloat(document.getElementById('edit-property-latitude').value) : null,
                longitude: document.getElementById('edit-property-longitude').value ? parseFloat(document.getElementById('edit-property-longitude').value) : null,
                status: document.getElementById('edit-property-status').value
            };
            
            try {
                const response = await fetch(`/api/db/properties/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Property updated successfully!');
                    closeModal('editPropertyModal');
                    loadProperties();
                } else {
                    alert('Error updating property: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving property:', error);
                alert('Error saving property');
            }
            
            return false;
        }

        async function geocodePropertyAddress() {
            const address = document.getElementById('edit-property-address').value;
            const city = document.getElementById('edit-property-city').value;
            const state = document.getElementById('edit-property-state').value;
            const zipcode = document.getElementById('edit-property-zipcode').value;
            const country = document.getElementById('edit-property-country').value;
            
            const fullAddress = [address, city, state, zipcode, country].filter(Boolean).join(', ');
            
            if (!fullAddress) {
                alert('Please enter an address first');
                return;
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`, {
                    headers: { 'User-Agent': 'GAS-Admin/1.0' }
                });
                
                const results = await response.json();
                
                if (results && results.length > 0) {
                    const lat = parseFloat(results[0].lat).toFixed(7);
                    const lon = parseFloat(results[0].lon).toFixed(7);
                    
                    document.getElementById('edit-property-latitude').value = lat;
                    document.getElementById('edit-property-longitude').value = lon;
                    
                    if (propertyMap) {
                        updatePropertyMapMarker(lat, lon);
                    }
                    
                    alert(`‚úÖ Coordinates found!\n\nLatitude: ${lat}\nLongitude: ${lon}`);
                } else {
                    alert('Could not find coordinates for this address. Try being more specific or enter coordinates manually.');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error looking up address. Please enter coordinates manually.');
            }
        }

        function togglePropertyMap() {
            const mapPreview = document.getElementById('property-map-preview');
            const btn = document.getElementById('toggle-map-btn');
            
            if (mapPreview.style.display === 'none') {
                mapPreview.style.display = 'block';
                btn.textContent = 'üó∫Ô∏è Hide Map';
                if (!propertyMap) {
                    initPropertyMap();
                }
            } else {
                mapPreview.style.display = 'none';
                btn.textContent = 'üó∫Ô∏è Show Map';
            }
        }

        function initPropertyMap() {
            if (!document.getElementById('leaflet-css')) {
                const link = document.createElement('link');
                link.id = 'leaflet-css';
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(link);
            }
            
            if (typeof L === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.onload = () => createPropertyMap();
                document.head.appendChild(script);
            } else {
                createPropertyMap();
            }
        }

        function createPropertyMap() {
            const lat = parseFloat(document.getElementById('edit-property-latitude').value) || 51.5074;
            const lon = parseFloat(document.getElementById('edit-property-longitude').value) || -0.1278;
            
            propertyMap = L.map('property-map-container').setView([lat, lon], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(propertyMap);
            
            if (document.getElementById('edit-property-latitude').value) {
                propertyMarker = L.marker([lat, lon], { draggable: true }).addTo(propertyMap);
                propertyMarker.on('dragend', function(e) {
                    const pos = e.target.getLatLng();
                    document.getElementById('edit-property-latitude').value = pos.lat.toFixed(7);
                    document.getElementById('edit-property-longitude').value = pos.lng.toFixed(7);
                });
            }
            
            propertyMap.on('click', function(e) {
                document.getElementById('edit-property-latitude').value = e.latlng.lat.toFixed(7);
                document.getElementById('edit-property-longitude').value = e.latlng.lng.toFixed(7);
                
                if (propertyMarker) {
                    propertyMarker.setLatLng(e.latlng);
                } else {
                    propertyMarker = L.marker(e.latlng, { draggable: true }).addTo(propertyMap);
                    propertyMarker.on('dragend', function(ev) {
                        const pos = ev.target.getLatLng();
                        document.getElementById('edit-property-latitude').value = pos.lat.toFixed(7);
                        document.getElementById('edit-property-longitude').value = pos.lng.toFixed(7);
                    });
                }
            });
            
            setTimeout(() => propertyMap.invalidateSize(), 100);
        }

        function updatePropertyMapMarker(lat, lon) {
            if (propertyMap) {
                propertyMap.setView([lat, lon], 15);
                if (propertyMarker) {
                    propertyMarker.setLatLng([lat, lon]);
                } else {
                    propertyMarker = L.marker([lat, lon], { draggable: true }).addTo(propertyMap);
                    propertyMarker.on('dragend', function(e) {
                        const pos = e.target.getLatLng();
                        document.getElementById('edit-property-latitude').value = pos.lat.toFixed(7);
                        document.getElementById('edit-property-longitude').value = pos.lng.toFixed(7);
                    });
                }
            }
        }

        async function deleteProperty() {
            const id = document.getElementById('edit-property-id').value;
            const name = document.getElementById('edit-property-name').value;
            
            if (!confirm(`Are you sure you want to delete "${name}"?\n\nThis will also delete all rooms, images, and related data.\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/db/properties/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Property deleted successfully!');
                    closeModal('editPropertyModal');
                    loadProperties();
                    loadDashboard(); // Refresh stats
                } else {
                    alert('Error deleting property: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting property:', error);
                alert('Error deleting property');
            }
        }

        async function editRoom(id) {
            try {
                const response = await fetch(`/api/admin/units/${id}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const room = data.data;
                    document.getElementById('edit-room-id').value = room.id;
                    
                    // CM Data (read-only display)
                    document.getElementById('edit-room-name').value = room.name || '';
                    
                    // Display name - handle JSON format {en: "name"}
                    let displayName = room.display_name || '';
                    if (typeof displayName === 'object' && displayName !== null) {
                        displayName = displayName.en || '';
                    } else if (typeof displayName === 'string' && displayName.startsWith('{')) {
                        try { displayName = JSON.parse(displayName).en || displayName; } catch(e) {}
                    }
                    document.getElementById('edit-room-display-name').value = displayName;
                    
                    // Short description - handle JSON format
                    let shortDesc = room.short_description || '';
                    if (typeof shortDesc === 'object' && shortDesc !== null) {
                        shortDesc = shortDesc.en || '';
                    } else if (typeof shortDesc === 'string' && shortDesc.startsWith('{')) {
                        try { shortDesc = JSON.parse(shortDesc).en || shortDesc; } catch(e) {}
                    }
                    document.getElementById('edit-room-short-description').value = shortDesc;
                    
                    // Full description - handle JSON format
                    let fullDesc = room.full_description || '';
                    if (typeof fullDesc === 'object' && fullDesc !== null) {
                        fullDesc = fullDesc.en || '';
                    } else if (typeof fullDesc === 'string' && fullDesc.startsWith('{')) {
                        try { fullDesc = JSON.parse(fullDesc).en || fullDesc; } catch(e) {}
                    }
                    document.getElementById('edit-room-full-description').value = fullDesc;
                    
                    // Editable fields
                    document.getElementById('edit-room-type').value = room.unit_type || 'double';
                    document.getElementById('edit-room-maxguests').value = room.max_guests || 2;
                    document.getElementById('edit-room-maxadults').value = room.max_adults || 2;
                    document.getElementById('edit-room-maxchildren').value = room.max_children || 0;
                    
                    // GAS Controls
                    document.getElementById('edit-room-quantity').value = room.quantity || 1;
                    document.getElementById('edit-room-status').value = room.status || 'available';
                    
                    openModal('editRoomModal');
                }
            } catch (error) {
                console.error('Error loading room:', error);
                alert('Error loading room details');
            }
        }
        
        function getAmenityName(a) {
            if (typeof a.amenity_name === 'string') {
                if (a.amenity_name.startsWith('{')) {
                    try { return JSON.parse(a.amenity_name).en || a.amenity_code; } catch(e) { return a.amenity_code; }
                }
                return a.amenity_name;
            }
            return a.amenity_name?.en || a.amenity_code;
        }

        async function saveRoom(e) {
            e.preventDefault();
            const id = document.getElementById('edit-room-id').value;
            
            // Get all editable fields including descriptions
            const data = {
                display_name: document.getElementById('edit-room-display-name').value || null,
                short_description: document.getElementById('edit-room-short-description').value || null,
                full_description: document.getElementById('edit-room-full-description').value || null,
                room_type: document.getElementById('edit-room-type').value,
                max_guests: parseInt(document.getElementById('edit-room-maxguests').value) || 2,
                max_adults: parseInt(document.getElementById('edit-room-maxadults').value) || 2,
                max_children: parseInt(document.getElementById('edit-room-maxchildren').value) || 0,
                quantity: document.getElementById('edit-room-quantity').value || 1,
                status: document.getElementById('edit-room-status').value
            };
            
            try {
                // Update room fields
                const response = await fetch(`/api/admin/units/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('Room updated successfully!', 'success');
                    closeModal('editRoomModal');
                    loadRoomsForProperty();
                } else {
                    alert('Error updating room: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving room:', error);
                alert('Error saving room');
            }
            
            return false;
        }
        
        async function generateRoomDescription(type) {
            const roomId = document.getElementById('edit-room-id').value;
            const roomName = document.getElementById('edit-room-name').value;
            const prompt = document.getElementById('edit-room-ai-prompt').value;
            
            if (!roomId) return alert('No room selected');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: type === 'short' ? 'room_short' : 'room_full',
                        room_id: roomId,
                        room_name: roomName,
                        prompt 
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    if (type === 'short') {
                        document.getElementById('edit-room-short-desc').value = result.content;
                    } else {
                        document.getElementById('edit-room-full-desc').value = result.content;
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating content');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generateRoomDisplayName() {
            const roomId = document.getElementById('edit-room-id').value;
            const originalName = document.getElementById('edit-room-name').value;
            const roomType = document.getElementById('edit-room-type').value;
            const maxGuests = document.getElementById('edit-room-maxguests').value;
            
            if (!originalName) return alert('No room name to work with');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: 'room_display_name',
                        room_id: roomId,
                        original_name: originalName,
                        room_type: roomType,
                        max_guests: maxGuests
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('edit-room-display-name').value = result.content;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating display name');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generateRoomShortDescription() {
            const roomId = document.getElementById('edit-room-id').value;
            const roomName = document.getElementById('edit-room-name').value;
            const displayName = document.getElementById('edit-room-display-name').value;
            const roomType = document.getElementById('edit-room-type').value;
            const maxGuests = document.getElementById('edit-room-maxguests').value;
            
            if (!roomName) return alert('No room name to work with');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: 'room_short_description',
                        room_id: roomId,
                        room_name: displayName || roomName,
                        room_type: roomType,
                        max_guests: maxGuests
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('edit-room-short-description').value = result.content;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating short description');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generateRoomFullDescription() {
            const roomId = document.getElementById('edit-room-id').value;
            const roomName = document.getElementById('edit-room-name').value;
            const displayName = document.getElementById('edit-room-display-name').value;
            const shortDesc = document.getElementById('edit-room-short-description').value;
            const roomType = document.getElementById('edit-room-type').value;
            const maxGuests = document.getElementById('edit-room-maxguests').value;
            
            if (!roomName) return alert('No room name to work with');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: 'room_full_description',
                        room_id: roomId,
                        room_name: displayName || roomName,
                        short_description: shortDesc,
                        room_type: roomType,
                        max_guests: maxGuests
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    document.getElementById('edit-room-full-description').value = result.content;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating full description');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function generatePropertyDescription(type) {
            const propertyId = document.getElementById('edit-property-id').value;
            const propertyName = document.getElementById('edit-property-name').value;
            const prompt = document.getElementById('edit-property-ai-prompt').value;
            
            if (!propertyId) return alert('No property selected');
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Generating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ 
                        type: type === 'short' ? 'property_short' : 'property_description',
                        property_id: propertyId,
                        property_name: propertyName,
                        prompt 
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    if (type === 'short') {
                        document.getElementById('edit-property-short-desc').value = result.content;
                    } else {
                        document.getElementById('edit-property-full-desc').value = result.content;
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('Error generating content');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.select();
                document.execCommand('copy');
                
                // Show brief feedback
                const btn = event.target;
                const original = btn.innerHTML;
                btn.innerHTML = '‚úì';
                setTimeout(() => btn.innerHTML = original, 1000);
            }
        }

        async function deleteRoom() {
            const id = document.getElementById('edit-room-id').value;
            const name = document.getElementById('edit-room-name').value;
            
            if (!confirm(`Are you sure you want to delete "${name}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/units/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Room deleted successfully!');
                    closeModal('editRoomModal');
                    loadRoomsForProperty();
                    loadDashboard(); // Refresh stats
                } else {
                    alert('Error deleting room: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting room:', error);
                alert('Error deleting room');
            }
        }

        // Placeholder functions for other modals
        function openAddRoomModal() {
            alert('Add Room feature coming soon!');
        }

        function openUploadModal() {
            openImageUploadModal();
        }

        // Toggle upsell presets visibility
        function toggleUpsellPresets() {
            const presets = document.getElementById('all-upsell-presets');
            const btn = document.getElementById('toggle-presets-btn');
            
            if (presets.style.display === 'none') {
                presets.style.display = 'block';
                btn.textContent = 'Hide Categories ‚ñ≤';
            } else {
                presets.style.display = 'none';
                btn.textContent = 'Show All Categories ‚ñº';
            }
        }
        
        // Quick add upsell from preset - opens modal pre-filled
        async function quickAddUpsell(name, price, chargeType) {
            // Reset form first
            document.getElementById('upsell-form').reset();
            document.getElementById('upsell-id').value = '';
            document.getElementById('upsell-multi-room').checked = false;
            document.getElementById('upsell-rooms-checkboxes').style.display = 'none';
            document.getElementById('upsell-room').style.display = 'block';
            
            // Pre-fill with preset values
            document.getElementById('upsell-name').value = name;
            document.getElementById('upsell-price').value = price;
            document.getElementById('upsell-charge-type').value = chargeType;
            document.getElementById('upsell-active').checked = true;
            
            // Load properties
            await loadUpsellPropertiesForModal();
            
            // Update modal title to show it's from preset
            document.getElementById('upsell-modal-title').innerHTML = 'üéÅ Add: ' + name;
            
            openModal('addUpsellModal');
        }

        // Cleanup duplicates
        async function cleanupDuplicates() {
            if (!confirm('This will remove duplicate properties and rooms, keeping only the most recent imports. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/cleanup-duplicates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úì Duplicates removed!\n\nProperties: ' + result.counts.properties + '\nRooms: ' + result.counts.units);
                    loadDashboard();
                    if (document.getElementById('properties').classList.contains('active')) {
                        loadProperties();
                    }
                    if (document.getElementById('rooms').classList.contains('active')) {
                        loadRooms();
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error cleaning up: ' + error.message);
            }
        }

        // =====================================================
        // WEBSITE PAGES FUNCTIONS
        // =====================================================
        
        let currentPageType = 'about';
        
        const pageTemplates = {
            about: {
                title: 'About Us',
                prompts: ['history', 'team', 'values', 'mission']
            },
            contact: {
                title: 'Contact Us',
                prompts: ['location', 'hours', 'directions']
            },
            terms: {
                title: 'Terms & Conditions',
                prompts: ['booking', 'cancellation', 'liability', 'payment']
            },
            privacy: {
                title: 'Privacy Policy',
                prompts: ['data collection', 'cookies', 'GDPR', 'rights']
            }
        };

        async function loadWebsitePage(pageType) {
            currentPageType = pageType;
            document.getElementById('page-type').value = pageType;
            
            // Update tab buttons
            ['about', 'contact', 'terms', 'privacy'].forEach(type => {
                const btn = document.getElementById('page-tab-' + type);
                if (btn) {
                    btn.style.background = type === pageType ? 'var(--accent)' : '#64748b';
                }
            });
            
            // Update AI panel badge
            const badge = document.getElementById('page-ai-badge');
            if (badge) {
                const titles = { about: 'About Us', contact: 'Contact', terms: 'Terms & Conditions', privacy: 'Privacy Policy' };
                badge.textContent = titles[pageType] || pageType;
            }
            
            // Update AI context placeholder based on page type
            const contextInput = document.getElementById('page-ai-context');
            if (contextInput) {
                const placeholders = {
                    about: "Tell us about your property... e.g. 'Victorian B&B in St Louis, family-run since 1995, known for gourmet breakfasts'",
                    contact: "Your business details... e.g. 'Open 7 days, check-in from 3pm, located downtown near metro'",
                    terms: "Your booking policies... e.g. '48-hour cancellation, no smoking, pets welcome with fee, 18+ only'",
                    privacy: "Your data practices... e.g. 'We collect booking info, use Stripe for payments, based in USA'"
                };
                contextInput.placeholder = placeholders[pageType] || placeholders.about;
            }
            
            try {
                const response = await fetch(`/api/admin/pages/${pageType}?client_id=${getClientId()}`);
                const data = await response.json();
                
                if (data.success && data.page) {
                    document.getElementById('page-title').value = data.page.title || '';
                    document.getElementById('page-subtitle').value = data.page.subtitle || '';
                    document.getElementById('page-content').value = data.page.content || '';
                    document.getElementById('page-meta-title').value = data.page.meta_title || '';
                    document.getElementById('page-meta-description').value = data.page.meta_description || '';
                    document.getElementById('page-published').checked = data.page.is_published;
                    document.getElementById('page-faq-schema').value = data.page.faq_schema || '';
                    updateMetaCount();
                    updateFAQPreview();
                } else {
                    // Clear form for new page
                    const defaultTitles = { about: 'About Us', contact: 'Contact Us', terms: 'Terms & Conditions', privacy: 'Privacy Policy' };
                    document.getElementById('page-title').value = defaultTitles[pageType] || '';
                    document.getElementById('page-subtitle').value = '';
                    document.getElementById('page-content').value = '';
                    document.getElementById('page-meta-title').value = '';
                    document.getElementById('page-meta-description').value = '';
                    document.getElementById('page-published').checked = false;
                    document.getElementById('page-faq-schema').value = '';
                    updateMetaCount();
                    document.getElementById('faq-schema-preview').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading page:', error);
            }
        }
        
        function updateMetaCount() {
            const title = document.getElementById('page-meta-title').value;
            const desc = document.getElementById('page-meta-description').value;
            
            const titleCount = document.getElementById('meta-title-count');
            const descCount = document.getElementById('meta-desc-count');
            
            if (titleCount) {
                titleCount.textContent = `(${title.length}/60)`;
                titleCount.style.color = title.length > 60 ? '#ef4444' : title.length > 50 ? '#f59e0b' : 'var(--text-muted)';
            }
            if (descCount) {
                descCount.textContent = `(${desc.length}/160)`;
                descCount.style.color = desc.length > 160 ? '#ef4444' : desc.length > 150 ? '#f59e0b' : 'var(--text-muted)';
            }
        }
        
        function updateFAQPreview() {
            const schemaText = document.getElementById('page-faq-schema').value;
            const preview = document.getElementById('faq-schema-preview');
            const list = document.getElementById('faq-items-list');
            
            if (!schemaText || schemaText.trim() === '') {
                preview.style.display = 'none';
                return;
            }
            
            try {
                const faqs = JSON.parse(schemaText);
                if (Array.isArray(faqs) && faqs.length > 0) {
                    list.innerHTML = faqs.map((faq, i) => `
                        <div style="padding: 0.5rem 0; ${i > 0 ? 'border-top: 1px solid #e2e8f0;' : ''}">
                            <div style="font-weight: 600; font-size: 0.85rem; color: #1e293b;">Q: ${faq.question}</div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">A: ${faq.answer?.substring(0, 100)}${faq.answer?.length > 100 ? '...' : ''}</div>
                        </div>
                    `).join('');
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            } catch (e) {
                preview.style.display = 'none';
            }
        }
        
        async function generatePageContent() {
            const context = document.getElementById('page-ai-context').value;
            const businessName = document.getElementById('contact-business-name')?.value || 'Our Property';
            const statusEl = document.getElementById('page-ai-status');
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '‚è≥ Generating content...';
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        type: 'page_content',
                        page_type: currentPageType,
                        context: context,
                        business_name: businessName
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.content) {
                    document.getElementById('page-content').value = data.content;
                    if (data.title) document.getElementById('page-title').value = data.title;
                    if (data.subtitle) document.getElementById('page-subtitle').value = data.subtitle;
                    statusEl.innerHTML = '‚úÖ Content generated! Review and edit as needed.';
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
            } catch (error) {
                console.error('Error generating content:', error);
                statusEl.innerHTML = '‚ùå Error generating content. Using template instead...';
                
                // Fallback to local templates
                setTimeout(() => {
                    const template = getPageTemplate(currentPageType, context, businessName);
                    document.getElementById('page-content').value = template;
                    statusEl.innerHTML = '‚úÖ Template applied! Customize it for your property.';
                }, 500);
            }
            
            setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
        }
        
        function getPageTemplate(pageType, context, businessName) {
            const templates = {
                about: `<h2>Welcome to ${businessName}</h2>
<p>${context || 'We are delighted to welcome you to our property. Our commitment to exceptional hospitality ensures every guest enjoys a memorable stay.'}</p>

<h2>Our Story</h2>
<p>Founded with a passion for hospitality, ${businessName} has been providing comfortable accommodations and warm service to travelers from around the world.</p>

<h2>What Makes Us Special</h2>
<ul>
    <li><strong>Prime Location</strong> - Perfectly situated for exploring the local area</li>
    <li><strong>Comfortable Rooms</strong> - Thoughtfully designed for your relaxation</li>
    <li><strong>Personal Service</strong> - Our team is dedicated to making your stay exceptional</li>
    <li><strong>Local Experience</strong> - We love sharing our knowledge of the area</li>
</ul>

<h2>Our Commitment</h2>
<p>We believe that great hospitality is about the details. From the moment you arrive until you check out, our goal is to exceed your expectations and create lasting memories.</p>`,

                contact: `<h2>Get in Touch</h2>
<p>We'd love to hear from you! Whether you have questions about your booking, need recommendations for local attractions, or want to arrange a special request, our team is here to help.</p>

<h2>Contact Information</h2>
<p>Feel free to reach out through any of the following channels:</p>

<h2>Before Your Arrival</h2>
<p>If you have any special requests or need to communicate arrival details, please don't hesitate to contact us. We're happy to help with:</p>
<ul>
    <li>Early check-in or late check-out requests</li>
    <li>Special occasion arrangements</li>
    <li>Dietary requirements</li>
    <li>Transportation assistance</li>
    <li>Local recommendations</li>
</ul>

<h2>During Your Stay</h2>
<p>Our team is available to assist you with anything you need during your stay. Just ask!</p>`,

                terms: `<h2>Booking Terms & Conditions</h2>
<p>Please read these terms carefully before making a reservation at ${businessName}. By completing a booking, you agree to these terms and conditions.</p>

<h2>Reservations & Payment</h2>
<p>A valid credit card is required to secure your reservation. Payment terms vary by rate type:</p>
<ul>
    <li><strong>Standard Rate:</strong> Full payment due at check-in</li>
    <li><strong>Non-Refundable Rate:</strong> Full payment charged at time of booking</li>
    <li><strong>Deposit Required:</strong> Partial payment at booking, balance due at check-in</li>
</ul>

<h2>Cancellation Policy</h2>
<p>Our standard cancellation policy is as follows:</p>
<ul>
    <li>Free cancellation up to 48 hours before check-in</li>
    <li>Cancellations within 48 hours: First night charged</li>
    <li>No-shows: Full stay charged</li>
    <li>Non-refundable bookings: No refunds for any cancellation</li>
</ul>

<h2>Check-in & Check-out</h2>
<ul>
    <li><strong>Check-in:</strong> From 3:00 PM</li>
    <li><strong>Check-out:</strong> By 11:00 AM</li>
    <li>Early check-in and late check-out available upon request (subject to availability)</li>
</ul>

<h2>House Rules</h2>
<ul>
    <li>No smoking on the premises</li>
    <li>Quiet hours: 10:00 PM - 8:00 AM</li>
    <li>Pets policy: Please contact us for pet-friendly options</li>
    <li>Additional guests must be registered at check-in</li>
</ul>

<h2>Liability</h2>
<p>${businessName} is not responsible for loss or damage to guests' personal belongings. Valuables should be secured in provided safes where available.</p>

<h2>Damages</h2>
<p>Guests are responsible for any damage caused to the property during their stay. Costs for repairs or replacement will be charged to the card on file.</p>`,

                privacy: `<h2>Privacy Policy</h2>
<p>At ${businessName}, we are committed to protecting your privacy and personal data. This policy explains how we collect, use, and safeguard your information.</p>

<h2>Information We Collect</h2>
<p>We collect information necessary to provide our services:</p>
<ul>
    <li><strong>Booking Information:</strong> Name, email, phone, address</li>
    <li><strong>Payment Details:</strong> Processed securely through our payment provider</li>
    <li><strong>Stay Preferences:</strong> Special requests, dietary requirements</li>
    <li><strong>Communication Records:</strong> Emails and messages exchanged with us</li>
</ul>

<h2>How We Use Your Information</h2>
<ul>
    <li>Process and manage your booking</li>
    <li>Communicate about your reservation</li>
    <li>Improve our services</li>
    <li>Send marketing communications (with your consent)</li>
    <li>Comply with legal obligations</li>
</ul>

<h2>Data Protection (GDPR)</h2>
<p>If you are in the European Economic Area, you have rights under GDPR including:</p>
<ul>
    <li><strong>Right to Access:</strong> Request a copy of your personal data</li>
    <li><strong>Right to Rectification:</strong> Correct inaccurate data</li>
    <li><strong>Right to Erasure:</strong> Request deletion of your data</li>
    <li><strong>Right to Portability:</strong> Receive your data in a portable format</li>
    <li><strong>Right to Object:</strong> Object to processing of your data</li>
</ul>

<h2>Cookies</h2>
<p>Our website uses cookies to improve your experience:</p>
<ul>
    <li><strong>Essential Cookies:</strong> Required for the website to function</li>
    <li><strong>Analytics Cookies:</strong> Help us understand how visitors use our site</li>
    <li><strong>Marketing Cookies:</strong> Used to deliver relevant advertisements</li>
</ul>

<h2>Data Security</h2>
<p>We implement appropriate security measures to protect your personal information against unauthorized access, alteration, or destruction.</p>

<h2>Third-Party Services</h2>
<p>We may share data with trusted partners who assist in operating our business:</p>
<ul>
    <li>Payment processors</li>
    <li>Booking platforms</li>
    <li>Email service providers</li>
</ul>

<h2>Contact Us</h2>
<p>For any privacy-related questions or to exercise your rights, please contact us.</p>

<h2>Updates to This Policy</h2>
<p>We may update this policy periodically. The latest version will always be available on our website.</p>

<p><em>Last updated: ${new Date().toLocaleDateString()}</em></p>`
            };
            
            return templates[pageType] || templates.about;
        }
        
        async function generatePageSEO() {
            const content = document.getElementById('page-content').value;
            const title = document.getElementById('page-title').value;
            const businessName = document.getElementById('contact-business-name')?.value || '';
            const statusEl = document.getElementById('page-ai-status');
            
            if (!content) {
                alert('Please add some content first, then generate SEO.');
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '‚è≥ Generating SEO suggestions...';
            
            try {
                const response = await fetch('/api/ai/generate-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        type: 'seo',
                        page_type: currentPageType,
                        content: content.substring(0, 2000),
                        title: title,
                        business_name: businessName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.meta_title) document.getElementById('page-meta-title').value = data.meta_title;
                    if (data.meta_description) document.getElementById('page-meta-description').value = data.meta_description;
                    updateMetaCount();
                    statusEl.innerHTML = '‚úÖ SEO generated!';
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
            } catch (error) {
                console.error('Error generating SEO:', error);
                // Fallback to basic SEO generation
                const seo = generateBasicSEO(currentPageType, title, businessName);
                document.getElementById('page-meta-title').value = seo.title;
                document.getElementById('page-meta-description').value = seo.description;
                updateMetaCount();
                statusEl.innerHTML = '‚úÖ SEO suggestions applied!';
            }
            
            setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
        }
        
        function generateBasicSEO(pageType, title, businessName) {
            const seoTemplates = {
                about: {
                    title: `About ${businessName || 'Us'} | Our Story & Values`,
                    description: `Learn about ${businessName || 'our property'}, our history, and what makes us special. Discover why guests choose us for their stay.`
                },
                contact: {
                    title: `Contact ${businessName || 'Us'} | Get in Touch`,
                    description: `Contact ${businessName || 'us'} for bookings, inquiries, or assistance. Find our address, phone number, email, and hours of operation.`
                },
                terms: {
                    title: `Terms & Conditions | ${businessName || 'Booking Policies'}`,
                    description: `Read our terms and conditions including booking policies, cancellation rules, check-in/out times, and house rules at ${businessName || 'our property'}.`
                },
                privacy: {
                    title: `Privacy Policy | ${businessName || 'Data Protection'}`,
                    description: `Our privacy policy explains how ${businessName || 'we'} collect, use, and protect your personal data. GDPR compliant.`
                }
            };
            
            return seoTemplates[pageType] || seoTemplates.about;
        }
        
        function generatePageFAQSchema() {
            const content = document.getElementById('page-content').value;
            const statusEl = document.getElementById('page-ai-status');
            
            if (!content) {
                alert('Please add content with headers (h2, h3) first.');
                return;
            }
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = '‚è≥ Extracting FAQ schema from headers...';
            
            // Parse headers and their following content
            const faqs = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            const headers = tempDiv.querySelectorAll('h2, h3');
            headers.forEach(header => {
                const question = header.textContent.trim();
                if (!question) return;
                
                // Get content until next header
                let answer = '';
                let sibling = header.nextElementSibling;
                while (sibling && !['H1', 'H2', 'H3', 'H4'].includes(sibling.tagName)) {
                    answer += sibling.textContent.trim() + ' ';
                    sibling = sibling.nextElementSibling;
                }
                
                answer = answer.trim();
                if (answer && answer.length > 20) {
                    // Convert header to question format if not already
                    let q = question;
                    if (!q.endsWith('?')) {
                        q = 'What is ' + q.toLowerCase().replace(/^(our |the |about )/i, '') + '?';
                    }
                    
                    faqs.push({
                        question: q.charAt(0).toUpperCase() + q.slice(1),
                        answer: answer.substring(0, 500) + (answer.length > 500 ? '...' : '')
                    });
                }
            });
            
            if (faqs.length > 0) {
                document.getElementById('page-faq-schema').value = JSON.stringify(faqs, null, 2);
                updateFAQPreview();
                statusEl.innerHTML = `‚úÖ Generated ${faqs.length} FAQ items from headers!`;
            } else {
                statusEl.innerHTML = '‚ö†Ô∏è No headers found. Add &lt;h2&gt; or &lt;h3&gt; tags to your content.';
            }
            
            setTimeout(() => { statusEl.style.display = 'none'; }, 4000);
        }
        
        function previewPageContent() {
            const content = document.getElementById('page-content').value;
            const title = document.getElementById('page-title').value;
            
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title} - Preview</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; color: #1e293b; }
                        h1 { color: #6366f1; border-bottom: 2px solid #6366f1; padding-bottom: 10px; }
                        h2 { color: #1e293b; margin-top: 30px; }
                        ul { padding-left: 20px; }
                        li { margin-bottom: 8px; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    ${content}
                </body>
                </html>
            `);
            previewWindow.document.close();
        }

        async function saveWebsitePage() {
            const pageData = {
                client_id: getClientId(),
                page_type: currentPageType,
                slug: currentPageType,
                title: document.getElementById('page-title').value,
                subtitle: document.getElementById('page-subtitle').value,
                content: document.getElementById('page-content').value,
                meta_title: document.getElementById('page-meta-title').value,
                meta_description: document.getElementById('page-meta-description').value,
                faq_schema: document.getElementById('page-faq-schema').value,
                is_published: document.getElementById('page-published').checked
            };
            
            try {
                const response = await fetch('/api/admin/pages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(pageData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Page saved successfully!');
                } else {
                    alert('Error saving page: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving page:', error);
                alert('Error saving page');
            }
        }

        async function loadContactInfo() {
            try {
                const response = await fetch(`/api/admin/contact-info?client_id=${getClientId()}`);
                const data = await response.json();
                
                if (data.success && data.contact) {
                    const c = data.contact;
                    // Basic info
                    document.getElementById('contact-business-name').value = c.business_name || '';
                    document.getElementById('contact-tagline').value = c.tagline || '';
                    document.getElementById('contact-email').value = c.email || '';
                    document.getElementById('contact-phone').value = c.phone || '';
                    
                    // Optional fields with null checks
                    const phoneSecondary = document.getElementById('contact-phone-secondary');
                    if (phoneSecondary) phoneSecondary.value = c.phone_secondary || '';
                    
                    const whatsapp = document.getElementById('contact-whatsapp');
                    if (whatsapp) whatsapp.value = c.whatsapp || '';
                    
                    // Address fields
                    const addr1 = document.getElementById('contact-address1');
                    if (addr1) addr1.value = c.address_line1 || '';
                    
                    const addr2 = document.getElementById('contact-address2');
                    if (addr2) addr2.value = c.address_line2 || '';
                    
                    const city = document.getElementById('contact-city');
                    if (city) city.value = c.city || '';
                    
                    const state = document.getElementById('contact-state');
                    if (state) state.value = c.state_province || '';
                    
                    const postal = document.getElementById('contact-postal');
                    if (postal) postal.value = c.postal_code || '';
                    
                    const country = document.getElementById('contact-country');
                    if (country) country.value = normalizeCountryCode(c.country) || '';
                    
                    // Social media
                    document.getElementById('contact-facebook').value = c.facebook_url || '';
                    document.getElementById('contact-instagram').value = c.instagram_url || '';
                    document.getElementById('contact-twitter').value = c.twitter_url || '';
                    
                    const linkedin = document.getElementById('contact-linkedin');
                    if (linkedin) linkedin.value = c.linkedin_url || '';
                    
                    const youtube = document.getElementById('contact-youtube');
                    if (youtube) youtube.value = c.youtube_url || '';
                    
                    const tripadvisor = document.getElementById('contact-tripadvisor');
                    if (tripadvisor) tripadvisor.value = c.tripadvisor_url || '';
                    
                    // Map fields
                    const mapsUrl = document.getElementById('contact-maps-url');
                    if (mapsUrl) mapsUrl.value = c.google_maps_url || '';
                    
                    const placeId = document.getElementById('contact-place-id');
                    if (placeId) placeId.value = c.google_place_id || '';
                    
                    const lat = document.getElementById('contact-latitude');
                    if (lat) lat.value = c.latitude || '';
                    
                    const lng = document.getElementById('contact-longitude');
                    if (lng) lng.value = c.longitude || '';
                }
            } catch (error) {
                console.error('Error loading contact info:', error);
            }
        }

        async function saveContactInfo() {
            const getVal = (id) => {
                const el = document.getElementById(id);
                return el ? el.value : '';
            };
            
            const contactData = {
                client_id: getClientId(),
                business_name: getVal('contact-business-name'),
                tagline: getVal('contact-tagline'),
                email: getVal('contact-email'),
                phone: getVal('contact-phone'),
                phone_secondary: getVal('contact-phone-secondary'),
                whatsapp: getVal('contact-whatsapp'),
                address_line1: getVal('contact-address1'),
                address_line2: getVal('contact-address2'),
                city: getVal('contact-city'),
                state_province: getVal('contact-state'),
                postal_code: getVal('contact-postal'),
                country: getVal('contact-country'),
                facebook_url: getVal('contact-facebook'),
                instagram_url: getVal('contact-instagram'),
                twitter_url: getVal('contact-twitter'),
                linkedin_url: getVal('contact-linkedin'),
                youtube_url: getVal('contact-youtube'),
                tripadvisor_url: getVal('contact-tripadvisor'),
                google_maps_url: getVal('contact-maps-url'),
                google_place_id: getVal('contact-place-id'),
                latitude: getVal('contact-latitude') || null,
                longitude: getVal('contact-longitude') || null
            };
            
            try {
                const response = await fetch('/api/admin/contact-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(contactData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Contact info saved successfully!');
                } else {
                    alert('Error saving contact info: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving contact info:', error);
                alert('Error saving contact info');
            }
        }

        // =====================================================
        // BLOG FUNCTIONS
        // =====================================================

        async function loadBlogPosts() {
            try {
                const response = await fetch(`/api/admin/blog?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('blog-posts-list');
                
                if (data.success && data.posts && data.posts.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.posts.map(post => `
                                    <tr>
                                        <td><strong>${post.title}</strong></td>
                                        <td>${post.category || '-'}</td>
                                        <td><span class="badge ${post.is_published ? 'badge-success' : 'badge-secondary'}">${post.is_published ? 'Published' : 'Draft'}</span></td>
                                        <td>${post.published_at ? new Date(post.published_at).toLocaleDateString() : '-'}</td>
                                        <td>
                                            <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editBlogPost(${post.id})">Edit</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                            <p>No blog posts yet</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openBlogModal()">Create Your First Post</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading blog posts:', error);
            }
        }

        function openBlogModal(post = null) {
            alert('Blog modal coming soon! The API endpoints are ready at /api/admin/blog');
        }

        async function editBlogPost(id) {
            alert('Edit blog post ' + id + ' - Modal coming soon!');
        }

        // =====================================================
        // ATTRACTIONS FUNCTIONS
        // =====================================================

        async function loadAttractions() {
            try {
                const response = await fetch(`/api/admin/attractions?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('attractions-list');
                
                if (data.success && data.attractions && data.attractions.length > 0) {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                            ${data.attractions.map(attr => `
                                <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="editAttraction(${attr.id})">
                                    ${attr.featured_image_url ? 
                                        `<img src="${attr.featured_image_url}" style="width: 100%; height: 150px; object-fit: cover;">` :
                                        `<div style="width: 100%; height: 150px; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; font-size: 3rem;">üéØ</div>`
                                    }
                                    <div style="padding: 1rem;">
                                        <h4 style="margin: 0 0 0.5rem;">${attr.name}</h4>
                                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">
                                            ${attr.category ? `üìç ${attr.category}` : ''}
                                            ${attr.distance_text ? ` ‚Ä¢ ${attr.distance_text}` : ''}
                                        </p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üéØ</div>
                            <p>No attractions added yet</p>
                            <button class="btn" style="margin-top: 1rem;" onclick="openAttractionModal()">Add Your First Attraction</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading attractions:', error);
            }
        }

        function openAttractionModal(attraction = null) {
            alert('Attraction modal coming soon! The API endpoints are ready at /api/admin/attractions');
        }

        async function editAttraction(id) {
            alert('Edit attraction ' + id + ' - Modal coming soon!');
        }

        // =====================================================
        // REVIEWS FUNCTIONS
        // =====================================================

        function openReviewModal() {
            alert('Reviews modal coming soon! The API endpoints will be at /api/admin/reviews');
        }

        async function loadAppBlogPosts() {
            // Reuse the same function but target different container
            try {
                const response = await fetch(`/api/admin/blog?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('app-blog-posts-list');
                if (!container) return;
                
                if (data.success && data.posts && data.posts.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.posts.map(post => `
                                    <tr>
                                        <td><strong>${post.title}</strong></td>
                                        <td>${post.category || '-'}</td>
                                        <td><span class="badge ${post.is_published ? 'badge-success' : 'badge-secondary'}">${post.is_published ? 'Published' : 'Draft'}</span></td>
                                        <td>${post.published_at ? new Date(post.published_at).toLocaleDateString() : '-'}</td>
                                        <td>
                                            <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editBlogPost(${post.id})">Edit</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Error loading blog posts:', error);
            }
        }

        async function loadAppAttractions() {
            try {
                const response = await fetch(`/api/admin/attractions?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('app-attractions-list');
                if (!container) return;
                
                if (data.success && data.attractions && data.attractions.length > 0) {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                            ${data.attractions.map(attr => `
                                <div style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer; background: white;" onclick="editAttraction(${attr.id})">
                                    ${attr.featured_image_url ? 
                                        `<img src="${attr.featured_image_url}" style="width: 100%; height: 150px; object-fit: cover;">` :
                                        `<div style="width: 100%; height: 150px; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; font-size: 3rem;">üéØ</div>`
                                    }
                                    <div style="padding: 1rem;">
                                        <h4 style="margin: 0 0 0.5rem;">${attr.name}</h4>
                                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">
                                            ${attr.category ? `üìç ${attr.category}` : ''}
                                            ${attr.distance_text ? ` ‚Ä¢ ${attr.distance_text}` : ''}
                                        </p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading attractions:', error);
            }
        }

        // =====================================================
        // BRANDING FUNCTIONS
        // =====================================================

        async function loadBranding() {
            try {
                const response = await fetch(`/api/admin/branding?client_id=${getClientId()}`);
                const data = await response.json();
                
                if (data.success && data.branding) {
                    const b = data.branding;
                    
                    // Logo & Identity
                    document.getElementById('brand-logo-url').value = b.logo_url || '';
                    document.getElementById('brand-logo-dark-url').value = b.logo_dark_url || '';
                    document.getElementById('brand-favicon-url').value = b.favicon_url || '';
                    document.getElementById('brand-og-image-url').value = b.og_image_url || '';
                    document.getElementById('brand-site-title').value = b.site_title || '';
                    document.getElementById('brand-site-description').value = b.site_description || '';
                    
                    // Primary Colors
                    setColorInput('brand-primary-color', b.primary_color || '#2563eb');
                    setColorInput('brand-secondary-color', b.secondary_color || '#7c3aed');
                    setColorInput('brand-accent-color', b.accent_color || '#f59e0b');
                    
                    // Text & Background
                    setColorInput('brand-text-color', b.text_color || '#1e293b');
                    setColorInput('brand-text-light-color', b.text_light_color || '#64748b');
                    setColorInput('brand-background-color', b.background_color || '#ffffff');
                    setColorInput('brand-surface-color', b.surface_color || '#f8fafc');
                    
                    // Header
                    setColorInput('brand-header-bg', b.header_bg_color || '#ffffff');
                    setColorInput('brand-header-text', b.header_text_color || '#1e293b');
                    document.getElementById('brand-header-sticky').checked = b.header_sticky !== false;
                    document.getElementById('brand-header-transparent').checked = b.header_transparent_home || false;
                    
                    // Footer
                    setColorInput('brand-footer-bg', b.footer_bg_color || '#0f172a');
                    setColorInput('brand-footer-text', b.footer_text_color || '#ffffff');
                    setColorInput('brand-footer-link', b.footer_link_color || '#94a3b8');
                    setColorInput('brand-footer-link-hover', b.footer_link_hover_color || '#ffffff');
                    document.getElementById('brand-copyright').value = b.copyright_text || '';
                    
                    // Buttons
                    setColorInput('brand-btn-primary-bg', b.button_primary_bg || b.primary_color || '#2563eb');
                    setColorInput('brand-btn-primary-text', b.button_primary_text || '#ffffff');
                    setColorInput('brand-btn-primary-hover', b.button_primary_hover || '#1d4ed8');
                    setColorInput('brand-btn-secondary-text', b.button_secondary_text || b.primary_color || '#2563eb');
                    setColorInput('brand-btn-secondary-bg', b.button_secondary_bg || '#ffffff');
                    document.getElementById('brand-btn-radius').value = b.button_border_radius || '8px';
                    
                    // Typography
                    document.getElementById('brand-font-heading').value = b.font_heading || 'Inter';
                    document.getElementById('brand-font-body').value = b.font_body || 'Inter';
                    document.getElementById('brand-font-heading-weight').value = b.font_heading_weight || '700';
                    document.getElementById('brand-font-body-weight').value = b.font_body_weight || '400';
                    
                    // Custom CSS
                    document.getElementById('brand-custom-css').value = b.custom_css || '';
                    
                    // Update previews
                    updateBrandingPreviews();
                }
            } catch (error) {
                console.error('Error loading branding:', error);
            }
        }
        
        function setColorInput(baseId, value) {
            const colorInput = document.getElementById(baseId);
            const textInput = document.getElementById(baseId + '-text');
            if (colorInput) colorInput.value = value;
            if (textInput) textInput.value = value;
        }
        
        function updateBrandingPreviews() {
            // Update button previews - check if elements exist first
            const primaryBtn = document.getElementById('preview-btn-primary');
            const secondaryBtn = document.getElementById('preview-btn-secondary');
            const radiusEl = document.getElementById('brand-btn-radius');
            
            // Exit early if branding elements don't exist on this page
            if (!radiusEl) return;
            
            const radius = radiusEl.value;
            
            if (primaryBtn) {
                const bgEl = document.getElementById('brand-btn-primary-bg');
                const textEl = document.getElementById('brand-btn-primary-text');
                if (bgEl) primaryBtn.style.background = bgEl.value;
                if (textEl) primaryBtn.style.color = textEl.value;
                primaryBtn.style.borderRadius = radius;
            }
            
            if (secondaryBtn) {
                const bgEl = document.getElementById('brand-btn-secondary-bg');
                const textEl = document.getElementById('brand-btn-secondary-text');
                if (textEl) {
                    const textColor = textEl.value;
                    if (bgEl) secondaryBtn.style.background = bgEl.value;
                    secondaryBtn.style.color = textColor;
                    secondaryBtn.style.border = '2px solid ' + textColor;
                }
                secondaryBtn.style.borderRadius = radius;
            }
            
            // Update typography preview
            const headingPreview = document.getElementById('preview-heading');
            const bodyPreview = document.getElementById('preview-body');
            
            if (headingPreview) {
                const fontEl = document.getElementById('brand-font-heading');
                const weightEl = document.getElementById('brand-font-heading-weight');
                if (fontEl) headingPreview.style.fontFamily = fontEl.value;
                if (weightEl) headingPreview.style.fontWeight = weightEl.value;
            }
            
            if (bodyPreview) {
                const fontEl = document.getElementById('brand-font-body');
                const weightEl = document.getElementById('brand-font-body-weight');
                if (fontEl) bodyPreview.style.fontFamily = fontEl.value;
                if (weightEl) bodyPreview.style.fontWeight = weightEl.value;
            }
        }

        async function saveBranding() {
            const brandData = {
                client_id: getClientId(),
                // Logo & Identity
                logo_url: document.getElementById('brand-logo-url').value,
                logo_dark_url: document.getElementById('brand-logo-dark-url').value,
                favicon_url: document.getElementById('brand-favicon-url').value,
                og_image_url: document.getElementById('brand-og-image-url').value,
                site_title: document.getElementById('brand-site-title').value,
                site_description: document.getElementById('brand-site-description').value,
                
                // Primary Colors
                primary_color: document.getElementById('brand-primary-color').value,
                secondary_color: document.getElementById('brand-secondary-color').value,
                accent_color: document.getElementById('brand-accent-color').value,
                
                // Text & Background
                text_color: document.getElementById('brand-text-color').value,
                text_light_color: document.getElementById('brand-text-light-color').value,
                background_color: document.getElementById('brand-background-color').value,
                surface_color: document.getElementById('brand-surface-color').value,
                
                // Header
                header_bg_color: document.getElementById('brand-header-bg').value,
                header_text_color: document.getElementById('brand-header-text').value,
                header_sticky: document.getElementById('brand-header-sticky').checked,
                header_transparent_home: document.getElementById('brand-header-transparent').checked,
                
                // Footer
                footer_bg_color: document.getElementById('brand-footer-bg').value,
                footer_text_color: document.getElementById('brand-footer-text').value,
                footer_link_color: document.getElementById('brand-footer-link').value,
                footer_link_hover_color: document.getElementById('brand-footer-link-hover').value,
                copyright_text: document.getElementById('brand-copyright').value,
                
                // Buttons
                button_primary_bg: document.getElementById('brand-btn-primary-bg').value,
                button_primary_text: document.getElementById('brand-btn-primary-text').value,
                button_primary_hover: document.getElementById('brand-btn-primary-hover').value,
                button_secondary_text: document.getElementById('brand-btn-secondary-text').value,
                button_secondary_bg: document.getElementById('brand-btn-secondary-bg').value,
                button_border_radius: document.getElementById('brand-btn-radius').value,
                
                // Typography
                font_heading: document.getElementById('brand-font-heading').value,
                font_body: document.getElementById('brand-font-body').value,
                font_heading_weight: document.getElementById('brand-font-heading-weight').value,
                font_body_weight: document.getElementById('brand-font-body-weight').value,
                
                // Custom CSS
                custom_css: document.getElementById('brand-custom-css').value
            };
            
            try {
                const response = await fetch('/api/admin/branding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(brandData)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Branding saved!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error saving branding:', error);
            }
        }
        
        function previewBranding() {
            alert('Theme preview coming soon! Your changes are saved and will appear on the website immediately.');
        }
        
        // Add event listeners for live preview updates
        document.addEventListener('DOMContentLoaded', function() {
            // Color input sync
            document.querySelectorAll('input[type="color"]').forEach(colorInput => {
                colorInput.addEventListener('input', function() {
                    const textInput = document.getElementById(this.id + '-text');
                    if (textInput) textInput.value = this.value;
                    updateBrandingPreviews();
                });
            });
            
            // Select change handlers for previews
            ['brand-btn-radius', 'brand-font-heading', 'brand-font-body', 'brand-font-heading-weight', 'brand-font-body-weight'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', updateBrandingPreviews);
            });
        });

        // =====================================================
        // API FUNCTIONS
        // =====================================================

        async function loadApiKeys() {
            try {
                const response = await fetch(`/api/admin/api-keys?client_id=${getClientId()}`);
                const data = await response.json();
                
                const container = document.getElementById('api-keys-list');
                if (!container) return;
                
                if (data.success && data.api_keys && data.api_keys.length > 0) {
                    container.innerHTML = `
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>API Key</th>
                                        <th>Last Used</th>
                                        <th>Requests</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.api_keys.map(key => `
                                        <tr>
                                            <td><strong>${key.key_name}</strong></td>
                                            <td>
                                                <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                                    ${key.api_key.substring(0, 12)}...
                                                </code>
                                                <button onclick="copyToClipboard('${key.api_key}')" style="background: none; border: none; cursor: pointer; margin-left: 0.25rem;">üìã</button>
                                            </td>
                                            <td style="font-size: 0.85rem; color: var(--text-secondary);">
                                                ${key.last_used_at ? new Date(key.last_used_at).toLocaleDateString() : 'Never'}
                                            </td>
                                            <td style="font-size: 0.85rem;">${key.total_requests?.toLocaleString() || 0}</td>
                                            <td>
                                                <span class="badge ${key.is_active ? 'badge-success' : 'badge-secondary'}">
                                                    ${key.is_active ? 'Active' : 'Disabled'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="toggleApiKey(${key.id}, ${!key.is_active})">
                                                    ${key.is_active ? 'Disable' : 'Enable'}
                                                </button>
                                                <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #ef4444;" onclick="deleteApiKey(${key.id})">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîê</div>
                            <p>No API keys yet. Create one to access secure endpoints.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading API keys:', error);
            }
        }

        // Channel Manager Modal
        function openChannelManagerModal() {
            document.getElementById('channelManagerModal').style.display = 'flex';
            document.addEventListener('keydown', handleChannelManagerEscape);
        }
        
        function handleChannelManagerEscape(e) {
            if (e.key === 'Escape') closeChannelManagerModal();
        }

        function closeChannelManagerModal() {
            document.getElementById('channelManagerModal').style.display = 'none';
            document.removeEventListener('keydown', handleChannelManagerEscape);
        }

        function openApiKeyModal() {
            document.getElementById('api-key-name').value = '';
            document.getElementById('api-key-rate-limit').value = '60';
            document.getElementById('api-key-origins').value = '';
            document.getElementById('api-key-edit-id').value = '';
            document.getElementById('perm-read-rooms').checked = true;
            document.getElementById('perm-read-availability').checked = true;
            document.getElementById('perm-read-pricing').checked = true;
            document.getElementById('perm-read-offers').checked = true;
            document.getElementById('perm-read-content').checked = true;
            document.getElementById('apiKeyModalTitle').textContent = 'Create API Key';
            document.getElementById('apiKeyModal').style.display = 'flex';
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }

        async function saveApiKey() {
            const name = document.getElementById('api-key-name').value;
            if (!name) {
                alert('Please enter a key name');
                return;
            }
            
            const permissions = [];
            if (document.getElementById('perm-read-rooms').checked) permissions.push('read:rooms');
            if (document.getElementById('perm-read-availability').checked) permissions.push('read:availability');
            if (document.getElementById('perm-read-pricing').checked) permissions.push('read:pricing');
            if (document.getElementById('perm-read-offers').checked) permissions.push('read:offers');
            if (document.getElementById('perm-read-content').checked) permissions.push('read:content');
            
            const originsText = document.getElementById('api-key-origins').value;
            const allowed_origins = originsText ? originsText.split(',').map(s => s.trim()).filter(Boolean) : [];
            
            const keyData = {
                client_id: getClientId(),
                key_name: name,
                permissions: permissions,
                rate_limit_per_minute: parseInt(document.getElementById('api-key-rate-limit').value) || 60,
                allowed_origins: allowed_origins
            };
            
            try {
                const response = await fetch('/api/admin/api-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(keyData)
                });
                
                const result = await response.json();
                if (result.success) {
                    closeApiKeyModal();
                    loadApiKeys();
                    
                    // Show the new key
                    alert('API Key Created!\n\nYour new key:\n' + result.api_key.api_key + '\n\nCopy this key now - you won\'t be able to see the full key again.');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating API key:', error);
                alert('Error creating API key');
            }
        }

        async function toggleApiKey(id, newState) {
            try {
                const response = await fetch(`/api/admin/api-keys/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ is_active: newState })
                });
                
                const result = await response.json();
                if (result.success) {
                    loadApiKeys();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error toggling API key:', error);
            }
        }

        async function deleteApiKey(id) {
            if (!confirm('Are you sure you want to delete this API key? Any applications using it will stop working.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/api-keys/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    loadApiKeys();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting API key:', error);
            }
        }

        function showApiTab(tab) {
            // Update buttons
            ['rooms', 'availability', 'pricing', 'offers', 'content'].forEach(t => {
                const btn = document.getElementById('api-tab-' + t);
                if (btn) btn.style.background = t === tab ? 'var(--accent)' : '#64748b';
            });
            
            // Show/hide sections
            document.querySelectorAll('.api-endpoints-section').forEach(el => el.style.display = 'none');
            const section = document.getElementById('api-endpoints-' + tab);
            if (section) section.style.display = 'block';
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Copied!');
            });
        }

        async function testApiConnection() {
            try {
                const response = await fetch('/api/public/client/1/rooms');
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ API Connection Successful!\n\nFound ' + (data.rooms?.length || 0) + ' rooms.');
                } else {
                    alert('‚ùå API Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Connection Failed: ' + error.message);
            }
        }

        function copyApiUrl() {
            copyToClipboard(document.getElementById('api-docs-base-url').value);
        }

        // =====================================================
        // KNOWLEDGE BASE FUNCTIONS
        // =====================================================

        async function setupKnowledgeBase() {
            try {
                const response = await fetch('/api/setup-knowledge-base');
                const data = await response.json();
                if (data.success) {
                    showNotification('Knowledge base tables created!', 'success');
                    loadKBArticles();
                    loadKBCategories();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error setting up knowledge base', 'error');
            }
        }

        async function loadKBCategories() {
            try {
                const response = await fetch('/api/kb/categories');
                const data = await response.json();
                if (data.success) {
                    // Populate filter dropdown
                    const filterSelect = document.getElementById('kb-category-filter');
                    const articleSelect = document.getElementById('kb-article-category');
                    
                    if (filterSelect) {
                        filterSelect.innerHTML = '<option value="">All Categories</option>' +
                            data.data.map(c => `<option value="${c.id}">${c.icon || ''} ${c.name} (${c.article_count || 0})</option>`).join('');
                    }
                    
                    if (articleSelect) {
                        articleSelect.innerHTML = '<option value="">Select category...</option>' +
                            data.data.map(c => `<option value="${c.id}">${c.icon || ''} ${c.name}</option>`).join('');
                    }
                    
                    // Update stats
                    document.getElementById('kb-category-count').textContent = data.data.length;
                }
            } catch (error) {
                console.error('Error loading KB categories:', error);
            }
        }

        async function loadKBArticles() {
            try {
                const categoryId = document.getElementById('kb-category-filter')?.value || '';
                const search = document.getElementById('kb-search')?.value || '';
                
                let url = '/api/kb/articles?status=published';
                if (categoryId) url += '&category_id=' + categoryId;
                if (search) url += '&search=' + encodeURIComponent(search);
                
                const response = await fetch(url);
                const data = await response.json();
                
                const tbody = document.getElementById('kb-articles-table');
                if (!tbody) return;
                
                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(article => `
                        <tr>
                            <td>
                                <strong>${article.title}</strong>
                                ${article.summary ? `<br><small style="color: var(--text-secondary);">${article.summary.substring(0, 80)}...</small>` : ''}
                            </td>
                            <td>${article.category_icon || ''} ${article.category_name || 'Uncategorized'}</td>
                            <td>
                                <span class="badge ${article.status === 'published' ? 'badge-success' : 'badge-warning'}">
                                    ${article.status}
                                </span>
                            </td>
                            <td>${article.views || 0}</td>
                            <td>
                                <span style="color: var(--success);">üëç ${article.helpful_yes || 0}</span>
                                <span style="color: var(--error); margin-left: 0.5rem;">üëé ${article.helpful_no || 0}</span>
                            </td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editKBArticle(${article.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: var(--error);" onclick="deleteKBArticle(${article.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                    
                    document.getElementById('kb-article-count').textContent = data.data.length;
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No articles found. Click "Setup Tables" first, then add articles.</td></tr>';
                    document.getElementById('kb-article-count').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading KB articles:', error);
            }
        }

        function openKBArticleModal(articleId = null) {
            document.getElementById('kb-article-id').value = '';
            document.getElementById('kb-article-title').value = '';
            document.getElementById('kb-article-summary').value = '';
            document.getElementById('kb-article-content').value = '';
            document.getElementById('kb-article-keywords').value = '';
            document.getElementById('kb-article-status').value = 'published';
            document.getElementById('kb-article-category').value = '';
            document.getElementById('kb-article-modal-title').textContent = 'üìö Add Knowledge Article';
            
            loadKBCategories();
            openModal('kbArticleModal');
        }

        async function editKBArticle(id) {
            try {
                const response = await fetch('/api/kb/articles/' + id);
                const data = await response.json();
                
                if (data.success) {
                    const article = data.data;
                    document.getElementById('kb-article-id').value = article.id;
                    document.getElementById('kb-article-title').value = article.title;
                    document.getElementById('kb-article-summary').value = article.summary || '';
                    document.getElementById('kb-article-content').value = article.content;
                    document.getElementById('kb-article-keywords').value = (article.keywords || []).join(', ');
                    document.getElementById('kb-article-status').value = article.status;
                    document.getElementById('kb-article-modal-title').textContent = 'üìù Edit Article';
                    
                    await loadKBCategories();
                    document.getElementById('kb-article-category').value = article.category_id || '';
                    
                    openModal('kbArticleModal');
                }
            } catch (error) {
                showNotification('Error loading article', 'error');
            }
        }

        async function saveKBArticle(event) {
            event.preventDefault();
            
            const id = document.getElementById('kb-article-id').value;
            const keywords = document.getElementById('kb-article-keywords').value
                .split(',')
                .map(k => k.trim().toLowerCase())
                .filter(k => k.length > 0);
            
            const articleData = {
                id: id || undefined,
                title: document.getElementById('kb-article-title').value,
                category_id: document.getElementById('kb-article-category').value || null,
                summary: document.getElementById('kb-article-summary').value,
                content: document.getElementById('kb-article-content').value,
                keywords: keywords,
                status: document.getElementById('kb-article-status').value
            };
            
            try {
                const response = await fetch('/api/kb/articles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(articleData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Article saved!', 'success');
                    closeModal('kbArticleModal');
                    loadKBArticles();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving article', 'error');
            }
        }

        async function deleteKBArticle(id) {
            if (!confirm('Delete this article? This cannot be undone.')) return;
            
            try {
                const response = await fetch('/api/kb/articles/' + id, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Article deleted', 'success');
                    loadKBArticles();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error deleting article', 'error');
            }
        }

        function openKBImportModal() {
            document.getElementById('kb-import-json').value = '';
            document.getElementById('kb-import-result').style.display = 'none';
            openModal('kbImportModal');
        }

        async function importKBArticles() {
            const jsonText = document.getElementById('kb-import-json').value.trim();
            const resultDiv = document.getElementById('kb-import-result');
            
            if (!jsonText) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fef2f2';
                resultDiv.innerHTML = '‚ùå Please paste JSON data';
                return;
            }
            
            try {
                const articles = JSON.parse(jsonText);
                
                if (!Array.isArray(articles)) {
                    throw new Error('JSON must be an array');
                }
                
                const response = await fetch('/api/kb/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ articles })
                });
                
                const data = await response.json();
                
                resultDiv.style.display = 'block';
                if (data.success) {
                    resultDiv.style.background = '#f0fdf4';
                    resultDiv.innerHTML = `‚úÖ Imported ${data.imported} articles` +
                        (data.errors?.length ? `<br>‚ö†Ô∏è ${data.errors.length} errors` : '');
                    loadKBArticles();
                    loadKBCategories();
                } else {
                    resultDiv.style.background = '#fef2f2';
                    resultDiv.innerHTML = '‚ùå ' + data.error;
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fef2f2';
                resultDiv.innerHTML = '‚ùå Invalid JSON: ' + error.message;
            }
        }

        async function loadKBUnanswered() {
            try {
                const status = document.getElementById('kb-unanswered-filter')?.value || 'new';
                const response = await fetch('/api/kb/unanswered' + (status ? '?status=' + status : ''));
                const data = await response.json();
                
                const container = document.getElementById('kb-unanswered-list');
                const countEl = document.getElementById('kb-unanswered-count');
                const totalEl = document.getElementById('kb-unanswered-total');
                
                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(q => `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <p style="margin: 0 0 0.5rem 0; font-weight: 500;">"${q.question}"</p>
                                    <small style="color: var(--text-secondary);">
                                        Asked ${q.times_asked}x ¬∑ ${new Date(q.created_at).toLocaleDateString()}
                                    </small>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;" onclick="createArticleFromQuestion(${q.id}, '${q.question.replace(/'/g, "\\'")}')">
                                        + Create Article
                                    </button>
                                    <button class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;" onclick="dismissQuestion(${q.id})">
                                        Dismiss
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    if (countEl) countEl.textContent = data.data.length;
                    if (totalEl) totalEl.textContent = data.data.length + ' questions';
                } else {
                    container.innerHTML = '<div class="card" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No unanswered questions! üéâ</div>';
                    if (countEl) countEl.textContent = '0';
                    if (totalEl) totalEl.textContent = '0 questions';
                }
            } catch (error) {
                console.error('Error loading unanswered:', error);
            }
        }

        function createArticleFromQuestion(questionId, questionText) {
            openKBArticleModal();
            document.getElementById('kb-article-title').value = questionText;
            // Store question ID to resolve after saving
            document.getElementById('kb-article-form').dataset.resolveQuestionId = questionId;
        }

        async function dismissQuestion(id) {
            if (!confirm('Dismiss this question?')) return;
            
            try {
                const response = await fetch('/api/kb/unanswered/' + id, { method: 'DELETE', headers: authHeaders() });
                if (response.ok) {
                    showNotification('Question dismissed', 'success');
                    loadKBUnanswered();
                }
            } catch (error) {
                showNotification('Error dismissing question', 'error');
            }
        }

        // Load KB data when switching to KB views
        const originalNavClick = navClick;
        navClick = function(element, view) {
            originalNavClick(element, view);
            if (view === 'kb-articles') {
                loadKBCategories();
                loadKBArticles();
            } else if (view === 'kb-unanswered') {
                loadKBUnanswered();
            } else if (view === 'billing-overview') {
                loadBillingOverview();
            } else if (view === 'billing-plans') {
                loadBillingPlans();
            } else if (view === 'billing-products') {
                loadBillingProducts();
            } else if (view === 'billing-addons') {
                loadBillingAddons();
            } else if (view === 'billing-subscribers') {
                loadSubscribers();
            } else if (view === 'billing-credits') {
                loadCreditPackages();
            } else if (view === 'billing-extras') {
                loadBillingExtras();
            } else if (view === 'billing-affiliates') {
                loadAffiliatesAdmin();
            } else if (view === 'my-referrals') {
                loadMyReferrals();
            } else if (view === 'my-billing') {
                loadMyBilling();
            }
        };

        // Show admin billing sections for master_admin only
        function updateBillingNavVisibility() {
            // Check both possible storage keys and currentAccount
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || localStorage.getItem('gas_user') || '{}');
            const isMasterAdmin = user.role === 'master_admin';
            
            document.querySelectorAll('.billing-admin-only').forEach(el => {
                if (isMasterAdmin) {
                    // Use appropriate display based on element type
                    if (el.tagName === 'A') {
                        el.style.display = 'flex';
                    } else if (el.tagName === 'BUTTON') {
                        el.style.display = 'inline-flex';
                    } else {
                        el.style.display = 'block';
                    }
                } else {
                    el.style.display = 'none';
                }
            });
        }
        
        // Call on page load (will be called again after auth)
        updateBillingNavVisibility();

        // =====================================================
        // FEATURE ENTITLEMENTS
        // =====================================================
        
        let accountEntitlements = null;
        
        // Load entitlements for the current/selected account
        async function loadAccountEntitlements() {
            const accountId = selectedAccountId || (currentAccount ? currentAccount.id : null);
            
            if (!accountId) {
                // No subscription - lock all premium features
                accountEntitlements = { features: {} };
                applyFeatureLocks();
                return;
            }
            
            try {
                const response = await fetch(`/api/account/${accountId}/entitlements`);
                const data = await response.json();
                
                if (data.success) {
                    accountEntitlements = data;
                } else {
                    accountEntitlements = { features: {} };
                }
            } catch (error) {
                console.error('Error loading entitlements:', error);
                accountEntitlements = { features: {} };
            }
            
            applyFeatureLocks();
        }
        
        // Apply locked state to nav items based on entitlements
        function applyFeatureLocks() {
            const features = accountEntitlements?.features || {};
            const hasPlan = accountEntitlements?.plan != null;
            
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            
            // If master_admin with NO account selected, show everything unlocked
            if (user.role === 'master_admin' && !selectedAccountId) {
                document.querySelectorAll('[data-requires-feature]').forEach(el => {
                    el.classList.remove('feature-locked');
                    const lock = el.querySelector('.feature-lock');
                    if (lock) lock.style.display = 'none';
                });
                return;
            }
            
            // Otherwise, show locks based on selected account's entitlements
            document.querySelectorAll('[data-requires-feature]').forEach(el => {
                const requiredFeature = el.getAttribute('data-requires-feature');
                
                // Check access based on feature type
                let hasAccess = false;
                if (requiredFeature === 'has_subscription') {
                    hasAccess = hasPlan;
                } else if (requiredFeature === 'api_access') {
                    hasAccess = features.api_access === true;
                } else {
                    hasAccess = features[requiredFeature] === true;
                }
                
                if (hasAccess) {
                    el.classList.remove('feature-locked');
                    const lock = el.querySelector('.feature-lock');
                    if (lock) lock.style.display = 'none';
                } else {
                    el.classList.add('feature-locked');
                    const lock = el.querySelector('.feature-lock');
                    if (lock) lock.style.display = 'inline';
                }
            });
        }
        
        // Handle click on feature-gated nav items
        function handleFeatureClick(element, viewName, featureName) {
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            
            // Master admin with no account selected - always has access
            if (user.role === 'master_admin' && !selectedAccountId) {
                navClick(element, viewName);
                return false;
            }
            
            const features = accountEntitlements?.features || {};
            const hasPlan = accountEntitlements?.plan != null;
            
            // Check access based on feature type
            let hasAccess = false;
            if (featureName === 'has_subscription') {
                hasAccess = hasPlan;
            } else if (featureName === 'api_access') {
                hasAccess = features.api_access === true;
            } else {
                hasAccess = features[featureName] === true;
            }
            
            if (hasAccess) {
                navClick(element, viewName);
            } else {
                // Show upgrade prompt
                const featureNames = {
                    'blog_module': 'Blog Module',
                    'attractions_module': 'Attractions Module', 
                    'reviews_widget': 'Reviews Widget',
                    'has_subscription': 'WordPress Integration',
                    'api_access': 'API Access'
                };
                const planRequired = {
                    'blog_module': 'Professional',
                    'attractions_module': 'Business',
                    'reviews_widget': 'Enterprise',
                    'has_subscription': 'any',
                    'api_access': 'with API access enabled'
                };
                
                const name = featureNames[featureName] || featureName;
                const plan = planRequired[featureName] || 'a higher';
                
                // Different messages based on feature type
                if (user.role === 'master_admin') {
                    if (featureName === 'has_subscription') {
                        showNotification(`üîí This account needs an active subscription for ${name}.`, 'warning', 5000);
                    } else if (featureName === 'api_access') {
                        showNotification(`üîí API Access is not enabled for this account. Enable it in account settings.`, 'warning', 5000);
                    } else {
                        showNotification(`üîí This account doesn't have ${name}. Assign ${plan} plan or above.`, 'warning', 5000);
                    }
                } else {
                    if (featureName === 'has_subscription') {
                        showNotification(`üîí ${name} requires an active subscription. Go to Billing to subscribe.`, 'warning', 5000);
                    } else if (featureName === 'api_access') {
                        showNotification(`üîí API Access is not enabled for your account. Contact support.`, 'warning', 5000);
                    } else {
                        showNotification(`üîí ${name} requires ${plan} plan or above. Go to Billing > Plans & Extras to upgrade.`, 'warning', 5000);
                    }
                }
            }
            return false;
        }
        
        // Call after auth and when account selection changes
        loadAccountEntitlements();

        // =====================================================
        // INSTAWP INTEGRATION
        // =====================================================
        
        let vpsSettingsVisible = false;
        
        function toggleVPSSettings() {
            vpsSettingsVisible = !vpsSettingsVisible;
            document.getElementById('vps-settings-panel').style.display = vpsSettingsVisible ? 'block' : 'none';
            document.getElementById('vps-toggle-text').textContent = vpsSettingsVisible ? 'Hide Settings' : 'Show Settings';
            
            if (vpsSettingsVisible) {
                loadVPSSettings();
            }
        }
        
        async function loadVPSSettings() {
            try {
                const response = await fetch('/api/admin/vps/settings');
                const data = await response.json();
                
                if (data.success && data.data) {
                    if (document.getElementById('vps-api-url')) {
                        document.getElementById('vps-api-url').value = data.data.api_url || 'https://sites.gas.travel/gas-api.php';
                    }
                    document.getElementById('vps-api-key').value = data.data.api_key || '';
                    document.getElementById('vps-default-template').value = data.data.default_template || '';
                    document.getElementById('vps-enabled').checked = data.data.is_enabled || false;
                }
            } catch (error) {
                console.error('Error loading WordPress settings:', error);
            }
        }
        
        async function saveVPSSettings() {
            try {
                const response = await fetch('/api/admin/vps/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        api_url: document.getElementById('vps-api-url')?.value || 'https://sites.gas.travel/gas-api.php',
                        api_key: document.getElementById('vps-api-key').value,
                        default_template: document.getElementById('vps-default-template').value,
                        templates: {},
                        is_enabled: document.getElementById('vps-enabled').checked
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('WordPress hosting settings saved!', 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        }
        
        // Load account website status when WordPress view is shown
        async function loadAccountWebsite() {
            const section = document.getElementById('wp-website-section');
            const noWebsite = document.getElementById('wp-no-website');
            const hasWebsite = document.getElementById('wp-has-website');
            const creating = document.getElementById('wp-website-creating');
            
            // Only show for selected accounts or non-master-admin users
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            const accountId = selectedAccountId || (user.role !== 'master_admin' ? user.id : null);
            
            if (!accountId) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            noWebsite.style.display = 'none';
            hasWebsite.style.display = 'none';
            creating.style.display = 'none';
            
            try {
                const response = await fetch(`/api/account/${accountId}/website`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const website = data.data;
                    
                    if (website.status === 'creating') {
                        creating.style.display = 'block';
                    } else {
                        hasWebsite.style.display = 'block';
                        
                        document.getElementById('wp-website-url').href = website.site_url || '#';
                        document.getElementById('wp-website-url').textContent = website.site_url || '-';
                        document.getElementById('wp-website-admin').href = website.admin_url || '#';
                        document.getElementById('wp-website-template').textContent = website.template_used || '-';
                        document.getElementById('wp-website-visit-btn').href = website.site_url || '#';
                        document.getElementById('wp-website-admin-btn').href = website.admin_url || '#';
                        
                        const statusBadge = document.getElementById('wp-website-status');
                        statusBadge.textContent = website.status;
                        statusBadge.className = 'badge ' + (website.status === 'active' ? 'badge-success' : 'badge-warning');
                    }
                } else {
                    noWebsite.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading website:', error);
                noWebsite.style.display = 'block';
            }
        }
        
        function openCreateWebsiteModal() {
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            const accountId = selectedAccountId || user.id;
            const accountName = selectedAccountName || user.name;
            
            document.getElementById('create-website-account-name').textContent = accountName;
            document.getElementById('create-website-name').value = accountName.toLowerCase().replace(/[^a-z0-9]/g, '');
            updateWebsitePreview();
            
            openModal('createWebsiteModal');
        }
        
        function updateWebsitePreview() {
            const name = document.getElementById('create-website-name').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
            document.getElementById('create-website-preview').textContent = name || 'yoursite';
        }
        
        // Add event listener for site name input
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('create-website-name');
            if (nameInput) {
                nameInput.addEventListener('input', updateWebsitePreview);
            }
        });
        
        async function createWebsite() {
            const user = currentAccount || JSON.parse(localStorage.getItem('gas_account') || '{}');
            const accountId = selectedAccountId || user.id;
            
            const siteName = document.getElementById('create-website-name').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
            const template = document.getElementById('create-website-template').value;
            
            if (!siteName) {
                showNotification('Please enter a site name', 'error');
                return;
            }
            
            const btn = document.getElementById('create-website-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Creating...';
            
            try {
                const response = await fetch('/api/admin/vps/create-site', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: accountId,
                        site_name: siteName,
                        template_slug: template || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('üéâ Website creation started!', 'success');
                    closeModal('createWebsiteModal');
                    loadAccountWebsite();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error creating website', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Create Website';
            }
        }
        
        async function refreshWebsiteStatus() {
            showNotification('Checking website status...', 'info', 2000);
            await loadAccountWebsite();
        }

        // =====================================================
        // PROPERTY PAYMENT SETTINGS
        // =====================================================
        
        let currentPaymentPropertyId = null;
        
        async function openPaymentSettings(propertyId, propertyName) {
            currentPaymentPropertyId = propertyId;
            document.getElementById('payment-settings-property-id').value = propertyId;
            document.getElementById('payment-settings-property-name').textContent = propertyName;
            
            // Reset form
            document.getElementById('payment-provider-stripe').checked = true;
            document.getElementById('stripe-publishable-key').value = '';
            document.getElementById('stripe-secret-key').value = '';
            document.getElementById('stripe-test-mode').checked = false;
            document.getElementById('stripe-keys-status').style.display = 'none';
            document.getElementById('setup-link-result').style.display = 'none';
            document.getElementById('payment-deposit-type').value = 'percentage';
            document.getElementById('payment-deposit-amount').value = 25;
            document.getElementById('payment-balance-days').value = 14;
            document.getElementById('payment-currency').value = 'GBP';
            document.getElementById('payment-cancellation').value = '';
            
            // Get property's account_id
            try {
                const propRes = await fetch(`/api/db/properties/${propertyId}`);
                const propData = await propRes.json();
                if (propData.success) {
                    document.getElementById('payment-settings-account-id').value = propData.data.account_id;
                }
            } catch (e) {
                console.error('Error getting property:', e);
            }
            
            // Load existing payment configuration
            try {
                const response = await fetch(`/api/properties/${propertyId}/payment-configuration`);
                const data = await response.json();
                
                if (data.success && data.configuration) {
                    const config = data.configuration;
                    
                    // Show configured status
                    const statusEl = document.getElementById('stripe-keys-status');
                    if (config.is_enabled) {
                        statusEl.innerHTML = '<span style="color: var(--success);">‚úÖ Stripe connected and enabled</span>';
                        statusEl.style.background = '#d1fae5';
                        statusEl.style.display = 'block';
                    }
                    
                    // Fill in publishable key (secret is hidden)
                    if (config.credentials?.publishable_key) {
                        document.getElementById('stripe-publishable-key').value = config.credentials.publishable_key;
                        document.getElementById('stripe-secret-key').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    }
                    
                    if (config.test_mode) {
                        document.getElementById('stripe-test-mode').checked = true;
                    }
                }
            } catch (error) {
                console.error('Error loading payment config:', error);
            }
            
            // Also load legacy payment settings
            try {
                const response = await fetch(`/api/property/${propertyId}/payment-settings`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const settings = data.data;
                    document.getElementById('payment-deposit-type').value = settings.deposit_type || 'percentage';
                    document.getElementById('payment-deposit-amount').value = settings.deposit_amount || 25;
                    document.getElementById('payment-balance-days').value = settings.balance_due_days || 14;
                    document.getElementById('payment-currency').value = settings.currency || 'GBP';
                    document.getElementById('payment-cancellation').value = settings.cancellation_policy || '';
                    
                    updateDepositSymbol();
                }
            } catch (error) {
                console.error('Error loading payment settings:', error);
            }
            
            openModal('paymentSettingsModal');
        }
        
        function updateDepositSymbol() {
            const type = document.getElementById('payment-deposit-type').value;
            const symbol = document.getElementById('payment-deposit-symbol');
            const amountInput = document.getElementById('payment-deposit-amount');
            
            if (type === 'percentage') {
                symbol.textContent = '%';
                amountInput.max = 100;
            } else if (type === 'fixed') {
                const currency = document.getElementById('payment-currency').value;
                symbol.textContent = currency === 'GBP' ? '¬£' : currency === 'EUR' ? '‚Ç¨' : currency === 'USD' ? '$' : currency;
                amountInput.max = 99999;
            } else if (type === 'full' || type === 'none') {
                symbol.textContent = '';
                amountInput.disabled = true;
            }
            
            if (type !== 'full' && type !== 'none') {
                amountInput.disabled = false;
            }
        }
        
        // Add event listener for deposit type change
        document.addEventListener('DOMContentLoaded', function() {
            const depositType = document.getElementById('payment-deposit-type');
            if (depositType) {
                depositType.addEventListener('change', updateDepositSymbol);
            }
            const currencySelect = document.getElementById('payment-currency');
            if (currencySelect) {
                currencySelect.addEventListener('change', updateDepositSymbol);
            }
        });
        
        async function savePaymentSettings() {
            const propertyId = document.getElementById('payment-settings-property-id').value;
            const accountId = document.getElementById('payment-settings-account-id').value;
            
            const publishableKey = document.getElementById('stripe-publishable-key').value.trim();
            const secretKey = document.getElementById('stripe-secret-key').value.trim();
            const testMode = document.getElementById('stripe-test-mode').checked;
            
            // If Stripe keys provided, save to payment_configurations
            if (publishableKey && secretKey) {
                try {
                    const configResponse = await fetch('/api/payment-configurations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({
                            account_id: parseInt(accountId),
                            property_id: parseInt(propertyId),
                            provider: 'stripe',
                            credentials: {
                                publishable_key: publishableKey,
                                secret_key: secretKey
                            },
                            is_enabled: true,
                            is_default: true,
                            test_mode: testMode
                        })
                    });
                    
                    const configData = await configResponse.json();
                    if (!configData.success) {
                        showNotification('Error saving Stripe keys: ' + configData.error, 'error');
                        return;
                    }
                } catch (error) {
                    showNotification('Error saving Stripe configuration', 'error');
                    return;
                }
            }
            
            // Save deposit/payment settings
            const settings = {
                payment_enabled: true,
                deposit_type: document.getElementById('payment-deposit-type').value,
                deposit_amount: parseFloat(document.getElementById('payment-deposit-amount').value) || 25,
                balance_due_days: parseInt(document.getElementById('payment-balance-days').value) || 14,
                currency: document.getElementById('payment-currency').value,
                accepted_methods: ['card'],
                cancellation_policy: document.getElementById('payment-cancellation').value
            };
            
            try {
                const response = await fetch(`/api/property/${propertyId}/payment-settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Payment settings saved!', 'success');
                    closeModal('paymentSettingsModal');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        }
        
        async function testStripeConnection() {
            const secretKey = document.getElementById('stripe-secret-key').value.trim();
            const publishableKey = document.getElementById('stripe-publishable-key').value.trim();
            
            if (!secretKey || !publishableKey) {
                showNotification('Please enter both Publishable Key and Secret Key', 'warning');
                return;
            }
            
            const statusEl = document.getElementById('stripe-keys-status');
            statusEl.innerHTML = '<span style="color: var(--text-secondary);">üîÑ Testing connection...</span>';
            statusEl.style.background = '#f1f5f9';
            statusEl.style.display = 'block';
            
            try {
                // Save temporarily to test
                const propertyId = document.getElementById('payment-settings-property-id').value;
                const accountId = document.getElementById('payment-settings-account-id').value;
                
                const response = await fetch('/api/payment-configurations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: parseInt(accountId),
                        property_id: parseInt(propertyId),
                        provider: 'stripe',
                        credentials: {
                            publishable_key: publishableKey,
                            secret_key: secretKey
                        },
                        is_enabled: false  // Don't enable until explicitly saved
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Now test the connection
                    const testResponse = await fetch(`/api/payment-configurations/${data.configuration.id}/test`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() }
                    });
                    
                    const testData = await testResponse.json();
                    
                    if (testData.success && testData.test_result?.success) {
                        statusEl.innerHTML = '<span style="color: var(--success);">‚úÖ Connection successful! Keys are valid.</span>';
                        statusEl.style.background = '#d1fae5';
                    } else {
                        statusEl.innerHTML = `<span style="color: var(--error);">‚ùå ${testData.test_result?.message || testData.error}</span>`;
                        statusEl.style.background = '#fee2e2';
                    }
                } else {
                    statusEl.innerHTML = `<span style="color: var(--error);">‚ùå ${data.error}</span>`;
                    statusEl.style.background = '#fee2e2';
                }
            } catch (error) {
                statusEl.innerHTML = '<span style="color: var(--error);">‚ùå Connection test failed</span>';
                statusEl.style.background = '#fee2e2';
            }
        }
        
        async function generatePaymentSetupLink() {
            const propertyId = document.getElementById('payment-settings-property-id').value;
            const accountId = document.getElementById('payment-settings-account-id').value;
            
            try {
                const response = await fetch('/api/payment-setup-tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: parseInt(accountId),
                        property_id: parseInt(propertyId),
                        provider: 'stripe',
                        expires_hours: 72
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('setup-link-url').value = data.setup_url;
                    document.getElementById('setup-link-result').style.display = 'block';
                    showNotification('Setup link generated!', 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error generating link', 'error');
            }
        }
        
        function copySetupLink() {
            const input = document.getElementById('setup-link-url');
            input.select();
            document.execCommand('copy');
            showNotification('Link copied to clipboard!', 'success');
        }

        // Load client-facing billing page
        async function loadMyBilling() {
            // Load plans
            try {
                const plansRes = await fetch('/api/billing/plans');
                const plansData = await plansRes.json();
                
                const plansContainer = document.getElementById('my-billing-plans');
                if (plansData.success && plansData.data.length > 0) {
                    plansContainer.innerHTML = plansData.data.map(plan => {
                        let features = plan.features;
                        if (typeof features === 'string') {
                            try { features = JSON.parse(features); } catch(e) { features = {}; }
                        }
                        
                        // Handle both old array format and new object format
                        let featuresList = [];
                        if (Array.isArray(features)) {
                            featuresList = features;
                        } else if (features && features.features_list) {
                            featuresList = features.features_list;
                        }
                        
                        const currencySymbol = plan.currency === 'GBP' ? '¬£' : plan.currency === 'EUR' ? '‚Ç¨' : '$';
                        return `
                        <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: center;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 1.2rem;">${plan.name}</h4>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1rem;">${plan.description || ''}</p>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent);">
                                ${currencySymbol}${parseFloat(plan.price_monthly).toFixed(2)}
                                <span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">/mo</span>
                            </div>
                            ${plan.price_yearly ? `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1rem;">or ${currencySymbol}${parseFloat(plan.price_yearly).toFixed(2)}/year</div>` : '<div style="margin-bottom: 1rem;"></div>'}
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                ${plan.max_properties ? plan.max_properties + ' properties' : 'Unlimited properties'}
                            </div>
                            <ul style="text-align: left; font-size: 0.8rem; color: var(--text-secondary); margin: 0 0 1rem 0; padding-left: 1.2rem;">
                                ${featuresList.slice(0, 5).map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            <button class="btn" style="width: 100%;" onclick="contactForPlan('${plan.name}')">Get Started</button>
                        </div>
                    `}).join('');
                } else {
                    plansContainer.innerHTML = '<p style="color: var(--text-secondary);">No plans available</p>';
                }
            } catch (e) {
                console.error('Error loading plans:', e);
            }
            
            // Load credit packages
            try {
                const creditsRes = await fetch('/api/billing/credit-packages');
                const creditsData = await creditsRes.json();
                
                const creditsContainer = document.getElementById('my-billing-credits');
                if (creditsData.success && creditsData.data.length > 0) {
                    creditsContainer.innerHTML = creditsData.data.map(pkg => {
                        const currencySymbol = pkg.currency === 'GBP' ? '¬£' : pkg.currency === 'EUR' ? '‚Ç¨' : '$';
                        const totalCredits = pkg.credits + (pkg.bonus_credits || 0);
                        return `
                        <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1.25rem; text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.25rem;">ü™ô</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">${totalCredits}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">credits</div>
                            ${pkg.bonus_credits > 0 ? `<div style="font-size: 0.75rem; color: var(--success); margin-bottom: 0.5rem;">+${pkg.bonus_credits} bonus!</div>` : ''}
                            <div style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">${currencySymbol}${parseFloat(pkg.price).toFixed(2)}</div>
                            <button class="btn btn-secondary" style="width: 100%;" onclick="contactForCredits('${pkg.name}')">Buy</button>
                        </div>
                    `}).join('');
                } else {
                    creditsContainer.innerHTML = '<p style="color: var(--text-secondary);">No credit packages available</p>';
                }
            } catch (e) {
                console.error('Error loading credits:', e);
            }
            
            // Load extras
            try {
                const extrasRes = await fetch('/api/billing/extras');
                const extrasData = await extrasRes.json();
                
                const extrasContainer = document.getElementById('my-billing-extras');
                if (extrasData.success && extrasData.data.length > 0) {
                    extrasContainer.innerHTML = extrasData.data.map(extra => `
                        <div style="border: 1px solid var(--border); border-radius: 12px; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem;">${extra.icon || 'üì¶'}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${extra.name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${extra.description || ''}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-weight: 700; color: var(--warning);">${extra.credit_cost}</div>
                                <div style="font-size: 0.7rem; color: var(--text-secondary);">credits</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    extrasContainer.innerHTML = '<p style="color: var(--text-secondary);">No extras available</p>';
                }
            } catch (e) {
                console.error('Error loading extras:', e);
            }
        }

        // Placeholder functions for purchase actions
        function contactForPlan(planName) {
            alert('To subscribe to the ' + planName + ' plan, please contact us at support@example.com');
        }

        function contactForCredits(packageName) {
            alert('To purchase ' + packageName + ', please contact us at support@example.com');
        }

        // =====================================================
        // BILLING FUNCTIONS
        // =====================================================

        // Show notification toast
        function showNotification(message, type = 'info', duration = 3000) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 9999;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 400px;
            `;
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            } else if (type === 'warning') {
                notification.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else {
                notification.style.background = 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after duration
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        async function setupBilling() {
            console.log('setupBilling called');
            try {
                const response = await fetch('/api/setup-billing');
                console.log('Response:', response);
                const data = await response.json();
                console.log('Data:', data);
                if (data.success) {
                    showNotification('Billing tables created!', 'success');
                    loadBillingOverview();
                    loadBillingPlans();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Setup billing error:', error);
                showNotification('Error setting up billing: ' + error.message, 'error');
                alert('Error: ' + error.message);
            }
        }

        async function loadBillingOverview() {
            try {
                const response = await fetch('/api/admin/billing/overview');
                const data = await response.json();
                
                // Hide setup button if we have data
                const setupSection = document.getElementById('billing-setup-section');
                if (setupSection) {
                    if (data.success) {
                        setupSection.style.display = 'none';
                    } else {
                        setupSection.style.display = 'block';
                    }
                }
                
                if (data.success) {
                    // Update MRR
                    document.getElementById('billing-mrr').textContent = '¬£' + data.mrr.toFixed(2);
                    
                    // Update active subs count
                    const totalSubs = data.subscriptions_by_plan.reduce((sum, p) => sum + parseInt(p.count), 0);
                    document.getElementById('billing-active-subs').textContent = totalSubs;
                    
                    // Update credits in circulation
                    document.getElementById('billing-credits-circulation').textContent = data.credits?.total_balance || 0;
                    
                    // Subscriptions by plan
                    const subsByPlan = document.getElementById('billing-subs-by-plan');
                    if (data.subscriptions_by_plan.length > 0) {
                        subsByPlan.innerHTML = data.subscriptions_by_plan.map(p => `
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                                <span>${p.name}</span>
                                <span><strong>${p.count}</strong> subscribers √ó ¬£${parseFloat(p.price_monthly).toFixed(2)} = <strong>¬£${parseFloat(p.mrr).toFixed(2)}</strong>/mo</span>
                            </div>
                        `).join('');
                    } else {
                        subsByPlan.innerHTML = '<p style="color: var(--text-secondary);">No active subscriptions yet</p>';
                    }
                    
                    // Recent payments
                    const paymentsTable = document.getElementById('billing-recent-payments');
                    if (data.recent_payments.length > 0) {
                        paymentsTable.innerHTML = data.recent_payments.map(p => `
                            <tr>
                                <td>${p.account_name}</td>
                                <td>¬£${parseFloat(p.amount).toFixed(2)}</td>
                                <td><span class="badge">${p.type}</span></td>
                                <td>${new Date(p.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('');
                    } else {
                        paymentsTable.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No payments yet</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Error loading billing overview:', error);
            }
        }

        // Plans
        async function loadBillingPlans() {
            try {
                const response = await fetch('/api/admin/billing/plans');
                const data = await response.json();
                
                const container = document.getElementById('billing-plans-list');
                
                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.map(plan => {
                        let features = plan.features;
                        if (typeof features === 'string') {
                            try { features = JSON.parse(features); } catch(e) { features = {}; }
                        }
                        
                        // Handle both old array format and new object format
                        let featuresList = [];
                        if (Array.isArray(features)) {
                            featuresList = features;
                        } else if (features.features_list) {
                            featuresList = features.features_list;
                        } else {
                            // Build from object
                            if (features.properties) featuresList.push(features.properties === null ? 'Unlimited properties' : features.properties + ' properties');
                            if (features.websites) featuresList.push(features.websites + ' website' + (features.websites > 1 ? 's' : ''));
                            if (features.booking_plugin) featuresList.push('Booking plugin');
                            if (features.blog_module) featuresList.push('Blog module');
                            if (features.attractions_module) featuresList.push('Attractions module');
                            if (features.reviews_widget) featuresList.push('Reviews widget');
                            if (features.support) featuresList.push(features.support.charAt(0).toUpperCase() + features.support.slice(1) + ' support');
                            if (features.free_trial) featuresList.push('14-day free trial');
                            if (features.white_label) featuresList.push('White-label');
                        }
                        
                        return `
                        <div class="card" style="position: relative; ${!plan.is_active ? 'opacity: 0.6;' : ''}">
                            <div style="position: absolute; top: 1rem; right: 1rem; display: flex; gap: 0.5rem;">
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="editPlan(${plan.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; color: var(--error);" onclick="deletePlan(${plan.id})">√ó</button>
                            </div>
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem;">${plan.name}</h3>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">${plan.description || ''}</p>
                            <div style="font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem;">
                                ¬£${parseFloat(plan.price_monthly).toFixed(2)}<span style="font-size: 1rem; font-weight: 400; color: var(--text-secondary);">/mo</span>
                            </div>
                            ${plan.price_yearly ? `<div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">or ¬£${parseFloat(plan.price_yearly).toFixed(2)}/year</div>` : ''}
                            <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">
                                <strong>Max properties:</strong> ${plan.max_properties || 'Unlimited'}
                            </div>
                            <ul style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; padding-left: 1.25rem;">
                                ${featuresList.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            ${!plan.is_active ? '<div style="margin-top: 1rem;"><span class="badge badge-warning">Inactive</span></div>' : ''}
                        </div>
                    `}).join('');
                } else {
                    container.innerHTML = '<div class="card" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No plans configured. Click "Setup Billing" in Overview first.</div>';
                }
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }

        function openPlanModal() {
            document.getElementById('plan-id').value = '';
            document.getElementById('plan-name').value = '';
            document.getElementById('plan-slug').value = '';
            document.getElementById('plan-description').value = '';
            document.getElementById('plan-price-monthly').value = '';
            document.getElementById('plan-price-yearly').value = '';
            document.getElementById('plan-currency').value = 'GBP';
            document.getElementById('plan-max-properties').value = '';
            document.getElementById('plan-features').value = '';
            document.getElementById('plan-sort-order').value = '0';
            document.getElementById('plan-is-active').checked = true;
            document.getElementById('plan-modal-title').textContent = 'üí≥ Add Subscription Plan';
            openModal('billingPlanModal');
        }

        async function editPlan(id) {
            try {
                const response = await fetch('/api/admin/billing/plans');
                const data = await response.json();
                const plan = data.data.find(p => p.id === id);
                
                if (plan) {
                    document.getElementById('plan-id').value = plan.id;
                    document.getElementById('plan-name').value = plan.name;
                    document.getElementById('plan-slug').value = plan.slug;
                    document.getElementById('plan-description').value = plan.description || '';
                    document.getElementById('plan-price-monthly').value = plan.price_monthly;
                    document.getElementById('plan-price-yearly').value = plan.price_yearly || '';
                    document.getElementById('plan-currency').value = plan.currency || 'GBP';
                    document.getElementById('plan-max-properties').value = plan.max_properties || '';
                    document.getElementById('plan-sort-order').value = plan.sort_order || 0;
                    document.getElementById('plan-is-active').checked = plan.is_active;
                    
                    // Handle features - can be array or object with features_list
                    let features = typeof plan.features === 'string' ? JSON.parse(plan.features) : (plan.features || {});
                    let featuresList = [];
                    if (Array.isArray(features)) {
                        featuresList = features;
                    } else if (features.features_list) {
                        featuresList = features.features_list;
                    }
                    document.getElementById('plan-features').value = featuresList.join('\n');
                    
                    document.getElementById('plan-modal-title').textContent = 'üí≥ Edit Plan';
                    openModal('billingPlanModal');
                }
            } catch (error) {
                console.error('Error editing plan:', error);
                showNotification('Error loading plan', 'error');
            }
        }

        async function savePlan(event) {
            event.preventDefault();
            
            const featuresText = document.getElementById('plan-features').value;
            const featuresList = featuresText.split('\n').map(f => f.trim()).filter(f => f.length > 0);
            
            // Build features object with features_list
            const maxProps = document.getElementById('plan-max-properties').value ? parseInt(document.getElementById('plan-max-properties').value) : null;
            const features = {
                properties: maxProps,
                websites: 1,
                booking_plugin: true,
                features_list: featuresList
            };
            
            const planData = {
                id: document.getElementById('plan-id').value || undefined,
                name: document.getElementById('plan-name').value,
                slug: document.getElementById('plan-slug').value || undefined,
                description: document.getElementById('plan-description').value,
                price_monthly: parseFloat(document.getElementById('plan-price-monthly').value),
                price_yearly: document.getElementById('plan-price-yearly').value ? parseFloat(document.getElementById('plan-price-yearly').value) : null,
                currency: document.getElementById('plan-currency').value,
                max_properties: maxProps,
                features: features,
                sort_order: parseInt(document.getElementById('plan-sort-order').value) || 0,
                is_active: document.getElementById('plan-is-active').checked
            };
            
            try {
                const response = await fetch('/api/admin/billing/plans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(planData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Plan saved!', 'success');
                    closeModal('billingPlanModal');
                    loadBillingPlans();
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Error saving plan', 'error');
            }
        }

        async function deletePlan(id) {
            if (!confirm('Delete this plan?')) return;
            
            try {
                const response = await fetch('/api/admin/billing/plans/' + id, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    showNotification('Plan deleted', 'success');
                    loadBillingPlans();
                }
            } catch (error) {
                showNotification('Error deleting plan', 'error');
            }
        }

        // =====================================================
        // PRODUCTS
        // =====================================================
        async function loadBillingProducts() {
            try {
                const response = await fetch('/api/admin/billing/products');
                const data = await response.json();
                
                const tbody = document.getElementById('billing-products-table');
                
                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(p => `
                        <tr style="${!p.is_active ? 'opacity: 0.6;' : ''}">
                            <td>
                                <strong>${p.name}</strong>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${p.code}</div>
                            </td>
                            <td><span class="badge">${p.category || 'general'}</span></td>
                            <td>${p.price_monthly > 0 ? '¬£' + parseFloat(p.price_monthly).toFixed(2) + '/mo' : '-'}</td>
                            <td>${p.price_yearly > 0 ? '¬£' + parseFloat(p.price_yearly).toFixed(2) + '/yr' : '-'}</td>
                            <td><span class="badge ${p.is_active ? 'badge-success' : 'badge-warning'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editProduct(${p.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: var(--error);" onclick="deleteProduct(${p.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No products yet. Click "+ Add Product" to create one.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('billing-products-table').innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--error);">Error loading products</td></tr>';
            }
        }

        function openProductModal(product = null) {
            document.getElementById('product-modal-title').textContent = product ? 'üì¶ Edit Product' : 'üì¶ Add Product';
            document.getElementById('product-id').value = product?.id || '';
            document.getElementById('product-code').value = product?.code || '';
            document.getElementById('product-name').value = product?.name || '';
            document.getElementById('product-description').value = product?.description || '';
            document.getElementById('product-category').value = product?.category || 'general';
            document.getElementById('product-price-monthly').value = product?.price_monthly || '';
            document.getElementById('product-price-yearly').value = product?.price_yearly || '';
            document.getElementById('product-is-active').checked = product?.is_active !== false;
            openModal('productModal');
        }

        async function editProduct(id) {
            try {
                const response = await fetch('/api/admin/billing/products');
                const data = await response.json();
                const product = data.data.find(p => p.id === id);
                if (product) openProductModal(product);
            } catch (error) {
                showNotification('Error loading product', 'error');
            }
        }

        async function saveProduct(event) {
            event.preventDefault();
            
            const id = document.getElementById('product-id').value;
            const productData = {
                code: document.getElementById('product-code').value,
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                category: document.getElementById('product-category').value,
                price_monthly: parseFloat(document.getElementById('product-price-monthly').value) || 0,
                price_yearly: parseFloat(document.getElementById('product-price-yearly').value) || 0,
                is_active: document.getElementById('product-is-active').checked
            };
            
            try {
                const url = id ? `/api/admin/billing/products/${id}` : '/api/admin/billing/products';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                if (data.success) {
                    closeModal('productModal');
                    showNotification(id ? 'Product updated' : 'Product created', 'success');
                    loadBillingProducts();
                } else {
                    showNotification(data.error || 'Error saving product', 'error');
                }
            } catch (error) {
                showNotification('Error saving product', 'error');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Delete this product?')) return;
            try {
                const response = await fetch(`/api/admin/billing/products/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    showNotification('Product deleted', 'success');
                    loadBillingProducts();
                }
            } catch (error) {
                showNotification('Error deleting product', 'error');
            }
        }

        // =====================================================
        // ADD-ONS
        // =====================================================
        async function loadBillingAddons() {
            try {
                const response = await fetch('/api/admin/billing/addons');
                const data = await response.json();
                
                const tbody = document.getElementById('billing-addons-table');
                
                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(a => `
                        <tr style="${!a.is_active ? 'opacity: 0.6;' : ''}">
                            <td>
                                <strong>${a.name}</strong>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">${a.description || ''}</div>
                            </td>
                            <td>¬£${parseFloat(a.price_monthly).toFixed(2)}/mo</td>
                            <td>${a.extra_properties > 0 ? '+' + a.extra_properties : '-'}</td>
                            <td><span class="badge ${a.is_active ? 'badge-success' : 'badge-warning'}">${a.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="editAddon(${a.id})">Edit</button>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; color: var(--error);" onclick="deleteAddon(${a.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No add-ons yet. Click "+ Add Add-on" to create one.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading addons:', error);
            }
        }

        function openAddonModal(addon = null) {
            document.getElementById('addon-modal-title').textContent = addon ? 'üß© Edit Add-on' : 'üß© Add Add-on';
            document.getElementById('addon-id').value = addon?.id || '';
            document.getElementById('addon-code').value = addon?.code || '';
            document.getElementById('addon-name').value = addon?.name || '';
            document.getElementById('addon-description').value = addon?.description || '';
            document.getElementById('addon-price-monthly').value = addon?.price_monthly || '';
            document.getElementById('addon-extra-properties').value = addon?.extra_properties || '0';
            document.getElementById('addon-is-active').checked = addon?.is_active !== false;
            openModal('addonModal');
        }

        async function editAddon(id) {
            try {
                const response = await fetch('/api/admin/billing/addons');
                const data = await response.json();
                const addon = data.data.find(a => a.id === id);
                if (addon) openAddonModal(addon);
            } catch (error) {
                showNotification('Error loading add-on', 'error');
            }
        }

        async function saveAddon(event) {
            event.preventDefault();
            
            const id = document.getElementById('addon-id').value;
            const addonData = {
                code: document.getElementById('addon-code').value,
                name: document.getElementById('addon-name').value,
                description: document.getElementById('addon-description').value,
                price_monthly: parseFloat(document.getElementById('addon-price-monthly').value) || 0,
                extra_properties: parseInt(document.getElementById('addon-extra-properties').value) || 0,
                is_active: document.getElementById('addon-is-active').checked
            };
            
            try {
                const url = id ? `/api/admin/billing/addons/${id}` : '/api/admin/billing/addons';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(addonData)
                });
                
                const data = await response.json();
                if (data.success) {
                    closeModal('addonModal');
                    showNotification(id ? 'Add-on updated' : 'Add-on created', 'success');
                    loadBillingAddons();
                } else {
                    showNotification(data.error || 'Error saving add-on', 'error');
                }
            } catch (error) {
                showNotification('Error saving add-on', 'error');
            }
        }

        async function deleteAddon(id) {
            if (!confirm('Delete this add-on?')) return;
            try {
                const response = await fetch(`/api/admin/billing/addons/${id}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    showNotification('Add-on deleted', 'success');
                    loadBillingAddons();
                }
            } catch (error) {
                showNotification('Error deleting add-on', 'error');
            }
        }

        // =====================================================
        // SUBSCRIBERS
        // =====================================================
        async function loadSubscribers() {
            const planFilter = document.getElementById('subscribers-filter-plan')?.value || '';
            const statusFilter = document.getElementById('subscribers-filter-status')?.value || '';
            
            try {
                let url = '/api/admin/billing/subscriptions?';
                if (planFilter) url += `plan=${planFilter}&`;
                if (statusFilter) url += `status=${statusFilter}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                const tbody = document.getElementById('billing-subscribers-table');
                
                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(s => {
                        const statusColors = {
                            'active': 'badge-success',
                            'trialing': 'badge-info',
                            'past_due': 'badge-warning',
                            'cancelled': 'badge-error'
                        };
                        return `
                        <tr>
                            <td><strong>${s.account_name || 'Account #' + s.account_id}</strong></td>
                            <td>${s.plan_code || 'None'}</td>
                            <td>${s.addon_count || 0} add-ons</td>
                            <td>¬£${parseFloat(s.mrr || 0).toFixed(2)}</td>
                            <td><span class="badge ${statusColors[s.status] || ''}">${s.status}</span></td>
                            <td>${s.created_at ? new Date(s.created_at).toLocaleDateString() : '-'}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="viewSubscription(${s.id})">View</button>
                            </td>
                        </tr>
                    `}).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">No subscribers yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading subscribers:', error);
            }
        }

        function viewSubscription(id) {
            alert('Subscription details coming soon! ID: ' + id);
        }

        // =====================================================
        // AFFILIATE FUNCTIONS
        // =====================================================
        
        async function loadAffiliatesAdmin() {
            try {
                const response = await fetch('/api/admin/affiliates');
                const data = await response.json();
                
                const tbody = document.getElementById('billing-affiliates-table');
                
                if (data.success && data.data && data.data.length > 0) {
                    // Update stats
                    document.getElementById('affiliate-total-count').textContent = data.data.length;
                    document.getElementById('affiliate-active-referrals').textContent = 
                        data.data.reduce((sum, a) => sum + (a.active_referrals || 0), 0);
                    
                    tbody.innerHTML = data.data.map(a => {
                        const tierColors = { bronze: '#CD7F32', silver: '#C0C0C0', gold: '#FFD700' };
                        const tierIcons = { bronze: 'ü•â', silver: 'ü•à', gold: 'ü•á' };
                        return `
                        <tr>
                            <td><strong>${a.account_name || 'Account #' + a.account_id}</strong></td>
                            <td>
                                <span style="color: ${tierColors[a.tier_code] || '#666'};">
                                    ${tierIcons[a.tier_code] || ''} ${a.tier_code || 'bronze'}
                                </span>
                            </td>
                            <td><code>${a.referral_code}</code></td>
                            <td>${a.active_referrals || 0}</td>
                            <td>¬£${parseFloat(a.lifetime_earnings || 0).toFixed(2)}</td>
                            <td>¬£${parseFloat(a.pending_amount || 0).toFixed(2)}</td>
                            <td>
                                <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="viewAffiliateDetails(${a.id})">View</button>
                            </td>
                        </tr>
                    `}).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">No affiliates yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading affiliates:', error);
            }
        }
        
        function viewAffiliateDetails(id) {
            alert('Affiliate details coming soon! ID: ' + id);
        }
        
        async function loadMyReferrals() {
            try {
                const response = await fetch('/api/affiliate/me');
                const data = await response.json();
                
                if (data.success && data.affiliate) {
                    // User is an affiliate - show dashboard
                    document.getElementById('affiliate-signup-card').style.display = 'none';
                    document.getElementById('affiliate-dashboard').style.display = 'block';
                    
                    const a = data.affiliate;
                    const tierIcons = { bronze: 'ü•â', silver: 'ü•à', gold: 'ü•á' };
                    const tierNames = { bronze: 'Bronze', silver: 'Silver', gold: 'Gold' };
                    const commissionRates = { bronze: '5%', silver: '10%', gold: '15%' };
                    
                    document.getElementById('my-tier-icon').textContent = tierIcons[a.tier_code] || 'ü•â';
                    document.getElementById('my-tier-name').textContent = tierNames[a.tier_code] || 'Bronze';
                    document.getElementById('my-commission-rate').textContent = commissionRates[a.tier_code] || '5%';
                    document.getElementById('my-referral-link').value = a.referral_link || `https://gas.travel/ref/${a.referral_code}`;
                    
                    document.getElementById('my-earnings-month').textContent = '¬£' + parseFloat(a.month_earnings || 0).toFixed(2);
                    document.getElementById('my-earnings-pending').textContent = '¬£' + parseFloat(a.pending_amount || 0).toFixed(2);
                    document.getElementById('my-earnings-lifetime').textContent = '¬£' + parseFloat(a.lifetime_earnings || 0).toFixed(2);
                    document.getElementById('my-referral-count').textContent = a.active_referrals || 0;
                    
                    // Enable payout button if enough balance
                    const payoutBtn = document.getElementById('request-payout-btn');
                    if ((a.pending_amount || 0) >= 50) {
                        payoutBtn.disabled = false;
                    } else {
                        payoutBtn.disabled = true;
                    }
                    
                    // Tier progress
                    const referralsToSilver = Math.max(0, 5 - (a.active_referrals || 0));
                    const referralsToGold = Math.max(0, 10 - (a.active_referrals || 0));
                    const tierProgress = document.getElementById('tier-progress');
                    
                    if (a.tier_code === 'gold') {
                        tierProgress.innerHTML = '<p style="margin: 0; font-size: 0.9rem; color: #92400e;">üèÜ You\'ve reached the top tier!</p>';
                    } else if (a.tier_code === 'silver') {
                        tierProgress.innerHTML = `<p style="margin: 0; font-size: 0.9rem; color: #92400e;">${referralsToGold} more referrals to reach Gold!</p>`;
                    } else {
                        tierProgress.innerHTML = `<p style="margin: 0; font-size: 0.9rem; color: #92400e;">${referralsToSilver} more referrals to reach Silver!</p>`;
                    }
                    
                    // Load referrals list
                    loadMyReferralsList();
                    
                } else {
                    // Not an affiliate - show signup
                    document.getElementById('affiliate-signup-card').style.display = 'block';
                    document.getElementById('affiliate-dashboard').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading affiliate data:', error);
                // Show signup card on error
                document.getElementById('affiliate-signup-card').style.display = 'block';
                document.getElementById('affiliate-dashboard').style.display = 'none';
            }
        }
        
        async function loadMyReferralsList() {
            try {
                const response = await fetch('/api/affiliate/referrals');
                const data = await response.json();
                
                const tbody = document.getElementById('my-referrals-table');
                
                if (data.success && data.referrals && data.referrals.length > 0) {
                    tbody.innerHTML = data.referrals.map(r => {
                        const statusColors = {
                            'pending': 'badge-warning',
                            'active': 'badge-success',
                            'churned': 'badge-error',
                            'cancelled': 'badge-secondary'
                        };
                        return `
                        <tr>
                            <td>${r.account_name || 'Property #' + r.referred_account_id}</td>
                            <td>${r.signed_up_at ? new Date(r.signed_up_at).toLocaleDateString() : '-'}</td>
                            <td>${r.plan_code || 'Free'}</td>
                            <td><span class="badge ${statusColors[r.status] || ''}">${r.status}</span></td>
                            <td>¬£${parseFloat(r.total_commission || 0).toFixed(2)}</td>
                        </tr>
                    `}).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No referrals yet. Share your link to get started!</td></tr>';
                }
            } catch (error) {
                console.error('Error loading referrals:', error);
            }
        }
        
        async function joinAffiliateProgram() {
            try {
                const response = await fetch('/api/affiliate/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('üéâ Welcome to the affiliate program!', 'success');
                    loadMyReferrals();
                } else {
                    showNotification(data.error || 'Error joining program', 'error');
                }
            } catch (error) {
                showNotification('Error joining affiliate program', 'error');
            }
        }
        
        function copyReferralLink() {
            const input = document.getElementById('my-referral-link');
            input.select();
            document.execCommand('copy');
            showNotification('üìã Referral link copied!', 'success');
        }
        
        async function requestPayout() {
            if (!confirm('Request payout of your pending balance?')) return;
            
            try {
                const response = await fetch('/api/affiliate/payout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() }
                });
                const data = await response.json();
                
                if (data.success) {
                    showNotification('üí∏ Payout requested! Processing within 7 days.', 'success');
                    loadMyReferrals();
                } else {
                    showNotification(data.error || 'Error requesting payout', 'error');
                }
            } catch (error) {
                showNotification('Error requesting payout', 'error');
            }
        }

        // Handle URL hash and query params (for Stripe redirect)
        function handleUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const hash = window.location.hash.replace('#', '').split('?')[0];
            
            // Check for Stripe connection status
            if (urlParams.get('stripe_connected') === 'true') {
                setTimeout(() => {
                    showNotification('Stripe connected successfully!', 'success');
                }, 500);
            }
            if (urlParams.get('stripe_error')) {
                setTimeout(() => {
                    showNotification('Stripe error: ' + urlParams.get('stripe_error'), 'error');
                }, 500);
            }
            
            // Navigate to hash view if specified
            if (hash && document.getElementById(hash)) {
                setTimeout(() => {
                    const navItem = document.querySelector(`.nav-item[data-view="${hash}"]`);
                    if (navItem) {
                        navClick(navItem, hash);
                    } else {
                        showView(hash);
                    }
                }, 100);
            }
            
            // Clean up URL
            if (urlParams.get('stripe_connected') || urlParams.get('stripe_error')) {
                window.history.replaceState({}, document.title, window.location.pathname + (hash ? '#' + hash : ''));
            }
        }

        // Initial load
        loadClientSelector();
        loadDashboard();
        handleUrlParams();

        // =====================================================
        // GASSYNC JAVASCRIPT FUNCTIONS
        // =====================================================

        let gasSyncConnections = [];
        let gasSyncAdapters = [];
        let selectedConnectionId = null;

        // Dashboard
        async function loadGasSyncDashboard() {
            try {
                const response = await fetch('/api/gas-sync/status', { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('syncStatConnections').textContent = data.stats.active_connections || 0;
                    document.getElementById('syncStatProperties').textContent = data.stats.total_properties || 0;
                    document.getElementById('syncStatRoomTypes').textContent = data.stats.total_room_types || 0;
                    document.getElementById('syncStatReservations').textContent = data.stats.active_reservations || 0;
                    document.getElementById('syncStatImages').textContent = data.stats.total_images || 0;
                    document.getElementById('syncStatErrors').textContent = data.stats.error_connections || 0;
                    
                    const tbody = document.getElementById('recentActivityTable');
                    if (data.recent_activity && data.recent_activity.length > 0) {
                        tbody.innerHTML = data.recent_activity.map(activity => `
                            <tr>
                                <td>${formatDateTime(activity.started_at)}</td>
                                <td><span class="badge">${activity.adapter_code}</span></td>
                                <td>${activity.sync_type}</td>
                                <td><span class="status-badge status-${activity.status}">${activity.status}</span></td>
                                <td>${activity.records_processed || 0}</td>
                                <td>${activity.duration_ms ? (activity.duration_ms / 1000).toFixed(1) + 's' : '-'}</td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--text-secondary);">No recent activity</td></tr>';
                    }
                }
                
                await loadConnectionStatus();
            } catch (error) {
                console.error('Error loading GasSync dashboard:', error);
            }
        }

        async function loadConnectionStatus() {
            try {
                const response = await fetch('/api/gas-sync/connections' + buildQueryString(), { headers: authHeaders() });
                const data = await response.json();
                
                const container = document.getElementById('connectionStatusList');
                
                if (data.success && data.connections.length > 0) {
                    container.innerHTML = data.connections.map(conn => `
                        <div class="connection-status-item">
                            <div class="status-dot ${conn.status}"></div>
                            <div style="flex: 1;">
                                <strong>${conn.connection_name || conn.external_account_name || conn.adapter_name}</strong>
                                <div style="font-size: 12px; color: #6b7280;">
                                    ${conn.adapter_name} ‚Ä¢ ${conn.property_count} properties
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 12px; color: #6b7280;">
                                ${conn.last_sync_at ? 'Synced ' + formatTimeAgo(conn.last_sync_at) : 'Never synced'}
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="triggerSync(${conn.id})">üîÑ</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üîå</div>
                            <h4>No Connections Yet</h4>
                            <p style="color: var(--text-secondary);">Connect your first channel manager</p>
                            <button class="btn btn-primary" onclick="showView('gas-sync-connections'); setTimeout(showAddConnectionModal, 100);">
                                ‚ûï Add Connection
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading connection status:', error);
            }
        }

        // Simple client connection view
        async function loadClientConnectionView() {
            const container = document.getElementById('clientConnectionInfo');
            try {
                const response = await fetch('/api/gas-sync/connections' + buildQueryString(), { headers: authHeaders() });
                const data = await response.json();
                
                if (data.success && data.connections && data.connections.length > 0) {
                    const conn = data.connections[0];
                    
                    // Fetch properties for this connection
                    let propertiesHtml = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No properties synced</td></tr>';
                    try {
                        const propsResponse = await fetch(`/api/gas-sync/connections/${conn.id}/properties`, { headers: authHeaders() });
                        const propsData = await propsResponse.json();
                        if (propsData.success && propsData.properties && propsData.properties.length > 0) {
                            const rows = [];
                            for (const prop of propsData.properties) {
                                const roomsResponse = await fetch(`/api/gas-sync/properties/${prop.id}/room-types`, { headers: authHeaders() });
                                const roomsData = await roomsResponse.json();
                                const roomCount = roomsData.success ? roomsData.room_types.length : 0;
                                
                                rows.push(`
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">${prop.name.charAt(0)}</div>
                                                <div>
                                                    <strong>${prop.name}</strong>
                                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${prop.city || ''} ${prop.country || ''}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td><span class="connection-status-badge connected">${conn.adapter_name}</span></td>
                                        <td>${roomCount} rooms</td>
                                        <td><span class="connection-status-badge ${conn.status}">${conn.status}</span></td>
                                    </tr>
                                `);
                            }
                            propertiesHtml = rows.join('');
                        }
                    } catch (e) {
                        console.error('Error fetching properties:', e);
                    }
                    
                    container.innerHTML = `
                        <div class="table-container">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Property</th>
                                        <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Channel</th>
                                        <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Rooms</th>
                                        <th style="text-align: left; padding: 12px 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${propertiesHtml}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üîå</div>
                            <h3>No Connection</h3>
                            <p style="color: var(--text-secondary);">No channel manager connected yet.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading client connection:', error);
                container.innerHTML = '<p style="color: var(--text-secondary);">Error loading connection info.</p>';
            }
        }

        // Connections
        async function loadGasSyncConnections() {
            try {
                const response = await fetch('/api/gas-sync/connections' + buildQueryString(), { headers: authHeaders() });
                const data = await response.json();
                
                gasSyncConnections = data.connections || [];
                
                const grid = document.getElementById('connectionsGrid');
                const isMaster = currentAccount && currentAccount.role === 'master_admin';
                const isViewingClient = selectedAccountId !== null;
                const showControls = isMaster && !isViewingClient;
                
                if (gasSyncConnections.length > 0) {
                    grid.innerHTML = gasSyncConnections.map(conn => `
                        <div class="connection-card status-${conn.status}">
                            <div class="connection-card-header">
                                <div class="connection-logo">${getAdapterEmoji(conn.adapter_code)}</div>
                                <div class="connection-info">
                                    <h4>${conn.connection_name || conn.external_account_name || 'Unnamed'}</h4>
                                    <div class="adapter-name">${conn.adapter_name}</div>
                                </div>
                                <span class="connection-status-badge ${conn.status}">${conn.status}</span>
                            </div>
                            
                            <div class="connection-stats">
                                <div class="connection-stat">
                                    <div class="connection-stat-value">${conn.property_count || 0}</div>
                                    <div class="connection-stat-label">Properties</div>
                                </div>
                                <div class="connection-stat">
                                    <div class="connection-stat-value">${conn.room_type_count || 0}</div>
                                    <div class="connection-stat-label">Room Types</div>
                                </div>
                                <div class="connection-stat">
                                    <div class="connection-stat-value">${conn.reservation_count || 0}</div>
                                    <div class="connection-stat-label">Reservations</div>
                                </div>
                            </div>
                            
                            <div class="connection-meta">
                                ${conn.last_sync_at ? 'Last sync: ' + formatTimeAgo(conn.last_sync_at) : 'Never synced'}
                                ${conn.last_error ? '<br><span style="color: #ef4444;">Error: ' + conn.last_error.substring(0, 50) + '...</span>' : ''}
                            </div>
                            
                            ${showControls ? `
                            <div class="connection-actions">
                                <button class="btn btn-secondary btn-sm" onclick="triggerSync(${conn.id})">üîÑ Sync</button>
                                <button class="btn btn-secondary btn-sm" onclick="showConnectionDetails(${conn.id})">‚öôÔ∏è Details</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteConnection(${conn.id})">üóëÔ∏è</button>
                            </div>
                            ` : ''}
                        </div>
                    `).join('');
                } else {
                    if (showControls) {
                        grid.innerHTML = `
                            <div style="grid-column: 1 / -1; text-align: center; padding: 60px;">
                                <div style="font-size: 64px; margin-bottom: 20px;">üîå</div>
                                <h3>No Channel Managers Connected</h3>
                                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                                    Connect your channel managers to sync properties, availability, and reservations
                                </p>
                                <button class="btn btn-primary btn-lg" onclick="showAddConnectionModal()">
                                    ‚ûï Add Your First Connection
                                </button>
                            </div>
                        `;
                    } else {
                        grid.innerHTML = `
                            <div style="grid-column: 1 / -1; text-align: center; padding: 60px;">
                                <div style="font-size: 64px; margin-bottom: 20px;">üîå</div>
                                <h3>No Connections</h3>
                                <p style="color: var(--text-secondary);">
                                    Contact your administrator to set up a channel manager connection.
                                </p>
                            </div>
                        `;
                    }
                }
                
                populateConnectionFilters();
            } catch (error) {
                console.error('Error loading connections:', error);
            }
        }

        function populateConnectionFilters() {
            const filters = ['syncPropertiesConnectionFilter', 'syncLogsConnectionFilter'];
            filters.forEach(filterId => {
                const select = document.getElementById(filterId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">All Connections</option>' +
                        gasSyncConnections.map(c => `<option value="${c.id}">${c.connection_name || c.external_account_name || c.adapter_name}</option>`).join('');
                    select.value = currentValue;
                }
            });
        }

        function getAdapterEmoji(code) {
            const emojis = { beds24: 'üõèÔ∏è', hostaway: 'üè†', smoobu: 'üìÖ', calry: 'üîÑ', guesty: 'üë•', hostfully: '‚ú®', hospitable: 'üè°' };
            return emojis[code] || 'üì°';
        }

        async function triggerSync(connectionId, type = 'incremental') {
            try {
                showNotification('Starting sync...', 'info');
                const response = await fetch(`/api/gas-sync/connections/${connectionId}/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ type })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Sync started in background', 'success');
                    setTimeout(() => loadGasSyncConnections(), 3000);
                } else {
                    showNotification(data.error || 'Sync failed', 'error');
                }
            } catch (error) {
                showNotification('Failed to start sync', 'error');
            }
        }

        async function deleteConnection(connectionId) {
            if (!confirm('Delete this connection? All synced data will be removed.')) return;
            try {
                const response = await fetch(`/api/gas-sync/connections/${connectionId}`, { method: 'DELETE', headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    showNotification('Connection deleted', 'success');
                    loadGasSyncConnections();
                } else {
                    showNotification(data.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                showNotification('Failed to delete connection', 'error');
            }
        }

        // Add Connection Modal
        async function showAddConnectionModal() {
            try {
                const response = await fetch('/api/gas-sync/adapters', { headers: authHeaders() });
                const data = await response.json();
                gasSyncAdapters = data.adapters || [];
                
                const grid = document.getElementById('adapterGrid');
                grid.innerHTML = gasSyncAdapters.map(adapter => `
                    <div class="adapter-card" onclick="selectAdapter('${adapter.code}', '${adapter.name}')">
                        <div class="adapter-card-logo">${getAdapterEmoji(adapter.code)}</div>
                        <div class="adapter-card-name">${adapter.name}</div>
                    </div>
                `).join('');
                
                const accountsResponse = await fetch('/api/admin/accounts', { headers: authHeaders() });
                const accountsData = await accountsResponse.json();
                const accountSelect = document.getElementById('connectionAccountId');
                accountSelect.innerHTML = (accountsData.accounts || []).map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading adapters:', error);
            }
            
            showConnectionStep(1);
            document.getElementById('addConnectionModal').style.display = 'flex';
        }

        function showConnectionStep(step) {
            document.getElementById('connectionStep1').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('connectionStep2').style.display = step === 2 ? 'block' : 'none';
        }

        function selectAdapter(code, name) {
            document.getElementById('selectedAdapterCode').value = code;
            document.getElementById('selectedAdapterName').textContent = `Configure ${name}`;
            
            const fieldsContainer = document.getElementById('credentialFields');
            let fieldsHtml = '';
            
            if (code === 'beds24') {
                fieldsHtml = `
                    <div class="form-group"><label>API Token (V2)</label>
                        <input type="password" id="credToken" placeholder="Enter your Beds24 API token" required>
                        <div class="help-text">Get this from Beds24 ‚Üí Settings ‚Üí API</div></div>
                    <div class="form-group"><label>API Key (V1 - for images)</label>
                        <input type="password" id="credApiKey" placeholder="Optional: V1 API key for image sync">
                        <div class="help-text">Optional: Enables image download</div></div>
                    <div class="form-group"><label>Property Key (V1)</label>
                        <input type="text" id="credPropKey" placeholder="Optional: V1 property key"></div>
                `;
            } else if (code === 'calry') {
                fieldsHtml = `
                    <div class="form-group"><label>Calry API Token</label>
                        <input type="password" id="credToken" placeholder="Enter your Calry API token" required></div>
                    <div class="form-group"><label>Workspace ID</label>
                        <input type="text" id="credWorkspaceId" placeholder="Your Calry workspace ID" required></div>
                    <div class="form-group"><label>Integration Account ID</label>
                        <input type="text" id="credIntegrationAccountId" placeholder="The connected PMS account ID" required></div>
                `;
            } else {
                fieldsHtml = `<div class="form-group"><label>API Token</label>
                    <input type="password" id="credToken" placeholder="Enter API token" required></div>`;
            }
            
            fieldsContainer.innerHTML = fieldsHtml;
            showConnectionStep(2);
        }

        async function testAndSaveConnection() {
            const adapterCode = document.getElementById('selectedAdapterCode').value;
            const accountId = document.getElementById('connectionAccountId').value;
            const syncEnabled = document.getElementById('connectionSyncEnabled').checked;
            const syncInterval = document.getElementById('connectionSyncInterval').value;
            
            const credentials = {};
            const tokenEl = document.getElementById('credToken');
            const apiKeyEl = document.getElementById('credApiKey');
            const propKeyEl = document.getElementById('credPropKey');
            const workspaceIdEl = document.getElementById('credWorkspaceId');
            const integrationAccountIdEl = document.getElementById('credIntegrationAccountId');
            
            if (tokenEl?.value) credentials.token = tokenEl.value;
            if (apiKeyEl?.value) credentials.apiKey = apiKeyEl.value;
            if (propKeyEl?.value) credentials.propKey = propKeyEl.value;
            if (workspaceIdEl?.value) credentials.workspaceId = workspaceIdEl.value;
            if (integrationAccountIdEl?.value) credentials.integrationAccountId = integrationAccountIdEl.value;
            
            try {
                showNotification('Testing connection...', 'info');
                const response = await fetch('/api/gas-sync/connections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        account_id: accountId,
                        adapter_code: adapterCode,
                        credentials,
                        sync_enabled: syncEnabled,
                        sync_interval_minutes: parseInt(syncInterval)
                    })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Connection created! Initial sync starting...', 'success');
                    closeModal('addConnectionModal');
                    loadGasSyncConnections();
                } else {
                    showNotification(data.error || 'Connection failed', 'error');
                }
            } catch (error) {
                showNotification('Failed to create connection', 'error');
            }
        }

        // Connection Details Modal
        async function showConnectionDetails(connectionId) {
            selectedConnectionId = connectionId;
            document.getElementById('connectionDetailsModal').style.display = 'flex';
            showConnectionTab('overview');
        }

        async function showConnectionTab(tab) {
            document.querySelectorAll('.gas-sync-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.gas-sync-tab[onclick*="${tab}"]`)?.classList.add('active');
            document.querySelectorAll('.gas-sync-tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(`connectionTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
            
            if (tab === 'overview') await loadConnectionOverview();
            else if (tab === 'properties') await loadConnectionPropertiesTab();
            else if (tab === 'reservations') await loadConnectionReservationsTab();
            else if (tab === 'logs') await loadConnectionLogsTab();
            else if (tab === 'settings') loadConnectionSettingsTab();
        }

        async function loadConnectionOverview() {
            const container = document.getElementById('connectionTabOverview');
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    const conn = data.connection;
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4>Connection Info</h4>
                                <table style="width: 100%;"><tbody>
                                    <tr><td style="padding: 8px 0; color: #6b7280;">Adapter:</td><td>${conn.adapter_name}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #6b7280;">Status:</td><td><span class="status-badge status-${conn.status}">${conn.status}</span></td></tr>
                                    <tr><td style="padding: 8px 0; color: #6b7280;">External Account:</td><td>${conn.external_account_name || '-'}</td></tr>
                                    <tr><td style="padding: 8px 0; color: #6b7280;">Last Sync:</td><td>${conn.last_sync_at ? formatTimeAgo(conn.last_sync_at) : 'Never'}</td></tr>
                                </tbody></table>
                            </div>
                            <div>
                                <h4>Quick Actions</h4>
                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <button class="btn btn-primary" onclick="triggerSync(${conn.id}, 'full')">üîÑ Full Sync</button>
                                    <button class="btn btn-secondary" onclick="triggerSync(${conn.id}, 'incremental')">‚ö° Incremental Sync</button>
                                </div>
                                ${conn.last_error ? `<div style="margin-top: 15px; padding: 12px; background: #fee2e2; border-radius: 8px; color: #dc2626;"><strong>Last Error:</strong><br>${conn.last_error}</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = '<p style="color: #ef4444;">Error loading details</p>';
            }
        }

        async function loadConnectionPropertiesTab() {
            const container = document.getElementById('connectionTabProperties');
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}/properties`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success && data.properties.length > 0) {
                    container.innerHTML = `<table class="data-table"><thead><tr><th>Property</th><th>Location</th><th>Room Types</th><th>Images</th><th>Linked</th><th>Actions</th></tr></thead><tbody>
                        ${data.properties.map(p => `<tr>
                            <td><strong>${p.name}</strong><br><small style="color: #6b7280;">${p.external_id}</small></td>
                            <td>${p.city || ''}, ${p.country || ''}</td>
                            <td>${p.room_type_count}</td>
                            <td>${p.image_count}</td>
                            <td>${p.gas_property_id ? '‚úÖ' : '‚ùå'}</td>
                            <td>${!p.gas_property_id ? `<button class="btn btn-sm btn-primary" onclick="importSyncedProperty(${p.id})">Import</button>` : ''}
                                <button class="btn btn-sm btn-secondary" onclick="downloadPropertyImages(${p.id})">üì∑</button></td>
                        </tr>`).join('')}
                    </tbody></table>`;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No properties synced yet</p>';
                }
            } catch (error) {
                container.innerHTML = '<p style="color: #ef4444;">Error loading properties</p>';
            }
        }

        async function loadConnectionReservationsTab() {
            const container = document.getElementById('connectionTabReservations');
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}/reservations?limit=20`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success && data.reservations.length > 0) {
                    container.innerHTML = `<table class="data-table"><thead><tr><th>Guest</th><th>Property</th><th>Dates</th><th>Channel</th><th>Total</th><th>Status</th></tr></thead><tbody>
                        ${data.reservations.map(r => `<tr>
                            <td>${r.guest_first_name} ${r.guest_last_name}</td>
                            <td>${r.property_name || r.room_type_name || '-'}</td>
                            <td>${formatDate(r.check_in)} ‚Üí ${formatDate(r.check_out)}</td>
                            <td><span class="badge">${r.channel || 'Direct'}</span></td>
                            <td>${r.currency} ${r.total || 0}</td>
                            <td><span class="status-badge status-${r.status}">${r.status}</span></td>
                        </tr>`).join('')}
                    </tbody></table>`;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No reservations synced yet</p>';
                }
            } catch (error) {
                container.innerHTML = '<p style="color: #ef4444;">Error loading reservations</p>';
            }
        }

        async function loadConnectionLogsTab() {
            const container = document.getElementById('connectionTabLogs');
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}/logs?limit=20`, { headers: authHeaders() });
                const data = await response.json();
                if (data.success && data.logs.length > 0) {
                    container.innerHTML = `<table class="data-table"><thead><tr><th>Time</th><th>Type</th><th>Status</th><th>Records</th><th>Duration</th><th>Error</th></tr></thead><tbody>
                        ${data.logs.map(log => `<tr>
                            <td>${formatDateTime(log.started_at)}</td>
                            <td>${log.sync_type}</td>
                            <td><span class="status-badge status-${log.status}">${log.status}</span></td>
                            <td>${log.records_created || 0} / ${log.records_updated || 0} / ${log.records_failed || 0}</td>
                            <td>${log.duration_ms ? (log.duration_ms / 1000).toFixed(1) + 's' : '-'}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${log.error_message || '-'}</td>
                        </tr>`).join('')}
                    </tbody></table>`;
                } else {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No sync logs yet</p>';
                }
            } catch (error) {
                container.innerHTML = '<p style="color: #ef4444;">Error loading logs</p>';
            }
        }

        function loadConnectionSettingsTab() {
            const conn = gasSyncConnections.find(c => c.id === selectedConnectionId);
            if (!conn) return;
            const container = document.getElementById('connectionTabSettings');
            container.innerHTML = `
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="settingSyncEnabled" ${conn.sync_enabled ? 'checked' : ''}>
                        Enable automatic sync
                    </label>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Sync Interval</label>
                    <select id="settingSyncInterval" class="form-control">
                        <option value="5" ${conn.sync_interval_minutes == 5 ? 'selected' : ''}>Every 5 minutes</option>
                        <option value="15" ${conn.sync_interval_minutes == 15 ? 'selected' : ''}>Every 15 minutes</option>
                        <option value="30" ${conn.sync_interval_minutes == 30 ? 'selected' : ''}>Every 30 minutes</option>
                        <option value="60" ${conn.sync_interval_minutes == 60 ? 'selected' : ''}>Every hour</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px;">Account Name</label>
                    <input type="text" id="settingAccountName" class="form-control" value="${conn.external_account_name || ''}" placeholder="Display name">
                </div>
                <button class="btn btn-primary" onclick="saveConnectionSettings()">Save Settings</button>
                <hr style="margin: 30px 0;">
                <h4 style="color: #ef4444;">Danger Zone</h4>
                <button class="btn btn-danger" onclick="deleteConnection(${conn.id}); closeModal('connectionDetailsModal');">üóëÔ∏è Delete Connection</button>
            `;
        }

        async function saveConnectionSettings() {
            try {
                const response = await fetch(`/api/gas-sync/connections/${selectedConnectionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({
                        sync_enabled: document.getElementById('settingSyncEnabled').checked,
                        sync_interval_minutes: parseInt(document.getElementById('settingSyncInterval').value),
                        external_account_name: document.getElementById('settingAccountName').value
                    })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification('Settings saved', 'success');
                    loadGasSyncConnections();
                } else {
                    showNotification(data.error || 'Failed to save', 'error');
                }
            } catch (error) {
                showNotification('Failed to save settings', 'error');
            }
        }

        async function importSyncedProperty(syncPropertyId) {
            const accountId = selectedAccountId || currentAccount.id;
            try {
                showNotification('Importing property...', 'info');
                const response = await fetch(`/api/gas-sync/properties/${syncPropertyId}/import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ account_id: accountId })
                });
                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadConnectionPropertiesTab();
                } else {
                    showNotification(data.error || 'Import failed', 'error');
                }
            } catch (error) {
                showNotification('Failed to import property', 'error');
            }
        }

        async function downloadPropertyImages(syncPropertyId) {
            try {
                showNotification('Downloading images...', 'info');
                const response = await fetch(`/api/gas-sync/properties/${syncPropertyId}/download-images`, { method: 'POST', headers: authHeaders() });
                const data = await response.json();
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadConnectionPropertiesTab();
                } else {
                    showNotification(data.error || 'Download failed', 'error');
                }
            } catch (error) {
                showNotification('Failed to download images', 'error');
            }
        }

        // Synced Properties View
        async function loadSyncedProperties() {
            const connectionId = document.getElementById('syncPropertiesConnectionFilter')?.value;
            try {
                let properties = [];
                if (connectionId) {
                    const response = await fetch(`/api/gas-sync/connections/${connectionId}/properties`, { headers: authHeaders() });
                    const data = await response.json();
                    properties = data.properties || [];
                } else {
                    for (const conn of gasSyncConnections) {
                        const response = await fetch(`/api/gas-sync/connections/${conn.id}/properties`, { headers: authHeaders() });
                        const data = await response.json();
                        if (data.properties) {
                            properties = properties.concat(data.properties.map(p => ({...p, connection: conn})));
                        }
                    }
                }
                
                const tbody = document.getElementById('syncedPropertiesTable');
                if (properties.length > 0) {
                    tbody.innerHTML = properties.map(p => `<tr>
                        <td><strong>${p.name}</strong><br><small style="color: #6b7280;">${p.connection?.adapter_name || ''}</small></td>
                        <td>${p.city || ''}, ${p.country || ''}</td>
                        <td>${p.room_type_count || 0}</td>
                        <td>${p.image_count || 0}</td>
                        <td>${p.gas_property_id ? '<span class="badge" style="background:#d1fae5;color:#047857;">Linked</span>' : '<span class="badge" style="background:#fef3c7;color:#92400e;">Not Linked</span>'}</td>
                        <td>${formatTimeAgo(p.synced_at)}</td>
                        <td>${!p.gas_property_id ? `<button class="btn btn-sm btn-primary" onclick="importSyncedProperty(${p.id})">Import</button>` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="downloadPropertyImages(${p.id})">üì∑</button></td>
                    </tr>`).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--text-secondary);">No synced properties</td></tr>';
                }
            } catch (error) {
                console.error('Error loading synced properties:', error);
            }
        }

        // Sync Logs View
        async function loadSyncLogs() {
            const connectionId = document.getElementById('syncLogsConnectionFilter')?.value;
            const status = document.getElementById('syncLogsStatusFilter')?.value;
            try {
                let allLogs = [];
                if (connectionId) {
                    const response = await fetch(`/api/gas-sync/connections/${connectionId}/logs?limit=50`, { headers: authHeaders() });
                    const data = await response.json();
                    allLogs = (data.logs || []).map(l => ({...l, connection: gasSyncConnections.find(c => c.id == connectionId)}));
                } else {
                    for (const conn of gasSyncConnections) {
                        const response = await fetch(`/api/gas-sync/connections/${conn.id}/logs?limit=20`, { headers: authHeaders() });
                        const data = await response.json();
                        if (data.logs) {
                            allLogs = allLogs.concat(data.logs.map(l => ({...l, connection: conn})));
                        }
                    }
                    allLogs.sort((a, b) => new Date(b.started_at) - new Date(a.started_at));
                }
                
                if (status) allLogs = allLogs.filter(l => l.status === status);
                
                const tbody = document.getElementById('syncLogsTable');
                if (allLogs.length > 0) {
                    tbody.innerHTML = allLogs.slice(0, 100).map(log => `<tr>
                        <td>${formatDateTime(log.started_at)}</td>
                        <td>${log.connection?.adapter_name || '-'}</td>
                        <td>${log.sync_type}</td>
                        <td><span class="status-badge status-${log.status}">${log.status}</span></td>
                        <td>${log.records_created || 0}</td>
                        <td>${log.records_updated || 0}</td>
                        <td>${log.records_failed || 0}</td>
                        <td>${log.duration_ms ? (log.duration_ms / 1000).toFixed(1) + 's' : '-'}</td>
                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${log.error_message || ''}">${log.error_message || '-'}</td>
                    </tr>`).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color: var(--text-secondary);">No logs found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading sync logs:', error);
            }
        }

        // Helper functions
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return formatDate(dateString);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString();
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleString();
        }
    </script>
</body>
</html>
