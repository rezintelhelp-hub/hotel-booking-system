<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAS Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* Left Sidebar - Property List */
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .sidebar-header h2 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #667eea;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s;
        }

        .search-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .property-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .property-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: #f9f9f9;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .property-item:hover {
            background: #f0f0f0;
            transform: translateX(4px);
        }

        .property-item.active {
            background: #e8ecff;
            border-color: #667eea;
        }

        .property-item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .property-item-location {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .property-item-meta {
            font-size: 0.8rem;
            color: #999;
            margin-top: 0.5rem;
            display: flex;
            gap: 1rem;
        }

        /* Right Panel - Details/Form */
        .content-panel {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: #fafafa;
        }

        .panel-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }

        .panel-empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .form-container {
            max-width: 900px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 2rem;
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #555;
            font-size: 0.9rem;
        }

        .form-input,
        .form-textarea,
        .form-select {
            padding: 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Images Section */
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-item {
            position: relative;
            aspect-ratio: 4/3;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-item-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255,0,0,0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .image-item:hover .image-item-remove {
            opacity: 1;
        }

        .image-upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 4/3;
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #999;
            font-size: 2rem;
        }

        .image-upload-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f9f9ff;
        }

        /* Amenities Section */
        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .amenity-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #f9f9f9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .amenity-item:hover {
            background: #f0f0f0;
        }

        .amenity-item.selected {
            background: #e8ecff;
            border-color: #667eea;
        }

        .amenity-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .amenity-label {
            font-size: 0.9rem;
            cursor: pointer;
            flex: 1;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ff4444;
            color: white;
        }

        .btn-danger:hover {
            background: #cc0000;
        }

        .btn-success {
            background: #00C851;
            color: white;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #f0f0f0;
        }

        /* AI Import Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status Messages */
        .status-message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.active {
            display: block;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 300px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .amenities-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üè® Global Accommodation System</h1>
        <div class="header-actions">
            <button class="btn btn-success" onclick="openImportModal()">
                ‚ú® AI Import
            </button>
            <button class="btn btn-primary" onclick="createNewProperty()">
                ‚ûï New Property
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Properties</h2>
                <input 
                    type="text" 
                    class="search-box" 
                    id="searchBox"
                    placeholder="üîç Search properties..."
                    oninput="filterProperties()"
                >
            </div>
            <div class="property-list" id="propertyList">
                <!-- Properties will be loaded here -->
            </div>
        </div>

        <!-- Right Content Panel -->
        <div class="content-panel">
            <div class="panel-empty" id="emptyState">
                <div class="panel-empty-icon">üè®</div>
                <h3>Select a property to view details</h3>
                <p style="margin-top: 0.5rem; color: #999;">or create a new one to get started</p>
            </div>

            <div id="propertyForm" style="display: none;">
                <div class="status-message" id="statusMessage"></div>

                <div class="form-container">
                    <div class="form-header">
                        <h2 class="form-title" id="formTitle">Property Details</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                            <button class="btn btn-danger" onclick="deleteProperty()" id="deleteBtn" style="display: none;">Delete</button>
                        </div>
                    </div>

                    <form id="mainForm" onsubmit="saveProperty(event)">
                        <!-- Basic Information -->
                        <div class="form-section">
                            <div class="form-section-title">üìã Basic Information</div>
                            <div class="form-grid">
                                <div class="form-group form-grid-full">
                                    <label class="form-label">Property Name *</label>
                                    <input type="text" class="form-input" id="name" required>
                                </div>
                                <div class="form-group form-grid-full">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-textarea" id="description" rows="4"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Location -->
                        <div class="form-section">
                            <div class="form-section-title">üìç Location</div>
                            <div class="form-grid">
                                <div class="form-group form-grid-full">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-input" id="address">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-input" id="city">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">State/Province</label>
                                    <input type="text" class="form-input" id="state">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Country</label>
                                    <input type="text" class="form-input" id="country">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Postal Code</label>
                                    <input type="text" class="form-input" id="postcode">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Latitude</label>
                                    <input type="number" step="any" class="form-input" id="latitude">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Longitude</label>
                                    <input type="number" step="any" class="form-input" id="longitude">
                                </div>
                            </div>
                        </div>

                        <!-- Property Details -->
                        <div class="form-section">
                            <div class="form-section-title">üõèÔ∏è Property Details</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Bedrooms</label>
                                    <input type="number" class="form-input" id="bedrooms" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Beds</label>
                                    <input type="number" class="form-input" id="beds" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bathrooms</label>
                                    <input type="number" step="0.5" class="form-input" id="bathrooms" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Max Guests</label>
                                    <input type="number" class="form-input" id="max_guests" min="1">
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="form-section">
                            <div class="form-section-title">üìû Contact Information</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-input" id="phone">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" id="email">
                                </div>
                                <div class="form-group form-grid-full">
                                    <label class="form-label">Website</label>
                                    <input type="url" class="form-input" id="website">
                                </div>
                            </div>
                        </div>

                        <!-- Check-in/out Times -->
                        <div class="form-section">
                            <div class="form-section-title">‚è∞ Check-in/out Times</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Check-in Time</label>
                                    <input type="time" class="form-input" id="checkin_time">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Check-out Time</label>
                                    <input type="time" class="form-input" id="checkout_time">
                                </div>
                            </div>
                        </div>

                        <!-- Policies -->
                        <div class="form-section">
                            <div class="form-section-title">üìú Policies</div>
                            <div class="form-grid">
                                <div class="form-group form-grid-full">
                                    <label class="form-label">House Rules</label>
                                    <textarea class="form-textarea" id="house_rules" rows="3"></textarea>
                                </div>
                                <div class="form-group form-grid-full">
                                    <label class="form-label">Cancellation Policy</label>
                                    <textarea class="form-textarea" id="cancellation_policy" rows="3"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Images -->
                        <div class="form-section">
                            <div class="form-section-title">üì∑ Images</div>
                            <div class="images-grid" id="imagesGrid">
                                <!-- Images will be displayed here -->
                                <div class="image-upload-btn" onclick="document.getElementById('imageUpload').click()">
                                    +
                                </div>
                            </div>
                            <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">
                        </div>

                        <!-- Amenities -->
                        <div class="form-section">
                            <div class="form-section-title">‚ú® Amenities</div>
                            <div class="amenities-grid" id="amenitiesGrid">
                                <!-- Common amenities will be loaded here -->
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="saveBtn">
                                üíæ Save Property
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h3 class="modal-header">‚ú® AI Import from URL</h3>
            <div class="form-group">
                <label class="form-label">Property URL (Airbnb or Booking.com)</label>
                <input type="url" class="form-input" id="importUrl" placeholder="https://www.airbnb.com/rooms/...">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                <button class="btn btn-primary" onclick="importFromUrl()" id="importBtn">
                    Import Property
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentPropertyId = null;
        let properties = [];
        let selectedAmenities = new Set();
        let propertyImages = [];

        // Common amenities list
        const commonAmenities = [
            'WiFi', 'Air Conditioning', 'Heating', 'TV', 'Kitchen', 'Washing Machine',
            'Dryer', 'Parking', 'Pool', 'Hot Tub', 'Gym', 'Elevator', 'Balcony',
            'Garden', 'BBQ', 'Fireplace', 'Workspace', 'Pets Allowed', 'Smoking Allowed',
            'Wheelchair Accessible', 'Beach Access', 'Lake Access', 'Ski-in/Ski-out',
            'Iron', 'Hair Dryer', 'Essentials', 'Hangers', 'Bed Linens', 'Extra Pillows'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadProperties();
            loadAmenities();
        });

        // Load all properties
        async function loadProperties() {
            try {
                const response = await fetch('/api/db/properties');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                properties = result.data;
                renderPropertyList();
            } catch (error) {
                console.error('Error loading properties:', error);
                showStatus('Error loading properties', 'error');
            }
        }

        // Render property list in sidebar
        function renderPropertyList() {
            const listContainer = document.getElementById('propertyList');
            
            if (properties.length === 0) {
                listContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">No properties yet</div>';
                return;
            }

            listContainer.innerHTML = properties.map(property => `
                <div class="property-item ${property.id === currentPropertyId ? 'active' : ''}" 
                     onclick="selectProperty(${property.id})">
                    <div class="property-item-name">${property.name || 'Unnamed Property'}</div>
                    <div class="property-item-location">
                        üìç ${property.city || 'Unknown'}, ${property.country || 'Unknown'}
                    </div>
                    <div class="property-item-meta">
                        <span>üõèÔ∏è ${property.bedrooms || 0} bed</span>
                        <span>üë• ${property.max_guests || 0} guests</span>
                    </div>
                </div>
            `).join('');
        }

        // Filter properties by search
        function filterProperties() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const filtered = properties.filter(p => 
                (p.name || '').toLowerCase().includes(searchTerm) ||
                (p.city || '').toLowerCase().includes(searchTerm) ||
                (p.country || '').toLowerCase().includes(searchTerm)
            );
            
            const listContainer = document.getElementById('propertyList');
            listContainer.innerHTML = filtered.map(property => `
                <div class="property-item ${property.id === currentPropertyId ? 'active' : ''}" 
                     onclick="selectProperty(${property.id})">
                    <div class="property-item-name">${property.name || 'Unnamed Property'}</div>
                    <div class="property-item-location">
                        üìç ${property.city || 'Unknown'}, ${property.country || 'Unknown'}
                    </div>
                    <div class="property-item-meta">
                        <span>üõèÔ∏è ${property.bedrooms || 0} bed</span>
                        <span>üë• ${property.max_guests || 0} guests</span>
                    </div>
                </div>
            `).join('');
        }

        // Select and load property
        async function selectProperty(id) {
            try {
                // Get the property from our loaded array instead of fetching individually
                const property = properties.find(p => p.id === id);
                if (!property) {
                    throw new Error('Property not found');
                }
                
                currentPropertyId = id;
                populateForm(property);
                
                // For now, no images or amenities in API - we'll add these later
                propertyImages = [];
                selectedAmenities = new Set();
                
                renderImages();
                renderAmenities();
                
                // Update UI
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('propertyForm').style.display = 'block';
                document.getElementById('formTitle').textContent = property.name || 'Property Details';
                document.getElementById('deleteBtn').style.display = 'inline-flex';
                
                renderPropertyList();
            } catch (error) {
                console.error('Error loading property:', error);
                showStatus('Error loading property', 'error');
            }
        }

        // Populate form with property data
        function populateForm(property) {
            const fieldMap = {
                'name': 'name',
                'description': 'description',
                'address': 'address',
                'city': 'city',
                'state': 'state',
                'country': 'country',
                'postcode': 'postcode',
                'latitude': 'latitude',
                'longitude': 'longitude',
                'bedrooms': 'bedrooms',
                'beds': 'beds',
                'bathrooms': 'bathrooms',
                'max_guests': 'max_guests',
                'phone': 'phone',
                'email': 'email',
                'website': 'website',
                'checkin_time': 'check_in_time',
                'checkout_time': 'check_out_time',
                'house_rules': 'house_rules',
                'cancellation_policy': 'cancellation_policy'
            };
            
            Object.entries(fieldMap).forEach(([formField, dataField]) => {
                const element = document.getElementById(formField);
                if (element && property[dataField] !== null && property[dataField] !== undefined) {
                    element.value = property[dataField];
                }
            });
        }

        // Create new property
        function createNewProperty() {
            currentPropertyId = null;
            document.getElementById('mainForm').reset();
            selectedAmenities.clear();
            propertyImages = [];
            
            renderAmenities();
            renderImages();
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('propertyForm').style.display = 'block';
            document.getElementById('formTitle').textContent = 'New Property';
            document.getElementById('deleteBtn').style.display = 'none';
            
            renderPropertyList();
        }

        // Save property
        async function saveProperty(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                country: document.getElementById('country').value,
                postcode: document.getElementById('postcode').value,
                latitude: parseFloat(document.getElementById('latitude').value) || null,
                longitude: parseFloat(document.getElementById('longitude').value) || null,
                bedrooms: parseInt(document.getElementById('bedrooms').value) || null,
                beds: parseInt(document.getElementById('beds').value) || null,
                bathrooms: parseFloat(document.getElementById('bathrooms').value) || null,
                max_guests: parseInt(document.getElementById('max_guests').value) || null,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                website: document.getElementById('website').value,
                check_in_time: document.getElementById('checkin_time').value,
                check_out_time: document.getElementById('checkout_time').value,
                house_rules: document.getElementById('house_rules').value,
                cancellation_policy: document.getElementById('cancellation_policy').value
            };

            try {
                const url = currentPropertyId 
                    ? `/api/db/properties/${currentPropertyId}`
                    : '/api/db/properties';
                
                const method = currentPropertyId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to save property');
                }
                
                if (!currentPropertyId && result.data && result.data.id) {
                    currentPropertyId = result.data.id;
                }

                // Note: Amenities saving will be implemented when backend supports it

                showStatus('Property saved successfully!', 'success');
                await loadProperties();
                
                // Keep form open with saved data
                if (currentPropertyId) {
                    await selectProperty(currentPropertyId);
                }
                
            } catch (error) {
                console.error('Error saving property:', error);
                showStatus('Error saving property', 'error');
            }
        }

        // Delete property
        async function deleteProperty() {
            if (!currentPropertyId) return;
            
            if (!confirm('Are you sure you want to delete this property?')) return;

            try {
                const response = await fetch(`/api/db/properties/${currentPropertyId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to delete property');
                }

                showStatus('Property deleted successfully!', 'success');
                await loadProperties();
                cancelEdit();
            } catch (error) {
                console.error('Error deleting property:', error);
                showStatus('Error deleting property', 'error');
            }
        }

        // Cancel edit
        function cancelEdit() {
            currentPropertyId = null;
            document.getElementById('propertyForm').style.display = 'none';
            document.getElementById('emptyState').style.display = 'flex';
            renderPropertyList();
        }

        // Load and render amenities
        function loadAmenities() {
            renderAmenities();
        }

        function renderAmenities() {
            const grid = document.getElementById('amenitiesGrid');
            grid.innerHTML = commonAmenities.map(amenity => `
                <div class="amenity-item ${selectedAmenities.has(amenity) ? 'selected' : ''}" 
                     onclick="toggleAmenity('${amenity}')">
                    <input type="checkbox" 
                           class="amenity-checkbox" 
                           ${selectedAmenities.has(amenity) ? 'checked' : ''}
                           onchange="toggleAmenity('${amenity}')">
                    <span class="amenity-label">${amenity}</span>
                </div>
            `).join('');
        }

        function toggleAmenity(amenity) {
            if (selectedAmenities.has(amenity)) {
                selectedAmenities.delete(amenity);
            } else {
                selectedAmenities.add(amenity);
            }
            renderAmenities();
        }

        // Note: Amenities will be saved when backend API is ready

        // Image handling
        function renderImages() {
            const grid = document.getElementById('imagesGrid');
            const imagesHtml = propertyImages.map((img, index) => `
                <div class="image-item">
                    <img src="${img.url}" alt="Property image">
                    <button class="image-item-remove" onclick="removeImage(${index})">√ó</button>
                </div>
            `).join('');
            
            grid.innerHTML = imagesHtml + `
                <div class="image-upload-btn" onclick="document.getElementById('imageUpload').click()">
                    +
                </div>
            `;
        }

        function handleImageUpload(event) {
            // This would handle actual image uploads
            // For now, just show the UI
            alert('Image upload functionality will be implemented');
        }

        function removeImage(index) {
            propertyImages.splice(index, 1);
            renderImages();
        }

        // AI Import Modal
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.getElementById('importUrl').value = '';
        }

        async function importFromUrl() {
            const url = document.getElementById('importUrl').value;
            if (!url) {
                alert('Please enter a URL');
                return;
            }

            const btn = document.getElementById('importBtn');
            btn.innerHTML = '<span class="spinner"></span> Importing...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/import-property', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Import failed');
                }
                
                // Auto-fill the form with imported data
                if (result.data && result.data.property) {
                    const p = result.data.property;
                    
                    // Create new property
                    createNewProperty();
                    
                    // Fill in the form
                    if (p.name) document.getElementById('name').value = p.name;
                    if (p.description) document.getElementById('description').value = p.description;
                    if (p.address) document.getElementById('address').value = p.address;
                    if (p.city) document.getElementById('city').value = p.city;
                    if (p.state) document.getElementById('state').value = p.state;
                    if (p.country) document.getElementById('country').value = p.country;
                    if (p.postcode) document.getElementById('postcode').value = p.postcode;
                    if (p.latitude) document.getElementById('latitude').value = p.latitude;
                    if (p.longitude) document.getElementById('longitude').value = p.longitude;
                    if (p.bedrooms) document.getElementById('bedrooms').value = p.bedrooms;
                    if (p.beds) document.getElementById('beds').value = p.beds;
                    if (p.bathrooms) document.getElementById('bathrooms').value = p.bathrooms;
                    if (p.max_guests) document.getElementById('max_guests').value = p.max_guests;
                    if (p.phone) document.getElementById('phone').value = p.phone;
                    if (p.email) document.getElementById('email').value = p.email;
                    if (p.website) document.getElementById('website').value = p.website || url;
                    if (p.check_in_time) document.getElementById('checkin_time').value = p.check_in_time;
                    if (p.check_out_time) document.getElementById('checkout_time').value = p.check_out_time;
                    if (p.house_rules) document.getElementById('house_rules').value = p.house_rules;
                    if (p.cancellation_policy) document.getElementById('cancellation_policy').value = p.cancellation_policy;
                }
                
                closeImportModal();
                showStatus('Property data imported! Review and click Save to add it.', 'success');
                
            } catch (error) {
                console.error('Error importing:', error);
                showStatus('Error importing property: ' + error.message, 'error');
            } finally {
                btn.innerHTML = 'Import Property';
                btn.disabled = false;
            }
        }

        // Status messages
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type} active`;
            
            setTimeout(() => {
                statusEl.classList.remove('active');
            }, 5000);
        }

        // Close modal on outside click
        document.getElementById('importModal').addEventListener('click', (e) => {
            if (e.target.id === 'importModal') {
                closeImportModal();
            }
        });
    </script>
</body>
</html>
