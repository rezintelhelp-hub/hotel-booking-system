<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connect to Hostaway - GAS</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #a8b5f7 0%, #c9b8ea 50%, #e8d0e0 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .wizard-container {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 650px;
      overflow: hidden;
    }
    .wizard-header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: #fff;
      padding: 30px;
      text-align: center;
    }
    .wizard-header h1 {
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .wizard-header p {
      opacity: 0.9;
      font-size: 0.95rem;
    }
    .version-tag {
      font-size: 0.75rem;
      opacity: 0.7;
    }
    .step-dots {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ddd;
      transition: all 0.3s;
    }
    .step-dot.active {
      background: #3498db;
    }
    .step-dot.completed {
      background: #27ae60;
    }
    .wizard-content {
      padding: 30px 40px;
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .step-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    .step-subtitle {
      color: #7f8c8d;
      margin-bottom: 25px;
      font-size: 0.95rem;
    }
    .tab-buttons {
      display: flex;
      gap: 0;
      margin-bottom: 25px;
    }
    .tab-btn {
      flex: 1;
      padding: 14px 20px;
      border: 2px solid #e0e0e0;
      background: #fff;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: #666;
    }
    .tab-btn:first-child {
      border-radius: 8px 0 0 8px;
      border-right: 1px solid #e0e0e0;
    }
    .tab-btn:last-child {
      border-radius: 0 8px 8px 0;
      border-left: 1px solid #e0e0e0;
    }
    .tab-btn.active {
      background: #f0f7ff;
      border-color: #3498db;
      color: #2c3e50;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-weight: 500;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
      background: #f8fafc;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #3498db;
      background: #fff;
    }
    .form-group input::placeholder {
      color: #aaa;
    }
    .help-text {
      font-size: 0.85rem;
      color: #95a5a6;
      margin-top: 6px;
    }
    .wizard-footer {
      padding: 20px 40px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #eee;
    }
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: #fff;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52,152,219,0.4);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #666;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    .btn-link {
      background: none;
      color: #3498db;
      padding: 14px 0;
    }
    .btn-link:hover {
      text-decoration: underline;
    }
    .status-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 0.9rem;
      display: none;
    }
    .status-message.show {
      display: block;
    }
    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-message.info {
      background: #e7f3ff;
      color: #004085;
      border: 1px solid #b8daff;
    }
    .instructions-box {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
    }
    .instructions-box h3 {
      font-size: 1rem;
      color: #2c3e50;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .instructions-box ol {
      margin: 0;
      padding-left: 20px;
      color: #5a6c7d;
      font-size: 0.9rem;
      line-height: 1.7;
    }
    .property-list {
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .property-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .property-item:last-child {
      border-bottom: none;
    }
    .property-item:hover {
      background: #f8f9fa;
    }
    .property-item.selected {
      background: #e7f3ff;
    }
    .property-checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid #ddd;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .property-item.selected .property-checkbox {
      background: #3498db;
      border-color: #3498db;
      color: #fff;
    }
    .property-thumb {
      width: 70px;
      height: 50px;
      border-radius: 6px;
      object-fit: cover;
      background: #f0f0f0;
      flex-shrink: 0;
    }
    .property-info {
      flex: 1;
      min-width: 0;
    }
    .property-name {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .property-location {
      font-size: 0.85rem;
      color: #7f8c8d;
    }
    .property-meta {
      font-size: 0.8rem;
      color: #95a5a6;
      margin-top: 2px;
    }
    .property-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    .property-status.active {
      background: #d4edda;
      color: #155724;
    }
    .property-status.inactive {
      background: #fff3cd;
      color: #856404;
    }
    .checkbox-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 0;
    }
    .checkbox-option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #3498db;
    }
    .checkbox-option label {
      color: #2c3e50;
      font-size: 0.95rem;
      cursor: pointer;
    }
    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 40px;
      color: #7f8c8d;
    }
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #e0e0e0;
      border-top-color: #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .success-box {
      text-align: center;
      padding: 20px;
    }
    .success-icon {
      width: 80px;
      height: 80px;
      background: #d4edda;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 2.5rem;
    }
    .summary-table {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e9ecef;
    }
    .summary-row:last-child {
      border-bottom: none;
    }
    .summary-label {
      color: #7f8c8d;
    }
    .summary-value {
      font-weight: 600;
      color: #2c3e50;
    }
    .select-actions {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }
    .select-actions a {
      color: #3498db;
      cursor: pointer;
      text-decoration: none;
    }
    .select-actions a:hover {
      text-decoration: underline;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="wizard-container">
    <div class="wizard-header">
      <h1>üè† Connect to Hostaway</h1>
      <p>Set up your channel manager integration in minutes <span class="version-tag">(v1)</span></p>
    </div>
    
    <div class="step-dots">
      <div class="step-dot active" data-step="1"></div>
      <div class="step-dot" data-step="2"></div>
      <div class="step-dot" data-step="3"></div>
      <div class="step-dot" data-step="4"></div>
      <div class="step-dot" data-step="5"></div>
    </div>
    
    <div class="wizard-content">
      <!-- Step 1: Login/Register -->
      <div class="step active" data-step="1">
        <h2 class="step-title">Welcome to GAS</h2>
        <p class="step-subtitle">Login or create an account to get started</p>
        
        <div class="tab-buttons">
          <button class="tab-btn active" onclick="showTab('login')">Login</button>
          <button class="tab-btn" onclick="showTab('register')">Register</button>
        </div>
        
        <div id="login-form">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="login-email" placeholder="your@email.com">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="login-password" placeholder="Your password">
          </div>
        </div>
        
        <div id="register-form" class="hidden">
          <div class="form-group">
            <label>Account Name</label>
            <input type="text" id="register-name" placeholder="Your property or company name">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="register-email" placeholder="your@email.com">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="register-password" placeholder="Choose a password">
          </div>
        </div>
        
        <div id="step1-status" class="status-message"></div>
      </div>
      
      <!-- Step 2: Hostaway Credentials -->
      <div class="step" data-step="2">
        <h2 class="step-title">Hostaway API Credentials</h2>
        <p class="step-subtitle">Enter your Hostaway API credentials</p>
        
        <div class="instructions-box">
          <h3>üìã How to get your credentials:</h3>
          <ol>
            <li>Log in to your <strong>Hostaway Dashboard</strong></li>
            <li>Go to <strong>Settings ‚Üí API</strong></li>
            <li>Copy your <strong>Account ID</strong> and <strong>API Key</strong></li>
          </ol>
        </div>
        
        <div class="form-group">
          <label>Account ID (Client ID)</label>
          <input type="text" id="hostaway-account-id" placeholder="Your Hostaway Account ID">
        </div>
        <div class="form-group">
          <label>API Key (Client Secret)</label>
          <input type="password" id="hostaway-api-key" placeholder="Your Hostaway API Key">
          <p class="help-text">Your credentials are encrypted and stored securely</p>
        </div>
        
        <div id="step2-status" class="status-message"></div>
      </div>
      
      <!-- Step 3: Select Properties -->
      <div class="step" data-step="3">
        <h2 class="step-title">Select Properties</h2>
        <p class="step-subtitle">Choose which properties to import into GAS</p>
        
        <div id="properties-loading" class="loading-spinner">
          <div class="spinner"></div>
          <span>Loading your properties...</span>
        </div>
        
        <div id="properties-container" class="hidden">
          <div class="select-actions">
            <a onclick="selectAll()">Select All</a>
            <a onclick="selectNone()">Select None</a>
            <span style="color: #95a5a6;">|</span>
            <span id="selected-count">0 selected</span>
          </div>
          
          <div class="property-list" id="property-list"></div>
        </div>
        
        <div id="step3-status" class="status-message"></div>
      </div>
      
      <!-- Step 4: Import Options -->
      <div class="step" data-step="4">
        <h2 class="step-title">Import Options</h2>
        <p class="step-subtitle">Configure how your properties will be imported</p>
        
        <div class="checkbox-option">
          <input type="checkbox" id="import-images" checked>
          <label for="import-images">Import property images</label>
        </div>
        
        <div class="checkbox-option">
          <input type="checkbox" id="update-existing">
          <label for="update-existing">Update existing properties (re-import images)</label>
        </div>
        
        <div class="summary-table">
          <div class="summary-row">
            <span class="summary-label">Properties to import</span>
            <span class="summary-value" id="summary-properties">0</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">GAS Account</span>
            <span class="summary-value" id="summary-account">-</span>
          </div>
        </div>
        
        <div id="step4-status" class="status-message"></div>
      </div>
      
      <!-- Step 5: Complete -->
      <div class="step" data-step="5">
        <div class="success-box">
          <div class="success-icon">‚úì</div>
          <h2 class="step-title">Import Complete!</h2>
          <p class="step-subtitle">Your properties have been imported successfully</p>
        </div>
        
        <div class="summary-table" id="final-summary"></div>
        
        <!-- Webhook Setup Instructions -->
        <div class="webhook-setup" style="margin-top: 24px; padding: 20px; background: #f0f9ff; border-radius: 12px; border-left: 4px solid #3498db;">
          <h3 style="margin-bottom: 12px; color: #2c3e50; font-size: 1.1rem;">üì° Enable Real-Time Sync (Recommended)</h3>
          <p style="margin-bottom: 12px; color: #555; font-size: 0.9rem;">
            To receive instant booking updates from Airbnb, VRBO, etc., add this webhook URL in Hostaway:
          </p>
          <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <input type="text" id="webhook-url" value="https://admin.gas.travel/api/webhooks/hostaway" readonly 
              style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 0.85rem; background: #fff;">
            <button onclick="copyWebhookUrl()" style="padding: 10px 16px; background: #3498db; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Copy</button>
          </div>
          <p style="color: #666; font-size: 0.85rem; margin-bottom: 8px;">
            <strong>Steps:</strong> Hostaway Dashboard ‚Üí Settings ‚Üí Integrations ‚Üí Unified Webhooks ‚Üí Add Webhook
          </p>
          <p style="color: #888; font-size: 0.8rem;">
            Without webhook: Bookings sync every 15 minutes via polling.
          </p>
        </div>
        
        <div id="step5-status" class="status-message"></div>
      </div>
    </div>
    
    <div class="wizard-footer">
      <button class="btn btn-link hidden" id="btn-back" onclick="prevStep()">‚Üê Back</button>
      <div></div>
      <button class="btn btn-primary" id="btn-next" onclick="nextStep()">Next ‚Üí</button>
    </div>
  </div>

  <script>
    // State
    let currentStep = 1;
    let gasAccountId = null;
    let gasAccountName = null;
    let hostawayToken = null;
    let hostawayAccountId = null;
    let hostawayApiKey = null;
    let properties = [];
    let selectedProperties = new Set();
    let isLoginMode = true;

    // Tab switching
    function showTab(tab) {
      isLoginMode = tab === 'login';
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('login-form').classList.toggle('hidden', !isLoginMode);
      document.getElementById('register-form').classList.toggle('hidden', isLoginMode);
    }

    // Navigation
    function updateStepDots() {
      document.querySelectorAll('.step-dot').forEach((dot, idx) => {
        dot.classList.remove('active', 'completed');
        if (idx + 1 === currentStep) {
          dot.classList.add('active');
        } else if (idx + 1 < currentStep) {
          dot.classList.add('completed');
        }
      });
    }

    function showStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
      
      // Update buttons
      document.getElementById('btn-back').classList.toggle('hidden', step === 1);
      
      if (step === 4) {
        document.getElementById('btn-next').textContent = 'Import ‚Üí';
      } else if (step === 5) {
        document.getElementById('btn-next').textContent = 'Go to Dashboard';
      } else {
        document.getElementById('btn-next').textContent = 'Next ‚Üí';
      }
      
      updateStepDots();
    }

    async function nextStep() {
      clearStatus();
      
      if (currentStep === 1) {
        if (await handleAuth()) {
          currentStep = 2;
          showStep(currentStep);
        }
      } else if (currentStep === 2) {
        if (await testConnection()) {
          currentStep = 3;
          showStep(currentStep);
          loadProperties();
        }
      } else if (currentStep === 3) {
        if (selectedProperties.size === 0) {
          showStatus('step3-status', 'Please select at least one property', 'error');
          return;
        }
        currentStep = 4;
        document.getElementById('summary-properties').textContent = selectedProperties.size;
        document.getElementById('summary-account').textContent = gasAccountName;
        showStep(currentStep);
      } else if (currentStep === 4) {
        await importProperties();
      } else if (currentStep === 5) {
        window.location.href = '/admin';
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
      }
    }

    // Step 1: Authentication
    async function handleAuth() {
      if (isLoginMode) {
        return await login();
      } else {
        return await register();
      }
    }

    async function login() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      
      if (!email || !password) {
        showStatus('step1-status', 'Please enter email and password', 'error');
        return false;
      }
      
      showStatus('step1-status', 'Logging in...', 'info');
      
      try {
        const response = await fetch('/api/accounts/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          gasAccountId = data.accountId;
          gasAccountName = data.accountName || email;
          showStatus('step1-status', '‚úì Logged in successfully', 'success');
          return true;
        } else {
          showStatus('step1-status', data.error || 'Login failed', 'error');
          return false;
        }
      } catch (error) {
        showStatus('step1-status', 'Connection error: ' + error.message, 'error');
        return false;
      }
    }

    async function register() {
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;
      
      if (!name || !email || !password) {
        showStatus('step1-status', 'Please fill in all fields', 'error');
        return false;
      }
      
      showStatus('step1-status', 'Creating account...', 'info');
      
      try {
        const response = await fetch('/api/accounts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });
        
        const data = await response.json();
        
        if (data.success) {
          gasAccountId = data.account?.id;
          gasAccountName = name;
          showStatus('step1-status', '‚úì Account created successfully', 'success');
          return true;
        } else {
          showStatus('step1-status', data.error || 'Registration failed', 'error');
          return false;
        }
      } catch (error) {
        showStatus('step1-status', 'Connection error: ' + error.message, 'error');
        return false;
      }
    }

    // Step 2: Test Hostaway Connection
    async function testConnection() {
      const accountId = document.getElementById('hostaway-account-id').value.trim();
      const apiKey = document.getElementById('hostaway-api-key').value.trim();
      
      if (!accountId || !apiKey) {
        showStatus('step2-status', 'Please enter both Account ID and API Key', 'error');
        return false;
      }
      
      showStatus('step2-status', 'Testing connection...', 'info');
      
      try {
        const response = await fetch('/api/hostaway-wizard/test-connection', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountId, apiKey })
        });
        
        const data = await response.json();
        
        if (data.success) {
          hostawayToken = data.token;
          hostawayAccountId = accountId;
          hostawayApiKey = apiKey;
          showStatus('step2-status', '‚úì Connection successful', 'success');
          return true;
        } else {
          showStatus('step2-status', data.error || 'Connection failed', 'error');
          return false;
        }
      } catch (error) {
        showStatus('step2-status', 'Connection error: ' + error.message, 'error');
        return false;
      }
    }

    // Step 3: Load Properties
    async function loadProperties() {
      document.getElementById('properties-loading').classList.remove('hidden');
      document.getElementById('properties-container').classList.add('hidden');
      
      try {
        const response = await fetch('/api/hostaway-wizard/properties', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: hostawayToken })
        });
        
        const data = await response.json();
        
        document.getElementById('properties-loading').classList.add('hidden');
        
        if (data.success) {
          properties = data.properties;
          document.getElementById('properties-container').classList.remove('hidden');
          renderProperties();
        } else {
          showStatus('step3-status', data.error || 'Failed to load properties', 'error');
        }
      } catch (error) {
        document.getElementById('properties-loading').classList.add('hidden');
        showStatus('step3-status', 'Error loading properties: ' + error.message, 'error');
      }
    }

    function renderProperties() {
      const listEl = document.getElementById('property-list');
      
      if (properties.length === 0) {
        listEl.innerHTML = '<div style="padding: 40px; text-align: center; color: #7f8c8d;">No properties found in your Hostaway account</div>';
        return;
      }
      
      listEl.innerHTML = properties.map(prop => `
        <div class="property-item ${selectedProperties.has(prop.id) ? 'selected' : ''}" onclick="toggleProperty(${prop.id})">
          <div class="property-checkbox">${selectedProperties.has(prop.id) ? '‚úì' : ''}</div>
          <img class="property-thumb" 
               src="${prop.thumbnailUrl || ''}" 
               alt=""
               onerror="this.style.display='none'">
          <div class="property-info">
            <div class="property-name">${escapeHtml(prop.name)}</div>
            <div class="property-location">${escapeHtml([prop.city, prop.state, prop.country].filter(Boolean).join(', ') || 'No location')}</div>
            <div class="property-meta">${prop.bedrooms || 0} bed ‚Ä¢ ${prop.bathrooms || 0} bath ‚Ä¢ ${prop.maxGuests || 0} guests</div>
          </div>
          <span class="property-status ${prop.isActive ? 'active' : 'inactive'}">${prop.isActive ? 'Active' : 'Inactive'}</span>
        </div>
      `).join('');
      
      updateSelectedCount();
    }

    function toggleProperty(id) {
      if (selectedProperties.has(id)) {
        selectedProperties.delete(id);
      } else {
        selectedProperties.add(id);
      }
      renderProperties();
    }

    function selectAll() {
      properties.forEach(p => selectedProperties.add(p.id));
      renderProperties();
    }

    function selectNone() {
      selectedProperties.clear();
      renderProperties();
    }

    function updateSelectedCount() {
      document.getElementById('selected-count').textContent = `${selectedProperties.size} selected`;
    }

    // Step 4: Import
    async function importProperties() {
      const importImages = document.getElementById('import-images').checked;
      const updateExisting = document.getElementById('update-existing').checked;
      
      showStatus('step4-status', 'Importing properties...', 'info');
      document.getElementById('btn-next').disabled = true;
      
      const results = [];
      let successCount = 0;
      let totalImages = 0;
      
      for (const propId of selectedProperties) {
        const prop = properties.find(p => p.id === propId);
        showStatus('step4-status', `Importing: ${prop?.name || propId}...`, 'info');
        
        try {
          const response = await fetch('/api/hostaway-wizard/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              accountId: hostawayAccountId,
              apiKey: hostawayApiKey,
              token: hostawayToken,
              listingId: propId,
              importImages,
              updateExisting,
              gasAccountId
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            successCount++;
            totalImages += data.stats?.imagesCreated || 0;
            results.push({ name: prop?.name, success: true });
          } else {
            results.push({ name: prop?.name, success: false, error: data.error });
          }
        } catch (error) {
          results.push({ name: prop?.name, success: false, error: error.message });
        }
      }
      
      // Show results
      document.getElementById('final-summary').innerHTML = `
        <div class="summary-row">
          <span class="summary-label">Properties Imported</span>
          <span class="summary-value">${successCount} of ${selectedProperties.size}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Images Imported</span>
          <span class="summary-value">${totalImages}</span>
        </div>
        <div style="margin-top: 15px; font-size: 0.9rem;">
          ${results.map(r => `
            <div style="padding: 5px 0; color: ${r.success ? '#155724' : '#721c24'};">
              ${r.success ? '‚úì' : '‚úó'} ${escapeHtml(r.name)}
              ${r.error ? ` - ${escapeHtml(r.error)}` : ''}
            </div>
          `).join('')}
        </div>
      `;
      
      currentStep = 5;
      showStep(currentStep);
      document.getElementById('btn-next').disabled = false;
    }

    // Utilities
    function showStatus(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `status-message show ${type}`;
    }

    function clearStatus() {
      document.querySelectorAll('.status-message').forEach(el => {
        el.classList.remove('show');
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyWebhookUrl() {
      const input = document.getElementById('webhook-url');
      input.select();
      document.execCommand('copy');
      
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = 'Copied!';
      btn.style.background = '#27ae60';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#3498db';
      }, 2000);
    }

    // Enter key handling
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        nextStep();
      }
    });
    
    // Console command to delete all Hostaway properties
    window.deleteHostawayProperties = async function() {
      if (!confirm('Delete ALL Hostaway properties, rooms, and images?')) return;
      
      const response = await fetch('/api/hostaway-wizard/delete-all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      console.log('Delete result:', data);
      return data;
    };
    
    console.log('üè† Hostaway Wizard loaded. Run deleteHostawayProperties() to clear all Hostaway imports.');
  </script>
</body>
</html>
