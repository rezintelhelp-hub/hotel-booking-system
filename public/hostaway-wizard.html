<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Hostaway - GAS</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: white;
        }
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .header p {
            opacity: 0.9;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 1.5rem;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .step-number {
            width: 36px;
            height: 36px;
            background: #1e3a5f;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
        }
        .step-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #1e3a5f;
        }
        .help-text {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #1e3a5f;
            color: white;
        }
        .btn-primary:hover {
            background: #2d5a87;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background: #d1d5db;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }
        .properties-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .property-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }
        .property-item:hover {
            background: #f9fafb;
        }
        .property-item:last-child {
            border-bottom: none;
        }
        .property-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 1rem;
        }
        .property-info {
            flex: 1;
        }
        .property-name {
            font-weight: 500;
            color: #1f2937;
        }
        .property-details {
            font-size: 0.85rem;
            color: #6b7280;
        }
        .property-id {
            font-size: 0.8rem;
            color: #9ca3af;
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .progress-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .progress-step {
            display: flex;
            align-items: center;
        }
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
        }
        .progress-dot.active {
            background: white;
        }
        .progress-dot.completed {
            background: #10b981;
        }
        .progress-line {
            width: 60px;
            height: 2px;
            background: rgba(255,255,255,0.3);
            margin: 0 0.5rem;
        }
        .progress-line.completed {
            background: #10b981;
        }
        .logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .webhook-url {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
            margin: 1rem 0;
        }
        .copy-btn {
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .copy-btn:hover {
            background: #2d5a87;
        }
        .rooms-list {
            margin-top: 0.5rem;
            padding-left: 2.5rem;
            font-size: 0.85rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üè†</div>
            <h1>Connect Hostaway</h1>
            <p>Link your Hostaway account to sync properties, availability, and bookings</p>
        </div>

        <div class="progress-steps">
            <div class="progress-step">
                <div class="progress-dot active" id="dot-1"></div>
            </div>
            <div class="progress-line" id="line-1"></div>
            <div class="progress-step">
                <div class="progress-dot" id="dot-2"></div>
            </div>
            <div class="progress-line" id="line-2"></div>
            <div class="progress-step">
                <div class="progress-dot" id="dot-3"></div>
            </div>
            <div class="progress-line" id="line-3"></div>
            <div class="progress-step">
                <div class="progress-dot" id="dot-4"></div>
            </div>
        </div>

        <!-- Step 1: Enter Credentials -->
        <div class="card step active" id="step-1">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">Enter Hostaway Credentials</div>
            </div>
            
            <div id="step1-status"></div>
            
            <div class="form-group">
                <label for="accountId">Account ID</label>
                <input type="text" id="accountId" placeholder="e.g., 140206">
                <div class="help-text">
                    Find this in Hostaway Dashboard ‚Üí Settings ‚Üí Account
                </div>
            </div>
            
            <div class="form-group">
                <label for="clientSecret">Client Secret</label>
                <input type="password" id="clientSecret" placeholder="Enter your API client secret">
                <div class="help-text">
                    Generate this in Hostaway Dashboard ‚Üí Settings ‚Üí API
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="window.location.href='/gas-admin.html'">Cancel</button>
                <button class="btn btn-primary" onclick="connectHostaway()">Connect to Hostaway</button>
            </div>
        </div>

        <!-- Step 2: Select Properties -->
        <div class="card step" id="step-2">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">Select Properties to Import</div>
            </div>
            
            <div id="step2-status"></div>
            
            <p style="margin-bottom: 1rem; color: #6b7280;">Select the properties you want to manage in GAS:</p>
            
            <div class="properties-list" id="properties-list">
                <div style="padding: 2rem; text-align: center; color: #6b7280;">
                    Loading properties...
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                <button class="btn btn-primary" onclick="importProperties()" id="import-btn" disabled>Import Selected</button>
            </div>
        </div>

        <!-- Step 3: Configure Webhook -->
        <div class="card step" id="step-3">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">Configure Webhook (Optional)</div>
            </div>
            
            <div id="step3-status"></div>
            
            <p style="margin-bottom: 1rem; color: #374151;">
                To receive real-time updates when bookings are created or modified in Hostaway, 
                configure the webhook URL in your Hostaway dashboard:
            </p>
            
            <div class="webhook-url" id="webhook-url">
                https://hotel-booking-system-production-d6db.up.railway.app/api/webhooks/hostaway
            </div>
            
            <button class="copy-btn" onclick="copyWebhookUrl()">üìã Copy URL</button>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                <strong>Setup Instructions:</strong>
                <ol style="margin-top: 0.5rem; padding-left: 1.5rem; color: #92400e;">
                    <li>Go to Hostaway Dashboard ‚Üí Settings ‚Üí Integrations</li>
                    <li>Find "Unified Webhooks" section</li>
                    <li>Add new webhook with the URL above</li>
                    <li>Enable: reservation created, reservation updated</li>
                </ol>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToStep(2)">Back</button>
                <button class="btn btn-primary" onclick="goToStep(4)">Continue</button>
            </div>
        </div>

        <!-- Step 4: Complete -->
        <div class="card step" id="step-4">
            <div class="step-header">
                <div class="step-number">‚úì</div>
                <div class="step-title">Setup Complete!</div>
            </div>
            
            <div class="status success">
                <strong>üéâ Hostaway Connected Successfully!</strong>
                <p style="margin-top: 0.5rem;">Your properties have been imported and are ready to sync.</p>
            </div>
            
            <div id="import-summary"></div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="window.location.href='/gas-admin.html'">Go to Admin Dashboard</button>
                <button class="btn btn-secondary" onclick="syncAvailability()">Sync Availability Now</button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let hostawayToken = null;
        let hostawayAccountId = null;
        let properties = [];
        let connectionId = null;

        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');
            
            // Update progress dots
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`dot-${i}`);
                const line = document.getElementById(`line-${i}`);
                
                dot.classList.remove('active', 'completed');
                if (i < step) {
                    dot.classList.add('completed');
                } else if (i === step) {
                    dot.classList.add('active');
                }
                
                if (line) {
                    line.classList.toggle('completed', i < step);
                }
            }
            
            currentStep = step;
        }

        async function connectHostaway() {
            const accountId = document.getElementById('accountId').value.trim();
            const clientSecret = document.getElementById('clientSecret').value.trim();
            
            if (!accountId || !clientSecret) {
                showStatus('step1-status', 'Please enter both Account ID and Client Secret', 'error');
                return;
            }
            
            showStatus('step1-status', 'Connecting to Hostaway...', 'info');
            
            try {
                const response = await fetch('/api/hostaway/setup-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountId, clientSecret })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    hostawayToken = data.accessToken;
                    hostawayAccountId = accountId;
                    connectionId = data.connectionId;
                    
                    showStatus('step1-status', '‚úì Connected successfully!', 'success');
                    
                    // Load properties
                    await loadProperties();
                    
                    setTimeout(() => goToStep(2), 500);
                } else {
                    showStatus('step1-status', data.error || 'Failed to connect', 'error');
                }
            } catch (error) {
                showStatus('step1-status', 'Connection error: ' + error.message, 'error');
            }
        }

        async function loadProperties() {
            try {
                const response = await fetch('/api/hostaway/list-properties', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: hostawayToken, connectionId })
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    properties = data.data;
                    renderProperties();
                } else {
                    document.getElementById('properties-list').innerHTML = 
                        `<div style="padding: 2rem; text-align: center; color: #991b1b;">
                            Failed to load properties: ${data.error || 'Unknown error'}
                        </div>`;
                }
            } catch (error) {
                document.getElementById('properties-list').innerHTML = 
                    `<div style="padding: 2rem; text-align: center; color: #991b1b;">
                        Error: ${error.message}
                    </div>`;
            }
        }

        function renderProperties() {
            if (properties.length === 0) {
                document.getElementById('properties-list').innerHTML = 
                    `<div style="padding: 2rem; text-align: center; color: #6b7280;">
                        No properties found in your Hostaway account
                    </div>`;
                return;
            }
            
            let html = '';
            properties.forEach(prop => {
                html += `
                    <label class="property-item">
                        <input type="checkbox" value="${prop.id}" onchange="updateImportButton()">
                        <div class="property-info">
                            <div class="property-name">${prop.name}</div>
                            <div class="property-details">
                                ${prop.city || ''} ${prop.country || ''} ‚Ä¢ 
                                ${prop.bedroomsNumber || 0} bed ‚Ä¢ 
                                ${prop.personCapacity || 0} guests
                            </div>
                        </div>
                        <div class="property-id">ID: ${prop.id}</div>
                    </label>
                `;
            });
            
            document.getElementById('properties-list').innerHTML = html;
        }

        function updateImportButton() {
            const checked = document.querySelectorAll('#properties-list input:checked');
            document.getElementById('import-btn').disabled = checked.length === 0;
        }

        async function importProperties() {
            const checked = document.querySelectorAll('#properties-list input:checked');
            const selectedIds = Array.from(checked).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                showStatus('step2-status', 'Please select at least one property', 'error');
                return;
            }
            
            showStatus('step2-status', `Importing ${selectedIds.length} properties...`, 'info');
            
            const selectedProperties = properties.filter(p => selectedIds.includes(String(p.id)));
            let imported = 0;
            let failed = 0;
            
            for (const prop of selectedProperties) {
                try {
                    const response = await fetch('/api/hostaway/import-property', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            property: prop, 
                            token: hostawayToken,
                            connectionId 
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        imported++;
                    } else {
                        failed++;
                        console.error(`Failed to import ${prop.name}:`, data.error);
                    }
                } catch (error) {
                    failed++;
                    console.error(`Error importing ${prop.name}:`, error);
                }
            }
            
            if (imported > 0) {
                showStatus('step2-status', `‚úì Imported ${imported} properties`, 'success');
                
                document.getElementById('import-summary').innerHTML = `
                    <div style="padding: 1rem; background: #f3f4f6; border-radius: 8px; margin-bottom: 1rem;">
                        <strong>Import Summary:</strong>
                        <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                            <li>${imported} properties imported successfully</li>
                            ${failed > 0 ? `<li>${failed} properties failed</li>` : ''}
                        </ul>
                    </div>
                `;
                
                setTimeout(() => goToStep(3), 500);
            } else {
                showStatus('step2-status', 'Failed to import properties', 'error');
            }
        }

        function copyWebhookUrl() {
            const url = document.getElementById('webhook-url').textContent;
            navigator.clipboard.writeText(url);
            showStatus('step3-status', '‚úì URL copied to clipboard', 'success');
        }

        async function syncAvailability() {
            showStatus('step4-status', 'Starting availability sync...', 'info');
            
            try {
                const response = await fetch('/api/admin/sync-all-availability-quick', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showStatus('step4-status', `‚úì Synced ${data.totalPricesFound} prices for ${data.roomsCount} rooms`, 'success');
                } else {
                    showStatus('step4-status', 'Sync failed: ' + data.error, 'error');
                }
            } catch (error) {
                showStatus('step4-status', 'Sync error: ' + error.message, 'error');
            }
        }

        function showStatus(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
    </script>
</body>
</html>
